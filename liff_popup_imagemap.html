<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE OA å½ˆçª—ç†±å€ç·¨è¼¯å™¨ (LIFF + æ‰‹æ©Ÿé è¦½æŠ½å±œ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .area-box{
      position:absolute;
      border:2px solid rgba(255,0,0,.85);
      background:rgba(255,0,0,.18);
      color:white;
      font-weight:800;
      display:flex;
      justify-content:center;
      align-items:center;
      cursor:pointer;
      user-select:none;
      text-shadow:0 1px 2px rgba(0,0,0,.9);
    }
    .draw-rect{
      position:absolute;
      border:2px dashed rgba(0,0,0,.6);
      background:rgba(0,0,0,.10);
      pointer-events:none;
    }
    .preview-hotspot{
      position:absolute;
      border:2px solid rgba(255,0,0,.85);
      background:rgba(255,0,0,.10);
      pointer-events:none;
    }

    /* âœ… ä¸»å€é«˜åº¦ï¼šç”¨ JS å‹•æ…‹æ‰£æ‰ header */
    .main-h { height: calc(100vh - 140px); }

    /* âœ… å³å´ç•«å¸ƒï¼šç”¨ stage scale ç¸®æ”¾ */
    #stage{
      position: relative;
      transform-origin: top left;
    }
    #drawLayer{
      position:absolute;
      inset:0;
      cursor: crosshair;
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen text-slate-800">

  <!-- Header / Controls (å¯æ”¶åˆ) -->
  <div id="topBar" class="bg-white shadow sticky top-0 z-20">
    <div class="p-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-bold text-lg text-blue-700">LINE OA å½ˆçª—ç†±å€ç·¨è¼¯å™¨ï¼ˆLIFFï¼‰</div>
          <div class="text-xs text-slate-500 mt-1">
            ä¸Šå‚³åœ–ç‰‡ â†’ æ‹–æ›³ç•«æ¡† â†’ æ¯å€‹æ¡†å¡«ã€Œè¦é€å‡ºçš„é—œéµå­—ã€â†’ å„²å­˜ã€‚åº•ä¸‹å¯ã€Œæ‰‹æ©Ÿé è¦½ï¼ˆå¯æ”¶æ”¾ï¼‰ã€ã€‚
          </div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreviewDrawer(true)">
            ğŸ“±é è¦½
          </button>
          <button id="toggleBarBtn" class="px-3 py-2 rounded bg-slate-200 text-slate-800 text-sm hover:bg-slate-300 font-bold">
            æ”¶åˆ
          </button>
          <button class="px-3 py-2 rounded bg-slate-700 text-white text-sm hover:bg-slate-900" onclick="closeLiff()">
            é—œé–‰
          </button>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 md:grid-cols-[1fr_1fr] gap-2">
        <input id="workerUrl" class="border rounded px-3 py-2 bg-yellow-50 text-sm"
          placeholder="Worker URLï¼ˆhttps://xxx.workers.devï¼‰" />
        <input id="triggerKeyword" class="border rounded px-3 py-2 text-sm font-bold border-blue-500"
          placeholder="è§¸ç™¼é—œéµå­—ï¼ˆä½¿ç”¨è€…è¼¸å…¥é€™å¥æœƒå‡ºç¾é€™å¼µåœ–ï¼‰" />
      </div>
    </div>

    <!-- âœ… å¯æ”¶åˆå…§å®¹ -->
    <div id="topBarBody" class="px-3 pb-3">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_1fr_1fr] gap-2">

        <!-- âœ… Zoom å€å¡Š -->
        <div class="border rounded p-2 bg-slate-50">
          <div class="text-xs font-bold text-slate-600 mb-2">ğŸ” åœ–ç‰‡ç¸®æ”¾ï¼ˆZoomï¼‰</div>
          <div class="text-[11px] text-slate-500 mb-2">æç¤ºï¼šåœ¨ç•«å¸ƒä¸ŠæŒ‰ä½ Ctrl/Alt/Shift + æ»¾è¼ªä¹Ÿå¯ä»¥ç¸®æ”¾</div>

          <div class="flex items-center gap-2">
            <input id="zoomRange" type="range" min="0.5" max="3" step="0.01" value="1" class="w-full">
            <div class="text-xs font-black w-14 text-right" id="zoomLabel">100%</div>
          </div>

          <div class="mt-2 flex gap-2">
            <button class="text-xs bg-slate-900 text-white px-3 py-2 rounded hover:bg-black font-bold" onclick="setZoom(1)">100%</button>
            <button class="text-xs bg-slate-100 px-3 py-2 rounded hover:bg-slate-200 font-bold" onclick="setZoom(0.75)">75%</button>
            <button class="text-xs bg-slate-100 px-3 py-2 rounded hover:bg-slate-200 font-bold" onclick="setZoom(1.5)">150%</button>
          </div>
        </div>

        <!-- åœ–ç‰‡å£“ç¸® -->
        <div class="border rounded p-2 bg-slate-50">
          <div class="text-xs font-bold text-slate-600 mb-2">åœ–ç‰‡å£“ç¸®</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <label class="flex flex-col gap-1">
              <span class="text-slate-500">é•·é‚Šä¸Šé™</span>
              <select id="maxSide" class="border rounded px-2 py-1">
                <option value="960">960ï¼ˆçœç©ºé–“ï¼‰</option>
                <option value="1280" selected>1280ï¼ˆLINE å»ºè­°ï¼‰</option>
                <option value="1600">1600ï¼ˆæ›´æ¸…æ™°ï¼‰</option>
              </select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-slate-500">æ ¼å¼</span>
              <select id="outFormat" class="border rounded px-2 py-1">
                <option value="image/webp" selected>WebPï¼ˆæ¨è–¦ï¼‰</option>
                <option value="image/jpeg">JPEG</option>
              </select>
            </label>

            <label class="flex flex-col gap-1 col-span-2">
              <span class="text-slate-500">å“è³ª <span id="qVal">0.82</span></span>
              <input id="quality" type="range" min="0.55" max="0.95" step="0.01" value="0.82">
            </label>

            <label class="flex items-center gap-2 col-span-2">
              <input id="cropSquare" type="checkbox" class="scale-110">
              <span class="text-slate-600">è£åˆ‡æ­£æ–¹å½¢ï¼ˆå¸¸ç”¨ï¼‰</span>
            </label>
          </div>
        </div>

        <!-- æ“ä½œ -->
        <div class="border rounded p-2 bg-slate-50">
          <div class="text-xs font-bold text-slate-600 mb-2">æ“ä½œ</div>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700" onclick="pickAndUpload()">
              ä¸Šå‚³åœ–ç‰‡åˆ° R2
            </button>
            <button class="px-3 py-2 rounded bg-gray-600 text-white text-sm hover:bg-gray-700" onclick="loadConfig()">
              è®€å–
            </button>
            <button class="px-3 py-2 rounded bg-green-600 text-white text-sm hover:bg-green-700" onclick="saveConfig()">
              å„²å­˜
            </button>
            <button class="px-3 py-2 rounded bg-red-600 text-white text-sm hover:bg-red-700" onclick="clearAreas()">
              æ¸…ç©ºæ¡†
            </button>
            <button class="px-3 py-2 rounded bg-black text-white text-sm hover:bg-slate-900" onclick="sendTestToMe()">
              é€åˆ°æˆ‘æ¸¬è©¦
            </button>
          </div>
          <div id="status" class="text-xs text-slate-500 mt-2">ç‹€æ…‹ï¼šæœªåˆå§‹åŒ–</div>

          <div class="mt-3 border-t pt-3 text-xs text-slate-600 space-y-1">
            <div>LIFFï¼š<span id="liffState" class="font-bold">-</span></div>
            <div>ä½¿ç”¨è€…ï¼š<span id="userName" class="font-bold">-</span></div>
            <div class="text-[11px] text-slate-500">æç¤ºï¼šç¸®æ”¾ä¸å½±éŸ¿åº§æ¨™ï¼Œç•«æ¡†æ›´æº–ã€‚</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Main -->
  <div id="mainArea" class="p-4 grid grid-cols-1 lg:grid-cols-[380px_1fr] gap-4 pb-32 main-h">
    <!-- Left: area list -->
    <div class="bg-white rounded-lg shadow p-4 h-fit">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-slate-700">æ¡†æ¡†è¨­å®šï¼ˆé»ç´…æ¡†ä¹Ÿå¯åˆªé™¤ï¼‰</div>
        <div class="text-xs text-slate-500">ä¸é™æ•¸é‡</div>
      </div>
      <div class="text-xs text-slate-500 mb-3">
        æ¯å€‹æ¡†çš„ã€Œå…§å®¹ã€ï¼ä½¿ç”¨è€…é»åˆ°æ™‚è‡ªå‹•é€å‡ºçš„æ–‡å­—ï¼ˆç”¨ä¾†è§¸ç™¼ä½ çš„è‡ªå‹•å›è¦†ï¼‰ã€‚
      </div>

      <div id="areaList" class="space-y-2"></div>
      <div id="areaEmpty" class="text-xs text-slate-400">ç›®å‰æ²’æœ‰æ¡†ï¼Œå»å³é‚Šåœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†ã€‚</div>

      <div class="mt-4 border-t pt-3">
        <button class="w-full px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black"
          onclick="togglePreviewDrawer(true)">
          ğŸ“± æ‰“é–‹æ‰‹æ©Ÿé è¦½æŠ½å±œ
        </button>
      </div>
    </div>

    <!-- Right: canvas (å›ºå®šé«˜åº¦ï¼Œç•«å¸ƒæ›´å¤§) -->
    <div class="bg-white rounded-lg shadow overflow-hidden flex flex-col">
      <div class="p-2 bg-slate-50 border-b text-xs text-slate-600 flex items-center justify-between">
        <div>âœ… æ‹–æ›³ç•«æ¡†ï¼›é»ç´…æ¡†åˆªé™¤ï¼›ç¸®æ”¾ä¸å½±éŸ¿åº§æ¨™</div>
        <button class="text-[11px] px-2 py-1 rounded bg-white border hover:bg-slate-50" onclick="setZoom(1)">é‡ç½® 100%</button>
      </div>

      <div id="canvasWrap" class="relative flex-1 overflow-auto bg-gray-100">
        <!-- stage æœƒ scale -->
        <div id="stage" class="inline-block">
          <img id="preview" class="block pointer-events-none select-none" style="max-width:none;" alt="">
          <div id="drawLayer"></div>
        </div>
      </div>

      <div class="p-3 bg-gray-50 text-center text-xs text-gray-600">
        åœ¨åœ–ç‰‡ä¸ŠæŒ‰ä½æ‹–æ›³ç•«æ¡†ã€‚é»ç´…æ¡†å¯åˆªé™¤ã€‚
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" hidden>

  <!-- Preview Drawer (collapsible bottom sheet) -->
  <div id="drawerOverlay" class="fixed inset-0 bg-black/40 hidden z-30" onclick="togglePreviewDrawer(false)"></div>

  <div id="previewDrawer"
       class="fixed left-0 right-0 bottom-0 z-40 translate-y-full transition-transform duration-300 ease-out">
    <div class="mx-auto max-w-4xl">
      <div class="bg-white rounded-t-2xl shadow-2xl overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="font-bold text-slate-700">ğŸ“± æ‰‹æ©Ÿå½ˆçª—é è¦½ï¼ˆå¯æ”¶æ”¾ï¼‰</div>
          <div class="flex items-center gap-2">
            <label class="flex items-center gap-2 text-xs text-slate-600">
              <input id="showHotspots" type="checkbox" checked>
              é¡¯ç¤ºç†±å€æ¡†
            </label>
            <button class="px-3 py-1.5 rounded bg-slate-200 text-slate-700 text-sm hover:bg-slate-300"
              onclick="togglePreviewDrawer(false)">
              æ”¶èµ·
            </button>
          </div>
        </div>

        <div class="p-4 bg-slate-50">
          <div class="mx-auto w-[360px] max-w-full">
            <div class="rounded-[26px] border-4 border-slate-900 bg-slate-900 p-2">
              <div class="rounded-[20px] bg-white overflow-hidden">
                <div class="bg-slate-100 text-xs text-slate-600 px-3 py-2 border-b flex items-center justify-between">
                  <span>LINE èŠå¤©å…§å°ºå¯¸æ„Ÿ</span>
                  <button class="text-[11px] px-2 py-1 rounded bg-white border hover:bg-slate-50"
                          onclick="sendPreviewToMe()">
                    ç›´æ¥é€åˆ°æˆ‘æ¸¬è©¦
                  </button>
                </div>

                <div class="p-3">
                  <div class="mx-auto w-[320px] max-w-full">
                    <div class="text-[11px] text-slate-500 mb-2">
                      é»ç†±å€æœƒæç¤ºé€å‡ºçš„é—œéµå­—ï¼ˆæ¨¡æ“¬ç”¨æˆ¶é»é¸ï¼‰
                    </div>

                    <div class="relative rounded-lg overflow-hidden border bg-white">
                      <img id="phoneImg" class="w-full h-[220px] object-cover bg-gray-100">
                      <div id="phoneHotspots" class="absolute inset-0"></div>
                    </div>

                    <div class="mt-2 text-[11px] text-slate-500">
                      * é€™æ˜¯é è¦½ã€ŒèŠå¤©æ³¡æ³¡å¯¬åº¦æ„Ÿã€ï¼Œå¯¦éš›æœƒå› æ‰‹æ©Ÿç•¥æœ‰å·®ç•°
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 flex gap-2">
              <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black"
                onclick="togglePreviewDrawer(false)">
                æ”¶èµ·é è¦½
              </button>
              <button class="flex-1 px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700"
                onclick="refreshPhonePreview()">
                é‡æ–°æ¸²æŸ“
              </button>
            </div>
          </div>
        </div>

        <div class="px-4 py-3 bg-white border-t text-xs text-slate-500">
          æç¤ºï¼šä½ ç•«æ¡†æˆ–æ”¹æ–‡å­—å¾Œï¼ŒæŠ½å±œæœƒè‡ªå‹•æ›´æ–°ï¼›å¦‚æœæ²’æ›´æ–°å°±æŒ‰ã€Œé‡æ–°æ¸²æŸ“ã€ã€‚
        </div>
      </div>
    </div>
  </div>

<script>
/* ===================== ä½ åªè¦æ”¹é€™è£¡ ===================== */
const LIFF_ID = "2009037126-AD8Dolxb";
/* ======================================================= */

let isReady = false;
let config = { imageUrl: "", areas: [] }; // {x,y,w,h,text}

/* ---------- å°å·¥å…· ---------- */
const $ = (id) => document.getElementById(id);
function normalizeWorkerUrl(raw){
  if(!raw) return "";
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = "https://" + s;
  return s.replace(/\/+$/,'');
}
function setStatus(msg){ $("status").textContent = "ç‹€æ…‹ï¼š" + msg; }

async function postJSON(url, data){
  const res = await fetch(url, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const ct = res.headers.get("content-type") || "";
  return ct.includes("json") ? res.json() : res.text();
}

async function uploadToR2(workerBaseUrl, fileBlob, filename){
  const form = new FormData();
  form.append("file", fileBlob, filename || "image.webp");
  const res = await fetch(workerBaseUrl + "/upload", { method:"POST", body: form });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const j = await res.json();
  if(!j.ok || !j.url) throw new Error("ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°");
  return j.url;
}

/* ---------- Header æ”¶åˆ & ä¸»å€é«˜åº¦åŒæ­¥ ---------- */
const topBar = $("topBar");
const topBarBody = $("topBarBody");
const toggleBarBtn = $("toggleBarBtn");
const mainArea = $("mainArea");
let barCollapsed = false;

toggleBarBtn.onclick = () => {
  barCollapsed = !barCollapsed;
  topBarBody.classList.toggle("hidden", barCollapsed);
  toggleBarBtn.textContent = barCollapsed ? "å±•é–‹" : "æ”¶åˆ";
  syncMainHeight();
};
function syncMainHeight(){
  const h = topBar.getBoundingClientRect().height;
  mainArea.style.height = `calc(100vh - ${Math.ceil(h)}px)`;
}
window.addEventListener("resize", syncMainHeight);

/* ---------- Zoom ---------- */
let ZOOM = 1;
const zoomRange = $("zoomRange");
const zoomLabel = $("zoomLabel");
const stage = $("stage");
const canvasWrap = $("canvasWrap");

function setZoom(v){
  ZOOM = Math.max(0.5, Math.min(3, Number(v) || 1));
  stage.style.transform = `scale(${ZOOM})`;
  zoomRange.value = String(ZOOM);
  zoomLabel.textContent = Math.round(ZOOM * 100) + "%";
}
zoomRange.addEventListener("input", () => setZoom(zoomRange.value));

canvasWrap.addEventListener("wheel", (e) => {
  if(!(e.ctrlKey || e.altKey || e.shiftKey)) return;
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.08 : 0.08;
  setZoom((ZOOM + delta).toFixed(2));
}, { passive:false });

/* ---------- äº‹ä»¶ ---------- */
$("quality").addEventListener("input", () => $("qVal").textContent = $("quality").value);
$("showHotspots").addEventListener("change", () => refreshPhonePreview());

/* ---------- å£“ç¸® ---------- */
async function compressImage(file, {maxSide, mime, quality, cropSquare}){
  const img = await createImageBitmap(file);

  let sx = 0, sy = 0, sw = img.width, sh = img.height;
  if(cropSquare){
    const side = Math.min(img.width, img.height);
    sx = Math.floor((img.width - side) / 2);
    sy = Math.floor((img.height - side) / 2);
    sw = side; sh = side;
  }

  const longSide = Math.max(sw, sh);
  const scale = Math.min(1, maxSide / longSide);
  const w = Math.max(1, Math.round(sw * scale));
  const h = Math.max(1, Math.round(sh * scale));

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d", { alpha: true });
  ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);

  const outBlob = await new Promise((resolve) => canvas.toBlob(resolve, mime, quality));
  if(!outBlob) throw new Error("å£“ç¸®å¤±æ•—ï¼ˆtoBlob ç©ºï¼‰");

  const ext = (mime === "image/webp") ? "webp" : "jpg";
  const safeName = (file.name || "image").replace(/\.[^/.]+$/, "");
  return { blob: outBlob, filename: `${safeName}.${ext}` };
}

/* ---------- ç•«æ¡†ï¼ˆç¸®æ”¾è¦é™¤ä»¥ zoomï¼‰ ---------- */
const layer = $("drawLayer");
let isDrawing = false;
let sx = 0, sy = 0;
let previewRect = null;

function getLayerPoint(e){
  const rect = layer.getBoundingClientRect();
  // stage æœ‰ scaleï¼Œæ‰€ä»¥è¦é™¤ä»¥ zoom æ‰æ˜¯ã€Œæœªç¸®æ”¾åº§æ¨™ã€
  const x = (e.clientX - rect.left) / ZOOM;
  const y = (e.clientY - rect.top) / ZOOM;
  return { x, y, rect };
}

layer.addEventListener("mousedown", (e) => {
  if(!config.imageUrl) return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡");
  isDrawing = true;

  const p = getLayerPoint(e);
  sx = p.x; sy = p.y;

  previewRect = document.createElement("div");
  previewRect.className = "draw-rect";
  previewRect.style.left = sx + "px";
  previewRect.style.top = sy + "px";
  previewRect.style.width = "0px";
  previewRect.style.height = "0px";
  layer.appendChild(previewRect);
});

layer.addEventListener("mousemove", (e) => {
  if(!isDrawing || !previewRect) return;
  const p = getLayerPoint(e);
  const cx = p.x, cy = p.y;

  const x = Math.min(sx, cx);
  const y = Math.min(sy, cy);
  const w = Math.abs(cx - sx);
  const h = Math.abs(cy - sy);

  previewRect.style.left = x + "px";
  previewRect.style.top = y + "px";
  previewRect.style.width = w + "px";
  previewRect.style.height = h + "px";
});

layer.addEventListener("mouseup", (e) => {
  if(!isDrawing) return;
  isDrawing = false;

  const p = getLayerPoint(e);
  const ex = p.x, ey = p.y;

  const x = Math.min(sx, ex);
  const y = Math.min(sy, ey);
  const w = Math.abs(ex - sx);
  const h = Math.abs(ey - sy);

  if(previewRect){ previewRect.remove(); previewRect = null; }
  if(w < 14 || h < 14) return;

  // layer çš„ã€ŒåŸå°ºå¯¸ã€ï¼ˆæœªç¸®æ”¾ï¼‰
  const baseW = layer.clientWidth;
  const baseH = layer.clientHeight;

  config.areas.push({ x: x/baseW, y: y/baseH, w: w/baseW, h: h/baseH, text: "" });
  renderAreas();
  renderAreaList();
  refreshPhonePreview();
});

/* ---------- æ¸²æŸ“ç´…æ¡†ï¼ˆç·¨è¼¯å€ï¼‰ ---------- */
function renderAreas(){
  layer.querySelectorAll(".area-box").forEach(el => el.remove());
  config.areas.forEach((a, i) => {
    const d = document.createElement("div");
    d.className = "area-box";
    d.style.left = (a.x*100) + "%";
    d.style.top = (a.y*100) + "%";
    d.style.width = (a.w*100) + "%";
    d.style.height = (a.h*100) + "%";
    d.textContent = (i+1);

    d.onclick = (ev) => {
      ev.stopPropagation();
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        config.areas.splice(i,1);
        renderAreas();
        renderAreaList();
        refreshPhonePreview();
      }
    };
    layer.appendChild(d);
  });
}

/* ---------- å·¦å´æ¡†æ¸…å–® ---------- */
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderAreaList(){
  const list = $("areaList");
  list.innerHTML = "";
  $("areaEmpty").classList.toggle("hidden", config.areas.length !== 0);

  config.areas.forEach((a, i) => {
    const row = document.createElement("div");
    row.className = "border rounded p-2 bg-white";
    row.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-sm">æ¡† ${i+1}</div>
        <button class="text-xs text-red-600 underline">åˆªé™¤</button>
      </div>
      <div class="text-xs text-slate-500 mb-1">é»æ­¤æ¡†é€å‡ºæ–‡å­—ï¼š</div>
      <input class="w-full border rounded px-2 py-2 text-sm font-bold"
        placeholder="ä¾‹å¦‚ï¼šMENU_SHOP / MENU_CALENDAR / MENU_NUTRITION"
        value="${escapeHtml(a.text)}">
    `;

    const del = row.querySelector("button");
    const input = row.querySelector("input");

    del.onclick = () => {
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        config.areas.splice(i,1);
        renderAreas();
        renderAreaList();
        refreshPhonePreview();
      }
    };
    input.oninput = () => {
      a.text = input.value;
      refreshPhonePreview();
    };

    list.appendChild(row);
  });
}

function clearAreas(){
  if(confirm("ç¢ºå®šæ¸…ç©ºå…¨éƒ¨æ¡†ï¼Ÿ")){
    config.areas = [];
    renderAreas();
    renderAreaList();
    refreshPhonePreview();
  }
}

/* ---------- åœ–ç‰‡è¼‰å…¥å¾Œï¼šåŒæ­¥ layer å°ºå¯¸ï¼ˆé¿å…ç¸®æ”¾æ™‚æŠ“éŒ¯ï¼‰ ---------- */
function syncLayerToImage(){
  const img = $("preview");
  const w = img.naturalWidth || img.clientWidth || 0;
  const h = img.naturalHeight || img.clientHeight || 0;
  if(!w || !h) return;

  img.style.width = w + "px";
  img.style.height = h + "px";
  layer.style.width = w + "px";
  layer.style.height = h + "px";
}
$("preview").addEventListener("load", () => {
  syncLayerToImage();
  renderAreas();
  refreshPhonePreview();
});

/* ---------- ä¸Šå‚³ï¼ˆR2ï¼‰ ---------- */
async function pickAndUpload(){
  const base = normalizeWorkerUrl($("workerUrl").value);
  if(!base) return alert("è«‹å…ˆå¡« Worker URL");
  localStorage.setItem("line_worker_url", base);

  const input = $("fileInput");
  input.value = "";
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    setStatus("å£“ç¸®+ä¸Šå‚³ä¸­...");
    try{
      const maxSide = parseInt($("maxSide").value, 10);
      const mime = $("outFormat").value;
      const quality = parseFloat($("quality").value);
      const cropSquare = $("cropSquare").checked;

      const { blob, filename } = await compressImage(file, {maxSide, mime, quality, cropSquare});
      const url = await uploadToR2(base, blob, filename);

      config.imageUrl = url;
      config.areas = [];
      $("preview").src = url;

      setZoom(1); // ä¸Šå‚³æ–°åœ–é‡ç½®ç¸®æ”¾ï¼Œé¿å…æ‰¾ä¸åˆ°
      renderAreas();
      renderAreaList();
      refreshPhonePreview();

      setStatus("ä¸Šå‚³å®Œæˆ âœ…");
      togglePreviewDrawer(true);
    }catch(err){
      setStatus("ä¸Šå‚³å¤±æ•—");
      alert("ä¸Šå‚³å¤±æ•—ï¼š\n" + err.message);
    }
  };
  input.click();
}

/* ---------- ç”¢å‡º imagemap messageï¼ˆå…¨éƒ¨ message actionï¼‰ ---------- */
async function buildImagemapMessage(){
  if(!config.imageUrl) throw new Error("å°šæœªä¸Šå‚³åœ–ç‰‡");
  if(config.areas.length === 0) throw new Error("å°šæœªç•«æ¡†");
  if(config.areas.some(a => !String(a.text||"").trim())) throw new Error("æœ‰æ¡†æ²’æœ‰å¡«å…§å®¹");

  return new Promise((resolve, reject) => {
    const im = new Image();
    im.onload = () => {
      const baseW = 1040;
      const ratio = im.naturalHeight / im.naturalWidth;
      const baseH = Math.max(1040, Math.round(baseW * ratio));

      const actions = config.areas.map(a => ({
        type: "message",
        text: a.text,
        area: {
          x: Math.round(a.x * baseW),
          y: Math.round(a.y * baseH),
          width: Math.round(a.w * baseW),
          height: Math.round(a.h * baseH)
        }
      }));

      resolve({
        type: "imagemap",
        baseUrl: config.imageUrl,
        altText: "è«‹é»é¸",
        baseSize: { width: baseW, height: baseH },
        actions
      });
    };
    im.onerror = () => reject(new Error("è®€å–åœ–ç‰‡å°ºå¯¸å¤±æ•—ï¼Œè«‹ç¢ºèªåœ–ç‰‡ URL å¯å…¬é–‹å­˜å–"));
    im.src = config.imageUrl;
  });
}

/* ---------- å­˜/è®€ï¼ˆâœ… ç„¡å¯†ç¢¼ç‰ˆæœ¬ï¼‰ ---------- */
async function saveConfig(){
  const base = normalizeWorkerUrl($("workerUrl").value);
  const keyword = $("triggerKeyword").value.trim();
  if(!base || !keyword) return alert("è«‹å¡« Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem("line_worker_url", base);

  try{
    const msg = await buildImagemapMessage();
    const payload = { mode: "imagemap", messages: [msg] };
    await postJSON(base + "/save", { keyword, payload });
    setStatus("å„²å­˜æˆåŠŸ âœ…");
    alert("å„²å­˜æˆåŠŸï¼\nä½¿ç”¨è€…è¼¸å…¥è§¸ç™¼é—œéµå­—ï¼šã€Œ" + keyword + "ã€å°±æœƒå‡ºç¾é€™å¼µåœ–ã€‚");
  }catch(e){
    setStatus("å„²å­˜å¤±æ•—");
    alert("å„²å­˜å¤±æ•—ï¼š\n" + e.message);
  }
}

async function loadConfig(){
  const base = normalizeWorkerUrl($("workerUrl").value);
  const keyword = $("triggerKeyword").value.trim();
  if(!base || !keyword) return alert("è«‹å¡« Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem("line_worker_url", base);

  try{
    const data = await postJSON(base + "/load", { keyword });
    const obj = (typeof data === "string") ? JSON.parse(data) : data;

    if(obj.mode !== "imagemap" || !obj.messages?.[0]) throw new Error("ä¸æ˜¯ imagemap æ ¼å¼");
    const m = obj.messages[0];

    config.imageUrl = m.baseUrl;
    $("preview").src = config.imageUrl;

    const bw = m.baseSize?.width || 1040;
    const bh = m.baseSize?.height || 1040;

    config.areas = (m.actions || []).map(a => ({
      x: (a.area?.x || 0) / bw,
      y: (a.area?.y || 0) / bh,
      w: (a.area?.width || 0) / bw,
      h: (a.area?.height || 0) / bh,
      text: a.text || ""
    }));

    renderAreas();
    renderAreaList();
    refreshPhonePreview();

    setZoom(1);
    setStatus("è®€å–æˆåŠŸ âœ…");
    togglePreviewDrawer(true);
  }catch(e){
    setStatus("è®€å–å¤±æ•—");
    alert("è®€å–å¤±æ•—ï¼š\n" + e.message);
  }
}

/* ---------- LIFFï¼šé€æ¸¬è©¦è¨Šæ¯ ---------- */
async function sendTestToMe(){
  if(!isReady) return alert("LIFF å°šæœªåˆå§‹åŒ–å®Œæˆ");
  if(!liff.isInClient()) return alert("è«‹åœ¨ LINE å…§é–‹å•Ÿï¼ˆå½ˆçª—ï¼‰æ‰å¯é€æ¸¬è©¦è¨Šæ¯");

  try{
    const msg = await buildImagemapMessage();
    await liff.sendMessages([msg]);
    alert("å·²æŠŠ imagemap é€åˆ°ä½ ç›®å‰çš„èŠå¤©å®¤ âœ…\nä½ å¯ä»¥ç›´æ¥é»æ¡†æ¸¬è©¦æ˜¯å¦æœƒé€å‡ºé—œéµå­—ã€‚");
  }catch(e){
    alert("é€æ¸¬è©¦å¤±æ•—ï¼š\n" + e.message);
  }
}
async function sendPreviewToMe(){
  return sendTestToMe();
}

/* ---------- é è¦½æŠ½å±œï¼šé–‹/é—œ + æ¸²æŸ“ ---------- */
function togglePreviewDrawer(open){
  const overlay = $("drawerOverlay");
  const drawer = $("previewDrawer");

  if(open){
    overlay.classList.remove("hidden");
    drawer.classList.remove("translate-y-full");
    refreshPhonePreview();
  }else{
    overlay.classList.add("hidden");
    drawer.classList.add("translate-y-full");
  }
}

function refreshPhonePreview(){
  const img = $("phoneImg");
  const wrap = $("phoneHotspots");

  if(!config.imageUrl){
    img.src = "";
    wrap.innerHTML = "";
    return;
  }

  img.src = config.imageUrl;
  wrap.innerHTML = "";

  requestAnimationFrame(() => {
    const show = $("showHotspots").checked;
    const r = wrap.getBoundingClientRect();
    if(!r.width || !r.height) return;

    config.areas.forEach((a, i) => {
      if(show){
        const box = document.createElement("div");
        box.className = "preview-hotspot";
        box.style.left = (a.x * r.width) + "px";
        box.style.top = (a.y * r.height) + "px";
        box.style.width = (a.w * r.width) + "px";
        box.style.height = (a.h * r.height) + "px";
        wrap.appendChild(box);
      }

      const btn = document.createElement("button");
      btn.style.position = "absolute";
      btn.style.left = (a.x*100) + "%";
      btn.style.top = (a.y*100) + "%";
      btn.style.width = (a.w*100) + "%";
      btn.style.height = (a.h*100) + "%";
      btn.style.background = "transparent";
      btn.onclick = () => {
        const t = (a.text || "").trim();
        alert(`ç†±å€ ${i+1}\nå°‡é€å‡ºï¼š${t || "ï¼ˆå°šæœªå¡«ï¼‰"}`);
      };
      wrap.appendChild(btn);
    });
  });
}

/* ---------- LIFF åˆå§‹åŒ– / é—œé–‰ ---------- */
async function initLIFF(){
  try{
    $("liffState").textContent = "åˆå§‹åŒ–ä¸­...";
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      $("liffState").textContent = "éœ€è¦ç™»å…¥";
      liff.login();
      return;
    }

    $("liffState").textContent = liff.isInClient() ? "LINE å…§ï¼ˆå½ˆçª—ï¼‰" : "å¤–éƒ¨ç€è¦½å™¨";
    if(liff.getProfile){
      const p = await liff.getProfile();
      $("userName").textContent = p.displayName || "-";
    }

    const savedUrl = localStorage.getItem("line_worker_url");
    if(savedUrl) $("workerUrl").value = savedUrl;

    isReady = true;
    setStatus("å°±ç·’ âœ…ï¼ˆå¯ä¸Šå‚³ã€ç•«æ¡†ã€å„²å­˜ï¼‰");

    syncMainHeight();
    setZoom(1);
  }catch(e){
    $("liffState").textContent = "åˆå§‹åŒ–å¤±æ•—";
    setStatus("åˆå§‹åŒ–å¤±æ•—");
    alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š\n" + e.message + "\n\nè«‹ç¢ºèªä½ å·²æŠŠ LIFF_ID æ›æˆæ­£ç¢ºçš„ã€‚");
  }
}

function closeLiff(){
  if(window.liff && liff.isInClient()) liff.closeWindow();
  else window.close();
}

/* ---------- åˆå§‹åŒ– ---------- */
initLIFF();
</script>
</body>
</html>
