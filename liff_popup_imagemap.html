<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE OA å½ˆçª—ç†±å€ç·¨è¼¯å™¨ (Canvaè‡ªç”±ç·¨è¼¯ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .area-box{
      position:absolute;
      border:2px solid rgba(255,0,0,.9);
      background:rgba(255,0,0,.12);
      color:white;
      font-weight:900;
      display:flex;
      justify-content:center;
      align-items:center;
      cursor:move;
      user-select:none;
      text-shadow:0 1px 2px rgba(0,0,0,.9);
      box-sizing:border-box;
    }
    .area-box.selected{
      outline: 2px solid rgba(59,130,246,.9);
      box-shadow: 0 0 0 4px rgba(59,130,246,.18);
    }
    .handle{
      position:absolute;
      width:10px; height:10px;
      background:white;
      border:2px solid rgba(59,130,246,.95);
      border-radius:2px;
      box-sizing:border-box;
    }
    .handle.nw{ left:-6px; top:-6px; cursor:nwse-resize; }
    .handle.n { left:calc(50% - 5px); top:-6px; cursor:ns-resize; }
    .handle.ne{ right:-6px; top:-6px; cursor:nesw-resize; }
    .handle.e { right:-6px; top:calc(50% - 5px); cursor:ew-resize; }
    .handle.se{ right:-6px; bottom:-6px; cursor:nwse-resize; }
    .handle.s { left:calc(50% - 5px); bottom:-6px; cursor:ns-resize; }
    .handle.sw{ left:-6px; bottom:-6px; cursor:nesw-resize; }
    .handle.w { left:-6px; top:calc(50% - 5px); cursor:ew-resize; }

    .draw-rect{
      position:absolute;
      border:2px dashed rgba(0,0,0,.6);
      background:rgba(0,0,0,.10);
      pointer-events:none;
      box-sizing:border-box;
    }

    #stage{
      position:relative;
      transform-origin: top left;
    }
    #drawLayer{
      position:absolute;
      inset:0;
    }

    /* Canva æ„Ÿï¼šç©ºç™½éµå¹³ç§»æ™‚çš„æ¸¸æ¨™ */
    .panning { cursor: grab !important; }
    .panning:active { cursor: grabbing !important; }

    /* å…¨è¢å¹•ç•«å¸ƒ */
    .fs{
      position:fixed !important;
      inset:0 !important;
      z-index:9999 !important;
      background:#fff !important;
      border-radius:0 !important;
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen text-slate-800">

  <!-- Header -->
  <div id="topBar" class="bg-white shadow sticky top-0 z-20">
    <div class="p-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-bold text-lg text-blue-700">LINE OA å½ˆçª—ç†±å€ç·¨è¼¯å™¨ï¼ˆCanva è‡ªç”±ç‰ˆï¼‰</div>
          <div class="text-xs text-slate-500 mt-1">
            ç©ºç™½éµæ‹–æ›³å¹³ç§»ï½œCtrl/Alt/Shift + æ»¾è¼ªç¸®æ”¾ï½œæ¡†æ¡†å¯æ‹–ç§»/æ‹‰è§’ç¸®æ”¾ï½œå¯å…¨è¢å¹•ç·¨è¼¯
          </div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreviewDrawer(true)">ğŸ“±é è¦½</button>
          <button id="toggleBarBtn" class="px-3 py-2 rounded bg-slate-200 text-slate-800 text-sm hover:bg-slate-300 font-bold">æ”¶åˆ</button>
          <button class="px-3 py-2 rounded bg-slate-700 text-white text-sm hover:bg-slate-900" onclick="closeLiff()">é—œé–‰</button>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 md:grid-cols-[1fr_1fr] gap-2">
        <input id="workerUrl" class="border rounded px-3 py-2 bg-yellow-50 text-sm"
          placeholder="Worker URLï¼ˆhttps://xxx.workers.devï¼‰" />
        <input id="triggerKeyword" class="border rounded px-3 py-2 text-sm font-bold border-blue-500"
          placeholder="è§¸ç™¼é—œéµå­—ï¼ˆä½¿ç”¨è€…è¼¸å…¥é€™å¥æœƒå‡ºç¾é€™å¼µåœ–ï¼‰" />
      </div>
    </div>

    <!-- å¯æ”¶åˆ -->
    <div id="topBarBody" class="px-3 pb-3">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_1fr_1fr] gap-2">

        <!-- Zoom -->
        <div class="border rounded p-2 bg-slate-50">
          <div class="text-xs font-bold text-slate-600 mb-2">ğŸ” ç¸®æ”¾ / è¦–åœ–</div>
          <div class="flex items-center gap-2">
            <button class="text-xs bg-slate-900 text-white px-3 py-2 rounded hover:bg-black font-bold" onclick="zoomBy(-0.1)">-</button>
            <input id="zoomRange" type="range" min="0.3" max="4" step="0.01" value="1" class="w-full">
            <button class="text-xs bg-slate-900 text-white px-3 py-2 rounded hover:bg-black font-bold" onclick="zoomBy(0.1)">+</button>
            <div class="text-xs font-black w-14 text-right" id="zoomLabel">100%</div>
          </div>
          <div class="mt-2 grid grid-cols-3 gap-2">
            <button class="text-xs bg-white border px-3 py-2 rounded hover:bg-slate-50 font-bold" onclick="setZoom(1)">100%</button>
            <button class="text-xs bg-white border px-3 py-2 rounded hover:bg-slate-50 font-bold" onclick="fitToView()">Fit</button>
            <button class="text-xs bg-white border px-3 py-2 rounded hover:bg-slate-50 font-bold" onclick="centerView()">ç½®ä¸­</button>
          </div>
          <div class="mt-2 text-[11px] text-slate-500">
            å¹³ç§»ï¼šæŒ‰ä½ <b>ç©ºç™½éµ</b> + æ‹–æ›³ï¼ˆæˆ–è§¸æ§æ¿é›™æŒ‡æ»‘ï¼‰
          </div>
        </div>

        <!-- å£“ç¸® -->
        <div class="border rounded p-2 bg-slate-50">
          <div class="text-xs font-bold text-slate-600 mb-2">åœ–ç‰‡å£“ç¸®</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <label class="flex flex-col gap-1">
              <span class="text-slate-500">é•·é‚Šä¸Šé™</span>
              <select id="maxSide" class="border rounded px-2 py-1">
                <option value="960">960ï¼ˆçœç©ºé–“ï¼‰</option>
                <option value="1280" selected>1280ï¼ˆLINE å»ºè­°ï¼‰</option>
                <option value="1600">1600ï¼ˆæ›´æ¸…æ™°ï¼‰</option>
              </select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-slate-500">æ ¼å¼</span>
              <select id="outFormat" class="border rounded px-2 py-1">
                <option value="image/webp" selected>WebPï¼ˆæ¨è–¦ï¼‰</option>
                <option value="image/jpeg">JPEG</option>
              </select>
            </label>

            <label class="flex flex-col gap-1 col-span-2">
              <span class="text-slate-500">å“è³ª <span id="qVal">0.82</span></span>
              <input id="quality" type="range" min="0.55" max="0.95" step="0.01" value="0.82">
            </label>

            <label class="flex items-center gap-2 col-span-2">
              <input id="cropSquare" type="checkbox" class="scale-110">
              <span class="text-slate-600">è£åˆ‡æ­£æ–¹å½¢ï¼ˆå¸¸ç”¨ï¼‰</span>
            </label>
          </div>
        </div>

        <!-- æ“ä½œ -->
        <div class="border rounded p-2 bg-slate-50">
          <div class="text-xs font-bold text-slate-600 mb-2">æ“ä½œ</div>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700" onclick="pickAndUpload()">ä¸Šå‚³åœ–ç‰‡åˆ° R2</button>
            <button class="px-3 py-2 rounded bg-gray-600 text-white text-sm hover:bg-gray-700" onclick="loadConfig()">è®€å–</button>
            <button class="px-3 py-2 rounded bg-green-600 text-white text-sm hover:bg-green-700" onclick="saveConfig()">å„²å­˜</button>
            <button class="px-3 py-2 rounded bg-red-600 text-white text-sm hover:bg-red-700" onclick="clearAreas()">æ¸…ç©ºæ¡†</button>
            <button class="px-3 py-2 rounded bg-black text-white text-sm hover:bg-slate-900" onclick="sendTestToMe()">é€åˆ°æˆ‘æ¸¬è©¦</button>
          </div>
          <div id="status" class="text-xs text-slate-500 mt-2">ç‹€æ…‹ï¼šæœªåˆå§‹åŒ–</div>

          <div class="mt-3 border-t pt-3 text-xs text-slate-600 space-y-1">
            <div>LIFFï¼š<span id="liffState" class="font-bold">-</span></div>
            <div>ä½¿ç”¨è€…ï¼š<span id="userName" class="font-bold">-</span></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Main: å·¦å³å¯æ‹‰å¯¬ï¼ˆsplitterï¼‰ -->
  <div id="mainArea" class="p-4 pb-32" style="height:calc(100vh - 160px);">
    <div class="bg-white rounded-xl shadow overflow-hidden h-full">
      <div class="flex h-full">

        <!-- Left Panel -->
        <div id="leftPanel" class="w-[380px] min-w-[280px] max-w-[560px] border-r p-4 overflow-auto">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold text-slate-700">æ¡†æ¡†è¨­å®š</div>
            <div class="text-xs text-slate-500">å¯æ‹–ç§»/æ‹‰è§’ç¸®æ”¾</div>
          </div>
          <div class="text-xs text-slate-500 mb-3">
            æ¯å€‹æ¡†çš„ã€Œå…§å®¹ã€ï¼é»åˆ°æ™‚é€å‡ºçš„æ–‡å­—ï¼ˆç”¨ä¾†è§¸ç™¼ä½ çš„è‡ªå‹•å›è¦†ï¼‰
          </div>

          <div id="areaList" class="space-y-2"></div>
          <div id="areaEmpty" class="text-xs text-slate-400">ç›®å‰æ²’æœ‰æ¡†ï¼Œå»å³é‚Šåœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†ã€‚</div>

          <div class="mt-4 border-t pt-3 grid grid-cols-2 gap-2">
            <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreviewDrawer(true)">ğŸ“±æ‰‹æ©Ÿé è¦½</button>
            <button id="fsBtn" class="px-3 py-2 rounded bg-white border text-slate-800 text-sm hover:bg-slate-50 font-bold" onclick="toggleFullscreenCanvas()">å…¨è¢å¹•ç·¨è¼¯</button>
          </div>
          <div class="mt-2 text-[11px] text-slate-500">
            æç¤ºï¼šå·¦å´é‚Šç•Œå¯æ‹–æ›³èª¿æ•´å¯¬åº¦ï¼ˆåƒ Canva é¢æ¿ï¼‰
          </div>
        </div>

        <!-- Splitter -->
        <div id="splitter" class="w-2 cursor-col-resize bg-slate-100 hover:bg-slate-200"></div>

        <!-- Right Canvas -->
        <div id="rightPanel" class="flex-1 flex flex-col">
          <div class="p-2 bg-slate-50 border-b text-xs text-slate-600 flex items-center justify-between">
            <div>âœ… æ‹–æ›³ç•«æ¡†ï¼ˆæ–°å¢ï¼‰ï½œé¸å–æ¡†å¾Œå¯æ‹–ç§»/æ‹‰è§’ç¸®æ”¾ï½œDelete å¯åˆªé™¤é¸å–æ¡†</div>
            <button class="text-[11px] px-2 py-1 rounded bg-white border hover:bg-slate-50" onclick="setZoom(1)">é‡ç½® 100%</button>
          </div>

          <div id="canvasWrap" class="relative flex-1 overflow-auto bg-gray-100">
            <div id="stage" class="inline-block">
              <img id="preview" class="block pointer-events-none select-none" style="max-width:none;" alt="">
              <div id="drawLayer"></div>
            </div>
          </div>

          <div class="p-3 bg-gray-50 text-center text-xs text-gray-600">
            æ–°å¢æ¡†ï¼šæ‹–æ›³ï½œå¹³ç§»ï¼šç©ºç™½éµæ‹–æ›³ï½œç¸®æ”¾ï¼šCtrl/Alt/Shift + æ»¾è¼ª
          </div>
        </div>

      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" hidden>

  <!-- Preview Drawer -->
  <div id="drawerOverlay" class="fixed inset-0 bg-black/40 hidden z-30" onclick="togglePreviewDrawer(false)"></div>
  <div id="previewDrawer" class="fixed left-0 right-0 bottom-0 z-40 translate-y-full transition-transform duration-300 ease-out">
    <div class="mx-auto max-w-4xl">
      <div class="bg-white rounded-t-2xl shadow-2xl overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="font-bold text-slate-700">ğŸ“± æ‰‹æ©Ÿå½ˆçª—é è¦½ï¼ˆå¯æ”¶æ”¾ï¼‰</div>
          <div class="flex items-center gap-2">
            <label class="flex items-center gap-2 text-xs text-slate-600">
              <input id="showHotspots" type="checkbox" checked>
              é¡¯ç¤ºç†±å€æ¡†
            </label>
            <button class="px-3 py-1.5 rounded bg-slate-200 text-slate-700 text-sm hover:bg-slate-300"
              onclick="togglePreviewDrawer(false)">æ”¶èµ·</button>
          </div>
        </div>

        <div class="p-4 bg-slate-50">
          <div class="mx-auto w-[360px] max-w-full">
            <div class="rounded-[26px] border-4 border-slate-900 bg-slate-900 p-2">
              <div class="rounded-[20px] bg-white overflow-hidden">
                <div class="bg-slate-100 text-xs text-slate-600 px-3 py-2 border-b flex items-center justify-between">
                  <span>LINE èŠå¤©å…§å°ºå¯¸æ„Ÿ</span>
                  <button class="text-[11px] px-2 py-1 rounded bg-white border hover:bg-slate-50" onclick="sendPreviewToMe()">ç›´æ¥é€åˆ°æˆ‘æ¸¬è©¦</button>
                </div>

                <div class="p-3">
                  <div class="mx-auto w-[320px] max-w-full">
                    <div class="text-[11px] text-slate-500 mb-2">é»ç†±å€æœƒæç¤ºé€å‡ºçš„é—œéµå­—ï¼ˆæ¨¡æ“¬é»é¸ï¼‰</div>

                    <div class="relative rounded-lg overflow-hidden border bg-white">
                      <img id="phoneImg" class="w-full h-[220px] object-cover bg-gray-100">
                      <div id="phoneHotspots" class="absolute inset-0"></div>
                    </div>

                    <div class="mt-2 text-[11px] text-slate-500">* é€™æ˜¯é è¦½ã€ŒèŠå¤©æ³¡æ³¡å¯¬åº¦æ„Ÿã€ï¼Œå¯¦éš›æœƒå› æ‰‹æ©Ÿç•¥æœ‰å·®ç•°</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 flex gap-2">
              <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreviewDrawer(false)">æ”¶èµ·é è¦½</button>
              <button class="flex-1 px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700" onclick="refreshPhonePreview()">é‡æ–°æ¸²æŸ“</button>
            </div>
          </div>
        </div>

        <div class="px-4 py-3 bg-white border-t text-xs text-slate-500">
          æç¤ºï¼šä½ ç•«æ¡†æˆ–æ”¹æ–‡å­—å¾Œï¼Œé è¦½æœƒè‡ªå‹•æ›´æ–°ï¼›å¦‚æœæ²’æ›´æ–°å°±æŒ‰ã€Œé‡æ–°æ¸²æŸ“ã€ã€‚
        </div>
      </div>
    </div>
  </div>

<script>
/* ===================== ä½ åªè¦æ”¹é€™è£¡ ===================== */
const LIFF_ID = "2009037126-AD8Dolxb";
/* ======================================================= */

const $ = (id) => document.getElementById(id);
let isReady = false;

let config = { imageUrl: "", areas: [] }; // 0~1 normalized
let ZOOM = 1;

let selectedIndex = -1;

// ç©ºç™½éµå¹³ç§»
let spaceDown = false;

// splitter
let splitting = false;

// fullscreen
let canvasFullscreen = false;

/* ---------- utils ---------- */
function normalizeWorkerUrl(raw){
  if(!raw) return "";
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = "https://" + s;
  return s.replace(/\/+$/,'');
}
function setStatus(msg){ $("status").textContent = "ç‹€æ…‹ï¼š" + msg; }

async function postJSON(url, data){
  const res = await fetch(url, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const ct = res.headers.get("content-type") || "";
  return ct.includes("json") ? res.json() : res.text();
}

async function uploadToR2(workerBaseUrl, fileBlob, filename){
  const form = new FormData();
  form.append("file", fileBlob, filename || "image.webp");
  const res = await fetch(workerBaseUrl + "/upload", { method:"POST", body: form });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const j = await res.json();
  if(!j.ok || !j.url) throw new Error("ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°");
  return j.url;
}

function clamp01(v){ return Math.max(0, Math.min(1, v)); }

/* ---------- header collapse + main height ---------- */
const topBar = $("topBar");
const topBarBody = $("topBarBody");
const toggleBarBtn = $("toggleBarBtn");
const mainArea = $("mainArea");
let barCollapsed = false;

toggleBarBtn.onclick = () => {
  barCollapsed = !barCollapsed;
  topBarBody.classList.toggle("hidden", barCollapsed);
  toggleBarBtn.textContent = barCollapsed ? "å±•é–‹" : "æ”¶åˆ";
  syncMainHeight();
};
function syncMainHeight(){
  const h = topBar.getBoundingClientRect().height;
  mainArea.style.height = `calc(100vh - ${Math.ceil(h)}px)`;
}
window.addEventListener("resize", () => {
  syncMainHeight();
  if(config.imageUrl) fitToView(false); // resizeæ™‚ç¨å¾®è²¼åˆ
});

/* ---------- zoom ---------- */
const stage = $("stage");
const canvasWrap = $("canvasWrap");
const zoomRange = $("zoomRange");
const zoomLabel = $("zoomLabel");

function applyZoom(){
  stage.style.transform = `scale(${ZOOM})`;
  zoomRange.value = String(ZOOM);
  zoomLabel.textContent = Math.round(ZOOM * 100) + "%";
}
function setZoom(v){
  ZOOM = Math.max(0.3, Math.min(4, Number(v) || 1));
  applyZoom();
}
function zoomBy(delta){
  setZoom((ZOOM + delta).toFixed(2));
}
zoomRange.addEventListener("input", () => setZoom(zoomRange.value));

canvasWrap.addEventListener("wheel", (e) => {
  if(!(e.ctrlKey || e.altKey || e.shiftKey)) return;
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.10 : 0.10;
  zoomBy(delta);
}, { passive:false });

function centerView(){
  // ç½®ä¸­ï¼šæ»¾å‹•åˆ°ä¸­å¤®
  const r = stage.getBoundingClientRect();
  canvasWrap.scrollLeft = Math.max(0, (stage.offsetWidth * ZOOM - canvasWrap.clientWidth) / 2);
  canvasWrap.scrollTop  = Math.max(0, (stage.offsetHeight * ZOOM - canvasWrap.clientHeight) / 2);
}

function fitToView(alsoCenter=true){
  if(!config.imageUrl) return;
  const img = $("preview");
  const w = img.naturalWidth || img.width || 1;
  const h = img.naturalHeight || img.height || 1;

  // é ç•™ä¸€é»é‚Šè·
  const margin = 40;
  const vw = Math.max(200, canvasWrap.clientWidth - margin);
  const vh = Math.max(200, canvasWrap.clientHeight - margin);

  const z = Math.min(vw / w, vh / h);
  setZoom(z.toFixed(2));
  if(alsoCenter) requestAnimationFrame(() => centerView());
}

/* ---------- pan (space + drag scroll) ---------- */
let panDown = false, panSX=0, panSY=0, panScrollL=0, panScrollT=0;

function setPanningUI(on){
  canvasWrap.classList.toggle("panning", on);
}
window.addEventListener("keydown", (e) => {
  if(e.code === "Space" && !spaceDown){
    spaceDown = true;
    setPanningUI(true);
  }
  if(e.key === "Delete" || e.key === "Backspace"){
    if(selectedIndex >= 0){
      if(confirm(`åˆªé™¤æ¡† ${selectedIndex+1}ï¼Ÿ`)){
        config.areas.splice(selectedIndex,1);
        selectedIndex = -1;
        renderAreas();
        renderAreaList();
        refreshPhonePreview();
      }
    }
  }
});
window.addEventListener("keyup", (e) => {
  if(e.code === "Space"){
    spaceDown = false;
    panDown = false;
    setPanningUI(false);
  }
});

canvasWrap.addEventListener("mousedown", (e) => {
  if(!spaceDown) return;
  panDown = true;
  panSX = e.clientX;
  panSY = e.clientY;
  panScrollL = canvasWrap.scrollLeft;
  panScrollT = canvasWrap.scrollTop;
  e.preventDefault();
});

window.addEventListener("mousemove", (e) => {
  if(!panDown) return;
  const dx = e.clientX - panSX;
  const dy = e.clientY - panSY;
  canvasWrap.scrollLeft = panScrollL - dx;
  canvasWrap.scrollTop  = panScrollT - dy;
});

window.addEventListener("mouseup", () => {
  panDown = false;
});

/* ---------- splitter (resize left panel) ---------- */
const leftPanel = $("leftPanel");
const splitter = $("splitter");

splitter.addEventListener("mousedown", (e) => {
  splitting = true;
  document.body.style.userSelect = "none";
});
window.addEventListener("mousemove", (e) => {
  if(!splitting) return;
  const rect = mainArea.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const w = Math.max(280, Math.min(560, x));
  leftPanel.style.width = w + "px";
});
window.addEventListener("mouseup", () => {
  splitting = false;
  document.body.style.userSelect = "";
});

/* ---------- fullscreen canvas ---------- */
function toggleFullscreenCanvas(){
  canvasFullscreen = !canvasFullscreen;
  const container = mainArea.querySelector(".bg-white.rounded-xl.shadow");
  const btn = $("fsBtn");

  if(canvasFullscreen){
    container.classList.add("fs");
    container.style.height = "100vh";
    mainArea.style.padding = "0px";
    btn.textContent = "é€€å‡ºå…¨è¢å¹•";
  }else{
    container.classList.remove("fs");
    container.style.height = "";
    mainArea.style.padding = "1rem";
    btn.textContent = "å…¨è¢å¹•ç·¨è¼¯";
    syncMainHeight();
  }

  // å…¨è¢å¹•åˆ‡æ›å¾Œï¼Œé‡ç®— fit
  setTimeout(() => {
    if(config.imageUrl) fitToView();
  }, 50);
}

/* ---------- compress ---------- */
$("quality").addEventListener("input", () => $("qVal").textContent = $("quality").value);

async function compressImage(file, {maxSide, mime, quality, cropSquare}){
  const img = await createImageBitmap(file);

  let sx = 0, sy = 0, sw = img.width, sh = img.height;
  if(cropSquare){
    const side = Math.min(img.width, img.height);
    sx = Math.floor((img.width - side) / 2);
    sy = Math.floor((img.height - side) / 2);
    sw = side; sh = side;
  }

  const longSide = Math.max(sw, sh);
  const scale = Math.min(1, maxSide / longSide);
  const w = Math.max(1, Math.round(sw * scale));
  const h = Math.max(1, Math.round(sh * scale));

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d", { alpha: true });
  ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);

  const outBlob = await new Promise((resolve) => canvas.toBlob(resolve, mime, quality));
  if(!outBlob) throw new Error("å£“ç¸®å¤±æ•—ï¼ˆtoBlob ç©ºï¼‰");

  const ext = (mime === "image/webp") ? "webp" : "jpg";
  const safeName = (file.name || "image").replace(/\.[^/.]+$/, "");
  return { blob: outBlob, filename: `${safeName}.${ext}` };
}

/* ---------- draw + edit rectangles (move/resize like canva) ---------- */
const layer = $("drawLayer");
let isDrawing = false;
let drawSX = 0, drawSY = 0;
let previewRect = null;

let dragMode = null; // "move" or handle key
let dragIndex = -1;
let dragStart = null;

function getLayerPoint(e){
  const rect = layer.getBoundingClientRect();
  // layerçš„ bbox å·²ç¶“è¢« zoom æ”¾å¤§ï¼Œæ‰€ä»¥è¦é™¤ä»¥ zoom å¾—åˆ°ã€ŒåŸå°ºå¯¸åº§æ¨™ã€
  const x = (e.clientX - rect.left) / ZOOM;
  const y = (e.clientY - rect.top) / ZOOM;
  return { x, y, rect };
}

function toNorm(x, y){
  const baseW = layer.clientWidth;
  const baseH = layer.clientHeight;
  return { nx: x / baseW, ny: y / baseH };
}
function fromNorm(n){
  const baseW = layer.clientWidth;
  const baseH = layer.clientHeight;
  return { x: n.x * baseW, y: n.y * baseH, w: n.w * baseW, h: n.h * baseH };
}

layer.addEventListener("mousedown", (e) => {
  if(spaceDown) return; // å¹³ç§»å„ªå…ˆ
  if(!config.imageUrl) return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡");

  // å¦‚æœé»åˆ°ç©ºç™½ï¼Œé–‹å§‹ã€Œæ–°å¢ç•«æ¡†ã€
  if(e.target === layer){
    selectedIndex = -1;
    renderAreas();
    renderAreaList();
    refreshPhonePreview();

    const p = getLayerPoint(e);
    isDrawing = true;
    drawSX = p.x; drawSY = p.y;

    previewRect = document.createElement("div");
    previewRect.className = "draw-rect";
    previewRect.style.left = drawSX + "px";
    previewRect.style.top = drawSY + "px";
    previewRect.style.width = "0px";
    previewRect.style.height = "0px";
    layer.appendChild(previewRect);
  }
});

layer.addEventListener("mousemove", (e) => {
  // æ–°å¢ç•«æ¡†
  if(isDrawing && previewRect){
    const p = getLayerPoint(e);
    const cx = p.x, cy = p.y;

    const x = Math.min(drawSX, cx);
    const y = Math.min(drawSY, cy);
    const w = Math.abs(cx - drawSX);
    const h = Math.abs(cy - drawSY);

    previewRect.style.left = x + "px";
    previewRect.style.top = y + "px";
    previewRect.style.width = w + "px";
    previewRect.style.height = h + "px";
  }

  // ç§»å‹•/ç¸®æ”¾
  if(dragMode && dragIndex >= 0 && dragStart){
    const p = getLayerPoint(e);
    const dx = p.x - dragStart.px;
    const dy = p.y - dragStart.py;

    const a = config.areas[dragIndex];
    const base = fromNorm(dragStart.base);

    let x = base.x, y = base.y, w = base.w, h = base.h;

    if(dragMode === "move"){
      x = base.x + dx;
      y = base.y + dy;
    }else{
      // handles
      const minSize = 16;
      if(dragMode.includes("e")) w = Math.max(minSize, base.w + dx);
      if(dragMode.includes("s")) h = Math.max(minSize, base.h + dy);
      if(dragMode.includes("w")){ x = base.x + dx; w = Math.max(minSize, base.w - dx); }
      if(dragMode.includes("n")){ y = base.y + dy; h = Math.max(minSize, base.h - dy); }
    }

    // clamp to image bounds
    const maxX = layer.clientWidth - w;
    const maxY = layer.clientHeight - h;
    x = Math.max(0, Math.min(maxX, x));
    y = Math.max(0, Math.min(maxY, y));

    const n = toNorm(x, y);
    a.x = clamp01(n.nx);
    a.y = clamp01(n.ny);
    a.w = clamp01(w / layer.clientWidth);
    a.h = clamp01(h / layer.clientHeight);

    renderAreas();
    renderAreaList(false);
    refreshPhonePreview();
  }
});

window.addEventListener("mouseup", (e) => {
  // å®Œæˆæ–°å¢ç•«æ¡†
  if(isDrawing){
    isDrawing = false;

    if(previewRect){ previewRect.remove(); previewRect = null; }

    const p = getLayerPoint(e);
    const ex = p.x, ey = p.y;

    const x = Math.min(drawSX, ex);
    const y = Math.min(drawSY, ey);
    const w = Math.abs(ex - drawSX);
    const h = Math.abs(ey - drawSY);

    if(w < 14 || h < 14) return;

    const n = toNorm(x, y);
    config.areas.push({
      x: clamp01(n.nx),
      y: clamp01(n.ny),
      w: clamp01(w / layer.clientWidth),
      h: clamp01(h / layer.clientHeight),
      text: ""
    });
    selectedIndex = config.areas.length - 1;
    renderAreas();
    renderAreaList();
    refreshPhonePreview();
  }

  dragMode = null;
  dragIndex = -1;
  dragStart = null;
});

/* ---------- render areas + handles ---------- */
function renderAreas(){
  layer.querySelectorAll(".area-box").forEach(el => el.remove());

  config.areas.forEach((a, i) => {
    const d = document.createElement("div");
    d.className = "area-box" + (i === selectedIndex ? " selected" : "");
    d.style.left = (a.x*100) + "%";
    d.style.top  = (a.y*100) + "%";
    d.style.width  = (a.w*100) + "%";
    d.style.height = (a.h*100) + "%";
    d.textContent = (i+1);

    d.addEventListener("mousedown", (ev) => {
      if(spaceDown) return;
      ev.stopPropagation();
      selectedIndex = i;
      renderAreas();
      renderAreaList();
      refreshPhonePreview();

      // move
      dragMode = "move";
      dragIndex = i;

      const p = getLayerPoint(ev);
      dragStart = {
        px: p.x,
        py: p.y,
        base: { ...a }
      };
    });

    // handles only when selected
    if(i === selectedIndex){
      ["nw","n","ne","e","se","s","sw","w"].forEach(key => {
        const h = document.createElement("div");
        h.className = "handle " + key;
        h.addEventListener("mousedown", (ev) => {
          ev.stopPropagation();
          dragMode = key; // resize
          dragIndex = i;

          const p = getLayerPoint(ev);
          dragStart = {
            px: p.x,
            py: p.y,
            base: { ...a }
          };
        });
        d.appendChild(h);
      });
    }

    // double click to delete
    d.ondblclick = (ev) => {
      ev.stopPropagation();
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        config.areas.splice(i, 1);
        if(selectedIndex === i) selectedIndex = -1;
        renderAreas();
        renderAreaList();
        refreshPhonePreview();
      }
    };

    layer.appendChild(d);
  });
}

/* ---------- left list ---------- */
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function renderAreaList(scrollToSelected=true){
  const list = $("areaList");
  list.innerHTML = "";
  $("areaEmpty").classList.toggle("hidden", config.areas.length !== 0);

  config.areas.forEach((a, i) => {
    const row = document.createElement("div");
    row.className = "border rounded p-2 bg-white " + (i === selectedIndex ? "ring-2 ring-blue-400" : "");
    row.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-sm">æ¡† ${i+1}</div>
        <button class="text-xs text-red-600 underline">åˆªé™¤</button>
      </div>
      <div class="text-xs text-slate-500 mb-1">é»æ­¤æ¡†é€å‡ºæ–‡å­—ï¼š</div>
      <input class="w-full border rounded px-2 py-2 text-sm font-bold"
        placeholder="ä¾‹å¦‚ï¼šMENU_SHOP / MENU_CALENDAR / MENU_NUTRITION"
        value="${escapeHtml(a.text)}">
      <div class="mt-2 grid grid-cols-2 gap-2">
        <button class="text-xs px-3 py-2 rounded bg-slate-900 text-white hover:bg-black font-bold">é¸å–</button>
        <button class="text-xs px-3 py-2 rounded bg-white border hover:bg-slate-50 font-bold">å®šä½</button>
      </div>
    `;

    const del = row.querySelector("button.text-red-600");
    const input = row.querySelector("input");
    const pickBtn = row.querySelectorAll("button")[1];
    const focusBtn = row.querySelectorAll("button")[2];

    del.onclick = () => {
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        config.areas.splice(i,1);
        if(selectedIndex === i) selectedIndex = -1;
        renderAreas();
        renderAreaList();
        refreshPhonePreview();
      }
    };
    input.oninput = () => { a.text = input.value; refreshPhonePreview(); };

    pickBtn.onclick = () => {
      selectedIndex = i;
      renderAreas();
      renderAreaList();
      refreshPhonePreview();
    };
    focusBtn.onclick = () => {
      selectedIndex = i;
      renderAreas();
      renderAreaList(false);
      refreshPhonePreview();
      focusArea(i);
    };

    list.appendChild(row);

    if(scrollToSelected && i === selectedIndex){
      setTimeout(() => row.scrollIntoView({ block:"nearest", behavior:"smooth" }), 10);
    }
  });
}

function focusArea(i){
  const a = config.areas[i];
  if(!a) return;
  const px = fromNorm(a);

  // scroll åˆ°æ¡†ä¸­å¿ƒï¼ˆæ³¨æ„ zoomï¼‰
  const cx = (px.x + px.w/2) * ZOOM;
  const cy = (px.y + px.h/2) * ZOOM;

  canvasWrap.scrollLeft = Math.max(0, cx - canvasWrap.clientWidth/2);
  canvasWrap.scrollTop  = Math.max(0, cy - canvasWrap.clientHeight/2);
}

function clearAreas(){
  if(confirm("ç¢ºå®šæ¸…ç©ºå…¨éƒ¨æ¡†ï¼Ÿ")){
    config.areas = [];
    selectedIndex = -1;
    renderAreas();
    renderAreaList();
    refreshPhonePreview();
  }
}

/* ---------- image load: sync layer size to natural image ---------- */
function syncLayerToImage(){
  const img = $("preview");
  const w = img.naturalWidth || 0;
  const h = img.naturalHeight || 0;
  if(!w || !h) return;

  img.style.width = w + "px";
  img.style.height = h + "px";
  layer.style.width = w + "px";
  layer.style.height = h + "px";
}

$("preview").addEventListener("load", () => {
  syncLayerToImage();
  renderAreas();
  refreshPhonePreview();
  fitToView();
});

/* ---------- upload ---------- */
async function pickAndUpload(){
  const base = normalizeWorkerUrl($("workerUrl").value);
  if(!base) return alert("è«‹å…ˆå¡« Worker URL");
  localStorage.setItem("line_worker_url", base);

  const input = $("fileInput");
  input.value = "";
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    setStatus("å£“ç¸®+ä¸Šå‚³ä¸­...");
    try{
      const maxSide = parseInt($("maxSide").value, 10);
      const mime = $("outFormat").value;
      const quality = parseFloat($("quality").value);
      const cropSquare = $("cropSquare").checked;

      const { blob, filename } = await compressImage(file, {maxSide, mime, quality, cropSquare});
      const url = await uploadToR2(base, blob, filename);

      config.imageUrl = url;
      config.areas = [];
      selectedIndex = -1;

      $("preview").src = url;

      setZoom(1);
      setStatus("ä¸Šå‚³å®Œæˆ âœ…");
      togglePreviewDrawer(true);
    }catch(err){
      setStatus("ä¸Šå‚³å¤±æ•—");
      alert("ä¸Šå‚³å¤±æ•—ï¼š\n" + err.message);
    }
  };
  input.click();
}

/* ---------- imagemap message build ---------- */
async function buildImagemapMessage(){
  if(!config.imageUrl) throw new Error("å°šæœªä¸Šå‚³åœ–ç‰‡");
  if(config.areas.length === 0) throw new Error("å°šæœªç•«æ¡†");
  if(config.areas.some(a => !String(a.text||"").trim())) throw new Error("æœ‰æ¡†æ²’æœ‰å¡«å…§å®¹");

  return new Promise((resolve, reject) => {
    const im = new Image();
    im.onload = () => {
      const baseW = 1040;
      const ratio = im.naturalHeight / im.naturalWidth;
      const baseH = Math.max(1040, Math.round(baseW * ratio));

      const actions = config.areas.map(a => ({
        type: "message",
        text: a.text,
        area: {
          x: Math.round(a.x * baseW),
          y: Math.round(a.y * baseH),
          width: Math.round(a.w * baseW),
          height: Math.round(a.h * baseH)
        }
      }));

      resolve({
        type: "imagemap",
        baseUrl: config.imageUrl,
        altText: "è«‹é»é¸",
        baseSize: { width: baseW, height: baseH },
        actions
      });
    };
    im.onerror = () => reject(new Error("è®€å–åœ–ç‰‡å°ºå¯¸å¤±æ•—ï¼Œè«‹ç¢ºèªåœ–ç‰‡ URL å¯å…¬é–‹å­˜å–"));
    im.src = config.imageUrl;
  });
}

/* ---------- save/load (ç„¡å¯†ç¢¼ç‰ˆ) ---------- */
async function saveConfig(){
  const base = normalizeWorkerUrl($("workerUrl").value);
  const keyword = $("triggerKeyword").value.trim();
  if(!base || !keyword) return alert("è«‹å¡« Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem("line_worker_url", base);

  try{
    const msg = await buildImagemapMessage();
    const payload = { mode:"imagemap", messages:[msg] };
    await postJSON(base + "/save", { keyword, payload });
    setStatus("å„²å­˜æˆåŠŸ âœ…");
    alert("å„²å­˜æˆåŠŸï¼\nä½¿ç”¨è€…è¼¸å…¥è§¸ç™¼é—œéµå­—ï¼šã€Œ" + keyword + "ã€å°±æœƒå‡ºç¾é€™å¼µåœ–ã€‚");
  }catch(e){
    setStatus("å„²å­˜å¤±æ•—");
    alert("å„²å­˜å¤±æ•—ï¼š\n" + e.message);
  }
}

async function loadConfig(){
  const base = normalizeWorkerUrl($("workerUrl").value);
  const keyword = $("triggerKeyword").value.trim();
  if(!base || !keyword) return alert("è«‹å¡« Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem("line_worker_url", base);

  try{
    const data = await postJSON(base + "/load", { keyword });
    const obj = (typeof data === "string") ? JSON.parse(data) : data;

    if(obj.mode !== "imagemap" || !obj.messages?.[0]) throw new Error("ä¸æ˜¯ imagemap æ ¼å¼");
    const m = obj.messages[0];

    config.imageUrl = m.baseUrl;
    $("preview").src = config.imageUrl;

    const bw = m.baseSize?.width || 1040;
    const bh = m.baseSize?.height || 1040;

    config.areas = (m.actions || []).map(a => ({
      x: (a.area?.x || 0) / bw,
      y: (a.area?.y || 0) / bh,
      w: (a.area?.width || 0) / bw,
      h: (a.area?.height || 0) / bh,
      text: a.text || ""
    }));

    selectedIndex = -1;
    renderAreas();
    renderAreaList();
    refreshPhonePreview();

    setStatus("è®€å–æˆåŠŸ âœ…");
    togglePreviewDrawer(true);
  }catch(e){
    setStatus("è®€å–å¤±æ•—");
    alert("è®€å–å¤±æ•—ï¼š\n" + e.message);
  }
}

/* ---------- LIFF send test ---------- */
async function sendTestToMe(){
  if(!isReady) return alert("LIFF å°šæœªåˆå§‹åŒ–å®Œæˆ");
  if(!liff.isInClient()) return alert("è«‹åœ¨ LINE å…§é–‹å•Ÿï¼ˆå½ˆçª—ï¼‰æ‰å¯é€æ¸¬è©¦è¨Šæ¯");
  try{
    const msg = await buildImagemapMessage();
    await liff.sendMessages([msg]);
    alert("å·²æŠŠ imagemap é€åˆ°ä½ ç›®å‰çš„èŠå¤©å®¤ âœ…");
  }catch(e){
    alert("é€æ¸¬è©¦å¤±æ•—ï¼š\n" + e.message);
  }
}
async function sendPreviewToMe(){ return sendTestToMe(); }

/* ---------- preview drawer ---------- */
$("showHotspots").addEventListener("change", () => refreshPhonePreview());

function togglePreviewDrawer(open){
  const overlay = $("drawerOverlay");
  const drawer = $("previewDrawer");
  if(open){
    overlay.classList.remove("hidden");
    drawer.classList.remove("translate-y-full");
    refreshPhonePreview();
  }else{
    overlay.classList.add("hidden");
    drawer.classList.add("translate-y-full");
  }
}

function refreshPhonePreview(){
  const img = $("phoneImg");
  const wrap = $("phoneHotspots");
  if(!config.imageUrl){
    img.src = "";
    wrap.innerHTML = "";
    return;
  }

  img.src = config.imageUrl;
  wrap.innerHTML = "";

  requestAnimationFrame(() => {
    const show = $("showHotspots").checked;
    const r = wrap.getBoundingClientRect();
    if(!r.width || !r.height) return;

    config.areas.forEach((a, i) => {
      if(show){
        const box = document.createElement("div");
        box.className = "preview-hotspot";
        box.style.left = (a.x * r.width) + "px";
        box.style.top  = (a.y * r.height) + "px";
        box.style.width  = (a.w * r.width) + "px";
        box.style.height = (a.h * r.height) + "px";
        wrap.appendChild(box);
      }
      const btn = document.createElement("button");
      btn.style.position="absolute";
      btn.style.left = (a.x*100)+"%";
      btn.style.top  = (a.y*100)+"%";
      btn.style.width = (a.w*100)+"%";
      btn.style.height= (a.h*100)+"%";
      btn.style.background="transparent";
      btn.onclick = () => alert(`ç†±å€ ${i+1}\nå°‡é€å‡ºï¼š${(a.text||"").trim() || "ï¼ˆå°šæœªå¡«ï¼‰"}`);
      wrap.appendChild(btn);
    });
  });
}

/* ---------- LIFF init / close ---------- */
async function initLIFF(){
  try{
    $("liffState").textContent = "åˆå§‹åŒ–ä¸­...";
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      $("liffState").textContent = "éœ€è¦ç™»å…¥";
      liff.login();
      return;
    }

    $("liffState").textContent = liff.isInClient() ? "LINE å…§ï¼ˆå½ˆçª—ï¼‰" : "å¤–éƒ¨ç€è¦½å™¨";
    if(liff.getProfile){
      const p = await liff.getProfile();
      $("userName").textContent = p.displayName || "-";
    }

    const savedUrl = localStorage.getItem("line_worker_url");
    if(savedUrl) $("workerUrl").value = savedUrl;

    isReady = true;
    setStatus("å°±ç·’ âœ…ï¼ˆå¯ä¸Šå‚³ã€ç•«æ¡†ã€å„²å­˜ï¼‰");

    syncMainHeight();
    setZoom(1);
  }catch(e){
    $("liffState").textContent = "åˆå§‹åŒ–å¤±æ•—";
    setStatus("åˆå§‹åŒ–å¤±æ•—");
    alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š\n" + e.message);
  }
}

function closeLiff(){
  if(window.liff && liff.isInClient()) liff.closeWindow();
  else window.close();
}

/* ---------- start ---------- */
initLIFF();
</script>
</body>
</html>
