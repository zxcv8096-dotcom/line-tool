<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¼•æµåœ–ç·¨è¼¯å™¨ (R2 å£“ç¸®ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .area-box{
      position:absolute;
      border:2px solid rgba(255,0,0,.85);
      background:rgba(255,0,0,.22);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:800;
      font-size:14px;
      text-shadow:0 1px 2px rgba(0,0,0,.9);
      user-select:none;
    }
    .draw-rect{
      position:absolute;
      border:2px dashed rgba(0,0,0,.6);
      background:rgba(0,0,0,.10);
      pointer-events:none;
    }
  </style>
</head>

<body class="bg-slate-100 h-screen flex flex-col text-slate-800">

  <div class="bg-white shadow p-4 z-10 flex justify-between items-center">
    <h1 class="font-bold text-xl text-blue-600 flex items-center gap-2">
      <a href="index.html" class="text-2xl hover:bg-slate-100 rounded px-1">ğŸ”™</a>
      å¼•æµåœ–ç·¨è¼¯å™¨ (R2 å£“ç¸®ç‰ˆ)
    </h1>

    <div class="flex gap-2">
      <input type="text" id="workerUrl" placeholder="https://xxxx.workers.dev"
        class="border rounded px-2 text-sm w-60 bg-yellow-50">
      <input type="text" id="triggerKeyword" placeholder="æœ¬åœ–é—œéµå­—"
        class="border rounded px-2 text-sm font-bold w-40 border-blue-500">
      <button onclick="loadSettings()" class="bg-gray-500 text-white px-3 rounded text-sm hover:bg-gray-600">è®€å–</button>
      <button onclick="saveSettings()" class="bg-green-600 text-white px-3 rounded text-sm hover:bg-green-700">å„²å­˜</button>
    </div>
  </div>

  <div class="flex flex-1 overflow-hidden w-full">

    <!-- å·¦å´ -->
    <div class="w-72 bg-white border-r overflow-y-auto p-4 flex flex-col gap-4">
      <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
        <strong>æ“ä½œï¼š</strong><br>
        æ–°å¢åœ–ç‰‡ â†’ ä¸Šå‚³ï¼ˆè‡ªå‹•å£“ç¸®ï¼‰â†’ æ‹–æ›³ç•«æ¡†ï¼ˆä¸é™æ•¸é‡ï¼‰â†’ å³å´å¡«å…§å®¹ã€‚
      </div>

      <button onclick="addImageBlock()"
        class="w-full py-3 border-2 border-dashed border-blue-300 text-blue-500 rounded font-bold hover:bg-blue-50">
        + æ–°å¢åœ–ç‰‡
      </button>

      <div id="imageList" class="space-y-4"></div>
    </div>

    <!-- å³å´ï¼šç·¨è¼¯å€ -->
    <div class="flex-1 bg-slate-200 relative overflow-auto flex justify-center p-6">
      <div id="editorWrap" class="hidden w-full max-w-6xl grid grid-cols-1 xl:grid-cols-[360px_1fr] gap-4">
        <!-- æ¡†æ¡†è¨­å®š -->
        <div class="bg-white rounded-lg shadow p-4 h-fit">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold text-slate-700">æ¡†æ¡†è¨­å®š</div>
            <button onclick="clearAreas()" class="text-xs text-red-600 underline">æ¸…ç©ºæœ¬åœ–å…¨éƒ¨æ¡†</button>
          </div>

          <div class="border rounded p-3 mb-3 bg-slate-50">
            <div class="font-bold text-xs text-slate-600 mb-2">åœ–ç‰‡å£“ç¸®è¨­å®šï¼ˆä¸Šå‚³æ™‚ç”Ÿæ•ˆï¼‰</div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <label class="flex flex-col gap-1">
                <span class="text-slate-500">æœ€å¤§å¯¬</span>
                <select id="maxWidth" class="border rounded px-2 py-1">
                  <option value="960">960</option>
                  <option value="1280" selected>1280</option>
                  <option value="1600">1600</option>
                  <option value="2048">2048</option>
                </select>
              </label>
              <label class="flex flex-col gap-1">
                <span class="text-slate-500">æ ¼å¼</span>
                <select id="outFormat" class="border rounded px-2 py-1">
                  <option value="image/webp" selected>WebPï¼ˆæ¨è–¦ï¼‰</option>
                  <option value="image/jpeg">JPEG</option>
                  <option value="image/png">PNGï¼ˆä¸å»ºè­°ï¼‰</option>
                </select>
              </label>
              <label class="flex flex-col gap-1 col-span-2">
                <span class="text-slate-500">å“è³ªï¼ˆ0.5ï½0.95ï¼‰</span>
                <input id="quality" type="range" min="0.5" max="0.95" step="0.01" value="0.82">
                <div class="text-right text-[11px] text-slate-500">ç›®å‰ï¼š<span id="qVal">0.82</span></div>
              </label>
            </div>
          </div>

          <div class="text-xs text-slate-500 mb-2">
            æ¯ä¸€å€‹æ¡†éƒ½è¦å¡«å…§å®¹ï¼š<br>ã€Œç™¼æ–‡å­—ã€= é—œéµå­—ï¼›ã€Œé–‹ç¶²é ã€= å®Œæ•´ç¶²å€ã€‚
          </div>

          <div id="areaList" class="space-y-2"></div>
        </div>

        <!-- åœ–ç‰‡ç•«æ¡†å€ -->
        <div class="bg-white shadow-lg relative rounded overflow-hidden">
          <div class="relative">
            <img id="previewImage" class="block pointer-events-none select-none w-full max-h-[680px] object-contain bg-gray-100">
            <button onclick="triggerUpload(currentImgIndex, this)"
              class="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded">
              ğŸ“· ä¸Šå‚³åœ–ç‰‡åˆ° R2ï¼ˆå£“ç¸®ï¼‰
            </button>
            <div id="drawLayer" class="absolute inset-0 cursor-crosshair"></div>
          </div>
          <div class="p-3 bg-gray-50 text-center text-xs text-gray-600">
            åœ¨åœ–ç‰‡ä¸ŠæŒ‰ä½æ‹–æ›³ç•«æ¡†ã€‚é»ç´…æ¡†å¯åˆªé™¤ã€‚
          </div>
        </div>
      </div>

      <div id="emptyState" class="text-slate-400 mt-20 flex flex-col items-center">
        <span class="text-6xl mb-4">ğŸ‘ˆ</span><span>è«‹å¾å·¦å´æ–°å¢åœ–ç‰‡</span>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" class="hidden">

<script>
/* ---------- å…±ç”¨å·¥å…· ---------- */
function normalizeWorkerUrl(raw){
  if(!raw) return '';
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
  return s.replace(/\/+$/,'');
}
async function postJSON(url, data){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status} ${res.statusText}\n${txt}`);
  }
  const ct = res.headers.get('content-type') || '';
  if(ct.includes('application/json')) return await res.json();
  return await res.text();
}
async function uploadToR2(workerBaseUrl, fileBlob, filename){
  const form = new FormData();
  form.append('file', fileBlob, filename || 'image.webp');
  const res = await fetch(workerBaseUrl + '/upload', { method:'POST', body: form });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const j = await res.json();
  if(!j.ok || !j.url) throw new Error('ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°');
  return j.url;
}

/* ---------- å£“ç¸® ---------- */
async function compressImage(file, {maxWidth, mime, quality}){
  const img = await createImageBitmap(file);
  const scale = Math.min(1, maxWidth / img.width);
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d', { alpha: true });
  ctx.drawImage(img, 0, 0, w, h);

  const outBlob = await new Promise((resolve) => {
    if (mime === 'image/png') canvas.toBlob(resolve, mime);
    else canvas.toBlob(resolve, mime, quality);
  });
  if(!outBlob) throw new Error('å£“ç¸®å¤±æ•—ï¼ˆtoBlob å›å‚³ç©ºï¼‰');

  const ext = (mime === 'image/webp') ? 'webp' : (mime === 'image/jpeg') ? 'jpg' : 'png';
  const safeName = (file.name || 'image').replace(/\.[^/.]+$/, '');
  return { blob: outBlob, filename: `${safeName}.${ext}`, w, h };
}

function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* ---------- ç‹€æ…‹ ---------- */
let images = []; // {url:'', areas:[{x,y,w,h,type,text}]}  x,y,w,h ç‚º 0~1 æ¯”ä¾‹
let currentImgIndex = -1;

window.onload = () => {
  const savedUrl = localStorage.getItem('line_worker_url');
  if(savedUrl) document.getElementById('workerUrl').value = savedUrl;

  const q = document.getElementById('quality');
  const qVal = document.getElementById('qVal');
  q.addEventListener('input', () => qVal.textContent = q.value);
};

/* ---------- å·¦å´åˆ—è¡¨ ---------- */
function addImageBlock(){
  images.push({ url:'', areas:[] });
  renderImageList();
  selectImage(images.length - 1);
}
function renderImageList(){
  const list = document.getElementById('imageList');
  list.innerHTML = '';
  images.forEach((img, idx) => {
    const div = document.createElement('div');
    div.className = `p-2 border rounded ${idx === currentImgIndex ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} cursor-pointer`;

    div.innerHTML = `
      <div class="flex justify-between mb-2">
        <span class="font-bold text-xs">åœ–ç‰‡ ${idx + 1}</span>
        <button class="text-red-500 text-xs" onclick="event.stopPropagation();removeImage(${idx});">âœ•</button>
      </div>
      ${img.url ? `<img src="${img.url}" class="w-full h-24 object-cover rounded mb-2 border">`
               : `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-xs text-gray-400 rounded mb-2 border">ç„¡åœ–ç‰‡</div>`}
      <button class="w-full bg-blue-600 text-white text-xs py-2 rounded hover:bg-blue-700 font-bold"
        onclick="event.stopPropagation();triggerUpload(${idx}, this);">
        ä¸Šå‚³åˆ° R2ï¼ˆå£“ç¸®ï¼‰
      </button>
      <div class="mt-1 text-[10px] text-gray-500 text-right">ç†±å€: ${img.areas.length}</div>
    `;

    div.onclick = () => selectImage(idx);
    list.appendChild(div);
  });
}
function removeImage(idx){
  images.splice(idx, 1);
  renderImageList();
  selectImage(images.length ? Math.min(idx, images.length-1) : -1);
}
function selectImage(idx){
  currentImgIndex = idx;

  const wrap = document.getElementById('editorWrap');
  const empty = document.getElementById('emptyState');
  if(idx === -1 || !images[idx]){
    wrap.classList.add('hidden');
    empty.classList.remove('hidden');
    return;
  }
  wrap.classList.remove('hidden');
  empty.classList.add('hidden');

  const preview = document.getElementById('previewImage');
  preview.src = images[idx].url || '';
  renderAreas();
  renderAreaList();
}

/* ---------- æ¸…ç©ºæ¡† ---------- */
function clearAreas(){
  if(currentImgIndex < 0) return;
  if(confirm('ç¢ºå®šæ¸…ç©ºæœ¬åœ–å…¨éƒ¨æ¡†ï¼Ÿ')){
    images[currentImgIndex].areas = [];
    renderAreas(); renderAreaList(); renderImageList();
  }
}

/* ---------- ä¸Šå‚³ï¼ˆå£“ç¸®â†’R2ï¼‰ ---------- */
async function triggerUpload(idx, btn){
  const raw = document.getElementById('workerUrl').value;
  const base = normalizeWorkerUrl(raw);
  if(!base) return alert('è«‹å…ˆå¡« WorkerUrl');
  localStorage.setItem('line_worker_url', base);

  const input = document.getElementById('fileInput');
  input.value = '';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    const oldText = btn.innerText;
    btn.innerText = "â³ å£“ç¸®+ä¸Šå‚³ä¸­...";
    btn.disabled = true;

    try{
      const maxWidth = parseInt(document.getElementById('maxWidth').value, 10);
      const mime = document.getElementById('outFormat').value;
      const quality = parseFloat(document.getElementById('quality').value);

      const { blob, filename } = await compressImage(file, { maxWidth, mime, quality });
      const url = await uploadToR2(base, blob, filename);

      images[idx].url = url;
      images[idx].areas = []; // æ›åœ–æ¸…ç©ºç†±å€
      renderImageList();
      selectImage(idx);
    }catch(err){
      alert('ä¸Šå‚³å¤±æ•—ï¼š\n' + err.message);
    }

    btn.innerText = oldText;
    btn.disabled = false;
  };
  input.click();
}

/* ---------- ç•«æ¡†ï¼ˆæ¯”ä¾‹ï¼‰ ---------- */
const layer = document.getElementById('drawLayer');
let isDrawing = false;
let sx = 0, sy = 0;
let previewRect = null;

layer.addEventListener('mousedown', (e) => {
  if(currentImgIndex < 0) return;
  if(!images[currentImgIndex].url) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼ˆR2ï¼‰å†ç•«æ¡†');

  const rect = layer.getBoundingClientRect();
  isDrawing = true;
  sx = e.clientX - rect.left;
  sy = e.clientY - rect.top;

  previewRect = document.createElement('div');
  previewRect.className = 'draw-rect';
  previewRect.style.left = sx + 'px';
  previewRect.style.top = sy + 'px';
  previewRect.style.width = '0px';
  previewRect.style.height = '0px';
  layer.appendChild(previewRect);
});

layer.addEventListener('mousemove', (e) => {
  if(!isDrawing || !previewRect) return;
  const rect = layer.getBoundingClientRect();
  const cx = e.clientX - rect.left;
  const cy = e.clientY - rect.top;

  const x = Math.min(sx, cx);
  const y = Math.min(sy, cy);
  const w = Math.abs(cx - sx);
  const h = Math.abs(cy - sy);

  previewRect.style.left = x + 'px';
  previewRect.style.top = y + 'px';
  previewRect.style.width = w + 'px';
  previewRect.style.height = h + 'px';
});

layer.addEventListener('mouseup', (e) => {
  if(!isDrawing) return;
  isDrawing = false;

  const rect = layer.getBoundingClientRect();
  const ex = e.clientX - rect.left;
  const ey = e.clientY - rect.top;

  const x = Math.min(sx, ex);
  const y = Math.min(sy, ey);
  const w = Math.abs(ex - sx);
  const h = Math.abs(ey - sy);

  if(previewRect){
    previewRect.remove();
    previewRect = null;
  }

  if(w < 14 || h < 14) return;

  images[currentImgIndex].areas.push({
    x: x / rect.width,
    y: y / rect.height,
    w: w / rect.width,
    h: h / rect.height,
    type: 'message',
    text: ''
  });

  renderAreas();
  renderAreaList();
  renderImageList();
});

function renderAreas(){
  layer.querySelectorAll('.area-box').forEach(el => el.remove());
  if(currentImgIndex < 0) return;

  const areas = images[currentImgIndex].areas;
  areas.forEach((a, i) => {
    const d = document.createElement('div');
    d.className = 'area-box';
    d.style.left = (a.x * 100) + '%';
    d.style.top  = (a.y * 100) + '%';
    d.style.width  = (a.w * 100) + '%';
    d.style.height = (a.h * 100) + '%';
    d.innerText = i + 1;

    d.onclick = (e) => {
      e.stopPropagation();
      if(confirm(`åˆªé™¤å€åŸŸ ${i+1}?`)){
        images[currentImgIndex].areas.splice(i, 1);
        renderAreas();
        renderAreaList();
        renderImageList();
      }
    };

    layer.appendChild(d);
  });
}

/* ---------- æ¡†æ¸…å–®ï¼šè¼¸å…¥ keyword/url ---------- */
function renderAreaList(){
  const box = document.getElementById('areaList');
  box.innerHTML = '';
  if(currentImgIndex < 0) return;

  const areas = images[currentImgIndex].areas;

  if(areas.length === 0){
    box.innerHTML = `<div class="text-xs text-slate-400">ç›®å‰æ²’æœ‰æ¡†ï¼Œå»åœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†ã€‚</div>`;
    return;
  }

  areas.forEach((a, i) => {
    const typeLabel = a.type === 'uri' ? 'é–‹ç¶²é ' : 'ç™¼æ–‡å­—';
    const placeholder = a.type === 'uri' ? 'è²¼ç¶²å€ https://...' : 'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰';

    const row = document.createElement('div');
    row.className = 'border rounded p-2 bg-white';
    row.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-sm">æ¡† ${i+1}</div>
        <button class="text-xs text-red-600 underline">åˆªé™¤</button>
      </div>

      <div class="grid grid-cols-3 gap-2 text-xs">
        <label class="col-span-1 flex flex-col gap-1">
          <span class="text-slate-500">å‹•ä½œ</span>
          <select class="border rounded px-2 py-1">
            <option value="message" ${a.type==='message'?'selected':''}>ç™¼æ–‡å­—</option>
            <option value="uri" ${a.type==='uri'?'selected':''}>é–‹ç¶²é </option>
          </select>
        </label>

        <label class="col-span-2 flex flex-col gap-1">
          <span class="text-slate-500">å…§å®¹</span>
          <input class="border rounded px-2 py-1" value="${escapeHtml(a.text||'')}" placeholder="${placeholder}">
        </label>
      </div>

      <div class="text-[11px] text-slate-400 mt-2">ç›®å‰ï¼š${typeLabel}</div>
    `;

    const delBtn = row.querySelector('button');
    const sel = row.querySelector('select');
    const input = row.querySelector('input');

    delBtn.onclick = () => {
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        images[currentImgIndex].areas.splice(i, 1);
        renderAreas(); renderAreaList(); renderImageList();
      }
    };

    sel.onchange = () => {
      a.type = sel.value;
      input.placeholder = a.type === 'uri' ? 'è²¼ç¶²å€ https://...' : 'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰';
      renderAreaList();
    };

    input.oninput = () => {
      a.text = input.value;
    };

    box.appendChild(row);
  });
}

/* ---------- imagemap ç”¢ç”Ÿï¼ˆ1040åŸºæº–ï¼Œéœ€è¦åœ–ç‰‡ natural å°ºå¯¸ï¼‰ ---------- */
function buildImagemapMessages(){
  return Promise.all(images.map(img => new Promise((resolve) => {
    const im = new Image();
    im.onload = () => {
      const baseW = 1040;
      const ratio = im.naturalHeight / im.naturalWidth;
      const baseH = Math.round(baseW * ratio);

      const actions = img.areas.map(a => ({
        type: a.type,
        text: a.type === 'message' ? a.text : undefined,
        linkUri: a.type === 'uri' ? a.text : undefined,
        area: {
          x: Math.round(a.x * baseW),
          y: Math.round(a.y * baseH),
          width: Math.round(a.w * baseW),
          height: Math.round(a.h * baseH)
        }
      }));

      resolve({
        type: "imagemap",
        baseUrl: img.url,
        altText: "é¸å–®",
        baseSize: { width: baseW, height: baseH },
        actions
      });
    };
    im.onerror = () => {
      // fallbackï¼ˆä¸å»ºè­°ï¼Œä½†é¿å…æ•´æ‰¹å£æ‰ï¼‰
      resolve({
        type: "imagemap",
        baseUrl: img.url,
        altText: "é¸å–®",
        baseSize: { width: 1040, height: 1040 },
        actions: []
      });
    };
    im.src = img.url;
  })));
}

/* ---------- save/load ---------- */
async function saveSettings(){
  const raw = document.getElementById('workerUrl').value;
  const keyword = document.getElementById('triggerKeyword').value.trim();
  const base = normalizeWorkerUrl(raw);

  if(!base || !keyword) return alert('è³‡æ–™ä¸å…¨ï¼ˆWorkerUrl / é—œéµå­—ï¼‰');
  if(images.length === 0) return alert('è‡³å°‘æ–°å¢ä¸€å¼µåœ–ç‰‡');
  if(images.some(i => !i.url)) return alert('æœ‰åœ–ç‰‡å°šæœªä¸Šå‚³åˆ° R2');

  // æ¯å€‹æ¡†è¦æœ‰å…§å®¹
  const bad = images.some(img => img.areas.some(a => !String(a.text||'').trim()));
  if(bad) return alert('æœ‰æ¡†æ²’æœ‰å¡«å…§å®¹ï¼ˆé—œéµå­—æˆ–ç¶²å€ï¼‰');

  localStorage.setItem('line_worker_url', base);

  try{
    const messages = await buildImagemapMessages();

    await postJSON(base + '/save', {
      password:'1234',
      keyword,
      payload:{ mode:'imagemap', messages }
    });

    alert('å„²å­˜æˆåŠŸï¼');
  }catch(e){
    alert('å„²å­˜å¤±æ•—ï¼š\n' + e.message);
  }
}

async function loadSettings(){
  const raw = document.getElementById('workerUrl').value;
  const keyword = document.getElementById('triggerKeyword').value.trim();
  const base = normalizeWorkerUrl(raw);

  if(!base || !keyword) return alert('è³‡æ–™ä¸å…¨ï¼ˆWorkerUrl / é—œéµå­—ï¼‰');
  localStorage.setItem('line_worker_url', base);

  try{
    const data = await postJSON(base + '/load', { password:'1234', keyword });
    const obj = (typeof data === 'string') ? JSON.parse(data) : data;

    if(!obj.messages || !Array.isArray(obj.messages)){
      return alert('è®€åˆ°è³‡æ–™ä½†æ ¼å¼ä¸å°ï¼ˆæ²’æœ‰ messagesï¼‰');
    }

    // LINE çš„ area(px) -> è½‰æ¯”ä¾‹ 0~1ï¼Œæ–¹ä¾¿ç•«é¢ç¸®æ”¾
    images = obj.messages.map(m => {
      const bw = m.baseSize?.width || 1040;
      const bh = m.baseSize?.height || 1040;
      return {
        url: m.baseUrl,
        areas: (m.actions || []).map(a => ({
          type: a.type,
          text: a.type === 'message' ? (a.text || '') : (a.linkUri || ''),
          x: (a.area.x || 0) / bw,
          y: (a.area.y || 0) / bh,
          w: (a.area.width || 0) / bw,
          h: (a.area.height || 0) / bh,
        }))
      };
    });

    renderImageList();
    selectImage(images.length ? 0 : -1);
    alert('è®€å–æˆåŠŸï¼');
  }catch(e){
    alert('è®€å–å¤±æ•—ï¼š\n' + e.message);
  }
}
</script>

</body>
</html>
