<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¼•æµåœ–ç·¨è¼¯å™¨ (Imgur ç©©å®šç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .area-box{
      position:absolute;
      border:2px solid rgba(255,0,0,.85);
      background:rgba(255,0,0,.22);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:700;
      font-size:14px;
      text-shadow:0 1px 2px rgba(0,0,0,.9);
      user-select:none;
    }
  </style>
</head>

<body class="bg-slate-100 h-screen flex flex-col text-slate-800">

  <!-- Header -->
  <div class="bg-white shadow p-4 z-10 flex justify-between items-center">
    <h1 class="font-bold text-xl text-blue-600 flex items-center gap-2">
      <a href="index.html" class="text-2xl hover:bg-slate-100 rounded px-1">ğŸ”™</a>
      å¼•æµåœ–ç·¨è¼¯å™¨
    </h1>

    <div class="flex gap-2">
      <input type="text" id="workerUrl" placeholder="https://xxxx.workers.dev"
        class="border rounded px-2 text-sm w-56 bg-yellow-50">
      <input type="text" id="triggerKeyword" placeholder="æœ¬åœ–é—œéµå­—"
        class="border rounded px-2 text-sm font-bold w-36 border-blue-500">
      <button onclick="loadSettings()" class="bg-gray-500 text-white px-3 rounded text-sm hover:bg-gray-600">è®€å–</button>
      <button onclick="saveSettings()" class="bg-green-600 text-white px-3 rounded text-sm hover:bg-green-700">å„²å­˜</button>
      <button onclick="resetImgur()" class="text-xs text-gray-400 underline ml-2">é‡è¨­ Imgur ID</button>
    </div>
  </div>

  <div class="flex flex-1 overflow-hidden w-full">

    <!-- å·¦å´ -->
    <div class="w-72 bg-white border-r overflow-y-auto p-4 flex flex-col gap-4">
      <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
        <strong>ç©©å®šæ¨¡å¼ï¼š</strong><br>
        åœ–ç‰‡ä¸Šå‚³åˆ° Imgurï¼Œè¨­å®šå­˜åˆ° Cloudflare Worker(KV)ã€‚<br>
        ä½ åªè¦å¡« WorkerUrl + é—œéµå­— â†’ å„²å­˜/è®€å–å°±èƒ½ç”¨ã€‚
      </div>

      <button onclick="addImageBlock()"
        class="w-full py-3 border-2 border-dashed border-blue-300 text-blue-500 rounded font-bold hover:bg-blue-50">
        + æ–°å¢åœ–ç‰‡
      </button>

      <div id="imageList" class="space-y-4"></div>
    </div>

    <!-- å³å´ -->
    <div class="flex-1 bg-slate-200 relative overflow-auto flex justify-center p-8">
      <div id="canvasContainer" class="bg-white shadow-lg relative hidden rounded overflow-hidden">
        <img id="previewImage" class="block pointer-events-none select-none" style="max-width: 720px;">
        <div id="drawLayer" class="absolute inset-0 cursor-crosshair"></div>
      </div>

      <div id="emptyState" class="text-slate-400 mt-20 flex flex-col items-center">
        <span class="text-6xl mb-4">ğŸ‘ˆ</span><span>è«‹å¾å·¦å´æ–°å¢åœ–ç‰‡</span>
      </div>
    </div>

  </div>

  <input type="file" id="fileInput" accept="image/*" class="hidden">

<script>
/* ================= å·¥å…·ï¼šWorker URL æ­£è¦åŒ– + é€ JSON ================= */
function normalizeWorkerUrl(raw){
  if(!raw) return '';
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
  return s.replace(/\/+$/,'');
}

async function postJSON(url, data){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });

  if(!res.ok){
    const txt = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status} ${res.statusText}\n${txt}`);
  }

  const ct = res.headers.get('content-type') || '';
  if(ct.includes('application/json')) return await res.json();
  return await res.text();
}

/* ================= ç‹€æ…‹ ================= */
let images = [];
let currentImgIndex = -1;

// ç•«æ¡†æš«å­˜ï¼šç”¨ã€Œæ¯”ä¾‹ã€å­˜ï¼Œé¿å…ç¸®æ”¾å•é¡Œ
let isDrawing = false;
let startX = 0, startY = 0;

/* ================= åˆå§‹åŒ– ================= */
window.onload = () => {
  const savedUrl = localStorage.getItem('line_worker_url');
  if(savedUrl) document.getElementById('workerUrl').value = savedUrl;
};

/* ================= å·¦å´åˆ—è¡¨ ================= */
function addImageBlock(){
  images.push({ url:'', areas:[] }); // areas: [{x,y,w,h,type,text}] éƒ½æ˜¯ 0~1 æ¯”ä¾‹
  renderImageList();
  selectImage(images.length - 1);
}

function renderImageList(){
  const list = document.getElementById('imageList');
  list.innerHTML = '';

  images.forEach((img, idx) => {
    const div = document.createElement('div');
    div.className = `p-2 border rounded ${idx===currentImgIndex ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} cursor-pointer`;

    div.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <span class="font-bold text-xs">åœ–ç‰‡ ${idx+1}</span>
        <button class="text-red-500 text-xs" onclick="event.stopPropagation();removeImage(${idx});">âœ•</button>
      </div>

      ${img.url
        ? `<img src="${img.url}" class="w-full h-24 object-cover rounded mb-2 border">`
        : `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-xs text-gray-400 rounded mb-2 border">ç„¡åœ–ç‰‡</div>`
      }

      <button class="w-full bg-blue-600 text-white text-xs py-2 rounded hover:bg-blue-700 font-bold"
        onclick="event.stopPropagation();triggerUpload(${idx}, this);">
        ä¸Šå‚³åˆ° Imgur
      </button>

      <div class="mt-1 text-[10px] text-gray-500 text-right">ç†±å€: ${img.areas.length}</div>
    `;

    div.onclick = () => selectImage(idx);
    list.appendChild(div);
  });
}

function removeImage(idx){
  images.splice(idx, 1);
  renderImageList();
  selectImage(images.length ? Math.min(idx, images.length-1) : -1);
}

/* ================= é¸å–åœ–ç‰‡ ================= */
function selectImage(idx){
  currentImgIndex = idx;

  const canvas = document.getElementById('canvasContainer');
  const empty = document.getElementById('emptyState');
  const preview = document.getElementById('previewImage');

  if(idx === -1 || !images[idx] || !images[idx].url){
    canvas.classList.add('hidden');
    empty.classList.remove('hidden');
    return;
  }

  preview.src = images[idx].url;
  preview.onload = () => {
    canvas.classList.remove('hidden');
    empty.classList.add('hidden');
    renderAreas();
  };
}

/* ================= Imgur ================= */
function getImgurClientId(){
  let id = localStorage.getItem('imgur_client_id');
  if(!id){
    id = prompt("è«‹è¼¸å…¥ Imgur Client ID\n(å…¬é–‹æ¸¬è©¦ID: 546c25a59c58ad7)", "546c25a59c58ad7");
    if(id) localStorage.setItem('imgur_client_id', id);
  }
  return id;
}

function resetImgur(){
  localStorage.removeItem('imgur_client_id');
  alert("å·²é‡ç½®ï¼Œä¸‹æ¬¡ä¸Šå‚³æœƒå†è©¢å•ã€‚");
}

async function triggerUpload(idx, btn){
  const clientId = getImgurClientId();
  if(!clientId) return alert("æœªè¼¸å…¥ Client ID");

  const input = document.getElementById('fileInput');
  input.value = '';

  input.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    const oldText = btn.innerText;
    btn.innerText = "â³ ä¸Šå‚³ä¸­...";
    btn.disabled = true;

    try{
      const formData = new FormData();
      formData.append('image', file);

      const res = await fetch('https://api.imgur.com/3/image', {
        method:'POST',
        headers:{ 'Authorization': 'Client-ID ' + clientId },
        body: formData
      });

      const json = await res.json();

      if(json.success){
        images[idx].url = json.data.link;
        images[idx].areas = []; // æ›åœ–å°±æ¸…ç©ºç†±å€ï¼ˆé¿å…ç†±å€å°ä¸ä¸Šï¼‰
        renderImageList();
        selectImage(idx);
      } else {
        const err = (json && json.data && json.data.error) ? json.data.error : 'æœªçŸ¥éŒ¯èª¤';
        alert('Imgur ä¸Šå‚³å¤±æ•—ï¼š' + err + (json.status === 429 ? '\n(å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦)' : ''));
      }
    }catch(e){
      alert('Imgur é€£ç·šéŒ¯èª¤ï¼š\n' + e.message);
    }

    btn.innerText = oldText;
    btn.disabled = false;
  };

  input.click();
}

/* ================= ç•«æ¡†ï¼ˆç”¨æ¯”ä¾‹ï¼‰ ================= */
const layer = document.getElementById('drawLayer');

layer.onmousedown = (e) => {
  if(currentImgIndex === -1) return;
  isDrawing = true;

  const rect = layer.getBoundingClientRect();
  startX = (e.clientX - rect.left) / rect.width;
  startY = (e.clientY - rect.top) / rect.height;
};

layer.onmouseup = (e) => {
  if(!isDrawing) return;
  isDrawing = false;

  const rect = layer.getBoundingClientRect();
  const endX = (e.clientX - rect.left) / rect.width;
  const endY = (e.clientY - rect.top) / rect.height;

  const x = Math.min(startX, endX);
  const y = Math.min(startY, endY);
  const w = Math.abs(endX - startX);
  const h = Math.abs(endY - startY);

  if(w < 0.03 || h < 0.03) return; // å¤ªå°ä¸è¨˜

  const typeIn = prompt("å‹•ä½œ? (text=ç™¼æ–‡å­—, link=é–‹ç¶²é )", "text");
  if(!typeIn) return;

  const content = prompt("å…§å®¹? (é—œéµå­— æˆ– ç¶²å€)");
  if(!content) return;

  images[currentImgIndex].areas.push({
    x, y, w, h,
    type: (typeIn === 'link') ? 'uri' : 'message',
    text: content.trim()
  });

  renderAreas();
  renderImageList();
};

function renderAreas(){
  layer.innerHTML = '';
  if(currentImgIndex === -1) return;

  const rect = layer.getBoundingClientRect();

  images[currentImgIndex].areas.forEach((a, i) => {
    const div = document.createElement('div');
    div.className = 'area-box';
    div.style.left = (a.x * rect.width) + 'px';
    div.style.top  = (a.y * rect.height) + 'px';
    div.style.width  = (a.w * rect.width) + 'px';
    div.style.height = (a.h * rect.height) + 'px';
    div.innerText = i + 1;

    div.onclick = (e) => {
      e.stopPropagation();
      if(confirm(`åˆªé™¤å€åŸŸ ${i+1}?`)){
        images[currentImgIndex].areas.splice(i, 1);
        renderAreas();
        renderImageList();
      }
    };

    layer.appendChild(div);
  });
}

/* ================= å„²å­˜ï¼šè½‰æˆ LINE imagemap 1040 åŸºæº– ================= */
function buildImagemapMessages(){
  // LINE imagemap: baseSize width 1040, height 1040 * (åœ–ç‰‡é«˜åº¦/åœ–ç‰‡å¯¬åº¦)
  // æˆ‘å€‘æ²’æœ‰åŸå§‹å¯¬é«˜ï¼ˆå› ç‚ºç”¨ Imgur é€£çµï¼‰ï¼Œæ‰€ä»¥ç”¨ã€Œé è¦½åœ–è‡ªç„¶å°ºå¯¸ã€ä¾†å–æ¯”ä¾‹
  const preview = document.getElementById('previewImage');

  // è‹¥ç›®å‰æ²’é¸ä¸­ï¼Œä»å…è¨±å­˜æ•´æ‰¹ï¼šæ¯å¼µéƒ½è¦å…ˆè¼‰å…¥å– naturalWidth/Height å¤ªéº»ç…©
  // æ‰€ä»¥ï¼šå­˜æ™‚ä»¥ã€Œå›ºå®š 1040 x 1040ã€ä¹Ÿèƒ½ç”¨ï¼Œåªæ˜¯æ¯”ä¾‹å¯èƒ½å¤±çœŸã€‚
  // æœ€ç©©ï¼šæ¯å¼µéƒ½å…ˆç”¨ <img> å– naturalWidth/Height
  // é€™è£¡åšï¼šé€å¼µå‹•æ…‹å»ºç«‹ img å–å¾—å°ºå¯¸ï¼ˆåŒæ­¥ Promiseï¼‰
  return Promise.all(images.map(img => new Promise((resolve) => {
    const im = new Image();
    im.onload = () => {
      const baseW = 1040;
      const ratio = im.naturalHeight / im.naturalWidth;
      const baseH = Math.round(baseW * ratio);

      const actions = img.areas.map(a => ({
        type: a.type,
        text: a.type === 'message' ? a.text : undefined,
        linkUri: a.type === 'uri' ? a.text : undefined,
        area: {
          x: Math.round(a.x * baseW),
          y: Math.round(a.y * baseH),
          width: Math.round(a.w * baseW),
          height: Math.round(a.h * baseH)
        }
      }));

      resolve({
        type: "imagemap",
        baseUrl: img.url,
        altText: "é¸å–®",
        baseSize: { width: baseW, height: baseH },
        actions
      });
    };
    im.onerror = () => {
      // åœ–è¼‰ä¸é€²ä¾†å°±ç”¨ 1040x1040 ç•¶ fallback
      const baseW = 1040, baseH = 1040;
      const actions = img.areas.map(a => ({
        type: a.type,
        text: a.type === 'message' ? a.text : undefined,
        linkUri: a.type === 'uri' ? a.text : undefined,
        area: {
          x: Math.round(a.x * baseW),
          y: Math.round(a.y * baseH),
          width: Math.round(a.w * baseW),
          height: Math.round(a.h * baseH)
        }
      }));

      resolve({
        type: "imagemap",
        baseUrl: img.url,
        altText: "é¸å–®",
        baseSize: { width: baseW, height: baseH },
        actions
      });
    };
    im.src = img.url;
  })));
}

/* ================= Save / Load ================= */
async function saveSettings(){
  const raw = document.getElementById('workerUrl').value;
  const keyword = document.getElementById('triggerKeyword').value.trim();
  const url = normalizeWorkerUrl(raw);

  if(!url || !keyword) return alert('è³‡æ–™ä¸å…¨ï¼ˆWorkerUrl / é—œéµå­—ï¼‰');
  if(images.length === 0) return alert('è‡³å°‘æ–°å¢ä¸€å¼µåœ–ç‰‡');
  if(images.some(i => !i.url)) return alert('æœ‰åœ–ç‰‡å°šæœªä¸Šå‚³åˆ° Imgur');

  localStorage.setItem('line_worker_url', url);

  try{
    const messages = await buildImagemapMessages();

    await postJSON(url + '/save', {
      password:'1234',
      keyword,
      payload:{
        mode:'imagemap',
        messages
      }
    });

    alert('å„²å­˜æˆåŠŸï¼');
  }catch(e){
    alert('å„²å­˜å¤±æ•—ï¼š\n' + e.message);
  }
}

async function loadSettings(){
  const raw = document.getElementById('workerUrl').value;
  const keyword = document.getElementById('triggerKeyword').value.trim();
  const url = normalizeWorkerUrl(raw);

  if(!url || !keyword) return alert('è³‡æ–™ä¸å…¨ï¼ˆWorkerUrl / é—œéµå­—ï¼‰');
  localStorage.setItem('line_worker_url', url);

  try{
    const data = await postJSON(url + '/load', { password:'1234', keyword });
    const obj = (typeof data === 'string') ? JSON.parse(data) : data;

    if(!obj.messages || !Array.isArray(obj.messages)){
      return alert('è®€åˆ°è³‡æ–™ä½†æ ¼å¼ä¸å°ï¼ˆæ²’æœ‰ messagesï¼‰');
    }

    // æŠŠ LINE çš„åº§æ¨™ï¼ˆbaseSize pxï¼‰è½‰å›æ¯”ä¾‹ï¼ˆ0~1ï¼‰ï¼Œæ–¹ä¾¿ç•«é¢ç¸®æ”¾
    images = obj.messages.map(m => {
      const bw = m.baseSize?.width || 1040;
      const bh = m.baseSize?.height || 1040;
      return {
        url: m.baseUrl,
        areas: (m.actions || []).map(a => ({
          type: a.type,
          text: a.type === 'message' ? a.text : (a.linkUri || ''),
          x: (a.area.x || 0) / bw,
          y: (a.area.y || 0) / bh,
          w: (a.area.width || 0) / bw,
          h: (a.area.height || 0) / bh,
        }))
      };
    });

    renderImageList();
    selectImage(images.length ? 0 : -1);
    alert('è®€å–æˆåŠŸï¼');
  }catch(e){
    alert('è®€å–å¤±æ•—ï¼š\n' + e.message);
  }
}
</script>

</body>
</html>
