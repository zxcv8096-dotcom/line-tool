<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼•æµåœ–ç·¨è¼¯å™¨ (å£“ç¸®ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .area-box { position: absolute; border: 2px solid rgba(255, 0, 0, 0.8); background: rgba(255, 0, 0, 0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px black; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col text-slate-800">
    <div class="bg-white shadow p-4 z-10 flex justify-between items-center">
        <h1 class="font-bold text-xl text-blue-600 flex items-center gap-2">
            <a href="index.html" class="text-2xl hover:bg-slate-100 rounded px-1">ğŸ”™</a> å¼•æµåœ–ç·¨è¼¯å™¨
        </h1>
        <div class="flex gap-2">
            <input type="text" id="workerUrl" placeholder="Worker ç¶²å€..." class="border rounded px-2 text-sm w-48 bg-yellow-50">
            <input type="text" id="triggerKeyword" placeholder="è¨­å®šæœ¬åœ–é—œéµå­—" class="border rounded px-2 text-sm font-bold w-40 border-blue-500">
            <button onclick="loadSettings()" class="bg-gray-500 text-white px-3 rounded text-sm hover:bg-gray-600">è®€å–</button>
            <button onclick="saveSettings()" class="bg-green-600 text-white px-3 rounded text-sm hover:bg-green-700">å„²å­˜</button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden w-full">
        <div class="w-72 bg-white border-r overflow-y-auto p-4 flex flex-col gap-4">
            <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
                <strong>ğŸ’¡ ç©©å®šæ¨¡å¼ï¼š</strong><br>åœ–ç‰‡æœƒè‡ªå‹•å£“ç¸®è‡³é©åˆ LINE çš„å¤§å°ï¼Œç¢ºä¿ä¸Šå‚³æˆåŠŸã€‚
            </div>
            <h3 class="font-bold text-sm">åœ–ç‰‡æ¸…å–®</h3>
            <div id="imageList" class="space-y-4"></div>
            <button onclick="addImageBlock()" class="w-full py-2 border-2 border-dashed border-blue-300 text-blue-500 rounded hover:bg-blue-50">+ æ–°å¢åœ–ç‰‡</button>
        </div>

        <div class="flex-1 bg-slate-200 relative overflow-auto flex justify-center p-8">
            <div id="canvasContainer" class="bg-white shadow-lg relative hidden">
                <img id="previewImage" class="block pointer-events-none select-none" style="max-width: 600px;">
                <div id="drawLayer" class="absolute inset-0 cursor-crosshair"></div>
            </div>
            <div id="emptyState" class="text-slate-400 mt-20 flex flex-col items-center">
                <span class="text-4xl mb-2">ğŸ‘ˆ</span><span>è«‹å¾å·¦å´æ–°å¢åœ–ç‰‡</span>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" accept="image/*" class="hidden">

    <script>
        let images = []; let currentImgIndex = -1; let isDrawing = false, startX, startY;

        window.onload = function() {
            const savedUrl = localStorage.getItem('line_worker_url');
            if(savedUrl) document.getElementById('workerUrl').value = savedUrl;
        }

        function addImageBlock() { images.push({ url: '', areas: [], width: 0, height: 0 }); renderImageList(); selectImage(images.length - 1); }

        function renderImageList() {
            const list = document.getElementById('imageList'); list.innerHTML = '';
            images.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = `p-2 border rounded cursor-pointer ${idx === currentImgIndex ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`;
                div.innerHTML = `
                    <div class="flex justify-between mb-2"><span class="font-bold text-xs">åœ–ç‰‡ ${idx + 1}</span><button onclick="images.splice(${idx},1);renderImageList();selectImage(-1)" class="text-red-500 text-xs">âœ•</button></div>
                    ${img.url ? `<img src="${img.url}" class="w-full h-24 object-cover rounded mb-2 border">` : '<div class="w-full h-20 bg-gray-100 flex items-center justify-center text-xs text-gray-400">ç„¡åœ–ç‰‡</div>'}
                    <button onclick="triggerUpload(${idx}, this)" class="w-full bg-blue-500 text-white text-xs py-1 rounded hover:bg-blue-600">ä¸Šå‚³åœ–ç‰‡</button>
                    <div class="mt-1 text-[10px] text-gray-500 text-right">ç†±å€: ${img.areas.length}</div>
                `;
                div.onclick = (e) => { if(!e.target.tagName.match(/BUTTON|INPUT/)) selectImage(idx); };
                list.appendChild(div);
            });
        }

        function selectImage(idx) {
            currentImgIndex = idx;
            const canvas = document.getElementById('canvasContainer');
            const preview = document.getElementById('previewImage');
            if (idx === -1 || !images[idx]) { canvas.classList.add('hidden'); document.getElementById('emptyState').classList.remove('hidden'); return; }
            
            const imgData = images[idx];
            if (imgData.url) {
                preview.src = imgData.url;
                preview.onload = () => { imgData.width = preview.naturalWidth; imgData.height = preview.naturalHeight; canvas.classList.remove('hidden'); document.getElementById('emptyState').classList.add('hidden'); renderAreas(); };
            } else { canvas.classList.add('hidden'); document.getElementById('emptyState').classList.remove('hidden'); }
        }

        // â˜…â˜…â˜… æ ¸å¿ƒï¼šå£“ç¸®èˆ‡ä¸Šå‚³ â˜…â˜…â˜…
        function triggerUpload(idx, btn) {
            const url = document.getElementById('workerUrl').value;
            if (!url) return alert('è«‹å…ˆè¼¸å…¥ Worker ç¶²å€');

            document.getElementById('fileInput').onchange = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                const oldText = btn.innerText; btn.innerText = "â³ å£“ç¸®ä¸Šå‚³ä¸­...";

                try {
                    // 1. å‰ç«¯å£“ç¸® (Canvas Resize)
                    const compressedBase64 = await compressImage(file);
                    
                    // 2. ä¸Šå‚³ Base64 å­—ç¬¦ä¸²
                    const res = await fetch(url + '/upload', {
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ password: '1234', image: compressedBase64 }) 
                    });

                    if (res.ok) {
                        const json = await res.json();
                        images[idx].url = json.url;
                        renderImageList(); selectImage(idx);
                    } else { alert('ä¸Šå‚³å¤±æ•—: ' + await res.text()); }
                } catch(e) { 
                    console.error(e);
                    alert('ç™¼ç”ŸéŒ¯èª¤: ' + e.message); 
                }
                btn.innerText = oldText;
            };
            document.getElementById('fileInput').click();
        }

        // åœ–ç‰‡å£“ç¸®å‡½å¼
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // LINE Imagemap æ¨™æº–å¯¬åº¦ 1040
                        const MAX_WIDTH = 1040;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è½‰æˆ JPEG, å“è³ª 0.8
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // ç•«æ¡†èˆ‡å…¶ä»–é‚è¼¯ç¶­æŒä¸è®Š
        const layer = document.getElementById('drawLayer');
        layer.onmousedown = (e) => {
            if (currentImgIndex === -1) return; isDrawing = true;
            const rect = layer.getBoundingClientRect(); const scale = images[currentImgIndex].width / rect.width;
            startX = (e.clientX - rect.left) * scale; startY = (e.clientY - rect.top) * scale;
        };
        layer.onmouseup = (e) => {
            if (!isDrawing) return; isDrawing = false;
            const rect = layer.getBoundingClientRect(); const scale = images[currentImgIndex].width / rect.width;
            const endX = (e.clientX - rect.left) * scale; const endY = (e.clientY - rect.top) * scale;
            const w = Math.abs(endX - startX); const h = Math.abs(endY - startY);
            if (w > 20 && h > 20) {
                const type = prompt("é»æ“Šå¾Œå‹•ä½œ? (text=ç™¼æ–‡å­—, link=é–‹ç¶²é )", "text");
                if(!type) return;
                const content = prompt("å…§å®¹? (ä¾‹å¦‚: 'ç”¢å“ä»‹ç´¹' æˆ– 'https://...')");
                if (content) {
                    images[currentImgIndex].areas.push({ x: Math.min(startX, endX), y: Math.min(startY, endY), width: w, height: h, type: type === 'link' ? 'uri' : 'message', text: content });
                    renderAreas(); renderImageList();
                }
            }
        };

        function renderAreas() {
            layer.innerHTML = '';
            if (currentImgIndex === -1) return;
            const imgData = images[currentImgIndex];
            const rect = document.getElementById('previewImage').getBoundingClientRect();
            const scale = rect.width / imgData.width;
            imgData.areas.forEach((area, i) => {
                const div = document.createElement('div'); div.className = 'area-box';
                div.style.left = (area.x * scale) + 'px'; div.style.top = (area.y * scale) + 'px';
                div.style.width = (area.width * scale) + 'px'; div.style.height = (area.height * scale) + 'px';
                div.innerText = i + 1;
                div.onclick = (e) => { e.stopPropagation(); if(confirm(`åˆªé™¤å€åŸŸ ${i+1}?`)) { imgData.areas.splice(i, 1); renderAreas(); renderImageList(); } };
                layer.appendChild(div);
            });
        }

        async function saveSettings() {
            const keyword = document.getElementById('triggerKeyword').value;
            const url = document.getElementById('workerUrl').value;
            if(!keyword || !url) return alert('è³‡æ–™ä¸å…¨');
            
            const messages = images.map(img => ({
                type: "imagemap", baseUrl: img.url, altText: "é¸å–®",
                baseSize: { width: 1040, height: img.height * (1040/img.width) },
                actions: img.areas.map(a => ({
                    type: a.type, text: a.text || a.linkUri, linkUri: a.type === 'uri' ? a.text : undefined,
                    area: { x: a.x * (1040/img.width), y: a.y * (1040/img.width), width: a.width * (1040/img.width), height: a.height * (1040/img.width) }
                }))
            }));
            try {
                const res = await fetch(url + '/save', { method: 'POST', body: JSON.stringify({ password: '1234', keyword, payload: { mode: 'imagemap', messages } }) });
                if(res.ok) alert('å„²å­˜æˆåŠŸï¼'); else alert('å¤±æ•—');
            } catch(e) { alert('é€£ç·šå¤±æ•—'); }
        }

        async function loadSettings() {
            const keyword = document.getElementById('triggerKeyword').value;
            const url = document.getElementById('workerUrl').value;
            try {
                const res = await fetch(url + '/load', { method: 'POST', body: JSON.stringify({ password: '1234', keyword }) });
                if(res.ok) {
                    const data = await res.json();
                    if(data.messages) {
                        images = data.messages.map(m => ({
                            url: m.baseUrl,
                            areas: m.actions.map(a => ({ type: a.type, text: a.text || a.linkUri, x: a.area.x, y: a.area.y, width: a.area.width, height: a.area.height })),
                            width: 1040, height: m.baseSize.height 
                        }));
                    }
                    renderImageList(); selectImage(0); alert('è®€å–æˆåŠŸ');
                } else alert('ç„¡è³‡æ–™');
            } catch(e) { alert('éŒ¯èª¤'); }
        }
    </script>
</body>
</html>
