<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼•æµåœ–ç·¨è¼¯å™¨ (Imagemap)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .area-box { position: absolute; border: 2px solid rgba(255, 0, 0, 0.7); background: rgba(255, 0, 0, 0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
        .area-box.selected { border-color: #fbbf24; background: rgba(251, 191, 36, 0.3); }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col text-slate-800">
    <div class="bg-white shadow p-4 z-10">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 class="font-bold text-xl text-blue-600 flex items-center gap-2">
                <a href="index.html" class="text-2xl hover:bg-slate-100 rounded px-1">ğŸ”™</a> 
                å¼•æµåœ–ç·¨è¼¯å™¨
            </h1>
            <div class="flex gap-2">
                <input type="text" id="workerUrl" placeholder="Worker ç¶²å€..." class="border rounded px-2 text-sm w-48 bg-yellow-50">
                <input type="password" id="workerPwd" value="1234" class="hidden"> <input type="text" id="triggerKeyword" placeholder="è§¸ç™¼é—œéµå­—" class="border rounded px-2 text-sm font-bold w-32 border-blue-500">
                <button onclick="loadSettings()" class="bg-gray-500 text-white px-3 rounded text-sm hover:bg-gray-600">è®€å–</button>
                <button onclick="saveSettings()" class="bg-green-600 text-white px-3 rounded text-sm hover:bg-green-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        <div class="w-1/4 bg-white border-r overflow-y-auto p-4 flex flex-col gap-4">
            <h3 class="font-bold text-sm">1. åœ–ç‰‡æ¸…å–® (å¯å¤šå¼µ)</h3>
            <div id="imageList" class="space-y-4"></div>
            <button onclick="addImageBlock()" class="w-full py-2 border-2 border-dashed border-blue-300 text-blue-500 rounded hover:bg-blue-50">+ æ–°å¢ä¸€å¼µåœ–</button>
            
            <hr class="my-4">
            <h3 class="font-bold text-sm text-red-600">ğŸ”´ ç´…è‰²æ¡†æ¡†æŒ‰éˆ• (Quick Reply)</h3>
            <div id="qrList" class="space-y-2"></div>
            <button onclick="addQR()" class="w-full py-1 bg-red-50 text-red-500 text-xs rounded border border-red-200 hover:bg-red-100">+ æ–°å¢æŒ‰éˆ•</button>
        </div>

        <div class="flex-1 bg-slate-200 relative overflow-auto flex justify-center p-8">
            <div id="canvasContainer" class="bg-white shadow-lg relative hidden">
                <img id="previewImage" class="block pointer-events-none select-none" style="max-width: 600px;">
                <div id="drawLayer" class="absolute inset-0 cursor-crosshair"></div>
            </div>
            <div id="emptyState" class="text-slate-400 mt-20 flex flex-col items-center">
                <span class="text-4xl mb-2">ğŸ‘ˆ</span>
                <span>è«‹å¾å·¦å´é¸æ“‡æˆ–æ–°å¢åœ–ç‰‡</span>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" class="hidden">

    <script>
        let images = []; 
        let quickReplies = [];
        let currentImgIndex = -1;
        let isDrawing = false, startX, startY;

        // â˜…â˜…â˜… è‡ªå‹•è®€å–ç¶²å€ â˜…â˜…â˜…
        window.onload = function() {
            const savedUrl = localStorage.getItem('line_worker_url');
            if(savedUrl) document.getElementById('workerUrl').value = savedUrl;
        }

        function addImageBlock() {
            images.push({ url: '', areas: [], width: 0, height: 0 });
            renderImageList();
            selectImage(images.length - 1);
        }

        function renderImageList() {
            const list = document.getElementById('imageList');
            list.innerHTML = '';
            images.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = `p-2 border rounded cursor-pointer transition ${idx === currentImgIndex ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:bg-gray-50'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-xs">åœ–ç‰‡ ${idx + 1}</span>
                        <button onclick="removeImage(${idx})" class="text-red-500 text-xs hover:bg-red-100 rounded px-1">âœ•</button>
                    </div>
                    ${img.url ? `<img src="${img.url}" class="w-full h-24 object-cover rounded mb-2 border">` : '<div class="w-full h-20 bg-gray-100 flex items-center justify-center text-xs text-gray-400 rounded">ç„¡åœ–ç‰‡</div>'}
                    <button onclick="triggerUpload(${idx})" class="w-full bg-blue-500 text-white text-xs py-1 rounded hover:bg-blue-600">ä¸Šå‚³åœ–ç‰‡</button>
                    <div class="mt-2 text-[10px] text-gray-500 text-right">é»æ“Šå€åŸŸ: ${img.areas.length} å€‹</div>
                `;
                div.onclick = (e) => { if(!e.target.tagName.match(/BUTTON|INPUT/)) selectImage(idx); };
                list.appendChild(div);
            });
        }

        function removeImage(idx) {
            if(!confirm('ç¢ºå®šåˆªé™¤é€™å¼µåœ–å—ï¼Ÿ')) return;
            images.splice(idx, 1);
            if(images.length === 0) { currentImgIndex = -1; }
            else if(idx <= currentImgIndex) { currentImgIndex = Math.max(0, currentImgIndex - 1); }
            renderImageList();
            selectImage(currentImgIndex);
        }

        function selectImage(idx) {
            currentImgIndex = idx;
            renderImageList();
            const canvas = document.getElementById('canvasContainer');
            const preview = document.getElementById('previewImage');
            const empty = document.getElementById('emptyState');

            if (idx === -1 || !images[idx]) {
                canvas.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            const imgData = images[idx];
            if (imgData.url) {
                preview.src = imgData.url;
                preview.onload = () => {
                    imgData.width = preview.naturalWidth;
                    imgData.height = preview.naturalHeight;
                    canvas.classList.remove('hidden');
                    empty.classList.add('hidden');
                    renderAreas();
                };
            } else {
                canvas.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        // ä¸Šå‚³é‚è¼¯
        function triggerUpload(idx) {
            const url = document.getElementById('workerUrl').value;
            if (!url) return alert('è«‹å…ˆè¼¸å…¥ Worker ç¶²å€');

            document.getElementById('fileInput').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // è½‰ Base64
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    try {
                        const res = await fetch(url + '/upload', {
                            method: 'POST', body: JSON.stringify({ password: '1234', image: reader.result })
                        });
                        if (res.ok) {
                            const json = await res.json();
                            images[idx].url = json.url;
                            selectImage(idx);
                        } else alert('ä¸Šå‚³å¤±æ•—');
                    } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
                };
            };
            document.getElementById('fileInput').click();
        }

        // ç•«å¸ƒé‚è¼¯
        const layer = document.getElementById('drawLayer');
        layer.onmousedown = (e) => {
            if (currentImgIndex === -1) return;
            isDrawing = true;
            const rect = layer.getBoundingClientRect();
            const scale = images[currentImgIndex].width / rect.width;
            startX = (e.clientX - rect.left) * scale;
            startY = (e.clientY - rect.top) * scale;
        };
        layer.onmouseup = (e) => {
            if (!isDrawing) return;
            isDrawing = false;
            const rect = layer.getBoundingClientRect();
            const scale = images[currentImgIndex].width / rect.width;
            const endX = (e.clientX - rect.left) * scale;
            const endY = (e.clientY - rect.top) * scale;
            
            const w = Math.abs(endX - startX);
            const h = Math.abs(endY - startY);
            if (w > 20 && h > 20) {
                const type = prompt("é¡å‹? (è¼¸å…¥ 'text' å›è¦†æ–‡å­—, 'link' é–‹ç¶²é )", "text");
                if(!type) return;
                const content = prompt("å…§å®¹? (é—œéµå­— æˆ– ç¶²å€)", type==='link' ? 'https://' : '');
                if (content) {
                    images[currentImgIndex].areas.push({
                        x: Math.min(startX, endX), y: Math.min(startY, endY), width: w, height: h,
                        type: type === 'link' ? 'uri' : 'message', text: content
                    });
                    renderAreas();
                    renderImageList();
                }
            }
        };

        function renderAreas() {
            layer.innerHTML = '';
            if (currentImgIndex === -1) return;
            const imgData = images[currentImgIndex];
            const rect = document.getElementById('previewImage').getBoundingClientRect();
            const scale = rect.width / imgData.width;

            imgData.areas.forEach((area, i) => {
                const div = document.createElement('div');
                div.className = 'area-box';
                div.style.left = (area.x * scale) + 'px';
                div.style.top = (area.y * scale) + 'px';
                div.style.width = (area.width * scale) + 'px';
                div.style.height = (area.height * scale) + 'px';
                div.innerText = i + 1;
                div.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm('åˆªé™¤å€åŸŸ ' + (i+1) + '?')) {
                        imgData.areas.splice(i, 1);
                        renderAreas();
                        renderImageList();
                    }
                };
                layer.appendChild(div);
            });
        }

        // Quick Reply é‚è¼¯
        function addQR() { quickReplies.push({ label: 'æŒ‰éˆ•', text: 'å›è¦†' }); renderQR(); }
        function renderQR() {
            const list = document.getElementById('qrList');
            list.innerHTML = '';
            quickReplies.forEach((qr, i) => {
                list.innerHTML += `<div class="flex gap-1 mb-1 items-center bg-white p-1 rounded border"><input value="${qr.label}" onchange="quickReplies[${i}].label=this.value" class="w-1/3 border px-1 text-xs py-1 rounded" placeholder="é¡¯ç¤º"><input value="${qr.text}" onchange="quickReplies[${i}].text=this.value" class="w-1/2 border px-1 text-xs py-1 rounded" placeholder="ç™¼é€"><button onclick="quickReplies.splice(${i},1);renderQR()" class="text-red-500 px-1 font-bold">âœ•</button></div>`;
            });
        }

        // å­˜æª”èˆ‡è®€å–
        async function saveSettings() {
            const keyword = document.getElementById('triggerKeyword').value;
            const url = document.getElementById('workerUrl').value;
            if(!keyword || !url) return alert('è³‡æ–™ä¸å…¨');
            
            // è½‰æ›ç‚º LINE Message æ ¼å¼
            const messages = images.map(img => ({
                type: "imagemap",
                baseUrl: img.url,
                altText: "åœ–ç‰‡è¨Šæ¯",
                baseSize: { width: 1040, height: img.height * (1040/img.width) },
                actions: img.areas.map(a => ({
                    type: a.type,
                    text: a.type === 'message' ? a.text : undefined,
                    linkUri: a.type === 'uri' ? a.text : undefined,
                    area: { x: a.x * (1040/img.width), y: a.y * (1040/img.width), width: a.width * (1040/img.width), height: a.height * (1040/img.width) }
                }))
            }));

            const payload = { mode: 'imagemap', messages, quickReplies };
            
            try {
                const res = await fetch(url + '/save', {
                    method: 'POST', body: JSON.stringify({ password: '1234', keyword, payload })
                });
                if(res.ok) alert('å„²å­˜æˆåŠŸ'); else alert('å„²å­˜å¤±æ•—');
            } catch(e) { alert('å¤±æ•—'); }
        }

        async function loadSettings() {
            const keyword = document.getElementById('triggerKeyword').value;
            const url = document.getElementById('workerUrl').value;
            try {
                const res = await fetch(url + '/load', { method: 'POST', body: JSON.stringify({ password: '1234', keyword }) });
                if(res.ok) {
                    const data = await res.json();
                    quickReplies = data.quickReplies || [];
                    // åå‘è§£æ Imagemap
                    if(data.messages) {
                        images = data.messages.map(m => ({
                            url: m.baseUrl,
                            areas: m.actions.map(a => ({
                                type: a.type, text: a.text || a.linkUri, 
                                x: a.area.x, y: a.area.y, width: a.area.width, height: a.area.height
                            })),
                            width: 1040, height: m.baseSize.height 
                        }));
                    }
                    renderImageList(); renderQR(); selectImage(0);
                    alert('è®€å–æˆåŠŸ');
                } else alert('ç„¡è³‡æ–™');
            } catch(e) { alert('éŒ¯èª¤'); }
        }
    </script>
</body>
</html>
