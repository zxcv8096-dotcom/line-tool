<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI 問卷後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --card: rgba(255,255,255,.9); }
    body { background: linear-gradient(135deg, #eef2ff, #fdf2f8, #ecfeff); }
    .glass { background: var(--card); backdrop-filter: blur(10px); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .toast { animation: pop .18s ease-out; }
    @keyframes pop { from { transform: scale(.98); opacity: .6; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">AI 問卷後台</h1>
        <p class="text-slate-600 mt-1">無密碼版（沿用你原本 Worker 的 /save /load /loadAny /listAll）</p>
      </div>
      <div class="flex gap-2">
        <a id="btnOpenPublic" target="_blank" class="hidden px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500">開啟前台（問答）</a>
      </div>
    </header>

    <!-- BOOT / WORKER URL -->
    <section class="glass rounded-2xl shadow p-5 mb-4">
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="text-sm font-semibold text-slate-700">Worker 網址（會自動抓首頁儲存的 line_worker_url）</label>
          <input id="inApiBase" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                 placeholder="https://api.xxx.workers.dev" />
          <div class="text-xs text-slate-500 mt-2">
            目前 key：<span class="mono font-semibold">AI_SURVEY:CONFIG</span>（設定）、
            <span class="mono font-semibold">AI_SURVEY:LEAD:</span>（名單前綴）
          </div>
        </div>
        <div class="flex gap-2">
          <button id="btnConnect" class="w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">載入</button>
          <button id="btnSave" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 font-semibold">儲存</button>
        </div>
      </div>
      <div class="mt-3 text-xs text-slate-500">
        最後同步：<span id="txtLastSync" class="mono">-</span>
      </div>
    </section>

    <div class="grid lg:grid-cols-3 gap-4">
      <!-- LEFT: NAV -->
      <aside class="glass rounded-2xl shadow p-4 lg:sticky lg:top-4 h-fit">
        <div class="text-xs text-slate-500">API Base</div>
        <div id="txtApiBase" class="mono text-sm text-slate-900 break-all">-</div>

        <div class="mt-4 space-y-2">
          <button data-tab="survey" class="tabbtn w-full text-left px-4 py-3 rounded-xl bg-slate-900 text-white">AI 問答設定</button>
          <button data-tab="products" class="tabbtn w-full text-left px-4 py-3 rounded-xl bg-white/70 hover:bg-white border border-slate-200 text-slate-900">產品清單</button>
          <button data-tab="rules" class="tabbtn w-full text-left px-4 py-3 rounded-xl bg-white/70 hover:bg-white border border-slate-200 text-slate-900">推薦規則</button>
          <button data-tab="leads" class="tabbtn w-full text-left px-4 py-3 rounded-xl bg-white/70 hover:bg-white border border-slate-200 text-slate-900">名單 Leads</button>
          <button data-tab="settings" class="tabbtn w-full text-left px-4 py-3 rounded-xl bg-white/70 hover:bg-white border border-slate-200 text-slate-900">系統設定</button>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <button id="btnReload" class="px-4 py-2 rounded-xl bg-white/70 hover:bg-white border border-slate-200">重新載入</button>
          <button id="btnLeadsReload" class="px-4 py-2 rounded-xl bg-white/70 hover:bg-white border border-slate-200">刷新名單</button>
        </div>

        <div class="mt-3 text-xs text-slate-500">
          Leads：<span id="txtLeadCount" class="mono">0</span> 筆（只抓 <span class="mono">AI_SURVEY:LEAD:</span>）
        </div>
      </aside>

      <!-- RIGHT: CONTENT -->
      <main class="lg:col-span-2 space-y-4">
        <!-- TAB: SURVEY -->
        <section id="tab-survey" class="glass rounded-2xl shadow p-5">
          <h2 class="text-lg font-extrabold text-slate-900">AI 問答設定</h2>
          <p class="text-sm text-slate-600 mt-1">控制 AI 怎麼問、問幾題、最後怎麼總結。</p>

          <div class="mt-5 grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-slate-700">問答主題</label>
              <input id="surveyTitle" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
                placeholder="例如：三分鐘找出你為什麼一直累" />
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-700">建議題數</label>
              <input id="surveyTurns" type="number" min="3" max="12"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200" />
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold text-slate-700">AI 角色/風格（System Prompt）</label>
              <textarea id="surveyPrompt" rows="10" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
placeholder="你是『健康狀態引導顧問』，用繁中，語氣接地氣但專業，不做醫療診斷，不誇大療效。
每次只問一題。每題都提供 3~5 個可點選選項（短句），也允許使用者自行補充。
最後輸出：狀態分類、原因推測、建議方向、推薦產品（依規則）、下一步 CTA。"></textarea>
              <p class="text-xs text-slate-500 mt-2">建議避免「診斷/治療/保證效果」類字眼。</p>
            </div>
          </div>
        </section>

        <!-- TAB: PRODUCTS -->
        <section id="tab-products" class="hidden glass rounded-2xl shadow p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">產品清單</h2>
              <p class="text-sm text-slate-600 mt-1">AI 最後會從這裡挑產品推薦。</p>
            </div>
            <button id="btnAddProduct" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">新增產品</button>
          </div>

          <div id="productList" class="mt-4 space-y-3"></div>

          <template id="tplProduct">
            <div class="rounded-2xl border border-slate-200 bg-white/60 p-4">
              <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
                <div class="flex-1">
                  <div class="flex gap-2 items-center">
                    <input data-k="name" class="w-full px-3 py-2 rounded-xl border border-slate-200 font-semibold"
                      placeholder="產品名稱" />
                    <input data-k="sku" class="w-40 px-3 py-2 rounded-xl border border-slate-200 mono"
                      placeholder="SKU/代碼" />
                  </div>
                  <div class="mt-2 grid md:grid-cols-2 gap-2">
                    <input data-k="tags" class="px-3 py-2 rounded-xl border border-slate-200"
                      placeholder="標籤（逗號）例如：疲勞,精神,代謝" />
                    <input data-k="link" class="px-3 py-2 rounded-xl border border-slate-200 mono"
                      placeholder="產品連結（你的 landing page）" />
                  </div>
                  <textarea data-k="desc" rows="3" class="mt-2 w-full px-3 py-2 rounded-xl border border-slate-200"
                    placeholder="一句話賣點（避免療效誇大，用『幫助/支持/維持』）"></textarea>
                </div>
                <div class="flex gap-2">
                  <button data-act="up" class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">上移</button>
                  <button data-act="down" class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">下移</button>
                  <button data-act="del" class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-500">刪除</button>
                </div>
              </div>
            </div>
          </template>
        </section>

        <!-- TAB: RULES -->
        <section id="tab-rules" class="hidden glass rounded-2xl shadow p-5">
          <h2 class="text-lg font-extrabold text-slate-900">推薦規則</h2>
          <p class="text-sm text-slate-600 mt-1">用「關鍵詞/類型 → 推薦哪些產品」來鎖 AI，不要亂推。</p>

          <div class="mt-4">
            <label class="text-sm font-semibold text-slate-700">規則 JSON</label>
            <textarea id="rulesJson" rows="14" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
placeholder='[
  {
    "if_any_keywords": ["疲勞", "下午累", "精神差", "提不起勁"],
    "recommend_skus": ["P001","P002"],
    "summary_title": "能量下滑型",
    "summary_hint": "偏向作息/壓力/能量利用不足的組合，建議先從支持能量代謝與日常節奏開始。"
  }
]'></textarea>
            <p class="text-xs text-slate-500 mt-2">儲存前會檢查 JSON 格式。</p>
          </div>
        </section>

        <!-- TAB: LEADS -->
        <section id="tab-leads" class="hidden glass rounded-2xl shadow p-5">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">名單 Leads</h2>
              <p class="text-sm text-slate-600 mt-1">從 DB 裡抓所有 key 前綴為 <span class="mono">AI_SURVEY:LEAD:</span> 的資料。</p>
            </div>
            <div class="flex gap-2">
              <input id="leadsQ" class="px-4 py-2 rounded-xl border border-slate-200" placeholder="搜尋（姓名/標籤/關鍵字）" />
            </div>
          </div>

          <div class="mt-4 overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600">
                <tr>
                  <th class="text-left py-2 pr-4">時間</th>
                  <th class="text-left py-2 pr-4">User</th>
                  <th class="text-left py-2 pr-4">狀態/標題</th>
                  <th class="text-left py-2 pr-4">推薦</th>
                  <th class="text-left py-2 pr-4">關鍵字</th>
                </tr>
              </thead>
              <tbody id="leadsTbody" class="text-slate-900"></tbody>
            </table>
          </div>

          <div class="mt-4 flex items-center justify-between">
            <button id="btnPrev" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">上一頁</button>
            <div class="text-xs text-slate-500">page: <span id="txtPage" class="mono">1</span></div>
            <button id="btnNext" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">下一頁</button>
          </div>

          <div class="mt-2 text-xs text-slate-500">
            每頁載入 <span class="mono">20</span> 筆（用 /loadAny 分批抓，速度取決於你名單數）
          </div>
        </section>

        <!-- TAB: SETTINGS -->
        <section id="tab-settings" class="hidden glass rounded-2xl shadow p-5">
          <h2 class="text-lg font-extrabold text-slate-900">系統設定</h2>
          <p class="text-sm text-slate-600 mt-1">前台（問答頁）會用到的連結/參數。</p>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-slate-700">前台網址（問答頁 URL）</label>
              <input id="publicUrl" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                placeholder="https://你的網域/survey" />
              <p class="text-xs text-slate-500 mt-2">右上角「開啟前台」會用這個。</p>
            </div>

            <div>
              <label class="text-sm font-semibold text-slate-700">LINE 加好友連結（可選）</label>
              <input id="addFriendUrl" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                placeholder="https://lin.ee/xxxxxxx" />
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold text-slate-700">AI 結尾 CTA 模板</label>
              <textarea id="ctaTemplate" rows="6" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
placeholder="範例：
如果你願意，我可以把你的狀況整理成「1 份簡單方案」給你（不推銷，先讓你看方向）。
你可以：
1) 點這裡看方案：{{public_url}}
2) 或直接加我 LINE：{{add_friend_url}}
回我『方案』我就幫你做。"></textarea>
            </div>
          </div>
        </section>

        <!-- RAW JSON -->
        <section class="glass rounded-2xl shadow p-5">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-slate-900">目前設定（JSON）</h3>
            <button id="btnCopyJson" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">複製 JSON</button>
          </div>
          <pre id="jsonPreview" class="mt-3 p-4 rounded-2xl bg-slate-900 text-slate-50 text-xs overflow-auto mono"></pre>
        </section>
      </main>
    </div>
  </div>

  <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(92vw,520px)] space-y-2 z-50"></div>

<script>
  const CONFIG_KEY = "AI_SURVEY:CONFIG";
  const LEAD_PREFIX = "AI_SURVEY:LEAD:";
  const LEADS_PAGE_SIZE = 20;

  let API_BASE = "";
  let ALL_LEAD_KEYS = [];
  let LEADS_CACHE = [];
  let PAGE = 1;

  const model = {
    survey: { title: "三分鐘找出你為什麼一直累", turns: 6, prompt: "" },
    products: [],
    rules: [],
    settings: { public_url: "", add_friend_url: "", cta_template: "" }
  };

  const els = (id) => document.getElementById(id);
  const toastWrap = els("toastWrap");

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toast(msg, type="ok") {
    const div = document.createElement("div");
    div.className = `toast glass rounded-2xl shadow px-4 py-3 border ${
      type==="ok" ? "border-emerald-200" : type==="warn" ? "border-amber-200" : "border-rose-200"
    }`;
    div.innerHTML = `<div class="text-sm text-slate-900 font-semibold">${escapeHtml(msg)}</div>`;
    toastWrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }

  async function api(path, bodyObj) {
    if (!API_BASE) throw new Error("Worker 網址未設定");
    const res = await fetch(API_BASE.replace(/\/$/,"") + path, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok || data?.ok === false) throw new Error(data?.error || data?.detail || res.statusText);
    return data;
  }

  function setTab(tab) {
    document.querySelectorAll(".tabbtn").forEach(b=>{
      const active = b.dataset.tab === tab;
      b.classList.toggle("bg-slate-900", active);
      b.classList.toggle("text-white", active);
      b.classList.toggle("bg-white/70", !active);
      b.classList.toggle("border", !active);
      b.classList.toggle("border-slate-200", !active);
    });

    ["survey","products","rules","leads","settings"].forEach(t=>{
      els("tab-"+t).classList.toggle("hidden", t !== tab);
    });
  }

  function updatePreview() {
    els("jsonPreview").textContent = JSON.stringify(model, null, 2);

    const u = (model.settings.public_url || "").trim();
    const a = els("btnOpenPublic");
    if (u) { a.href = u; a.classList.remove("hidden"); } else { a.classList.add("hidden"); }
  }

  function bindSurvey() {
    els("surveyTitle").value = model.survey.title || "";
    els("surveyTurns").value = model.survey.turns || 6;
    els("surveyPrompt").value = model.survey.prompt || "";

    els("surveyTitle").oninput = (e)=>{ model.survey.title = e.target.value; updatePreview(); };
    els("surveyTurns").oninput = (e)=>{ model.survey.turns = Number(e.target.value||6); updatePreview(); };
    els("surveyPrompt").oninput = (e)=>{ model.survey.prompt = e.target.value; updatePreview(); };
  }

  function renderProducts() {
    const wrap = els("productList");
    wrap.innerHTML = "";
    const tpl = els("tplProduct");

    model.products.forEach((p, idx) => {
      const node = tpl.content.cloneNode(true);
      const root = node.querySelector("div");

      root.querySelectorAll("[data-k]").forEach(input => {
        const k = input.getAttribute("data-k");
        input.value = (p[k] ?? "");
        input.addEventListener("input", (e)=>{
          p[k] = e.target.value;
          updatePreview();
        });
      });

      root.querySelectorAll("[data-act]").forEach(btn => {
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if (act === "del") {
            model.products.splice(idx, 1);
          } else if (act === "up" && idx > 0) {
            const tmp = model.products[idx-1]; model.products[idx-1] = model.products[idx]; model.products[idx] = tmp;
          } else if (act === "down" && idx < model.products.length-1) {
            const tmp = model.products[idx+1]; model.products[idx+1] = model.products[idx]; model.products[idx] = tmp;
          }
          renderProducts();
          updatePreview();
        });
      });

      wrap.appendChild(node);
    });

    if (model.products.length === 0) {
      const empty = document.createElement("div");
      empty.className = "rounded-2xl border border-dashed border-slate-300 bg-white/50 p-6 text-slate-600";
      empty.innerHTML = "目前沒有產品。按右上角「新增產品」。";
      wrap.appendChild(empty);
    }
  }

  function bindRules() {
    els("rulesJson").value = JSON.stringify(model.rules || [], null, 2);
    els("rulesJson").addEventListener("input", (e)=>{
      try {
        const v = JSON.parse(e.target.value || "[]");
        model.rules = Array.isArray(v) ? v : [];
        updatePreview();
      } catch {}
    });
  }

  function bindSettings() {
    els("publicUrl").value = model.settings.public_url || "";
    els("addFriendUrl").value = model.settings.add_friend_url || "";
    els("ctaTemplate").value = model.settings.cta_template || "";

    els("publicUrl").oninput = (e)=>{ model.settings.public_url = e.target.value; updatePreview(); };
    els("addFriendUrl").oninput = (e)=>{ model.settings.add_friend_url = e.target.value; updatePreview(); };
    els("ctaTemplate").oninput = (e)=>{ model.settings.cta_template = e.target.value; updatePreview(); };
  }

  async function loadConfig() {
    const data = await api("/load", { keyword: CONFIG_KEY });
    // 你 /load 會直接回 payload 本體，不一定包 ok
    // 所以做兩種相容：
    const cfg = (data?.payload && typeof data.payload === "object") ? data.payload : data;
    if (cfg?.survey) model.survey = cfg.survey;
    if (Array.isArray(cfg?.products)) model.products = cfg.products;
    if (Array.isArray(cfg?.rules)) model.rules = cfg.rules;
    if (cfg?.settings) model.settings = cfg.settings;

    bindSurvey();
    renderProducts();
    bindRules();
    bindSettings();
    updatePreview();

    els("txtLastSync").textContent = new Date().toLocaleString();
    toast("已載入設定");
  }

  async function saveConfig() {
    try { JSON.parse(els("rulesJson").value || "[]"); }
    catch { toast("規則 JSON 格式錯誤，請先修正", "warn"); setTab("rules"); return; }

    await api("/save", { keyword: CONFIG_KEY, payload: model });
    els("txtLastSync").textContent = new Date().toLocaleString();
    toast("已儲存設定");
  }

  function renderLeadsTable(items) {
    const tb = els("leadsTbody");
    tb.innerHTML = "";

    const q = (els("leadsQ").value || "").trim().toLowerCase();
    const filtered = (items || []).filter(x => !q || JSON.stringify(x).toLowerCase().includes(q));

    filtered.forEach(x=>{
      const tr = document.createElement("tr");
      tr.className = "border-t border-slate-200";

      const dt = x.created_at ? new Date(x.created_at).toLocaleString() : (x.createdAt ? new Date(x.createdAt).toLocaleString() : "-");
      const user = x.display_name || x.displayName || x.user_id || x.userId || "-";
      const title = x.summary_title || x.summaryTitle || x.type || "-";
      const rec = (x.recommend_skus || x.recommendSkus || x.recommendations || []).join?.(", ") || "-";
      const kw = (x.keywords || x.keyword || []).join?.(", ") || (typeof x.keyword === "string" ? x.keyword : "-");

      tr.innerHTML = `
        <td class="py-2 pr-4 text-slate-700">${escapeHtml(dt)}</td>
        <td class="py-2 pr-4 font-semibold">${escapeHtml(user)}</td>
        <td class="py-2 pr-4">${escapeHtml(title)}</td>
        <td class="py-2 pr-4 mono text-xs">${escapeHtml(rec)}</td>
        <td class="py-2 pr-4 text-slate-700">${escapeHtml(kw)}</td>
      `;
      tb.appendChild(tr);
    });

    if (filtered.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="py-6 text-center text-slate-500">沒有資料</td>`;
      tb.appendChild(tr);
    }
  }

  async function loadLeadKeys() {
    // 你的 worker 目前沒有 prefix list API，所以用 /listAll 拿全 keys，再自己 filter
    const data = await api("/listAll", {});
    const db = data?.db || [];
    ALL_LEAD_KEYS = db.filter(k => k.startsWith(LEAD_PREFIX))
                      .sort((a,b)=> b.localeCompare(a)); // 新的在前
    els("txtLeadCount").textContent = String(ALL_LEAD_KEYS.length);
  }

  async function loadLeadsPage(page) {
    PAGE = Math.max(1, page);
    els("txtPage").textContent = String(PAGE);

    const start = (PAGE - 1) * LEADS_PAGE_SIZE;
    const keys = ALL_LEAD_KEYS.slice(start, start + LEADS_PAGE_SIZE);

    if (keys.length === 0) {
      LEADS_CACHE = [];
      renderLeadsTable([]);
      return;
    }

    // 分批抓（避免一次太多）
    const promises = keys.map(k => api("/loadAny", { namespace: "DB", keyword: k })
      .then(r => r?.payload ?? r)
      .catch(()=>null)
    );

    const rows = (await Promise.all(promises)).filter(Boolean);
    LEADS_CACHE = rows;
    renderLeadsTable(rows);
  }

  async function refreshLeads() {
    await loadLeadKeys();
    await loadLeadsPage(1);
    toast("名單已更新");
  }

  function initApiBase() {
    // 優先抓首頁存的 line_worker_url
    const fromHome = (localStorage.getItem("line_worker_url") || "").trim();
    const fromSelf = (localStorage.getItem("questionnaire_worker_url") || "").trim();
    const v = fromHome || fromSelf;
    if (v) {
      API_BASE = v;
      els("inApiBase").value = v;
      els("txtApiBase").textContent = v;
    }
  }

  function setApiBaseFromInput() {
    const v = (els("inApiBase").value || "").trim();
    if (!v) throw new Error("請輸入 Worker 網址");
    API_BASE = v;
    localStorage.setItem("questionnaire_worker_url", v);
    // 同步回首頁的 key（你想要統一就這樣）
    localStorage.setItem("line_worker_url", v);

    els("txtApiBase").textContent = v;
  }

  (function init(){
    // tab
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
    });
    setTab("survey");

    // buttons
    els("btnConnect").addEventListener("click", async ()=>{
      try {
        setApiBaseFromInput();
        await loadConfig().catch(async (e)=>{
          // 如果沒有資料，直接用預設並提示
          toast("目前沒有設定資料（第一次使用），可直接儲存建立", "warn");
          bindSurvey(); renderProducts(); bindRules(); bindSettings(); updatePreview();
        });
        // 順便刷新 leads（不強制）
        await refreshLeads().catch(()=>{});
      } catch(e) {
        toast(e.message, "err");
      }
    });

    els("btnReload").addEventListener("click", async ()=>{
      try { setApiBaseFromInput(); await loadConfig(); } catch(e){ toast(e.message, "err"); }
    });

    els("btnSave").addEventListener("click", async ()=>{
      try { setApiBaseFromInput(); await saveConfig(); } catch(e){ toast(e.message, "err"); }
    });

    els("btnLeadsReload").addEventListener("click", async ()=>{
      try { setApiBaseFromInput(); await refreshLeads(); } catch(e){ toast(e.message, "err"); }
    });

    els("btnPrev").addEventListener("click", async ()=>{
      try { await loadLeadsPage(PAGE - 1); } catch(e){ toast(e.message, "err"); }
    });
    els("btnNext").addEventListener("click", async ()=>{
      try { await loadLeadsPage(PAGE + 1); } catch(e){ toast(e.message, "err"); }
    });

    els("leadsQ").addEventListener("input", ()=> renderLeadsTable(LEADS_CACHE));

    els("btnAddProduct").addEventListener("click", ()=>{
      model.products.push({ name:"", sku:"", tags:"", link:"", desc:"" });
      renderProducts();
      updatePreview();
    });

    els("btnCopyJson").addEventListener("click", async ()=>{
      try {
        await navigator.clipboard.writeText(JSON.stringify(model, null, 2));
        toast("已複製 JSON");
      } catch {
        toast("複製失敗（瀏覽器限制）", "warn");
      }
    });

    // default prompt if empty
    if (!model.survey.prompt) {
      model.survey.prompt =
`你是『健康狀態引導顧問』，用繁中，語氣接地氣但專業，不做醫療診斷，不誇大療效。
每次只問一題。每題都提供 3~5 個可點選選項（短句），也允許使用者自行補充。
總結格式：
【你的狀態】一句話
【你為什麼會這樣】2~4 句（用可能/傾向）
【建議方向】3 點（生活/補充方向）
【適合的產品方向】依規則產生 1~3 個建議（不要承諾效果）
【下一步】引導加 LINE 或看方案`;
    }

    initApiBase();
    bindSurvey(); renderProducts(); bindRules(); bindSettings(); updatePreview();
  })();
</script>
</body>
</html>
