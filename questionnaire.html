<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI å•å·å¾Œå°ï¼ˆç°¡å–®ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      background: linear-gradient(135deg,#f8fafc,#eef2ff,#ecfeff);
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .card{ background: rgba(255,255,255,.86); backdrop-filter: blur(10px); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .shadowSoft{ box-shadow: 0 12px 40px rgba(15,23,42,.10); }
    .toast{ animation: pop .15s ease-out; }
    @keyframes pop{ from{ transform: translateY(6px); opacity:.6 } to{ transform: translateY(0); opacity:1 } }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-6">
      <div>
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 border border-slate-200 text-slate-700 text-xs">
          ç„¡å¯†ç¢¼ï½œæ²¿ç”¨ä½ åŸæœ¬ Workerï½œä¸€èˆ¬äººå¯ç”¨
        </div>
        <h1 class="text-2xl md:text-3xl font-black text-slate-900 mt-2">AI å•å·å¾Œå°ï¼ˆè¶…ç°¡å–®ç‰ˆï¼‰</h1>
        <p class="text-slate-600 mt-1">ç…§é †åºå¡«å®Œ 1ï½5 æ­¥ â†’ æŒ‰ã€Œå„²å­˜ã€â†’ ç›´æ¥ç”¨åœ¨ LINE OAã€‚</p>
      </div>
      <div class="flex gap-2">
        <button id="btnLoad" class="px-4 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 font-semibold">
          è¼‰å…¥
        </button>
        <button id="btnSave" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">
          å„²å­˜
        </button>
      </div>
    </header>

    <!-- Step 0 -->
    <section class="card shadowSoft rounded-2xl p-5 border border-slate-200 mb-4">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="flex-1">
          <h2 class="text-lg font-extrabold text-slate-900">0ï¼‰å…ˆè²¼ä¸Šä½ çš„ Worker ç¶²å€</h2>
          <p class="text-slate-600 text-sm mt-1">ä½ åªè¦è²¼ä¸€æ¬¡ï¼Œä¹‹å¾Œæœƒè‡ªå‹•è¨˜ä½ã€‚</p>
          <input id="apiBase" class="mt-3 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                 placeholder="https://api.xxx.workers.dev">
          <div class="text-xs text-slate-500 mt-2">
            è¨­å®šæœƒå­˜åˆ° KV(DB) çš„ keyï¼š<span class="mono font-semibold">AI_SURVEY:CONFIG</span>ï¼Œ
            Leads key å‰ç¶´ï¼š<span class="mono font-semibold">AI_SURVEY:LEAD:</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="btnCheck" class="px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">
            æ¸¬è©¦é€£ç·š
          </button>
        </div>
      </div>

      <div class="mt-3 text-xs text-slate-500">
        ç›®å‰ APIï¼š<span id="txtApi" class="mono">-</span> ï½œæœ€å¾ŒåŒæ­¥ï¼š<span id="txtSync" class="mono">-</span>
      </div>
    </section>

    <!-- Main -->
    <div class="grid lg:grid-cols-3 gap-4">
      <!-- Left: guide -->
      <aside class="card shadowSoft rounded-2xl p-5 border border-slate-200 h-fit lg:sticky lg:top-4">
        <h3 class="font-extrabold text-slate-900">ä½ è¦åšçš„äº‹ï¼ˆç…§é †åºï¼‰</h3>
        <ol class="mt-3 space-y-2 text-sm text-slate-700">
          <li class="flex gap-2"><span class="font-black text-indigo-600">1</span> è¨­å®šã€Œå•å·é€£çµã€åŠ å¥½å‹é€£çµã€çµå°¾èªªè©ã€</li>
          <li class="flex gap-2"><span class="font-black text-indigo-600">2</span> å¡«ã€Œä½ è¦è³£çš„ç”¢å“/æ–¹æ¡ˆã€</li>
          <li class="flex gap-2"><span class="font-black text-indigo-600">3</span> å¡«ã€Œæ¨è–¦è¦å‰‡ã€è®“ AI ä¸äº‚æ¨</li>
          <li class="flex gap-2"><span class="font-black text-indigo-600">4</span> ä¸€éµå»ºç«‹ã€ŒLINE æ¸¬è©¦é—œéµå­—ï¼šå ±å‘Šã€</li>
          <li class="flex gap-2"><span class="font-black text-indigo-600">5</span> çœ‹ Leadsï¼ˆåšéå•å·çš„åå–®ï¼‰</li>
        </ol>

        <div class="mt-5 p-4 rounded-2xl bg-white border border-slate-200">
          <div class="text-sm font-bold text-slate-900">æœ€å¿«æ¸¬è©¦æ–¹å¼</div>
          <div class="text-sm text-slate-700 mt-2 leading-relaxed">
            å…ˆæŒ‰ <span class="font-semibold">ã€Œä¸€éµå¥—ç”¨ç¯„ä¾‹ã€</span> â†’ å†æŒ‰ <span class="font-semibold">å„²å­˜</span> â†’ åˆ° LINE æ‰“ <span class="font-semibold">ã€Œå ±å‘Šã€</span>ã€‚
          </div>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <button id="btnFillExample" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 font-semibold">
            ä¸€éµå¥—ç”¨ç¯„ä¾‹
          </button>
          <button id="btnClear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 font-semibold">
            æ¸…ç©º
          </button>
        </div>
      </aside>

      <!-- Right -->
      <main class="lg:col-span-2 space-y-4">
        <!-- Step 1: basic -->
        <section class="card shadowSoft rounded-2xl p-5 border border-slate-200">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">1ï¼‰ç³»çµ±è¨­å®šï¼ˆå®¢æˆ¶æœƒçœ‹åˆ°çš„é€£çµï¼‰</h2>
              <p class="text-sm text-slate-600 mt-1">å…ˆå¡«é€™ä¸€å€ï¼Œæœ€é‡è¦ã€‚</p>
            </div>
            <button id="btnOpenPublic" class="hidden px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold" target="_blank">
              é–‹å•Ÿå‰å°
            </button>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-slate-700">å‰å°ç¶²å€ï¼ˆå•ç­”é  URLï¼‰</label>
              <input id="publicUrl" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono" placeholder="https://ä½ çš„ç¶²åŸŸ/survey">
              <p class="text-xs text-slate-500 mt-2">ä½ ä¹‹å¾Œè¦è®“ã€Œåœ–ç‰‡/æŒ‰éˆ•ã€å°åˆ°é€™å€‹ç¶²å€ã€‚</p>
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-700">LINE åŠ å¥½å‹é€£çµï¼ˆå¯é¸ï¼‰</label>
              <input id="addFriendUrl" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono" placeholder="https://lin.ee/xxxxxxx">
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold text-slate-700">AI çµå°¾ CTAï¼ˆæœ€å¾Œä¸€æ®µè¦æ€éº¼å¼•å°ï¼‰</label>
              <textarea id="ctaTemplate" rows="6" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
placeholder="ç¯„ä¾‹ï¼š
æˆ‘æŠŠä½ çš„ç‹€æ³æ•´ç†æˆä¸€ä»½ã€Œç°¡å–®æ–¹å‘ã€çµ¦ä½ ï¼ˆä¸æ¨éŠ·ï¼Œå…ˆè®“ä½ çœ‹æ–¹å‘ï¼‰ã€‚
1) é»é€™è£¡çœ‹æ–¹æ¡ˆï¼š{{public_url}}
2) æˆ–ç›´æ¥åŠ æˆ‘ LINEï¼š{{add_friend_url}}
å›æˆ‘ã€æ–¹æ¡ˆã€æˆ‘å°±å¹«ä½ åšã€‚"></textarea>
              <div class="text-xs text-slate-500 mt-2">å¯ç”¨è®Šæ•¸ï¼š<span class="mono">{{public_url}}</span>ã€<span class="mono">{{add_friend_url}}</span></div>
            </div>
          </div>
        </section>

        <!-- Step 2: survey style -->
        <section class="card shadowSoft rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-extrabold text-slate-900">2ï¼‰AI å•ç­”è¨­å®šï¼ˆAI è¦æ€éº¼å•ï¼‰</h2>
          <p class="text-sm text-slate-600 mt-1">ä½ ä¸ç”¨å¯«å¾ˆå°ˆæ¥­ï¼Œç…§ç¯„ä¾‹æ”¹å¹¾å€‹å­—å°±è¡Œã€‚</p>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-slate-700">å•å·æ¨™é¡Œï¼ˆçµ¦ä½ è‡ªå·±çœ‹ï¼‰</label>
              <input id="surveyTitle" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="ä¾‹å¦‚ï¼šä¸‰åˆ†é˜æ‰¾å‡ºä½ ç‚ºä»€éº¼ä¸€ç›´ç´¯">
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-700">å»ºè­°é¡Œæ•¸</label>
              <input id="surveyTurns" type="number" min="3" max="12" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200">
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold text-slate-700">AI é¢¨æ ¼ï¼ˆä¸ç”¨æ‡‚ï¼Œç…§ç¯„ä¾‹æ”¹ï¼‰</label>
              <textarea id="surveyPrompt" rows="10" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
placeholder="ä½ æ˜¯å¥åº·ç‹€æ…‹å¼•å°é¡§å•ï¼Œç”¨ç¹ä¸­ï¼Œèªæ°£æ¥åœ°æ°£ä½†å°ˆæ¥­ã€‚
ä¸åšé†«ç™‚è¨ºæ–·ï¼Œä¸èª‡å¤§ç™‚æ•ˆï¼Œåªç”¨ï¼šæ”¯æŒ/å¹«åŠ©/ç¶­æŒ/æ”¹å–„ç¿’æ…£ã€‚
æ¯æ¬¡åªå•ä¸€é¡Œï¼Œæ¯é¡Œçµ¦ 3~5 å€‹å¯é»é¸é¸é …ï¼ˆçŸ­å¥ï¼‰ã€‚
æœ€å¾Œè¼¸å‡ºï¼šç‹€æ…‹åˆ†é¡ã€å¯èƒ½åŸå› ã€å»ºè­°æ–¹å‘ã€æ¨è–¦ç”¢å“ã€ä¸‹ä¸€æ­¥ CTAã€‚"></textarea>
              <p class="text-xs text-slate-500 mt-2">å»ºè­°é¿å…ï¼šè¨ºæ–·/æ²»ç™‚/ä¿è­‰/ä¸€å®šæœ‰æ•ˆ ç­‰å­—çœ¼ã€‚</p>
            </div>
          </div>
        </section>

        <!-- Step 3: products simple -->
        <section class="card shadowSoft rounded-2xl p-5 border border-slate-200">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">3ï¼‰ç”¢å“æ¸…å–®ï¼ˆä½ è¦ AI æ¨ä»€éº¼ï¼‰</h2>
              <p class="text-sm text-slate-600 mt-1">ä¸€å€‹ç”¢å“ï¼ä¸€è¡Œã€‚å…ˆæ”¾ 2~3 å€‹æ¸¬è©¦å°±å¥½ã€‚</p>
            </div>
            <button id="btnAddProduct" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">
              + æ–°å¢ä¸€å€‹ç”¢å“
            </button>
          </div>

          <div id="productList" class="mt-4 space-y-3"></div>

          <template id="tplProduct">
            <div class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="grid md:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs font-bold text-slate-600">ç”¢å“åç¨±</label>
                  <input data-k="name" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 font-semibold" placeholder="ä¾‹å¦‚ï¼šèƒ½é‡æ”¯æŒæ–¹æ¡ˆ">
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600">SKU/ä»£ç¢¼ï¼ˆä½ è‡ªå·±çœ‹ï¼‰</label>
                  <input data-k="sku" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 mono" placeholder="ä¾‹å¦‚ï¼šP001">
                </div>

                <div>
                  <label class="text-xs font-bold text-slate-600">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿï¼‰</label>
                  <input data-k="tags" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="ç–²å‹,ç¡çœ ,è…¸èƒƒ">
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600">ç”¢å“/æ–¹æ¡ˆé€£çµ</label>
                  <input data-k="link" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 mono" placeholder="https://ä½ çš„landingpage">
                </div>

                <div class="md:col-span-2">
                  <label class="text-xs font-bold text-slate-600">ä¸€å¥è©±èªªæ˜ï¼ˆåˆ¥å¯«ç™‚æ•ˆï¼‰</label>
                  <textarea data-k="desc" rows="2" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200"
                    placeholder="ä¾‹å¦‚ï¼šæ”¯æŒæ—¥å¸¸èƒ½é‡èˆ‡ç²¾ç¥ç‹€æ…‹ï¼Œé©åˆå¿™ç¢Œã€ä½œæ¯ä¸ç©©è€…ã€‚"></textarea>
                </div>
              </div>

              <div class="mt-3 flex gap-2 justify-end">
                <button data-act="up" class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">ä¸Šç§»</button>
                <button data-act="down" class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">ä¸‹ç§»</button>
                <button data-act="del" class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-500 font-semibold">åˆªé™¤</button>
              </div>
            </div>
          </template>
        </section>

        <!-- Step 4: rules -->
        <section class="card shadowSoft rounded-2xl p-5 border border-slate-200">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">4ï¼‰æ¨è–¦è¦å‰‡ï¼ˆè®“ AI ä¸äº‚æ¨ï¼‰</h2>
              <p class="text-sm text-slate-600 mt-1">ä½ åªè¦æ”¹ã€Œé—œéµå­—ã€å’Œã€ŒSKUã€å°±å¥½ã€‚</p>
            </div>
            <button id="btnRuleExample" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 font-semibold">
              å¥—ç”¨è¦å‰‡ç¯„ä¾‹
            </button>
          </div>

          <textarea id="rulesJson" rows="14" class="mt-4 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
placeholder='[
  {
    "if_any_keywords": ["ç–²å‹", "ç²¾ç¥å·®", "ä¸‹åˆç´¯", "æä¸èµ·å‹"],
    "recommend_skus": ["P001","P002"],
    "summary_title": "èƒ½é‡ä¸‹æ»‘å‹",
    "summary_hint": "åå‘ä½œæ¯/å£“åŠ›/èƒ½é‡åˆ©ç”¨ä¸è¶³çš„çµ„åˆï¼Œå»ºè­°å…ˆæŠŠç¯€å¥ç©©å®šï¼Œå†åšæ”¯æŒã€‚"
  }
]'></textarea>

          <div class="mt-2 text-xs text-slate-500">
            é€™æ®µå¿…é ˆæ˜¯åˆæ³• JSONã€‚ä½ ä¸æƒ³ç¢°å®ƒä¹Ÿè¡Œï¼šå…ˆç”¨ç¯„ä¾‹æ¸¬é€šå†èªªã€‚
          </div>
        </section>

        <!-- Step 5: build LINE test keywords -->
        <section class="card shadowSoft rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-extrabold text-slate-900">5ï¼‰ä¸€éµå»ºç«‹ LINE æ¸¬è©¦é—œéµå­—ï¼ˆä¸ç”¨ä½ å¯«ä»»ä½• codeï¼‰</h2>
          <p class="text-sm text-slate-600 mt-1">
            æŒ‰ä¸€æ¬¡å°±æœƒå¹«ä½ åœ¨ KV(DB) å»º 4 å€‹é—œéµå­—ï¼š<span class="mono">å ±å‘Š</span>ã€<span class="mono">__AI_Q1__</span>ã€<span class="mono">__AI_Q2__:ç²¾ç¥ç–²å‹</span>ã€<span class="mono">__AI_Q3__:ç²¾ç¥ç–²å‹|æœ€è¿‘</span>
          </p>

          <div class="mt-4 grid md:grid-cols-2 gap-3">
            <button id="btnBuildTestFlow" class="px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">
              ä¸€éµå»ºç«‹ã€Œå ±å‘Šã€æ¸¬è©¦æµç¨‹
            </button>
            <button id="btnDeleteTestFlow" class="px-4 py-3 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 font-semibold">
              ï¼ˆå¯é¸ï¼‰æ¸…é™¤æ¸¬è©¦æµç¨‹
            </button>
          </div>

          <div class="mt-4 p-4 rounded-2xl bg-white border border-slate-200">
            <div class="text-sm font-bold text-slate-900">å»ºç«‹å¾Œï¼Œä½ å°±é€™æ¨£æ¸¬ï¼š</div>
            <ol class="mt-2 text-sm text-slate-700 list-decimal ml-5 space-y-1">
              <li>åˆ° LINE å®˜æ–¹å¸³è™ŸèŠå¤©å®¤</li>
              <li>æ‰“ï¼š<span class="font-semibold">å ±å‘Š</span></li>
              <li>é»ï¼šé–‹å§‹ â†’ é¸ï¼šç²¾ç¥ç–²å‹ â†’ é¸ï¼šæœ€è¿‘</li>
              <li>æœƒè·³å‡ºä¸€æ®µã€Œåˆ†æ + ä¸‹ä¸€æ­¥ã€</li>
            </ol>
          </div>
        </section>

        <!-- Leads -->
        <section class="card shadowSoft rounded-2xl p-5 border border-slate-200">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">Leads åå–®ï¼ˆå·²åšéå•å·çš„äººï¼‰</h2>
              <p class="text-sm text-slate-600 mt-1">åªæŠ“ DB è£¡ key ä»¥ <span class="mono">AI_SURVEY:LEAD:</span> é–‹é ­çš„è³‡æ–™ã€‚</p>
            </div>
            <div class="flex gap-2">
              <button id="btnLeadsReload" class="px-4 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 font-semibold">
                åˆ·æ–°åå–®
              </button>
              <input id="leadsQ" class="px-4 py-2 rounded-xl border border-slate-200" placeholder="æœå°‹ï¼ˆå§“å/é—œéµå­—ï¼‰">
            </div>
          </div>

          <div class="mt-4 overflow-auto border border-slate-200 rounded-2xl bg-white">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left py-2 px-3">æ™‚é–“</th>
                  <th class="text-left py-2 px-3">User</th>
                  <th class="text-left py-2 px-3">ç‹€æ…‹</th>
                  <th class="text-left py-2 px-3">æ¨è–¦</th>
                </tr>
              </thead>
              <tbody id="leadsTbody" class="text-slate-900"></tbody>
            </table>
          </div>

          <div class="mt-3 flex items-center justify-between">
            <button id="btnPrev" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">ä¸Šä¸€é </button>
            <div class="text-xs text-slate-500">page: <span id="txtPage" class="mono">1</span> ï½œå…± <span id="txtLeadCount" class="mono">0</span> ç­†</div>
            <button id="btnNext" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200">ä¸‹ä¸€é </button>
          </div>
        </section>

        <!-- Preview JSON -->
        <section class="card shadowSoft rounded-2xl p-5 border border-slate-200">
          <div class="flex items-center justify-between">
            <h3 class="font-extrabold text-slate-900">ç›®å‰è¨­å®šï¼ˆJSON é è¦½ï¼‰</h3>
            <button id="btnCopyJson" class="px-4 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 font-semibold">
              è¤‡è£½ JSON
            </button>
          </div>
          <pre id="jsonPreview" class="mt-3 p-4 rounded-2xl bg-slate-900 text-slate-50 text-xs overflow-auto mono"></pre>
        </section>
      </main>
    </div>
  </div>

  <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(92vw,560px)] space-y-2 z-50"></div>

<script>
  // ====== keys ======
  const CONFIG_KEY = "AI_SURVEY:CONFIG";
  const LEAD_PREFIX = "AI_SURVEY:LEAD:";
  const PAGE_SIZE = 20;

  // ====== state ======
  let API_BASE = "";
  let ALL_LEAD_KEYS = [];
  let LEADS_CACHE = [];
  let PAGE = 1;

  const model = {
    survey: { title: "", turns: 6, prompt: "" },
    products: [],
    rules: [],
    settings: { public_url: "", add_friend_url: "", cta_template: "" }
  };

  // ====== helpers ======
  const el = (id)=>document.getElementById(id);

  function toast(msg, type="ok"){
    const wrap = el("toastWrap");
    const div = document.createElement("div");
    div.className = "toast card shadowSoft rounded-2xl border px-4 py-3 " + (
      type==="ok" ? "border-emerald-200" : type==="warn" ? "border-amber-200" : "border-rose-200"
    );
    div.innerHTML = `<div class="text-sm font-semibold text-slate-900">${escapeHtml(msg)}</div>`;
    wrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function setApiBase(){
    const v = (el("apiBase").value || "").trim();
    if(!v) throw new Error("è«‹å…ˆè²¼ä¸Š Worker ç¶²å€");
    API_BASE = v.replace(/\/$/,"");
    localStorage.setItem("questionnaire_worker_url", API_BASE);
    localStorage.setItem("line_worker_url", API_BASE); // åŒæ­¥é¦–é ç”¨
    el("txtApi").textContent = API_BASE;
  }

  async function apiPost(path, bodyObj){
    if(!API_BASE) throw new Error("Worker ç¶²å€æœªè¨­å®š");
    const res = await fetch(API_BASE + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok || data?.ok === false){
      throw new Error(data?.error || data?.detail || res.statusText);
    }
    return data;
  }

  function updatePreview(){
    el("jsonPreview").textContent = JSON.stringify(model, null, 2);

    const u = (model.settings.public_url || "").trim();
    const btn = el("btnOpenPublic");
    if(u){
      btn.classList.remove("hidden");
      btn.onclick = ()=> window.open(u, "_blank");
    }else{
      btn.classList.add("hidden");
      btn.onclick = null;
    }
  }

  // ====== bind UI ======
  function bindSettings(){
    el("publicUrl").value = model.settings.public_url || "";
    el("addFriendUrl").value = model.settings.add_friend_url || "";
    el("ctaTemplate").value = model.settings.cta_template || "";

    el("publicUrl").oninput = e=>{ model.settings.public_url = e.target.value; updatePreview(); };
    el("addFriendUrl").oninput = e=>{ model.settings.add_friend_url = e.target.value; updatePreview(); };
    el("ctaTemplate").oninput = e=>{ model.settings.cta_template = e.target.value; updatePreview(); };
  }

  function bindSurvey(){
    el("surveyTitle").value = model.survey.title || "";
    el("surveyTurns").value = model.survey.turns || 6;
    el("surveyPrompt").value = model.survey.prompt || "";

    el("surveyTitle").oninput = e=>{ model.survey.title = e.target.value; updatePreview(); };
    el("surveyTurns").oninput = e=>{ model.survey.turns = Number(e.target.value || 6); updatePreview(); };
    el("surveyPrompt").oninput = e=>{ model.survey.prompt = e.target.value; updatePreview(); };
  }

  function renderProducts(){
    const wrap = el("productList");
    wrap.innerHTML = "";
    const tpl = el("tplProduct");

    if(model.products.length===0){
      const div = document.createElement("div");
      div.className = "rounded-2xl border border-dashed border-slate-300 bg-white p-5 text-slate-600";
      div.innerHTML = "ç›®å‰æ²’æœ‰ç”¢å“ã€‚æŒ‰å³ä¸Šè§’ã€Œæ–°å¢ä¸€å€‹ç”¢å“ã€å…ˆæ”¾ 2ï½3 å€‹æ¸¬è©¦å°±å¥½ã€‚";
      wrap.appendChild(div);
      return;
    }

    model.products.forEach((p, idx)=>{
      const node = tpl.content.cloneNode(true);
      const root = node.querySelector("div");

      root.querySelectorAll("[data-k]").forEach(inp=>{
        const k = inp.getAttribute("data-k");
        inp.value = (p[k] ?? "");
        inp.addEventListener("input", e=>{
          p[k] = e.target.value;
          updatePreview();
        });
      });

      root.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="del"){
            model.products.splice(idx,1);
          }else if(act==="up" && idx>0){
            const t=model.products[idx-1]; model.products[idx-1]=model.products[idx]; model.products[idx]=t;
          }else if(act==="down" && idx<model.products.length-1){
            const t=model.products[idx+1]; model.products[idx+1]=model.products[idx]; model.products[idx]=t;
          }
          renderProducts();
          updatePreview();
        });
      });

      wrap.appendChild(node);
    });
  }

  function bindRules(){
    el("rulesJson").value = JSON.stringify(model.rules || [], null, 2);
    el("rulesJson").addEventListener("input", e=>{
      try{
        const v = JSON.parse(e.target.value || "[]");
        model.rules = Array.isArray(v) ? v : [];
        updatePreview();
      }catch{}
    });
  }

  // ====== load/save config ======
  async function loadConfig(){
    const data = await apiPost("/load", { keyword: CONFIG_KEY });
    const cfg = (data?.payload && typeof data.payload==="object") ? data.payload : data;

    if(cfg?.survey) model.survey = cfg.survey;
    if(Array.isArray(cfg?.products)) model.products = cfg.products;
    if(Array.isArray(cfg?.rules)) model.rules = cfg.rules;
    if(cfg?.settings) model.settings = cfg.settings;

    bindSettings(); bindSurvey(); renderProducts(); bindRules(); updatePreview();
    el("txtSync").textContent = new Date().toLocaleString();
    toast("å·²è¼‰å…¥è¨­å®š");
  }

  async function saveConfig(){
    // validate rules json
    try{ JSON.parse(el("rulesJson").value || "[]"); }
    catch{ toast("æ¨è–¦è¦å‰‡æ ¼å¼éŒ¯èª¤ï¼ˆä¸æ˜¯ JSONï¼‰", "warn"); throw new Error("rules JSON invalid"); }

    await apiPost("/save", { keyword: CONFIG_KEY, payload: model });
    el("txtSync").textContent = new Date().toLocaleString();
    toast("å·²å„²å­˜è¨­å®š");
  }

  // ====== leads ======
  function renderLeadsTable(items){
    const tb = el("leadsTbody");
    tb.innerHTML = "";

    const q = (el("leadsQ").value || "").trim().toLowerCase();
    const filtered = (items || []).filter(x => !q || JSON.stringify(x).toLowerCase().includes(q));

    if(filtered.length===0){
      tb.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-slate-500">æ²’æœ‰è³‡æ–™</td></tr>`;
      return;
    }

    filtered.forEach(x=>{
      const tr = document.createElement("tr");
      tr.className = "border-t border-slate-200";

      const dt = x.created_at ? new Date(x.created_at).toLocaleString()
                : x.createdAt ? new Date(x.createdAt).toLocaleString()
                : "-";
      const user = x.display_name || x.displayName || x.user_id || x.userId || "-";
      const title = x.summary_title || x.summaryTitle || x.type || "-";
      const rec = (x.recommend_skus || x.recommendSkus || x.recommendations || []).join?.(", ") || "-";

      tr.innerHTML = `
        <td class="py-2 px-3 text-slate-700">${escapeHtml(dt)}</td>
        <td class="py-2 px-3 font-semibold">${escapeHtml(user)}</td>
        <td class="py-2 px-3">${escapeHtml(title)}</td>
        <td class="py-2 px-3 mono text-xs">${escapeHtml(rec)}</td>
      `;
      tb.appendChild(tr);
    });
  }

  async function loadLeadKeys(){
    const data = await apiPost("/listAll", {});
    const db = data?.db || [];
    ALL_LEAD_KEYS = db.filter(k => k.startsWith(LEAD_PREFIX)).sort((a,b)=> b.localeCompare(a));
    el("txtLeadCount").textContent = String(ALL_LEAD_KEYS.length);
  }

  async function loadLeadsPage(page){
    PAGE = Math.max(1, page);
    el("txtPage").textContent = String(PAGE);

    const start = (PAGE-1)*PAGE_SIZE;
    const keys = ALL_LEAD_KEYS.slice(start, start+PAGE_SIZE);

    if(keys.length===0){
      LEADS_CACHE = [];
      renderLeadsTable([]);
      return;
    }

    const promises = keys.map(k => apiPost("/loadAny", { namespace:"DB", keyword:k })
      .then(r => r?.payload ?? r)
      .catch(()=>null)
    );

    const rows = (await Promise.all(promises)).filter(Boolean);
    LEADS_CACHE = rows;
    renderLeadsTable(rows);
  }

  async function refreshLeads(){
    await loadLeadKeys();
    await loadLeadsPage(1);
    toast("åå–®å·²æ›´æ–°");
  }

  // ====== one-click examples ======
  function fillExample(){
    model.settings.public_url = model.settings.public_url || "https://example.com/survey";
    model.settings.add_friend_url = model.settings.add_friend_url || "https://lin.ee/xxxxxxx";
    model.settings.cta_template = model.settings.cta_template || (
`æˆ‘æŠŠä½ çš„ç‹€æ³æ•´ç†æˆä¸€ä»½ã€Œç°¡å–®æ–¹å‘ã€çµ¦ä½ ï¼ˆä¸æ¨éŠ·ï¼Œå…ˆè®“ä½ çœ‹æ–¹å‘ï¼‰ã€‚
1) é»é€™è£¡çœ‹æ–¹æ¡ˆï¼š{{public_url}}
2) æˆ–ç›´æ¥åŠ æˆ‘ LINEï¼š{{add_friend_url}}
å›æˆ‘ã€æ–¹æ¡ˆã€æˆ‘å°±å¹«ä½ åšã€‚`
    );

    model.survey.title = model.survey.title || "ä¸‰åˆ†é˜æ‰¾å‡ºä½ ç‚ºä»€éº¼ä¸€ç›´ç´¯";
    model.survey.turns = model.survey.turns || 6;
    model.survey.prompt = model.survey.prompt || (
`ä½ æ˜¯å¥åº·ç‹€æ…‹å¼•å°é¡§å•ï¼Œç”¨ç¹ä¸­ï¼Œèªæ°£æ¥åœ°æ°£ä½†å°ˆæ¥­ã€‚
ä¸åšé†«ç™‚è¨ºæ–·ï¼Œä¸èª‡å¤§ç™‚æ•ˆï¼Œåªç”¨ï¼šæ”¯æŒ/å¹«åŠ©/ç¶­æŒ/æ”¹å–„ç¿’æ…£ã€‚
æ¯æ¬¡åªå•ä¸€é¡Œï¼Œæ¯é¡Œçµ¦ 3~5 å€‹å¯é»é¸é¸é …ï¼ˆçŸ­å¥ï¼‰ã€‚
æœ€å¾Œè¼¸å‡ºï¼šç‹€æ…‹åˆ†é¡ã€å¯èƒ½åŸå› ã€å»ºè­°æ–¹å‘ã€æ¨è–¦ç”¢å“ã€ä¸‹ä¸€æ­¥ CTAã€‚`
    );

    if(model.products.length===0){
      model.products = [
        { name:"èƒ½é‡æ”¯æŒæ–¹æ¡ˆ", sku:"P001", tags:"ç–²å‹,ç²¾ç¥,å¿™ç¢Œ", link:"https://example.com/p001", desc:"æ”¯æŒæ—¥å¸¸èƒ½é‡èˆ‡ç²¾ç¥ç‹€æ…‹ï¼Œé©åˆå¿™ç¢Œã€ä½œæ¯ä¸ç©©è€…ã€‚" },
        { name:"ç¡çœ ç¯€å¥æ–¹æ¡ˆ", sku:"P002", tags:"ç¡çœ ,æ”¾é¬†,ä½œæ¯", link:"https://example.com/p002", desc:"æ”¯æŒæ”¾é¬†èˆ‡ç¡çœ ç¯€å¥ï¼Œé©åˆå£“åŠ›å¤§ã€æ™šç¡è€…ã€‚" }
      ];
    }

    if(!Array.isArray(model.rules) || model.rules.length===0){
      model.rules = [
        {
          if_any_keywords: ["ç–²å‹","ç²¾ç¥å·®","ä¸‹åˆç´¯","æä¸èµ·å‹"],
          recommend_skus: ["P001"],
          summary_title: "èƒ½é‡ä¸‹æ»‘å‹",
          summary_hint: "åå‘ä½œæ¯/å£“åŠ›/èƒ½é‡åˆ©ç”¨ä¸è¶³ï¼Œå…ˆç©©å®šç¯€å¥ï¼Œå†åšæ”¯æŒã€‚"
        },
        {
          if_any_keywords: ["ç¡ä¸å¥½","æ·ºçœ ","é›£å…¥ç¡","æ—©é†’"],
          recommend_skus: ["P002"],
          summary_title: "ç¡çœ ç¯€å¥å‹",
          summary_hint: "åå‘æ”¾é¬†ä¸è¶³æˆ–ä½œæ¯ä¸ç©©ï¼Œå…ˆå»ºç«‹ç¯€å¥ï¼Œå†åšæ”¯æŒã€‚"
        }
      ];
    }

    bindSettings(); bindSurvey(); renderProducts(); bindRules(); updatePreview();
    toast("å·²å¥—ç”¨ç¯„ä¾‹ï¼ˆä½ ç¾åœ¨å¯ä»¥ç›´æ¥æŒ‰ã€Œå„²å­˜ã€ï¼‰");
  }

  function clearAll(){
    model.survey = { title:"", turns: 6, prompt:"" };
    model.products = [];
    model.rules = [];
    model.settings = { public_url:"", add_friend_url:"", cta_template:"" };
    bindSettings(); bindSurvey(); renderProducts(); bindRules(); updatePreview();
    toast("å·²æ¸…ç©º");
  }

  function setRulesExample(){
    model.rules = [
      {
        if_any_keywords: ["ç–²å‹","ç²¾ç¥å·®","ä¸‹åˆç´¯","æä¸èµ·å‹"],
        recommend_skus: ["P001","P002"],
        summary_title: "èƒ½é‡ä¸‹æ»‘å‹",
        summary_hint: "åå‘ä½œæ¯/å£“åŠ›/èƒ½é‡åˆ©ç”¨ä¸è¶³çš„çµ„åˆï¼Œå…ˆç©©å®šç¯€å¥ï¼Œå†åšæ”¯æŒã€‚"
      }
    ];
    bindRules(); updatePreview();
    toast("å·²å¥—ç”¨è¦å‰‡ç¯„ä¾‹");
  }

  // ====== build LINE test flow keywords (using /save) ======
  async function buildTestFlow(){
    // é€™äº›æœƒå­˜åˆ° DBï¼ˆä½ çš„ webhook æ˜¯ç”¨ userText å» DB.getï¼Œæ‰€ä»¥è¦ç›´æ¥å»º keywordï¼‰
    const k0 = "å ±å‘Š";
    const k1 = "__AI_Q1__";
    const k2 = "__AI_Q2__:ç²¾ç¥ç–²å‹";
    const k3 = "__AI_Q3__:ç²¾ç¥ç–²å‹|æœ€è¿‘";

    const payload0 = {
      mode: "text",
      replyText: "æˆ‘æœƒå¹«ä½ å¿«é€Ÿé‡æ¸…ç‹€æ³ï¼Œå…ˆå›ç­”å¹¾å€‹å•é¡ŒğŸ‘‡",
      quickReplies: [{ label:"é–‹å§‹", text:k1 }]
    };

    const payload1 = {
      mode: "text",
      replyText: "ç¬¬ä¸€é¡Œï¼šä½ ç›®å‰æœ€æƒ³æ”¹å–„å“ªä¸€å¡Šï¼Ÿ",
      quickReplies: [
        { label:"ç²¾ç¥ç–²å‹", text:k2 },
        { label:"ç¡çœ ç‹€æ³", text:"__AI_Q2__:ç¡çœ " },
        { label:"è…¸èƒƒæ¶ˆåŒ–", text:"__AI_Q2__:è…¸èƒƒ" },
        { label:"é«”æ…‹ä»£è¬", text:"__AI_Q2__:é«”æ…‹" }
      ]
    };

    const payload2 = {
      mode: "text",
      replyText: "ç¬¬äºŒé¡Œï¼šé€™å€‹ç‹€æ³å¤§æ¦‚å¤šä¹…äº†ï¼Ÿ",
      quickReplies: [
        { label:"æœ€è¿‘", text:k3 },
        { label:"å¹¾é€±", text:"__AI_Q3__:ç²¾ç¥ç–²å‹|å¹¾é€±" },
        { label:"å¹¾å€‹æœˆ", text:"__AI_Q3__:ç²¾ç¥ç–²å‹|å¹¾å€‹æœˆ" }
      ]
    };

    const payload3 = {
      messages: [{
        type:"text",
        text:
"æˆ‘å¤§æ¦‚äº†è§£ä½ çš„ç‹€æ³äº†ï¼Œå…ˆçµ¦ä½ ä¸€å€‹æ–¹å‘ğŸ‘‡\n\n" +
"ã€ä½ çš„ç‹€æ…‹ã€‘çŸ­æœŸèƒ½é‡ä¸‹æ»‘å‹\n" +
"ã€å¯èƒ½åŸå› ã€‘ä½œæ¯ç·Šã€å£“åŠ›é«˜ã€æ¢å¾©ä¸è¶³ï¼ˆåå¯èƒ½/å‚¾å‘ï¼Œä¸æ˜¯è¨ºæ–·ï¼‰\n" +
"ã€å»ºè­°æ–¹å‘ã€‘\n" +
"1) å…ˆæŠŠç¡çœ ç¯€å¥æ‹‰å›ä¾†\n" +
"2) ç™½å¤©è£œæ°´èˆ‡è¦å¾‹é€²é£Ÿ\n" +
"3) æ¸›å°‘é€£çºŒé«˜å£“å·¥ä½œæ®µ\n\n" +
"å¦‚æœä½ é¡˜æ„ï¼Œæˆ‘å¯ä»¥æŠŠä½ çš„ç‹€æ³æ•´ç†æˆã€Œ1 ä»½ç°¡å–®æ–¹æ¡ˆã€çµ¦ä½ ï¼ˆä¸æ¨éŠ·ï¼Œå…ˆè®“ä½ çœ‹æ–¹å‘ï¼‰ã€‚\n" +
"å›æˆ‘ã€æ–¹æ¡ˆã€æˆ‘å°±å¹«ä½ åšã€‚"
      }]
    };

    await apiPost("/save", { keyword:k0, payload:payload0 });
    await apiPost("/save", { keyword:k1, payload:payload1 });
    await apiPost("/save", { keyword:k2, payload:payload2 });
    await apiPost("/save", { keyword:k3, payload:payload3 });

    toast("å·²å»ºç«‹ã€Œå ±å‘Šã€æ¸¬è©¦æµç¨‹ï¼šå» LINE æ‰“ã€å ±å‘Šã€å³å¯");
  }

  async function deleteTestFlow(){
    const keys = ["å ±å‘Š","__AI_Q1__","__AI_Q2__:ç²¾ç¥ç–²å‹","__AI_Q3__:ç²¾ç¥ç–²å‹|æœ€è¿‘"];
    // ä½ çš„ worker æœ‰ /delete (DB)ï¼›ä¹Ÿæœ‰ /deleteAny
    // é€™è£¡ç”¨ /deleteï¼ˆç°¡å–®ï¼‰
    for(const k of keys){
      try{ await apiPost("/delete", { keyword:k }); }catch{}
    }
    toast("å·²æ¸…é™¤æ¸¬è©¦æµç¨‹ï¼ˆå¦‚æœä¹‹å‰æœ‰å»ºï¼‰");
  }

  // ====== init ======
  (function init(){
    // restore api
    const fromHome = (localStorage.getItem("line_worker_url")||"").trim();
    const fromSelf = (localStorage.getItem("questionnaire_worker_url")||"").trim();
    const v = fromHome || fromSelf;
    if(v){
      el("apiBase").value = v;
      API_BASE = v.replace(/\/$/,"");
      el("txtApi").textContent = API_BASE;
    }

    // default prompt if empty
    if(!model.survey.prompt){
      model.survey.prompt =
`ä½ æ˜¯å¥åº·ç‹€æ…‹å¼•å°é¡§å•ï¼Œç”¨ç¹ä¸­ï¼Œèªæ°£æ¥åœ°æ°£ä½†å°ˆæ¥­ã€‚
ä¸åšé†«ç™‚è¨ºæ–·ï¼Œä¸èª‡å¤§ç™‚æ•ˆï¼Œåªç”¨ï¼šæ”¯æŒ/å¹«åŠ©/ç¶­æŒ/æ”¹å–„ç¿’æ…£ã€‚
æ¯æ¬¡åªå•ä¸€é¡Œï¼Œæ¯é¡Œçµ¦ 3~5 å€‹å¯é»é¸é¸é …ï¼ˆçŸ­å¥ï¼‰ã€‚
æœ€å¾Œè¼¸å‡ºï¼šç‹€æ…‹åˆ†é¡ã€å¯èƒ½åŸå› ã€å»ºè­°æ–¹å‘ã€æ¨è–¦ç”¢å“ã€ä¸‹ä¸€æ­¥ CTAã€‚`;
    }

    bindSettings(); bindSurvey(); renderProducts(); bindRules(); updatePreview();

    // actions
    el("btnCheck").onclick = async ()=>{
      try{
        setApiBase();
        await apiPost("/listAll", {}); // èƒ½è·‘å°±ä»£è¡¨é€š
        toast("é€£ç·šæˆåŠŸ");
      }catch(e){
        toast(e.message || "é€£ç·šå¤±æ•—", "err");
      }
    };

    el("btnLoad").onclick = async ()=>{
      try{
        setApiBase();
        await loadConfig().catch(()=>toast("ç›®å‰æ²’æœ‰è¨­å®šè³‡æ–™ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰", "warn"));
        await refreshLeads().catch(()=>{});
      }catch(e){ toast(e.message, "err"); }
    };

    el("btnSave").onclick = async ()=>{
      try{
        setApiBase();
        await saveConfig();
      }catch(e){ toast(e.message, "err"); }
    };

    el("btnFillExample").onclick = ()=> fillExample();
    el("btnClear").onclick = ()=> clearAll();
    el("btnRuleExample").onclick = ()=> setRulesExample();

    el("btnAddProduct").onclick = ()=>{
      model.products.push({ name:"", sku:"", tags:"", link:"", desc:"" });
      renderProducts(); updatePreview();
    };

    el("btnCopyJson").onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(JSON.stringify(model, null, 2));
        toast("å·²è¤‡è£½ JSON");
      }catch{
        toast("è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰", "warn");
      }
    };

    el("btnBuildTestFlow").onclick = async ()=>{
      try{ setApiBase(); await buildTestFlow(); }
      catch(e){ toast(e.message, "err"); }
    };

    el("btnDeleteTestFlow").onclick = async ()=>{
      try{ setApiBase(); await deleteTestFlow(); }
      catch(e){ toast(e.message, "err"); }
    };

    el("btnLeadsReload").onclick = async ()=>{
      try{ setApiBase(); await refreshLeads(); }
      catch(e){ toast(e.message, "err"); }
    };

    el("leadsQ").oninput = ()=> renderLeadsTable(LEADS_CACHE);
    el("btnPrev").onclick = async ()=>{ try{ await loadLeadsPage(PAGE-1); }catch(e){ toast(e.message,"err"); } };
    el("btnNext").onclick = async ()=>{ try{ await loadLeadsPage(PAGE+1); }catch(e){ toast(e.message,"err"); } };

    // update open public
    updatePreview();
  })();
</script>
</body>
</html>
