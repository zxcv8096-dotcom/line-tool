<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI 問卷後台（完整強化版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      background: linear-gradient(135deg, #f8fafc, #eef2ff, #ecfeff);
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .card { background: rgba(255,255,255,.92); backdrop-filter: blur(10px); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    /* 讓手機匯入框舒服可滑、不卡住 */
    textarea { -webkit-overflow-scrolling: touch; }
    /* modal 內部滾動 */
    .modal-scroll { max-height: min(78vh, 720px); overflow: auto; -webkit-overflow-scrolling: touch; }
  </style>
</head>

<body class="min-h-screen safe-bottom">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">AI 問卷後台</h1>
        <p class="text-slate-600 mt-1">多問卷｜關鍵字綁定｜一鍵刪除｜可預覽｜可匯入文字｜Leads 報告</p>
      </div>
      <div class="flex gap-2">
        <button id="btnOpenClient" class="hidden px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">
          開啟客戶前台（LIFF 問卷）
        </button>
      </div>
    </header>

    <!-- CONNECT -->
    <section class="card rounded-2xl shadow p-5 mb-4 border border-slate-200">
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="text-sm font-semibold text-slate-700">Worker 網址</label>
          <input id="inApiBase" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                 placeholder="https://api.xxx.workers.dev" />
          <div class="text-xs text-slate-500 mt-2">
            問卷：<span class="mono font-semibold">AI_SURVEY:Q:&lt;name&gt;</span>　
            關鍵字表：<span class="mono font-semibold">AI_SURVEY:KW_MAP</span>　
            Leads：<span class="mono font-semibold">AI_SURVEY:LEAD:</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="btnConnect" class="w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">連線</button>
          <button id="btnSave" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 font-semibold">儲存</button>
        </div>
      </div>

      <div class="mt-3 grid md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs font-bold text-slate-500">LIFF ID</label>
          <input id="inLiffId" class="mt-1 w-full px-4 py-2 rounded-xl border border-slate-200 mono" placeholder="例如：2001234567-abcDEF" />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs font-bold text-slate-500">客戶問卷頁檔名（固定）</label>
          <input disabled class="mt-1 w-full px-4 py-2 rounded-xl border border-slate-200 mono bg-slate-50" value="liff_survey.html" />
        </div>
      </div>

      <div class="mt-3 text-xs text-slate-500">
        狀態：<span id="txtStatus" class="font-semibold">未連線</span>　
        最後同步：<span id="txtLastSync" class="mono">-</span>
      </div>
    </section>

    <div class="grid lg:grid-cols-3 gap-4">
      <!-- LEFT -->
      <aside class="card rounded-2xl shadow p-4 border border-slate-200 h-fit lg:sticky lg:top-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-500">問卷清單</div>
            <div class="text-sm text-slate-900 font-semibold">（可存多份｜可刪除）</div>
          </div>
          <button id="btnNew" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">新增</button>
        </div>

        <div class="mt-3">
          <input id="qSearch" class="w-full px-4 py-2 rounded-xl border border-slate-200" placeholder="搜尋…" />
        </div>

        <div id="surveyList" class="mt-3 space-y-2"></div>

        <hr class="my-4 border-slate-200" />

        <button id="btnTabBuilder" class="w-full text-left px-4 py-3 rounded-xl bg-slate-900 text-white font-semibold">① 問卷設定</button>
        <button id="btnTabPreview" class="w-full text-left px-4 py-3 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 mt-2 font-semibold text-slate-900">② 預覽互動</button>
        <button id="btnTabLeads" class="w-full text-left px-4 py-3 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 mt-2 font-semibold text-slate-900">③ Leads 報告</button>

        <div class="mt-4 text-xs text-slate-500">
          Leads：<span id="txtLeadCount" class="mono font-semibold">0</span> 筆
        </div>
      </aside>

      <!-- RIGHT -->
      <main class="lg:col-span-2 space-y-4">
        <!-- BUILDER -->
        <section id="tabBuilder" class="card rounded-2xl shadow p-5 border border-slate-200">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">① 問卷設定</h2>
              <p class="text-sm text-slate-600 mt-1">第 1 題可多選項；第 2 題後每題固定 4 個選項。</p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <button id="btnBulk" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">批次匯入</button>
              <button id="btnAddQ" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">新增題目</button>
              <button id="btnCopyLinkTop" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">複製入口</button>
            </div>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold text-slate-700">問卷檔名（唯一）</label>
              <input id="inName" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="例如：健康需求分流_8題_第一版" />
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-700">問卷標題（客戶看到）</label>
              <input id="inTitle" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="例如：三分鐘找出你最想改善的方向" />
            </div>

            <!-- ✅ 關鍵字（不說明、不占版面） -->
            <div class="md:col-span-2">
              <div class="flex items-center justify-between gap-2">
                <label class="text-sm font-semibold text-slate-700">關鍵字</label>
                <div id="kwHint" class="text-xs font-semibold text-slate-500"></div>
              </div>
              <input id="inKeyword" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
                     placeholder="例如：健康問卷" />
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold text-slate-700">結尾報告模板（你的口吻）</label>
              <textarea id="inReportHint" rows="4" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
                placeholder="例如：用接地氣的方式整理他的答案，給 1~3 個方向，最後叫他回『報告』。"></textarea>
            </div>

            <!-- ✅ 入口連結（直接顯示＋一鍵複製，不再 prompt） -->
            <div class="md:col-span-2">
              <div class="flex items-center justify-between gap-2">
                <label class="text-sm font-semibold text-slate-700">入口連結</label>
                <button id="btnCopyLink" class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-sm font-semibold">複製</button>
              </div>
              <input id="inClientUrl" readonly class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono bg-slate-50" value="" />
            </div>
          </div>

          <div class="mt-5">
            <h3 class="font-bold text-slate-900">題目列表</h3>
            <div class="mt-1 text-xs text-slate-500">第 1 題可多選項；第 2 題後每題 4 選項。</div>
            <div id="qWrap" class="mt-3 space-y-3"></div>
          </div>
        </section>

        <!-- PREVIEW -->
        <section id="tabPreview" class="hidden card rounded-2xl shadow p-5 border border-slate-200">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">② 預覽互動</h2>
              <p class="text-sm text-slate-600 mt-1">你自己先試跑，確認流程和文字。</p>
            </div>
            <div class="flex gap-2">
              <button id="btnPreviewRestart" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">重來</button>
              <button id="btnPreviewToLeads" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">看 Leads</button>
            </div>
          </div>

          <div class="mt-4 rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div id="pvTitle" class="text-lg font-extrabold text-slate-900">-</div>
            <div id="pvStep" class="text-xs text-slate-500 mt-1">-</div>

            <div class="mt-4 rounded-2xl bg-slate-900 text-white p-4">
              <div id="pvQuestion" class="text-base font-semibold">-</div>
              <div id="pvOptions" class="mt-3 grid md:grid-cols-2 gap-2"></div>
            </div>

            <div class="mt-4">
              <h4 class="font-bold text-slate-900">你剛剛選的答案（預覽）</h4>
              <div id="pvAnswers" class="mt-2 text-sm text-slate-700 space-y-1"></div>
            </div>

            <div class="mt-4 hidden" id="pvReportBox">
              <h4 class="font-bold text-slate-900">完成後報告（預覽）</h4>
              <div id="pvReport" class="mt-2 rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-800 whitespace-pre-line"></div>
            </div>
          </div>
        </section>

        <!-- LEADS -->
        <section id="tabLeads" class="hidden card rounded-2xl shadow p-5 border border-slate-200">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">③ Leads 報告</h2>
              <p class="text-sm text-slate-600 mt-1">顯示：大頭照、暱稱、userId、問卷、時間、報告</p>
            </div>
            <div class="flex gap-2">
              <input id="leadSearch" class="px-4 py-2 rounded-xl border border-slate-200" placeholder="搜尋…" />
              <button id="btnLeadsReload" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">刷新</button>
            </div>
          </div>

          <div id="leadList" class="mt-4 space-y-3"></div>
        </section>

        <!-- TOAST -->
        <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(92vw,560px)] space-y-2 z-50"></div>
      </main>
    </div>
  </div>

  <!-- BULK MODAL -->
  <div id="bulkModal" class="hidden fixed inset-0 bg-black/40 z-50">
    <div class="max-w-3xl mx-auto p-4 md:p-8">
      <div class="card rounded-2xl shadow border border-slate-200 p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xl font-extrabold text-slate-900">批次匯入</div>
            <div class="text-sm text-slate-600 mt-1">貼上純文字 → 自動填入（檔名/標題/報告/題目/選項）</div>
          </div>
          <button id="btnBulkClose" class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">關閉</button>
        </div>

        <div class="mt-4 modal-scroll rounded-2xl border border-slate-200 bg-white/70 p-4 text-sm text-slate-700">
          <div class="font-bold">格式範例：</div>
<pre class="mt-2 p-3 rounded-xl bg-slate-900 text-slate-50 text-xs overflow-auto mono whitespace-pre-wrap">NAME: 健康問卷_第一版
TITLE: 三分鐘了解你目前最想改善的方向
KEYWORD: 健康問卷
REPORT:
我會用你的選擇整理成「一個優先方向＋兩個加分方向」。
我會給你 3 個今天就能做的調整重點。
如果你願意，回我「報告」，我幫你整理成更清楚的版本。
ENDREPORT

Q: 你現在最想先改善哪一塊？
- 睡眠
- 壓力
- 精神
- 腸胃
- 體態
- 運動
- 免疫
- 皮膚

Q: 你最近睡得怎麼樣？
- 一覺到天亮
- 會醒幾次
- 很難入睡
- 醒來還是累</pre>
        </div>

        <textarea id="bulkText" rows="12"
          class="mt-4 w-full px-4 py-3 rounded-2xl border border-slate-200 mono"
          style="min-height: 260px; max-height: 48vh; overflow:auto;"
          placeholder="把問卷文字貼這裡…"></textarea>

        <div class="mt-4 flex flex-wrap gap-2 justify-end">
          <button id="btnBulkExample" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">塞入範例</button>
          <button id="btnBulkApply" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">套用</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= KV Keys =========
  const Q_PREFIX = "AI_SURVEY:Q:";
  const LEAD_PREFIX = "AI_SURVEY:LEAD:";
  const KW_MAP_KEY = "AI_SURVEY:KW_MAP";

  // ========= State =========
  let API_BASE = "";
  let SURVEYS = [];     // list of {key,name}
  let CURRENT = makeEmptySurvey();
  let PREVIEW = { idx: 0, answers: [] };
  let LEADS = [];
  let KW_MAP = {};      // keyword -> surveyName

  // ========= Helpers =========
  const $ = (id)=>document.getElementById(id);

  function toast(msg, type="ok"){
    const wrap = $("toastWrap");
    const div = document.createElement("div");
    div.className = `card rounded-2xl shadow px-4 py-3 border ${
      type==="ok" ? "border-emerald-200" : type==="warn" ? "border-amber-200" : "border-rose-200"
    }`;
    div.innerHTML = `<div class="text-sm text-slate-900 font-semibold">${escapeHtml(msg)}</div>`;
    wrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normKw(s){
    return String(s||"").trim();
  }

  function makeEmptySurvey(){
    return {
      name: "",
      title: "",
      keyword: "",
      reportHint: "",
      questions: [
        { q:"你現在最想先改善哪一塊？", a:["睡眠","壓力","精神","腸胃","體態","運動","免疫","皮膚"] },
        { q:"你最近睡得怎麼樣？", a:["一覺到天亮","會醒幾次","很難入睡","醒來還是累"] },
        { q:"你白天狀態比較像？", a:["精神穩定","下午下滑","注意力差","常想躺"] },
        { q:"你飲食習慣較像？", a:["三餐固定","常外食","常跳餐","愛吃甜/炸"] },
        { q:"你壓力感比較像？", a:["不太有","偶爾緊","常緊繃","腦停不下"] },
        { q:"你腸胃狀態較像？", a:["很順","偶爾卡","常脹氣","忽快忽慢"] },
        { q:"你運動後恢復？", a:["很快","普通","很久","很少運動"] },
        { q:"你最想先做到？", a:["睡更好","更有精神","更輕盈","更穩定"] },
      ]
    };
  }

  async function api(path, bodyObj){
    if(!API_BASE) throw new Error("Worker 網址未設定");
    const res = await fetch(API_BASE.replace(/\/$/,"") + path, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || res.statusText);
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }

  function setTab(tab){
    $("tabBuilder").classList.toggle("hidden", tab!=="builder");
    $("tabPreview").classList.toggle("hidden", tab!=="preview");
    $("tabLeads").classList.toggle("hidden", tab!=="leads");

    $("btnTabBuilder").className = tab==="builder"
      ? "w-full text-left px-4 py-3 rounded-xl bg-slate-900 text-white font-semibold"
      : "w-full text-left px-4 py-3 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 mt-0 font-semibold text-slate-900";

    $("btnTabPreview").className = tab==="preview"
      ? "w-full text-left px-4 py-3 rounded-xl bg-slate-900 text-white font-semibold mt-2"
      : "w-full text-left px-4 py-3 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 mt-2 font-semibold text-slate-900";

    $("btnTabLeads").className = tab==="leads"
      ? "w-full text-left px-4 py-3 rounded-xl bg-slate-900 text-white font-semibold mt-2"
      : "w-full text-left px-4 py-3 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 mt-2 font-semibold text-slate-900";
  }

  // ========= KW Map =========
  async function refreshKwMap(){
    const data = await api("/kwMapGet", {});
    KW_MAP = (data && data.payload && typeof data.payload === "object") ? data.payload : {};
  }

  async function saveKwMap(){
    await api("/kwMapPut", { payload: KW_MAP });
  }

  function keywordOwner(kw){
    const k = normKw(kw);
    if(!k) return "";
    return KW_MAP[k] || "";
  }

  function updateKwHint(){
    const kw = normKw($("inKeyword").value);
    const name = normKw($("inName").value || CURRENT.name);
    const owner = keywordOwner(kw);
    const el = $("kwHint");
    el.textContent = "";
    el.className = "text-xs font-semibold text-slate-500";

    if(!kw) return;

    if(owner && owner !== name){
      el.textContent = "已被使用";
      el.className = "text-xs font-extrabold text-rose-600";
    }else{
      el.textContent = "可用";
      el.className = "text-xs font-extrabold text-emerald-700";
    }
  }

  // ========= Survey list =========
  async function refreshSurveyList(){
    const data = await api("/listAll", {});
    const db = data.db || [];
    SURVEYS = db
      .filter(k => k.startsWith(Q_PREFIX))
      .map(k => ({ key:k, name:k.replace(Q_PREFIX,"") }))
      .sort((a,b)=>a.name.localeCompare(b.name,"zh-Hant"));
    renderSurveyList();
  }

  function renderSurveyList(){
    const wrap = $("surveyList");
    wrap.innerHTML = "";
    const q = ($("qSearch").value || "").trim().toLowerCase();
    const items = SURVEYS.filter(x => !q || x.name.toLowerCase().includes(q));

    if(items.length===0){
      const d = document.createElement("div");
      d.className = "rounded-2xl border border-dashed border-slate-300 bg-white/60 p-4 text-slate-600 text-sm";
      d.textContent = "目前沒有問卷。按「新增」建立。";
      wrap.appendChild(d);
      return;
    }

    items.forEach(x=>{
      const row = document.createElement("div");
      row.className = "rounded-2xl bg-white/70 border border-slate-200 overflow-hidden";

      const btn = document.createElement("button");
      btn.className = "w-full text-left px-4 py-3 hover:bg-white flex items-start justify-between gap-3";
      btn.innerHTML = `
        <div class="min-w-0">
          <div class="font-semibold text-slate-900 truncate">${escapeHtml(x.name)}</div>
          <div class="text-xs text-slate-500 mono truncate">${escapeHtml(x.key)}</div>
        </div>
        <div class="shrink-0 flex items-center gap-2">
          <span class="text-xs px-2 py-1 rounded-full bg-slate-50 border border-slate-200 font-semibold text-slate-600">載入</span>
        </div>
      `;
      btn.onclick = async ()=>{
        try{
          const loaded = await api("/loadAny", { namespace:"DB", keyword: x.key });
          const payload = loaded.payload || loaded;
          CURRENT = normalizeSurvey(payload);
          fillBuilder();
          toast("已載入：" + x.name);
          setTab("builder");
        }catch(e){
          toast(e.message, "err");
        }
      };

      const del = document.createElement("button");
      del.className = "w-full px-4 py-2 bg-rose-600 text-white hover:bg-rose-500 font-extrabold";
      del.textContent = "刪除";
      del.onclick = async ()=>{
        const ok = confirm(`確定刪除「${x.name}」？（會連同關鍵字一起刪）`);
        if(!ok) return;
        try{
          await api("/surveyDelete", { surveyName: x.name });
          toast("已刪除：" + x.name);
          // 若正在編輯同一份，清空
          if((CURRENT.name||"") === x.name){
            CURRENT = makeEmptySurvey();
            fillBuilder();
          }
          await refreshKwMap().catch(()=>{});
          await refreshSurveyList();
        }catch(e){
          toast(e.message, "err");
        }
      };

      row.appendChild(btn);
      row.appendChild(del);
      wrap.appendChild(row);
    });
  }

  function normalizeSurvey(obj){
    const s = makeEmptySurvey();
    if(obj && typeof obj === "object"){
      s.name = obj.name || s.name;
      s.title = obj.title || s.title;
      s.keyword = obj.keyword || "";
      s.reportHint = obj.reportHint || obj.reportHint;
      if(Array.isArray(obj.questions)) s.questions = obj.questions.map(q=>({
        q: (q.q||"").toString(),
        a: Array.isArray(q.a) ? q.a.map(x=>(x||"").toString()) : []
      }));
    }
    // 第 1 題：保留全部選項（至少 4）
    if(s.questions[0]){
      const a0 = (s.questions[0].a||[]);
      while(a0.length<4) a0.push("");
      s.questions[0].a = a0;
    }
    // 第 2 題後：固定 4
    s.questions = s.questions.map((q, idx)=>{
      const a = (q.a||[]);
      if(idx===0) return { q:q.q, a:a };
      while(a.length<4) a.push("");
      return { q:q.q, a:a.slice(0,4) };
    });
    return s;
  }

  // ========= Builder UI =========
  function fillBuilder(){
    $("inName").value = CURRENT.name || "";
    $("inTitle").value = CURRENT.title || "";
    $("inKeyword").value = CURRENT.keyword || "";
    $("inReportHint").value = CURRENT.reportHint || "";
    renderQuestions();
    updateClientBtn();
    updateKwHint();
  }

  function renderQuestions(){
    const wrap = $("qWrap");
    wrap.innerHTML = "";

    CURRENT.questions.forEach((item, idx)=>{
      const box = document.createElement("div");
      box.className = "rounded-2xl border border-slate-200 bg-white/70 p-4";

      const isFirst = idx===0;

      box.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="font-extrabold text-slate-900">第 ${idx+1} 題 ${isFirst ? "（可多選項）" : "（4 選項）"}</div>
          <div class="flex gap-2">
            <button class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-sm font-semibold" data-act="up">上移</button>
            <button class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-sm font-semibold" data-act="down">下移</button>
            <button class="px-3 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm font-semibold" data-act="del">刪除</button>
          </div>
        </div>

        <label class="text-sm font-semibold text-slate-700 mt-3 block">題目</label>
        <input class="mt-1 w-full px-4 py-2 rounded-xl border border-slate-200" data-k="q" placeholder="請輸入題目" />

        <div class="mt-3 flex items-center justify-between">
          <div class="text-xs text-slate-500">${isFirst ? "" : ""}</div>
          ${isFirst ? `<button class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-sm font-semibold" data-act="addopt">+ 加選項</button>` : ``}
        </div>

        <div class="mt-3 grid md:grid-cols-2 gap-2" data-optwrap></div>
      `;

      box.querySelector('[data-k="q"]').value = item.q || "";
      box.querySelector('[data-k="q"]').oninput = (e)=>{ item.q = e.target.value; };

      const optWrap = box.querySelector("[data-optwrap]");
      const a = item.a || [];

      if(isFirst){
        while(a.length<4) a.push("");
        item.a = a;
      }else{
        while(a.length<4) a.push("");
        item.a = a.slice(0,4);
      }

      const drawOptions = ()=>{
        optWrap.innerHTML = "";
        const list = item.a || [];
        const n = isFirst ? list.length : 4;
        for(let i=0;i<n;i++){
          const div = document.createElement("div");
          div.innerHTML = `
            <label class="text-xs font-bold text-slate-500">選項 ${i+1}</label>
            <div class="mt-1 flex gap-2">
              <input class="flex-1 w-full px-4 py-2 rounded-xl border border-slate-200" placeholder="請輸入選項" />
              ${isFirst && i>=4 ? `<button class="px-3 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm font-semibold">刪</button>` : ``}
            </div>
          `;
          const inp = div.querySelector("input");
          inp.value = list[i] || "";
          inp.oninput = (e)=>{ item.a[i] = e.target.value; };

          const delBtn = div.querySelector("button");
          if(delBtn){
            delBtn.onclick = ()=>{
              item.a.splice(i, 1);
              drawOptions();
            };
          }
          optWrap.appendChild(div);
        }
      };
      drawOptions();

      box.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.onclick = ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="del"){
            CURRENT.questions.splice(idx,1);
          }else if(act==="up" && idx>0){
            const t = CURRENT.questions[idx-1]; CURRENT.questions[idx-1]=CURRENT.questions[idx]; CURRENT.questions[idx]=t;
          }else if(act==="down" && idx<CURRENT.questions.length-1){
            const t = CURRENT.questions[idx+1]; CURRENT.questions[idx+1]=CURRENT.questions[idx]; CURRENT.questions[idx]=t;
          }else if(act==="addopt" && idx===0){
            CURRENT.questions[0].a.push("");
          }
          renderQuestions();
        };
      });

      wrap.appendChild(box);
    });

    if(CURRENT.questions.length===0){
      const empty = document.createElement("div");
      empty.className = "rounded-2xl border border-dashed border-slate-300 bg-white/60 p-6 text-slate-600";
      empty.textContent = "目前沒有題目。按上方「新增題目」。";
      wrap.appendChild(empty);
    }
  }

  function validateSurvey(){
    const name = ($("inName").value||"").trim();
    const title = ($("inTitle").value||"").trim();
    const kw = normKw($("inKeyword").value);

    if(!name) throw new Error("請先填『問卷檔名』");
    if(!title) throw new Error("請先填『問卷標題』");
    if(!kw) throw new Error("請先填『關鍵字』");
    if(CURRENT.questions.length<1) throw new Error("至少要有 1 題");

    // 關鍵字不可被其他問卷使用
    const owner = keywordOwner(kw);
    if(owner && owner !== name) throw new Error("關鍵字已被其他問卷使用");

    CURRENT.questions.forEach((q,i)=>{
      if(!(q.q||"").trim()) throw new Error(`第 ${i+1} 題題目是空的`);
      const need = (i===0) ? Math.max(4, (q.a||[]).length) : 4;
      for(let k=0;k<need;k++){
        const v = (q.a && q.a[k]) ? String(q.a[k]).trim() : "";
        if(!v) throw new Error(`第 ${i+1} 題的選項 ${k+1} 是空的`);
      }
    });

    return { name, title, kw };
  }

  async function saveSurvey(){
    const { name, title, kw } = validateSurvey();

    // 1) 先存問卷本體
    CURRENT.name = name;
    CURRENT.title = title;
    CURRENT.keyword = kw;
    CURRENT.reportHint = ($("inReportHint").value||"").trim();

    CURRENT.questions = CURRENT.questions.map((q, idx)=>{
      if(idx===0){
        const a = (q.a||[]);
        while(a.length<4) a.push("");
        return { q:q.q, a:a };
      }
      const a = (q.a||[]);
      while(a.length<4) a.push("");
      return { q:q.q, a:a.slice(0,4) };
    });

    await api("/putAny", {
      namespace: "DB",
      keyword: Q_PREFIX + CURRENT.name,
      payload: CURRENT
    });

    // 2) 同步關鍵字表：把「指向這份問卷的舊關鍵字」清掉，再寫入新的
    // （這樣你改關鍵字也會自動更新，不需要你手動）
    await refreshKwMap().catch(()=>{});
    for(const k of Object.keys(KW_MAP)){
      if(KW_MAP[k] === CURRENT.name && k !== kw){
        delete KW_MAP[k];
      }
    }
    KW_MAP[kw] = CURRENT.name;
    await saveKwMap();

    toast("已儲存（含關鍵字綁定）");
    $("txtLastSync").textContent = new Date().toLocaleString();

    await refreshSurveyList();
    await refreshKwMap().catch(()=>{});
    updateKwHint();
    updateClientBtn();
  }

  // ========= Preview =========
  function startPreview(){
    const title = ($("inTitle").value||CURRENT.title||"").trim() || "（未命名問卷）";
    $("pvTitle").textContent = title;
    PREVIEW = { idx: 0, answers: [] };
    $("pvReportBox").classList.add("hidden");
    renderPreviewStep();
    setTab("preview");
  }

  function renderPreviewStep(){
    const qList = CURRENT.questions || [];
    const idx = PREVIEW.idx;

    $("pvStep").textContent = `進度：${Math.min(idx+1, qList.length)}/${qList.length}`;

    if(idx >= qList.length){
      $("pvQuestion").textContent = "完成！以下是報告預覽";
      $("pvOptions").innerHTML = "";

      const report = buildReportPreview();
      $("pvReport").textContent = report;
      $("pvReportBox").classList.remove("hidden");
      renderPreviewAnswers();
      return;
    }

    const q = qList[idx];
    $("pvQuestion").textContent = q.q || "-";
    const optWrap = $("pvOptions");
    optWrap.innerHTML = "";

    const opts = (q.a||[]).map(x=>String(x||"").trim()).filter(Boolean);
    opts.forEach((txt)=>{
      const b = document.createElement("button");
      b.className = "px-4 py-3 rounded-xl bg-white text-slate-900 hover:bg-slate-50 border border-slate-200 text-left font-semibold";
      b.textContent = txt;
      b.onclick = ()=>{
        PREVIEW.answers.push({ q: q.q, a: txt, idx: PREVIEW.idx });
        PREVIEW.idx++;
        renderPreviewStep();
      };
      optWrap.appendChild(b);
    });

    renderPreviewAnswers();
  }

  function renderPreviewAnswers(){
    const wrap = $("pvAnswers");
    wrap.innerHTML = "";
    if(PREVIEW.answers.length===0){
      wrap.innerHTML = `<div class="text-slate-500">尚未作答</div>`;
      return;
    }
    PREVIEW.answers.forEach(x=>{
      const d = document.createElement("div");
      d.className = "rounded-xl border border-slate-200 bg-white/70 px-3 py-2";
      d.innerHTML = `<div class="text-xs text-slate-500">${escapeHtml(x.q)}</div>
                     <div class="font-semibold text-slate-900">${escapeHtml(x.a)}</div>`;
      wrap.appendChild(d);
    });
  }

  function buildReportPreview(){
    const hint = ($("inReportHint").value||CURRENT.reportHint||"").trim();
    const bullets = PREVIEW.answers.map(x=>`- ${x.q}：${x.a}`).join("\n");
    return `【你填的答案】\n${bullets}\n\n【整理方向】\n${hint || "（尚未填報告模板）"}\n\n【下一步】\n回我「報告」我幫你整理成更清楚的版本。`;
  }

  // ========= Leads =========
  async function refreshLeads(){
    const data = await api("/listAll", {});
    const db = data.db || [];
    const keys = db.filter(k=>k.startsWith(LEAD_PREFIX)).sort((a,b)=>b.localeCompare(a));
    $("txtLeadCount").textContent = String(keys.length);

    const top = keys.slice(0, 30);
    const rows = await Promise.all(top.map(k =>
      api("/loadAny", { namespace:"DB", keyword:k })
        .then(r=>r.payload||r)
        .catch(()=>null)
    ));
    LEADS = rows.filter(Boolean);
    renderLeads();
  }

  function renderLeads(){
    const q = ($("leadSearch").value||"").trim().toLowerCase();
    const items = LEADS.filter(x=> !q || JSON.stringify(x).toLowerCase().includes(q));

    const wrap = $("leadList");
    wrap.innerHTML = "";

    if(items.length===0){
      const d = document.createElement("div");
      d.className = "rounded-2xl border border-dashed border-slate-300 bg-white/60 p-6 text-slate-600";
      d.textContent = "目前沒有 Leads。";
      wrap.appendChild(d);
      return;
    }

    items.forEach(x=>{
      const when = x.created_at ? new Date(x.created_at).toLocaleString() : (x.createdAt ? new Date(x.createdAt).toLocaleString() : "-");
      const name = x.displayName || x.display_name || "-";
      const pic = x.pictureUrl || x.picture_url || "";
      const uid = x.userId || x.user_id || "-";
      const survey = x.surveyName || x.survey_name || "-";
      const report = x.report || x.summary || x.result || "";

      const card = document.createElement("div");
      card.className = "rounded-2xl border border-slate-200 bg-white/70 p-4";
      card.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="w-12 h-12 rounded-2xl bg-slate-100 overflow-hidden border border-slate-200 shrink-0">
            ${pic ? `<img src="${escapeHtml(pic)}" class="w-full h-full object-cover">` : ``}
          </div>
          <div class="flex-1">
            <div class="flex flex-wrap items-center gap-2">
              <div class="font-extrabold text-slate-900">${escapeHtml(name)}</div>
              <div class="text-xs text-slate-500">${escapeHtml(when)}</div>
              <span class="text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100 font-semibold">
                ${escapeHtml(survey)}
              </span>
            </div>
            <div class="mt-1 text-xs text-slate-500 mono break-all">userId: ${escapeHtml(uid)}</div>

            <div class="mt-3 rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 whitespace-pre-line">
              ${escapeHtml(report || "（沒有報告內容）")}
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(card);
    });
  }

  // ========= Client URL =========
  function buildClientUrl(){
    const liffId = ($("inLiffId").value || localStorage.getItem("line_liff_id") || "").trim();
    const name = ($("inName").value||CURRENT.name||"").trim();
    if(!liffId || !name) return "";
    return `https://liff.line.me/${encodeURIComponent(liffId)}?page=liff_survey.html&survey=${encodeURIComponent(name)}`;
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand("copy");
      ta.remove();
      return ok;
    }
  }

  function updateClientBtn(){
    const liffId = ($("inLiffId").value || localStorage.getItem("line_liff_id") || "").trim();
    $("inLiffId").value = liffId;

    const url = buildClientUrl();
    $("inClientUrl").value = url || "";

    const btn = $("btnOpenClient");
    if(!url){
      btn.classList.add("hidden");
      return;
    }
    btn.classList.remove("hidden");
    btn.onclick = ()=> window.open(url, "_blank");
  }

  // ========= Bulk Import =========
  function openBulk(){ $("bulkModal").classList.remove("hidden"); }
  function closeBulk(){ $("bulkModal").classList.add("hidden"); }

  function parseBulk(text){
    const lines = (text||"").replace(/\r/g,"").split("\n");
    const out = { name:"", title:"", keyword:"", reportHint:"", questions:[] };

    let i=0;
    for(; i<lines.length; i++){
      const line = (lines[i]||"").trim();
      if(!line) continue;

      if(/^NAME\s*:/i.test(line)){ out.name = line.split(":").slice(1).join(":").trim(); continue; }
      if(/^TITLE\s*:/i.test(line)){ out.title = line.split(":").slice(1).join(":").trim(); continue; }
      if(/^KEYWORD\s*:/i.test(line)){ out.keyword = line.split(":").slice(1).join(":").trim(); continue; }

      if(/^REPORT\s*:/i.test(line)){
        i++;
        const buf = [];
        for(; i<lines.length; i++){
          const l = lines[i];
          if((l||"").trim()==="ENDREPORT") break;
          buf.push(l);
        }
        out.reportHint = buf.join("\n").trim();
        continue;
      }
      if(/^Q\s*:/i.test(line) || /^第\s*\d+\s*題[:：]/.test(line)) break;
    }

    let cur = null;
    for(; i<lines.length; i++){
      const raw = lines[i] ?? "";
      const line = raw.trim();
      if(!line) continue;

      const isQ = /^Q\s*:/i.test(line) || /^第\s*\d+\s*題[:：]/.test(line);
      if(isQ){
        if(cur) out.questions.push(cur);
        const qText = line.replace(/^Q\s*:/i,"").replace(/^第\s*\d+\s*題[:：]/,"").trim();
        cur = { q: qText, a: [] };
        continue;
      }

      const m1 = line.match(/^\-\s*(.+)$/);
      const m2 = line.match(/^\d+\s*[\)\.、]\s*(.+)$/);
      const opt = (m1 ? m1[1] : (m2 ? m2[1] : ""));
      if(opt && cur){
        cur.a.push(opt.trim());
      }
    }
    if(cur) out.questions.push(cur);

    if(out.questions.length===0) throw new Error("沒有讀到題目（請確認有 Q: 開頭）");

    out.questions = out.questions.map((q, idx)=>{
      const a = (q.a||[]).map(x=>String(x||"").trim()).filter(Boolean);
      if(idx===0){
        while(a.length<4) a.push("");
        return { q: q.q || "", a };
      }else{
        while(a.length<4) a.push("");
        return { q: q.q || "", a: a.slice(0,4) };
      }
    });
    return out;
  }

  function applyBulkToCurrent(parsed){
    CURRENT = makeEmptySurvey();
    CURRENT.name = parsed.name || "";
    CURRENT.title = parsed.title || "";
    CURRENT.keyword = parsed.keyword || "";
    CURRENT.reportHint = parsed.reportHint || "";
    CURRENT.questions = parsed.questions || [];
    fillBuilder();
  }

  // ========= Init =========
  function initApiBase(){
    const fromHome = (localStorage.getItem("line_worker_url") || "").trim();
    const fromSelf = (localStorage.getItem("questionnaire_worker_url") || "").trim();
    const v = fromHome || fromSelf;
    if(v){
      API_BASE = v;
      $("inApiBase").value = v;
    }
    const liff = (localStorage.getItem("line_liff_id") || "").trim();
    if(liff) $("inLiffId").value = liff;
  }

  function setApiBaseFromInput(){
    const v = ($("inApiBase").value || "").trim();
    if(!v) throw new Error("請輸入 Worker 網址");
    API_BASE = v;
    localStorage.setItem("questionnaire_worker_url", v);
    localStorage.setItem("line_worker_url", v);
  }

  function bindInputs(){
    $("inName").oninput = ()=>{ updateClientBtn(); updateKwHint(); };
    $("inTitle").oninput = ()=>{};
    $("inReportHint").oninput = ()=>{};

    $("inKeyword").oninput = ()=> updateKwHint();

    $("inLiffId").oninput = (e)=>{
      localStorage.setItem("line_liff_id", (e.target.value||"").trim());
      updateClientBtn();
    };

    $("qSearch").oninput = ()=> renderSurveyList();
    $("leadSearch").oninput = ()=> renderLeads();

    $("btnTabBuilder").onclick = ()=> setTab("builder");
    $("btnTabPreview").onclick = ()=> startPreview();
    $("btnTabLeads").onclick = async ()=>{ setTab("leads"); await refreshLeads().catch(()=>{}); };

    $("btnNew").onclick = ()=>{
      CURRENT = makeEmptySurvey();
      fillBuilder();
      toast("已建立新問卷（尚未儲存）");
      setTab("builder");
    };

    $("btnAddQ").onclick = ()=>{
      CURRENT.questions.push({ q:"", a:["","","",""] });
      renderQuestions();
    };

    $("btnPreviewRestart").onclick = ()=> startPreview();
    $("btnPreviewToLeads").onclick = async ()=>{ setTab("leads"); await refreshLeads().catch(()=>{}); };

    $("btnLeadsReload").onclick = async ()=>{ await refreshLeads().catch(e=>toast(e.message,"err")); };

    $("btnConnect").onclick = async ()=>{
      try{
        setApiBaseFromInput();
        $("txtStatus").textContent = "已連線";
        $("txtStatus").className = "font-semibold text-emerald-700";
        $("txtLastSync").textContent = new Date().toLocaleString();

        await refreshKwMap().catch(()=>{});
        await refreshSurveyList();
        await refreshLeads().catch(()=>{});
        updateClientBtn();
        updateKwHint();
        toast("連線成功");
      }catch(e){
        $("txtStatus").textContent = "連線失敗";
        $("txtStatus").className = "font-semibold text-rose-700";
        toast(e.message, "err");
      }
    };

    $("btnSave").onclick = async ()=>{
      try{
        setApiBaseFromInput();
        // 先拿最新 KW_MAP，避免你開兩個視窗時衝突
        await refreshKwMap().catch(()=>{});
        await saveSurvey();
      }catch(e){
        toast(e.message,"err");
      }
    };

    // copy link buttons
    const doCopy = async ()=>{
      const url = buildClientUrl();
      if(!url) return toast("請先填 LIFF ID + 問卷檔名", "warn");
      const ok = await copyText(url);
      toast(ok ? "已複製" : "複製失敗", ok ? "ok" : "err");
    };
    $("btnCopyLink").onclick = doCopy;
    $("btnCopyLinkTop").onclick = doCopy;

    // bulk
    $("btnBulk").onclick = openBulk;
    $("btnBulkClose").onclick = closeBulk;
    $("bulkModal").addEventListener("click", (e)=>{ if(e.target === $("bulkModal")) closeBulk(); });

    $("btnBulkExample").onclick = ()=>{
      $("bulkText").value = `NAME: 健康問卷_第一版
TITLE: 三分鐘了解你目前最想改善的方向
KEYWORD: 健康問卷
REPORT:
我會用你的選擇整理成「一個優先方向＋兩個加分方向」。
我會給你 3 個今天就能做的調整重點。
如果你願意，回我「報告」，我幫你整理成更清楚的版本。
ENDREPORT

Q: 你現在最想先改善哪一塊？
- 睡眠
- 壓力
- 精神
- 腸胃
- 體態
- 運動
- 免疫
- 皮膚

Q: 你最近睡得怎麼樣？
- 一覺到天亮
- 會醒幾次
- 很難入睡
- 醒來還是累

Q: 你白天狀態比較像？
- 精神穩定
- 下午下滑
- 注意力差
- 常想躺

Q: 你飲食習慣較像？
- 三餐固定
- 常外食
- 常跳餐
- 愛吃甜/炸`;
      toast("已塞入範例");
    };

    $("btnBulkApply").onclick = ()=>{
      try{
        const parsed = parseBulk($("bulkText").value || "");
        applyBulkToCurrent(parsed);
        closeBulk();
        toast("已套用（記得按儲存）");
      }catch(e){
        toast(e.message, "err");
      }
    };
  }

  (function init(){
    initApiBase();
    bindInputs();
    fillBuilder();
    setTab("builder");
    updateClientBtn();
  })();
</script>
</body>
</html>
