<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>關鍵字自動回覆後台</title>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont; background:#f5f7fb; padding:40px; }
    h1 { margin-bottom: 14px; }
    .box { background:white; padding:20px; border-radius:12px; max-width:720px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea, select, button {
      width:100%; margin-top:8px; padding:10px; font-size:16px; box-sizing:border-box;
    }
    textarea { min-height:120px; }
    button { background:#4f46e5; color:white; border:none; border-radius:10px; cursor:pointer; margin-top:14px; }
    .hint { font-size:13px; opacity:.75; margin-top:6px; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
  </style>
</head>
<body>
  <h1>關鍵字自動回覆後台</h1>

  <div class="box">
    <label>關鍵字</label>
    <input id="keyword" placeholder="例如：菜單" />

    <div class="row">
      <div>
        <label>回覆類型</label>
        <select id="type">
          <option value="text">文字</option>
          <option value="image">圖片（網址）</option>
          <option value="video">影片（網址）</option>
          <option value="audio">錄音（網址）</option>
          <option value="link">連結（網址＋標題）</option>
        </select>
      </div>
      <div>
        <label>連結標題（只給「連結」用）</label>
        <input id="linkTitle" placeholder="例如：點我領取" />
      </div>
    </div>

    <label id="valueLabel">回覆內容（文字）</label>
    <textarea id="value" placeholder="輸入要回覆的文字"></textarea>
    <div class="hint" id="hint"></div>

    <button id="saveBtn">儲存</button>
  </div>

  <script>
    const API_BASE = "https://api.zxcv8096.workers.dev";

    const keywordEl = document.getElementById("keyword");
    const typeEl = document.getElementById("type");
    const linkTitleEl = document.getElementById("linkTitle");
    const valueLabelEl = document.getElementById("valueLabel");
    const valueEl = document.getElementById("value");
    const hintEl = document.getElementById("hint");
    const saveBtn = document.getElementById("saveBtn");

    function refreshUI() {
      const t = typeEl.value;

      linkTitleEl.disabled = (t !== "link");
      if (t === "text") {
        valueLabelEl.textContent = "回覆內容（文字）";
        valueEl.placeholder = "輸入要回覆的文字";
        hintEl.textContent = "";
      } else if (t === "link") {
        valueLabelEl.textContent = "連結網址";
        valueEl.placeholder = "https://...";
        hintEl.textContent = "連結要填：網址；標題填上面那格";
      } else {
        valueLabelEl.textContent = "檔案網址";
        valueEl.placeholder = "https://... (圖片/影片/音檔網址)";
        hintEl.textContent = "請貼可公開存取的檔案網址";
      }
    }
    typeEl.addEventListener("change", refreshUI);
    refreshUI();

    saveBtn.addEventListener("click", async () => {
      const keyword = keywordEl.value.trim();
      const type = typeEl.value;
      const v = valueEl.value.trim();
      const linkTitle = linkTitleEl.value.trim();

      if (!keyword) return alert("請輸入關鍵字");
      if (!v) return alert("請輸入回覆內容/網址");
      if (type === "link" && !linkTitle) return alert("連結類型請填連結標題");

      const data =
        type === "text" ? { type:"text", text: v } :
        type === "image" ? { type:"image", url: v } :
        type === "video" ? { type:"video", url: v } :
        type === "audio" ? { type:"audio", url: v } :
        { type:"link", url: v, title: linkTitle };

      const res = await fetch(API_BASE + "/save", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ keyword, reply: JSON.stringify(data) })
      });

      const t = await res.text();
      if (!res.ok) return alert("儲存失敗：" + t);

      alert("儲存成功");
      valueEl.value = "";
    });

    // 輸入關鍵字按 Enter：自動讀出目前設定
    keywordEl.addEventListener("keydown", async (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();

      const keyword = keywordEl.value.trim();
      if (!keyword) return;

      const res = await fetch(API_BASE + "/reply?keyword=" + encodeURIComponent(keyword));
      const j = await res.json();
      const data = j?.data;
      if (!data) return alert("找不到此關鍵字");

      if (data.type === "text") {
        typeEl.value = "text";
        valueEl.value = data.text || "";
      } else if (data.type === "link") {
        typeEl.value = "link";
        valueEl.value = data.url || "";
        linkTitleEl.value = data.title || "";
      } else {
        typeEl.value = data.type;
        valueEl.value = data.url || "";
      }
      refreshUI();
    });
  </script>
</body>
</html>
