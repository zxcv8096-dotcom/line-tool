<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´…è‰²æ¡†æ¡†æŒ‰éˆ•è¨­å®š</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4 text-slate-800">

    <div class="bg-white w-full max-w-lg rounded-xl shadow-lg overflow-hidden">
        <div class="bg-red-600 p-4 text-white flex justify-between items-center">
            <h1 class="font-bold text-lg flex items-center gap-2"><a href="index.html" class="opacity-80 hover:opacity-100">ğŸ”™</a> ç´…è‰²æ¡†æ¡†è¨­å®šå™¨</h1>
        </div>

        <div class="p-6 space-y-6">
            <div class="bg-slate-100 p-4 rounded-lg">
                <label class="block text-xs font-bold text-slate-500 mb-1">Worker ç¶²å€</label>
                <input type="text" id="workerUrl" class="w-full border p-2 rounded text-sm bg-white text-gray-600" readonly>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">æœ¬é¸å–®çš„è§¸ç™¼é—œéµå­—</label>
                    <div class="flex gap-2">
                        <input type="text" id="keyword" placeholder="ä¾‹å¦‚ï¼šé¸å–®" class="flex-1 border-2 border-red-200 rounded p-2 focus:border-red-500 outline-none font-bold">
                        <button onclick="loadData()" class="bg-gray-600 text-white px-4 rounded text-sm font-bold hover:bg-gray-700">è®€å–</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">æ©Ÿå™¨äººå›è¦†æ–‡å­—</label>
                    <textarea id="replyText" rows="2" class="w-full border rounded p-2 text-sm" placeholder="ä¾‹å¦‚ï¼šè«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™..."></textarea>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold text-red-600">ğŸ”´ ç´…è‰²æ¡†æ¡†æŒ‰éˆ•åˆ—è¡¨</label>
                        <button onclick="addBtn()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 font-bold">+ æ–°å¢æŒ‰éˆ•</button>
                    </div>
                    <div class="flex items-center gap-2 bg-yellow-50 p-2 rounded text-xs mb-2">
                        <span>ğŸ“‹ å¿«é€Ÿé¸æ“‡ç›®æ¨™:</span>
                        <select id="targetSelect" class="border rounded p-1 flex-1" onchange="applyTarget()">
                            <option value="">(è¼‰å…¥ä¸­...è«‹ç¨å€™)</option>
                        </select>
                        <button onclick="loadKeys()" class="text-blue-500 underline">é‡æ–°æ•´ç†</button>
                    </div>

                    <div id="btnList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>

            <button onclick="saveData()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-md transition transform active:scale-95">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <script>
        let availableKeys = [];

        window.onload = function() {
            const savedUrl = localStorage.getItem('line_worker_url');
            if(savedUrl) { document.getElementById('workerUrl').value = savedUrl; loadKeys(); }
            else alert("è«‹å…ˆå›é¦–é  (index.html) è¼¸å…¥ Worker ç¶²å€ï¼");
            addBtn(); 
        }

        // â˜… æ–°åŠŸèƒ½ï¼šå¾ Worker æŠ“å–æ‰€æœ‰é—œéµå­— â˜…
        async function loadKeys() {
            const url = document.getElementById('workerUrl').value;
            const sel = document.getElementById('targetSelect');
            sel.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
            try {
                const res = await fetch(url + '/list', { method: 'POST' }); // å‘¼å« Worker æ–°å¢çš„ /list
                if(res.ok) {
                    availableKeys = await res.json();
                    renderSelectOptions();
                } else { sel.innerHTML = '<option>è®€å–å¤±æ•—</option>'; }
            } catch(e) { sel.innerHTML = '<option>é€£ç·šéŒ¯èª¤</option>'; }
        }

        function renderSelectOptions() {
            const sel = document.getElementById('targetSelect');
            sel.innerHTML = '<option value="">â–¼ é¸æ“‡è¦å½ˆå‡ºçš„å¼•æµåœ–/å¡ç‰‡...</option>';
            availableKeys.forEach(k => {
                sel.innerHTML += `<option value="${k}">${k}</option>`;
            });
        }

        // ç•¶ä½¿ç”¨è€…é¸äº†ä¸€å€‹ç›®æ¨™ï¼Œè‡ªå‹•å¡«å…¥æœ€å¾Œä¸€å€‹æŒ‰éˆ•çš„ã€Œç™¼é€ã€æ¬„ä½
        function applyTarget() {
            const val = document.getElementById('targetSelect').value;
            if(!val) return;
            // æ‰¾åˆ°æœ€å¾Œä¸€å€‹æŒ‰éˆ•çš„ input
            const inputs = document.querySelectorAll('.btn-text');
            if(inputs.length > 0) {
                inputs[inputs.length - 1].value = val;
                // è‡ªå‹•å¹«ä»–å¡«é¡¯ç¤ºæ–‡å­— (å¦‚æœåŸæœ¬æ˜¯ç©ºçš„)
                const labelInput = inputs[inputs.length - 1].previousElementSibling.querySelector('input'); 
                if(!labelInput.value) labelInput.value = val;
            }
        }

        function addBtn(label='', text='') {
            const list = document.getElementById('btnList');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200";
            div.innerHTML = `
                <div class="flex-1 space-y-1">
                    <div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-500 w-12">æŒ‰éˆ•å:</span><input type="text" placeholder="é¡¯ç¤ºæ–‡å­—" value="${label}" class="btn-label flex-1 border rounded px-2 py-1 text-sm focus:border-red-400 outline-none"></div>
                    <div class="flex items-center gap-2"><span class="text-xs font-bold text-red-500 w-12">è§¸ç™¼:</span><input type="text" placeholder="ç™¼é€å…§å®¹" value="${text}" class="btn-text flex-1 border rounded px-2 py-1 text-sm focus:border-red-400 outline-none bg-red-50"></div>
                </div>
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 px-2 font-bold text-lg">âœ•</button>
            `;
            list.appendChild(div);
        }

        async function saveData() {
            const url = document.getElementById('workerUrl').value; const key = document.getElementById('keyword').value; const text = document.getElementById('replyText').value;
            if(!url || !key) return alert("è³‡æ–™ä¸å®Œæ•´");
            const btns = [];
            document.querySelectorAll('#btnList > div').forEach(div => {
                const l = div.querySelector('.btn-label').value; const t = div.querySelector('.btn-text').value;
                if(l && t) btns.push({ label: l, text: t });
            });
            const payload = { mode: 'text', replyText: text, quickReplies: btns };
            try {
                const res = await fetch(url + '/save', { method: 'POST', body: JSON.stringify({ password: '1234', keyword: key, payload: payload }) });
                if(res.ok) alert('å„²å­˜æˆåŠŸï¼'); else alert('å„²å­˜å¤±æ•—');
            } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
        }

        async function loadData() {
            const url = document.getElementById('workerUrl').value; const key = document.getElementById('keyword').value;
            if(!url || !key) return alert("è«‹è¼¸å…¥é—œéµå­—");
            try {
                const res = await fetch(url + '/load', { method: 'POST', body: JSON.stringify({ password: '1234', keyword: key }) });
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('replyText').value = data.replyText || '';
                    document.getElementById('btnList').innerHTML = '';
                    if(data.quickReplies) data.quickReplies.forEach(b => addBtn(b.label, b.text));
                    alert('è®€å–æˆåŠŸ');
                } else alert('æ‰¾ä¸åˆ°æ­¤é—œéµå­—');
            } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
        }
    </script>
</body>
</html>
