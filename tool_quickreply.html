<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´…è‰²æ¡†æ¡†æŒ‰éˆ•è¨­å®š</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4 text-slate-800">

    <div class="bg-white w-full max-w-lg rounded-xl shadow-lg overflow-hidden">
        <div class="bg-red-600 p-4 text-white flex justify-between items-center">
            <h1 class="font-bold text-lg flex items-center gap-2">
                <a href="index.html" class="opacity-80 hover:opacity-100">ğŸ”™</a> 
                ç´…è‰²æ¡†æ¡†è¨­å®šå™¨
            </h1>
            <div class="text-xs opacity-80">ç¨ç«‹åŠŸèƒ½ç‰ˆ</div>
        </div>

        <div class="p-6 space-y-6">
            
            <div class="bg-slate-100 p-4 rounded-lg">
                <label class="block text-xs font-bold text-slate-500 mb-1">Worker ç¶²å€</label>
                <input type="text" id="workerUrl" class="w-full border p-2 rounded text-sm bg-white text-gray-600" placeholder="https://api..." readonly>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">æœ¬é¸å–®çš„è§¸ç™¼é—œéµå­—</label>
                    <div class="flex gap-2">
                        <input type="text" id="keyword" placeholder="ä¾‹å¦‚ï¼šé¸å–®" class="flex-1 border-2 border-red-200 rounded p-2 focus:border-red-500 outline-none font-bold">
                        <button onclick="loadData()" class="bg-gray-600 text-white px-4 rounded text-sm font-bold hover:bg-gray-700">è®€å–</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">æ©Ÿå™¨äººå›è¦†æ–‡å­—</label>
                    <textarea id="replyText" rows="2" class="w-full border rounded p-2 text-sm" placeholder="ä¾‹å¦‚ï¼šè«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™..."></textarea>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold text-red-600">ğŸ”´ ç´…è‰²æ¡†æ¡†æŒ‰éˆ•åˆ—è¡¨</label>
                        <button onclick="addBtn()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 font-bold">+ æ–°å¢æŒ‰éˆ•</button>
                    </div>
                    <div class="text-[10px] text-gray-400 mb-2">
                        ğŸ’¡ æç¤ºï¼šåœ¨ã€Œç™¼é€å…§å®¹ã€å¡«å…¥å¼•æµåœ–çš„é—œéµå­—ï¼ŒæŒ‰éˆ•å°±æœƒå½ˆå‡ºé‚£å¼µåœ–ã€‚
                    </div>
                    <div id="btnList" class="space-y-2 max-h-60 overflow-y-auto">
                        </div>
                </div>
            </div>

            <button onclick="saveData()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-md transition transform active:scale-95">
                ğŸ’¾ å„²å­˜è¨­å®š
            </button>

        </div>
    </div>

    <script>
        // è‡ªå‹•è®€å–é¦–é å­˜çš„ç¶²å€
        window.onload = function() {
            const savedUrl = localStorage.getItem('line_worker_url');
            if(savedUrl) {
                document.getElementById('workerUrl').value = savedUrl;
            } else {
                alert("è«‹å…ˆå›é¦–é  (index.html) è¼¸å…¥ Worker ç¶²å€ï¼");
            }
            addBtn(); 
        }

        function addBtn(label='', text='') {
            const list = document.getElementById('btnList');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200";
            div.innerHTML = `
                <div class="flex-1 space-y-1">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-500 w-12">æŒ‰éˆ•å:</span>
                        <input type="text" placeholder="é¡¯ç¤ºæ–‡å­— (å¦‚: ç”¢å“ä»‹ç´¹)" value="${label}" class="btn-label flex-1 border rounded px-2 py-1 text-sm focus:border-red-400 outline-none">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-red-500 w-12">è§¸ç™¼:</span>
                        <input type="text" placeholder="å°æ‡‰çš„é—œéµå­— (å¦‚: product_map)" value="${text}" class="btn-text flex-1 border rounded px-2 py-1 text-sm focus:border-red-400 outline-none bg-red-50">
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 px-2 font-bold text-lg">âœ•</button>
            `;
            list.appendChild(div);
        }

        async function saveData() {
            const url = document.getElementById('workerUrl').value;
            const key = document.getElementById('keyword').value;
            const text = document.getElementById('replyText').value;
            
            if(!url || !key) return alert("è³‡æ–™ä¸å®Œæ•´");

            const btns = [];
            document.querySelectorAll('#btnList > div').forEach(div => {
                const l = div.querySelector('.btn-label').value;
                const t = div.querySelector('.btn-text').value;
                if(l && t) btns.push({ label: l, text: t });
            });

            const payload = {
                mode: 'text', 
                replyText: text,
                quickReplies: btns
            };

            try {
                const res = await fetch(url + '/save', {
                    method: 'POST',
                    body: JSON.stringify({ password: '1234', keyword: key, payload: payload })
                });
                if(res.ok) alert('å„²å­˜æˆåŠŸï¼'); else alert('å„²å­˜å¤±æ•—');
            } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
        }

        async function loadData() {
            const url = document.getElementById('workerUrl').value;
            const key = document.getElementById('keyword').value;
            if(!url || !key) return alert("è«‹è¼¸å…¥é—œéµå­—");

            try {
                const res = await fetch(url + '/load', {
                    method: 'POST',
                    body: JSON.stringify({ password: '1234', keyword: key })
                });
                if(res.ok) {
                    const data = await res.json(); 
                    document.getElementById('replyText').value = data.replyText || '';
                    const list = document.getElementById('btnList');
                    list.innerHTML = '';
                    if(data.quickReplies) {
                        data.quickReplies.forEach(b => addBtn(b.label, b.text));
                    }
                    alert('è®€å–æˆåŠŸ');
                } else {
                    alert('æ‰¾ä¸åˆ°æ­¤é—œéµå­—è³‡æ–™');
                }
            } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
        }
    </script>
</body>
</html>
