<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è³‡æ–™æ¨™è¨˜å™¨ï¼ˆåŠŸèƒ½/ç‹€æ…‹/å‚™è¨»ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; }
    .card { background: white; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .btn { font-weight: 900; border-radius: 14px; padding: 10px 14px; }
    .btnDark { background:#0f172a; color:#fff; }
    .btnDark:hover { background:#000; }
    .btnGreen { background:#059669; color:#fff; }
    .btnGreen:hover { background:#047857; }
    .btnBlue { background:#2563eb; color:#fff; }
    .btnBlue:hover { background:#1d4ed8; }
    .btnGhost { background:#fff; border:1px solid #e2e8f0; }
    .btnGhost:hover { background:#f1f5f9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge { font-size: 11px; padding: 3px 10px; border-radius: 999px; border: 1px solid; font-weight: 900; }
    .badge-db { background:#eff6ff; color:#1d4ed8; border-color:#dbeafe; }
    .badge-replies { background:#fffbeb; color:#b45309; border-color:#fef3c7; }
    .chip { font-size: 12px; padding: 2px 10px; border-radius: 999px; background:#f1f5f9; border:1px solid #e2e8f0; }
    .danger { color:#be123c; }
  </style>
</head>

<body class="min-h-screen p-4 text-slate-800">
  <div class="max-w-5xl mx-auto space-y-4">

    <div class="card p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-5xl">ğŸ·ï¸</div>
          <h1 class="text-2xl font-extrabold mt-2">è³‡æ–™æ¨™è¨˜å™¨ï¼ˆåŠŸèƒ½ / ç‹€æ…‹ / å‚™è¨»ï¼‰</h1>
          <p class="text-sm text-slate-500 mt-1">
            ç”¨ä¾†æŠŠèˆŠè³‡æ–™å¾ unknown è®Šæˆå¯ç¯©é¸ï¼ˆquickreply / imagemap / carousel / flow...ï¼‰ï¼Œä¸¦æ”¯æ´ DB / REPLIES å¯«å›ã€‚
          </p>
        </div>
        <div class="text-right flex gap-2">
          <a href="index.html" class="btn btnDark inline-block">å›é¦–é </a>
          <a href="lab_dashboard.html" class="btn btnGhost inline-block">å»å¯¦é©—å®¤</a>
        </div>
      </div>

      <div class="mt-4 bg-slate-100 rounded-xl p-4">
        <label class="block text-xs font-bold text-slate-600 mb-1">Worker ç¶²å€</label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="workerUrl" placeholder="https://api.xxx.workers.dev"
                 class="flex-1 border rounded-xl p-2 text-sm bg-white"
                 oninput="saveWorkerUrl(this.value)">
          <button class="btn btnGreen" onclick="reloadKeys()">è¼‰å…¥æ¸…å–®</button>
          <button class="btn btnGhost" onclick="ping()">æ¸¬è©¦é€£ç·š</button>
        </div>
        <div class="mt-2 text-[12px] text-slate-600">
          éœ€è¦ Worker æ”¯æ´ï¼š
          <span class="mono">/listMeta</span>ï¼ˆæœ€å¥½æœ‰ï¼‰ã€
          <span class="mono">/loadAny</span>ã€
          <span class="mono">/putAny</span>ï¼ˆå¯«å› DB/REPLIESï¼‰ã€
          <span class="mono">/save</span>ï¼ˆç›¸å®¹ DBï¼‰ã€‚
        </div>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-600"></div>

      <div class="mt-4 flex flex-wrap gap-2">
        <span class="chip">âœ… DB å¯«å›ï¼š/save æˆ– /putAny</span>
        <span class="chip">âœ… REPLIES å¯«å›ï¼š/putAny</span>
        <span class="chip">âœ… æŸ¥è©¢ï¼š/listMetaï¼ˆæˆ– fallback /listAll /listï¼‰</span>
      </div>
    </div>

    <div class="card p-6 space-y-3">
      <div class="flex flex-col lg:flex-row gap-3">
        <!-- Left -->
        <div class="flex-1 space-y-2">
          <div class="flex flex-col md:flex-row gap-2">
            <input id="search" class="w-full border rounded-xl p-2 text-sm"
                   placeholder="æœå°‹ key / note / featureï¼ˆä¾‹å¦‚ï¼šé¸å–®/ç”¢å“/æµç¨‹/å¡ç‰‡ï¼‰"
                   oninput="renderList()">
            <select id="nsFilter" class="border rounded-xl p-2 text-sm" onchange="renderList()">
              <option value="ALL">å…¨éƒ¨</option>
              <option value="DB">DB</option>
              <option value="REPLIES">REPLIES</option>
            </select>
          </div>

          <div class="flex flex-col md:flex-row gap-2">
            <select id="featureFilter" class="border rounded-xl p-2 text-sm flex-1" onchange="renderList()">
              <option value="ALL">åŠŸèƒ½ï¼šå…¨éƒ¨</option>
              <option value="quickreply">quickreply</option>
              <option value="imagemap">imagemap</option>
              <option value="carousel">carousel</option>
              <option value="flow">flow</option>
              <option value="liff_preview">liff_preview</option>
              <option value="other">other</option>
              <option value="unknown">unknown</option>
            </select>

            <select id="statusFilter" class="border rounded-xl p-2 text-sm flex-1" onchange="renderList()">
              <option value="ALL">ç‹€æ…‹ï¼šå…¨éƒ¨</option>
              <option value="active">active</option>
              <option value="testing">testing</option>
              <option value="deprecated">deprecated</option>
              <option value="unknown">unknown</option>
            </select>
          </div>

          <div class="flex flex-col md:flex-row gap-2">
            <button class="btn btnGhost w-full md:w-auto" onclick="markAllVisible('active')">å¯è¦‹é …ç›® â†’ active</button>
            <button class="btn btnGhost w-full md:w-auto" onclick="markAllVisible('testing')">å¯è¦‹é …ç›® â†’ testing</button>
            <button class="btn btnGhost w-full md:w-auto" onclick="markAllVisible('deprecated')">å¯è¦‹é …ç›® â†’ deprecated</button>
            <button class="btn btnGhost w-full md:w-auto danger" onclick="dangerZoneTip()">âš  æ‰¹æ¬¡æ¨™è¨˜èªªæ˜</button>
          </div>

          <div id="list" class="space-y-2 max-h-[540px] overflow-auto pr-1"></div>
          <div id="stats" class="text-[12px] text-slate-500"></div>
        </div>

        <!-- Right -->
        <div class="w-full lg:w-[420px] space-y-3">
          <div class="bg-slate-50 border rounded-2xl p-4">
            <div class="font-extrabold text-slate-800">ç›®å‰é¸å–</div>
            <div class="mt-2 text-sm">
              <div class="flex items-center gap-2">
                <span id="selNsBadge" class="badge badge-db">DB</span>
                <div id="selKey" class="font-black break-all">ï¼ˆå°šæœªé¸å–ï¼‰</div>
              </div>
            </div>

            <div class="mt-3 grid grid-cols-1 gap-2">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">åŠŸèƒ½ feature</label>
                <select id="metaFeature" class="w-full border rounded-xl p-2 text-sm">
                  <option value="quickreply">quickreplyï¼ˆç´…æ¡†ï¼‰</option>
                  <option value="imagemap">imagemapï¼ˆå¼•æµåœ–ï¼‰</option>
                  <option value="carousel">carouselï¼ˆè¼ªæ’­å¡ï¼‰</option>
                  <option value="flow">flowï¼ˆæµç¨‹ï¼‰</option>
                  <option value="liff_preview">liff_previewï¼ˆLIFF é è¦½ï¼‰</option>
                  <option value="other">otherï¼ˆå…¶ä»–ï¼‰</option>
                  <option value="unknown">unknownï¼ˆæœªåˆ†é¡ï¼‰</option>
                </select>
              </div>

              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">ç‹€æ…‹ status</label>
                <select id="metaStatus" class="w-full border rounded-xl p-2 text-sm">
                  <option value="active">activeï¼ˆæ­£å¼ä½¿ç”¨ï¼‰</option>
                  <option value="testing">testingï¼ˆæ¸¬è©¦ä¸­ï¼‰</option>
                  <option value="deprecated">deprecatedï¼ˆå·²æ£„ç”¨ï¼‰</option>
                  <option value="unknown">unknown</option>
                </select>
              </div>

              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">å‚™è¨» noteï¼ˆå¯ç©ºï¼‰</label>
                <input id="metaNote" class="w-full border rounded-xl p-2 text-sm" placeholder="ä¾‹å¦‚ï¼šä¸»é¸å–®/ç”¢å“å°è³¼/å¥åº·å¼•æµ...">
              </div>

              <button class="btn btnGreen w-full" onclick="saveMeta()">å„²å­˜æ¨™è¨˜</button>

              <div class="grid grid-cols-2 gap-2">
                <button class="btn btnGhost w-full" onclick="preview()">é è¦½ JSON</button>
                <button class="btn btnBlue w-full" onclick="copyJSON()">è¤‡è£½ JSON</button>
              </div>

              <button class="btn btnGhost w-full danger" onclick="deleteItem()">åˆªé™¤é€™ç­†ï¼ˆæ…ç”¨ï¼‰</button>
            </div>

            <div class="mt-3 text-[12px] text-slate-500">
              å„²å­˜æœƒæŠŠä½ åŸæœ¬ payload ä¿ç•™ï¼Œåªæ–°å¢/æ›´æ–° <span class="mono">payload.meta</span>ã€‚
            </div>
          </div>

          <div class="bg-white border rounded-2xl p-4">
            <div class="font-extrabold">é è¦½</div>
            <pre id="previewBox" class="mt-2 text-xs bg-slate-50 border rounded-xl p-3 max-h-[300px] overflow-auto mono"></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center text-[12px] text-slate-400">
      Powered by GitHub Pages + Cloudflare Workers
    </div>
  </div>

<script>
  const WORKER_KEY = 'line_worker_url';
  let ITEMS = [];      // {namespace,key,feature,status,updatedAt,note}
  let SELECTED = null; // {namespace,key,payload}

  window.onload = () => {
    const saved = localStorage.getItem(WORKER_KEY);
    if (saved) document.getElementById('workerUrl').value = saved;
    setStatus('è¼¸å…¥ Worker URL â†’ é»ã€Œè¼‰å…¥æ¸…å–®ã€', 'info');
  };

  function setStatus(msg, type='info') {
    const el = document.getElementById('status');
    const cls = type==='ok' ? 'text-emerald-700' : type==='err' ? 'text-rose-700' : 'text-slate-600';
    el.className = `mt-3 text-sm ${cls}`;
    el.textContent = msg;
  }

  function saveWorkerUrl(v){ localStorage.setItem(WORKER_KEY, (v||'').trim()); }

  function getWorker(){
    let w = (document.getElementById('workerUrl').value || '').trim();
    w = w.replace(/\/+$/, '');
    if(!w){
      alert('è«‹å…ˆè¼¸å…¥ Worker ç¶²å€');
      document.getElementById('workerUrl').focus();
      return null;
    }
    saveWorkerUrl(w);
    return w;
  }

  async function postJSON(fullUrl, data){
    const res = await fetch(fullUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data || {})
    });
    const out = await res.json().catch(()=>null);
    return {res, out};
  }

  async function ping(){
    const w = getWorker();
    if(!w) return;
    try{
      const res = await fetch(w + '/health', { method:'GET' });
      if(res.ok) setStatus('é€£ç·šæˆåŠŸï¼š/health OK', 'ok');
      else setStatus('é€£ç·šå¤±æ•—ï¼š/health é 200', 'err');
    }catch(e){
      setStatus('é€£ç·šå¤±æ•—ï¼š' + (e.message || e), 'err');
    }
  }

  async function reloadKeys(){
    const w = getWorker();
    if(!w) return;

    setStatus('è¼‰å…¥ä¸­â€¦', 'info');
    ITEMS = [];
    SELECTED = null;
    document.getElementById('previewBox').textContent = '';
    document.getElementById('selKey').textContent = 'ï¼ˆå°šæœªé¸å–ï¼‰';

    // 1) /listMeta
    try{
      const r = await postJSON(w + '/listMeta', {});
      if(r.res.ok && r.out?.ok && Array.isArray(r.out.items)){
        ITEMS = r.out.items.map(x => ({
          namespace: String(x.namespace||'DB').toUpperCase(),
          key: String(x.key||''),
          feature: String(x.feature||'unknown'),
          status: String(x.status||'unknown'),
          updatedAt: Number(x.updatedAt||0)||0,
          note: String(x.note||'')
        })).filter(x=>x.key);
        setStatus(`è¼‰å…¥æˆåŠŸï¼š${ITEMS.length} ç­†ï¼ˆ/listMetaï¼‰`, 'ok');
        renderList();
        return;
      }
    }catch(e){}

    // 2) /listAll fallback
    try{
      const r = await postJSON(w + '/listAll', {});
      if(r.res.ok && r.out?.ok){
        const db = Array.isArray(r.out.db) ? r.out.db : [];
        const rep = Array.isArray(r.out.replies) ? r.out.replies : [];
        ITEMS = [
          ...db.map(k => ({namespace:'DB', key:String(k), feature:'unknown', status:'unknown', updatedAt:0, note:''})),
          ...rep.map(k => ({namespace:'REPLIES', key:String(k), feature:'unknown', status:'unknown', updatedAt:0, note:''}))
        ].filter(x=>x.key);
        setStatus(`è¼‰å…¥æˆåŠŸï¼š${ITEMS.length} ç­†ï¼ˆ/listAllï¼›feature/status=unknownï¼‰`, 'ok');
        renderList();
        return;
      }
    }catch(e){}

    // 3) /list fallback (DB only)
    try{
      const r = await postJSON(w + '/list', {});
      const keywords = r.out?.keywords || [];
      ITEMS = keywords.map(k => ({namespace:'DB', key:String(k), feature:'unknown', status:'unknown', updatedAt:0, note:''}));
      setStatus(`è¼‰å…¥æˆåŠŸï¼šDB ${ITEMS.length} ç­†ï¼ˆ/listï¼›feature/status=unknownï¼‰`, 'ok');
      renderList();
      return;
    }catch(e){
      setStatus('è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª Worker URL / CORS / API æ˜¯å¦å­˜åœ¨', 'err');
    }
  }

  function currentFilteredRows(){
    const q = (document.getElementById('search').value || '').trim().toLowerCase();
    const ns = document.getElementById('nsFilter').value;
    const f = document.getElementById('featureFilter').value;
    const s = document.getElementById('statusFilter').value;

    let rows = ITEMS.slice();
    if(ns !== 'ALL') rows = rows.filter(x => x.namespace === ns);
    if(f !== 'ALL') rows = rows.filter(x => (x.feature || 'unknown') === f);
    if(s !== 'ALL') rows = rows.filter(x => (x.status || 'unknown') === s);
    if(q) rows = rows.filter(x =>
      x.key.toLowerCase().includes(q) ||
      (x.note||'').toLowerCase().includes(q) ||
      (x.feature||'').toLowerCase().includes(q)
    );

    rows.sort((a,b)=>(a.namespace+":"+a.key).localeCompare(b.namespace+":"+b.key, 'zh-Hant'));
    return rows;
  }

  function renderList(){
    const rows = currentFilteredRows();
    document.getElementById('stats').textContent = `å…± ${ITEMS.length} ç­†ï¼ˆç›®å‰é¡¯ç¤º ${rows.length} ç­†ï¼‰`;

    const list = document.getElementById('list');
    list.innerHTML = '';
    if(!rows.length){
      list.innerHTML = '<div class="text-slate-400 text-sm">æ²’æœ‰è³‡æ–™</div>';
      return;
    }

    rows.forEach(x=>{
      const nsBadge = x.namespace === 'DB'
        ? `<span class="badge badge-db">DB</span>`
        : `<span class="badge badge-replies">REPLIES</span>`;

      const line = `
        <button class="w-full text-left border rounded-2xl p-3 bg-slate-50 hover:bg-slate-100"
                onclick="selectKey('${x.namespace}','${escapeJs(x.key)}')">
          <div class="flex items-center gap-2">
            ${nsBadge}
            <div class="font-black truncate">${escapeHtml(x.key)}</div>
          </div>
          <div class="text-[12px] text-slate-500 mt-1">
            feature: <span class="font-bold">${escapeHtml(x.feature||'unknown')}</span> /
            status: <span class="font-bold">${escapeHtml(x.status||'unknown')}</span>
            ${x.note ? ` / note: ${escapeHtml(x.note)}` : ``}
          </div>
        </button>
      `;
      list.innerHTML += line;
    });
  }

  async function selectKey(namespace, key){
    const w = getWorker();
    if(!w) return;

    // badge
    const nsBadge = document.getElementById('selNsBadge');
    if(namespace === 'DB'){
      nsBadge.textContent = 'DB';
      nsBadge.className = 'badge badge-db';
    }else{
      nsBadge.textContent = 'REPLIES';
      nsBadge.className = 'badge badge-replies';
    }
    document.getElementById('selKey').textContent = key;

    // loadAny
    setStatus(`è®€å– ${namespace}/${key}â€¦`, 'info');
    const r = await postJSON(w + '/loadAny', { namespace: namespace, keyword: key });
    if(!r.res.ok || !r.out?.ok){
      setStatus('è®€å–å¤±æ•—ï¼š' + (r.out?.error || r.res.status), 'err');
      return;
    }

    const payload = r.out.payload;
    SELECTED = { namespace, key, payload };

    // meta
    const meta = (payload && typeof payload === 'object' && payload.meta) ? payload.meta : {};
    document.getElementById('metaFeature').value = meta.feature || 'unknown';
    document.getElementById('metaStatus').value = meta.status || 'unknown';
    document.getElementById('metaNote').value = meta.note || '';

    document.getElementById('previewBox').textContent = JSON.stringify(payload, null, 2);
    setStatus('è®€å–æˆåŠŸï¼Œå¯ç›´æ¥ä¿®æ”¹ feature/status/note å¾ŒæŒ‰ã€Œå„²å­˜æ¨™è¨˜ã€', 'ok');
  }

  async function preview(){
    if(!SELECTED){
      alert('è«‹å…ˆå¾å·¦é‚Šé¸ä¸€ç­†è³‡æ–™');
      return;
    }
    document.getElementById('previewBox').textContent = JSON.stringify(SELECTED.payload, null, 2);
  }

  async function copyJSON(){
    if(!SELECTED){
      alert('è«‹å…ˆå¾å·¦é‚Šé¸ä¸€ç­†è³‡æ–™');
      return;
    }
    const text = JSON.stringify(SELECTED.payload, null, 2);
    try{
      await navigator.clipboard.writeText(text);
      alert('å·²è¤‡è£½ JSON');
    }catch(e){
      prompt('è¤‡è£½é€™æ®µ JSONï¼š', text);
    }
  }

  async function saveMeta(){
    if(!SELECTED){
      alert('è«‹å…ˆå¾å·¦é‚Šé¸ä¸€ç­†è³‡æ–™');
      return;
    }
    const w = getWorker();
    if(!w) return;

    const feature = document.getElementById('metaFeature').value || 'unknown';
    const status = document.getElementById('metaStatus').value || 'unknown';
    const note = (document.getElementById('metaNote').value || '').trim();

    // merge meta
    let payload = SELECTED.payload;
    if(!payload || typeof payload !== 'object') payload = { value: payload };
    payload.meta = (payload.meta && typeof payload.meta === 'object') ? payload.meta : {};
    payload.meta.feature = feature;
    payload.meta.status = status;
    payload.meta.note = note;
    payload.meta.createdFrom = payload.meta.createdFrom || 'tool_meta_editor';
    payload.meta.updatedAt = Date.now();

    setStatus('å„²å­˜ä¸­â€¦', 'info');

    // âœ… ä¸€å¾‹ç”¨ putAnyï¼ˆDB/REPLIES éƒ½å¯å¯«ï¼‰
    const r = await postJSON(w + '/putAny', {
      namespace: SELECTED.namespace,
      keyword: SELECTED.key,
      payload
    });

    if(r.res.ok && r.out && r.out.ok !== false){
      // æ›´æ–° ITEMS
      const idx = ITEMS.findIndex(x => x.namespace===SELECTED.namespace && x.key===SELECTED.key);
      if(idx >= 0){
        ITEMS[idx].feature = feature;
        ITEMS[idx].status = status;
        ITEMS[idx].note = note;
        ITEMS[idx].updatedAt = payload.meta.updatedAt;
      }
      SELECTED.payload = payload;
      document.getElementById('previewBox').textContent = JSON.stringify(payload, null, 2);
      renderList();
      setStatus('å„²å­˜æˆåŠŸ âœ…ï¼ˆå·²å¯«å› '+SELECTED.namespace+'ï¼‰', 'ok');
      alert('å„²å­˜æˆåŠŸ');
      return;
    }

    setStatus('å„²å­˜å¤±æ•—ï¼š' + (r.out?.error || r.res.status), 'err');
  }

  async function deleteItem(){
    if(!SELECTED){
      alert('è«‹å…ˆå¾å·¦é‚Šé¸ä¸€ç­†è³‡æ–™');
      return;
    }
    if(!confirm(`ç¢ºå®šåˆªé™¤ï¼Ÿ\n\n${SELECTED.namespace}/${SELECTED.key}\n\né€™å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;

    const w = getWorker();
    if(!w) return;

    setStatus('åˆªé™¤ä¸­â€¦', 'info');
    const r = await postJSON(w + '/deleteAny', {
      namespace: SELECTED.namespace,
      keyword: SELECTED.key
    });

    if(r.res.ok && r.out && r.out.ok !== false){
      ITEMS = ITEMS.filter(x => !(x.namespace===SELECTED.namespace && x.key===SELECTED.key));
      SELECTED = null;
      document.getElementById('previewBox').textContent = '';
      document.getElementById('selKey').textContent = 'ï¼ˆå°šæœªé¸å–ï¼‰';
      setStatus('åˆªé™¤æˆåŠŸ âœ…', 'ok');
      renderList();
      alert('åˆªé™¤æˆåŠŸ');
      return;
    }
    setStatus('åˆªé™¤å¤±æ•—ï¼š' + (r.out?.error || r.res.status), 'err');
  }

  function dangerZoneTip(){
    alert(
      'æ‰¹æ¬¡æ¨™è¨˜æœƒã€Œé€ç­†å¯«å› KVã€ï¼š\n' +
      '- å»ºè­°å…ˆç”¨æœå°‹/ç¯©é¸ç¸®å°ç¯„åœ\n' +
      '- ä¸€æ¬¡ä¸è¦é¸å¤ªå¤šï¼ˆä¾‹å¦‚ 30 ç­†ä»¥å…§ï¼‰\n' +
      '- REPLIES ä¹Ÿæœƒå¯«å›ï¼ˆéœ€è¦ä½ å·²æ›´æ–° worker.js æœ‰ /putAnyï¼‰'
    );
  }

  // æ‰¹æ¬¡æŠŠå¯è¦‹é …ç›®æ”¹ statusï¼ˆä¿ç•™ feature/note ä¸å‹•ï¼‰
  async function markAllVisible(newStatus){
    const w = getWorker();
    if(!w) return;

    const rows = currentFilteredRows();
    if(rows.length === 0) return alert('ç›®å‰æ²’æœ‰å¯è¦‹é …ç›®');
    if(rows.length > 30){
      alert('ç›®å‰å¯è¦‹é …ç›®å¤ªå¤šï¼ˆ'+rows.length+'ç­†ï¼‰ã€‚\nå»ºè­°å…ˆç”¨æœå°‹/ç¯©é¸ç¸®å°åˆ° 30 ç­†å…§å†æ‰¹æ¬¡ã€‚');
      return;
    }
    if(!confirm(`ç¢ºå®šæŠŠã€Œç›®å‰å¯è¦‹çš„ ${rows.length} ç­†ã€ç‹€æ…‹æ”¹æˆï¼š${newStatus} ï¼Ÿ`)) return;

    setStatus(`æ‰¹æ¬¡æ›´æ–°ä¸­â€¦ï¼ˆ${rows.length} ç­†ï¼‰`, 'info');

    // é€ç­†ï¼šloadAny -> æ”¹ meta.status -> putAny
    let okCount = 0, failCount = 0;
    for(const item of rows){
      try{
        const loaded = await postJSON(w + '/loadAny', { namespace: item.namespace, keyword: item.key });
        if(!loaded.res.ok || !loaded.out?.ok){ failCount++; continue; }

        let payload = loaded.out.payload;
        if(!payload || typeof payload !== 'object') payload = { value: payload };
        payload.meta = (payload.meta && typeof payload.meta === 'object') ? payload.meta : {};
        payload.meta.feature = payload.meta.feature || item.feature || 'unknown';
        payload.meta.status = newStatus;
        payload.meta.note = typeof payload.meta.note === 'string' ? payload.meta.note : (item.note || '');
        payload.meta.createdFrom = payload.meta.createdFrom || 'tool_meta_editor_batch';
        payload.meta.updatedAt = Date.now();

        const saved = await postJSON(w + '/putAny', {
          namespace: item.namespace,
          keyword: item.key,
          payload
        });
        if(saved.res.ok && saved.out && saved.out.ok !== false){
          okCount++;
          // æ›´æ–° ITEMS å¿«å–
          const idx = ITEMS.findIndex(x => x.namespace===item.namespace && x.key===item.key);
          if(idx>=0){
            ITEMS[idx].status = newStatus;
            ITEMS[idx].feature = payload.meta.feature || ITEMS[idx].feature;
            ITEMS[idx].note = payload.meta.note || ITEMS[idx].note;
            ITEMS[idx].updatedAt = payload.meta.updatedAt;
          }
        }else{
          failCount++;
        }
      }catch(e){
        failCount++;
      }
    }

    renderList();
    setStatus(`æ‰¹æ¬¡å®Œæˆ âœ… æˆåŠŸ ${okCount} ç­† / å¤±æ•— ${failCount} ç­†`, failCount? 'err':'ok');
    alert(`æ‰¹æ¬¡å®Œæˆï¼šæˆåŠŸ ${okCount} / å¤±æ•— ${failCount}`);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeJs(s){
    return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  }
</script>
</body>
</html>
