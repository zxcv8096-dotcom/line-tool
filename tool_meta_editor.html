<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è³‡æ–™æ¨™è¨˜å™¨ï¼ˆåŠŸèƒ½/ç‹€æ…‹/å‚™è¨»ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; }
    .card { background: white; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .btn { font-weight: 900; border-radius: 14px; padding: 10px 14px; }
    .btnDark { background:#0f172a; color:#fff; }
    .btnDark:hover { background:#000; }
    .btnGreen { background:#059669; color:#fff; }
    .btnGreen:hover { background:#047857; }
    .btnGhost { background:#fff; border:1px solid #e2e8f0; }
    .btnGhost:hover { background:#f1f5f9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge { font-size: 11px; padding: 3px 10px; border-radius: 999px; border: 1px solid; font-weight: 900; }
    .badge-db { background:#eff6ff; color:#1d4ed8; border-color:#dbeafe; }
    .badge-replies { background:#fffbeb; color:#b45309; border-color:#fef3c7; }
  </style>
</head>

<body class="min-h-screen p-4 text-slate-800">
  <div class="max-w-5xl mx-auto space-y-4">

    <div class="card p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-5xl">ğŸ·ï¸</div>
          <h1 class="text-2xl font-extrabold mt-2">è³‡æ–™æ¨™è¨˜å™¨ï¼ˆåŠŸèƒ½ / ç‹€æ…‹ / å‚™è¨»ï¼‰</h1>
          <p class="text-sm text-slate-500 mt-1">
            å°ˆé–€ç”¨ä¾†æŠŠèˆŠè³‡æ–™å¾ unknown è®Šæˆå¯ç¯©é¸ï¼ˆquickreply / imagemap / carousel / flow...ï¼‰ã€‚
          </p>
        </div>
        <div class="text-right flex gap-2">
          <a href="index.html" class="btn btnDark inline-block">å›é¦–é </a>
          <a href="lab_dashboard.html" class="btn btnGhost inline-block">å»å¯¦é©—å®¤</a>
        </div>
      </div>

      <div class="mt-4 bg-slate-100 rounded-xl p-4">
        <label class="block text-xs font-bold text-slate-600 mb-1">Worker ç¶²å€</label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="workerUrl" placeholder="https://api.xxx.workers.dev"
                 class="flex-1 border rounded-xl p-2 text-sm bg-white"
                 oninput="saveWorkerUrl(this.value)">
          <button class="btn btnGreen" onclick="reloadKeys()">è¼‰å…¥æ¸…å–®</button>
          <button class="btn btnGhost" onclick="ping()">æ¸¬è©¦é€£ç·š</button>
        </div>
        <div class="mt-2 text-[12px] text-slate-600">
          éœ€è¦ Worker æ”¯æ´ï¼š<span class="mono">/loadAny</span>ã€<span class="mono">/save</span>ï¼ˆDBï¼‰ã€ä»¥åŠæœ€å¥½æœ‰ <span class="mono">/listMeta</span>ã€‚
        </div>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-600"></div>
    </div>

    <div class="card p-6 space-y-3">
      <div class="flex flex-col lg:flex-row gap-3">
        <div class="flex-1 space-y-2">
          <div class="flex gap-2">
            <input id="search" class="w-full border rounded-xl p-2 text-sm" placeholder="æœå°‹ keyï¼ˆä¾‹å¦‚ï¼šé¸å–®/ç”¢å“/æµç¨‹/å¡ç‰‡ï¼‰" oninput="renderList()">
            <select id="nsFilter" class="border rounded-xl p-2 text-sm" onchange="renderList()">
              <option value="ALL">å…¨éƒ¨</option>
              <option value="DB">DB</option>
              <option value="REPLIES">REPLIES</option>
            </select>
          </div>

          <div id="list" class="space-y-2 max-h-[520px] overflow-auto pr-1"></div>
          <div id="stats" class="text-[12px] text-slate-500"></div>
        </div>

        <div class="w-full lg:w-[420px] space-y-3">
          <div class="bg-slate-50 border rounded-2xl p-4">
            <div class="font-extrabold text-slate-800">ç›®å‰é¸å–</div>
            <div class="mt-2 text-sm">
              <div class="flex items-center gap-2">
                <span id="selNsBadge" class="badge badge-db">DB</span>
                <div id="selKey" class="font-black break-all">ï¼ˆå°šæœªé¸å–ï¼‰</div>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-1 gap-2">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">åŠŸèƒ½ feature</label>
                <select id="metaFeature" class="w-full border rounded-xl p-2 text-sm">
                  <option value="quickreply">quickreplyï¼ˆç´…æ¡†ï¼‰</option>
                  <option value="imagemap">imagemapï¼ˆå¼•æµåœ–ï¼‰</option>
                  <option value="carousel">carouselï¼ˆè¼ªæ’­å¡ï¼‰</option>
                  <option value="flow">flowï¼ˆæµç¨‹ï¼‰</option>
                  <option value="liff_preview">liff_previewï¼ˆLIFF é è¦½ï¼‰</option>
                  <option value="other">otherï¼ˆå…¶ä»–ï¼‰</option>
                  <option value="unknown">unknownï¼ˆæœªåˆ†é¡ï¼‰</option>
                </select>
              </div>

              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">ç‹€æ…‹ status</label>
                <select id="metaStatus" class="w-full border rounded-xl p-2 text-sm">
                  <option value="active">activeï¼ˆæ­£å¼ä½¿ç”¨ï¼‰</option>
                  <option value="testing">testingï¼ˆæ¸¬è©¦ä¸­ï¼‰</option>
                  <option value="deprecated">deprecatedï¼ˆå·²æ£„ç”¨ï¼‰</option>
                  <option value="unknown">unknown</option>
                </select>
              </div>

              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">å‚™è¨» noteï¼ˆå¯ç©ºï¼‰</label>
                <input id="metaNote" class="w-full border rounded-xl p-2 text-sm" placeholder="ä¾‹å¦‚ï¼šä¸»é¸å–®/ç”¢å“å°è³¼/å¥åº·å¼•æµ...">
              </div>

              <button class="btn btnGreen w-full" onclick="saveMeta()">å„²å­˜æ¨™è¨˜</button>
              <button class="btn btnGhost w-full" onclick="preview()">é è¦½ JSON</button>
            </div>

            <div class="mt-3 text-[12px] text-slate-500">
              å„²å­˜æœƒæŠŠä½ åŸæœ¬ payload ä¿ç•™ï¼Œåªæ–°å¢/æ›´æ–° <span class="mono">payload.meta</span>ã€‚
            </div>
          </div>

          <div class="bg-white border rounded-2xl p-4">
            <div class="font-extrabold">é è¦½</div>
            <pre id="previewBox" class="mt-2 text-xs bg-slate-50 border rounded-xl p-3 max-h-[280px] overflow-auto mono"></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center text-[12px] text-slate-400">
      Powered by GitHub Pages + Cloudflare Workers
    </div>
  </div>

<script>
  const WORKER_KEY = 'line_worker_url';
  let ITEMS = [];      // {namespace,key,feature,status,updatedAt,note}
  let SELECTED = null; // {namespace,key,payload}

  window.onload = () => {
    const saved = localStorage.getItem(WORKER_KEY);
    if (saved) document.getElementById('workerUrl').value = saved;
    setStatus('è¼¸å…¥ Worker URL â†’ é»ã€Œè¼‰å…¥æ¸…å–®ã€', 'info');
  };

  function setStatus(msg, type='info') {
    const el = document.getElementById('status');
    const cls = type==='ok' ? 'text-emerald-700' : type==='err' ? 'text-rose-700' : 'text-slate-600';
    el.className = `mt-3 text-sm ${cls}`;
    el.textContent = msg;
  }

  function saveWorkerUrl(v){ localStorage.setItem(WORKER_KEY, (v||'').trim()); }

  function getWorker(){
    let w = (document.getElementById('workerUrl').value || '').trim();
    w = w.replace(/\/+$/, '');
    if(!w){
      alert('è«‹å…ˆè¼¸å…¥ Worker ç¶²å€');
      document.getElementById('workerUrl').focus();
      return null;
    }
    saveWorkerUrl(w);
    return w;
  }

  async function postJSON(fullUrl, data){
    const res = await fetch(fullUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data || {})
    });
    const out = await res.json().catch(()=>null);
    return {res, out};
  }

  async function ping(){
    const w = getWorker();
    if(!w) return;
    try{
      const res = await fetch(w + '/health', { method:'GET' });
      if(res.ok) setStatus('é€£ç·šæˆåŠŸï¼š/health OK', 'ok');
      else setStatus('é€£ç·šå¤±æ•—ï¼š/health é 200', 'err');
    }catch(e){
      setStatus('é€£ç·šå¤±æ•—ï¼š' + (e.message || e), 'err');
    }
  }

  async function reloadKeys(){
    const w = getWorker();
    if(!w) return;

    setStatus('è¼‰å…¥ä¸­â€¦', 'info');
    ITEMS = [];
    SELECTED = null;
    document.getElementById('previewBox').textContent = '';
    document.getElementById('selKey').textContent = 'ï¼ˆå°šæœªé¸å–ï¼‰';

    // 1) /listMeta
    try{
      const r = await postJSON(w + '/listMeta', {});
      if(r.res.ok && r.out?.ok && Array.isArray(r.out.items)){
        ITEMS = r.out.items.map(x => ({
          namespace: String(x.namespace||'DB').toUpperCase(),
          key: String(x.key||''),
          feature: String(x.feature||'unknown'),
          status: String(x.status||'unknown'),
          updatedAt: Number(x.updatedAt||0)||0,
          note: String(x.note||'')
        })).filter(x=>x.key);
        setStatus(`è¼‰å…¥æˆåŠŸï¼š${ITEMS.length} ç­†ï¼ˆ/listMetaï¼‰`, 'ok');
        renderList();
        return;
      }
    }catch(e){}

    // 2) /listAll fallback
    try{
      const r = await postJSON(w + '/listAll', {});
      if(r.res.ok && r.out?.ok){
        const db = Array.isArray(r.out.db) ? r.out.db : [];
        const rep = Array.isArray(r.out.replies) ? r.out.replies : [];
        ITEMS = [
          ...db.map(k => ({namespace:'DB', key:String(k), feature:'unknown', status:'unknown', updatedAt:0, note:''})),
          ...rep.map(k => ({namespace:'REPLIES', key:String(k), feature:'unknown', status:'unknown', updatedAt:0, note:''}))
        ].filter(x=>x.key);
        setStatus(`è¼‰å…¥æˆåŠŸï¼š${ITEMS.length} ç­†ï¼ˆ/listAllï¼›feature/status=unknownï¼‰`, 'ok');
        renderList();
        return;
      }
    }catch(e){}

    // 3) /list fallback (DB only)
    try{
      const r = await postJSON(w + '/list', {});
      const keywords = r.out?.keywords || [];
      ITEMS = keywords.map(k => ({namespace:'DB', key:String(k), feature:'unknown', status:'unknown', updatedAt:0, note:''}));
      setStatus(`è¼‰å…¥æˆåŠŸï¼šDB ${ITEMS.length} ç­†ï¼ˆ/listï¼›feature/status=unknownï¼‰`, 'ok');
      renderList();
      return;
    }catch(e){
      setStatus('è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª Worker URL / CORS / API æ˜¯å¦å­˜åœ¨', 'err');
    }
  }

  function renderList(){
    const q = (document.getElementById('search').value || '').trim().toLowerCase();
    const ns = document.getElementById('nsFilter').value;

    let rows = ITEMS.slice();
    if(ns !== 'ALL') rows = rows.filter(x => x.namespace === ns);
    if(q) rows = rows.filter(x =>
      x.key.toLowerCase().includes(q) ||
      (x.note||'').toLowerCase().includes(q) ||
      (x.feature||'').toLowerCase().includes(q)
    );

    rows.sort((a,b)=>(a.namespace+":"+a.key).localeCompare(b.namespace+":"+b.key, 'zh-Hant'));

    document.getElementById('stats').textContent = `å…± ${ITEMS.length} ç­†ï¼ˆç›®å‰é¡¯ç¤º ${rows.length} ç­†ï¼‰`;

    const list = document.getElementById('list');
    list.innerHTML = '';
    if(!rows.length){
      list.innerHTML = '<div class="text-slate-400 text-sm">æ²’æœ‰è³‡æ–™</div>';
      return;
    }

    rows.forEach(x=>{
      const nsBadge = x.namespace === 'DB'
        ? `<span class="badge badge-db">DB</span>`
        : `<span class="badge badge-replies">REPLIES</span>`;

      const line = `
        <button class="w-full text-left border rounded-2xl p-3 bg-slate-50 hover:bg-slate-100"
                onclick="selectKey('${x.namespace}','${escapeJs(x.key)}')">
          <div class="flex items-center gap-2">
            ${nsBadge}
            <div class="font-black truncate">${escapeHtml(x.key)}</div>
          </div>
          <div class="text-[12px] text-slate-500 mt-1">
            feature: <span class="font-bold">${escapeHtml(x.feature||'unknown')}</span> /
            status: <span class="font-bold">${escapeHtml(x.status||'unknown')}</span>
            ${x.note ? ` / note: ${escapeHtml(x.note)}` : ``}
          </div>
        </button>
      `;
      list.innerHTML += line;
    });
  }

  async function selectKey(namespace, key){
    const w = getWorker();
    if(!w) return;

    // badge
    const nsBadge = document.getElementById('selNsBadge');
    if(namespace === 'DB'){
      nsBadge.textContent = 'DB';
      nsBadge.className = 'badge badge-db';
    }else{
      nsBadge.textContent = 'REPLIES';
      nsBadge.className = 'badge badge-replies';
    }
    document.getElementById('selKey').textContent = key;

    // loadAny
    setStatus(`è®€å– ${namespace}/${key}â€¦`, 'info');
    const r = await postJSON(w + '/loadAny', { namespace: namespace, keyword: key });
    if(!r.res.ok || !r.out?.ok){
      setStatus('è®€å–å¤±æ•—ï¼š' + (r.out?.error || r.res.status), 'err');
      return;
    }

    const payload = r.out.payload;
    SELECTED = { namespace, key, payload };

    // å…ˆå¾ payload.meta å–å€¼
    const meta = (payload && typeof payload === 'object' && payload.meta) ? payload.meta : {};
    document.getElementById('metaFeature').value = meta.feature || 'unknown';
    document.getElementById('metaStatus').value = meta.status || 'unknown';
    document.getElementById('metaNote').value = meta.note || '';

    document.getElementById('previewBox').textContent = JSON.stringify(payload, null, 2);
    setStatus('è®€å–æˆåŠŸï¼Œå¯ç›´æ¥ä¿®æ”¹ feature/status/note å¾ŒæŒ‰ã€Œå„²å­˜æ¨™è¨˜ã€', 'ok');
  }

  async function preview(){
    if(!SELECTED){
      alert('è«‹å…ˆå¾å·¦é‚Šé¸ä¸€ç­†è³‡æ–™');
      return;
    }
    document.getElementById('previewBox').textContent = JSON.stringify(SELECTED.payload, null, 2);
  }

  async function saveMeta(){
    if(!SELECTED){
      alert('è«‹å…ˆå¾å·¦é‚Šé¸ä¸€ç­†è³‡æ–™');
      return;
    }
    const w = getWorker();
    if(!w) return;

    const feature = document.getElementById('metaFeature').value || 'unknown';
    const status = document.getElementById('metaStatus').value || 'unknown';
    const note = (document.getElementById('metaNote').value || '').trim();

    // merge meta
    let payload = SELECTED.payload;
    if(!payload || typeof payload !== 'object') payload = { value: payload };
    payload.meta = (payload.meta && typeof payload.meta === 'object') ? payload.meta : {};
    payload.meta.feature = feature;
    payload.meta.status = status;
    payload.meta.note = note;
    payload.meta.createdFrom = payload.meta.createdFrom || 'tool_meta_editor';
    payload.meta.updatedAt = Date.now();

    // å¯«å›ï¼šDB ç”¨ /saveï¼›REPLIES ç›®å‰ worker.js æ²’æœ‰ /saveReplies
    // æ‰€ä»¥ï¼šREPLIES ç”¨ deleteAny + putAny æœƒæ›´å¥½ï¼Œä½†ä½  worker.js æ²’æœ‰ putAny
    // â†’ é€™è£¡å…ˆè™•ç† DBï¼›REPLIES æœƒæç¤ºä½ åŠ  putAnyï¼ˆä¸‹ä¸€æ­¥æˆ‘æœƒç›´æ¥çµ¦ä½  worker.js æ›´æ–°ï¼‰
    if(SELECTED.namespace !== 'DB'){
      alert('ä½ ç›®å‰ Worker æ²’æœ‰æä¾›ã€Œå¯«å…¥ REPLIESã€çš„ APIã€‚\nä¸‹ä¸€æ­¥æˆ‘æœƒå¹«ä½ åœ¨ worker.js åŠ ï¼š/putAnyï¼ˆDB/REPLIES éƒ½å¯å¯«ï¼‰ã€‚');
      return;
    }

    setStatus('å„²å­˜ä¸­â€¦', 'info');
    const r = await postJSON(w + '/save', { keyword: SELECTED.key, payload });
    if(r.res.ok && r.out && r.out.ok !== false){
      // æ›´æ–° ITEMS å…§çš„ meta æ–¹ä¾¿ UI ç«‹å³åˆ·æ–°
      const idx = ITEMS.findIndex(x => x.namespace==='DB' && x.key===SELECTED.key);
      if(idx >= 0){
        ITEMS[idx].feature = feature;
        ITEMS[idx].status = status;
        ITEMS[idx].note = note;
        ITEMS[idx].updatedAt = payload.meta.updatedAt;
      }
      SELECTED.payload = payload;
      document.getElementById('previewBox').textContent = JSON.stringify(payload, null, 2);
      renderList();
      setStatus('å„²å­˜æˆåŠŸ âœ…', 'ok');
      alert('å„²å­˜æˆåŠŸ');
      return;
    }
    setStatus('å„²å­˜å¤±æ•—ï¼š' + (r.out?.error || r.res.status), 'err');
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeJs(s){
    return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  }
</script>
</body>
</html>
