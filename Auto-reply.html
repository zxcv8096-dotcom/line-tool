<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能健康引流中控台 V2.6 🦁</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #0f172a, #1e1b4b, #4338ca); }
        .token-input { @apply bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs w-full focus:ring-2 ring-indigo-500 outline-none; }
        .card-glow { box-shadow: 0 0 20px rgba(79, 70, 229, 0.1); }
        .warning-glow { box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 leading-relaxed" onload="initData()">

    <nav class="gradient-bg p-5 text-white shadow-2xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter">GAVIN AI FLOW V2.6 🧠</h1>
                <p class="text-[9px] text-indigo-300 font-bold uppercase tracking-widest">大心家族自動化戰略系統</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-bold text-yellow-400">2027/08 安麗鑽石目標 💎</p>
                <p class="text-[9px] opacity-70">2026 淨資產 700 萬階段目標 💰</p>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <div class="grid lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-indigo-900 text-white p-6 rounded-3xl shadow-xl card-glow">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">🦁 領袖思維：複利系統</h2>
                    <p class="text-xs opacity-80 leading-relaxed">
                        運用 GitHub 與 GAS 打造不花體力的自動化名單捕手。記住，106 萬觀看只是開始，轉化才是價值。
                    </p>
                </div>

                <div class="bg-amber-50 border-2 border-amber-200 p-6 rounded-3xl warning-glow">
                    <h3 class="text-amber-800 text-sm font-black mb-3 flex items-center gap-2">
                        ⚠️ 系統運行先決條件
                    </h3>
                    <ul class="text-[11px] text-amber-700 space-y-3 leading-relaxed">
                        <li>
                            <b class="text-amber-900">【Facebook】</b> 
                            必須使用「粉絲專頁」。個人檔案 (Profile) 不支援 API 自動回覆，強行使用會導致帳號異常。
                        </li>
                        <li>
                            <b class="text-amber-900">【Instagram】</b> 
                            需切換為「專業/商業帳號」，並連結至 FB 粉絲專頁方可連動。
                        </li>
                        <li>
                            <b class="text-amber-900">【LINE】</b> 
                            需使用「LINE 官方帳號 (OA)」並開啟 Messaging API 模式。
                        </li>
                        <li>
                            <b class="text-amber-900">【TikTok】</b> 
                            目前 API 權限嚴格，建議以 Bio 連結引流至上述平台。
                        </li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                    <label class="text-[10px] text-slate-400 font-bold uppercase">🔐 雲端識別碼 (accountKey)</label>
                    <input id="accountKey" type="password" placeholder="用於同步 LocalStorage" class="token-input mt-1 mb-4">
                    
                    <label class="text-[10px] text-slate-400 font-bold uppercase">🔑 Meta Webhook 暗號 (Verify Token)</label>
                    <div class="flex gap-2 mt-1 mb-4">
                        <input id="verifyToken" type="text" placeholder="自訂或點擊生成" class="token-input" oninput="renderUI()">
                        <button onclick="generateToken()" class="bg-slate-200 text-slate-600 px-3 rounded-xl text-[10px] font-bold">自動生成</button>
                    </div>

                    <button onclick="syncData()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl text-xs shadow-lg hover:bg-indigo-700 transition">同步雲端資料</button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
                    <h2 class="text-2xl font-black text-slate-800 mb-8 border-b pb-4">新增引流捕捉器</h2>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">第一步：引流分類</label>
                                <select id="category" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm focus:ring-4 ring-indigo-50 outline-none">
                                    <option value="health">💉 健康管理 (產品/諮詢)</option>
                                    <option value="biz">💎 事業招募 (夥伴)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">第二步：觸發關鍵字</label>
                                <input id="keyword" type="text" placeholder="例如：想了解、領取" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm focus:ring-4 ring-indigo-50 outline-none transition">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">第三步：匹配模式</label>
                                <select id="matchMode" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm focus:ring-4 ring-indigo-50 outline-none transition">
                                    <option value="includes">包含即可 ✨</option>
                                    <option value="exact">精確相等</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">第四步：感性回覆文案</label>
                            <textarea id="replyText" rows="10" placeholder="收到！因為我曾經看過家人受健康所苦，所以特別整理了..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm outline-none"></textarea>
                        </div>
                    </div>

                    <div class="mt-6 bg-slate-50 p-5 rounded-3xl border border-slate-100">
                        <label class="block text-xs font-bold text-slate-500 mb-3">第五步：引流目標網址 (LINE/見證 PDF)</label>
                        <div class="flex gap-2 mb-2">
                            <input id="mediaUrl" type="text" placeholder="https://..." class="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none">
                            <button onclick="addAttach()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold">新增</button>
                        </div>
                        <div id="attachList" class="flex flex-wrap gap-2"></div>
                    </div>

                    <button onclick="saveRule()" class="mt-8 w-full gradient-bg text-white font-black py-5 rounded-2xl shadow-2xl hover:opacity-90 transition transform active:scale-95 text-lg">
                        儲存規則並更新代碼 🚀
                    </button>
                </div>

                <div class="bg-slate-900 p-8 rounded-3xl shadow-2xl relative border-t-8 border-indigo-500">
                    <h3 class="text-indigo-400 font-mono text-[10px] font-bold mb-4 uppercase">最後一步：複製代碼到 GAS (記得要在粉專環境下運行)</h3>
                    <button onclick="copyCode()" class="absolute top-6 right-8 bg-indigo-600 text-white px-5 py-2 rounded-full text-xs hover:bg-indigo-500">複製代碼</button>
                    <pre id="outputCode" class="text-indigo-300 font-mono text-[9px] overflow-x-auto leading-loose h-[250px]"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rules = [];
        let currentAttach = [];

        function initData() { renderUI(); }

        function generateToken() {
            const randomToken = 'GAVIN_' + Math.random().toString(36).substr(2, 9).toUpperCase();
            document.getElementById('verifyToken').value = randomToken;
            renderUI();
        }

        function addAttach() {
            const url = document.getElementById('mediaUrl').value;
            if(!url) return;
            currentAttach.push(url);
            renderAttach();
            document.getElementById('mediaUrl').value = '';
            renderUI();
        }

        function renderAttach() {
            document.getElementById('attachList').innerHTML = currentAttach.map((url, i) => `
                <div class="bg-indigo-600 text-white px-3 py-1 rounded-full flex items-center text-[10px]">
                    <span class="truncate max-w-[150px]">${url}</span>
                    <button onclick="currentAttach.splice(${i},1);renderAttach();renderUI()" class="ml-2">✕</button>
                </div>`).join('');
        }

        function saveRule() {
            const key = document.getElementById('accountKey').value;
            const kw = document.getElementById('keyword').value;
            const text = document.getElementById('replyText').value;

            if(!key || !kw || !text) return alert('獅子座教練，欄位別漏填喔！🦁');

            rules.push({ 
                keyword: kw, 
                category: document.getElementById('category').value,
                mode: document.getElementById('matchMode').value, 
                text: text, 
                attachments: [...currentAttach] 
            });
            
            localStorage.setItem('v26_vault_' + key, JSON.stringify(rules));
            renderUI();
            
            document.getElementById('keyword').value = '';
            document.getElementById('replyText').value = '';
            currentAttach = [];
            renderAttach();
            alert('規則儲存成功！');
        }

        function syncData() {
            const key = document.getElementById('accountKey').value;
            if(!key) return alert('請先輸入識別碼');
            const data = localStorage.getItem('v26_vault_' + key);
            rules = data ? JSON.parse(data) : [];
            renderUI();
            alert('同步成功！已從 LocalStorage 載入資料。');
        }

        function renderUI() {
            const vToken = document.getElementById('verifyToken').value || "GAVIN_TOKEN_2027";
            const codeTemplate = `/**
 * GAVIN AI FLOW V2.6 - 自動化引流大腦
 * 🚀 目標：2027 鑽石 | 2026 淨資產 700 萬
 * ⚠️ 注意：此代碼僅適用於 FB 粉絲專頁與 IG 商業帳號
 */

const VERIFY_TOKEN = "${vToken}"; 
const ACCESS_TOKEN = "YOUR_PAGE_ACCESS_TOKEN"; // 需從 Meta Developer 取得
const SHEET_NAME = "Real-time_Leads";

const REPLY_RULES = ${JSON.stringify(rules, null, 2)};

function doGet(e) {
  let mode = e.parameter["hub.mode"];
  let token = e.parameter["hub.verify_token"];
  let challenge = e.parameter["hub.challenge"];
  
  if (mode && token) {
    if (mode === "subscribe" && token === VERIFY_TOKEN) {
      return ContentService.createTextOutput(challenge);
    }
  }
  return ContentService.createTextOutput("System Active");
}

function doPost(e) {
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  let data = JSON.parse(e.postData.contents);
  
  if (data.entry && data.entry[0].changes) {
    let change = data.entry[0].changes[0].value;
    let message = change.message || "";
    let senderName = change.from ? change.from.name : "未知用戶";
    let commentId = change.comment_id;

    REPLY_RULES.forEach(rule => {
      let isMatch = rule.mode === "includes" ? message.includes(rule.keyword) : message === rule.keyword;
      
      if (isMatch) {
        // A. 記錄名單
        sheet.appendRow([new Date(), "FB/IG", senderName, message, rule.category, "待聯繫"]);
        
        // B. 自動回覆
        sendReply(commentId, rule.text + " " + (rule.attachments[0] || ""));
      }
    });
  }
  return ContentService.createTextOutput("OK");
}

function sendReply(id, text) {
  let url = "https://graph.facebook.com/v18.0/" + id + "/comments";
  UrlFetchApp.fetch(url, {
    method: "post",
    payload: { message: text, access_token: ACCESS_TOKEN }
  });
}`;
            document.getElementById('outputCode').innerText = codeTemplate;
        }

        function copyCode() {
            const code = document.getElementById('outputCode').innerText;
            navigator.clipboard.writeText(code).then(() => alert('代碼已複製！記得去 GAS 貼上並佈署為 Web App 👑'));
        }
    </script>
</body>
</html>
