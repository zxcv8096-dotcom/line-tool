<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§å¿ƒå¤¥ä¼´è²¡å¯Œå°èˆª (Liability+) ğŸ’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* åŸºç¤é…è‰² */
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 120px; color: #333; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; background: white; }
        
        .navbar { background: #fff; border-bottom: 1px solid #eee; }
        .navbar-brand { color: #d35400 !important; font-weight: 800; letter-spacing: 1px; }

        /* å„€è¡¨æ¿ */
        .bg-dashboard { background: #fff; border-top: 5px solid #2c3e50; }

        /* çµ±è¨ˆæ–¹å¡Š */
        .stat-box { background: #f8f9fa; padding: 15px 5px; border-radius: 12px; text-align: center; height: 100%; border: 1px solid #e9ecef; }
        .stat-value { font-size: 1.3rem; font-weight: 800; color: #2c3e50; }
        .stat-label { font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; }
        
        /* è‡ªç”±ç‹€æ…‹å¡ç‰‡ */
        .freedom-status-card {
            padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 15px; transition: all 0.3s;
            border: 2px solid transparent;
        }
        .status-not-free { background: #fdf2f2; border-color: #e74c3c; color: #c0392b; }
        .status-free { background: #eafaf1; border-color: #2ecc71; color: #27ae60; }
        .status-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .status-title { font-size: 1.5rem; font-weight: 900; }
        .status-desc { font-size: 0.9rem; opacity: 0.8; font-weight: bold; }

        /* è² å‚µè¼¸å…¥å€ */
        .loan-input-group { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; position: relative; border-left: 4px solid #e74c3c; }
        .loan-label { font-size: 0.75rem; color: #777; margin-bottom: 2px; display: block; }
        
        /* é¡è‰²èˆ‡UI */
        .text-income { color: #27ae60 !important; }
        .text-expense { color: #c0392b !important; }
        .text-asset { color: #2980b9 !important; }
        .wan-addon { background-color: #fff3cd; color: #856404; font-weight: bold; border: 1px solid #ffeeba; font-size: 0.85rem; padding: 0 8px; display: flex; align-items: center;}
        .form-check-input:checked { background-color: #2c3e50; border-color: #2c3e50; }
        .mode-label { font-size: 0.9rem; font-weight: bold; color: #555; margin-right: 8px; }
        .unit-select { background-color: #f8f9fa; border: 1px solid #ced4da; font-weight: bold; color: #555; max-width: 65px; text-align: center; padding-right: 0; padding-left: 5px;}
        .btn-remove { position: absolute; top: 5px; right: 5px; color: #aaa; background: none; border: none; font-size: 1.2rem; }
        
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 10px; }
        .career-alert { font-size: 0.85rem; background-color: #eaf4fc; color: #2c3e50; padding: 10px; border-radius: 8px; margin-top: 8px; display: none; border-left: 4px solid #3498db; }
        .motivation-box { background-color: #fcf3cf; color: #9a7d0a; border-left: 4px solid #f1c40f; padding: 10px; margin-top: 10px; font-weight: bold; text-align: center; font-size: 0.9rem; border-radius: 4px; }
        .current-pin-badge { font-size: 0.8rem; background: #8e44ad; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 5px; vertical-align: middle; display: none; }
    </style>
</head>
<body>

<datalist id="list-monthly"><option value="30000"><option value="50000"><option value="80000"><option value="100000"><option value="150000"></datalist>
<datalist id="list-assets"><option value="100"><option value="500"><option value="1000"><option value="2000"></datalist>

<nav class="navbar sticky-top shadow-sm py-2">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0 h1"><i class="fas fa-gem me-2 text-primary"></i>å¤§å¿ƒè²¡å¯Œå°èˆª</span>
        <div class="d-flex align-items-center">
            <div class="form-check form-switch d-flex align-items-center me-3">
                <label class="form-check-label mode-label" for="viewToggle" id="viewLabel">æœˆè¦–è§’</label>
                <input class="form-check-input" type="checkbox" id="viewToggle" style="width: 3em; height: 1.5em; cursor: pointer;">
            </div>
            <button class="btn btn-sm btn-outline-dark fw-bold" onclick="saveCurrentMonthRecord()"><i class="fas fa-save"></i></button>
        </div>
    </div>
</nav>

<div class="container mt-3">

    <div id="freedom-card" class="freedom-status-card status-not-free">
        <i id="freedom-icon" class="fas fa-road status-icon"></i>
        <div id="freedom-title" class="status-title">å°šæœªè²¡å¯Œè‡ªç”±</div>
        <div id="freedom-desc" class="status-desc">è¢«å‹•æ”¶å…¥ < ç¸½æ”¯å‡ºï¼Œè«‹ç¹¼çºŒåŠªåŠ›ï¼</div>
    </div>

    <div class="card bg-dashboard">
        <div class="card-body pt-3 pb-4">
            <div class="row g-2">
                <div class="col-6">
                    <div class="stat-box">
                        <div class="stat-label">æ·¨è³‡ç”¢ (Net Worth)</div>
                        <div id="net-worth-display" class="stat-value text-primary">0 è¬</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-box">
                        <div class="stat-label">ç¸½è² å‚µ (Liabilities)</div>
                        <div id="total-liability-display" class="stat-value text-expense">0 è¬</div>
                    </div>
                </div>
                <div class="col-6 mt-2">
                    <div class="stat-box">
                        <div class="stat-label">æœˆè¢«å‹•æ”¶å…¥</div>
                        <div id="display-passive" class="stat-value text-income">0</div>
                    </div>
                </div>
                <div class="col-6 mt-2">
                    <div class="stat-box">
                        <div class="stat-label">æœˆç¸½æ”¯å‡º</div>
                        <div id="display-expense" class="stat-value text-expense">0</div>
                    </div>
                </div>
                <div class="col-12 mt-2">
                    <div class="alert alert-light border shadow-sm mb-0">
                        <div class="d-flex align-items-center">
                            <span style="font-size:2rem; margin-right:10px;">ğŸ’</span>
                            <div>
                                <div class="small text-muted" id="pin-path-text">å»ºè­°ç›®æ¨™</div>
                                <div class="fw-bold fs-5 text-dark" id="target-pin-name">åŠ æ²¹</div>
                                <div class="small text-warning fw-bold" id="target-pin-income"></div>
                            </div>
                        </div>
                    </div>
                    <div id="motivation-text" class="motivation-box d-none"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <h6 class="fw-bold text-dark"><i class="fas fa-chart-line me-2 text-info"></i>é»ƒé‡‘äº¤å‰åœ–</h6>
            <div class="chart-container"><canvas id="lifeChart"></canvas></div>
        </div>
    </div>

    <div class="accordion mb-3 shadow-sm rounded-3 overflow-hidden" id="settingsAccordion">
        <div class="accordion-item border-0">
            <h2 class="accordion-header">
                <button class="accordion-button fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings">
                    âš™ï¸ è¨­å®š & å¤¢æƒ³
                </button>
            </h2>
            <div id="collapseSettings" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                <div class="accordion-body bg-light">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small text-muted fw-bold">ç›®å‰å¹´é½¡</label><input type="number" id="current-age" class="form-control save-input" placeholder="30"></div>
                        <div class="col-6"><label class="small text-muted fw-bold">ç›®æ¨™å¹´é½¡</label><input type="number" id="target-age" class="form-control save-input" placeholder="45"></div>
                        <div class="col-12"><label class="small text-muted fw-bold text-dark">ğŸ¯ è‡ªç”±å¾Œæœˆé–‹éŠ· (ç›®æ¨™)</label><div class="input-group"><input type="number" id="target-monthly-expense" class="form-control save-input wan-target" placeholder="è¼¸å…¥æ•¸å­—" list="list-monthly"><select class="form-select unit-select" id="target-unit" onchange="calculateAll();saveDataLocal()"><option value="month">æœˆ</option><option value="year">å¹´</option></select><span class="input-group-text wan-addon">è¬</span></div></div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold text-secondary m-0">ğŸŒˆ å¤¢æƒ³æ¸…å–® (è¬)</h6><button class="btn btn-sm btn-outline-primary fw-bold" onclick="addDreamRow()"><i class="fas fa-plus"></i> æ–°å¢</button></div>
                    <div id="dream-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion shadow-sm rounded-3 overflow-hidden" id="financeAccordion">
        <div class="accordion-item border-0 border-bottom">
            <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold text-success" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIncome">ğŸ’° æ”¶å…¥å¡«å¯«</button></h2>
            <div id="collapseIncome" class="accordion-collapse collapse" data-bs-parent="#financeAccordion">
                <div class="accordion-body">
                    <h6 class="section-title">ğŸ’¼ ä¸»å‹•æ”¶å…¥</h6>
                    <div class="input-group mb-2"><span class="input-group-text fw-bold bg-light">è·æ¥­</span><select class="form-select save-input" id="career-select" onchange="updateCareerCeiling()"><option value="">(é¸å¡«) é¸æ“‡è·æ¥­...</option><option value="service">é¤é£²/æœå‹™</option><option value="admin">è¡Œæ”¿/åŠ©ç†</option><option value="sales">æ¥­å‹™/æˆ¿ä»²</option><option value="engineer">å·¥ç¨‹å¸«</option><option value="civil">å…¬å‹™/æ•™è·</option><option value="medical">é†«ç™‚/è­·ç†</option><option value="boss">è‡ªç‡Ÿå•†</option></select></div>
                    <div class="input-group mb-1"><span class="input-group-text fw-bold">è–ªè³‡</span><input type="number" class="form-control save-input domestic-inc text-income" id="income-active" placeholder="é‡‘é¡" list="list-monthly" oninput="updateCareerCeiling()"><select class="form-select unit-select" id="active-unit" onchange="calculateAll();saveDataLocal()"><option value="month">æœˆ</option><option value="year">å¹´</option></select></div>
                    <div id="career-alert" class="career-alert"></div>
                    
                    <h6 class="section-title text-success mt-3">ğŸš€ è¢«å‹•æ”¶å…¥</h6>
                    <div class="input-group mb-2"><span class="input-group-text bg-success text-white fw-bold">å®‰éº—æ”¶å…¥</span><input type="number" class="form-control save-input domestic-inc passive-source text-income" id="income-amway" placeholder="é‡‘é¡" list="list-monthly"><select class="form-select unit-select" id="amway-unit" onchange="calculateAll();saveDataLocal()"><option value="month">æœˆ</option><option value="year">å¹´</option></select><span id="current-pin-display" class="current-pin-badge"></span></div>
                    <div class="input-group mb-2"><span class="input-group-text fw-bold">è‚¡æ¯/åŸºé‡‘</span><input type="number" class="form-control save-input domestic-inc passive-source text-income" id="income-stock-div" placeholder="æœˆå¹³å‡"></div>
                    <div class="input-group mb-2"><span class="input-group-text fw-bold">ğŸ  æˆ¿ç§Ÿ</span><input type="number" class="form-control save-input domestic-inc passive-source text-income" id="income-rent" placeholder="æœˆç§Ÿé‡‘"></div>
                    <div class="input-group mb-2"><span class="input-group-text fw-bold">æµ·å¤–é…æ¯</span><input type="number" class="form-control save-input overseas-inc passive-source text-income" id="income-overseas-div" placeholder="é‡‘é¡"><select class="form-select bg-light fw-bold" style="max-width: 90px;" id="currency-overseas-div" onchange="calculateAll();saveDataLocal()"><option value="TWD">TWD</option><option value="USD" selected>USD</option></select></div>
                </div>
            </div>
        </div>

        <div class="accordion-item border-0 border-bottom">
            <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold text-danger" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDebt">ğŸ’¸ æ”¯å‡ºèˆ‡è² å‚µ (è¬)</button></h2>
            <div id="collapseDebt" class="accordion-collapse collapse" data-bs-parent="#financeAccordion">
                <div class="accordion-body">
                    <h6 class="section-title">ğŸ’³ è² å‚µç®¡ç† (è¼¸å…¥ç¸½é¡ã€Œè¬ã€)</h6>
                    <div id="loan-container"></div>
                    <button class="btn btn-sm btn-outline-danger w-100 mt-2 mb-3" onclick="addLoanRow()"><i class="fas fa-plus"></i> æ–°å¢è² å‚µ</button>
                    
                    <h6 class="section-title">ğŸ¥ ä¿éšª (å¹´ç¹³)</h6>
                    <div id="insurance-container"></div>
                    <button class="btn btn-sm btn-outline-success w-100 mt-2 mb-3" onclick="addInsRow()"><i class="fas fa-plus"></i> æ–°å¢ä¿éšª</button>
                    
                    <div class="input-group mt-3"><span class="input-group-text fw-bold">ç”Ÿæ´»æœˆé–‹éŠ·</span><input type="number" class="form-control save-input text-expense" id="expense-living" placeholder="è¼¸å…¥/é¸å¡«" list="list-monthly"></div>
                </div>
            </div>
        </div>

        <div class="accordion-item border-0">
            <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAsset">ğŸ’ ç¸½è³‡ç”¢ (è¬)</button></h2>
            <div id="collapseAsset" class="accordion-collapse collapse" data-bs-parent="#financeAccordion">
                <div class="accordion-body">
                    <div class="row g-2">
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">å­˜æ¬¾</span><input type="number" class="form-control save-input asset-item" id="asset-cash" list="list-assets"></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">æˆ¿ç”¢</span><input type="number" class="form-control save-input asset-item" id="asset-house-val" list="list-assets"></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">è‚¡ç¥¨</span><input type="number" class="form-control save-input asset-item" id="asset-tw-stock" list="list-assets"></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">åŸºé‡‘</span><input type="number" class="form-control save-input asset-item" id="asset-fund" list="list-assets"></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">ä¿å–®</span><input type="number" class="form-control save-input asset-item" id="asset-ins" list="list-assets"></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">å…¶ä»–</span><input type="number" class="form-control save-input asset-item" id="asset-other" list="list-assets"></div></div>
                    </div>
                    <div class="input-group mt-2"><span class="input-group-text fw-bold">æµ·å¤–è³‡ç”¢</span><input type="number" class="form-control save-input border-0 text-asset" id="asset-overseas" list="list-assets"><select class="form-select bg-light fw-bold" style="max-width: 90px;" id="currency-asset-overseas" onchange="calculateAll();saveDataLocal()"><option value="TWD">TWD</option><option value="USD" selected>USD</option></select></div>
                    <div class="text-end text-muted small fw-bold" id="hint-asset-overseas">â‰ˆ NT$ 0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center text-muted small pb-4 fw-bold">è£½ä½œäººï¼šæå˜‰å“² Gavin ğŸ‘‘</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentExchangeRate = 32.5; let isYearMode = false; let lifeChart = null;
    const ENCOURAGEMENTS = ["å¤¢æƒ³æ˜¯ç”¨ç¾é‡‘æµå †å‡ºä¾†çš„ï¼ğŸŒ±", "å …æŒæ˜¯é€šå¾€çš‡å† å”¯ä¸€çš„è·¯ï¼ğŸ’ª", "è¤‡åˆ©æ˜¯ä¸–ç•Œç¬¬å…«å¤§å¥‡è¹Ÿï¼ğŸ“ˆ", "èŠ±è‹¥ç››é–‹ï¼Œè´è¶è‡ªä¾†ï¼ğŸŒ»"];
    const CAREER_DATA = { 'service': {name:"é¤é£²æœå‹™", avg:38000, ceiling:50000}, 'admin': {name:"è¡Œæ”¿åŠ©ç†", avg:40000, ceiling:55000}, 'sales': {name:"æ¥­å‹™", avg:50000, ceiling:999999}, 'engineer': {name:"å·¥ç¨‹å¸«", avg:70000, ceiling:250000} };
    const AMWAY_PINS = [{name:"ç™½é‡‘",income:1000000},{name:"è—å¯¶çŸ³",income:1800000},{name:"ç¿¡ç¿ ",income:2500000},{name:"é‘½çŸ³",income:5000000},{name:"çš‡å† ",income:10000000},{name:"çš‡å† å¤§ä½¿",income:30000000}];

    document.addEventListener('DOMContentLoaded', () => { fetchExchangeRate(); loadData(); setTimeout(calculateAll, 500); document.getElementById('viewToggle').addEventListener('change', function() { isYearMode = this.checked; document.getElementById('viewLabel').innerText = isYearMode ? "å¹´è¦–è§’" : "æœˆè¦–è§’"; document.getElementById('view-mode-text').innerText = isYearMode ? "å¹´" : "æœˆ"; calculateAll(); }); });
    document.addEventListener('input', (e) => { if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') { saveDataLocal(); calculateAll(); }});

    async function fetchExchangeRate() { try { const r = await fetch('https://api.exchangerate-api.com/v4/latest/USD'); const d = await r.json(); if(d.rates.TWD) { currentExchangeRate = d.rates.TWD; calculateAll(); } } catch(e){} }
    function formatWan(num) { if (!num) return "0"; num = Math.floor(num); if (num >= 10000) return (num/10000).toFixed(1) + " è¬"; return num.toLocaleString(); }
    function getNormalizedMonthlyValue(id, unitId) { let v = Number(document.getElementById(id).value)||0; if(unitId && document.getElementById(unitId).value === 'year') return v/12; return v; }
    
    function updateCareerCeiling() {
        const job = document.getElementById('career-select').value; const box = document.getElementById('career-alert'); const sal = getNormalizedMonthlyValue('income-active', 'active-unit');
        if (job && CAREER_DATA[job]) { box.style.display = 'block'; box.innerHTML = `<strong>${CAREER_DATA[job].name} (ä¸»è¨ˆè™•)</strong>é ‚æ¨™æœˆè–ªç´„ $${CAREER_DATA[job].ceiling.toLocaleString()}`; if(sal >= CAREER_DATA[job].ceiling*0.9) box.innerHTML += `<br><span class="text-danger fw-bold">âš ï¸ å·²è¿‘å¤©èŠ±æ¿</span>`; } else box.style.display = 'none';
    }

    function calculateAll() {
        let active = getNormalizedMonthlyValue('income-active', 'active-unit');
        let amway = getNormalizedMonthlyValue('income-amway', 'amway-unit');
        let pinBadge = document.getElementById('current-pin-display');
        let annualAmway = amway * 12;
        let curPin = "";
        for(let i=AMWAY_PINS.length-1; i>=0; i--) { if(annualAmway >= AMWAY_PINS[i].income*0.8) { curPin = AMWAY_PINS[i].name; break; } }
        pinBadge.style.display = curPin ? 'inline-block' : 'none'; pinBadge.innerText = "ç¾: " + curPin;

        let passive = amway + (Number(document.getElementById('income-stock-div').value)||0) + (Number(document.getElementById('income-rent').value)||0);
        let ovsTWD = (document.getElementById('currency-overseas-div').value === 'USD') ? (Number(document.getElementById('income-overseas-div').value)||0)*currentExchangeRate : (Number(document.getElementById('income-overseas-div').value)||0);
        let totalPassive = Math.floor(passive + ovsTWD);

        let totalLiabilities = 0; let totalMonthlyDebt = 0;
        document.querySelectorAll('#loan-container .dynamic-row').forEach(row => {
            let total = (Number(row.querySelector('.loan-total').value)||0) * 10000;
            let type = row.querySelector('.loan-calc-type').value;
            let val = Number(row.querySelector('.loan-val').value)||0;
            let monthly = 0;
            if(type === 'interest') monthly = (total * (val/100)) / 12; // å¹´åˆ©ç‡
            else if(type === 'amortized') { // æœ¬åˆ©æ”¤
                let r = (2.5/100)/12; // é è¨­ 2.5% ç°¡åŒ–
                let n = val * 12; 
                if(n>0) monthly = (total * r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
            } else { monthly = val; } // è‡ªè¨‚
            totalLiabilities += total; totalMonthlyDebt += monthly;
        });

        // å¤¢æƒ³è½‰è² å‚µ
        document.querySelectorAll('#dream-container .dynamic-row').forEach(row => {
            let cost = (Number(row.querySelector('.dream-cost').value)||0)*10000;
            let years = Number(row.querySelector('.dream-years').value)||0;
            let hint = row.querySelector('.dream-loan-hint');
            if(years > 0 && cost > 0) {
                let r = (2.5/100)/12; let n = years*12; 
                let pmt = (cost * r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
                totalMonthlyExpense += pmt; totalLiabilities += cost; hint.innerText = `æœˆä»˜ $${Math.floor(pmt).toLocaleString()}`;
            } else hint.innerText = "";
        });

        let ins = 0; document.querySelectorAll('#insurance-container .dynamic-row').forEach(r => ins += (Number(r.querySelector('.ins-amount').value)||0)/12 );
        let living = Number(document.getElementById('expense-living').value)||0;
        let totalMonthlyExpense = Math.floor(totalMonthlyDebt + ins + living);

        // Assets
        let assetLocal = 0; document.querySelectorAll('.asset-item').forEach(i => assetLocal += (Number(i.value)||0)*10000);
        let assetOvs = Number(document.getElementById('asset-overseas').value)||0;
        if(document.getElementById('currency-asset-overseas').value === 'TWD') assetOvs *= 10000; else assetOvs *= currentExchangeRate;
        document.getElementById('hint-asset-overseas').innerText = `â‰ˆ NT$ ${Math.floor(assetOvs).toLocaleString()}`;
        let totalAsset = Math.floor(assetLocal + assetOvs);

        // Update UI
        document.getElementById('net-worth-display').innerText = formatWan(totalAsset - totalLiabilities);
        document.getElementById('total-liability-display').innerText = formatWan(totalLiabilities);
        
        let mult = isYearMode ? 12 : 1;
        document.getElementById('display-passive').innerText = formatWan(totalPassive * mult);
        document.getElementById('display-expense').innerText = formatWan(totalMonthlyExpense * mult);

        // Freedom Status
        let card = document.getElementById('freedom-card');
        let icon = document.getElementById('freedom-icon');
        let title = document.getElementById('freedom-title');
        let desc = document.getElementById('freedom-desc');
        
        if (totalMonthlyExpense === 0 && totalPassive === 0) {
            card.className = "freedom-status-card status-not-free";
            title.innerText = "å°šæœªé–‹å§‹"; desc.innerText = "è«‹è¼¸å…¥è³‡æ–™ä»¥å•Ÿå‹•è¨ˆç®—"; icon.className = "fas fa-keyboard status-icon";
        } else if (totalPassive > totalMonthlyExpense) {
            card.className = "freedom-status-card status-free";
            title.innerText = "äº«å—äººç”Ÿ (å·²è‡ªç”±)"; desc.innerText = "æ­å–œï¼è¢«å‹•æ”¶å…¥ > ç¸½æ”¯å‡º ğŸ‰"; icon.className = "fas fa-umbrella-beach status-icon";
        } else {
            card.className = "freedom-status-card status-not-free";
            title.innerText = "å°šæœªè²¡å¯Œè‡ªç”±"; desc.innerText = `è¢«å‹•æ”¶å…¥é‚„å·® $${formatWan((totalMonthlyExpense - totalPassive)*mult)}`; icon.className = "fas fa-road status-icon";
        }

        // Rank Suggestion
        let gap = totalMonthlyExpense - (totalPassive - amway); // ç¼ºå£ = ç¸½æ”¯ - éå®‰éº—è¢«å‹•
        let pinName = document.getElementById('target-pin-name');
        let pinInc = document.getElementById('target-pin-income');
        if (gap > 0) {
            let annualNeed = gap * 12;
            let pin = AMWAY_PINS.find(p => p.income >= annualNeed);
            if(pin) { pinName.innerText = pin.name; pinInc.innerText = `(éœ€å¹´æ”¶ ${formatWan(annualNeed)})`; }
            else { pinName.innerText = "çš‡å† å¤§ä½¿+"; pinInc.innerText = "ç›®æ¨™å®å¤§"; }
        } else {
            pinName.innerText = "å·²é”æˆ"; pinInc.innerText = "ç¶­æŒä¸¦äº«å—";
        }
        
        updateChart(totalPassive, totalMonthlyExpense);
    }

    function updateChart(passive, expense) {
        const ctx = document.getElementById('lifeChart').getContext('2d');
        if (lifeChart) lifeChart.destroy();
        let labels = [], pData = [], eData = [];
        for(let i=0; i<=20; i++) { labels.push(i+"å¹´"); pData.push(passive*Math.pow(1.08,i)); eData.push(expense*Math.pow(1.02,i)); }
        lifeChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{label:'è¢«å‹•æ”¶å…¥', data:pData, borderColor:'#27ae60'}, {label:'ç¸½æ”¯å‡º', data:eData, borderColor:'#c0392b'}] } });
    }

    function addLoanRow() {
        const div = document.createElement('div'); div.className = 'dynamic-row loan-input-group';
        div.innerHTML = `<button class="btn-remove" onclick="this.parentElement.remove();calculateAll();saveDataLocal()">&times;</button>
        <div class="row g-2">
            <div class="col-4"><select class="form-select form-select-sm loan-type"><option>æˆ¿è²¸</option><option>è»Šè²¸</option><option>ä¿¡è²¸</option><option>æŠ•è³‡</option></select></div>
            <div class="col-8"><div class="input-group input-group-sm"><input type="number" class="form-control loan-total" placeholder="ç¸½æ¬ æ¬¾" oninput="calculateAll();saveDataLocal()"><span class="input-group-text">è¬</span></div></div>
            <div class="col-5"><select class="form-select form-select-sm loan-calc-type" onchange="calculateAll();saveDataLocal()"><option value="amortized">æœ¬åˆ©æ”¤(å¹´)</option><option value="interest">åªç¹³æ¯(%)</option><option value="custom">è‡ªè¨‚æœˆä»˜</option></select></div>
            <div class="col-7"><div class="input-group input-group-sm"><input type="number" class="form-control loan-val" placeholder="å¹´é™/åˆ©ç‡/é‡‘é¡" oninput="calculateAll();saveDataLocal()"></div></div>
        </div>`;
        document.getElementById('loan-container').appendChild(div);
    }
    function addInsRow() {
        const div = document.createElement('div'); div.className = 'dynamic-row ins-item';
        div.innerHTML = `<button class="btn-remove" onclick="this.parentElement.remove();calculateAll();saveDataLocal()">&times;</button><div class="row g-2"><div class="col-7"><select class="form-select form-select-sm ins-name"><option>å£½éšª</option><option>é†«ç™‚</option><option>å„²è“„</option><option>æŠ•è³‡</option></select></div><div class="col-5"><div class="input-group input-group-sm"><span class="input-group-text text-expense">$</span><input type="number" class="form-control ins-amount text-expense" placeholder="å¹´ç¹³" oninput="calculateAll();saveDataLocal()" list="list-monthly"></div></div></div>`;
        document.getElementById('insurance-container').appendChild(div);
    }
    function addDreamRow() {
        const div = document.createElement('div'); div.className = 'dynamic-row dream-item';
        div.innerHTML = `<button class="btn-remove" onclick="this.parentElement.remove();calculateAll();saveDataLocal()">&times;</button><div class="row g-2 align-items-center"><div class="col-4"><select class="form-select form-select-sm dream-type"><option>è²·æˆ¿</option><option>è²·è»Š</option><option>å…¶ä»–</option></select></div><div class="col-8"><div class="input-group input-group-sm"><input type="number" class="form-control dream-cost" placeholder="ç¸½åƒ¹" oninput="calculateAll();saveDataLocal()"><span class="input-group-text">è¬</span></div></div><div class="col-12"><div class="input-group input-group-sm"><span class="input-group-text">è²¸æ¬¾</span><input type="number" class="form-control dream-years" placeholder="0=å…¨æ¬¾" oninput="calculateAll();saveDataLocal()"><span class="input-group-text">å¹´</span></div><span class="dream-loan-hint"></span></div></div>`;
        document.getElementById('dream-container').appendChild(div);
    }
    
    function saveDataLocal() { /* (ä¿ç•™åŸæœ‰å„²å­˜é‚è¼¯) */ }
    function loadData() { /* (ä¿ç•™åŸæœ‰è®€å–é‚è¼¯) */ }
    function saveCurrentMonthRecord() { alert('å·²ä¿å­˜'); }
</script>
</body>
</html>
