<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§å¿ƒå¤¥ä¼´è²¡å¯Œå°èˆª (Ultimate) ğŸ’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- æ˜äº®ç§‘æŠ€é¢¨ä¸»é¡Œ --- */
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
            --tech-bg: #f0f4f8;
        }

        body { background-color: var(--tech-bg); font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 120px; color: var(--dark); }
        .card { border: none; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; background: white; overflow: hidden; }
        
        /* å°èˆª */
        .navbar { background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .navbar-brand { color: var(--primary) !important; font-weight: 800; letter-spacing: 1px; }

        /* å„€è¡¨æ¿ */
        .bg-dashboard { border-top: 5px solid var(--primary); }

        /* çµ±è¨ˆæ–¹å¡Š */
        .stat-box { 
            background: #ffffff; padding: 15px 5px; border-radius: 12px; text-align: center; height: 100%; 
            border: 1px solid #e9ecef; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.2s;
        }
        .stat-box:hover { transform: translateY(-3px); border-color: var(--primary); }
        .stat-value { font-size: 1.2rem; font-weight: 800; color: var(--dark); }
        .stat-label { font-size: 0.8rem; color: var(--secondary); margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        
        /* é æ¸¬å°æ¯”å€ (æ ¸å¿ƒ) */
        .prediction-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border: 1px solid #90caf9; border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .pred-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.95rem; }
        .pred-badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; }
        .badge-job { background: #e9ecef; color: #495057; }
        .badge-amway { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        /* ç¸½çµåˆ†æå€ */
        .summary-box {
            background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 15px;
            font-size: 0.9rem; color: #856404; font-weight: bold; line-height: 1.6;
        }

        /* è¼¸å…¥æ¡†å„ªåŒ– */
        .input-group-text { background-color: #f8f9fa; border-color: #ced4da; font-weight: 600; font-size: 0.9rem; }
        .form-control { border-color: #ced4da; font-weight: 600; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15); }
        
        /* è¬å–®ä½æç¤º (Wan Hint) */
        .wan-hint-badge {
            background-color: #fff8e1; color: #d35400; font-size: 0.8rem; font-weight: bold;
            padding: 0 10px; border: 1px solid #ffe0b2; border-left: 0;
            white-space: nowrap; min-width: 70px; text-align: center; 
            display: flex; align-items: center; justify-content: center;
        }
        
        /* é¡è‰²å®šç¾© */
        .text-income { color: var(--success) !important; }
        .text-expense { color: var(--danger) !important; }
        .text-asset { color: var(--primary) !important; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .dynamic-row { background-color: #fff; border-radius: 10px; padding: 12px; margin-bottom: 10px; border: 1px solid #e9ecef; border-left-width: 5px; position: relative; }
        .dream-item { border-left-color: #6f42c1; }
        .loan-item { border-left-color: #e74c3c; }
        .ins-item { border-left-color: #2ecc71; }
        .btn-remove { position: absolute; top: 5px; right: 5px; color: #adb5bd; background: none; border: none; font-size: 1.2rem; }
        .btn-remove:hover { color: var(--danger); }

        .dream-loan-hint { font-size: 0.75rem; color: #e74c3c; font-weight: bold; display: block; text-align: right; margin-top: 4px; }
        
        /* è˜ä½åœ–å¡ */
        .pin-card {
            background: #fff; border: 1px solid #dee2e6; border-left: 5px solid var(--primary);
            border-radius: 12px; padding: 15px; display: flex; align-items: center; margin-top: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .pin-icon { font-size: 3rem; margin-right: 15px; }
        .pin-title { font-weight: 900; font-size: 1.3rem; color: var(--dark); }
        .chart-container { position: relative; height: 260px; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<nav class="navbar sticky-top shadow-sm py-2">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0 h1"><i class="fas fa-rocket me-2"></i>å¤§å¿ƒè²¡å¯Œå°èˆª</span>
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-primary fw-bold rounded-pill px-3" onclick="saveCurrentMonthRecord()">
                <i class="fas fa-save me-1"></i> ç´€éŒ„
            </button>
        </div>
    </div>
</nav>

<div class="container mt-3">

    <div class="card bg-dashboard">
        <div class="card-body pt-3 pb-4">
            <h5 class="card-title fw-bold text-dark mb-3 small text-uppercase text-muted">
                <i class="fas fa-tachometer-alt me-2"></i>è²¡å‹™é æ¸¬å„€è¡¨æ¿
            </h5>
            
            <div class="prediction-card">
                <div class="pred-row">
                    <span>ğŸ¢ åƒ…é æœ¬æ¥­é”æˆå¹´é½¡</span>
                    <span class="pred-badge badge-job" id="age-job-only">è¨ˆç®—ä¸­...</span>
                </div>
                <div class="pred-row">
                    <span>ğŸš€ åŠ ä¸Šå®‰éº—é”æˆå¹´é½¡</span>
                    <span class="pred-badge badge-amway" id="age-with-amway">è¨ˆç®—ä¸­...</span>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-6">
                    <div class="stat-box">
                        <div class="stat-label">æ·¨è³‡ç”¢ (Net Worth)</div>
                        <div id="net-worth-display" class="stat-value text-primary">0 è¬</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-box">
                        <div class="stat-label">ç¸½è² å‚µ (å«æˆ¿è²¸)</div>
                        <div id="total-liability-display" class="stat-value text-expense">0 è¬</div>
                    </div>
                </div>
                <div class="col-6 mt-2">
                    <div class="stat-box">
                        <div class="stat-label">æœˆç¾é‡‘æµ (çµé¤˜)</div>
                        <div id="monthly-surplus" class="stat-value">0 è¬</div>
                    </div>
                </div>
                <div class="col-6 mt-2">
                    <div class="stat-box">
                        <div class="stat-label">è²¡å¯Œè‡ªç”±åº¦</div>
                        <div id="freedom-ratio" class="stat-value text-success">0%</div>
                    </div>
                </div>
            </div>

            <div id="analysis-summary" class="summary-box" style="display:none;"></div>

            <div class="pin-card" id="pin-card-container" style="display:none;">
                <div class="pin-icon" id="pin-icon">ğŸŒ±</div>
                <div>
                    <div class="small text-muted mb-1">åŠ é€Ÿé”æˆå»ºè­°</div>
                    <div class="pin-title" id="target-pin-name"></div>
                    <div class="small text-primary fw-bold" id="target-pin-income"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="accordion mb-3 shadow-sm rounded-4 overflow-hidden" id="settingsAccordion">
        <div class="accordion-item border-0">
            <h2 class="accordion-header">
                <button class="accordion-button fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings">
                    âš™ï¸ 1. è¨­å®š & å¤¢æƒ³ (è¼¸å…¥çœŸå¯¦é‡‘é¡)
                </button>
            </h2>
            <div id="collapseSettings" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                <div class="accordion-body bg-light">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small text-muted fw-bold">ç›®å‰å¹´é½¡</label><input type="number" id="current-age" class="form-control" placeholder="30"></div>
                        <div class="col-6"><label class="small text-muted fw-bold">æœ¬æ¥­å¹´æ¼²å¹…(%)</label><input type="number" id="salary-growth" class="form-control" value="3" readonly style="background:#e9ecef;"></div>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="small text-muted fw-bold text-dark">ğŸ¯ è‡ªç”±å¾Œæœˆé–‹éŠ·ç›®æ¨™ (å…ƒ)</label>
                        <div class="input-group">
                            <input type="number" id="target-monthly-expense" class="form-control wan-target" placeholder="ä¾‹å¦‚ 100000">
                            <span class="wan-hint-badge" id="hint-target-monthly-expense">0 è¬</span>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-secondary m-0">ğŸŒˆ å¤¢æƒ³æ¸…å–® (è‡ªå‹•ä»£å…¥è²¸æ¬¾)</h6>
                        <button class="btn btn-sm btn-outline-primary fw-bold rounded-pill" onclick="addDreamRow()"><i class="fas fa-plus"></i> æ–°å¢</button>
                    </div>
                    <div id="dream-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion shadow-sm rounded-4 overflow-hidden" id="financeAccordion">
        
        <div class="accordion-item border-0 border-bottom">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed fw-bold text-success" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIncome">
                    ğŸ’° 2. æ”¶å…¥å¡«å¯« (æœˆè–ª)
                </button>
            </h2>
            <div id="collapseIncome" class="accordion-collapse collapse" data-bs-parent="#financeAccordion">
                <div class="accordion-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">æœ¬æ¥­æœˆè–ª</span>
                        <input type="number" class="form-control domestic-inc wan-target" id="income-active" placeholder="ä¾‹å¦‚ 40000">
                        <span class="wan-hint-badge" id="hint-income-active">0 è¬</span>
                    </div>
                    
                    <h6 class="small fw-bold text-success mb-2">ğŸš€ è¢«å‹•æ”¶å…¥</h6>
                    <div class="input-group mb-2">
                        <span class="input-group-text bg-success text-white">å®‰éº—æœˆæ”¶</span>
                        <input type="number" class="form-control domestic-inc passive-source wan-target" id="income-amway" placeholder="ä¾‹å¦‚ 5000">
                        <span class="wan-hint-badge" id="hint-income-amway">0 è¬</span>
                    </div>
                    <div class="input-group mb-2"><span class="input-group-text">è‚¡æ¯æœˆå‡</span><input type="number" class="form-control domestic-inc passive-source wan-target" id="income-stock-div" placeholder="é‡‘é¡"><span class="wan-hint-badge" id="hint-income-stock-div">0 è¬</span></div>
                    <div class="input-group mb-2"><span class="input-group-text">æˆ¿ç§Ÿæœˆæ”¶</span><input type="number" class="form-control domestic-inc passive-source wan-target" id="income-rent" placeholder="é‡‘é¡"><span class="wan-hint-badge" id="hint-income-rent">0 è¬</span></div>
                </div>
            </div>
        </div>

        <div class="accordion-item border-0 border-bottom">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed fw-bold text-danger" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDebt">
                    ğŸ’¸ 3. æ”¯å‡ºèˆ‡è² å‚µ
                </button>
            </h2>
            <div id="collapseDebt" class="accordion-collapse collapse" data-bs-parent="#financeAccordion">
                <div class="accordion-body">
                    <h6 class="small fw-bold text-secondary mb-2">ğŸ’³ å…¶ä»–è² å‚µ (æˆ¿/è»Šè²¸å·²åœ¨å¤¢æƒ³å€è‡ªå‹•ç®—)</h6>
                    <div id="loan-container"></div>
                    <button class="btn btn-sm btn-outline-secondary w-100 mt-1 mb-3 dashed-btn" onclick="addLoanRow()"><i class="fas fa-plus"></i> æ–°å¢ä¿¡è²¸/å­¸è²¸/å¡å‚µ</button>
                    
                    <div class="input-group mt-3">
                        <span class="input-group-text">ç”Ÿæ´»æœˆé–‹éŠ·</span>
                        <input type="number" class="form-control text-expense wan-target" id="expense-living" placeholder="ä¼™é£Ÿ/æ°´é›»ç­‰">
                        <span class="wan-hint-badge" id="hint-expense-living">0 è¬</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item border-0">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAsset">
                    ğŸ’ 4. ç¸½è³‡ç”¢ (è¼¸å…¥çœŸå¯¦é‡‘é¡)
                </button>
            </h2>
            <div id="collapseAsset" class="accordion-collapse collapse" data-bs-parent="#financeAccordion">
                <div class="accordion-body">
                    <div class="row g-2">
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">å­˜æ¬¾</span><input type="number" class="form-control asset-item wan-target" id="asset-cash"><span class="wan-hint-badge" id="hint-asset-cash">0</span></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">è‚¡ç¥¨</span><input type="number" class="form-control asset-item wan-target" id="asset-stock"><span class="wan-hint-badge" id="hint-asset-stock">0</span></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">åŸºé‡‘</span><input type="number" class="form-control asset-item wan-target" id="asset-fund"><span class="wan-hint-badge" id="hint-asset-fund">0</span></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">ä¿å–®</span><input type="number" class="form-control asset-item wan-target" id="asset-ins"><span class="wan-hint-badge" id="hint-asset-ins">0</span></div></div>
                        <div class="col-6"><div class="input-group input-group-sm mb-2"><span class="input-group-text">å…¶ä»–</span><input type="number" class="form-control asset-item wan-target" id="asset-other"><span class="wan-hint-badge" id="hint-asset-other">0</span></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mt-3">
        <div class="card-body">
            <h6 class="small fw-bold text-dark"><i class="fas fa-chart-line me-2 text-primary"></i>è³‡ç”¢é»ƒé‡‘äº¤å‰é æ¸¬</h6>
            <div class="chart-container"><canvas id="lifeChart"></canvas></div>
        </div>
    </div>

    <div class="text-center text-muted small pb-4 fw-bold mt-4" style="opacity:0.6">Designed for Daxin Partners â€¢ Gavin</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentExchangeRate = 32.5; let lifeChart = null;
    const RATES = { salary: 0.03, cpi: 0.04, house_loan: 0.022, car_loan: 0.05, invest: 0.05 }; 
    const AMWAY_PINS = [{name:"ç™½é‡‘",income:1000000},{name:"è—å¯¶çŸ³",income:1800000},{name:"ç¿¡ç¿ ",income:2500000},{name:"é‘½çŸ³",income:5000000},{name:"çš‡å† ",income:10000000},{name:"çš‡å† å¤§ä½¿",income:30000000}];

    document.addEventListener('DOMContentLoaded', () => { 
        loadData(); setTimeout(calculateAll, 500); 
        // ç¶å®šæ‰€æœ‰é‡‘é¡è¼¸å…¥æ¡†é¡¯ç¤ºè¬
        document.addEventListener('input', function(e) {
            if(e.target.classList.contains('wan-target')) updateWanHint(e.target);
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') { saveDataLocal(); calculateAll(); }
        });
    });

    function updateWanHint(input) {
        const val = parseFloat(input.value); 
        const hintId = 'hint-' + input.id; 
        const hintEl = document.getElementById(hintId) || input.nextElementSibling; // å˜—è©¦æ‰¾IDæˆ–ä¸‹ä¸€å€‹å…ƒç´ 
        if (hintEl && hintEl.classList.contains('wan-hint-badge')) { 
            if (!isNaN(val) && val > 0) { 
                let wanVal = val / 10000; 
                let txt = Number.isInteger(wanVal) ? wanVal : wanVal.toFixed(2); 
                hintEl.innerText = `${txt} è¬`; 
            } else { 
                hintEl.innerText = "0 è¬"; 
            } 
        }
    }

    function formatWan(num) { 
        if (!num) return "0"; num = Math.floor(num); 
        if (num >= 10000) return (num/10000).toFixed(1) + " è¬"; 
        return num.toLocaleString(); 
    }

    function calculateAll() {
        let currentAge = Number(document.getElementById('current-age').value) || 30;
        let active = Number(document.getElementById('income-active').value) || 0;
        let amway = Number(document.getElementById('income-amway').value) || 0;
        let passive = amway + (Number(document.getElementById('income-stock-div').value)||0) + (Number(document.getElementById('income-rent').value)||0);
        let totalIncome = active + passive;

        // 1. è² å‚µèˆ‡æ”¯å‡ºè¨ˆç®—
        let totalLiabilities = 0; let totalMonthlyDebt = 0;
        
        // å¤¢æƒ³è½‰è²¸æ¬¾ (Auto Loan Logic)
        let dreamAssetTarget = 0; 
        document.querySelectorAll('#dream-container .dynamic-row').forEach(row => {
            let type = row.querySelector('.dream-type').value;
            let cost = Number(row.querySelector('.dream-cost').value)||0; // çœŸå¯¦é‡‘é¡
            let years = Number(row.querySelector('.dream-years').value)||0;
            let hint = row.querySelector('.dream-loan-hint');
            
            if(years > 0 && cost > 0) { // è²¸æ¬¾æ¨¡å¼
                let rate = (type === 'car') ? RATES.car_loan/12 : RATES.house_loan/12;
                let n = years * 12;
                let pmt = (cost * rate * Math.pow(1+rate,n)) / (Math.pow(1+rate,n)-1);
                
                totalMonthlyDebt += pmt; 
                totalLiabilities += cost; 
                hint.innerText = `æœˆä»˜ $${Math.floor(pmt).toLocaleString()} (å«æ¯)`;
                hint.style.color = "#dc3545";
            } else if (cost > 0) { // å…¨æ¬¾æ¨¡å¼
                dreamAssetTarget += cost; 
                hint.innerText = "éœ€å­˜å…¨æ¬¾ (è³‡ç”¢ç›®æ¨™)";
                hint.style.color = "#e67e22";
            } else hint.innerText = "";
        });

        // æ‰‹å‹•è² å‚µ
        document.querySelectorAll('#loan-container .dynamic-row').forEach(row => {
            let monthly = Number(row.querySelector('.loan-monthly').value)||0;
            let periods = Number(row.querySelector('.loan-periods').value)||0;
            totalMonthlyDebt += monthly; 
            totalLiabilities += (monthly * periods);
        });

        let living = Number(document.getElementById('expense-living').value)||0;
        let totalMonthlyExpense = Math.floor(totalMonthlyDebt + living);
        let monthlySurplus = totalIncome - totalMonthlyExpense;

        // 2. è³‡ç”¢
        let totalAsset = 0; 
        document.querySelectorAll('.asset-item').forEach(i => totalAsset += (Number(i.value)||0));
        let netWorth = totalAsset - totalLiabilities;

        // 3. UI æ›´æ–°
        document.getElementById('net-worth-display').innerText = formatWan(netWorth);
        document.getElementById('total-liability-display').innerText = formatWan(totalLiabilities);
        document.getElementById('monthly-surplus').innerText = formatWan(monthlySurplus);
        document.getElementById('monthly-surplus').className = monthlySurplus > 0 ? "stat-value text-success" : "stat-value text-danger";
        
        let freedomRate = totalMonthlyExpense > 0 ? (passive / totalMonthlyExpense) * 100 : 0;
        document.getElementById('freedom-ratio').innerText = freedomRate.toFixed(0) + "%";

        // 4. é æ¸¬å¹´é½¡ (Prediction)
        let targetMonthly = Number(document.getElementById('target-monthly-expense').value) || totalMonthlyExpense; // è‹¥æ²’å¡«ç›®æ¨™ï¼Œç”¨ç¾åœ¨é–‹éŠ·ç®—
        
        // æœ¬æ¥­ç›ˆé¤˜ (æ‰£æ‰å¤¢æƒ³è² å‚µå¾Œçš„çœŸå¯¦å­˜éŒ¢èƒ½åŠ›)
        let mainSurplus = active - (totalMonthlyExpense - amway); 
        let targetAsset = dreamAssetTarget > 0 ? dreamAssetTarget : (totalLiabilities > 0 ? totalLiabilities : 5000000); // è‹¥ç„¡å¤¢æƒ³ï¼Œè¨­å€‹é è¨­ç›®æ¨™
        
        // å¦‚æœæ˜¯è¦å­˜å…¨æ¬¾ï¼Œç®—å­˜åˆ°å…¨æ¬¾çš„æ™‚é–“ã€‚å¦‚æœæ˜¯è²¸æ¬¾ï¼Œç®—è¢«å‹•æ”¶å…¥è¦†è“‹æ”¯å‡ºçš„æ™‚é–“ã€‚
        // ç‚ºç°¡åŒ–ï¼Œé€™è£¡çµ±ä¸€ç®—ã€Œè²¡å¯Œè‡ªç”±æ™‚é–“ã€ï¼šè¢«å‹•æ”¶å…¥ > ç›®æ¨™é–‹éŠ·
        
        let yMain = calculateYearsToFreedom(active, 0, totalMonthlyExpense, targetMonthly);
        let yAmway = calculateYearsToFreedom(active, amway, totalMonthlyExpense, targetMonthly);

        updateAgeBadge('age-job-only', currentAge + yMain, yMain);
        updateAgeBadge('age-with-amway', currentAge + yAmway, yAmway);

        // 5. ç¸½çµåˆ†æ
        let summary = document.getElementById('analysis-summary');
        if(yAmway < yMain && yAmway < 90) {
            let savedYears = yMain - yAmway;
            if (yMain > 90) savedYears = "ç„¡æ•¸";
            summary.style.display = 'block';
            summary.innerHTML = `<i class="fas fa-check-circle me-1"></i> ç¸½çµåˆ†æï¼š<br>é€éå®‰éº—äº‹æ¥­å»ºç«‹è¢«å‹•æ”¶å…¥ï¼Œæ‚¨å°‡æ¯”åªé æœ¬æ¥­ <strong>ææ—© ${savedYears} å¹´</strong> é”æˆè²¡å¯Œè‡ªç”±ï¼ç¾åœ¨å°±æ˜¯è¡Œå‹•çš„æœ€ä½³æ™‚æ©Ÿã€‚`;
        } else {
            summary.style.display = 'none';
        }

        // 6. è˜ä½å»ºè­°
        let gap = targetMonthly - passive;
        let pinContainer = document.getElementById('pin-card-container');
        if (gap > 0) {
            pinContainer.style.display = 'flex';
            let annualNeed = gap * 12;
            let pin = AMWAY_PINS.find(p => p.income >= annualNeed);
            if(pin) {
                document.getElementById('target-pin-name').innerText = pin.name;
                document.getElementById('target-pin-income').innerText = `ç›®æ¨™ç¼ºå£ï¼šå¹´æ”¶ ${formatWan(annualNeed)}`;
            } else {
                document.getElementById('target-pin-name').innerText = "çš‡å† å¤§ä½¿+";
                document.getElementById('target-pin-income').innerText = "ç›®æ¨™å®å¤§ï¼Œå…¨åŠ›ä»¥èµ´";
            }
        } else {
            pinContainer.style.display = 'none';
        }
        
        updateChart(totalAsset, dreamAssetTarget, monthlySurplus);
    }

    function calculateYearsToFreedom(activeStart, passiveStart, currentExpense, targetExpense) {
        let years = 0;
        let passive = passiveStart;
        let expense = targetExpense > 0 ? targetExpense : currentExpense;
        let active = activeStart;
        let accumulated = 0;

        // å‡è¨­ï¼šæœ¬æ¥­æˆé•· 3%, é€šè†¨ 4%, æŠ•è³‡ 5%, å®‰éº—æˆé•·è¼ƒå¿« 20%(åˆæœŸ) 
        // ç°¡å–®æ¨¡å‹ï¼šçœ‹ä½•æ™‚ (è¢«å‹• + æŠ•è³‡è¢«å‹•) > æ”¯å‡º
        while (years < 60) {
            years++;
            active *= (1 + RATES.salary);
            expense *= (1 + RATES.cpi);
            passive = passive > 0 ? passive * 1.1 : 0; // å®‰éº—æˆé•·å‡è¨­
            
            let surplus = (active + passive) - expense;
            if(surplus > 0) accumulated += surplus * 12;
            
            let investPassive = (accumulated * RATES.invest) / 12;
            
            if ((passive + investPassive) >= expense) return years;
        }
        return 99;
    }

    function updateAgeBadge(id, age, years) {
        let el = document.getElementById(id);
        if (years >= 60) {
            el.innerText = "ç„¡æ³•é”æˆ / é™é™ç„¡æœŸ";
            el.className = "pred-badge badge-job text-danger";
        } else {
            el.innerText = `${age} æ­² (ç´„ ${years} å¹´å¾Œ)`;
            el.className = id.includes('amway') ? "pred-badge badge-amway" : "pred-badge badge-job";
        }
    }

    function updateChart(startAsset, target, monthlySave) {
        const ctx = document.getElementById('lifeChart').getContext('2d');
        if (lifeChart) lifeChart.destroy();
        let labels = [], assetData = [], targetData = [];
        let current = startAsset; let goal = target > 0 ? target : startAsset * 1.5 + 1000000;
        
        for(let i=0; i<=15; i++) {
            labels.push(i+"å¹´");
            assetData.push(current); targetData.push(goal);
            current = (current + monthlySave * 12) * 1.05; 
            goal = goal * 1.04; 
        }
        lifeChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{label:'è³‡ç”¢ç´¯ç©', data:assetData, borderColor:'#007bff', fill:true, backgroundColor:'rgba(0,123,255,0.1)'}, {label:'ç›®æ¨™/å¤¢æƒ³æˆæœ¬', data:targetData, borderColor:'#dc3545', borderDash:[5,5]}] }, options: {responsive:true, maintainAspectRatio:false} });
    }

    // --- Dynamic Rows (Auto Loan Logic) ---
    function handleDreamTypeChange(select) {
        const row = select.closest('.dynamic-row');
        const yearInput = row.querySelector('.dream-years');
        const costInput = row.querySelector('.dream-cost');
        
        // é è¨­é‚è¼¯
        if (select.value === 'house') { yearInput.value = 30; } // è²·æˆ¿é è¨­30å¹´
        else if (select.value === 'car') { yearInput.value = 5; } // è²·è»Šé è¨­5å¹´
        else { yearInput.value = 0; } // å…¶ä»–é è¨­å…¨æ¬¾
        
        calculateAll();
    }

    function addDreamRow(data = null) {
        const div = document.createElement('div'); div.className = 'dynamic-row dream-item';
        div.innerHTML = `
            <button class="btn-remove" onclick="this.parentElement.remove();calculateAll();saveDataLocal()">&times;</button>
            <div class="row g-2 align-items-center">
                <div class="col-4">
                    <select class="form-select dream-type" onchange="handleDreamTypeChange(this); saveDataLocal()">
                        <option value="house">ğŸ  è²·æˆ¿</option>
                        <option value="car">ğŸš— è²·è»Š</option>
                        <option value="travel">âœˆï¸ æ—…éŠ</option>
                        <option value="learn">ğŸ“š é€²ä¿®</option>
                        <option value="company">ğŸ’¼ å‰µæ¥­</option>
                        <option value="other">âœ¨ å…¶ä»–</option>
                    </select>
                </div>
                <div class="col-8">
                    <div class="input-group">
                        <input type="number" class="form-control dream-cost wan-target" placeholder="ç¸½åƒ¹" oninput="updateWanHint(this); calculateAll(); saveDataLocal()">
                        <span class="wan-hint-badge">0 è¬</span>
                    </div>
                </div>
                <div class="col-12 d-flex justify-content-between align-items-center mt-2">
                    <div class="input-group input-group-sm w-50">
                        <span class="input-group-text">è²¸æ¬¾</span>
                        <input type="number" class="form-control dream-years" placeholder="å¹´ (0=å…¨æ¬¾)" oninput="calculateAll();saveDataLocal()">
                    </div>
                    <span class="dream-loan-hint"></span>
                </div>
            </div>`;
        document.getElementById('dream-container').appendChild(div);
        // åˆå§‹åŒ–ç¬¬ä¸€å€‹ hint
        updateWanHint(div.querySelector('.dream-cost'));
    }

    function addLoanRow() {
        const div = document.createElement('div'); div.className = 'dynamic-row loan-item';
        const types = ['æˆ¿è²¸','è»Šè²¸','ä¿¡è²¸','å­¸è²¸','å¡å‚µ','è¦ªå‹å€Ÿæ¬¾','å…¶ä»–'].map(t=>`<option>${t}</option>`).join('');
        div.innerHTML = `<button class="btn-remove" onclick="this.parentElement.remove();calculateAll();saveDataLocal()">&times;</button><div class="row g-2"><div class="col-4"><select class="form-select form-select-sm loan-type">${types}</select></div><div class="col-4"><div class="input-group input-group-sm"><input type="number" class="form-control loan-monthly" placeholder="æœˆä»˜" oninput="calculateAll();saveDataLocal()"></div></div><div class="col-4"><div class="input-group input-group-sm"><input type="number" class="form-control loan-periods" placeholder="æœŸæ•¸" oninput="calculateAll();saveDataLocal()"></div></div></div>`;
        document.getElementById('loan-container').appendChild(div);
    }

    function saveDataLocal() { /* ... */ }
    function loadData() { /* ... */ }
    function saveCurrentMonthRecord() { alert('âœ… ç´€éŒ„å·²ä¿å­˜'); }
</script>
</body>
</html>
