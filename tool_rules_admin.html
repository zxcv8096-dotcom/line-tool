<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…¨å·¥å…·ä¸­æ§å°ï½œçµ±ä¸€çª—å£ Gateway</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0f172a; --muted:#475569; --muted2:#64748b;
      --bd:rgba(15,23,42,.10); --bg:#f8fafc;
      --glass: rgba(255,255,255,.80); --glass2: rgba(255,255,255,.66);
      --shadow: 0 18px 55px rgba(15,23,42,.10); --shadow2: 0 8px 24px rgba(15,23,42,.08);
    }
    body{
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(950px 520px at 90% 12%, rgba(16,185,129,.16), transparent 55%),
        radial-gradient(1000px 650px at 50% 110%, rgba(245,158,11,.14), transparent 60%),
        var(--bg);
    }
    .glass{ background:var(--glass); border:1px solid var(--bd); backdrop-filter: blur(12px); box-shadow: var(--shadow); }
    .glass-soft{ background:var(--glass2); border:1px solid var(--bd); backdrop-filter: blur(10px); box-shadow: var(--shadow2); }
    .btn{ border:1px solid var(--bd); background:white; }
    .btn:hover{ background:#f1f5f9; }
    .pill{ border:1px solid var(--bd); background: rgba(255,255,255,.70); }
    .card{
      background: rgba(255,255,255,.84);
      border:1px solid var(--bd);
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
    }
    .card:hover{
      background: rgba(255,255,255,.95);
      box-shadow: 0 16px 38px rgba(15,23,42,.10);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.75);
      padding:.12rem .45rem;
      border-radius: .7rem;
      font-size: .82em;
      color:#0f172a;
    }
    input, textarea{ outline: none; }
  </style>
</head>

<body class="min-h-screen">
  <header class="sticky top-0 z-30">
    <div class="mx-auto max-w-6xl px-4 pt-4">
      <div class="glass rounded-3xl px-5 py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-12 w-12 rounded-2xl flex items-center justify-center"
               style="background: linear-gradient(135deg, rgba(59,130,246,.20), rgba(16,185,129,.18)); border:1px solid var(--bd);">
            <span class="text-2xl">ğŸ§­</span>
          </div>
          <div>
            <div class="text-lg font-extrabold leading-tight">å…¨å·¥å…·ä¸­æ§å°</div>
            <div class="text-sm mt-1" style="color:var(--muted2)">
              çµ±ä¸€çª—å£ Gatewayï½œå·¥å…·ä½ç½®ã€Œä»»æ„ã€ä¹Ÿèƒ½æ­£å¸¸è·³è½‰
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <span id="envBadge" class="pill text-xs px-3 py-2 rounded-2xl">åµæ¸¬ä¸­â€¦</span>
          <button id="btnHelp" class="btn text-sm px-4 py-2 rounded-2xl">æ•™å­¸</button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-24">
    <!-- Gateway -->
    <section class="mt-4 glass-soft rounded-3xl p-5">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
        <div class="flex-1">
          <div class="text-base font-bold">çµ±ä¸€çª—å£ï¼ˆGatewayï¼‰</div>
          <div class="mt-1 text-sm" style="color:var(--muted)">
            ä»»ä½•å·¥å…·éœ€è¦ Cloudflare åŠŸèƒ½ï¼ˆKV / R2 / D1 / Worker API / Webhookï¼‰éƒ½ **çµ±ä¸€èµ° Gateway**ã€‚
            å·¥å…·é ä½ç½®ä¸å›ºå®šä¹Ÿæ²’å•é¡Œï¼šä½ åªè¦åœ¨ã€Œå·¥å…·æ¸…å–®ã€å¡«å…¥ç¶²å€æˆ–ç›¸å°è·¯å¾‘å³å¯ã€‚
          </div>

          <div class="mt-4 grid md:grid-cols-3 gap-3">
            <div class="pill rounded-2xl p-4 md:col-span-2">
              <div class="text-sm font-semibold">Gateway Baseï¼ˆWorker ç¶²åŸŸï¼‰</div>
              <div class="mt-2 flex flex-col sm:flex-row gap-2">
                <input id="gwInput" class="w-full rounded-2xl px-4 py-3 border bg-white/80"
                       style="border-color:var(--bd)"
                       placeholder="ä¾‹å¦‚ï¼šhttps://api.zxcv8096.workers.dev" />
                <button id="gwSave" class="btn px-4 py-3 rounded-2xl text-sm font-semibold whitespace-nowrap">å„²å­˜</button>
              </div>
              <div class="mt-2 text-xs" style="color:var(--muted)">
                æœƒå­˜åˆ°ï¼š<span class="kbd">localStorage.GW_BASE</span>ã€€å·¥å…·é ä¹Ÿå¯ä»¥ç”¨ <span class="kbd">?gw=</span> è®€åˆ°
              </div>
            </div>

            <div class="pill rounded-2xl p-4">
              <div class="text-sm font-semibold">é€£ç·šæ¸¬è©¦</div>
              <div class="mt-2 text-sm" id="gwStatus" style="color:var(--muted)">å°šæœªæ¸¬è©¦</div>
              <div class="mt-3 flex gap-2">
                <button id="gwTest" class="btn px-4 py-2 rounded-2xl text-sm">æ¸¬è©¦</button>
                <button id="gwReset" class="btn px-4 py-2 rounded-2xl text-sm">é‡ç½®</button>
              </div>
            </div>
          </div>

          <div class="mt-4 grid lg:grid-cols-3 gap-3 text-sm">
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">ä½ ç›®å‰é–‹å•Ÿçš„ä½ç½®</div>
              <div class="mt-1" style="color:var(--muted)">
                Hostï¼š<span id="host" class="font-mono"></span><br/>
                Pathï¼š<span id="path" class="font-mono"></span>
              </div>
            </div>
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">ç›®å‰ Gateway</div>
              <div class="mt-1" style="color:var(--muted)">
                <span class="font-mono" id="gwHint"></span>
              </div>
            </div>
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">å¿«é€Ÿå‹•ä½œ</div>
              <div class="mt-2 flex gap-2">
                <button id="btnAdd" class="btn px-4 py-2 rounded-2xl text-sm">ï¼‹æ–°å¢å·¥å…·</button>
                <button id="btnExport" class="btn px-4 py-2 rounded-2xl text-sm">åŒ¯å‡º</button>
                <button id="btnImport" class="btn px-4 py-2 rounded-2xl text-sm">åŒ¯å…¥</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Search & filters -->
        <div class="shrink-0 w-full lg:w-[360px]">
          <div class="pill rounded-2xl p-4">
            <div class="text-sm font-semibold">æœå°‹ / ç¯©é¸</div>
            <div class="mt-3 flex gap-2">
              <input id="q" class="w-full rounded-2xl px-4 py-3 border bg-white/80"
                     style="border-color:var(--bd)"
                     placeholder="æœå°‹å·¥å…·â€¦ï¼ˆæŒ‰ / èšç„¦ï¼‰" />
              <button id="clear" class="btn px-4 py-3 rounded-2xl text-sm">æ¸…é™¤</button>
            </div>
            <div class="mt-3 flex gap-2">
              <select id="cat" class="w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)">
                <option value="">å…¨éƒ¨åˆ†é¡</option>
              </select>
              <select id="sort" class="w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)">
                <option value="pin">æ’åºï¼šç½®é ‚å„ªå…ˆ</option>
                <option value="name">æ’åºï¼šåç¨±</option>
                <option value="new">æ’åºï¼šæœ€æ–°æ–°å¢</option>
              </select>
            </div>
            <div class="mt-3 text-xs" style="color:var(--muted)">
              å¿«æ·éµï¼š<span class="kbd">/</span> æœå°‹ã€€<span class="kbd">Esc</span> é—œé–‰è¦–çª—
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tools list -->
    <section class="mt-4">
      <div class="flex items-end justify-between gap-3">
        <div>
          <div class="text-base font-bold">å·¥å…·æ¸…å–®ï¼ˆä½ç½®ä»»æ„ï¼‰</div>
          <div class="text-sm" style="color:var(--muted)">
            å·¥å…·ç¶²å€å¯å¡«ï¼š<span class="kbd">https://å®Œæ•´ç¶²å€</span> æˆ– <span class="kbd">/ç›¸å°è·¯å¾‘</span> æˆ– <span class="kbd">pages/tools/xxx.html</span>ï¼ˆæœƒç”¨ Gateway çµ„åˆï¼‰
          </div>
        </div>
        <div class="text-xs pill px-3 py-2 rounded-2xl">
          å…± <span id="count">0</span> å€‹
        </div>
      </div>

      <div id="grid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

      <div id="empty" class="hidden mt-5 glass-soft rounded-3xl p-6 text-center">
        <div class="text-lg font-bold">æ²’æœ‰å·¥å…·</div>
        <div class="mt-2 text-sm" style="color:var(--muted)">é»ã€Œæ–°å¢å·¥å…·ã€æŠŠä½ çš„å·¥å…·ç¶²å€åŠ é€²ä¾†</div>
      </div>
    </section>
  </main>

  <!-- Modal: Help -->
  <div id="helpModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto max-w-2xl px-4 py-6 sm:py-10 h-full flex items-center">
      <div class="glass rounded-3xl w-full max-h-[85vh] flex flex-col overflow-hidden">
        <div class="px-5 py-4 border-b" style="border-color:var(--bd);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-extrabold">æ•™å­¸ï¼ˆçµ±ä¸€çª—å£ Gatewayï¼‰</div>
              <div class="text-sm mt-1" style="color:var(--muted)">
                ä½ çš„æ ¸å¿ƒè¦å‰‡ï¼šæ‰€æœ‰ Cloudflare åŠŸèƒ½éƒ½ç”±é€™å€‹ Gateway çµ±ä¸€è½‰ç™¼ï¼Œä¸åˆ†å·¥å…·æ”¾å“ªè£¡ã€‚
              </div>
            </div>
            <button id="helpCloseTop" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
          </div>
        </div>

        <div class="px-5 py-4 overflow-auto text-sm space-y-3">
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">1) è¨­å®š Gateway</div>
            <div class="mt-1" style="color:var(--muted)">
              åœ¨ä¸Šæ–¹è¼¸å…¥ä½ çš„ Worker ç¶²åŸŸï¼Œä¾‹å¦‚ï¼š<span class="kbd">https://api.zxcv8096.workers.dev</span> â†’ å„²å­˜ã€‚
              ä¹‹å¾Œæ‰€æœ‰å·¥å…·éƒ½èƒ½è®€åˆ°ç›¸åŒè¨­å®šï¼ˆlocalStorage / ?gw=ï¼‰ã€‚
            </div>
          </div>
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">2) æ–°å¢å·¥å…·ï¼ˆä½ç½®ä»»æ„ï¼‰</div>
            <div class="mt-1" style="color:var(--muted)">
              å·¥å…·ç¶²å€å¯ä»¥æ˜¯ï¼š<br/>
              â€¢ å®Œæ•´ç¶²å€ï¼š<span class="kbd">https://xxx.com/tool.html</span><br/>
              â€¢ ç›¸å°è·¯å¾‘ï¼š<span class="kbd">/pages/tools/tool.html</span>ï¼ˆæœƒè‡ªå‹•ç”¨ Gateway çµ„åˆï¼‰<br/>
              â€¢ ç›¸å°è·¯å¾‘ï¼š<span class="kbd">pages/tools/tool.html</span>ï¼ˆåŒä¸Šï¼‰
            </div>
          </div>
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">3) å·¥å…·å¦‚ä½•æ‹¿åˆ° Gateway</div>
            <div class="mt-1" style="color:var(--muted)">
              é»å·¥å…·æœƒè‡ªå‹•å¸¶ï¼š<span class="kbd">?gw=ä½ çš„Gateway</span>ã€‚<br/>
              å·¥å…·é ä¹Ÿå¯ä»¥ç›´æ¥è®€ï¼š<span class="kbd">localStorage.GW_BASE</span>ã€‚
            </div>
          </div>
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">4) åŒ¯å‡º / åŒ¯å…¥</div>
            <div class="mt-1" style="color:var(--muted)">
              ä½ å¯ä»¥æŠŠæ•´ä»½å·¥å…·æ¸…å–®åŒ¯å‡ºæˆ JSONï¼Œæ›é›»è…¦æˆ–å‚™ä»½éƒ½å¾ˆæ–¹ä¾¿ã€‚
            </div>
          </div>
        </div>

        <div class="px-5 py-4 border-t flex items-center justify-between gap-3" style="border-color:var(--bd);">
          <div class="text-xs" style="color:var(--muted)">å¿«æ·éµï¼š<span class="kbd">/</span> æœå°‹</div>
          <button id="helpClose" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Editor -->
  <div id="editModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto max-w-2xl px-4 py-6 sm:py-10 h-full flex items-center">
      <div class="glass rounded-3xl w-full max-h-[85vh] flex flex-col overflow-hidden">
        <div class="px-5 py-4 border-b" style="border-color:var(--bd);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-extrabold" id="editTitle">æ–°å¢å·¥å…·</div>
              <div class="text-sm mt-1" style="color:var(--muted)">å·¥å…·ä½ç½®ä»»æ„ï¼Œé€™è£¡åªåšç®¡ç†èˆ‡çµ±ä¸€è·³è½‰</div>
            </div>
            <button id="editCloseTop" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
          </div>
        </div>

        <div class="px-5 py-4 overflow-auto text-sm space-y-3">
          <div class="grid md:grid-cols-2 gap-3">
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">å·¥å…·åç¨±ï¼ˆä¸­æ–‡ï¼‰</div>
              <input id="fName" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)" placeholder="ä¾‹å¦‚ï¼šè‡ªå‹•å›è¦†" />
            </div>
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">åˆ†é¡ï¼ˆå¯é¸ï¼‰</div>
              <input id="fCat" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)" placeholder="ä¾‹å¦‚ï¼šå›è¦† / é¸å–® / åœ–ç‰‡ / ç³»çµ±" />
            </div>
          </div>

          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">å·¥å…·ç¶²å€ / è·¯å¾‘</div>
            <div class="mt-1 text-xs" style="color:var(--muted)">
              æ”¯æ´ï¼šå®Œæ•´ç¶²å€ https://...ã€€æˆ–ç›¸å°è·¯å¾‘ /xxx æˆ– pages/tools/xxx.htmlï¼ˆæœƒç”¨ Gateway çµ„åˆï¼‰
            </div>
            <input id="fUrl" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)" placeholder="ä¾‹å¦‚ï¼šhttps://api.zxcv8096.workers.dev/pages/tools/auto_reply.html" />
          </div>

          <div class="grid md:grid-cols-2 gap-3">
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">åœ–ç¤ºï¼ˆemojiï¼‰</div>
              <input id="fIcon" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)" placeholder="ä¾‹å¦‚ï¼šğŸ¤–" />
            </div>
            <div class="pill rounded-2xl p-4 flex items-center gap-3">
              <label class="flex items-center gap-2">
                <input id="fPinned" type="checkbox" class="scale-110" />
                <span class="font-semibold">ç½®é ‚</span>
              </label>
              <label class="flex items-center gap-2">
                <input id="fNewTab" type="checkbox" class="scale-110" />
                <span class="font-semibold">æ–°åˆ†é é–‹å•Ÿ</span>
              </label>
            </div>
          </div>

          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">èªªæ˜ï¼ˆå¯é¸ï¼‰</div>
            <textarea id="fDesc" rows="3" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)"
              placeholder="ä¾‹å¦‚ï¼šé—œéµå­— â†’ è¦å‰‡åº«å›è¦†ï¼ˆèµ° Gatewayï¼‰"></textarea>
          </div>

          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">é è¦½ï¼ˆå¯¦éš›è·³è½‰ç¶²å€ï¼‰</div>
            <div class="mt-2 text-xs" style="color:var(--muted)">
              æœƒè‡ªå‹•é™„åŠ  <span class="kbd">?gw=</span>ï¼Œå·¥å…·å¯ç”¨ query æˆ– localStorage è®€å– Gateway
            </div>
            <div class="mt-2 font-mono text-xs break-all" id="previewUrl" style="color:var(--muted)"></div>
            <div class="mt-3 flex gap-2">
              <button id="btnPreviewOpen" class="btn px-4 py-2 rounded-2xl text-sm">é–‹å•Ÿé è¦½</button>
              <button id="btnPreviewCopy" class="btn px-4 py-2 rounded-2xl text-sm">è¤‡è£½ç¶²å€</button>
            </div>
          </div>
        </div>

        <div class="px-5 py-4 border-t flex items-center justify-between gap-3" style="border-color:var(--bd);">
          <div class="text-xs" style="color:var(--muted)" id="editFoot"></div>
          <div class="flex items-center gap-2">
            <button id="btnDelete" class="btn px-4 py-2 rounded-2xl text-sm">åˆªé™¤</button>
            <button id="btnSaveTool" class="btn px-4 py-2 rounded-2xl text-sm font-semibold">å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import/Export -->
  <div id="ioModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto max-w-2xl px-4 py-6 sm:py-10 h-full flex items-center">
      <div class="glass rounded-3xl w-full max-h-[85vh] flex flex-col overflow-hidden">
        <div class="px-5 py-4 border-b" style="border-color:var(--bd);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-extrabold" id="ioTitle">åŒ¯å‡º / åŒ¯å…¥</div>
              <div class="text-sm mt-1" style="color:var(--muted)">å‚™ä»½ä½ çš„å·¥å…·æ¸…å–®ï¼ˆJSONï¼‰</div>
            </div>
            <button id="ioCloseTop" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
          </div>
        </div>
        <div class="px-5 py-4 overflow-auto text-sm space-y-3">
          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">JSON å…§å®¹</div>
            <textarea id="ioText" rows="14" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80 font-mono text-xs"
              style="border-color:var(--bd)" placeholder="é€™è£¡æœƒé¡¯ç¤ºåŒ¯å‡ºå…§å®¹ï¼Œæˆ–è²¼ä¸ŠåŒ¯å…¥å…§å®¹"></textarea>
            <div class="mt-3 flex gap-2">
              <button id="ioCopy" class="btn px-4 py-2 rounded-2xl text-sm">è¤‡è£½</button>
              <button id="ioApply" class="btn px-4 py-2 rounded-2xl text-sm font-semibold">å¥—ç”¨åŒ¯å…¥</button>
            </div>
          </div>
          <div class="text-xs" style="color:var(--muted)">
            æ³¨æ„ï¼šåŒ¯å…¥æœƒè¦†è“‹ç›®å‰å·¥å…·æ¸…å–®ï¼ˆå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ï¼‰
          </div>
        </div>
        <div class="px-5 py-4 border-t flex items-center justify-between gap-3" style="border-color:var(--bd);">
          <div class="text-xs" style="color:var(--muted)">å¿«æ·éµï¼šEsc é—œé–‰</div>
          <button id="ioClose" class="btn px-4 py-2 rounded-2xl text-sm">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Storage keys =====
    const K_GW = "GW_BASE";
    const K_TOOLS = "TOOLS_LIST_V1";

    // ===== Defaults =====
    const DEFAULT_GW = "https://api.zxcv8096.workers.dev";
    const DEFAULT_TOOLS = [
      // å…ˆæ”¾ä½ å¸¸ç”¨çš„ï¼ˆä½ å¯è‡ªè¡Œå¢åˆ ï¼‰
      { id: uid(), name:"å¿«é€Ÿå›è¦†", cat:"å›è¦†", icon:"âš¡", desc:"å»ºç«‹ / ç®¡ç† Quick Reply", url:"/pages/tools/quickreply.html", pinned:true, newTab:false, createdAt: Date.now() },
      { id: uid(), name:"è‡ªå‹•å›è¦†", cat:"å›è¦†", icon:"ğŸ¤–", desc:"é—œéµå­— â†’ è¦å‰‡åº«å›è¦†", url:"/pages/tools/auto_reply.html", pinned:true, newTab:false, createdAt: Date.now() },
      { id: uid(), name:"Rich Menu", cat:"é¸å–®", icon:"ğŸ“Œ", desc:"åœ–æ–‡é¸å–®è¨­è¨ˆ / ç®¡ç†", url:"/pages/tools/tool_richmenu.html", pinned:false, newTab:false, createdAt: Date.now() },
    ];

    // ===== State =====
    let GW = loadGW();
    let TOOLS = loadTools();

    // ===== DOM =====
    const hostEl = document.getElementById("host");
    const pathEl = document.getElementById("path");
    const envBadge = document.getElementById("envBadge");

    const gwInput = document.getElementById("gwInput");
    const gwSave = document.getElementById("gwSave");
    const gwTest = document.getElementById("gwTest");
    const gwReset = document.getElementById("gwReset");
    const gwStatus = document.getElementById("gwStatus");
    const gwHint = document.getElementById("gwHint");

    const btnAdd = document.getElementById("btnAdd");
    const btnExport = document.getElementById("btnExport");
    const btnImport = document.getElementById("btnImport");

    const q = document.getElementById("q");
    const clear = document.getElementById("clear");
    const cat = document.getElementById("cat");
    const sort = document.getElementById("sort");

    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");
    const countEl = document.getElementById("count");

    const toolsRootHint = document.getElementById("toolsRootHint");

    // Help modal
    const helpModal = document.getElementById("helpModal");
    const btnHelp = document.getElementById("btnHelp");
    const helpCloseTop = document.getElementById("helpCloseTop");
    const helpClose = document.getElementById("helpClose");

    // Edit modal
    const editModal = document.getElementById("editModal");
    const editTitle = document.getElementById("editTitle");
    const editCloseTop = document.getElementById("editCloseTop");
    const btnSaveTool = document.getElementById("btnSaveTool");
    const btnDelete = document.getElementById("btnDelete");
    const editFoot = document.getElementById("editFoot");

    const fName = document.getElementById("fName");
    const fCat = document.getElementById("fCat");
    const fUrl = document.getElementById("fUrl");
    const fIcon = document.getElementById("fIcon");
    const fDesc = document.getElementById("fDesc");
    const fPinned = document.getElementById("fPinned");
    const fNewTab = document.getElementById("fNewTab");
    const previewUrl = document.getElementById("previewUrl");
    const btnPreviewOpen = document.getElementById("btnPreviewOpen");
    const btnPreviewCopy = document.getElementById("btnPreviewCopy");

    // IO modal
    const ioModal = document.getElementById("ioModal");
    const ioTitle = document.getElementById("ioTitle");
    const ioCloseTop = document.getElementById("ioCloseTop");
    const ioClose = document.getElementById("ioClose");
    const ioText = document.getElementById("ioText");
    const ioCopy = document.getElementById("ioCopy");
    const ioApply = document.getElementById("ioApply");

    // quick test tool
    const btnTestTool = document.getElementById("btnTestTool");

    // ===== init =====
    hostEl.textContent = location.host;
    pathEl.textContent = location.pathname;
    envBadge.textContent = (location.host.endsWith("workers.dev") ? "ä½ åœ¨ Workersï¼ˆâœ…ï¼‰" :
                           location.host.endsWith("github.io") ? "ä½ åœ¨ github.ioï¼ˆå¯ç”¨ï¼‰" :
                           location.host === "github.com" ? "ä½ åœ¨ GitHub Codeï¼ˆä¸æ˜¯ç¶²ç«™ï¼‰" : "ä¸€èˆ¬ç¶²ç«™æ¨¡å¼");
    gwInput.value = GW;
    syncGatewayHints();
    rebuildCategoryOptions();
    render();

    // ===== gateway actions =====
    gwSave.addEventListener("click", ()=>{
      const v = normalizeGW(gwInput.value);
      if(!v) return alert("Gateway ä¸èƒ½æ˜¯ç©ºçš„");
      GW = v;
      localStorage.setItem(K_GW, GW);
      syncGatewayHints();
      gwStatus.textContent = "å·²å„²å­˜ï¼ˆæœªæ¸¬è©¦ï¼‰";
    });

    gwReset.addEventListener("click", ()=>{
      GW = DEFAULT_GW;
      gwInput.value = GW;
      localStorage.setItem(K_GW, GW);
      syncGatewayHints();
      gwStatus.textContent = "å·²é‡ç½®";
    });

    // âœ… æ¸¬è©¦ï¼šå˜—è©¦ fetch GW çš„ /pingï¼ˆå¦‚æœæ²’æœ‰ä¹Ÿæ²’é—œä¿‚æœƒé¡¯ç¤ºåŸå› ï¼‰
    gwTest.addEventListener("click", async ()=>{
      const base = normalizeGW(gwInput.value) || GW;
      gwStatus.textContent = "æ¸¬è©¦ä¸­â€¦";
      try{
        const url = base.replace(/\/+$/,"") + "/ping";
        const res = await fetch(url, { method:"GET", cache:"no-store" });
        // ä¸è¦æ±‚ä¸€å®š 200ï¼Œåªè¦æœ‰å›æ‡‰ä»£è¡¨è·¯å¾‘å¯é€š
        gwStatus.textContent = `æœ‰å›æ‡‰ï¼šHTTP ${res.status}ï¼ˆ/pingï¼‰`;
      }catch(e){
        gwStatus.textContent = "å¤±æ•—ï¼šå¯èƒ½è¢« CORS æ“‹æˆ–ç¶²åŸŸä¸å¯é”";
      }
    });

    btnTestTool.addEventListener("click", ()=>{
      // å¦‚æœæœ‰å·¥å…·å°±é–‹ç¬¬ä¸€å€‹ç½®é ‚å·¥å…·ï¼Œæ²’æœ‰å°±é–‹ editor
      const list = getFilteredSortedTools();
      if(!list.length) return openEditor(null);
      openTool(list[0]);
    });

    // ===== search/filter/sort =====
    q.addEventListener("input", render);
    clear.addEventListener("click", ()=>{ q.value=""; render(); q.focus(); });
    cat.addEventListener("change", render);
    sort.addEventListener("change", render);

    // ===== keyboard shortcuts =====
    window.addEventListener("keydown", (e)=>{
      if (e.key === "/" && document.activeElement !== q){
        e.preventDefault(); q.focus();
      }
      if (e.key === "Escape"){
        closeHelp();
        closeEditor();
        closeIO();
      }
    });

    // ===== help modal =====
    btnHelp.addEventListener("click", openHelp);
    helpCloseTop.addEventListener("click", closeHelp);
    helpClose.addEventListener("click", closeHelp);
    helpModal.addEventListener("click", (e)=>{ if(e.target === helpModal) closeHelp(); });

    // ===== add / edit / delete =====
    btnAdd.addEventListener("click", ()=>openEditor(null));

    // ===== export/import =====
    btnExport.addEventListener("click", ()=>{
      openIO("åŒ¯å‡ºå·¥å…·æ¸…å–®ï¼ˆJSONï¼‰");
      ioText.value = JSON.stringify({ gw: GW, tools: TOOLS }, null, 2);
    });
    btnImport.addEventListener("click", ()=>{
      openIO("åŒ¯å…¥å·¥å…·æ¸…å–®ï¼ˆJSONï¼‰");
      ioText.value = "";
    });

    ioCloseTop.addEventListener("click", closeIO);
    ioClose.addEventListener("click", closeIO);
    ioModal.addEventListener("click", (e)=>{ if(e.target === ioModal) closeIO(); });

    ioCopy.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(ioText.value); alert("å·²è¤‡è£½"); }
      catch{ prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", ioText.value); }
    });

    ioApply.addEventListener("click", ()=>{
      const raw = ioText.value.trim();
      if(!raw) return alert("è«‹è²¼ä¸Š JSON å…§å®¹");
      try{
        const obj = JSON.parse(raw);
        if(obj.gw) {
          const v = normalizeGW(obj.gw);
          if(v){ GW = v; localStorage.setItem(K_GW, GW); gwInput.value = GW; syncGatewayHints(); }
        }
        if(Array.isArray(obj.tools)){
          TOOLS = obj.tools.map(t=>({
            id: t.id || uid(),
            name: String(t.name||"æœªå‘½åå·¥å…·"),
            cat: String(t.cat||""),
            icon: String(t.icon||"ğŸ§©"),
            desc: String(t.desc||""),
            url: String(t.url||""),
            pinned: !!t.pinned,
            newTab: !!t.newTab,
            createdAt: Number(t.createdAt || Date.now())
          }));
          saveTools();
          rebuildCategoryOptions();
          render();
          alert("åŒ¯å…¥æˆåŠŸ");
          closeIO();
        } else {
          alert("tools æ ¼å¼ä¸æ­£ç¢ºï¼ˆéœ€è¦æ˜¯é™£åˆ—ï¼‰");
        }
      }catch(e){
        alert("JSON è§£æå¤±æ•—");
      }
    });

    // ===== render =====
    function render(){
      const list = getFilteredSortedTools();
      countEl.textContent = list.length;
      empty.classList.toggle("hidden", list.length !== 0);

      grid.innerHTML = list.map(t=>cardHTML(t)).join("");

      grid.querySelectorAll("[data-id]").forEach(el=>{
        const id = el.getAttribute("data-id");
        el.querySelector("[data-open]").addEventListener("click", ()=>openTool(findById(id)));
        el.querySelector("[data-edit]").addEventListener("click", ()=>openEditor(findById(id)));
        el.querySelector("[data-pin]").addEventListener("click", ()=>togglePin(id));
        el.querySelector("[data-up]").addEventListener("click", ()=>move(id, -1));
        el.querySelector("[data-down]").addEventListener("click", ()=>move(id, +1));
      });
    }

    function cardHTML(t){
      const icon = escapeHTML(t.icon || "ğŸ§©");
      const name = escapeHTML(t.name || "æœªå‘½åå·¥å…·");
      const catTxt = escapeHTML(t.cat || "æœªåˆ†é¡");
      const desc = escapeHTML(t.desc || "");
      const resolved = resolveToolUrl(t.url);
      return `
        <div class="card rounded-3xl p-5">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-start gap-3">
              <div class="h-12 w-12 rounded-2xl flex items-center justify-center"
                   style="background:linear-gradient(135deg, rgba(59,130,246,.14), rgba(16,185,129,.12)); border:1px solid var(--bd);">
                <span class="text-2xl">${icon}</span>
              </div>
              <div class="min-w-0">
                <div class="text-lg font-extrabold leading-tight truncate">${name}</div>
                <div class="text-sm mt-1" style="color:var(--muted)">${desc || "â€”"}</div>
                <div class="mt-2 text-xs pill inline-flex px-3 py-1 rounded-2xl">${catTxt}</div>
              </div>
            </div>

            <div class="flex flex-col gap-2 items-end">
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-open title="é–‹å•Ÿ">é–‹å•Ÿ</button>
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-edit title="ç·¨è¼¯">ç·¨è¼¯</button>
            </div>
          </div>

          <div class="mt-4 text-xs" style="color:var(--muted2)">
            ç›®æ¨™ï¼š<span class="font-mono break-all">${escapeHTML(withGw(resolved))}</span>
          </div>

          <div class="mt-3 flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-pin>${t.pinned ? "å–æ¶ˆç½®é ‚" : "ç½®é ‚"}</button>
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-up>ä¸Šç§»</button>
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-down>ä¸‹ç§»</button>
            </div>
            <div class="text-xs" style="color:var(--muted)">
              ${t.newTab ? "æ–°åˆ†é " : "åŒåˆ†é "}
            </div>
          </div>

          <div data-id="${escapeHTML(t.id)}" style="display:none"></div>
        </div>
      `.replace('<div data-id=', '<div data-id="') // keep data-id
       .replace('style="display:none"></div>', '></div>') // avoid hidden dummy
       .replaceAll('data-id="', 'data-id="')
       .replaceAll('data-open', 'data-open')
       .replaceAll('data-edit', 'data-edit')
       .replaceAll('data-pin', 'data-pin')
       .replaceAll('data-up', 'data-up')
       .replaceAll('data-down', 'data-down');
    }

    // Fix: attach data-id at wrapper (simpler)
    function rebuildCardDataId(){
      grid.querySelectorAll(".card").forEach((card, i)=>{
        const list = getFilteredSortedTools();
        card.setAttribute("data-id", list[i].id);
      });
      grid.querySelectorAll(".card[data-id]").forEach(card=>{
        const id = card.getAttribute("data-id");
        card.querySelector("[data-open]").addEventListener("click", ()=>openTool(findById(id)));
        card.querySelector("[data-edit]").addEventListener("click", ()=>openEditor(findById(id)));
        card.querySelector("[data-pin]").addEventListener("click", ()=>togglePin(id));
        card.querySelector("[data-up]").addEventListener("click", ()=>move(id, -1));
        card.querySelector("[data-down]").addEventListener("click", ()=>move(id, +1));
      });
    }

    // Override render to assign ids correctly
    const _render = render;
    render = function(){
      const list = getFilteredSortedTools();
      countEl.textContent = list.length;
      empty.classList.toggle("hidden", list.length !== 0);
      grid.innerHTML = list.map(t=>`
        <div class="card rounded-3xl p-5" data-id="${escapeHTML(t.id)}">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-start gap-3">
              <div class="h-12 w-12 rounded-2xl flex items-center justify-center"
                   style="background:linear-gradient(135deg, rgba(59,130,246,.14), rgba(16,185,129,.12)); border:1px solid var(--bd);">
                <span class="text-2xl">${escapeHTML(t.icon || "ğŸ§©")}</span>
              </div>
              <div class="min-w-0">
                <div class="text-lg font-extrabold leading-tight truncate">${escapeHTML(t.name || "æœªå‘½åå·¥å…·")}</div>
                <div class="text-sm mt-1" style="color:var(--muted)">${escapeHTML(t.desc || "â€”")}</div>
                <div class="mt-2 text-xs pill inline-flex px-3 py-1 rounded-2xl">${escapeHTML(t.cat || "æœªåˆ†é¡")}</div>
              </div>
            </div>

            <div class="flex flex-col gap-2 items-end">
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-open>é–‹å•Ÿ</button>
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-edit>ç·¨è¼¯</button>
            </div>
          </div>

          <div class="mt-4 text-xs" style="color:var(--muted2)">
            ç›®æ¨™ï¼š<span class="font-mono break-all">${escapeHTML(withGw(resolveToolUrl(t.url)))}</span>
          </div>

          <div class="mt-3 flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-pin>${t.pinned ? "å–æ¶ˆç½®é ‚" : "ç½®é ‚"}</button>
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-up>ä¸Šç§»</button>
              <button class="btn text-xs px-3 py-2 rounded-2xl" data-down>ä¸‹ç§»</button>
            </div>
            <div class="text-xs" style="color:var(--muted)">
              ${t.newTab ? "æ–°åˆ†é " : "åŒåˆ†é "}
            </div>
          </div>
        </div>
      `).join("");

      grid.querySelectorAll(".card[data-id]").forEach(card=>{
        const id = card.getAttribute("data-id");
        card.querySelector("[data-open]").addEventListener("click", ()=>openTool(findById(id)));
        card.querySelector("[data-edit]").addEventListener("click", ()=>openEditor(findById(id)));
        card.querySelector("[data-pin]").addEventListener("click", ()=>togglePin(id));
        card.querySelector("[data-up]").addEventListener("click", ()=>move(id, -1));
        card.querySelector("[data-down]").addEventListener("click", ()=>move(id, +1));
      });
    };

    // ===== tool open =====
    function openTool(t){
      if(!t) return;
      const dest = withGw(resolveToolUrl(t.url));
      // åŒæ­¥ä¿å­˜ GWï¼Œçµ¦å·¥å…·é ç”¨
      localStorage.setItem(K_GW, GW);

      if (t.newTab) window.open(dest, "_blank");
      else location.href = dest;
    }

    // ===== editor =====
    let editingId = null;

    function openEditor(t){
      editingId = t ? t.id : null;
      editTitle.textContent = t ? "ç·¨è¼¯å·¥å…·" : "æ–°å¢å·¥å…·";
      btnDelete.style.display = t ? "" : "none";
      editFoot.textContent = t ? `IDï¼š${t.id}` : "æ–°å¢å¾Œæœƒè‡ªå‹•ç”¢ç”Ÿ ID";

      fName.value = t?.name || "";
      fCat.value = t?.cat || "";
      fUrl.value = t?.url || "";
      fIcon.value = t?.icon || "";
      fDesc.value = t?.desc || "";
      fPinned.checked = !!t?.pinned;
      fNewTab.checked = !!t?.newTab;

      updatePreview();
      editModal.classList.remove("hidden");
      setTimeout(()=>fName.focus(), 0);
    }
    function closeEditor(){ editModal.classList.add("hidden"); }
    editCloseTop.addEventListener("click", closeEditor);
    editModal.addEventListener("click", (e)=>{ if(e.target === editModal) closeEditor(); });

    // Preview updates
    ["input","change"].forEach(ev=>{
      fUrl.addEventListener(ev, updatePreview);
      fName.addEventListener(ev, updatePreview);
      fCat.addEventListener(ev, updatePreview);
      fIcon.addEventListener(ev, updatePreview);
      fPinned.addEventListener(ev, updatePreview);
      fNewTab.addEventListener(ev, updatePreview);
    });

    btnPreviewOpen.addEventListener("click", ()=>{
      const u = previewUrl.textContent.trim();
      if(!u) return;
      window.open(u, "_blank");
    });

    btnPreviewCopy.addEventListener("click", async ()=>{
      const u = previewUrl.textContent.trim();
      if(!u) return;
      try{ await navigator.clipboard.writeText(u); alert("å·²è¤‡è£½"); }
      catch{ prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", u); }
    });

    function updatePreview(){
      const resolved = resolveToolUrl(fUrl.value);
      previewUrl.textContent = resolved ? withGw(resolved) : "ï¼ˆè«‹è¼¸å…¥å·¥å…·ç¶²å€ / è·¯å¾‘ï¼‰";
    }

    btnSaveTool.addEventListener("click", ()=>{
      const name = fName.value.trim() || "æœªå‘½åå·¥å…·";
      const catv = fCat.value.trim();
      const urlv = fUrl.value.trim();
      if(!urlv) return alert("å·¥å…·ç¶²å€ / è·¯å¾‘ ä¸èƒ½ç©ºç™½");

      const obj = {
        id: editingId || uid(),
        name,
        cat: catv,
        url: urlv,
        icon: fIcon.value.trim() || "ğŸ§©",
        desc: fDesc.value.trim(),
        pinned: !!fPinned.checked,
        newTab: !!fNewTab.checked,
        createdAt: editingId ? (findById(editingId)?.createdAt || Date.now()) : Date.now()
      };

      if(editingId){
        TOOLS = TOOLS.map(t=>t.id===editingId ? obj : t);
      } else {
        TOOLS.unshift(obj);
      }

      saveTools();
      rebuildCategoryOptions();
      render();
      closeEditor();
    });

    btnDelete.addEventListener("click", ()=>{
      if(!editingId) return;
      if(!confirm("ç¢ºå®šåˆªé™¤é€™å€‹å·¥å…·ï¼Ÿ")) return;
      TOOLS = TOOLS.filter(t=>t.id !== editingId);
      saveTools();
      rebuildCategoryOptions();
      render();
      closeEditor();
    });

    // ===== pin / move =====
    function togglePin(id){
      TOOLS = TOOLS.map(t=>t.id===id ? ({...t, pinned: !t.pinned}) : t);
      saveTools();
      render();
    }
    function move(id, delta){
      const idx = TOOLS.findIndex(t=>t.id===id);
      if(idx<0) return;
      const next = idx + delta;
      if(next<0 || next>=TOOLS.length) return;
      const arr = TOOLS.slice();
      const [item] = arr.splice(idx, 1);
      arr.splice(next, 0, item);
      TOOLS = arr;
      saveTools();
      render();
    }

    // ===== filtering & sorting =====
    function getFilteredSortedTools(){
      const query = (q.value||"").toLowerCase().trim();
      const catv = (cat.value||"").trim();
      let list = TOOLS.slice();

      if(query){
        list = list.filter(t=>{
          const hay = [t.name,t.cat,t.desc,t.icon,t.url].join(" ").toLowerCase();
          return hay.includes(query);
        });
      }
      if(catv){
        list = list.filter(t=>(t.cat||"")===catv);
      }

      const mode = sort.value;
      if(mode==="pin"){
        list.sort((a,b)=>{
          if(!!b.pinned !== !!a.pinned) return (b.pinned?1:0)-(a.pinned?1:0);
          // stable-ish: keep original order by index in TOOLS
          return TOOLS.indexOf(a) - TOOLS.indexOf(b);
        });
      } else if(mode==="name"){
        list.sort((a,b)=>(a.name||"").localeCompare(b.name||"", "zh-Hant"));
      } else if(mode==="new"){
        list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      }
      return list;
    }

    function rebuildCategoryOptions(){
      const cats = Array.from(new Set(TOOLS.map(t=>t.cat).filter(Boolean)));
      const current = cat.value;
      cat.innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>` + cats.map(c=>`<option value="${escapeAttr(c)}">${escapeHTML(c)}</option>`).join("");
      if(cats.includes(current)) cat.value = current;
    }

    // ===== gateway helpers =====
    function syncGatewayHints(){
      gwHint.textContent = GW;
      toolsRootHint.textContent = GW.replace(/\/+$/,"") + "/";
    }

    function normalizeGW(v){
      const s = String(v||"").trim();
      if(!s) return "";
      // allow user to paste without scheme
      if(!/^https?:\/\//i.test(s)){
        return "https://" + s.replace(/^\/+/, "");
      }
      return s.replace(/\/+$/,"");
    }

    function loadGW(){
      const v = normalizeGW(localStorage.getItem(K_GW)) || DEFAULT_GW;
      localStorage.setItem(K_GW, v);
      return v;
    }

    function loadTools(){
      try{
        const raw = localStorage.getItem(K_TOOLS);
        if(raw){
          const arr = JSON.parse(raw);
          if(Array.isArray(arr)) return arr;
        }
      }catch{}
      localStorage.setItem(K_TOOLS, JSON.stringify(DEFAULT_TOOLS));
      return DEFAULT_TOOLS.slice();
    }

    function saveTools(){
      localStorage.setItem(K_TOOLS, JSON.stringify(TOOLS));
    }

    // ===== URL resolve rules =====
    // url can be:
    // 1) absolute: https://...
    // 2) protocol-relative: //example.com/a
    // 3) absolute-path: /a/b.html  -> GW + /a/b.html
    // 4) relative-path: a/b.html   -> GW + /a/b.html (normalize)
    function resolveToolUrl(input){
      const u = String(input||"").trim();
      if(!u) return "";
      if(/^https?:\/\//i.test(u)) return u;
      if(/^\/\//.test(u)) return "https:" + u;

      const base = GW.replace(/\/+$/,"");
      if(u.startsWith("/")) return base + u;

      // relative -> treat as "/"+u
      return base + "/" + u.replace(/^\/+/, "");
    }

    // attach gw param (also keep existing query)
    function withGw(url){
      if(!url) return "";
      const gw = encodeURIComponent(GW);
      const hasQ = url.includes("?");
      // avoid duplicate gw= if already present
      if(/[\?&]gw=/.test(url)) return url;
      return url + (hasQ ? "&" : "?") + "gw=" + gw;
    }

    // ===== modals =====
    function openHelp(){ helpModal.classList.remove("hidden"); }
    function closeHelp(){ helpModal.classList.add("hidden"); }

    function openIO(title){
      ioTitle.textContent = title;
      ioModal.classList.remove("hidden");
      setTimeout(()=>ioText.focus(), 0);
    }
    function closeIO(){ ioModal.classList.add("hidden"); }

    // ===== utils =====
    function uid(){
      return "t_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
    }
    function findById(id){ return TOOLS.find(t=>t.id===id); }

    function escapeHTML(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
    function escapeAttr(s){ return escapeHTML(s).replaceAll('"',"&quot;"); }
  </script>
</body>
</html>
