<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å•åˆ¸è¦å‰‡å¾Œå° Proï¼ˆKV ç‰ˆæœ¬åŒ–ãƒ»å¯è¦–åŒ–ãƒ»å¯æ¸¬è©¦ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --ring: 0 0 0 4px rgba(59,130,246,.15); }
    .glass{ background: rgba(255,255,255,.85); backdrop-filter: blur(10px); }
    .btn{ @apply px-3 py-2 rounded-lg font-bold text-sm transition; }
    .btn-primary{ @apply bg-blue-600 text-white hover:bg-blue-700; }
    .btn-dark{ @apply bg-slate-900 text-white hover:bg-black; }
    .btn-ghost{ @apply bg-white hover:bg-slate-50 border; }
    .btn-danger{ @apply bg-rose-600 text-white hover:bg-rose-700; }
    .chip{ @apply text-[11px] px-2 py-1 rounded-full bg-slate-100 border text-slate-600; }
    .card{ @apply bg-white rounded-2xl shadow-sm border; }
    .field{ @apply w-full border rounded-xl px-3 py-2 bg-white focus:outline-none; }
    .field:focus{ box-shadow: var(--ring); border-color: rgb(59,130,246); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kbd{ @apply px-2 py-1 rounded border bg-slate-50 text-[11px] mono; }
    .tab-active{ @apply bg-blue-600 text-white border-blue-600; }
    .tab{ @apply px-3 py-2 rounded-xl border text-sm font-bold hover:bg-slate-50; }
    .help a{ text-decoration: underline; }
    .subtle{ background-image: radial-gradient(circle at 10% 10%, rgba(59,130,246,.12), transparent 35%),
                               radial-gradient(circle at 90% 20%, rgba(16,185,129,.10), transparent 40%),
                               radial-gradient(circle at 30% 90%, rgba(244,63,94,.08), transparent 35%); }
    .toast{
      position: fixed; right: 16px; bottom: 16px; z-index: 50;
      min-width: 260px; max-width: 360px;
    }
  </style>
</head>

<body class="bg-slate-100 subtle text-slate-800 min-h-screen">
  <!-- Header -->
  <div class="sticky top-0 z-40">
    <div class="glass border-b">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-blue-600 text-white flex items-center justify-center font-black">KV</div>
          <div>
            <div class="text-lg font-black leading-tight">å•åˆ¸è¦å‰‡å¾Œå° Pro</div>
            <div class="text-xs text-slate-500">ç‰ˆæœ¬åŒ–ãƒ»åˆ†é ç·¨è¼¯ãƒ»ä¸€éµæ¸¬è©¦ãƒ»KV å³æ™‚ç”Ÿæ•ˆï¼ˆä¸ç”¨æ”¹ worker.jsï¼‰</div>
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap justify-end">
          <button id="btnGuide" class="btn btn-ghost">ğŸ“˜ æ•™å­¸</button>
          <button id="btnHealth" class="btn btn-ghost">âœ… é€£ç·šæª¢æŸ¥</button>
          <button id="btnLoad" class="btn btn-dark">è®€å–</button>
          <button id="btnSave" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- Config Bar -->
    <div class="bg-white border-b">
      <div class="max-w-7xl mx-auto px-4 py-3 grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
        <label class="lg:col-span-5">
          <div class="text-xs font-bold text-slate-500 mb-1">Worker API Base</div>
          <input id="apiBase" class="field" placeholder="https://api.xxx.workers.dev">
          <div class="text-[11px] text-slate-500 mt-1">ä¸è¦åŠ è·¯å¾‘ï¼Œåªå¡«ç¶²åŸŸï¼ˆä¾‹å¦‚ <span class="kbd">https://api.zxcv8096.workers.dev</span>ï¼‰</div>
        </label>

        <label class="lg:col-span-3">
          <div class="text-xs font-bold text-slate-500 mb-1">ADMIN_KEYï¼ˆæœ‰è¨­æ‰å¡«ï¼‰</div>
          <input id="adminKey" class="field" placeholder="å¯ç•™ç©º">
          <div class="text-[11px] text-slate-500 mt-1">å»ºè­°åœ¨ Cloudflare è¨­ Secretï¼š<span class="kbd">ADMIN_KEY</span> ä»¥å…è¢«äº‚æ”¹</div>
        </label>

        <label class="lg:col-span-2">
          <div class="text-xs font-bold text-slate-500 mb-1">å•åˆ¸ Key</div>
          <input id="surveyKey" class="field font-black" value="health_v1">
          <div class="text-[11px] text-slate-500 mt-1">ä¾‹å¦‚ï¼šhealth_v1 / health_v2 / women_v1</div>
        </label>

        <div class="lg:col-span-2 flex gap-2">
          <button id="btnNew" class="btn btn-ghost w-full">â• æ–°è¦å‰‡</button>
          <button id="btnClone" class="btn btn-ghost w-full">ğŸ§¬ è¤‡è£½</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 xl:grid-cols-12 gap-4">
    <!-- Left: Navigator -->
    <div class="xl:col-span-4 space-y-4">
      <!-- Quick status -->
      <div class="card p-4">
        <div class="flex items-center justify-between gap-2">
          <div class="font-black">ç‹€æ…‹</div>
          <div id="statusChip" class="chip">å°šæœªé€£ç·š</div>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border">
            <div class="text-xs text-slate-500 font-bold">ç›®å‰ç‰ˆæœ¬</div>
            <div id="metaVersion" class="font-black mt-1">â€”</div>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border">
            <div class="text-xs text-slate-500 font-bold">æœ€å¾Œæ›´æ–°</div>
            <div id="metaUpdated" class="font-black mt-1">â€”</div>
          </div>
        </div>

        <div class="mt-3 p-3 rounded-xl bg-blue-50 border border-blue-100 text-blue-800 text-sm help">
          <div class="font-black mb-1">æœ€ä½³å¯¦å‹™ï¼ˆé¿å…çˆ†ç‚¸ï¼‰</div>
          <ul class="list-disc pl-5 space-y-1 text-[13px]">
            <li>æ¯æ¬¡æ”¹è¦å‰‡å…ˆ <b>è¤‡è£½</b> åšæ–°ç‰ˆæœ¬ï¼š<span class="kbd">health_v2</span></li>
            <li>ç¨‹å¼ä¸å‹•ã€è¦å‰‡å‹•ï¼šä¿® bug æ”¹é€™è£¡å°±å¥½</li>
            <li>å…ˆç”¨ã€Œä¸€éµæ¸¬è©¦ã€è·‘éå†å„²å­˜</li>
          </ul>
        </div>
      </div>

      <!-- Section tabs -->
      <div class="card p-3">
        <div class="font-black px-1">ç·¨è¼¯å€å¡Š</div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button class="tab tab-active" data-tab="dimensions">â‘  ç¶­åº¦/é¡Œç›®</button>
          <button class="tab" data-tab="thresholds">â‘¡ é–€æª»</button>
          <button class="tab" data-tab="tips">â‘¢ ä»Šæ—¥èª¿æ•´</button>
          <button class="tab" data-tab="nutrients">â‘£ ç‡Ÿé¤Šç´ /é€£çµ</button>
          <button class="tab" data-tab="report">â‘¤ å ±å‘Šè¨­å®š</button>
          <button class="tab" data-tab="json">â‘¥ é€²éš JSON</button>
        </div>
      </div>

      <!-- Test panel -->
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div class="font-black">ä¸€éµæ¸¬è©¦</div>
          <button id="btnRunTest" class="btn btn-dark">â–¶ï¸ é€å‡ºæ¸¬è©¦</button>
        </div>
        <div class="text-sm text-slate-500 mt-1">ç”¨ä½ å¡«çš„ç­”æ¡ˆï¼Œç›´æ¥å‘¼å« <span class="kbd">/survey/submit</span> çœ‹å ±å‘Šçµæœã€‚</div>

        <div class="mt-3">
          <div class="flex items-center justify-between">
            <div class="text-xs font-bold text-slate-500">æ¸¬è©¦ç­”æ¡ˆï¼ˆJSONï¼‰</div>
            <button id="btnGenTemplateAns" class="btn btn-ghost py-1.5 px-2 text-xs">ç”Ÿæˆç¯„æœ¬</button>
          </div>
          <textarea id="testAnswers" class="field mono h-[160px] text-xs mt-1" placeholder='{"q_sleep_quality":2,"q_sleep_latency":1}'></textarea>
        </div>

        <div class="mt-3">
          <div class="text-xs font-bold text-slate-500 mb-1">æ¸¬è©¦çµæœï¼ˆé è¦½ï¼‰</div>
          <div id="testResult" class="p-3 rounded-xl bg-slate-50 border text-sm text-slate-700 whitespace-pre-wrap min-h-[90px]">å°šæœªæ¸¬è©¦</div>
        </div>
      </div>
    </div>

    <!-- Right: Editor -->
    <div class="xl:col-span-8 space-y-4">
      <!-- Dimensions -->
      <div id="panel-dimensions" class="card p-4">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div>
            <div class="font-black text-lg">â‘  ç¶­åº¦ / é¡Œç›®æ¬Šé‡</div>
            <div class="text-sm text-slate-500">æ–°å¢ç¶­åº¦ã€è¨­å®šæ¯é¡Œé¸é …å°æ‡‰åˆ†æ•¸ï¼ˆåˆ†æ•¸è¶Šä½ = è¶Šéœ€è¦å„ªå…ˆæ”¹å–„ï¼‰</div>
          </div>
          <div class="flex gap-2">
            <button id="btnAddDim" class="btn btn-ghost">â• æ–°å¢ç¶­åº¦</button>
            <button id="btnAddQ" class="btn btn-ghost">â• æ–°å¢é¡Œç›®æ˜ å°„</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div>
            <div class="text-xs font-bold text-slate-500 mb-2">ç¶­åº¦åˆ—è¡¨</div>
            <div id="dimList" class="space-y-2"></div>
          </div>

          <div class="p-3 rounded-2xl bg-slate-50 border">
            <div class="flex items-center justify-between">
              <div class="font-black">ç·¨è¼¯ç¶­åº¦</div>
              <div id="dimHint" class="text-xs text-slate-500">é¸ä¸€å€‹ç¶­åº¦é–‹å§‹</div>
            </div>

            <div id="dimEditor" class="mt-3 hidden space-y-3">
              <label>
                <div class="text-xs font-bold text-slate-500 mb-1">ç¶­åº¦ Keyï¼ˆè‹±æ–‡/åº•ç·šï¼‰</div>
                <input id="dimKey" class="field mono" placeholder="sleep">
              </label>
              <label>
                <div class="text-xs font-bold text-slate-500 mb-1">ç¶­åº¦æ¨™é¡Œï¼ˆé¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼‰</div>
                <input id="dimTitle" class="field" placeholder="ç¡çœ æ¢å¾©">
              </label>

              <div class="p-3 rounded-xl bg-white border">
                <div class="flex items-center justify-between">
                  <div class="font-black text-sm">é¡Œç›®æ˜ å°„ï¼ˆquestionsï¼‰</div>
                  <div class="text-xs text-slate-500">æ ¼å¼ï¼šqid â†’ é¸é …å€¼ â†’ åˆ†æ•¸</div>
                </div>
                <textarea id="dimQuestions" class="field mono h-[210px] text-xs mt-2"
                  placeholder='{"q_sleep_quality":{"0":0,"1":-1,"2":-2,"3":-3}}'></textarea>
                <div class="mt-2 flex items-center justify-between gap-2">
                  <button id="btnApplyDim" class="btn btn-primary">å¥—ç”¨åˆ°è¦å‰‡</button>
                  <button id="btnDeleteDim" class="btn btn-danger">åˆªé™¤æ­¤ç¶­åº¦</button>
                </div>
              </div>

              <div class="text-[11px] text-slate-500">
                å°æŠ€å·§ï¼šqid å»ºè­°å›ºå®šå‘½åï¼Œä¾‹å¦‚ <span class="kbd">q_sleep_quality</span>ï¼Œå‰ç«¯/LINE å›å‚³ç­”æ¡ˆå°±ç”¨åŒæ¨£ keyã€‚
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Thresholds -->
      <div id="panel-thresholds" class="card p-4 hidden">
        <div class="font-black text-lg">â‘¡ é–€æª»ï¼ˆåˆ†ç´šï¼‰</div>
        <div class="text-sm text-slate-500 mt-1">æ¯å€‹ç¶­åº¦å¯è¨­å®šï¼šgoodMin / okMinã€‚åˆ†æ•¸ â‰¥ goodMin â†’ goodï¼›åˆ†æ•¸ â‰¥ okMin â†’ okï¼›å…¶é¤˜ â†’ lowã€‚</div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div class="p-3 rounded-2xl bg-slate-50 border">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">é è¨­é–€æª»ï¼ˆ_defaultï¼‰</div>
              <button id="btnApplyDefaultTh" class="btn btn-primary">å¥—ç”¨</button>
            </div>
            <div class="mt-2 grid grid-cols-2 gap-2">
              <label>
                <div class="text-xs font-bold text-slate-500 mb-1">goodMin</div>
                <input id="thDefaultGood" class="field mono" type="number" value="0">
              </label>
              <label>
                <div class="text-xs font-bold text-slate-500 mb-1">okMin</div>
                <input id="thDefaultOk" class="field mono" type="number" value="-2">
              </label>
            </div>
            <div class="text-[11px] text-slate-500 mt-2">è‹¥æŸç¶­åº¦æ²’æœ‰å–®ç¨è¨­å®šï¼Œå°±æœƒåƒ _defaultã€‚</div>
          </div>

          <div class="p-3 rounded-2xl bg-white border">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">å„ç¶­åº¦é–€æª»</div>
              <button id="btnRebuildThList" class="btn btn-ghost">é‡æ–°ç”Ÿæˆåˆ—è¡¨</button>
            </div>
            <div id="thList" class="mt-2 space-y-2"></div>
            <div class="text-[11px] text-slate-500 mt-2">ä½ å¯ä»¥å–®ç¨å¾®èª¿æŸä¸€ç¶­åº¦çš„åš´æ ¼ç¨‹åº¦ï¼Œä¿® bug ä¸ç”¨æ”¹ç¨‹å¼ã€‚</div>
          </div>
        </div>
      </div>

      <!-- Tips -->
      <div id="panel-tips" class="card p-4 hidden">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div>
            <div class="font-black text-lg">â‘¢ ä»Šæ—¥å¯åšèª¿æ•´ï¼ˆTipsï¼‰</div>
            <div class="text-sm text-slate-500">ç”¨ key ç®¡ç†ï¼š<span class="kbd">ç¶­åº¦_level</span>ï¼ˆä¾‹å¦‚ sleep_low / stress_okï¼‰</div>
          </div>
          <div class="flex gap-2">
            <button id="btnAddTipKey" class="btn btn-ghost">â• æ–°å¢ key</button>
            <button id="btnApplyTips" class="btn btn-primary">å¥—ç”¨æ•´å€</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div>
            <div class="text-xs font-bold text-slate-500 mb-2">Tips keys</div>
            <div id="tipKeyList" class="space-y-2"></div>
          </div>
          <div class="p-3 rounded-2xl bg-slate-50 border">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">ç·¨è¼¯å…§å®¹ï¼ˆé™£åˆ—ï¼‰</div>
              <div id="tipHint" class="text-xs text-slate-500">é¸ä¸€å€‹ key</div>
            </div>
            <textarea id="tipEditor" class="field mono h-[260px] text-xs mt-2" placeholder='["ä»Šæ™šææ—©30åˆ†é˜ä¸ŠåºŠ","ç¡å‰2å°æ™‚ä¸å–å«å’–å•¡å› "]'></textarea>
            <div class="mt-2 flex items-center justify-between">
              <button id="btnDeleteTipKey" class="btn btn-danger">åˆªé™¤æ­¤ key</button>
              <button id="btnApplyTipOne" class="btn btn-primary">å¥—ç”¨æ­¤ key</button>
            </div>
            <div class="text-[11px] text-slate-500 mt-2">å»ºè­°æ¯å€‹ key 2â€“5 æ¢ï¼ŒçŸ­å¥ã€å¯ç«‹åˆ»åšåˆ°ã€ä¸è¦é†«ç™‚ç”¨èªã€‚</div>
          </div>
        </div>
      </div>

      <!-- Nutrients -->
      <div id="panel-nutrients" class="card p-4 hidden">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div>
            <div class="font-black text-lg">â‘£ å»ºè­°ç‡Ÿé¤Šç´  & ç”¢å“é€£çµ</div>
            <div class="text-sm text-slate-500">ç‡Ÿé¤Šç´ ä»¥ key ç®¡ç†ï¼š<span class="kbd">ç¶­åº¦_level</span>ï¼›ç”¢å“ç›®éŒ„ä»¥ã€Œç‡Ÿé¤Šç´ åç¨±ã€å°æ‡‰é€£çµ</div>
          </div>
          <div class="flex gap-2">
            <button id="btnApplyNutrients" class="btn btn-primary">å¥—ç”¨ç‡Ÿé¤Šç´ å€</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div class="p-3 rounded-2xl bg-slate-50 border">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">Nutrientsï¼ˆkey â†’ é™£åˆ—ï¼‰</div>
              <button id="btnGenNutKeys" class="btn btn-ghost">ç”Ÿæˆå¸¸ç”¨ keys</button>
            </div>
            <textarea id="nutrientsJson" class="field mono h-[310px] text-xs mt-2"
              placeholder='{"sleep_low":["é‚","ç¶­ç”Ÿç´ Bç¾¤"]}'></textarea>
            <div class="text-[11px] text-slate-500 mt-2">é€™è£¡åªæ”¾ã€Œåç¨±ã€ï¼Œé€£çµåœ¨å³å´ products ç›®éŒ„è¨­å®šã€‚</div>
          </div>

          <div class="p-3 rounded-2xl bg-white border">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">Productsï¼ˆç‡Ÿé¤Šç´  â†’ {name,url}ï¼‰</div>
              <button id="btnApplyProducts" class="btn btn-primary">å¥—ç”¨ç›®éŒ„</button>
            </div>
            <textarea id="productsJson" class="field mono h-[310px] text-xs mt-2"
              placeholder='{"é‚":{"name":"é‚ï¼ˆç”¢å“ï¼‰","url":"https://..."} }'></textarea>
            <div class="text-[11px] text-slate-500 mt-2">ä½ å¯ä»¥æŠŠ url æ›æˆä½ æ¯å€‹å¤¥ä¼´/å®¢æˆ¶å°ˆå±¬é€£çµï¼ˆæœªä¾†ä¹Ÿå¯åšå‹•æ…‹ï¼‰ã€‚</div>
          </div>
        </div>
      </div>

      <!-- Report -->
      <div id="panel-report" class="card p-4 hidden">
        <div class="font-black text-lg">â‘¤ å ±å‘Šè¨­å®š</div>
        <div class="text-sm text-slate-500 mt-1">æ§åˆ¶é¡¯ç¤ºæ‘˜è¦ã€å„ªå…ˆæ–¹å‘æ•¸é‡ã€èªæ°£ï¼ˆé¿å…ç¡¬æ¨ï¼‰ã€‚</div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div class="p-3 rounded-2xl bg-slate-50 border">
            <div class="font-black text-sm">åŸºæœ¬</div>
            <label class="block mt-2">
              <div class="text-xs font-bold text-slate-500 mb-1">å„ªå…ˆæ–¹å‘æ•¸é‡ topPriorityCount</div>
              <input id="topPriorityCount" class="field mono" type="number" min="1" max="8" value="3">
            </label>
            <label class="block mt-3">
              <div class="text-xs font-bold text-slate-500 mb-1">ä¸€èˆ¬æ‘˜è¦ summaryDefault</div>
              <textarea id="summaryDefault" class="field h-[110px]"></textarea>
            </label>
            <label class="block mt-3">
              <div class="text-xs font-bold text-slate-500 mb-1">ç‹€æ…‹å¾ˆå¥½æ‘˜è¦ summaryAllGood</div>
              <textarea id="summaryAllGood" class="field h-[110px]"></textarea>
            </label>
            <div class="mt-3 flex justify-end">
              <button id="btnApplyReport" class="btn btn-primary">å¥—ç”¨å ±å‘Šè¨­å®š</button>
            </div>
          </div>

          <div class="p-3 rounded-2xl bg-white border">
            <div class="font-black text-sm">å»ºè­°å¯«æ³•ï¼ˆæ•™å­¸ï¼‰</div>
            <div class="mt-2 text-sm text-slate-700 leading-relaxed help">
              <ul class="list-disc pl-5 space-y-2">
                <li><b>çŸ­å¥ã€å¯åŸ·è¡Œ</b>ï¼šä¾‹å¦‚ã€Œæ™šé¤å¾Œæ•£æ­¥ 10 åˆ†é˜ã€</li>
                <li><b>é¿å…é†«ç™‚ç”¨èª</b>ï¼šä¸è¦å¯«ã€Œè¨ºæ–·ã€ã€Œæ²»ç™‚ã€</li>
                <li><b>ç‹€æ…‹å¾ˆå¥½æ™‚ä¸ç¡¬æ¨</b>ï¼šç”¨ã€Œç¶­æŒå»ºè­°ã€èªæ°£</li>
                <li>å ±å‘Šçµæ§‹ï¼š<span class="kbd">æ‘˜è¦</span> + <span class="kbd">å„ªå…ˆæ–¹å‘</span> + <span class="kbd">ä»Šæ—¥å¯åš</span> + <span class="kbd">ç‡Ÿé¤Šç´ </span> + <span class="kbd">ç”¢å“é€£çµ(å¯é¸)</span></li>
              </ul>

              <div class="mt-4 p-3 rounded-xl bg-blue-50 border border-blue-100 text-blue-800">
                <div class="font-black mb-1">ä½ æœªä¾†æœƒå¾ˆçœäº‹çš„é»</div>
                <div class="text-sm">ç•¶ä½ æƒ³èª¿æ•´ã€Œåˆ¤æ–·æº–ä¸æº–ã€ï¼šæ”¹ <span class="kbd">dimensions/questions</span> æˆ– <span class="kbd">thresholds</span>ï¼›ç•¶ä½ æƒ³èª¿æ•´ã€Œèªªæ³•å¥½ä¸å¥½ã€ï¼šæ”¹ <span class="kbd">tips/nutrients/report</span>ã€‚ä¸ç”¨å†ç¢° worker.jsã€‚</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- JSON Advanced -->
      <div id="panel-json" class="card p-4 hidden">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div>
            <div class="font-black text-lg">â‘¥ é€²éš JSONï¼ˆå®Œæ•´ rulesï¼‰</div>
            <div class="text-sm text-slate-500">çµ¦é€²éšä½¿ç”¨ï¼šå¯ç›´æ¥è²¼æ•´ä»½ rulesï¼Œæˆ–åŒ¯å‡ºå‚™ä»½ã€‚</div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button id="btnValidate" class="btn btn-ghost">ğŸ” æª¢æŸ¥</button>
            <button id="btnExport" class="btn btn-ghost">â¬‡ï¸ åŒ¯å‡º</button>
            <label class="btn btn-ghost cursor-pointer">
              â¬†ï¸ åŒ¯å…¥
              <input id="importFile" type="file" accept="application/json" class="hidden">
            </label>
            <button id="btnApplyJson" class="btn btn-primary">å¥—ç”¨åˆ°è¡¨å–®</button>
          </div>
        </div>

        <textarea id="rulesJson" class="field mono h-[520px] text-xs mt-4" placeholder="å®Œæ•´ rules JSON..."></textarea>
        <div id="validateResult" class="mt-3 text-sm text-slate-600"></div>
      </div>
    </div>
  </div>

  <!-- Guide Modal -->
  <div id="guideModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl shadow-xl max-w-3xl w-full overflow-hidden">
      <div class="p-4 border-b flex items-center justify-between">
        <div class="font-black text-lg">ğŸ“˜ æ•™å­¸ï¼ˆ3 åˆ†é˜ä¸Šæ‰‹ï¼‰</div>
        <button id="btnCloseGuide" class="btn btn-ghost">é—œé–‰</button>
      </div>
      <div class="p-5 space-y-4 text-sm text-slate-700">
        <div class="p-4 rounded-2xl bg-slate-50 border">
          <div class="font-black">ä½ åœ¨åšä»€éº¼ï¼Ÿ</div>
          <div class="mt-1 leading-relaxed">
            é€™é æ˜¯åœ¨ç·¨è¼¯ã€Œrules è¦å‰‡ã€ï¼Œä¸¦å­˜åˆ° Cloudflare KVã€‚Worker åªè² è²¬è®€ rules ä¾†ç”¢å ±å‘Šï¼Œæ‰€ä»¥ä½ ä¿® bug æˆ–æ”¹æ–‡æ¡ˆæ™‚ï¼Œä¸ç”¨å†æ”¹ worker.jsã€‚
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="p-4 rounded-2xl bg-blue-50 border border-blue-100">
            <div class="font-black text-blue-900">â‘  ç¶­åº¦/é¡Œç›®</div>
            <div class="mt-1 text-blue-900/90 leading-relaxed">
              æ¯å€‹ç¶­åº¦æ˜¯ä¸€å€‹æ–¹å‘ï¼ˆç¡çœ /å£“åŠ›/è…¸èƒƒï¼‰ã€‚é¡Œç›®æ˜ å°„ç”¨ qid å°æ‡‰é¸é …åˆ†æ•¸ã€‚<b>åˆ†æ•¸è¶Šä½ï¼è¶Šéœ€è¦å„ªå…ˆæ”¹å–„</b>ã€‚
            </div>
          </div>
          <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
            <div class="font-black text-emerald-900">â‘¡ é–€æª»</div>
            <div class="mt-1 text-emerald-900/90 leading-relaxed">
              æ§åˆ¶ low/ok/good çš„åˆ†ç•Œã€‚è¦ºå¾—å¤ªåš´æ ¼æˆ–å¤ªå¯¬é¬†ï¼Œåªè¦æ”¹é–€æª»ï¼Œä¸ç”¨æ”¹ç¨‹å¼ã€‚
            </div>
          </div>
          <div class="p-4 rounded-2xl bg-amber-50 border border-amber-100">
            <div class="font-black text-amber-900">â‘¢ ä»Šæ—¥èª¿æ•´</div>
            <div class="mt-1 text-amber-900/90 leading-relaxed">
              ç”¨ keyï¼š<span class="kbd">sleep_low</span>ï¼Œæ”¾ 2â€“5 æ¢çŸ­å¥ã€‚è¶Šè²¼è¿‘ç”Ÿæ´»è¶Šå¥½ã€‚
            </div>
          </div>
          <div class="p-4 rounded-2xl bg-rose-50 border border-rose-100">
            <div class="font-black text-rose-900">â‘£ ç‡Ÿé¤Šç´ /é€£çµ</div>
            <div class="mt-1 text-rose-900/90 leading-relaxed">
              nutrients åªæ”¾åç¨±ï¼ˆå¦‚ã€Œé‚ã€ï¼‰ï¼Œproducts æ‰æ”¾ urlã€‚è¦æ›é€£çµä¸ç”¨æ”¹ç¨‹å¼ã€‚
            </div>
          </div>
        </div>

        <div class="p-4 rounded-2xl bg-slate-50 border">
          <div class="font-black">æœ€æ¨è–¦å·¥ä½œæµç¨‹ï¼ˆä¸è¸©é›·ï¼‰</div>
          <ol class="list-decimal pl-5 mt-2 space-y-1">
            <li>å…ˆæŒ‰ <b>è®€å–</b> å–å¾—ç›®å‰ç‰ˆæœ¬</li>
            <li>è¦å¤§æ”¹æ™‚å…ˆæŒ‰ <b>è¤‡è£½</b> â†’ æ”¹æˆæ–°ç‰ˆæœ¬ keyï¼ˆå¦‚ health_v2ï¼‰</li>
            <li>æ”¹å®ŒæŒ‰ <b>é€å‡ºæ¸¬è©¦</b> çœ‹çµæœ</li>
            <li>OK å†æŒ‰ <b>å„²å­˜</b>ï¼ˆç«‹åˆ»ç”Ÿæ•ˆï¼‰</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast space-y-2 pointer-events-none" id="toastWrap"></div>

<script>
/* ======================
   Pro KV Rules Admin
   Endpoints needed on Worker:
   - GET  /health
   - POST /survey/rules/get   {surveyKey}
   - POST /survey/rules/set   {surveyKey, rules}   (X-Admin-Key optional)
   - POST /survey/submit      {surveyKey, answers}
   ====================== */

const $ = (id) => document.getElementById(id);

const state = {
  rules: null,
  selectedDimKey: null,
  selectedTipKey: null,
  lastLoadedText: "",
};

function toast(msg, type="ok"){
  const wrap = $("toastWrap");
  const el = document.createElement("div");
  el.className = "pointer-events-auto card p-3 flex items-start gap-3";
  el.innerHTML = `
    <div class="w-9 h-9 rounded-2xl flex items-center justify-center font-black ${
      type==="ok" ? "bg-emerald-600 text-white" :
      type==="warn" ? "bg-amber-500 text-white" :
      "bg-rose-600 text-white"
    }">${type==="ok"?"âœ“":type==="warn"?"!":"Ã—"}</div>
    <div class="flex-1">
      <div class="font-black text-sm">${escapeHtml(msg)}</div>
      <div class="text-xs text-slate-500 mt-0.5">${new Date().toLocaleString()}</div>
    </div>
  `;
  wrap.appendChild(el);
  setTimeout(()=>{ el.classList.add("opacity-0"); el.style.transition="opacity .35s"; }, 2800);
  setTimeout(()=>{ el.remove(); }, 3300);
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function normalizeBase(s){
  s = (s||"").trim();
  if(!s) return "";
  if(!/^https?:\/\//i.test(s)) s = "https://" + s;
  return s.replace(/\/+$/,"");
}

function apiBase(){ return normalizeBase($("apiBase").value); }
function adminKey(){ return ($("adminKey").value||"").trim(); }
function surveyKey(){ return ($("surveyKey").value||"").trim(); }

async function postJSON(path, body){
  const base = apiBase();
  if(!base) throw new Error("è«‹å…ˆå¡« Worker API Base");
  const headers = { "Content-Type": "application/json" };
  const k = adminKey();
  if(k) headers["X-Admin-Key"] = k;

  const res = await fetch(base + path, { method:"POST", headers, body: JSON.stringify(body) });
  const ct = res.headers.get("content-type") || "";
  const payload = ct.includes("application/json") ? await res.json() : await res.text();
  if(!res.ok){
    const msg = typeof payload === "string" ? payload : (payload?.error || ("HTTP " + res.status));
    throw new Error(msg);
  }
  return payload;
}

async function getHealth(){
  const base = apiBase();
  if(!base) throw new Error("è«‹å…ˆå¡« Worker API Base");
  const res = await fetch(base + "/health");
  const t = await res.text();
  if(!res.ok) throw new Error("health å¤±æ•—ï¼š" + t);
  return t;
}

function setStatus(text, type="neutral"){
  const chip = $("statusChip");
  chip.textContent = text;
  chip.className = "chip " + (
    type==="ok" ? "bg-emerald-50 border-emerald-200 text-emerald-700" :
    type==="bad" ? "bg-rose-50 border-rose-200 text-rose-700" :
    type==="warn" ? "bg-amber-50 border-amber-200 text-amber-700" :
    "bg-slate-100 border text-slate-600"
  );
}

function ensureRules(){
  if(!state.rules){
    state.rules = {
      report: { topPriorityCount: 3, summaryDefault: "ä»¥ä¸‹æ˜¯ä½ ç›®å‰æœ€å„ªå…ˆå¯ä»¥èª¿æ•´çš„æ–¹å‘ï¼Œå…ˆåšç°¡å–®çš„æ—¥å¸¸å¾®èª¿å°±æœƒæœ‰æ„Ÿã€‚", summaryAllGood: "æ•´é«”ç‹€æ…‹å¾ˆä¸éŒ¯ï¼Œå»ºè­°ç¶­æŒç›®å‰ç¯€å¥ï¼Œå°ˆæ³¨åœ¨è¦å¾‹ä½œæ¯èˆ‡è¶³é‡æ°´åˆ†ã€‚" },
      thresholds: { _default: { goodMin: 0, okMin: -2 } },
      dimensions: {},
      tips: {},
      nutrients: {},
      products: {}
    };
  }
  // normalize required nodes
  state.rules.report ||= { topPriorityCount: 3, summaryDefault:"", summaryAllGood:"" };
  state.rules.thresholds ||= { _default:{ goodMin:0, okMin:-2 } };
  state.rules.dimensions ||= {};
  state.rules.tips ||= {};
  state.rules.nutrients ||= {};
  state.rules.products ||= {};
}

function rulesToText(){
  ensureRules();
  return JSON.stringify(state.rules, null, 2);
}

function loadTextToRules(txt){
  const obj = JSON.parse(txt);
  if(!obj || typeof obj !== "object") throw new Error("rules å¿…é ˆæ˜¯ object");
  if(!obj.dimensions || typeof obj.dimensions !== "object") throw new Error("rules.dimensions å¿…é ˆå­˜åœ¨");
  state.rules = obj;
  ensureRules();
}

function validateRulesObj(obj){
  const errs = [];
  if(!obj || typeof obj !== "object") errs.push("rules ä¸æ˜¯ object");
  if(!obj.dimensions || typeof obj.dimensions !== "object") errs.push("rules.dimensions ç¼ºå°‘æˆ–ä¸æ˜¯ object");
  if(!obj.thresholds || typeof obj.thresholds !== "object") errs.push("rules.thresholds ç¼ºå°‘æˆ–ä¸æ˜¯ object");
  if(!obj.report || typeof obj.report !== "object") errs.push("rules.report ç¼ºå°‘æˆ–ä¸æ˜¯ object");

  // validate dimensions/questions mapping shape (light)
  if(obj.dimensions && typeof obj.dimensions === "object"){
    for(const [dk, dim] of Object.entries(obj.dimensions)){
      if(!dim.title) errs.push(`dimensions.${dk}.title ç¼ºå°‘`);
      if(!dim.questions || typeof dim.questions !== "object") errs.push(`dimensions.${dk}.questions ç¼ºå°‘æˆ–ä¸æ˜¯ object`);
    }
  }

  // validate products urls if present
  if(obj.products && typeof obj.products === "object"){
    for(const [nut, p] of Object.entries(obj.products)){
      if(p && typeof p === "object" && p.url){
        if(!/^https?:\/\//i.test(String(p.url))) errs.push(`products["${nut}"].url ä¸æ˜¯ http(s)`);
      }
    }
  }

  return errs;
}

/* ---------- Tabs / Panels ---------- */
const panels = ["dimensions","thresholds","tips","nutrients","report","json"];
function showTab(name){
  panels.forEach(p=>{
    $("panel-"+p).classList.toggle("hidden", p!==name);
  });
  document.querySelectorAll(".tab").forEach(btn=>{
    const active = btn.dataset.tab === name;
    btn.classList.toggle("tab-active", active);
    if(active) btn.classList.add("tab-active"); else btn.classList.remove("tab-active");
  });

  // when switching to json tab, refresh full rules json
  if(name === "json"){
    $("rulesJson").value = rulesToText();
    $("validateResult").textContent = "";
  }
}

document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=> showTab(btn.dataset.tab));
});

/* ---------- Renderers ---------- */
function setMeta(versionText="â€”", updatedText="â€”"){
  $("metaVersion").textContent = versionText;
  $("metaUpdated").textContent = updatedText;
}

function renderDimList(){
  ensureRules();
  const box = $("dimList");
  box.innerHTML = "";
  const entries = Object.entries(state.rules.dimensions);
  if(entries.length === 0){
    box.innerHTML = `<div class="text-sm text-slate-500">å°šæœªå»ºç«‹ç¶­åº¦ï¼ŒæŒ‰ã€Œæ–°å¢ç¶­åº¦ã€é–‹å§‹ã€‚</div>`;
    return;
  }
  for(const [key, dim] of entries){
    const row = document.createElement("button");
    row.className = "w-full text-left p-3 rounded-2xl border bg-white hover:bg-slate-50 transition";
    const active = state.selectedDimKey === key;
    if(active) row.classList.add("ring-2","ring-blue-200","border-blue-300");
    row.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-black">${escapeHtml(dim.title || key)}</div>
        <span class="chip">${escapeHtml(key)}</span>
      </div>
      <div class="text-xs text-slate-500 mt-1">é¡Œç›®æ•¸ï¼š${Object.keys(dim.questions||{}).length}</div>
    `;
    row.onclick = ()=> selectDim(key);
    box.appendChild(row);
  }
}

function selectDim(key){
  state.selectedDimKey = key;
  $("dimEditor").classList.remove("hidden");
  $("dimHint").textContent = `æ­£åœ¨ç·¨è¼¯ï¼š${key}`;
  const dim = state.rules.dimensions[key];
  $("dimKey").value = key;
  $("dimTitle").value = dim.title || "";
  $("dimQuestions").value = JSON.stringify(dim.questions || {}, null, 2);
  renderDimList();
}

function renderThresholds(){
  ensureRules();
  const th = state.rules.thresholds || {};
  const def = th._default || { goodMin:0, okMin:-2 };
  $("thDefaultGood").value = Number(def.goodMin ?? 0);
  $("thDefaultOk").value = Number(def.okMin ?? -2);

  const list = $("thList");
  list.innerHTML = "";
  const dims = Object.keys(state.rules.dimensions || {});
  if(dims.length === 0){
    list.innerHTML = `<div class="text-sm text-slate-500">å…ˆå»ºç«‹ç¶­åº¦ï¼Œæ‰èƒ½ç”Ÿæˆå„ç¶­åº¦é–€æª»ã€‚</div>`;
    return;
  }

  for(const dk of dims){
    const cur = th[dk] || {};
    const good = Number(cur.goodMin ?? def.goodMin ?? 0);
    const ok = Number(cur.okMin ?? def.okMin ?? -2);

    const row = document.createElement("div");
    row.className = "p-3 rounded-2xl border bg-slate-50";
    row.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-black">${escapeHtml(state.rules.dimensions[dk]?.title || dk)} <span class="chip ml-2">${dk}</span></div>
        <button class="btn btn-ghost py-1.5 px-2 text-xs" data-reset="${dk}">é‡ç½®</button>
      </div>
      <div class="mt-2 grid grid-cols-2 gap-2">
        <label>
          <div class="text-xs font-bold text-slate-500 mb-1">goodMin</div>
          <input class="field mono" type="number" data-good="${dk}" value="${good}">
        </label>
        <label>
          <div class="text-xs font-bold text-slate-500 mb-1">okMin</div>
          <input class="field mono" type="number" data-ok="${dk}" value="${ok}">
        </label>
      </div>
    `;
    list.appendChild(row);
  }

  list.querySelectorAll("input[data-good]").forEach(inp=>{
    inp.oninput = ()=>{
      const dk = inp.getAttribute("data-good");
      state.rules.thresholds[dk] ||= {};
      state.rules.thresholds[dk].goodMin = Number(inp.value);
    };
  });
  list.querySelectorAll("input[data-ok]").forEach(inp=>{
    inp.oninput = ()=>{
      const dk = inp.getAttribute("data-ok");
      state.rules.thresholds[dk] ||= {};
      state.rules.thresholds[dk].okMin = Number(inp.value);
    };
  });
  list.querySelectorAll("button[data-reset]").forEach(btn=>{
    btn.onclick = ()=>{
      const dk = btn.getAttribute("data-reset");
      delete state.rules.thresholds[dk];
      renderThresholds();
      toast(`å·²é‡ç½® ${dk} é–€æª»ï¼ˆæ”¹ç”¨ _defaultï¼‰`, "ok");
    };
  });
}

function renderTipKeys(){
  ensureRules();
  const box = $("tipKeyList");
  box.innerHTML = "";
  const keys = Object.keys(state.rules.tips || {}).sort();
  if(keys.length === 0){
    box.innerHTML = `<div class="text-sm text-slate-500">å°šæœªå»ºç«‹ tipsï¼ŒæŒ‰ã€Œæ–°å¢ keyã€é–‹å§‹ã€‚</div>`;
    return;
  }
  keys.forEach(k=>{
    const active = state.selectedTipKey === k;
    const btn = document.createElement("button");
    btn.className = "w-full text-left p-3 rounded-2xl border bg-white hover:bg-slate-50 transition";
    if(active) btn.classList.add("ring-2","ring-blue-200","border-blue-300");
    const count = Array.isArray(state.rules.tips[k]) ? state.rules.tips[k].length : 0;
    btn.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-black">${escapeHtml(k)}</div>
        <span class="chip">æ¢ç›® ${count}</span>
      </div>
    `;
    btn.onclick = ()=> selectTipKey(k);
    box.appendChild(btn);
  });
}

function selectTipKey(k){
  state.selectedTipKey = k;
  $("tipHint").textContent = `æ­£åœ¨ç·¨è¼¯ï¼š${k}`;
  $("tipEditor").value = JSON.stringify(state.rules.tips[k] || [], null, 2);
  renderTipKeys();
}

function applyReportFormFromRules(){
  ensureRules();
  $("topPriorityCount").value = Number(state.rules.report?.topPriorityCount ?? 3);
  $("summaryDefault").value = state.rules.report?.summaryDefault || "";
  $("summaryAllGood").value = state.rules.report?.summaryAllGood || "";
}

function applyRulesFromReportForm(){
  ensureRules();
  state.rules.report.topPriorityCount = Number($("topPriorityCount").value || 3);
  state.rules.report.summaryDefault = $("summaryDefault").value || "";
  state.rules.report.summaryAllGood = $("summaryAllGood").value || "";
}

/* ---------- Buttons: Dimensions ---------- */
$("btnAddDim").onclick = ()=>{
  ensureRules();
  const base = "new_dim";
  let i = 1;
  let key = base + "_" + i;
  while(state.rules.dimensions[key]){ i++; key = base + "_" + i; }
  state.rules.dimensions[key] = { title: "æ–°ç¶­åº¦", questions: {} };
  toast("å·²æ–°å¢ç¶­åº¦ï¼ˆè«‹ç·¨è¼¯ key / title / questionsï¼‰", "ok");
  renderDimList();
  selectDim(key);
};

$("btnAddQ").onclick = ()=>{
  if(!state.selectedDimKey) return toast("è«‹å…ˆé¸ä¸€å€‹ç¶­åº¦", "warn");
  const dim = state.rules.dimensions[state.selectedDimKey];
  dim.questions ||= {};
  const qid = prompt("è¼¸å…¥é¡Œç›® IDï¼ˆä¾‹å¦‚ q_sleep_qualityï¼‰");
  if(!qid) return;
  if(dim.questions[qid]) return toast("é€™å€‹ qid å·²å­˜åœ¨", "warn");
  dim.questions[qid] = { "0": 0, "1": -1, "2": -2, "3": -3 };
  $("dimQuestions").value = JSON.stringify(dim.questions, null, 2);
  toast("å·²æ–°å¢é¡Œç›®æ˜ å°„ï¼ˆé è¨­ 0/-1/-2/-3ï¼Œå¯è‡ªè¡Œèª¿ï¼‰", "ok");
  renderDimList();
};

$("btnApplyDim").onclick = ()=>{
  try{
    ensureRules();
    const oldKey = state.selectedDimKey;
    const newKey = ($("dimKey").value||"").trim();
    const title = ($("dimTitle").value||"").trim();
    if(!newKey) return toast("ç¶­åº¦ key ä¸èƒ½ç©º", "warn");
    if(!/^[a-z0-9_]+$/i.test(newKey)) return toast("ç¶­åº¦ key å»ºè­°åªç”¨è‹±æ–‡/æ•¸å­—/åº•ç·š", "warn");
    if(!title) return toast("ç¶­åº¦æ¨™é¡Œä¸èƒ½ç©º", "warn");

    let questions;
    try{ questions = JSON.parse($("dimQuestions").value || "{}"); }catch{ return toast("questions JSON æ ¼å¼éŒ¯èª¤", "bad"); }
    if(!questions || typeof questions !== "object") return toast("questions å¿…é ˆæ˜¯ object", "bad");

    // rename key if needed
    if(oldKey !== newKey){
      if(state.rules.dimensions[newKey]) return toast("æ–° key å·²å­˜åœ¨ï¼Œè«‹æ›ä¸€å€‹", "warn");
      state.rules.dimensions[newKey] = state.rules.dimensions[oldKey];
      delete state.rules.dimensions[oldKey];
      state.selectedDimKey = newKey;
    }

    state.rules.dimensions[state.selectedDimKey].title = title;
    state.rules.dimensions[state.selectedDimKey].questions = questions;

    toast("å·²å¥—ç”¨ç¶­åº¦è¨­å®š", "ok");
    renderDimList();
    // update thresholds list if on that tab later
  }catch(e){
    toast(e.message || "å¥—ç”¨å¤±æ•—", "bad");
  }
};

$("btnDeleteDim").onclick = ()=>{
  if(!state.selectedDimKey) return;
  const k = state.selectedDimKey;
  if(!confirm(`ç¢ºå®šåˆªé™¤ç¶­åº¦ ${k}ï¼Ÿï¼ˆtips/nutrients/thresholds ä¸æœƒè‡ªå‹•åˆªï¼‰`)) return;
  delete state.rules.dimensions[k];
  delete state.rules.thresholds?.[k];
  state.selectedDimKey = null;
  $("dimEditor").classList.add("hidden");
  $("dimHint").textContent = "é¸ä¸€å€‹ç¶­åº¦é–‹å§‹";
  toast("å·²åˆªé™¤ç¶­åº¦", "ok");
  renderDimList();
};

/* ---------- Thresholds ---------- */
$("btnApplyDefaultTh").onclick = ()=>{
  ensureRules();
  state.rules.thresholds._default = {
    goodMin: Number($("thDefaultGood").value ?? 0),
    okMin: Number($("thDefaultOk").value ?? -2),
  };
  toast("å·²å¥—ç”¨é è¨­é–€æª» _default", "ok");
  renderThresholds();
};

$("btnRebuildThList").onclick = ()=>{
  renderThresholds();
  toast("å·²é‡æ–°ç”Ÿæˆé–€æª»åˆ—è¡¨", "ok");
};

/* ---------- Tips ---------- */
$("btnAddTipKey").onclick = ()=>{
  ensureRules();
  const suggested = suggestTipKey();
  const k = prompt("è¼¸å…¥ tips keyï¼ˆä¾‹å¦‚ sleep_lowï¼‰", suggested);
  if(!k) return;
  if(state.rules.tips[k]) return toast("æ­¤ key å·²å­˜åœ¨", "warn");
  state.rules.tips[k] = ["åœ¨é€™è£¡è¼¸å…¥ 2â€“5 æ¢çŸ­å¥å»ºè­°"];
  toast("å·²æ–°å¢ tips key", "ok");
  renderTipKeys();
  selectTipKey(k);
};

function suggestTipKey(){
  const dims = Object.keys(state.rules.dimensions||{});
  if(dims.length === 0) return "sleep_low";
  return `${dims[0]}_low`;
}

$("btnApplyTipOne").onclick = ()=>{
  if(!state.selectedTipKey) return toast("è«‹å…ˆé¸ä¸€å€‹ tips key", "warn");
  try{
    const arr = JSON.parse($("tipEditor").value || "[]");
    if(!Array.isArray(arr)) return toast("tips å¿…é ˆæ˜¯é™£åˆ—", "bad");
    state.rules.tips[state.selectedTipKey] = arr;
    toast("å·²å¥—ç”¨æ­¤ tips key", "ok");
    renderTipKeys();
  }catch{
    toast("tips JSON æ ¼å¼éŒ¯èª¤", "bad");
  }
};

$("btnDeleteTipKey").onclick = ()=>{
  if(!state.selectedTipKey) return;
  const k = state.selectedTipKey;
  if(!confirm(`ç¢ºå®šåˆªé™¤ tips keyï¼š${k}ï¼Ÿ`)) return;
  delete state.rules.tips[k];
  state.selectedTipKey = null;
  $("tipHint").textContent = "é¸ä¸€å€‹ key";
  $("tipEditor").value = "";
  toast("å·²åˆªé™¤ tips key", "ok");
  renderTipKeys();
};

$("btnApplyTips").onclick = ()=>{
  // In this UI, tips are applied per-key; this button just validates all
  try{
    ensureRules();
    // quick sanity
    for(const [k,v] of Object.entries(state.rules.tips)){
      if(!Array.isArray(v)) throw new Error(`tips.${k} ä¸æ˜¯é™£åˆ—`);
    }
    toast("tips å€å¡Šæª¢æŸ¥é€šé âœ…", "ok");
  }catch(e){
    toast(e.message, "bad");
  }
};

/* ---------- Nutrients / Products ---------- */
$("btnGenNutKeys").onclick = ()=>{
  ensureRules();
  const dims = Object.keys(state.rules.dimensions||{});
  if(dims.length === 0) return toast("è«‹å…ˆå»ºç«‹ç¶­åº¦", "warn");
  const obj = {};
  dims.forEach(d=>{
    obj[`${d}_low`] ||= [];
    obj[`${d}_ok`]  ||= [];
    obj[`${d}_good`] ||= [];
  });
  // merge existing
  state.rules.nutrients ||= {};
  for(const [k,v] of Object.entries(state.rules.nutrients)) obj[k] = v;
  $("nutrientsJson").value = JSON.stringify(obj, null, 2);
  toast("å·²ç”Ÿæˆå¸¸ç”¨ nutrients keysï¼ˆå¯è‡ªè¡Œåˆªæ”¹ï¼‰", "ok");
};

$("btnApplyNutrients").onclick = ()=>{
  try{
    ensureRules();
    const obj = JSON.parse($("nutrientsJson").value || "{}");
    if(!obj || typeof obj !== "object") return toast("nutrients å¿…é ˆæ˜¯ object", "bad");
    for(const [k,v] of Object.entries(obj)){
      if(!Array.isArray(v)) return toast(`nutrients.${k} å¿…é ˆæ˜¯é™£åˆ—`, "bad");
    }
    state.rules.nutrients = obj;
    toast("å·²å¥—ç”¨ nutrients", "ok");
  }catch{
    toast("nutrients JSON æ ¼å¼éŒ¯èª¤", "bad");
  }
};

$("btnApplyProducts").onclick = ()=>{
  try{
    ensureRules();
    const obj = JSON.parse($("productsJson").value || "{}");
    if(!obj || typeof obj !== "object") return toast("products å¿…é ˆæ˜¯ object", "bad");
    for(const [nut,p] of Object.entries(obj)){
      if(p && typeof p === "object" && p.url && !/^https?:\/\//i.test(String(p.url))){
        return toast(`products["${nut}"].url ä¸æ˜¯ http(s)`, "bad");
      }
    }
    state.rules.products = obj;
    toast("å·²å¥—ç”¨ products ç›®éŒ„", "ok");
  }catch{
    toast("products JSON æ ¼å¼éŒ¯èª¤", "bad");
  }
};

/* ---------- Report ---------- */
$("btnApplyReport").onclick = ()=>{
  applyRulesFromReportForm();
  toast("å·²å¥—ç”¨å ±å‘Šè¨­å®š", "ok");
};

/* ---------- JSON Advanced ---------- */
$("btnValidate").onclick = ()=>{
  try{
    const obj = JSON.parse($("rulesJson").value || "{}");
    const errs = validateRulesObj(obj);
    if(errs.length){
      $("validateResult").innerHTML = `<div class="p-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-700">
        <div class="font-black">æª¢æŸ¥å¤±æ•—</div>
        <ul class="list-disc pl-5 mt-2">${errs.map(e=>`<li>${escapeHtml(e)}</li>`).join("")}</ul>
      </div>`;
      toast("æª¢æŸ¥å¤±æ•—ï¼ˆçœ‹ä¸‹æ–¹åŸå› ï¼‰", "bad");
    }else{
      $("validateResult").innerHTML = `<div class="p-3 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-700">
        <div class="font-black">æª¢æŸ¥é€šé âœ…</div>
        <div class="text-sm mt-1">å¯ä»¥å„²å­˜æˆ–å¥—ç”¨åˆ°è¡¨å–®ã€‚</div>
      </div>`;
      toast("æª¢æŸ¥é€šé âœ…", "ok");
    }
  }catch(e){
    $("validateResult").innerHTML = `<div class="p-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-700">
      <div class="font-black">JSON è§£æå¤±æ•—</div>
      <div class="text-sm mt-1">${escapeHtml(e.message || "æ ¼å¼éŒ¯èª¤")}</div>
    </div>`;
    toast("JSON è§£æå¤±æ•—", "bad");
  }
};

$("btnApplyJson").onclick = ()=>{
  try{
    loadTextToRules($("rulesJson").value || "{}");
    // refresh all forms
    hydrateFormsFromRules();
    toast("å·²å¥—ç”¨å®Œæ•´ JSON åˆ°è¡¨å–®", "ok");
  }catch(e){
    toast(e.message || "å¥—ç”¨å¤±æ•—", "bad");
  }
};

$("btnExport").onclick = ()=>{
  try{
    ensureRules();
    const blob = new Blob([rulesToText()], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const sk = surveyKey() || "rules";
    a.download = `${sk}_rules_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    toast("å·²åŒ¯å‡º JSON æª”", "ok");
  }catch(e){
    toast(e.message || "åŒ¯å‡ºå¤±æ•—", "bad");
  }
};

$("importFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    $("rulesJson").value = txt;
    showTab("json");
    toast("å·²è¼‰å…¥åŒ¯å…¥æª”æ¡ˆï¼ˆè«‹å…ˆæŒ‰æª¢æŸ¥ï¼Œå†å¥—ç”¨/å„²å­˜ï¼‰", "ok");
  }catch{
    toast("è®€å–æª”æ¡ˆå¤±æ•—", "bad");
  }finally{
    e.target.value = "";
  }
});

/* ---------- Top actions ---------- */
$("btnGuide").onclick = ()=> $("guideModal").classList.remove("hidden"), $("guideModal").classList.add("flex");
$("btnCloseGuide").onclick = ()=> $("guideModal").classList.add("hidden"), $("guideModal").classList.remove("flex");
$("guideModal").addEventListener("click", (e)=>{ if(e.target === $("guideModal")) $("btnCloseGuide").click(); });

$("btnHealth").onclick = async ()=>{
  try{
    setStatus("æª¢æŸ¥ä¸­â€¦", "warn");
    await getHealth();
    setStatus("é€£ç·šæ­£å¸¸", "ok");
    toast("Worker é€£ç·šæ­£å¸¸ âœ…", "ok");
    // persist config
    persistConfig();
  }catch(e){
    setStatus("é€£ç·šå¤±æ•—", "bad");
    toast(e.message || "é€£ç·šå¤±æ•—", "bad");
  }
};

$("btnLoad").onclick = async ()=>{
  try{
    setStatus("è®€å–ä¸­â€¦", "warn");
    const sk = surveyKey();
    if(!sk) return toast("è«‹å¡«å•åˆ¸ Key", "warn");
    const out = await postJSON("/survey/rules/get", { surveyKey: sk });
    if(!out.rules){
      state.rules = null;
      ensureRules();
      setMeta(sk, "KV å°šç„¡è¦å‰‡");
      hydrateFormsFromRules();
      $("rulesJson").value = rulesToText();
      state.lastLoadedText = "";
      setStatus("å¯å»ºç«‹æ–°è¦å‰‡", "warn");
      toast("KV å°šç„¡ rulesï¼šä½ å¯ä»¥æŒ‰ã€Œæ–°è¦å‰‡ã€æˆ–ç›´æ¥é–‹å§‹ç·¨è¼¯å¾Œå„²å­˜", "warn");
    }else{
      state.rules = out.rules;
      ensureRules();
      // optional meta in rules
      const v = state.rules.__meta?.version || sk;
      const u = state.rules.__meta?.updatedAt || "ï¼ˆæœªæä¾›ï¼‰";
      setMeta(v, u);
      hydrateFormsFromRules();
      $("rulesJson").value = rulesToText();
      state.lastLoadedText = rulesToText();
      setStatus("å·²è®€å–", "ok");
      toast("è®€å–æˆåŠŸ âœ…", "ok");
    }
    persistConfig();
  }catch(e){
    setStatus("è®€å–å¤±æ•—", "bad");
    toast("è®€å–å¤±æ•—ï¼š" + (e.message || ""), "bad");
  }
};

$("btnSave").onclick = async ()=>{
  try{
    ensureRules();
    // apply forms into rules before save
    applyRulesFromReportForm();
    // nutrients/products apply if textareas have content
    if($("nutrientsJson").value.trim()){
      try{ state.rules.nutrients = JSON.parse($("nutrientsJson").value || "{}"); }catch{ throw new Error("ç‡Ÿé¤Šç´  JSON æ ¼å¼éŒ¯èª¤"); }
    }
    if($("productsJson").value.trim()){
      try{ state.rules.products = JSON.parse($("productsJson").value || "{}"); }catch{ throw new Error("ç”¢å“ç›®éŒ„ JSON æ ¼å¼éŒ¯èª¤"); }
    }

    // attach meta
    state.rules.__meta ||= {};
    state.rules.__meta.version = surveyKey();
    state.rules.__meta.updatedAt = new Date().toISOString();

    const errs = validateRulesObj(state.rules);
    if(errs.length){
      showTab("json");
      $("rulesJson").value = rulesToText();
      $("validateResult").innerHTML = `<div class="p-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-700">
        <div class="font-black">å„²å­˜å‰æª¢æŸ¥å¤±æ•—</div>
        <ul class="list-disc pl-5 mt-2">${errs.map(e=>`<li>${escapeHtml(e)}</li>`).join("")}</ul>
      </div>`;
      return toast("å„²å­˜è¢«é˜»æ­¢ï¼šè¦å‰‡æœ‰éŒ¯ï¼ˆçœ‹åŸå› ï¼‰", "bad");
    }

    setStatus("å„²å­˜ä¸­â€¦", "warn");
    await postJSON("/survey/rules/set", { surveyKey: surveyKey(), rules: state.rules });
    setMeta(state.rules.__meta.version, state.rules.__meta.updatedAt);
    setStatus("å·²å„²å­˜", "ok");
    state.lastLoadedText = rulesToText();
    toast("å„²å­˜æˆåŠŸ âœ…ï¼ˆKV ç«‹å³ç”Ÿæ•ˆï¼‰", "ok");
    persistConfig();
  }catch(e){
    setStatus("å„²å­˜å¤±æ•—", "bad");
    toast("å„²å­˜å¤±æ•—ï¼š" + (e.message || ""), "bad");
  }
};

$("btnNew").onclick = ()=>{
  state.rules = null;
  ensureRules();
  // meta defaults
  state.rules.__meta = { version: surveyKey() || "health_v1", updatedAt: new Date().toISOString() };
  hydrateFormsFromRules();
  toast("å·²å»ºç«‹æ–°è¦å‰‡ï¼ˆå°šæœªå¯«å…¥ KVï¼Œè¨˜å¾—æŒ‰å„²å­˜ï¼‰", "ok");
};

$("btnClone").onclick = ()=>{
  ensureRules();
  const from = surveyKey() || "health_v1";
  const to = prompt("è¼¸å…¥æ–°ç‰ˆæœ¬ surveyKeyï¼ˆä¾‹å¦‚ health_v2ï¼‰", from.replace(/_v(\d+)$/i, (_,n)=> `_v${Number(n)+1}`));
  if(!to) return;
  $("surveyKey").value = to;
  // update meta
  state.rules.__meta ||= {};
  state.rules.__meta.version = to;
  state.rules.__meta.updatedAt = new Date().toISOString();
  hydrateFormsFromRules();
  toast("å·²è¤‡è£½åˆ°æ–°ç‰ˆæœ¬ï¼ˆç¾åœ¨æŒ‰å„²å­˜æœƒå¯«åˆ°æ–°çš„ surveyKeyï¼‰", "ok");
  persistConfig();
};

/* ---------- Test ---------- */
$("btnGenTemplateAns").onclick = ()=>{
  ensureRules();
  // generate answers template from all qids found in dimensions
  const ans = {};
  for(const dim of Object.values(state.rules.dimensions)){
    for(const qid of Object.keys(dim.questions || {})){
      // pick a mid option if exists, else 0
      const optMap = dim.questions[qid] || {};
      const opts = Object.keys(optMap);
      ans[qid] = opts.includes("2") ? 2 : (opts.includes("1") ? 1 : (opts[0] ?? 0));
    }
  }
  $("testAnswers").value = JSON.stringify(ans, null, 2);
  toast("å·²ç”Ÿæˆæ¸¬è©¦ç­”æ¡ˆç¯„æœ¬", "ok");
};

$("btnRunTest").onclick = async ()=>{
  try{
    const sk = surveyKey();
    if(!sk) return toast("è«‹å¡«å•åˆ¸ Key", "warn");
    let answers;
    try{ answers = JSON.parse($("testAnswers").value || "{}"); }catch{ return toast("æ¸¬è©¦ç­”æ¡ˆ JSON æ ¼å¼éŒ¯èª¤", "bad"); }
    setStatus("æ¸¬è©¦ä¸­â€¦", "warn");
    const out = await postJSON("/survey/submit", { surveyKey: sk, answers });
    const rep = out.report;
    const text = formatReportPreview(rep);
    $("testResult").textContent = text;
    setStatus("æ¸¬è©¦å®Œæˆ", "ok");
    toast("æ¸¬è©¦å®Œæˆ âœ…", "ok");
  }catch(e){
    setStatus("æ¸¬è©¦å¤±æ•—", "bad");
    $("testResult").textContent = "æ¸¬è©¦å¤±æ•—ï¼š\n" + (e.message || "");
    toast("æ¸¬è©¦å¤±æ•—ï¼š" + (e.message || ""), "bad");
  }
};

function formatReportPreview(rep){
  if(!rep) return "ç„¡ report å›å‚³";
  const lines = [];
  lines.push("ã€æ‘˜è¦ã€‘");
  lines.push(rep.summary || "â€”");
  lines.push("");
  lines.push("ã€å„ªå…ˆæ–¹å‘ã€‘");
  (rep.priorities || []).forEach((p,i)=>{
    lines.push(`${i+1}. ${p.title}ï¼ˆlevel: ${p.level}, score: ${p.score}ï¼‰`);
    if(Array.isArray(p.tips) && p.tips.length){
      lines.push("  - ä»Šæ—¥å¯åšï¼š");
      p.tips.slice(0,6).forEach(t=> lines.push("    â€¢ " + t));
    }
    if(Array.isArray(p.nutrients) && p.nutrients.length){
      lines.push("  - å»ºè­°ç‡Ÿé¤Šç´ ï¼š" + p.nutrients.join("ã€"));
    }
    if(Array.isArray(p.products) && p.products.length){
      lines.push("  - ç”¢å“é€£çµï¼š");
      p.products.slice(0,6).forEach(x=> lines.push(`    â€¢ ${x.name} (${x.nutrient}) â†’ ${x.url}`));
    }
    lines.push("");
  });
  return lines.join("\n");
}

/* ---------- Hydration between forms and rules ---------- */
function hydrateFormsFromRules(){
  ensureRules();
  // Dim list
  renderDimList();
  // Thresholds
  renderThresholds();
  // Tips
  renderTipKeys();
  // Nutrients + products textareas
  $("nutrientsJson").value = JSON.stringify(state.rules.nutrients || {}, null, 2);
  $("productsJson").value = JSON.stringify(state.rules.products || {}, null, 2);
  // Report
  applyReportFormFromRules();
  // Full JSON
  $("rulesJson").value = rulesToText();
  // reset editors if selection missing
  if(state.selectedDimKey && !state.rules.dimensions[state.selectedDimKey]) state.selectedDimKey = null;
  if(state.selectedTipKey && !state.rules.tips[state.selectedTipKey]) state.selectedTipKey = null;
}

/* ---------- Persist config ---------- */
function persistConfig(){
  const base = apiBase();
  const sk = surveyKey();
  localStorage.setItem("kv_admin_apiBase", base);
  localStorage.setItem("kv_admin_surveyKey", sk);
  // adminKey deliberately NOT auto-saved unless you want:
  // localStorage.setItem("kv_admin_adminKey", adminKey());
}

function restoreConfig(){
  const base = localStorage.getItem("kv_admin_apiBase");
  const sk = localStorage.getItem("kv_admin_surveyKey");
  if(base) $("apiBase").value = base;
  if(sk) $("surveyKey").value = sk;
  // If you DO want auto-fill admin key, uncomment:
  // const k = localStorage.getItem("kv_admin_adminKey"); if(k) $("adminKey").value = k;
}

/* ---------- Init ---------- */
window.addEventListener("load", ()=>{
  restoreConfig();
  // start with dimensions tab
  showTab("dimensions");
  setStatus("å°šæœªé€£ç·š", "neutral");
  setMeta("â€”","â€”");
  // create empty rules (so UI works even before load)
  ensureRules();
  hydrateFormsFromRules();
});
</script>
</body>
</html>
