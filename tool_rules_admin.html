<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloudflare è¶…ç´šæ§åˆ¶å°ï½œçµ±ä¸€çª—å£</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bd:rgba(15,23,42,.10); --glass:rgba(255,255,255,.82); --glass2:rgba(255,255,255,.70); }
    body{
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(950px 520px at 90% 12%, rgba(16,185,129,.16), transparent 55%),
        radial-gradient(1000px 650px at 50% 110%, rgba(245,158,11,.14), transparent 60%),
        #f8fafc;
      font-family: ui-sans-serif, system-ui, "Microsoft JhengHei";
    }
    .glass{ background:var(--glass); border:1px solid var(--bd); backdrop-filter: blur(12px); box-shadow: 0 18px 55px rgba(15,23,42,.10);}
    .glass2{ background:var(--glass2); border:1px solid var(--bd); backdrop-filter: blur(10px); box-shadow: 0 10px 26px rgba(15,23,42,.06);}
    .btn{ border:1px solid var(--bd); background:#fff; }
    .btn:hover{ background:#f1f5f9; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.75);
      padding:.12rem .45rem;
      border-radius: .7rem;
      font-size: .82em;
    }
    .inp{
      border:1px solid var(--bd);
      background: rgba(255,255,255,.85);
      border-radius: 1rem;
      padding: .75rem 1rem;
      width: 100%;
      outline: none;
    }
    .inp:focus{ box-shadow: 0 0 0 4px rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); }
  </style>
</head>

<body class="min-h-screen">
  <div class="mx-auto max-w-6xl px-4 pt-5 pb-24">
    <!-- Header -->
    <div class="glass rounded-3xl px-5 py-4 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-extrabold text-slate-900 truncate">Cloudflare è¶…ç´šæ§åˆ¶å°ï½œçµ±ä¸€çª—å£</div>
        <div class="text-sm text-slate-600 truncate">
          é€™é æ˜¯ã€Œå° Worker ç™¼æŒ‡ä»¤ã€ä¸æ˜¯è·³è½‰é ï¼ˆKV / Survey / ç®¡ç† APIï¼‰
        </div>
      </div>
      <div class="flex gap-2">
        <button class="btn text-sm px-4 py-2 rounded-2xl" onclick="UI.ping()">æ¸¬è©¦é€£ç·š</button>
        <button class="btn text-sm px-4 py-2 rounded-2xl" onclick="UI.toggleHelp()">æ•™å­¸</button>
      </div>
    </div>

    <!-- Help -->
    <div id="help" class="hidden mt-4 glass2 rounded-3xl p-5 text-sm text-slate-700">
      <div class="font-bold text-slate-900">ç‚ºä»€éº¼ä½ æœƒã€ŒKV è®€å–å¤±æ•—ã€ï¼Ÿ</div>
      <div class="mt-2 text-slate-600 leading-relaxed">
        1) ä½  Worker è‹¥æœ‰è¨­å®š <span class="kbd">ADMIN_KEY</span>ï¼Œé‚£ KV API æœƒè¦æ±‚ header <span class="kbd">X-Admin-Key</span>ï¼Œæ²’å¸¶å°±æœƒ <span class="kbd">401</span>ã€‚<br/>
        2) è‹¥ä½  Worker æ²’æœ‰å‡ç´šåˆ°ã€Œè¶…ç´šå¾Œç«¯ã€ç‰ˆæœ¬ï¼Œæ‰“ <span class="kbd">/api/kv/get</span> æœƒ <span class="kbd">404</span>ã€‚<br/>
        3) è‹¥ Bindings æ²’æœ‰è¨­ <span class="kbd">DB -&gt; BOT_DATA</span>ï¼Œæœƒ <span class="kbd">500 Missing KV binding</span>ã€‚<br/>
        <div class="mt-3">
          âœ… æ­£å¸¸æ™‚ï¼š<span class="kbd">/health</span> å› okã€<span class="kbd">/api/ping</span> å› okã€KV GET å› okã€‚
        </div>
      </div>
    </div>

    <!-- Gateway + Admin -->
    <div class="mt-4 grid lg:grid-cols-2 gap-4">
      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-bold text-slate-900">Gatewayï¼ˆWorker ç¶²åŸŸï¼‰</div>
        <div class="mt-1 text-sm text-slate-600">ä¾‹å¦‚ï¼š<span class="kbd">https://api.zxcv8096.workers.dev</span></div>
        <input id="gw" class="inp mt-3" placeholder="è²¼ä¸Šä½ çš„ Worker ç¶²åŸŸâ€¦" />
        <div class="mt-2 text-xs text-slate-500">æœƒå­˜åˆ° <span class="kbd">localStorage.GW_BASE</span></div>
        <div class="mt-3 flex gap-2">
          <button class="btn px-4 py-3 rounded-2xl text-sm font-semibold" onclick="UI.saveGW()">å„²å­˜</button>
          <button class="btn px-4 py-3 rounded-2xl text-sm" onclick="UI.resetGW()">é‡ç½®</button>
        </div>
      </div>

      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-bold text-slate-900">ADMIN_KEYï¼ˆç®¡ç†å¯†é‘°ï¼‰</div>
        <div class="mt-1 text-sm text-slate-600">æœ‰è¨­ ADMIN_KEY æ‰èƒ½æ“ä½œ KV / rules setï¼ˆheader: <span class="kbd">X-Admin-Key</span>ï¼‰</div>
        <input id="ak" class="inp mt-3" type="password" placeholder="è¼¸å…¥ä¸€æ¬¡å¾Œæœƒè¨˜ä½ï¼ˆå¯ç•™ç©ºï¼‰" />
        <div class="mt-2 text-xs text-slate-500">æœƒå­˜åˆ° <span class="kbd">localStorage.ADMIN_KEY</span></div>
        <div class="mt-3 flex gap-2">
          <button class="btn px-4 py-3 rounded-2xl text-sm font-semibold" onclick="UI.saveAK()">å„²å­˜</button>
          <button class="btn px-4 py-3 rounded-2xl text-sm" onclick="UI.clearAK()">æ¸…é™¤</button>
        </div>
      </div>
    </div>

    <!-- Command Panel -->
    <div class="mt-5 grid lg:grid-cols-2 gap-4">
      <!-- KV: get/set -->
      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-bold text-slate-900">KV æŒ‡ä»¤ï¼ˆBOT_DATA via env.DBï¼‰</div>
        <div class="mt-1 text-sm text-slate-600">è®€å¯«ä½ çš„ KVï¼ˆä¾‹å¦‚ RULES_JSONã€CONFIGã€TOKENâ€¦ï¼‰</div>

        <div class="mt-4 grid gap-3">
          <div>
            <div class="text-sm font-semibold text-slate-900">Key</div>
            <input id="kvKey" class="inp mt-2" placeholder="ä¾‹å¦‚ï¼šSURVEY:health_v1:RULES" />
          </div>

          <div>
            <div class="text-sm font-semibold text-slate-900">Valueï¼ˆJSON / æ–‡å­—ï¼‰</div>
            <textarea id="kvVal" rows="7" class="inp mt-2 font-mono text-xs"
              placeholder='ä¾‹å¦‚ï¼š{"version":1,"rules":[...]} æˆ–ä»»ä½•æ–‡å­—'></textarea>
          </div>

          <div class="flex flex-wrap gap-2">
            <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.kvGet()">è®€å–</button>
            <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.kvPut()">å¯«å…¥</button>
            <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.kvDel()">åˆªé™¤</button>
          </div>
        </div>
      </div>

      <!-- KV: list -->
      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-bold text-slate-900">KV Keysï¼ˆæŸ¥è©¢ï¼‰</div>
        <div class="mt-1 text-sm text-slate-600">åˆ—å‡º KV è£¡æœ‰å“ªäº› keyï¼ˆå¯ç”¨ prefix ç¯©é¸ï¼‰</div>

        <div class="mt-4 grid gap-3">
          <div>
            <div class="text-sm font-semibold text-slate-900">Prefixï¼ˆå¯ç©ºï¼‰</div>
            <input id="kvPrefix" class="inp mt-2" placeholder="ä¾‹å¦‚ï¼šSURVEY: æˆ– ç•™ç©ºåˆ—å‡ºå…¨éƒ¨" />
          </div>

          <div class="grid grid-cols-12 gap-2">
            <div class="col-span-6">
              <div class="text-sm font-semibold text-slate-900">Limit</div>
              <input id="kvLimit" class="inp mt-2" value="100" />
            </div>
            <div class="col-span-6">
              <div class="text-sm font-semibold text-slate-900">Cursorï¼ˆç¿»é ç”¨ï¼Œå¯ç©ºï¼‰</div>
              <input id="kvCursor" class="inp mt-2" placeholder="ä¸Šä¸€æ¬¡ list å›å‚³çš„ cursor" />
            </div>
          </div>

          <div class="flex gap-2">
            <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.kvList()">åˆ—å‡º Keys</button>
            <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.clearLog()">æ¸…ç©º Log</button>
          </div>

          <div class="text-xs text-slate-500 leading-relaxed">
            éœ€è¦ Worker æœ‰ï¼š<span class="kbd">POST /api/kv/list</span>ã€<span class="kbd">/api/kv/get</span>ã€<span class="kbd">/api/kv/put</span>ã€<span class="kbd">/api/kv/del</span><br/>
            âœ… ä½ å·²å‡ç´šåˆ°ã€Œè¶…ç´šå¾Œç«¯ã€å°±æœƒæœ‰ã€‚
          </div>
        </div>
      </div>
    </div>

    <!-- Log -->
    <div class="mt-5 glass rounded-3xl p-5">
      <div class="flex items-center justify-between gap-3">
        <div class="text-base font-bold text-slate-900">åŸ·è¡Œ Logï¼ˆä¸€å®šæœƒé¡¯ç¤º HTTP ç‹€æ…‹èˆ‡å›æ‡‰ï¼‰</div>
        <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.copyLog()">è¤‡è£½ Log</button>
      </div>
      <pre id="log" class="mt-4 text-xs bg-white/70 border rounded-2xl p-4 overflow-auto max-h-[420px]"
        style="border-color:var(--bd)"></pre>
    </div>
  </div>

<script>
const UI = (() => {
  const K_GW = "GW_BASE";
  const K_AK = "ADMIN_KEY";
  const DEFAULT_GW = "https://api.zxcv8096.workers.dev";

  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");

  function normalizeGW(v){
    const s = String(v||"").trim();
    if(!s) return "";
    if(!/^https?:\/\//i.test(s)) return ("https://" + s.replace(/^\/+/,"")).replace(/\/+$/,"");
    return s.replace(/\/+$/,"");
  }

  function now(){
    return new Date().toLocaleTimeString();
  }
  function log(line){
    logEl.textContent = `[${now()}] ${line}\n` + logEl.textContent;
  }
  function toggleHelp(){ $("help").classList.toggle("hidden"); }
  function clearLog(){ logEl.textContent = ""; }

  // init
  let GW = normalizeGW(localStorage.getItem(K_GW)) || DEFAULT_GW;
  localStorage.setItem(K_GW, GW);
  $("gw").value = GW;

  let AK = String(localStorage.getItem(K_AK) || "");
  $("ak").value = AK;

  function saveGW(){
    const v = normalizeGW($("gw").value);
    if(!v) return alert("Gateway ä¸èƒ½ç©ºç™½");
    GW = v;
    localStorage.setItem(K_GW, GW);
    log(`âœ… å·²å„²å­˜ Gateway = ${GW}`);
  }
  function resetGW(){
    GW = DEFAULT_GW;
    $("gw").value = GW;
    localStorage.setItem(K_GW, GW);
    log(`ğŸ” å·²é‡ç½® Gateway = ${GW}`);
  }
  function saveAK(){
    AK = String($("ak").value || "").trim();
    localStorage.setItem(K_AK, AK);
    log(AK ? "âœ… å·²å„²å­˜ ADMIN_KEYï¼ˆå·²å•Ÿç”¨ç®¡ç†å‘¼å«ï¼‰" : "âœ… ADMIN_KEY ç‚ºç©ºï¼ˆè‹¥ Worker æœ‰è¨­ ADMIN_KEYï¼Œå‘¼å«æœƒ 401ï¼‰");
  }
  function clearAK(){
    AK = "";
    $("ak").value = "";
    localStorage.setItem(K_AK, "");
    log("ğŸ§¹ å·²æ¸…é™¤ ADMIN_KEY");
  }

  async function call(path, body){
    const url = GW + path;
    log(`â¡ï¸ ${url}`);
    const headers = { "Content-Type":"application/json" };
    if (AK) headers["X-Admin-Key"] = AK;

    try{
      const res = await fetch(url, {
        method: "POST",
        headers,
        body: JSON.stringify(body || {})
      });

      const text = await res.text();
      log(`â¬…ï¸ HTTP ${res.status} ${res.ok ? "OK" : "ERR"}`);

      // parse JSON if possible
      try{
        const j = JSON.parse(text);
        log(`ğŸ“¦ ${JSON.stringify(j, null, 2)}`);
        return j;
      }catch{
        log(`ğŸ“¦ ${text}`);
        return text;
      }
    }catch(e){
      log(`âŒ Fetch å¤±æ•—ï¼š${e?.message || e}`);
      log(`âš ï¸ å¸¸è¦‹åŸå› ï¼š1) Worker æ²’é–‹ CORS 2) ç¶²å€éŒ¯ 3) è¢«ç€è¦½å™¨æ“‹`);
      return null;
    }
  }

  async function ping(){
    // use GET /health (no admin)
    const url = GW.replace(/\/+$/,"") + "/health";
    log(`â¡ï¸ ${url} (GET)`);
    try{
      const res = await fetch(url, { method:"GET" });
      const text = await res.text();
      log(`â¬…ï¸ HTTP ${res.status} ${res.ok ? "OK" : "ERR"}`);
      try{ log(`ğŸ“¦ ${JSON.stringify(JSON.parse(text), null, 2)}`); }
      catch{ log(`ğŸ“¦ ${text}`); }
    }catch(e){
      log(`âŒ Ping å¤±æ•—ï¼š${e?.message || e}`);
    }
  }

  // KV actions
  async function kvGet(){
    const key = $("kvKey").value.trim();
    if(!key) return alert("Key ä¸èƒ½ç©ºç™½");
    await call("/api/kv/get", { key });
  }
  async function kvPut(){
    const key = $("kvKey").value.trim();
    if(!key) return alert("Key ä¸èƒ½ç©ºç™½");
    const raw = $("kvVal").value;
    let value = raw;
    try{ value = JSON.parse(raw); }catch{}
    await call("/api/kv/put", { key, value });
  }
  async function kvDel(){
    const key = $("kvKey").value.trim();
    if(!key) return alert("Key ä¸èƒ½ç©ºç™½");
    await call("/api/kv/del", { key });
  }
  async function kvList(){
    const prefix = $("kvPrefix").value.trim();
    const cursor = $("kvCursor").value.trim();
    const limit = Number(($("kvLimit").value || "100").trim());
    await call("/api/kv/list", {
      prefix,
      cursor: cursor || undefined,
      limit: Number.isFinite(limit) ? limit : 100
    });
  }

  async function copyLog(){
    const t = logEl.textContent || "";
    try{ await navigator.clipboard.writeText(t); alert("å·²è¤‡è£½"); }
    catch{ prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", t); }
  }

  return { toggleHelp, clearLog, copyLog, saveGW, resetGW, saveAK, clearAK, ping, kvGet, kvPut, kvDel, kvList };
})();
</script>
</body>
</html>
