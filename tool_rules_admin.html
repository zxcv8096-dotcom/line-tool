<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å•å·è¦å‰‡ä¸­æ§å°ï½œA+Health</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bd: rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.82);
      --glass2: rgba(255,255,255,.70);
    }
    body{
      font-family: ui-sans-serif, system-ui, "Microsoft JhengHei";
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(950px 520px at 90% 12%, rgba(16,185,129,.16), transparent 55%),
        radial-gradient(1000px 650px at 50% 110%, rgba(245,158,11,.14), transparent 60%),
        #f8fafc;
    }
    .glass{ background:var(--glass); border:1px solid var(--bd); backdrop-filter: blur(12px); box-shadow: 0 18px 55px rgba(15,23,42,.10); }
    .glass2{ background:var(--glass2); border:1px solid var(--bd); backdrop-filter: blur(10px); box-shadow: 0 10px 26px rgba(15,23,42,.06); }
    .btn{ border:1px solid var(--bd); background:#fff; }
    .btn:hover{ background:#f1f5f9; }
    .inp{
      width:100%;
      border-radius:16px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.85);
      padding:12px 14px;
      outline:none;
    }
    .inp:focus{ box-shadow: 0 0 0 4px rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.75);
      padding:.12rem .45rem;
      border-radius: .7rem;
      font-size: .82em;
    }
    pre{ white-space: pre-wrap; word-break: break-word; }
  </style>
</head>

<body class="min-h-screen">
  <div class="mx-auto max-w-6xl px-4 pt-5 pb-24 space-y-4">
    <!-- Header -->
    <div class="glass rounded-3xl px-5 py-4 flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-extrabold text-slate-900 truncate">å•å·è¦å‰‡ä¸­æ§å°ï½œA+Health</div>
        <div class="text-sm text-slate-600 truncate">
          é€™é æ˜¯ã€Œè¦å‰‡/å ±å‘Šå¼•æ“ã€æ§åˆ¶å°ï¼ˆå°æ‡‰ Workerï¼š<span class="kbd">/health</span>ã€<span class="kbd">/survey/*</span>ï¼‰
        </div>
      </div>
      <button class="btn text-sm px-4 py-2 rounded-2xl" onclick="UI.toggleHelp()">æ•™å­¸</button>
    </div>

    <!-- Help -->
    <div id="help" class="hidden glass2 rounded-3xl p-5 text-sm text-slate-700">
      <div class="font-bold text-slate-900">é€™é æ€éº¼ç”¨ï¼Ÿ</div>
      <div class="mt-2 text-slate-600 leading-relaxed">
        1) å…ˆç¢ºèª Worker Baseï¼ˆé è¨­å·²å¡«å¥½ï¼‰ã€‚<br/>
        2) æŒ‰ã€Œæ¸¬è©¦é€£ç·šã€æœƒæ‰“ <span class="kbd">GET /health</span>ã€‚<br/>
        3) ã€Œè®€è¦å‰‡ã€æ‰“ <span class="kbd">POST /survey/rules/get</span>ï¼ŒæŠŠ KV è£¡çš„è¦å‰‡æ‹‰å›ä¾†ã€‚<br/>
        4) ã€Œå¯«è¦å‰‡ã€æ‰“ <span class="kbd">POST /survey/rules/set</span>ï¼ˆéœ€è¦ ADMIN_KEYï¼Œheaderï¼š<span class="kbd">X-Admin-Key</span>ï¼‰ã€‚<br/>
        5) ã€Œæ¸¬è©¦ç”¢å ±å‘Šã€æ‰“ <span class="kbd">POST /survey/submit</span>ã€‚<br/>
        <span class="font-bold">æ³¨æ„ï¼š</span>ä½ ä¹‹å‰é‚£ä»½å•å·ä¸­æ§å°æ‰“çš„æ˜¯ <span class="kbd">/api/q/*</span>ï¼Œä½†ä½  Worker æ ¹æœ¬æ²’æœ‰é‚£äº›è·¯ç”±ï¼Œæ‰€ä»¥æœƒ 404ã€‚
      </div>
    </div>

    <!-- Settings -->
    <div class="glass2 rounded-3xl p-5">
      <div class="grid md:grid-cols-12 gap-3">
        <div class="md:col-span-6">
          <div class="text-sm font-extrabold text-slate-900">Worker Base</div>
          <div class="text-xs text-slate-600 mt-1">ä¾‹å¦‚ï¼š<span class="kbd">https://api.zxcv8096.workers.dev</span></div>
          <input id="base" class="inp mt-2" placeholder="https://...workers.dev">
          <div class="text-xs text-slate-500 mt-2">æœƒå­˜åˆ° <span class="kbd">localStorage.QA_BASE</span></div>
        </div>

        <div class="md:col-span-3">
          <div class="text-sm font-extrabold text-slate-900">surveyKey</div>
          <div class="text-xs text-slate-600 mt-1">é è¨­ï¼š<span class="kbd">health_v1</span></div>
          <input id="surveyKey" class="inp mt-2" placeholder="health_v1">
          <div class="text-xs text-slate-500 mt-2">å°æ‡‰ KV keyï¼š<span class="kbd">SURVEY:{surveyKey}:RULES</span></div>
        </div>

        <div class="md:col-span-3">
          <div class="text-sm font-extrabold text-slate-900">ADMIN_KEYï¼ˆå¯«å…¥ç”¨ï¼‰</div>
          <div class="text-xs text-slate-600 mt-1">headerï¼š<span class="kbd">X-Admin-Key</span></div>
          <input id="adminKey" class="inp mt-2" type="password" placeholder="éœ€è¦å¯«è¦å‰‡æ‰å¡«">
          <div class="flex gap-2 mt-3">
            <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.save()">å„²å­˜</button>
            <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.reset()">é‡ç½®</button>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.ping()">æ¸¬è©¦é€£ç·š</button>
        <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.rulesGet()">è®€è¦å‰‡</button>
        <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.rulesSet()">å¯«è¦å‰‡</button>
        <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.clearLog()">æ¸…ç©º Log</button>
      </div>
    </div>

    <!-- Editors -->
    <div class="grid lg:grid-cols-2 gap-4">
      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-extrabold text-slate-900">è¦å‰‡ JSONï¼ˆrulesï¼‰</div>
        <div class="text-sm text-slate-600 mt-1">ã€Œè®€è¦å‰‡ã€æœƒå¡«å…¥ï¼›æ”¹å®ŒæŒ‰ã€Œå¯«è¦å‰‡ã€å­˜å› KVã€‚</div>
        <textarea id="rules" rows="16" class="inp mt-3 font-mono text-xs" placeholder='{"dimensions":{...},"tips":{...}}'></textarea>
        <div class="text-xs text-slate-500 mt-2">
          Worker è·¯ç”±ï¼š<span class="kbd">POST /survey/rules/get</span>ã€<span class="kbd">POST /survey/rules/set</span>
        </div>
      </div>

      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-extrabold text-slate-900">æ¸¬è©¦ç­”æ¡ˆï¼ˆanswersï¼‰</div>
        <div class="text-sm text-slate-600 mt-1">ç”¨ä¾†æ‰“ <span class="kbd">POST /survey/submit</span> ç”¢ç”Ÿ reportã€‚</div>
        <textarea id="answers" rows="10" class="inp mt-3 font-mono text-xs" placeholder='{"q1":"0","q2":"2"}'></textarea>
        <div class="flex flex-wrap gap-2 mt-3">
          <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.submit()">æ¸¬è©¦ç”¢å ±å‘Š</button>
          <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.fillDemo()">å¡«å…¥ç¯„ä¾‹</button>
        </div>
        <div class="text-xs text-slate-500 mt-2">å¦‚æœå›ï¼š<span class="kbd">No rules found</span>ï¼Œä»£è¡¨ KV æ²’å­˜è¦å‰‡ã€‚</div>
      </div>
    </div>

    <!-- Log -->
    <div class="glass rounded-3xl p-5">
      <div class="flex items-center justify-between gap-3">
        <div class="text-base font-extrabold text-slate-900">åŸ·è¡Œ Logï¼ˆä¸€å®šæœƒé¡¯ç¤ºçµæœï¼‰</div>
        <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.copyLog()">è¤‡è£½ Log</button>
      </div>
      <pre id="log" class="mt-4 text-xs bg-white/70 border rounded-2xl p-4 overflow-auto max-h-[420px]" style="border-color:var(--bd)"></pre>
    </div>
  </div>

<script>
const UI = (() => {
  const LS_BASE = "QA_BASE";
  const LS_KEY  = "QA_ADMIN_KEY";
  const LS_SK   = "QA_SURVEY_KEY";

  const DEFAULT_BASE = "https://api.zxcv8096.workers.dev";
  const DEFAULT_SK   = "health_v1";

  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");

  function normBase(v){
    const s = String(v||"").trim();
    if(!s) return "";
    if(!/^https?:\/\//i.test(s)) return ("https://" + s.replace(/^\/+/,"")).replace(/\/+$/,"");
    return s.replace(/\/+$/,"");
  }

  function log(line){
    const ts = new Date().toLocaleTimeString();
    logEl.textContent = `[${ts}] ${line}\n` + logEl.textContent;
  }

  function toggleHelp(){ $("help").classList.toggle("hidden"); }

  function load(){
    $("base").value = normBase(localStorage.getItem(LS_BASE)) || DEFAULT_BASE;
    $("adminKey").value = localStorage.getItem(LS_KEY) || "";
    $("surveyKey").value = localStorage.getItem(LS_SK) || DEFAULT_SK;
  }

  function save(){
    const b = normBase($("base").value) || DEFAULT_BASE;
    localStorage.setItem(LS_BASE, b);
    localStorage.setItem(LS_KEY, ($("adminKey").value||"").trim());
    localStorage.setItem(LS_SK, ($("surveyKey").value||"").trim() || DEFAULT_SK);
    $("base").value = b;
    log(`âœ… å·²å„²å­˜ï¼šbase=${b} / surveyKey=${$("surveyKey").value.trim() || DEFAULT_SK}`);
  }

  function reset(){
    localStorage.setItem(LS_BASE, DEFAULT_BASE);
    localStorage.removeItem(LS_KEY);
    localStorage.setItem(LS_SK, DEFAULT_SK);
    load();
    log("ğŸ” å·²é‡ç½®ç‚ºé è¨­");
  }

  function clearLog(){ logEl.textContent = ""; }

  function base(){ return normBase($("base").value) || DEFAULT_BASE; }
  function surveyKey(){ return ($("surveyKey").value||"").trim() || DEFAULT_SK; }
  function adminKey(){ return ($("adminKey").value||"").trim(); }

  async function fetchJson(path, body, withAdmin=false){
    const url = base() + path;
    log(`â¡ï¸ ${url}`);
    let res, text;
    try{
      res = await fetch(url, {
        method: body ? "POST" : "GET",
        mode: "cors",
        headers: {
          "Content-Type":"application/json",
          ...(withAdmin && adminKey() ? {"X-Admin-Key": adminKey()} : {})
        },
        body: body ? JSON.stringify(body) : undefined
      });
      text = await res.text();
    }catch(e){
      log(`âŒ Fetch å¤±æ•—ï¼š${e?.message || e}`);
      log(`âš ï¸ è‹¥ä½ æ˜¯ GitHub Pagesï¼ŒWorker å¿…é ˆé–‹ CORSï¼ˆä½ é€™ä»½ worker å·²ç¶“æœ‰ *ï¼‰`);
      return null;
    }

    log(`â¬…ï¸ HTTP ${res.status} ${res.ok ? "OK" : "ERR"}`);

    try{
      const j = JSON.parse(text);
      log(`ğŸ“¦ ${JSON.stringify(j, null, 2)}`);
      return j;
    }catch{
      log(`ğŸ“¦ ${text}`);
      return { ok:false, raw:text };
    }
  }

  async function ping(){
    // å°é½Šä½ çš„ workerï¼šGET /health
    const j = await fetchJson("/health", null, false);
    if(!j) return;
    if(j.ok) log("âœ… é€£ç·š OKï¼ˆ/healthï¼‰");
    else log("âš ï¸ /health å›å‚³é okï¼ˆè«‹çœ‹ä¸Šæ–¹ logï¼‰");
  }

  async function rulesGet(){
    const j = await fetchJson("/survey/rules/get", { surveyKey: surveyKey() }, false);
    if(!j) return;
    $("rules").value = j.rules ? JSON.stringify(j.rules, null, 2) : "";
    if(!j.rules) log("âš ï¸ KV å°šæœªæœ‰è¦å‰‡ï¼ˆrules=nullï¼‰ï¼Œè«‹è²¼ä¸Šè¦å‰‡å¾ŒæŒ‰ã€Œå¯«è¦å‰‡ã€");
  }

  async function rulesSet(){
    let rulesObj = null;
    const raw = $("rules").value.trim();
    if(!raw) return alert("rules ä¸èƒ½ç©ºç™½");
    try{ rulesObj = JSON.parse(raw); }catch{ return alert("rules ä¸æ˜¯åˆæ³• JSON"); }

    const j = await fetchJson("/survey/rules/set", { surveyKey: surveyKey(), rules: rulesObj }, true);
    if(!j) return;
    if(j.ok) log("âœ… å·²å¯«å…¥è¦å‰‡åˆ° KV");
  }

  async function submit(){
    let ansObj = {};
    const raw = $("answers").value.trim();
    if(raw){
      try{ ansObj = JSON.parse(raw); }catch{ return alert("answers ä¸æ˜¯åˆæ³• JSON"); }
    }
    const j = await fetchJson("/survey/submit", { surveyKey: surveyKey(), answers: ansObj }, false);
    if(!j) return;
    if(j.ok && j.report) log("âœ… å·²ç”¢å‡º reportï¼ˆçœ‹ä¸Šæ–¹ JSONï¼‰");
  }

  function fillDemo(){
    $("answers").value = JSON.stringify({ q1:"0", q2:"2", q3:"1" }, null, 2);
    log("ğŸ§ª å·²å¡«å…¥ answers ç¯„ä¾‹");
  }

  async function copyLog(){
    const t = logEl.textContent || "";
    try{ await navigator.clipboard.writeText(t); alert("å·²è¤‡è£½"); }
    catch{ prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", t); }
  }

  load();
  return { toggleHelp, save, reset, clearLog, copyLog, ping, rulesGet, rulesSet, submit, fillDemo };
})();
</script>
</body>
</html>
