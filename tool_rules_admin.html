// ✅ 最小後台 API：三槽位規則 + 上線指標
// KV keys:
// - RULES_PROD / RULES_DEV / RULES_OLD : JSON string
// - RULES_ACTIVE_SLOT : "prod" | "dev" | "old"
//
// Secrets:
// - ADMIN_TOKEN

function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { "content-type": "application/json; charset=utf-8" },
  });
}

function assertAdmin(request, env) {
  const t = request.headers.get("x-admin-token") || "";
  if (!env.ADMIN_TOKEN || t !== env.ADMIN_TOKEN) {
    throw new Response(JSON.stringify({ error: "Unauthorized" }), {
      status: 401,
      headers: { "content-type": "application/json; charset=utf-8" },
    });
  }
}

function slotToKey(slot) {
  if (slot === "prod") return "RULES_PROD";
  if (slot === "dev") return "RULES_DEV";
  if (slot === "old") return "RULES_OLD";
  return null;
}

async function handleAdminApi(request, env) {
  // 管理端驗證
  assertAdmin(request, env);

  const url = new URL(request.url);

  // GET /admin/active
  if (url.pathname === "/admin/active" && request.method === "GET") {
    const active = (await env.DB.get("RULES_ACTIVE_SLOT")) || "prod";
    return json({ active });
  }

  // PUT /admin/active  body: { active: "prod|dev|old" }
  if (url.pathname === "/admin/active" && request.method === "PUT") {
    const body = await request.json();
    const active = body?.active;
    if (!["prod","dev","old"].includes(active)) return json({ error: "invalid active" }, 400);
    await env.DB.put("RULES_ACTIVE_SLOT", active);
    return json({ ok: true, active });
  }

  // GET /admin/rules?slot=prod|dev|old
  if (url.pathname === "/admin/rules" && request.method === "GET") {
    const slot = url.searchParams.get("slot") || "prod";
    const key = slotToKey(slot);
    if (!key) return json({ error: "invalid slot" }, 400);
    const raw = await env.DB.get(key);
    if (!raw) return json({ rules: {} }); // 空的也回傳
    try { return json({ rules: JSON.parse(raw) }); }
    catch { return json({ rules: raw }); }
  }

  // PUT /admin/rules?slot=... body: { rules: <object> }
  if (url.pathname === "/admin/rules" && request.method === "PUT") {
    const slot = url.searchParams.get("slot") || "prod";
    const key = slotToKey(slot);
    if (!key) return json({ error: "invalid slot" }, 400);
    const body = await request.json();
    const rules = body?.rules ?? {};
    await env.DB.put(key, JSON.stringify(rules));
    return json({ ok: true, slot });
  }

  // POST /admin/backup-prod-to-old
  if (url.pathname === "/admin/backup-prod-to-old" && request.method === "POST") {
    const prod = await env.DB.get("RULES_PROD");
    if (prod) await env.DB.put("RULES_OLD", prod);
    return json({ ok: true });
  }

  return json({ error: "Not Found" }, 404);
}

// ✅ 你原本的 fetch 裡加這段路由（放最前面）
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // 後台 API
    if (url.pathname.startsWith("/admin/")) {
      try { return await handleAdminApi(request, env); }
      catch (e) { return e instanceof Response ? e : json({ error: "server error" }, 500); }
    }

    // ✅ 問卷規則讀取：永遠從 ACTIVE_SLOT 指到的槽位讀
    // 你把你原本的規則讀取改成下面這種即可：
    // const active = (await env.DB.get("RULES_ACTIVE_SLOT")) || "prod";
    // const rulesKey = active === "dev" ? "RULES_DEV" : active === "old" ? "RULES_OLD" : "RULES_PROD";
    // const rules = JSON.parse((await env.DB.get(rulesKey)) || "{}");

    return new Response("OK");
  }
};
