<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloudflare çµ±ä¸€çª—å£ï½œæŒ‡ä»¤æ§åˆ¶å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bd:rgba(15,23,42,.10); --glass:rgba(255,255,255,.82); --glass2:rgba(255,255,255,.70); }
    body{
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(950px 520px at 90% 12%, rgba(16,185,129,.16), transparent 55%),
        radial-gradient(1000px 650px at 50% 110%, rgba(245,158,11,.14), transparent 60%),
        #f8fafc;
    }
    .glass{ background:var(--glass); border:1px solid var(--bd); backdrop-filter: blur(12px); box-shadow: 0 18px 55px rgba(15,23,42,.10);}
    .glass2{ background:var(--glass2); border:1px solid var(--bd); backdrop-filter: blur(10px); box-shadow: 0 10px 26px rgba(15,23,42,.06);}
    .btn{ border:1px solid var(--bd); background:#fff; }
    .btn:hover{ background:#f1f5f9; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.75);
      padding:.12rem .45rem;
      border-radius: .7rem;
      font-size: .82em;
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="mx-auto max-w-6xl px-4 pt-5 pb-24">
    <!-- Header -->
    <div class="glass rounded-3xl px-5 py-4 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-extrabold text-slate-900 truncate">Cloudflare çµ±ä¸€çª—å£ï½œæŒ‡ä»¤æ§åˆ¶å°</div>
        <div class="text-sm text-slate-600 truncate">
          ä½ æ‰€æœ‰å·¥å…·è¦ç”¨ Cloudflare åŠŸèƒ½ â†’ éƒ½æ”¹ç”±é€™è£¡ç™¼æŒ‡ä»¤ï¼ˆWorker APIï¼‰
        </div>
      </div>
      <button class="btn text-sm px-4 py-2 rounded-2xl" onclick="UI.toggleHelp()">æ•™å­¸</button>
    </div>

    <!-- Help -->
    <div id="help" class="hidden mt-4 glass2 rounded-3xl p-5 text-sm text-slate-700">
      <div class="font-bold text-slate-900">é€™é åœ¨åšä»€éº¼ï¼Ÿ</div>
      <div class="mt-2 text-slate-600">
        é€™æ˜¯ã€ŒCloudflare æŒ‡ä»¤æ§åˆ¶å°ã€ï¼Œä¸æ˜¯å·¥å…·è·³è½‰é ã€‚<br/>
        ä½ åœ¨é€™è£¡æŒ‰æŒ‰éˆ•ï¼Œæœƒç›´æ¥å° Worker ç™¼é€æŒ‡ä»¤ï¼ˆä¾‹å¦‚ KV è¨­å®šã€è®€å¯«ã€åˆ—å‡º Keyã€æ¸…é™¤å¿«å–â€¦ï¼‰ã€‚<br/>
        <span class="font-bold">å¦‚æœæŒ‰äº†æ²’åæ‡‰ï¼é€šå¸¸æ˜¯ Worker æ²’é–‹ CORS</span>ï¼ˆä¸‹é¢æœƒé¡¯ç¤ºéŒ¯èª¤åŸå› ï¼‰ã€‚
      </div>
    </div>

    <!-- Gateway -->
    <div class="mt-4 glass2 rounded-3xl p-5">
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="flex-1">
          <div class="text-base font-bold text-slate-900">Gatewayï¼ˆWorker ç¶²åŸŸï¼‰</div>
          <div class="mt-1 text-sm text-slate-600">ä¾‹å¦‚ï¼š<span class="kbd">https://api.zxcv8096.workers.dev</span></div>
          <input id="gw" class="mt-3 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)"
                 placeholder="è²¼ä¸Šä½ çš„ Worker ç¶²åŸŸâ€¦" />
          <div class="mt-2 text-xs text-slate-500">æœƒå­˜åˆ° <span class="kbd">localStorage.GW_BASE</span></div>
        </div>
        <div class="flex gap-2">
          <button class="btn px-4 py-3 rounded-2xl text-sm font-semibold" onclick="UI.saveGW()">å„²å­˜</button>
          <button class="btn px-4 py-3 rounded-2xl text-sm" onclick="UI.resetGW()">é‡ç½®</button>
        </div>
      </div>
    </div>

    <!-- Command Panel -->
    <div class="mt-5 grid lg:grid-cols-2 gap-4">
      <!-- KV: get/set -->
      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-bold text-slate-900">KV æŒ‡ä»¤ï¼ˆå¸¸ç”¨ï¼‰</div>
        <div class="mt-1 text-sm text-slate-600">è®€å¯«ä½ çš„ KVï¼ˆä¾‹å¦‚ RULES_JSONã€CONFIGã€TOKENâ€¦ï¼‰</div>

        <div class="mt-4 grid gap-3">
          <div>
            <div class="text-sm font-semibold text-slate-900">Key</div>
            <input id="kvKey" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)"
                   placeholder="ä¾‹å¦‚ï¼šRULES_JSON" />
          </div>

          <div>
            <div class="text-sm font-semibold text-slate-900">Valueï¼ˆJSON / æ–‡å­—ï¼‰</div>
            <textarea id="kvVal" rows="6" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80 font-mono text-xs"
                      style="border-color:var(--bd)"
                      placeholder='ä¾‹å¦‚ï¼š{"version":1,"rules":[...]} æˆ–ä»»ä½•æ–‡å­—'></textarea>
          </div>

          <div class="flex flex-wrap gap-2">
            <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.kvGet()">è®€å–</button>
            <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.kvPut()">å¯«å…¥</button>
            <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.kvDel()">åˆªé™¤</button>
          </div>
        </div>
      </div>

      <!-- KV: list -->
      <div class="glass2 rounded-3xl p-5">
        <div class="text-base font-bold text-slate-900">KV Keysï¼ˆæŸ¥è©¢ï¼‰</div>
        <div class="mt-1 text-sm text-slate-600">åˆ—å‡º KV è£¡æœ‰å“ªäº› keyï¼ˆå¯ç”¨ prefix ç¯©é¸ï¼‰</div>

        <div class="mt-4 grid gap-3">
          <div>
            <div class="text-sm font-semibold text-slate-900">Prefixï¼ˆå¯ç©ºï¼‰</div>
            <input id="kvPrefix" class="mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)"
                   placeholder="ä¾‹å¦‚ï¼šRULE_ æˆ– ç•™ç©ºåˆ—å‡ºå…¨éƒ¨" />
          </div>

          <div class="flex gap-2">
            <button class="btn px-4 py-2 rounded-2xl text-sm font-semibold" onclick="UI.kvList()">åˆ—å‡º Keys</button>
            <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.clearLog()">æ¸…ç©º Log</button>
          </div>

          <div class="text-xs text-slate-500">
            ä½  Worker éœ€è¦æä¾› APIï¼š<span class="kbd">/api/kv/list</span>ã€<span class="kbd">/api/kv/get</span>ã€<span class="kbd">/api/kv/put</span>ã€<span class="kbd">/api/kv/del</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Log -->
    <div class="mt-5 glass rounded-3xl p-5">
      <div class="flex items-center justify-between gap-3">
        <div class="text-base font-bold text-slate-900">åŸ·è¡Œ Logï¼ˆä¸€å®šæœƒé¡¯ç¤ºçµæœï¼‰</div>
        <button class="btn px-4 py-2 rounded-2xl text-sm" onclick="UI.copyLog()">è¤‡è£½ Log</button>
      </div>
      <pre id="log" class="mt-4 text-xs bg-white/70 border rounded-2xl p-4 overflow-auto max-h-[360px]"
           style="border-color:var(--bd)"></pre>
    </div>
  </div>

<script>
const UI = (() => {
  const K_GW = "GW_BASE";
  const DEFAULT_GW = "https://api.zxcv8096.workers.dev";

  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");

  function normalizeGW(v){
    const s = String(v||"").trim();
    if(!s) return "";
    if(!/^https?:\/\//i.test(s)) return ("https://" + s.replace(/^\/+/,"")).replace(/\/+$/,"");
    return s.replace(/\/+$/,"");
  }

  let GW = normalizeGW(localStorage.getItem(K_GW)) || DEFAULT_GW;
  localStorage.setItem(K_GW, GW);
  $("gw").value = GW;

  function log(line){
    const ts = new Date().toLocaleTimeString();
    logEl.textContent = `[${ts}] ${line}\n` + logEl.textContent;
  }

  function toggleHelp(){
    $("help").classList.toggle("hidden");
  }

  function saveGW(){
    const v = normalizeGW($("gw").value);
    if(!v) return alert("Gateway ä¸èƒ½ç©ºç™½");
    GW = v;
    localStorage.setItem(K_GW, GW);
    log(`âœ… å·²å„²å­˜ Gateway = ${GW}`);
  }

  function resetGW(){
    GW = DEFAULT_GW;
    $("gw").value = GW;
    localStorage.setItem(K_GW, GW);
    log(`ğŸ” å·²é‡ç½® Gateway = ${GW}`);
  }

  function clearLog(){ logEl.textContent = ""; }

  async function call(path, body){
    const url = GW + path;
    log(`â¡ï¸ ${url}`);
    try{
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body || {})
      });
      const text = await res.text();
      log(`â¬…ï¸ HTTP ${res.status} ${res.ok ? "OK" : "ERR"}`);
      // å˜—è©¦ parse JSONï¼Œå¤±æ•—å°±åŸæ¨£é¡¯ç¤º
      try{
        const j = JSON.parse(text);
        log(`ğŸ“¦ ${JSON.stringify(j, null, 2)}`);
        return j;
      }catch{
        log(`ğŸ“¦ ${text}`);
        return text;
      }
    }catch(e){
      log(`âŒ Fetch å¤±æ•—ï¼š${e?.message || e}`);
      log(`âš ï¸ å¸¸è¦‹åŸå› ï¼šWorker æ²’é–‹ CORSï¼ˆGitHub Pages æœƒæ“‹ï¼‰`);
      return null;
    }
  }

  // ===== KV actions =====
  async function kvGet(){
    const key = $("kvKey").value.trim();
    if(!key) return alert("Key ä¸èƒ½ç©ºç™½");
    await call("/api/kv/get", { key });
  }
  async function kvPut(){
    const key = $("kvKey").value.trim();
    if(!key) return alert("Key ä¸èƒ½ç©ºç™½");
    const valRaw = $("kvVal").value;
    // å¦‚æœæ˜¯ JSONï¼Œä¿æŒ JSONï¼›ä¸æ˜¯å°±ç•¶å­—ä¸²
    let value = valRaw;
    try{ value = JSON.parse(valRaw); }catch{}
    await call("/api/kv/put", { key, value });
  }
  async function kvDel(){
    const key = $("kvKey").value.trim();
    if(!key) return alert("Key ä¸èƒ½ç©ºç™½");
    await call("/api/kv/del", { key });
  }
  async function kvList(){
    const prefix = $("kvPrefix").value.trim();
    await call("/api/kv/list", { prefix });
  }

  async function copyLog(){
    const t = logEl.textContent || "";
    try{ await navigator.clipboard.writeText(t); alert("å·²è¤‡è£½"); }
    catch{ prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", t); }
  }

  return { toggleHelp, saveGW, resetGW, clearLog, copyLog, kvGet, kvPut, kvDel, kvList };
})();
</script>
</body>
</html>
