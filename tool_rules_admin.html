<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…¨å·¥å…·ä¸­æ§å°ï½œçµ±ä¸€çª—å£ Gateway</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --ink:#0f172a; --muted:#475569; --muted2:#64748b;
      --bd:rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.80);
      --glass2: rgba(255,255,255,.66);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
      --shadow2: 0 8px 24px rgba(15,23,42,.08);
    }
    body{
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(950px 520px at 90% 12%, rgba(16,185,129,.16), transparent 55%),
        radial-gradient(1000px 650px at 50% 110%, rgba(245,158,11,.14), transparent 60%),
        #f8fafc;
    }
    .glass{ background:var(--glass); border:1px solid var(--bd); backdrop-filter: blur(12px); box-shadow: var(--shadow); }
    .glass-soft{ background:var(--glass2); border:1px solid var(--bd); backdrop-filter: blur(10px); box-shadow: var(--shadow2); }
    .btn{ border:1px solid var(--bd); background:white; }
    .btn:hover{ background:#f1f5f9; }
    .pill{ border:1px solid var(--bd); background: rgba(255,255,255,.72); }
    .card{
      background: rgba(255,255,255,.86);
      border:1px solid var(--bd);
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 38px rgba(15,23,42,.10);
      background: rgba(255,255,255,.95);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.75);
      padding:.12rem .45rem;
      border-radius: .7rem;
      font-size: .82em;
      color:#0f172a;
    }
    .no-ring:focus{ outline:none; box-shadow:none; }
  </style>
</head>

<body class="min-h-screen">
  <!-- Top -->
  <header class="sticky top-0 z-30">
    <div class="mx-auto max-w-6xl px-4 pt-4">
      <div class="glass rounded-3xl px-5 py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="h-12 w-12 rounded-2xl flex items-center justify-center shrink-0"
               style="background: linear-gradient(135deg, rgba(59,130,246,.20), rgba(16,185,129,.18)); border:1px solid var(--bd);">
            <span class="text-2xl">ğŸ§­</span>
          </div>
          <div class="min-w-0">
            <div class="text-lg font-extrabold leading-tight truncate">å…¨å·¥å…·ä¸­æ§å°ï¼ˆçµ±ä¸€çª—å£ï¼‰</div>
            <div class="text-sm mt-1 truncate" style="color:var(--muted2)">
              æ‰€æœ‰ Cloudflare åŠŸèƒ½éƒ½ç”± Gateway çµ±ä¸€è½‰ï¼š<span class="kbd" id="gwBadge"></span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2 shrink-0">
          <span id="envBadge" class="pill text-xs px-3 py-2 rounded-2xl">â€”</span>
          <button id="btnHelp" class="btn text-sm px-4 py-2 rounded-2xl">æ•™å­¸</button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-24">
    <!-- Gateway -->
    <section class="mt-4 glass-soft rounded-3xl p-5">
      <div class="flex flex-col lg:flex-row gap-4">
        <div class="flex-1 min-w-0">
          <div class="text-base font-bold">Gatewayï¼ˆçµ±ä¸€çª—å£ï¼‰</div>
          <div class="mt-1 text-sm" style="color:var(--muted)">
            å·¥å…·æ”¾å“ªè£¡éƒ½å¯ä»¥ï¼šä½ åœ¨å·¥å…·æ¸…å–®å¡«ã€Œå®Œæ•´ç¶²å€ã€æˆ–ã€Œç›¸å°è·¯å¾‘ã€ï¼Œé€™è£¡æœƒè² è²¬çµ±ä¸€è·³è½‰èˆ‡çµ±ä¸€ Cloudflare å…¥å£ã€‚
          </div>

          <div class="mt-4 grid md:grid-cols-3 gap-3">
            <div class="pill rounded-2xl p-4 md:col-span-2">
              <div class="text-sm font-semibold">Gateway Baseï¼ˆWorker ç¶²åŸŸï¼‰</div>
              <div class="mt-2 flex flex-col sm:flex-row gap-2">
                <input id="gwInput" class="no-ring w-full rounded-2xl px-4 py-3 border bg-white/80"
                       style="border-color:var(--bd)"
                       placeholder="ä¾‹å¦‚ï¼šhttps://api.zxcv8096.workers.dev" />
                <button id="gwSave" class="btn px-4 py-3 rounded-2xl text-sm font-semibold whitespace-nowrap">å„²å­˜</button>
              </div>
              <div class="mt-2 text-xs" style="color:var(--muted)">
                å­˜åœ¨ <span class="kbd">localStorage.GW_BASE</span>ï¼Œä¸¦ä¸”é»å·¥å…·æœƒè‡ªå‹•å¸¶ <span class="kbd">?gw=</span>
              </div>
            </div>

            <div class="pill rounded-2xl p-4">
              <div class="text-sm font-semibold">é€£ç·šæ¸¬è©¦</div>
              <div class="mt-2 text-sm break-words" id="gwStatus" style="color:var(--muted)">å°šæœªæ¸¬è©¦</div>
              <div class="mt-3 flex gap-2">
                <button id="gwTest" class="btn px-4 py-2 rounded-2xl text-sm">æ¸¬è©¦</button>
                <button id="gwReset" class="btn px-4 py-2 rounded-2xl text-sm">é‡ç½®</button>
              </div>
            </div>
          </div>

          <div class="mt-4 grid lg:grid-cols-3 gap-3 text-sm">
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">ä½ ç›®å‰é–‹å•Ÿçš„ä½ç½®</div>
              <div class="mt-1" style="color:var(--muted)">
                Hostï¼š<span id="host" class="font-mono"></span><br/>
                Pathï¼š<span id="path" class="font-mono"></span>
              </div>
            </div>
            <div class="pill rounded-2xl p-4 min-w-0">
              <div class="font-semibold">è·³è½‰é è¨­è¦å‰‡</div>
              <div class="mt-1 text-xs" style="color:var(--muted)">
                å®Œæ•´ç¶²å€ï¼šç›´æ¥é–‹<br/>
                ç›¸å°è·¯å¾‘ï¼šç”¨ Gateway çµ„åˆï¼ˆ<span class="font-mono">GW + /path</span>ï¼‰
              </div>
            </div>
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">å¿«é€Ÿå‹•ä½œ</div>
              <div class="mt-2 flex gap-2">
                <button id="btnAdd" class="btn px-4 py-2 rounded-2xl text-sm">ï¼‹æ–°å¢å·¥å…·</button>
                <button id="btnExport" class="btn px-4 py-2 rounded-2xl text-sm">åŒ¯å‡º</button>
                <button id="btnImport" class="btn px-4 py-2 rounded-2xl text-sm">åŒ¯å…¥</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Search panel -->
        <div class="w-full lg:w-[360px] shrink-0">
          <div class="pill rounded-2xl p-4">
            <div class="text-sm font-semibold">æœå°‹ / ç¯©é¸</div>
            <div class="mt-3 flex gap-2">
              <input id="q" class="no-ring w-full rounded-2xl px-4 py-3 border bg-white/80"
                     style="border-color:var(--bd)"
                     placeholder="æœå°‹å·¥å…·â€¦ï¼ˆæŒ‰ / èšç„¦ï¼‰" />
              <button id="clear" class="btn px-4 py-3 rounded-2xl text-sm">æ¸…é™¤</button>
            </div>
            <div class="mt-3 flex gap-2">
              <select id="cat" class="no-ring w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)">
                <option value="">å…¨éƒ¨åˆ†é¡</option>
              </select>
              <select id="sort" class="no-ring w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)">
                <option value="pin">ç½®é ‚å„ªå…ˆ</option>
                <option value="name">åç¨±æ’åº</option>
                <option value="new">æœ€æ–°æ–°å¢</option>
              </select>
            </div>
            <div class="mt-3 text-xs" style="color:var(--muted)">
              å¿«æ·éµï¼š<span class="kbd">/</span> æœå°‹ã€€<span class="kbd">Esc</span> é—œé–‰è¦–çª—
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tools -->
    <section class="mt-5">
      <div class="flex items-end justify-between gap-3">
        <div class="min-w-0">
          <div class="text-base font-bold">å·¥å…·æ¸…å–®ï¼ˆä½ç½®ä»»æ„ï¼‰</div>
          <div class="text-sm truncate" style="color:var(--muted)">
            æ”¯æ´ï¼š<span class="kbd">https://å®Œæ•´ç¶²å€</span>ã€<span class="kbd">/ç›¸å°è·¯å¾‘</span>ã€<span class="kbd">pages/xxx.html</span>
          </div>
        </div>
        <div class="text-xs pill px-3 py-2 rounded-2xl shrink-0">
          å…± <span id="count">0</span> å€‹
        </div>
      </div>

      <div id="grid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

      <div id="empty" class="hidden mt-5 glass-soft rounded-3xl p-6 text-center">
        <div class="text-lg font-bold">ç›®å‰æ²’æœ‰å·¥å…·</div>
        <div class="mt-2 text-sm" style="color:var(--muted)">é»ã€Œæ–°å¢å·¥å…·ã€æŠŠä½ çš„å·¥å…·ç¶²å€åŠ é€²ä¾†</div>
      </div>
    </section>
  </main>

  <!-- Help modal -->
  <div id="helpModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto max-w-2xl px-4 py-6 sm:py-10 h-full flex items-center">
      <div class="glass rounded-3xl w-full max-h-[85vh] flex flex-col overflow-hidden">
        <div class="px-5 py-4 border-b" style="border-color:var(--bd);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-extrabold">æ•™å­¸ï¼šçµ±ä¸€çª—å£æ€éº¼ç”¨</div>
              <div class="text-sm mt-1" style="color:var(--muted)">
                é€™é æ˜¯ã€Œå…¨å·¥å…·å…¥å£ã€ï¼Œä¸æ˜¯å•å·å¾Œå°ã€‚æ ¸å¿ƒæ˜¯ï¼šGateway çµ±ä¸€ Cloudflare å…¥å£ + å·¥å…·æ¸…å–®çµ±ä¸€è·³è½‰ã€‚
              </div>
            </div>
            <button id="helpCloseTop" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
          </div>
        </div>

        <div class="px-5 py-4 overflow-auto text-sm space-y-3">
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">1) è¨­ Gateway</div>
            <div class="mt-1" style="color:var(--muted)">
              åœ¨ä¸Šæ–¹è¼¸å…¥ Worker ç¶²åŸŸ â†’ å„²å­˜ã€‚æ‰€æœ‰å·¥å…·æœƒå…±ç”¨åŒä¸€å€‹ <span class="kbd">GW_BASE</span>ã€‚
            </div>
          </div>
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">2) å·¥å…·ä½ç½®ä»»æ„</div>
            <div class="mt-1" style="color:var(--muted)">
              â€¢ ä½ å¡«å®Œæ•´ç¶²å€ï¼šç›´æ¥é–‹<br/>
              â€¢ ä½ å¡«ç›¸å°è·¯å¾‘ï¼šæœƒç”¨ Gateway çµ„åˆæˆå®Œæ•´ç¶²å€å†é–‹
            </div>
          </div>
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">3) å·¥å…·è¦æ‹¿ Gateway</div>
            <div class="mt-1" style="color:var(--muted)">
              é»å·¥å…·æœƒè‡ªå‹•å¸¶ <span class="kbd">?gw=</span>ï¼›å·¥å…·ä¹Ÿå¯è®€ <span class="kbd">localStorage.GW_BASE</span>ã€‚
            </div>
          </div>
          <div class="pill rounded-2xl p-4">
            <div class="font-bold">4) æ¸¬è©¦æŒ‰éˆ•èªªæ˜</div>
            <div class="mt-1" style="color:var(--muted)">
              æ¸¬è©¦æœƒå˜—è©¦æŠ“ <span class="kbd">GW/</span>ã€‚è‹¥è¢« CORS æ“‹ï¼Œæœƒé¡¯ç¤ºã€ŒCORS å¯èƒ½é˜»æ“‹ã€ï¼Œä½†ä¸ä»£è¡¨ Gateway å£ã€‚
            </div>
          </div>
        </div>

        <div class="px-5 py-4 border-t flex items-center justify-between gap-3" style="border-color:var(--bd);">
          <div class="text-xs" style="color:var(--muted)">Esc å¯é—œé–‰</div>
          <button id="helpClose" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Editor modal -->
  <div id="editModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto max-w-2xl px-4 py-6 sm:py-10 h-full flex items-center">
      <div class="glass rounded-3xl w-full max-h-[85vh] flex flex-col overflow-hidden">
        <div class="px-5 py-4 border-b" style="border-color:var(--bd);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-extrabold" id="editTitle">æ–°å¢å·¥å…·</div>
              <div class="text-sm mt-1" style="color:var(--muted)">å·¥å…·å¯æ”¾ä»»æ„ç¶²å€æˆ–ä»»æ„è·¯å¾‘</div>
            </div>
            <button id="editCloseTop" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
          </div>
        </div>

        <div class="px-5 py-4 overflow-auto text-sm space-y-3">
          <div class="grid md:grid-cols-2 gap-3">
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">åç¨±ï¼ˆä¸­æ–‡ï¼‰</div>
              <input id="fName" class="no-ring mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)" placeholder="ä¾‹å¦‚ï¼šè‡ªå‹•å›è¦†" />
            </div>
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">åˆ†é¡ï¼ˆå¯é¸ï¼‰</div>
              <input id="fCat" class="no-ring mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)" placeholder="ä¾‹å¦‚ï¼šå›è¦† / é¸å–® / åœ–ç‰‡ / ç³»çµ±" />
            </div>
          </div>

          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">å·¥å…·ç¶²å€ / è·¯å¾‘</div>
            <div class="mt-1 text-xs" style="color:var(--muted)">
              å®Œæ•´ç¶²å€ https://â€¦ æˆ– /path æˆ– pages/â€¦ éƒ½å¯ä»¥
            </div>
            <input id="fUrl" class="no-ring mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)"
                   placeholder="ä¾‹å¦‚ï¼šhttps://example.com/tool.html æˆ– /pages/tools/auto_reply.html" />
          </div>

          <div class="grid md:grid-cols-2 gap-3">
            <div class="pill rounded-2xl p-4">
              <div class="font-semibold">åœ–ç¤ºï¼ˆemojiï¼‰</div>
              <input id="fIcon" class="no-ring mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)" placeholder="ä¾‹å¦‚ï¼šğŸ¤–" />
            </div>
            <div class="pill rounded-2xl p-4 flex items-center gap-4">
              <label class="flex items-center gap-2">
                <input id="fPinned" type="checkbox" class="scale-110" />
                <span class="font-semibold">ç½®é ‚</span>
              </label>
              <label class="flex items-center gap-2">
                <input id="fNewTab" type="checkbox" class="scale-110" />
                <span class="font-semibold">æ–°åˆ†é </span>
              </label>
            </div>
          </div>

          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">èªªæ˜ï¼ˆå¯é¸ï¼‰</div>
            <textarea id="fDesc" rows="3" class="no-ring mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80" style="border-color:var(--bd)"
              placeholder="ä¾‹å¦‚ï¼šé—œéµå­— â†’ è¦å‰‡åº«å›è¦†ï¼ˆèµ° Gatewayï¼‰"></textarea>
          </div>

          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">å¯¦éš›è·³è½‰é è¦½</div>
            <div class="mt-2 text-xs" style="color:var(--muted)">
              æœƒè‡ªå‹•é™„åŠ  <span class="kbd">?gw=</span>ï¼ˆå·¥å…·å¯ç”¨ query æˆ– localStorage è®€ Gatewayï¼‰
            </div>
            <div class="mt-2 font-mono text-xs break-all" id="previewUrl" style="color:var(--muted)">â€”</div>
            <div class="mt-3 flex gap-2">
              <button id="btnPreviewOpen" class="btn px-4 py-2 rounded-2xl text-sm">é–‹å•Ÿé è¦½</button>
              <button id="btnPreviewCopy" class="btn px-4 py-2 rounded-2xl text-sm">è¤‡è£½ç¶²å€</button>
            </div>
          </div>
        </div>

        <div class="px-5 py-4 border-t flex items-center justify-between gap-3" style="border-color:var(--bd);">
          <div class="text-xs" style="color:var(--muted)" id="editFoot">â€”</div>
          <div class="flex items-center gap-2">
            <button id="btnDelete" class="btn px-4 py-2 rounded-2xl text-sm">åˆªé™¤</button>
            <button id="btnSaveTool" class="btn px-4 py-2 rounded-2xl text-sm font-semibold">å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- IO modal -->
  <div id="ioModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto max-w-2xl px-4 py-6 sm:py-10 h-full flex items-center">
      <div class="glass rounded-3xl w-full max-h-[85vh] flex flex-col overflow-hidden">
        <div class="px-5 py-4 border-b" style="border-color:var(--bd);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-extrabold" id="ioTitle">åŒ¯å‡º / åŒ¯å…¥</div>
              <div class="text-sm mt-1" style="color:var(--muted)">å‚™ä»½ä½ çš„ Gateway + å·¥å…·æ¸…å–®ï¼ˆJSONï¼‰</div>
            </div>
            <button id="ioCloseTop" class="btn text-sm px-4 py-2 rounded-2xl">é—œé–‰</button>
          </div>
        </div>
        <div class="px-5 py-4 overflow-auto text-sm space-y-3">
          <div class="pill rounded-2xl p-4">
            <div class="font-semibold">JSON å…§å®¹</div>
            <textarea id="ioText" rows="14" class="no-ring mt-2 w-full rounded-2xl px-4 py-3 border bg-white/80 font-mono text-xs"
              style="border-color:var(--bd)"></textarea>
            <div class="mt-3 flex gap-2">
              <button id="ioCopy" class="btn px-4 py-2 rounded-2xl text-sm">è¤‡è£½</button>
              <button id="ioApply" class="btn px-4 py-2 rounded-2xl text-sm font-semibold">å¥—ç”¨åŒ¯å…¥</button>
            </div>
          </div>
        </div>
        <div class="px-5 py-4 border-t flex items-center justify-between gap-3" style="border-color:var(--bd);">
          <div class="text-xs" style="color:var(--muted)">Esc å¯é—œé–‰</div>
          <button id="ioClose" class="btn px-4 py-2 rounded-2xl text-sm">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed bottom-5 left-0 right-0 z-[60] hidden">
    <div class="mx-auto max-w-md px-4">
      <div class="glass rounded-2xl px-4 py-3 text-sm" id="toastText"></div>
    </div>
  </div>

<script>
(() => {
  // ===== Keys =====
  const K_GW = "GW_BASE";
  const K_TOOLS = "TOOLS_LIST_V2";

  // ===== Defaults =====
  const DEFAULT_GW = "https://api.zxcv8096.workers.dev";
  const DEFAULT_TOOLS = [
    { id: uid(), name:"å¿«é€Ÿå›è¦†", cat:"å›è¦†", icon:"âš¡", desc:"å»ºç«‹ / ç®¡ç† Quick Reply", url:"/pages/tools/quickreply.html", pinned:true, newTab:false, createdAt: Date.now() },
    { id: uid(), name:"è‡ªå‹•å›è¦†", cat:"å›è¦†", icon:"ğŸ¤–", desc:"é—œéµå­— â†’ è¦å‰‡åº«å›è¦†", url:"/pages/tools/auto_reply.html", pinned:true, newTab:false, createdAt: Date.now() },
    { id: uid(), name:"Rich Menu", cat:"é¸å–®", icon:"ğŸ“Œ", desc:"åœ–æ–‡é¸å–®è¨­è¨ˆ / ç®¡ç†", url:"/pages/tools/tool_richmenu.html", pinned:false, newTab:false, createdAt: Date.now() },
  ];

  // ===== State =====
  let GW = loadGW();
  let TOOLS = loadTools();
  let editingId = null;

  // ===== DOM =====
  const $ = (id)=>document.getElementById(id);

  const gwBadge = $("gwBadge");
  const envBadge = $("envBadge");
  const hostEl = $("host");
  const pathEl = $("path");

  const gwInput = $("gwInput");
  const gwSave = $("gwSave");
  const gwTest = $("gwTest");
  const gwReset = $("gwReset");
  const gwStatus = $("gwStatus");

  const btnAdd = $("btnAdd");
  const btnExport = $("btnExport");
  const btnImport = $("btnImport");

  const q = $("q");
  const clear = $("clear");
  const cat = $("cat");
  const sort = $("sort");

  const grid = $("grid");
  const empty = $("empty");
  const countEl = $("count");

  const helpModal = $("helpModal");
  const btnHelp = $("btnHelp");
  const helpCloseTop = $("helpCloseTop");
  const helpClose = $("helpClose");

  const editModal = $("editModal");
  const editTitle = $("editTitle");
  const editCloseTop = $("editCloseTop");
  const editFoot = $("editFoot");
  const btnSaveTool = $("btnSaveTool");
  const btnDelete = $("btnDelete");

  const fName = $("fName");
  const fCat = $("fCat");
  const fUrl = $("fUrl");
  const fIcon = $("fIcon");
  const fDesc = $("fDesc");
  const fPinned = $("fPinned");
  const fNewTab = $("fNewTab");
  const previewUrl = $("previewUrl");
  const btnPreviewOpen = $("btnPreviewOpen");
  const btnPreviewCopy = $("btnPreviewCopy");

  const ioModal = $("ioModal");
  const ioTitle = $("ioTitle");
  const ioCloseTop = $("ioCloseTop");
  const ioClose = $("ioClose");
  const ioText = $("ioText");
  const ioCopy = $("ioCopy");
  const ioApply = $("ioApply");

  const toast = $("toast");
  const toastText = $("toastText");

  // ===== init =====
  hostEl.textContent = location.host;
  pathEl.textContent = location.pathname;

  envBadge.textContent =
    location.host.endsWith("workers.dev") ? "Workers âœ…" :
    location.host.endsWith("github.io") ? "github.io âœ…" :
    location.host === "github.com" ? "GitHub Code âš ï¸" :
    "Web âœ…";

  gwInput.value = GW;
  syncGWUI();
  rebuildCategoryOptions();
  render();

  // ===== events =====
  gwSave.addEventListener("click", () => {
    const v = normalizeGW(gwInput.value);
    if (!v) return toastShow("Gateway ä¸èƒ½ç©ºç™½");
    GW = v;
    localStorage.setItem(K_GW, GW);
    syncGWUI();
    gwStatus.textContent = "å·²å„²å­˜";
    toastShow("å·²å„²å­˜ Gateway");
  });

  gwReset.addEventListener("click", () => {
    GW = DEFAULT_GW;
    gwInput.value = GW;
    localStorage.setItem(K_GW, GW);
    syncGWUI();
    gwStatus.textContent = "å·²é‡ç½®";
    toastShow("å·²é‡ç½®ç‚ºé è¨­ Gateway");
  });

  gwTest.addEventListener("click", async () => {
    const base = normalizeGW(gwInput.value) || GW;
    gwStatus.textContent = "æ¸¬è©¦ä¸­â€¦";
    try{
      // âœ… ä¸å†ä¾è³´ /pingï¼šç›´æ¥æ¸¬ GW çš„ /
      const url = base.replace(/\/+$/,"") + "/?ts=" + Date.now();
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      gwStatus.textContent = `æœ‰å›æ‡‰ï¼šHTTP ${res.status}`;
      toastShow(`Gateway æœ‰å›æ‡‰ï¼šHTTP ${res.status}`);
    } catch (e){
      // å¤§å¤šæ˜¯ CORS æˆ–ç¶²åŸŸä¸å¯é”
      gwStatus.textContent = "å¯èƒ½è¢« CORS æ“‹æˆ–ç¶²åŸŸä¸å¯é”ï¼ˆå¯ç›´æ¥ç”¨ç€è¦½å™¨é–‹ Gateway ç¢ºèªï¼‰";
      toastShow("æ¸¬è©¦å¤±æ•—ï¼šå¯èƒ½ CORS æ“‹ / ç¶²åŸŸä¸å¯é”");
      // çµ¦ä½ ä¸€éµé–‹å•Ÿæª¢æŸ¥ï¼ˆä¸é˜»å¡ï¼‰
      window.open(base, "_blank");
    }
  });

  btnAdd.addEventListener("click", () => openEditor(null));

  btnExport.addEventListener("click", () => {
    openIO("åŒ¯å‡ºï¼ˆJSONï¼‰");
    ioText.value = JSON.stringify({ gw: GW, tools: TOOLS }, null, 2);
  });

  btnImport.addEventListener("click", () => {
    openIO("åŒ¯å…¥ï¼ˆJSONï¼‰");
    ioText.value = "";
  });

  q.addEventListener("input", render);
  clear.addEventListener("click", () => { q.value=""; render(); q.focus(); });
  cat.addEventListener("change", render);
  sort.addEventListener("change", render);

  // Help modal
  btnHelp.addEventListener("click", () => helpModal.classList.remove("hidden"));
  helpCloseTop.addEventListener("click", () => helpModal.classList.add("hidden"));
  helpClose.addEventListener("click", () => helpModal.classList.add("hidden"));
  helpModal.addEventListener("click", (e)=>{ if(e.target===helpModal) helpModal.classList.add("hidden"); });

  // Editor modal
  editCloseTop.addEventListener("click", closeEditor);
  editModal.addEventListener("click", (e)=>{ if(e.target===editModal) closeEditor(); });

  ["input","change"].forEach(ev=>{
    fUrl.addEventListener(ev, updatePreview);
    fName.addEventListener(ev, updatePreview);
    fCat.addEventListener(ev, updatePreview);
    fIcon.addEventListener(ev, updatePreview);
    fPinned.addEventListener(ev, updatePreview);
    fNewTab.addEventListener(ev, updatePreview);
  });

  btnPreviewOpen.addEventListener("click", ()=>{
    const u = previewUrl.textContent.trim();
    if(!u || u==="â€”") return;
    window.open(u, "_blank");
  });

  btnPreviewCopy.addEventListener("click", async ()=>{
    const u = previewUrl.textContent.trim();
    if(!u || u==="â€”") return;
    try{ await navigator.clipboard.writeText(u); toastShow("å·²è¤‡è£½ç¶²å€"); }
    catch{ prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", u); }
  });

  btnSaveTool.addEventListener("click", ()=>{
    const name = fName.value.trim() || "æœªå‘½åå·¥å…·";
    const urlv = fUrl.value.trim();
    if(!urlv) return toastShow("å·¥å…·ç¶²å€/è·¯å¾‘ä¸èƒ½ç©ºç™½");

    const obj = {
      id: editingId || uid(),
      name,
      cat: fCat.value.trim(),
      url: urlv,
      icon: fIcon.value.trim() || "ğŸ§©",
      desc: fDesc.value.trim(),
      pinned: !!fPinned.checked,
      newTab: !!fNewTab.checked,
      createdAt: editingId ? (findById(editingId)?.createdAt || Date.now()) : Date.now()
    };

    if(editingId){
      TOOLS = TOOLS.map(t=>t.id===editingId ? obj : t);
      toastShow("å·²æ›´æ–°å·¥å…·");
    } else {
      TOOLS = [obj, ...TOOLS];
      toastShow("å·²æ–°å¢å·¥å…·");
    }

    saveTools();
    rebuildCategoryOptions();
    render();
    closeEditor();
  });

  btnDelete.addEventListener("click", ()=>{
    if(!editingId) return;
    if(!confirm("ç¢ºå®šåˆªé™¤é€™å€‹å·¥å…·ï¼Ÿ")) return;
    TOOLS = TOOLS.filter(t=>t.id!==editingId);
    saveTools();
    rebuildCategoryOptions();
    render();
    closeEditor();
    toastShow("å·²åˆªé™¤å·¥å…·");
  });

  // IO modal
  ioCloseTop.addEventListener("click", closeIO);
  ioClose.addEventListener("click", closeIO);
  ioModal.addEventListener("click", (e)=>{ if(e.target===ioModal) closeIO(); });

  ioCopy.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(ioText.value); toastShow("å·²è¤‡è£½"); }
    catch{ prompt("è«‹æ‰‹å‹•è¤‡è£½ï¼š", ioText.value); }
  });

  ioApply.addEventListener("click", ()=>{
    const raw = ioText.value.trim();
    if(!raw) return toastShow("è«‹è²¼ä¸Š JSON");
    try{
      const obj = JSON.parse(raw);
      if(obj.gw){
        const v = normalizeGW(obj.gw);
        if(v){
          GW = v;
          localStorage.setItem(K_GW, GW);
          gwInput.value = GW;
          syncGWUI();
        }
      }
      if(Array.isArray(obj.tools)){
        TOOLS = obj.tools.map(t=>({
          id: t.id || uid(),
          name: String(t.name||"æœªå‘½åå·¥å…·"),
          cat: String(t.cat||""),
          url: String(t.url||""),
          icon: String(t.icon||"ğŸ§©"),
          desc: String(t.desc||""),
          pinned: !!t.pinned,
          newTab: !!t.newTab,
          createdAt: Number(t.createdAt || Date.now())
        }));
        saveTools();
        rebuildCategoryOptions();
        render();
        closeIO();
        toastShow("åŒ¯å…¥æˆåŠŸ");
      } else {
        toastShow("tools æ ¼å¼ä¸å°ï¼ˆéœ€è¦é™£åˆ—ï¼‰");
      }
    }catch{
      toastShow("JSON è§£æå¤±æ•—");
    }
  });

  // shortcuts
  window.addEventListener("keydown", (e)=>{
    if(e.key === "/" && document.activeElement !== q){
      e.preventDefault(); q.focus();
    }
    if(e.key === "Escape"){
      helpModal.classList.add("hidden");
      closeEditor();
      closeIO();
    }
  });

  // ===== functions =====
  function syncGWUI(){
    gwBadge.textContent = GW;
  }

  function render(){
    const list = getFilteredSortedTools();
    countEl.textContent = String(list.length);
    empty.classList.toggle("hidden", list.length !== 0);

    grid.innerHTML = list.map(t => `
      <div class="card rounded-3xl p-5 min-w-0" data-id="${escapeHTML(t.id)}">
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-start gap-3 min-w-0">
            <div class="h-12 w-12 rounded-2xl flex items-center justify-center shrink-0"
                 style="background:linear-gradient(135deg, rgba(59,130,246,.14), rgba(16,185,129,.12)); border:1px solid var(--bd);">
              <span class="text-2xl">${escapeHTML(t.icon||"ğŸ§©")}</span>
            </div>
            <div class="min-w-0">
              <div class="text-lg font-extrabold leading-tight truncate">${escapeHTML(t.name||"æœªå‘½åå·¥å…·")}</div>
              <div class="text-sm mt-1 line-clamp-2" style="color:var(--muted)">${escapeHTML(t.desc||"â€”")}</div>
              <div class="mt-2 text-xs pill inline-flex px-3 py-1 rounded-2xl">${escapeHTML(t.cat||"æœªåˆ†é¡")}</div>
            </div>
          </div>

          <div class="flex flex-col gap-2 shrink-0">
            <button class="btn text-xs px-3 py-2 rounded-2xl" data-open>é–‹å•Ÿ</button>
            <button class="btn text-xs px-3 py-2 rounded-2xl" data-edit>ç·¨è¼¯</button>
          </div>
        </div>

        <div class="mt-4 text-xs" style="color:var(--muted2)">
          ç›®æ¨™ï¼š<span class="font-mono break-all">${escapeHTML(withGw(resolveToolUrl(t.url)))}</span>
        </div>

        <div class="mt-3 flex items-center justify-between gap-2">
          <div class="flex flex-wrap items-center gap-2">
            <button class="btn text-xs px-3 py-2 rounded-2xl" data-pin>${t.pinned ? "å–æ¶ˆç½®é ‚" : "ç½®é ‚"}</button>
            <button class="btn text-xs px-3 py-2 rounded-2xl" data-up>ä¸Šç§»</button>
            <button class="btn text-xs px-3 py-2 rounded-2xl" data-down>ä¸‹ç§»</button>
          </div>
          <div class="text-xs shrink-0" style="color:var(--muted)">${t.newTab ? "æ–°åˆ†é " : "åŒåˆ†é "}</div>
        </div>
      </div>
    `).join("");

    grid.querySelectorAll(".card[data-id]").forEach(card=>{
      const id = card.getAttribute("data-id");
      card.querySelector("[data-open]").addEventListener("click", ()=> openTool(findById(id)));
      card.querySelector("[data-edit]").addEventListener("click", ()=> openEditor(findById(id)));
      card.querySelector("[data-pin]").addEventListener("click", ()=> togglePin(id));
      card.querySelector("[data-up]").addEventListener("click", ()=> move(id, -1));
      card.querySelector("[data-down]").addEventListener("click", ()=> move(id, +1));
    });
  }

  function getFilteredSortedTools(){
    const query = (q.value||"").toLowerCase().trim();
    const catv = (cat.value||"").trim();
    let list = TOOLS.slice();

    if(query){
      list = list.filter(t => ([t.name,t.cat,t.desc,t.icon,t.url].join(" ").toLowerCase().includes(query)));
    }
    if(catv){
      list = list.filter(t => (t.cat||"") === catv);
    }

    const mode = sort.value;
    if(mode==="pin"){
      list.sort((a,b)=>{
        if(!!b.pinned !== !!a.pinned) return (b.pinned?1:0)-(a.pinned?1:0);
        return TOOLS.indexOf(a) - TOOLS.indexOf(b);
      });
    }else if(mode==="name"){
      list.sort((a,b)=>(a.name||"").localeCompare(b.name||"", "zh-Hant"));
    }else if(mode==="new"){
      list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    }
    return list;
  }

  function rebuildCategoryOptions(){
    const cats = Array.from(new Set(TOOLS.map(t=>t.cat).filter(Boolean)));
    const current = cat.value;
    cat.innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>` + cats.map(c=>`<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join("");
    if(cats.includes(current)) cat.value = current;
  }

  function openTool(t){
    if(!t) return;
    localStorage.setItem(K_GW, GW);
    const dest = withGw(resolveToolUrl(t.url));
    if(t.newTab) window.open(dest, "_blank");
    else location.href = dest;
  }

  function openEditor(t){
    editingId = t ? t.id : null;
    editTitle.textContent = t ? "ç·¨è¼¯å·¥å…·" : "æ–°å¢å·¥å…·";
    btnDelete.style.display = t ? "" : "none";
    editFoot.textContent = t ? `IDï¼š${t.id}` : "æ–°å¢å¾Œæœƒè‡ªå‹•ç”¢ç”Ÿ ID";

    fName.value = t?.name || "";
    fCat.value  = t?.cat || "";
    fUrl.value  = t?.url || "";
    fIcon.value = t?.icon || "";
    fDesc.value = t?.desc || "";
    fPinned.checked = !!t?.pinned;
    fNewTab.checked = !!t?.newTab;

    updatePreview();
    editModal.classList.remove("hidden");
    setTimeout(()=>fName.focus(), 0);
  }

  function closeEditor(){
    editModal.classList.add("hidden");
    editingId = null;
  }

  function updatePreview(){
    const resolved = resolveToolUrl(fUrl.value);
    previewUrl.textContent = resolved ? withGw(resolved) : "â€”";
  }

  function togglePin(id){
    TOOLS = TOOLS.map(t=>t.id===id ? ({...t, pinned: !t.pinned}) : t);
    saveTools(); render();
  }

  function move(id, delta){
    const idx = TOOLS.findIndex(t=>t.id===id);
    if(idx<0) return;
    const next = idx + delta;
    if(next<0 || next>=TOOLS.length) return;
    const arr = TOOLS.slice();
    const [item] = arr.splice(idx,1);
    arr.splice(next,0,item);
    TOOLS = arr;
    saveTools(); render();
  }

  function openIO(title){
    ioTitle.textContent = title;
    ioModal.classList.remove("hidden");
    setTimeout(()=>ioText.focus(), 0);
  }
  function closeIO(){ ioModal.classList.add("hidden"); }

  function saveTools(){ localStorage.setItem(K_TOOLS, JSON.stringify(TOOLS)); }

  function loadTools(){
    try{
      const raw = localStorage.getItem(K_TOOLS);
      if(raw){
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) return arr;
      }
    }catch{}
    localStorage.setItem(K_TOOLS, JSON.stringify(DEFAULT_TOOLS));
    return DEFAULT_TOOLS.slice();
  }

  function loadGW(){
    const v = normalizeGW(localStorage.getItem(K_GW)) || DEFAULT_GW;
    localStorage.setItem(K_GW, v);
    return v;
  }

  function normalizeGW(v){
    const s = String(v||"").trim();
    if(!s) return "";
    if(!/^https?:\/\//i.test(s)){
      return ("https://" + s.replace(/^\/+/,"")).replace(/\/+$/,"");
    }
    return s.replace(/\/+$/,"");
  }

  function resolveToolUrl(input){
    const u = String(input||"").trim();
    if(!u) return "";
    if(/^https?:\/\//i.test(u)) return u;
    if(/^\/\//.test(u)) return "https:" + u;

    const base = GW.replace(/\/+$/,"");
    if(u.startsWith("/")) return base + u;
    return base + "/" + u.replace(/^\/+/,"");
  }

  function withGw(url){
    if(!url) return "";
    if(/[\?&]gw=/.test(url)) return url;
    const gw = encodeURIComponent(GW);
    return url + (url.includes("?") ? "&" : "?") + "gw=" + gw;
  }

  function findById(id){ return TOOLS.find(t=>t.id===id); }

  function toastShow(msg){
    toastText.textContent = msg;
    toast.classList.remove("hidden");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toast.classList.add("hidden"), 2200);
  }

  function uid(){
    return "t_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
  }

  function escapeHTML(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
})();
</script>
</body>
</html>
