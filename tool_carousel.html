<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ»‘å‹•å¡ç‰‡ç·¨è¼¯å™¨ (å£“ç¸®ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>.area-box { position: absolute; border: 2px solid red; background: rgba(255,0,0,0.2); cursor: pointer; color:white; font-weight:bold; display:flex; justify-content:center; align-items:center; }</style>
</head>
<body class="bg-slate-100 flex flex-col h-screen text-slate-800">
    <div class="bg-white shadow p-4 z-10 flex justify-between items-center">
        <h1 class="font-bold text-xl text-amber-600 flex items-center gap-2">
            <a href="index.html" class="text-2xl hover:bg-slate-50 rounded px-1">ğŸ”™</a> æ»‘å‹•å¡ç‰‡ç·¨è¼¯å™¨
        </h1>
        <div class="flex gap-2 text-sm">
            <input id="workerUrl" placeholder="Workerç¶²å€" class="border px-2 rounded w-48 bg-yellow-50">
            <input id="keyword" placeholder="è¨­å®šæ­¤å¡ç‰‡çš„é—œéµå­—" class="border px-2 rounded font-bold w-40 border-amber-500">
            <button onclick="load()" class="bg-gray-500 text-white px-3 rounded hover:bg-gray-600">è®€å–</button>
            <button onclick="save()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700">å„²å­˜</button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-72 bg-white border-r p-4 overflow-y-auto flex flex-col gap-2">
            <div class="bg-amber-50 p-2 rounded text-xs text-amber-800 mb-2">
                <strong>ğŸ’¡ ç©©å®šæ¨¡å¼ï¼š</strong><br>åœ–ç‰‡è‡ªå‹•å£“ç¸®ï¼Œä¸Šå‚³ä¿è­‰æˆåŠŸã€‚
            </div>
            <h3 class="font-bold mb-2">å¡ç‰‡æ¸…å–®</h3>
            <div id="cardList" class="space-y-2"></div>
            <button onclick="addCard()" class="w-full mt-2 py-2 border-dashed border-2 border-amber-400 text-amber-600 rounded hover:bg-amber-50">+ æ–°å¢å¡ç‰‡</button>
        </div>
        
        <div class="flex-1 bg-slate-200 p-8 flex justify-center overflow-auto relative items-start">
            <div id="editor" class="hidden bg-white shadow-xl rounded-lg overflow-hidden w-[320px] flex-shrink-0 self-start">
                <div class="relative group">
                    <img id="preview" class="w-full h-[220px] object-cover bg-gray-100">
                    <button onclick="uploadImg(currentIdx, this)" class="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">ğŸ“· æ›´æ›åœ–ç‰‡</button>
                    <div id="drawLayer" class="absolute inset-0 cursor-crosshair"></div>
                </div>
                <div class="p-4 bg-gray-50 text-center">
                    <p class="text-xs text-gray-500">ğŸ‘‡ åœ¨åœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†è¨­å®šé»æ“Š</p>
                </div>
            </div>
            <div id="emptyState" class="text-slate-400 mt-20 flex flex-col items-center">
                <span class="text-4xl mb-2">ğŸ‘ˆ</span><span>è«‹å¾å·¦å´æ–°å¢æˆ–é¸æ“‡å¡ç‰‡</span>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" hidden>

    <script>
        let cards = []; let currentIdx = -1; let isDrawing=false, startX, startY;

        window.onload = function() {
            const savedUrl = localStorage.getItem('line_worker_url');
            if(savedUrl) document.getElementById('workerUrl').value = savedUrl;
        }

        function addCard() { cards.push({url:'', areas:[]}); renderList(); selectCard(cards.length-1); }
        
        function renderList() {
            const c=document.getElementById('cardList'); c.innerHTML='';
            cards.forEach((card,i)=>{
                c.innerHTML += `
                <div class="p-3 border rounded transition ${i===currentIdx?'bg-amber-50 border-amber-500 shadow-sm':'hover:bg-gray-50'}">
                    <div class="flex justify-between items-center mb-2" onclick="selectCard(${i})">
                        <span class="font-bold text-sm cursor-pointer">å¡ç‰‡ ${i+1}</span>
                        <button onclick="cards.splice(${i},1);renderList();selectCard(-1);" class="text-red-400 font-bold px-1">âœ•</button>
                    </div>
                    ${card.url ? `<img src="${card.url}" class="w-full h-16 object-cover rounded mb-2 border">` : '<div class="w-full h-16 bg-gray-100 text-xs flex items-center justify-center text-gray-400 mb-2">ç„¡åœ–ç‰‡</div>'}
                    <button onclick="uploadImg(${i}, this)" class="w-full bg-amber-500 text-white text-xs py-1 rounded hover:bg-amber-600">ä¸Šå‚³åœ–ç‰‡</button>
                </div>`;
            });
        }

        function selectCard(i) {
            currentIdx = i;
            const div = document.getElementById('editor'); const img = document.getElementById('preview'); const empty = document.getElementById('emptyState');
            if(i===-1 || !cards[i]) { div.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            div.classList.remove('hidden'); empty.classList.add('hidden');
            img.src = cards[i].url || 'https://via.placeholder.com/320x220?text=Click+Upload';
            renderAreas();
        }

        // â˜…â˜…â˜… æ ¸å¿ƒï¼šå£“ç¸®èˆ‡ä¸Šå‚³ â˜…â˜…â˜…
        function uploadImg(idx, btn) {
            const url = document.getElementById('workerUrl').value;
            if(!url) return alert('è«‹å…ˆè¼¸å…¥ Worker ç¶²å€');

            document.getElementById('fileInput').onchange = async(e)=>{
                const file=e.target.files[0]; if(!file) return;
                const oldText = btn ? btn.innerText : 'Upload';
                if(btn) btn.innerText = "â³...";

                try {
                    // 1. å£“ç¸®
                    const compressed = await compressImage(file);
                    
                    // 2. ä¸Šå‚³ Base64 JSON
                    const res = await fetch(url+'/upload', {
                        method:'POST',
                        headers: {'Content-Type': 'application/json'},
                        body:JSON.stringify({password:'1234', image: compressed})
                    });
                    
                    if(res.ok) {
                        const json=await res.json();
                        cards[idx].url = json.url;
                        renderList(); selectCard(idx);
                    } else alert('ä¸Šå‚³å¤±æ•—');
                } catch(e) { console.error(e); alert('ä¸Šå‚³éŒ¯èª¤'); }
                if(btn) btn.innerText = oldText;
            };
            document.getElementById('fileInput').click();
        }

        // å£“ç¸®å‡½å¼
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // LINE Flex Image å»ºè­°å¯¬åº¦
                        const MAX_WIDTH = 1040;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        const layer = document.getElementById('drawLayer');
        layer.onmousedown = e => { isDrawing=true; const r=layer.getBoundingClientRect(); startX=e.clientX-r.left; startY=e.clientY-r.top; }
        layer.onmouseup = e => {
            if(!isDrawing) return; isDrawing=false;
            const r=layer.getBoundingClientRect();
            const w=Math.abs(e.clientX-r.left-startX); const h=Math.abs(e.clientY-r.top-startY);
            if(w>10&&h>10) {
                const type = prompt("é¡å‹? (text=æ–‡å­—, link=ç¶²é )", "text");
                const txt = prompt("å…§å®¹? (é—œéµå­— æˆ– ç¶²å€)");
                if(txt) {
                    cards[currentIdx].areas.push({
                        x: Math.min(startX, e.clientX-r.left)/r.width,
                        y: Math.min(startY, e.clientY-r.top)/r.height,
                        w: w/r.width, h: h/r.height,
                        text: txt, type: type==='link'?'uri':'message'
                    });
                    renderAreas();
                }
            }
        }
        function renderAreas() {
            layer.innerHTML=''; if(currentIdx===-1) return;
            cards[currentIdx].areas.forEach((a,i)=>{
                const d=document.createElement('div'); d.className='area-box';
                d.style.left=(a.x*100)+'%'; d.style.top=(a.y*100)+'%'; d.style.width=(a.w*100)+'%'; d.style.height=(a.h*100)+'%';
                d.innerText=i+1;
                d.onclick=e=>{e.stopPropagation(); if(confirm('åˆªé™¤?')) { cards[currentIdx].areas.splice(i,1); renderAreas(); } }
                layer.appendChild(d);
            });
        }

        async function save() {
            const url = document.getElementById('workerUrl').value; const key = document.getElementById('keyword').value;
            if(!url || !key) return alert('è³‡æ–™ä¸å…¨');
            const bubbles = cards.map(c => ({
                type: "bubble", body: { type: "box", layout: "overlap", paddingAll: "0px", contents: [{ type: "image", url: c.url, size: "full", aspectMode: "cover" }, ...c.areas.map(a => ({ type: "box", layout: "vertical", position: "absolute", offsetStart: (a.x*100)+'%', offsetTop: (a.y*100)+'%', width: (a.w*100)+'%', height: (a.h*100)+'%', action: { type: a.type, label: 'action', text: a.type==='message'?a.text:undefined, uri: a.type==='uri'?a.text:undefined } }))] }
            }));
            const payload = { mode: 'carousel', messages: [{ type: "flex", altText: "å¡ç‰‡é¸å–®", contents: { type: "carousel", contents: bubbles } }] };
            try {
                const res = await fetch(url+'/save', { method:'POST', body:JSON.stringify({password:'1234', keyword:key, payload}) });
                if(res.ok) alert('å„²å­˜æˆåŠŸ'); else alert('å¤±æ•—');
            } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
        }

        async function load() {
            const url = document.getElementById('workerUrl').value; const key = document.getElementById('keyword').value;
            try {
                const res = await fetch(url+'/load', { method:'POST', body:JSON.stringify({password:'1234', keyword:key}) });
                if(res.ok) {
                    const data = await res.json();
                    if(data.messages && data.messages[0].contents.type === 'carousel') {
                        cards = data.messages[0].contents.contents.map(b => ({ url: b.body.contents[0].url, areas: [] }));
                        alert('è®€å–æˆåŠŸ');
                    }
                    renderList(); selectCard(0);
                } else alert('ç„¡è³‡æ–™');
            } catch(e) { alert('éŒ¯èª¤'); }
        }
    </script>
</body>
</html>
