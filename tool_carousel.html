<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>滑動卡片編輯器 (R2版)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.area-box{
  position:absolute;
  border:2px solid red;
  background:rgba(255,0,0,.25);
  color:white;
  font-weight:bold;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
}
</style>
</head>

<body class="bg-slate-100 flex flex-col h-screen">

<div class="bg-white shadow p-4 flex justify-between items-center">
  <h1 class="font-bold text-xl text-amber-600">滑動卡片編輯器 (R2)</h1>
  <div class="flex gap-2 text-sm">
    <input id="workerUrl" placeholder="https://xxxx.workers.dev"
      class="border px-2 rounded w-56 bg-yellow-50">
    <input id="keyword" placeholder="觸發關鍵字"
      class="border px-2 rounded w-40 font-bold border-amber-500">
    <button onclick="load()" class="bg-gray-500 text-white px-3 rounded">讀取</button>
    <button onclick="save()" class="bg-green-600 text-white px-3 rounded">儲存</button>
  </div>
</div>

<div class="flex flex-1 overflow-hidden">

  <div class="w-72 bg-white border-r p-4 overflow-y-auto">
    <button onclick="addCard()"
      class="w-full mb-3 py-2 border-dashed border-2 border-amber-400 text-amber-600 rounded">
      + 新增卡片
    </button>
    <div id="cardList" class="space-y-2"></div>
  </div>

  <div class="flex-1 bg-slate-200 flex justify-center items-start p-8 relative overflow-auto">
    <div id="editor" class="hidden bg-white shadow rounded w-[320px]">
      <div class="relative">
        <img id="preview" class="w-full h-[220px] object-cover bg-gray-100">
        <button onclick="uploadImg(currentIdx,this)"
          class="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded">
          上傳圖片到 R2
        </button>
        <div id="drawLayer" class="absolute inset-0 cursor-crosshair"></div>
      </div>
      <div class="p-2 text-xs text-gray-500 text-center">在圖片上拖曳設定點擊區</div>
    </div>
    <div id="emptyState" class="text-gray-400 mt-20">← 請先新增卡片</div>
  </div>

</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<script>
function normalizeWorkerUrl(raw){
  if(!raw) return '';
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
  return s.replace(/\/+$/,'');
}

async function postJSON(url,data){
  const res = await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const ct = res.headers.get('content-type')||'';
  return ct.includes('json') ? res.json() : res.text();
}

async function uploadToR2(workerBaseUrl, file){
  const form = new FormData();
  form.append('file', file);

  const res = await fetch(workerBaseUrl + '/upload', { method:'POST', body: form });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const j = await res.json();
  if(!j.ok || !j.url) throw new Error('上傳回傳格式不對');
  return j.url;
}

/* state */
let cards=[], currentIdx=-1;
let isDrawing=false,startX,startY;

window.onload=()=>{
  const u=localStorage.getItem('line_worker_url');
  if(u) document.getElementById('workerUrl').value=u;
};

function addCard(){
  cards.push({url:'',areas:[]});
  renderList();
  selectCard(cards.length-1);
}

function renderList(){
  const c=document.getElementById('cardList');
  c.innerHTML='';
  cards.forEach((card,i)=>{
    c.innerHTML+=`
    <div class="p-2 border rounded ${i===currentIdx?'bg-amber-50 border-amber-500':''}">
      <div class="flex justify-between mb-1">
        <span onclick="selectCard(${i})" class="font-bold cursor-pointer">卡片 ${i+1}</span>
        <button onclick="cards.splice(${i},1);renderList();selectCard(-1)" class="text-red-500">✕</button>
      </div>
      ${card.url
        ? `<img src="${card.url}" class="w-full h-16 object-cover rounded mb-1">`
        : `<div class="h-16 bg-gray-100 text-xs flex items-center justify-center">無圖片</div>`
      }
      <button onclick="uploadImg(${i},this)"
        class="w-full bg-amber-500 text-white text-xs py-1 rounded">
        上傳圖片到 R2
      </button>
    </div>`;
  });
}

function selectCard(i){
  currentIdx=i;
  const ed=document.getElementById('editor');
  const em=document.getElementById('emptyState');
  if(i<0||!cards[i]){
    ed.classList.add('hidden');
    em.classList.remove('hidden');
    return;
  }
  ed.classList.remove('hidden');
  em.classList.add('hidden');
  document.getElementById('preview').src =
    cards[i].url || 'https://via.placeholder.com/320x220?text=Upload';
  renderAreas();
}

/* upload */
function uploadImg(idx, btn){
  const raw=document.getElementById('workerUrl').value;
  const base = normalizeWorkerUrl(raw);
  if(!base) return alert('請先填 WorkerUrl');

  localStorage.setItem('line_worker_url', base);

  const input = document.getElementById('fileInput');
  input.value = '';
  input.onchange = async (e) => {
    const f = e.target.files[0];
    if(!f) return;

    const old = btn.innerText;
    btn.innerText = '⏳ 上傳中...';
    btn.disabled = true;

    try{
      const url = await uploadToR2(base, f);
      cards[idx].url = url;
      renderList(); selectCard(idx);
    }catch(err){
      alert('上傳失敗：\n' + err.message);
    }

    btn.innerText = old;
    btn.disabled = false;
  };
  input.click();
}

/* draw */
const layer=document.getElementById('drawLayer');
layer.onmousedown=e=>{
  isDrawing=true;
  const r=layer.getBoundingClientRect();
  startX=e.clientX-r.left;
  startY=e.clientY-r.top;
};
layer.onmouseup=e=>{
  if(!isDrawing) return;
  isDrawing=false;
  const r=layer.getBoundingClientRect();
  const w=Math.abs(e.clientX-r.left-startX);
  const h=Math.abs(e.clientY-r.top-startY);
  if(w<10||h<10) return;

  const type=prompt('text 或 link','text');
  const txt=prompt('內容');
  if(!txt) return;

  cards[currentIdx].areas.push({
    x:Math.min(startX,e.clientX-r.left)/r.width,
    y:Math.min(startY,e.clientY-r.top)/r.height,
    w:w/r.width,h:h/r.height,
    type:type==='link'?'uri':'message',
    text:txt
  });
  renderAreas();
};

function renderAreas(){
  layer.innerHTML='';
  if(currentIdx<0) return;
  cards[currentIdx].areas.forEach((a,i)=>{
    const d=document.createElement('div');
    d.className='area-box';
    d.style.left=a.x*100+'%';
    d.style.top=a.y*100+'%';
    d.style.width=a.w*100+'%';
    d.style.height=a.h*100+'%';
    d.innerText=i+1;
    d.onclick=e=>{
      e.stopPropagation();
      if(confirm('刪除?')){
        cards[currentIdx].areas.splice(i,1);
        renderAreas();
      }
    };
    layer.appendChild(d);
  });
}

/* save/load */
async function save(){
  const raw=document.getElementById('workerUrl').value;
  const key=document.getElementById('keyword').value.trim();
  const base=normalizeWorkerUrl(raw);
  if(!base||!key) return alert('資料不全');
  localStorage.setItem('line_worker_url', base);

  const bubbles=cards.map(c=>({
    type:'bubble',
    body:{
      type:'box',layout:'overlap',paddingAll:'0px',
      contents:[
        {type:'image',url:c.url,size:'full',aspectMode:'cover'},
        ...c.areas.map(a=>({
          type:'box',layout:'vertical',position:'absolute',
          offsetStart:a.x*100+'%',offsetTop:a.y*100+'%',
          width:a.w*100+'%',height:a.h*100+'%',
          action:{
            type:a.type,label:'action',
            text:a.type==='message'?a.text:undefined,
            uri:a.type==='uri'?a.text:undefined
          }
        }))
      ]
    }
  }));

  try{
    await postJSON(base+'/save',{
      password:'1234',
      keyword:key,
      payload:{
        mode:'carousel',
        messages:[{type:'flex',altText:'卡片選單',
          contents:{type:'carousel',contents:bubbles}}]
      }
    });
    alert('儲存成功');
  }catch(e){
    alert('失敗：\n'+e.message);
  }
}

async function load(){
  const raw=document.getElementById('workerUrl').value;
  const key=document.getElementById('keyword').value.trim();
  const base=normalizeWorkerUrl(raw);
  if(!base||!key) return alert('資料不全');
  localStorage.setItem('line_worker_url', base);

  try{
    const data=await postJSON(base+'/load',{password:'1234',keyword:key});
    const obj=typeof data==='string'?JSON.parse(data):data;
    cards=obj.messages[0].contents.contents.map(b=>({
      url:b.body.contents[0].url, areas:[]
    }));
    renderList(); selectCard(0);
    alert('讀取成功');
  }catch(e){
    alert('失敗：\n'+e.message);
  }
}
</script>
</body>
</html>
