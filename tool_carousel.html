<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ»‘å‹•å¡ç‰‡ç·¨è¼¯å™¨ (R2 å£“ç¸®ç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .area-box{
    position:absolute;
    border:2px solid rgba(255,0,0,.9);
    background:rgba(255,0,0,.25);
    color:white;
    font-weight:800;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    user-select:none;
    text-shadow:0 1px 2px rgba(0,0,0,.9);
  }
  .draw-rect{
    position:absolute;
    border:2px dashed rgba(0,0,0,.6);
    background:rgba(0,0,0,.10);
    pointer-events:none;
  }
</style>
</head>

<body class="bg-slate-100 flex flex-col h-screen text-slate-800">
  <!-- Header -->
  <div class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="font-bold text-xl text-amber-600 flex items-center gap-2">
      <a href="index.html" class="text-2xl hover:bg-slate-50 rounded px-1">ğŸ”™</a>
      æ»‘å‹•å¡ç‰‡ç·¨è¼¯å™¨ (R2 å£“ç¸®ç‰ˆ)
    </h1>

    <div class="flex gap-2 text-sm items-center">
      <input id="workerUrl" placeholder="https://xxxx.workers.dev"
        class="border px-2 rounded w-60 bg-yellow-50">
      <input id="keyword" placeholder="è§¸ç™¼é—œéµå­—"
        class="border px-2 rounded font-bold w-44 border-amber-500">
      <button onclick="load()" class="bg-gray-500 text-white px-3 rounded hover:bg-gray-600">è®€å–</button>
      <button onclick="save()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700">å„²å­˜</button>
    </div>
  </div>

  <div class="flex flex-1 overflow-hidden">
    <!-- å·¦å´ï¼šå¡ç‰‡æ¸…å–® -->
    <div class="w-72 bg-white border-r p-4 overflow-y-auto flex flex-col gap-3">
      <div class="bg-amber-50 p-2 rounded text-xs text-amber-800">
        <strong>æ“ä½œï¼š</strong><br>
        1. æ–°å¢å¡ç‰‡ â†’ ä¸Šå‚³åœ–ç‰‡ï¼ˆæœƒè‡ªå‹•å£“ç¸®ï¼‰<br>
        2. åœ¨åœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†ï¼ˆä¸é™æ•¸é‡ï¼‰<br>
        3. å³å´æ¸…å–®å¡«å…¥ã€Œé—œéµå­—æˆ–ç¶²å€ã€
      </div>
      <button onclick="addCard()"
        class="w-full py-2 border-dashed border-2 border-amber-400 text-amber-600 rounded hover:bg-amber-50">
        + æ–°å¢å¡ç‰‡
      </button>
      <div id="cardList" class="space-y-2"></div>
    </div>

    <!-- ä¸­é–“ï¼šåœ–ç‰‡ç·¨è¼¯ -->
    <div class="flex-1 bg-slate-200 p-6 flex justify-center overflow-auto relative items-start">
      <div id="editorWrap" class="hidden w-full max-w-5xl grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4">
        <!-- å·¦ï¼šå€å¡Šè¼¸å…¥æ¸…å–® -->
        <div class="bg-white rounded-lg shadow p-4 h-fit">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold text-slate-700">æ¡†æ¡†è¨­å®š</div>
            <button onclick="clearAreas()" class="text-xs text-red-600 underline">æ¸…ç©ºæœ¬å¡å…¨éƒ¨æ¡†</button>
          </div>

          <div class="border rounded p-3 mb-3 bg-slate-50">
            <div class="font-bold text-xs text-slate-600 mb-2">åœ–ç‰‡å£“ç¸®è¨­å®šï¼ˆä¸Šå‚³æ™‚ç”Ÿæ•ˆï¼‰</div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <label class="flex flex-col gap-1">
                <span class="text-slate-500">æœ€å¤§å¯¬</span>
                <select id="maxWidth" class="border rounded px-2 py-1">
                  <option value="960">960</option>
                  <option value="1280" selected>1280</option>
                  <option value="1600">1600</option>
                  <option value="2048">2048</option>
                </select>
              </label>
              <label class="flex flex-col gap-1">
                <span class="text-slate-500">æ ¼å¼</span>
                <select id="outFormat" class="border rounded px-2 py-1">
                  <option value="image/webp" selected>WebPï¼ˆæ¨è–¦ï¼‰</option>
                  <option value="image/jpeg">JPEG</option>
                  <option value="image/png">PNGï¼ˆä¸å»ºè­°ï¼‰</option>
                </select>
              </label>
              <label class="flex flex-col gap-1 col-span-2">
                <span class="text-slate-500">å“è³ªï¼ˆ0.5ï½0.95ï¼‰</span>
                <input id="quality" type="range" min="0.5" max="0.95" step="0.01" value="0.82">
                <div class="text-right text-[11px] text-slate-500">ç›®å‰ï¼š<span id="qVal">0.82</span></div>
              </label>
            </div>
          </div>

          <div class="text-xs text-slate-500 mb-2">
            ä½ å¯ä»¥ä¸€ç›´ç•«æ¡†ï¼›æ¯ç•«ä¸€å€‹å°±æœƒæ–°å¢ä¸€æ¢è¨­å®šã€‚
          </div>

          <div id="areaList" class="space-y-2"></div>
        </div>

        <!-- å³ï¼šåœ–ç‰‡ç•«æ¡†å€ -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <div class="relative group">
            <img id="preview" class="w-full h-[520px] object-cover bg-gray-100">
            <button onclick="uploadImg(currentIdx, this)"
              class="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded">
              ğŸ“· ä¸Šå‚³åœ–ç‰‡åˆ° R2ï¼ˆå£“ç¸®ï¼‰
            </button>
            <div id="drawLayer" class="absolute inset-0 cursor-crosshair"></div>
          </div>
          <div class="p-3 bg-gray-50 text-center text-xs text-gray-600">
            åœ¨åœ–ç‰‡ä¸Šã€ŒæŒ‰ä½æ‹–æ›³ã€ç•«æ¡†ã€‚é»ç´…æ¡†å¯åˆªé™¤ã€‚
          </div>
        </div>
      </div>

      <div id="emptyState" class="text-slate-400 mt-20 flex flex-col items-center">
        <span class="text-4xl mb-2">ğŸ‘ˆ</span>
        <span>è«‹å¾å·¦å´æ–°å¢æˆ–é¸æ“‡å¡ç‰‡</span>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" hidden>

<script>
/* ---------- å…±ç”¨å·¥å…· ---------- */
function normalizeWorkerUrl(raw){
  if(!raw) return '';
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
  return s.replace(/\/+$/,'');
}
async function postJSON(url,data){
  const res = await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const ct = res.headers.get('content-type')||'';
  return ct.includes('json') ? res.json() : res.text();
}
async function uploadToR2(workerBaseUrl, fileBlob, filename){
  const form = new FormData();
  form.append('file', fileBlob, filename || 'image.webp');
  const res = await fetch(workerBaseUrl + '/upload', { method:'POST', body: form });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const j = await res.json();
  if(!j.ok || !j.url) throw new Error('ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°');
  return j.url;
}

/* ---------- å£“ç¸® ---------- */
async function compressImage(file, {maxWidth, mime, quality}){
  // PNG ä¹Ÿå¯è¼¸å‡ºï¼Œä½†é€šå¸¸ä¸æœƒè®Šå°ï¼›é è¨­ç”¨ webp/jpg
  const img = await createImageBitmap(file);
  const scale = Math.min(1, maxWidth / img.width);
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d', { alpha: true });
  ctx.drawImage(img, 0, 0, w, h);

  const outBlob = await new Promise((resolve) => {
    if (mime === 'image/png') {
      canvas.toBlob(resolve, mime); // png ä¸åƒ quality
    } else {
      canvas.toBlob(resolve, mime, quality);
    }
  });

  if(!outBlob) throw new Error('å£“ç¸®å¤±æ•—ï¼ˆtoBlob å›å‚³ç©ºï¼‰');

  const ext = (mime === 'image/webp') ? 'webp' : (mime === 'image/jpeg') ? 'jpg' : 'png';
  const safeName = (file.name || 'image').replace(/\.[^/.]+$/, '');
  return { blob: outBlob, filename: `${safeName}.${ext}`, w, h };
}

/* ---------- ç‹€æ…‹ ---------- */
let cards = []; // {url:'', areas:[{x,y,w,h,type,text}]}
let currentIdx = -1;

window.onload = () => {
  const savedUrl = localStorage.getItem('line_worker_url');
  if(savedUrl) document.getElementById('workerUrl').value = savedUrl;

  const q = document.getElementById('quality');
  const qVal = document.getElementById('qVal');
  q.addEventListener('input', () => qVal.textContent = q.value);
};

/* ---------- å¡ç‰‡ ---------- */
function addCard(){
  cards.push({ url:'', areas:[] });
  renderList();
  selectCard(cards.length - 1);
}
function renderList(){
  const c = document.getElementById('cardList');
  c.innerHTML = '';
  cards.forEach((card, i) => {
    const selected = i === currentIdx;
    c.innerHTML += `
      <div class="p-3 border rounded transition ${selected?'bg-amber-50 border-amber-500 shadow-sm':'hover:bg-gray-50'}">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold text-sm cursor-pointer" onclick="selectCard(${i})">å¡ç‰‡ ${i+1}</span>
          <button class="text-red-500 font-bold px-1"
            onclick="event.stopPropagation();cards.splice(${i},1);renderList();selectCard(${Math.max(-1, i-1)});">âœ•</button>
        </div>
        ${card.url
          ? `<img src="${card.url}" class="w-full h-16 object-cover rounded mb-2 border">`
          : `<div class="w-full h-16 bg-gray-100 text-xs flex items-center justify-center text-gray-400 mb-2">ç„¡åœ–ç‰‡</div>`
        }
        <button onclick="uploadImg(${i}, this)" class="w-full bg-amber-500 text-white text-xs py-1 rounded hover:bg-amber-600">
          ä¸Šå‚³åœ–ç‰‡åˆ° R2ï¼ˆå£“ç¸®ï¼‰
        </button>
        <div class="mt-1 text-[10px] text-gray-500 text-right">ç†±å€: ${card.areas.length}</div>
      </div>
    `;
  });
}
function selectCard(i){
  currentIdx = i;

  const wrap = document.getElementById('editorWrap');
  const empty = document.getElementById('emptyState');
  if(i === -1 || !cards[i]){
    wrap.classList.add('hidden');
    empty.classList.remove('hidden');
    return;
  }
  wrap.classList.remove('hidden');
  empty.classList.add('hidden');

  document.getElementById('preview').src = cards[i].url || 'https://via.placeholder.com/1200x800?text=Upload';
  renderAreas();
  renderAreaList();
}
function clearAreas(){
  if(currentIdx < 0) return;
  if(confirm('ç¢ºå®šæ¸…ç©ºæœ¬å¡å…¨éƒ¨æ¡†ï¼Ÿ')){
    cards[currentIdx].areas = [];
    renderAreas();
    renderAreaList();
    renderList();
  }
}

/* ---------- ä¸Šå‚³ï¼ˆå£“ç¸®å¾Œé€ Workerâ†’R2ï¼‰ ---------- */
function uploadImg(idx, btn){
  const raw = document.getElementById('workerUrl').value;
  const base = normalizeWorkerUrl(raw);
  if(!base) return alert('è«‹å…ˆå¡« WorkerUrlï¼ˆhttps://xxx.workers.devï¼‰');
  localStorage.setItem('line_worker_url', base);

  const input = document.getElementById('fileInput');
  input.value = '';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    const oldText = btn.innerText;
    btn.innerText = 'â³ å£“ç¸®+ä¸Šå‚³ä¸­...';
    btn.disabled = true;

    try{
      const maxWidth = parseInt(document.getElementById('maxWidth').value, 10);
      const mime = document.getElementById('outFormat').value;
      const quality = parseFloat(document.getElementById('quality').value);

      const { blob, filename } = await compressImage(file, { maxWidth, mime, quality });
      const url = await uploadToR2(base, blob, filename);

      cards[idx].url = url;
      cards[idx].areas = []; // æ›åœ–å¾Œæ¸…ç©ºç†±å€ï¼ˆé¿å…å°ä¸ä¸Šï¼‰
      renderList();
      selectCard(idx);
    }catch(err){
      alert('ä¸Šå‚³å¤±æ•—ï¼š\n' + err.message);
    }

    btn.innerText = oldText;
    btn.disabled = false;
  };
  input.click();
}

/* ---------- ç•«æ¡†ï¼ˆæ¯”ä¾‹ï¼‰ + é è¦½æ¡† ---------- */
const layer = document.getElementById('drawLayer');
let isDrawing = false;
let sx = 0, sy = 0;
let previewRect = null;

layer.addEventListener('mousedown', (e) => {
  if(currentIdx < 0) return;
  const r = layer.getBoundingClientRect();
  isDrawing = true;
  sx = e.clientX - r.left;
  sy = e.clientY - r.top;

  previewRect = document.createElement('div');
  previewRect.className = 'draw-rect';
  previewRect.style.left = sx + 'px';
  previewRect.style.top = sy + 'px';
  previewRect.style.width = '0px';
  previewRect.style.height = '0px';
  layer.appendChild(previewRect);
});

layer.addEventListener('mousemove', (e) => {
  if(!isDrawing || !previewRect) return;
  const r = layer.getBoundingClientRect();
  const cx = e.clientX - r.left;
  const cy = e.clientY - r.top;

  const x = Math.min(sx, cx);
  const y = Math.min(sy, cy);
  const w = Math.abs(cx - sx);
  const h = Math.abs(cy - sy);

  previewRect.style.left = x + 'px';
  previewRect.style.top = y + 'px';
  previewRect.style.width = w + 'px';
  previewRect.style.height = h + 'px';
});

layer.addEventListener('mouseup', (e) => {
  if(!isDrawing) return;
  isDrawing = false;

  const r = layer.getBoundingClientRect();
  const ex = e.clientX - r.left;
  const ey = e.clientY - r.top;

  const x = Math.min(sx, ex);
  const y = Math.min(sy, ey);
  const w = Math.abs(ex - sx);
  const h = Math.abs(ey - sy);

  if(previewRect){
    previewRect.remove();
    previewRect = null;
  }

  if(w < 12 || h < 12) return;
  if(!cards[currentIdx].url) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼ˆR2ï¼‰å†ç•«æ¡†');

  // å­˜æ¯”ä¾‹åº§æ¨™ï¼ˆ0~1ï¼‰
  const area = {
    x: x / r.width,
    y: y / r.height,
    w: w / r.width,
    h: h / r.height,
    type: 'message',
    text: ''
  };

  cards[currentIdx].areas.push(area);
  renderAreas();
  renderAreaList();
  renderList();
});

function renderAreas(){
  layer.querySelectorAll('.area-box').forEach(el => el.remove());
  if(currentIdx < 0) return;

  const areas = cards[currentIdx].areas;
  areas.forEach((a, i) => {
    const d = document.createElement('div');
    d.className = 'area-box';
    d.style.left = (a.x * 100) + '%';
    d.style.top = (a.y * 100) + '%';
    d.style.width = (a.w * 100) + '%';
    d.style.height = (a.h * 100) + '%';
    d.innerText = i + 1;
    d.onclick = (e) => {
      e.stopPropagation();
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        cards[currentIdx].areas.splice(i, 1);
        renderAreas();
        renderAreaList();
        renderList();
      }
    };
    layer.appendChild(d);
  });
}

/* ---------- å³å´æ¸…å–®ï¼šè¼¸å…¥ keyword/url ---------- */
function renderAreaList(){
  const box = document.getElementById('areaList');
  box.innerHTML = '';
  if(currentIdx < 0) return;

  const areas = cards[currentIdx].areas;

  if(areas.length === 0){
    box.innerHTML = `<div class="text-xs text-slate-400">ç›®å‰æ²’æœ‰æ¡†ï¼Œå»åœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†ã€‚</div>`;
    return;
  }

  areas.forEach((a, i) => {
    const typeLabel = a.type === 'uri' ? 'é–‹ç¶²é ' : 'ç™¼æ–‡å­—';
    const placeholder = a.type === 'uri' ? 'è²¼ç¶²å€ https://...' : 'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰';

    const row = document.createElement('div');
    row.className = 'border rounded p-2 bg-white';
    row.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-sm">æ¡† ${i+1}</div>
        <button class="text-xs text-red-600 underline">åˆªé™¤</button>
      </div>

      <div class="grid grid-cols-3 gap-2 text-xs">
        <label class="col-span-1 flex flex-col gap-1">
          <span class="text-slate-500">å‹•ä½œ</span>
          <select class="border rounded px-2 py-1">
            <option value="message" ${a.type==='message'?'selected':''}>ç™¼æ–‡å­—</option>
            <option value="uri" ${a.type==='uri'?'selected':''}>é–‹ç¶²é </option>
          </select>
        </label>

        <label class="col-span-2 flex flex-col gap-1">
          <span class="text-slate-500">å…§å®¹</span>
          <input class="border rounded px-2 py-1" value="${escapeHtml(a.text||'')}" placeholder="${placeholder}">
        </label>
      </div>

      <div class="text-[11px] text-slate-400 mt-2">ç›®å‰ï¼š${typeLabel}</div>
    `;

    const delBtn = row.querySelector('button');
    const sel = row.querySelector('select');
    const input = row.querySelector('input');

    delBtn.onclick = () => {
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        cards[currentIdx].areas.splice(i, 1);
        renderAreas(); renderAreaList(); renderList();
      }
    };

    sel.onchange = () => {
      a.type = sel.value;
      input.placeholder = a.type === 'uri' ? 'è²¼ç¶²å€ https://...' : 'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰';
      renderAreaList(); // è®“ä¸‹é¢æ–‡å­—æ›´æ–°
    };

    input.oninput = () => {
      a.text = input.value;
    };

    box.appendChild(row);
  });
}

function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* ---------- save/load ---------- */
async function save(){
  const raw = document.getElementById('workerUrl').value;
  const key = document.getElementById('keyword').value.trim();
  const base = normalizeWorkerUrl(raw);

  if(!base || !key) return alert('è³‡æ–™ä¸å…¨ï¼ˆWorkerUrl / é—œéµå­—ï¼‰');
  localStorage.setItem('line_worker_url', base);

  // é©—è­‰ï¼šæ¯å¼µå¡éƒ½è¦æœ‰åœ–
  if(cards.length === 0) return alert('è‡³å°‘æ–°å¢ä¸€å¼µå¡ç‰‡');
  if(cards.some(c => !c.url)) return alert('æœ‰å¡ç‰‡æ²’æœ‰åœ–ç‰‡ï¼Œè«‹å…ˆä¸Šå‚³');
  // é©—è­‰ï¼šæ¯å€‹æ¡†è¦æœ‰å…§å®¹
  const bad = cards.some(c => c.areas.some(a => !String(a.text||'').trim()));
  if(bad) return alert('æœ‰æ¡†æ²’æœ‰å¡«å…§å®¹ï¼ˆé—œéµå­—æˆ–ç¶²å€ï¼‰');

  const bubbles = cards.map(c => ({
    type: "bubble",
    body: {
      type: "box",
      layout: "overlap",
      paddingAll: "0px",
      contents: [
        { type: "image", url: c.url, size: "full", aspectMode: "cover" },
        ...c.areas.map(a => ({
          type: "box",
          layout: "vertical",
          position: "absolute",
          offsetStart: (a.x * 100) + '%',
          offsetTop: (a.y * 100) + '%',
          width: (a.w * 100) + '%',
          height: (a.h * 100) + '%',
          action: {
            type: a.type,
            label: "action",
            text: a.type === "message" ? a.text : undefined,
            uri: a.type === "uri" ? a.text : undefined
          }
        }))
      ]
    }
  }));

  const payload = {
    mode: 'carousel',
    messages: [{
      type: "flex",
      altText: "å¡ç‰‡é¸å–®",
      contents: { type: "carousel", contents: bubbles }
    }]
  };

  try{
    await postJSON(base + '/save', { password:'1234', keyword:key, payload });
    alert('å„²å­˜æˆåŠŸï¼');
  }catch(e){
    alert('å„²å­˜å¤±æ•—ï¼š\n' + e.message);
  }
}

async function load(){
  const raw = document.getElementById('workerUrl').value;
  const key = document.getElementById('keyword').value.trim();
  const base = normalizeWorkerUrl(raw);

  if(!base || !key) return alert('è³‡æ–™ä¸å…¨ï¼ˆWorkerUrl / é—œéµå­—ï¼‰');
  localStorage.setItem('line_worker_url', base);

  try{
    const data = await postJSON(base + '/load', { password:'1234', keyword:key });
    const obj = (typeof data === 'string') ? JSON.parse(data) : data;

    if(obj?.messages?.[0]?.contents?.type !== 'carousel'){
      return alert('è®€åˆ°è³‡æ–™ä½†ä¸æ˜¯ carousel æ ¼å¼');
    }

    // æ³¨æ„ï¼šå¾ LINE Flex çš„ overlay action è®€å›ä¾†æ™‚ï¼Œæˆ‘å€‘èƒ½å–åˆ° uri/text
    cards = obj.messages[0].contents.contents.map(b => {
      const imgUrl = b.body.contents?.[0]?.url || '';
      const overlays = (b.body.contents || []).slice(1);

      const areas = overlays.map(o => {
        const action = o.action || {};
        const type = action.type || 'message';
        const text = (type === 'message') ? (action.text || '') : (action.uri || '');
        const x = parseFloat(String(o.offsetStart||'0').replace('%',''))/100;
        const y = parseFloat(String(o.offsetTop||'0').replace('%',''))/100;
        const w = parseFloat(String(o.width||'0').replace('%',''))/100;
        const h = parseFloat(String(o.height||'0').replace('%',''))/100;

        return { x,y,w,h,type, text };
      });

      return { url: imgUrl, areas };
    });

    renderList();
    selectCard(cards.length ? 0 : -1);
    alert('è®€å–æˆåŠŸï¼');
  }catch(e){
    alert('è®€å–å¤±æ•—ï¼š\n' + e.message);
  }
}
</script>
</body>
</html>
