<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å…­å®®æ ¼é¸å–®</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --rail-w:92px; --panel-w:360px; --preview-w:380px; }
    body{ user-select:none; }
    input, textarea, select, button { user-select:auto; }

    .checker{
      background-image:
        linear-gradient(45deg, rgba(0,0,0,.035) 25%, transparent 25%),
        linear-gradient(-45deg, rgba(0,0,0,.035) 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, rgba(0,0,0,.035) 75%),
        linear-gradient(-45deg, transparent 75%, rgba(0,0,0,.035) 75%);
      background-size: 28px 28px;
      background-position: 0 0, 0 14px, 14px -14px, -14px 0px;
    }

    .artboard{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%, -50%);
      background:#fff;
      border:1px solid rgba(15,23,42,.20);
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      border-radius: 14px;
      overflow:hidden;
      touch-action:none;
    }

    .img-layer{ position:absolute; inset:0; overflow:hidden; background:#f8fafc; }
    .img-layer img{
      width:100%; height:100%;
      object-fit:cover;
      user-select:none;
      pointer-events:none;
    }

    .hotspot{
      position:absolute;
      border:2px solid rgba(239,68,68,.95);
      box-shadow: 0 0 0 2px rgba(255,255,255,.95), 0 6px 18px rgba(0,0,0,.18);
      background: rgba(239,68,68,.14);
      border-radius: 12px;
      color:white;
      font-weight:900;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-shadow:0 1px 2px rgba(0,0,0,.85);
      cursor:pointer;
      touch-action:none;
    }
    .hotspot.selected{
      border-color: rgba(59,130,246,.95);
      background: rgba(59,130,246,.12);
      box-shadow: 0 0 0 2px rgba(255,255,255,.95), 0 0 0 4px rgba(59,130,246,.95), 0 6px 18px rgba(0,0,0,.18);
    }
    .hotspot.multiSelected:not(.selected){
      border-color: rgba(234,179,8,.95);
      background: rgba(234,179,8,.10);
      box-shadow: 0 0 0 2px rgba(255,255,255,.95), 0 0 0 4px rgba(234,179,8,.95), 0 6px 18px rgba(0,0,0,.18);
    }

    .handle{
      position:absolute;
      width:10px; height:10px;
      background:#fff;
      border:2px solid rgba(59,130,246,.95);
      border-radius: 4px;
      box-shadow:0 1px 3px rgba(0,0,0,.25);
      z-index: 10;
      touch-action:none;
    }
    .handle.nw{ left:-6px; top:-6px; cursor:nwse-resize; }
    .handle.ne{ right:-6px; top:-6px; cursor:nesw-resize; }
    .handle.sw{ left:-6px; bottom:-6px; cursor:nesw-resize; }
    .handle.se{ right:-6px; bottom:-6px; cursor:nwse-resize; }

    .draw-rect{
      position:absolute;
      border:2px solid rgba(255,255,255,1);
      box-shadow: 0 0 0 2px rgba(0,0,0,.85);
      background: rgba(0,0,0,.10);
      border-radius: 12px;
      pointer-events:none;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border:1px solid rgba(0,0,0,.18);
      padding:2px 6px;
      border-radius:6px;
      background:#fff;
      font-size: 11px;
    }

    .phone{ border-radius:34px; background:#0b1220; padding:10px; box-shadow:0 22px 50px rgba(0,0,0,.25); }
    .phone-inner{ border-radius:26px; overflow:hidden; background:#e7eefb; border:1px solid rgba(255,255,255,.12); }
    .phone-chat{ height:360px; padding:12px; position:relative; overflow:hidden; }
    .bubble{ display:inline-block; padding:10px 12px; background:#a7f3d0; color:#064e3b; border-radius:18px; font-size:12px; margin-left:auto; max-width:80%; }

    .phone-bottom{
      background:#ffffff;
      border-top:1px solid rgba(2,6,23,.10);
      padding:8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mini-btn{
      width:38px; height:34px;
      border-radius:10px;
      background:#f1f5f9;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:#0f172a;
      border:1px solid rgba(2,6,23,.10);
      flex: 0 0 auto;
      user-select:none;
    }
    .menu-title{
      flex:1 1 auto;
      text-align:center;
      font-size:13px;
      font-weight:900;
      color:#0f172a;
      line-height:1;
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .menu-caret{ font-size:12px; opacity:.6; margin-left:4px; }

    .rm-wrap{
      position:relative;
      width:100%;
      aspect-ratio: 2500 / 1686;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(2,6,23,.12);
    }
    .rm-wrap img{ width:100%; height:100%; object-fit:cover; display:block; }
    #phoneHotspots{ pointer-events:auto; }
  </style>
</head>

<body class="bg-slate-100 text-slate-800 overflow-hidden">

<div class="h-14 bg-white border-b flex items-center justify-between px-3">
  <div class="flex items-center gap-3">
    <div class="font-extrabold text-indigo-700 text-lg">å…­å®®æ ¼é¸å–®</div>
    <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
      <span>æ»¾è¼ªï¼šç¸®æ”¾</span><span>ï½œ</span><span>ä¸­éµæŒ‰ä½ï¼šæ‹–æ›³å¹³ç§»</span><span>ï½œ</span>
      <span><span class="kbd">Shift+é»é¸</span> å¤šé¸</span><span>ï½œ</span>
      <span><span class="kbd">Ctrl+Z</span>/<span class="kbd">Ctrl+Y</span> å¾©åŸ/é‡åš</span><span>ï½œ</span>
      <span><span class="kbd">Delete</span> åˆªé™¤é¸å–</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <div id="status" class="text-xs text-slate-500 mr-2 hidden md:block">ç‹€æ…‹ï¼šå°±ç·’</div>
    <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="closePage()">è¿”å›</button>
  </div>
</div>

<div class="h-[calc(100vh-56px)] flex">

  <div class="w-[92px] bg-white border-r flex flex-col items-center py-3 gap-2">
    <button class="w-14 h-12 rounded-xl bg-slate-900 text-white flex items-center justify-center text-xl hover:bg-black"
            title="æ”¶åˆ/å±•é–‹å·¦å´" onclick="toggleLeft()">â˜°</button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="makeSixGrid()" title="å¿«é€Ÿå…­å®®æ ¼">
      <div class="text-xl">ğŸ§©</div><div class="text-[10px] text-slate-700 font-bold">å…­æ ¼</div>
    </button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="fitToScreen()" title="Fit">
      <div class="text-xl">ğŸ“</div><div class="text-[10px] text-slate-700 font-bold">Fit</div>
    </button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="resetView()" title="é‡ç½®è¦–è§’">
      <div class="text-xl">ğŸ”</div><div class="text-[10px] text-slate-700 font-bold">é‡ç½®</div>
    </button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="togglePreview()" title="é è¦½é¢æ¿ï¼ˆå³å´ï¼‰">
      <div class="text-xl">ğŸ“±</div><div class="text-[10px] text-slate-700 font-bold">é è¦½</div>
    </button>
  </div>

  <div id="leftPanel" class="w-[360px] bg-white border-r overflow-y-auto">
    <div class="p-4 space-y-4">

      <div class="rounded-xl border p-3 bg-slate-50">
        <div class="font-bold text-sm mb-2">é€£ç·š</div>
        <label class="text-xs text-slate-500">Worker URL</label>
        <input id="workerUrl" class="mt-1 w-full border rounded px-3 py-2 bg-yellow-50 text-sm"
               placeholder="https://api.xxx.workers.dev" />
      </div>

      <div class="rounded-xl border p-3">
        <div class="font-bold text-sm mb-2">é¸å–®è³‡è¨Š</div>

        <label class="text-xs text-slate-500">é¸å–®åç¨±ï¼ˆ=æª”æ¡ˆåç¨±ï¼‰</label>
        <input id="menuName" class="mt-1 w-full border rounded px-3 py-2 text-sm font-bold"
               placeholder="ä¾‹å¦‚ï¼šHOME_å…­å®®æ ¼" />

        <div class="mt-2 grid grid-cols-2 gap-2">
          <label class="text-xs text-slate-500">
            åˆ‡æ›å…¶ä»–é¸å–®
            <select id="menuSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm" onchange="onSelectMenu()">
              <option value="">ï¼ˆå°šæœªè¼‰å…¥ï¼‰</option>
            </select>
          </label>

          <label class="text-xs text-slate-500">
            è¨­ç‚ºé è¨­(é¦–é )
            <select id="isDefault" class="mt-1 w-full border rounded px-2 py-2 text-sm">
              <option value="no" selected>å¦</option>
              <option value="yes">æ˜¯</option>
            </select>
          </label>
        </div>

        <div class="mt-3 flex gap-2">
          <button id="btnImport" class="flex-1 px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700"
                  onclick="pickAndImport()">åŒ¯å…¥åœ–ç‰‡ï¼ˆè‡ªå‹•å£“ç¸®ï¼‰</button>

          <button class="flex-1 px-3 py-2 rounded bg-green-600 text-white text-sm hover:bg-green-700"
                  onclick="saveMenu()">å„²å­˜ä¸¦å¥—ç”¨åˆ° LINE</button>
        </div>

        <div class="mt-2 flex gap-2">
          <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black"
                  onclick="loadMenu()">è®€å–</button>

          <button class="flex-1 px-3 py-2 rounded bg-slate-200 text-slate-800 text-sm hover:bg-slate-300"
                  onclick="clearAll()">æ¸…ç©º</button>
        </div>

        <div class="mt-2 text-xs text-slate-500">
          âœ… æœƒè½‰ JPEG ä¸¦å£“åˆ° 950KB ä»¥ä¸‹ï¼Œé¿å… LINE 413
        </div>
      </div>

      <div class="rounded-xl border p-3">
        <div class="font-bold text-sm mb-2 flex items-center justify-between">
          <span>æ ¼å­æ¸…å–®</span>
          <div class="flex items-center gap-2">
            <span id="count" class="text-xs text-slate-500">0</span>
          </div>
        </div>

        <div class="flex items-center gap-2 mb-2">
          <button class="px-2 py-1 text-xs rounded border hover:bg-slate-50" onclick="selectAllHotspots()">å…¨é¸</button>
          <button class="px-2 py-1 text-xs rounded border hover:bg-slate-50" onclick="clearSelection()">å–æ¶ˆé¸å–</button>
          <button class="px-2 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700" onclick="deleteSelectedAll()">åˆªé™¤é¸å–</button>
        </div>

        <div id="empty" class="text-xs text-slate-400">å°šæœªæ–°å¢æ ¼å­ã€‚ä½ å¯ä»¥æ‹–æ›³æ–°å¢æ ¼å­ï¼Œæˆ–æŒ‰ã€Œå…­æ ¼ã€ã€‚</div>
        <div id="list" class="space-y-2"></div>
      </div>

      <div class="text-xs text-slate-400 pb-10">
        åœ–ç‰‡æœƒè£åˆ‡æˆ 2500Ã—1686ï¼Œä¸¦ä¸Šå‚³åˆ° R2ã€‚<br/>
        æ¯å€‹æ ¼å­ã€Œæ–‡å­—ã€å°±æ˜¯ç”¨ä¾†è§¸ç™¼ webhook çš„é—œéµå­—ã€‚
      </div>
    </div>
  </div>

  <div class="flex-1 relative checker overflow-hidden" id="workspace">
    <div class="absolute top-3 right-3 z-20 flex items-center gap-2 bg-white/90 backdrop-blur border rounded-xl px-2 py-1 shadow">
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1.1)">ï¼‹</button>
      <div class="w-16 text-center text-sm font-bold" id="zoomLabel">100%</div>
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1/1.1)">ï¼</button>
      <button class="px-2 py-1 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="fitToScreen()">Fit</button>
    </div>

    <div id="stage" class="absolute inset-0">
      <div id="artboard" class="artboard">
        <div class="img-layer"><img id="img" alt=""></div>
        <div id="hotspotLayer" class="absolute inset-0"></div>
        <div id="drawLayer" class="absolute inset-0"></div>
      </div>
    </div>

    <div class="absolute left-3 bottom-3 z-20 bg-white/90 backdrop-blur border rounded-xl px-3 py-2 shadow text-xs text-slate-600">
      <div class="font-bold mb-1">æ“ä½œ</div>
      <div class="space-y-1">
        <div>â€¢ æ‹–æ›³æ–°å¢æ ¼å­ï¼›é»é¸æ ¼å­å¾Œå¯æ‹–ç§»/æ‹‰è§’ç¸®æ”¾</div>
        <div>â€¢ æ»¾è¼ªï¼šç¸®æ”¾ï¼›ä¸­éµæŒ‰ä½ï¼šæ‹–æ›³å¹³ç§»</div>
        <div>â€¢ Shift+é»é¸ï¼šå¤šé¸ï¼›Deleteï¼šåˆªé™¤é¸å–</div>
      </div>
    </div>
  </div>

  <div id="previewPanel" class="w-[380px] bg-white border-l overflow-y-auto">
    <div class="p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="font-bold text-sm">LINE æ‰‹æ©Ÿé è¦½</div>
        <button class="text-xs px-2 py-1 rounded border hover:bg-slate-50" onclick="togglePreview()">æ”¶åˆ</button>
      </div>

      <div class="phone">
        <div class="phone-inner">
          <div class="phone-chat">
            <div class="bubble">é»ä¸‹æ–¹é¸å–®æ ¼å­æœƒé€å‡ºä½ è¨­å®šçš„æ–‡å­—</div>
          </div>

          <div class="phone-bottom">
            <button id="toggleBtn" class="mini-btn" onclick="toggleKeyboard()">â‰¡</button>
            <div class="menu-title">
              <span id="phoneMenuTitle">é¸å–®</span><span class="menu-caret">â–¼</span>
            </div>
            <div class="mini-btn">ï¼‹</div>
          </div>

          <div id="rmBar" class="p-3 bg-white">
            <div class="rm-wrap">
              <img id="phoneImg" alt="">
              <div id="phoneHotspots" class="absolute inset-0"></div>
            </div>
          </div>

        </div>
      </div>

      <div class="mt-3 text-xs text-slate-500">â€¢ ä½ æ¯æ¬¡æ‹–æ›³/æ”¹æ–‡å­—ï¼Œé è¦½æœƒè‡ªå‹•æ›´æ–°</div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<script>
  const $ = (id)=>document.getElementById(id);
  const BASE_W = 2500, BASE_H = 1686;
  const MAX_UPLOAD_BYTES = 950 * 1024; // âœ… å£“åˆ° 950KB ä»¥ä¸‹ï¼ˆé¿å… LINE 413ï¼‰

  const workerUrlEl = $("workerUrl");
  const menuNameEl = $("menuName");
  const menuSelectEl = $("menuSelect");
  const isDefaultEl = $("isDefault");
  const statusEl = $("status");

  const leftPanelEl = $("leftPanel");
  const previewPanelEl = $("previewPanel");
  const workspaceEl = $("workspace");
  const stageEl = $("stage");

  const artboardEl = $("artboard");
  const imgEl = $("img");
  const hotspotLayerEl = $("hotspotLayer");
  const drawLayerEl = $("drawLayer");

  const listEl = $("list");
  const emptyEl = $("empty");
  const countEl = $("count");
  const zoomLabelEl = $("zoomLabel");

  const btnImportEl = $("btnImport");

  const phoneImgEl = $("phoneImg");
  const phoneHotspotsEl = $("phoneHotspots");
  const rmBarEl = $("rmBar");
  const toggleBtnEl = $("toggleBtn");
  const phoneMenuTitleEl = $("phoneMenuTitle");

  function setStatus(s){ statusEl.textContent = "ç‹€æ…‹ï¼š" + s; }

  function normalizeWorkerUrl(raw){
    if(!raw) return "";
    let s = raw.trim();
    if(!/^https?:\/\//i.test(s)) s = "https://" + s;
    return s.replace(/\/+$/,'');
  }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    const txt = await res.text().catch(()=> "");
    if(!res.ok) throw new Error(`HTTP ${res.status}\n${txt}`);
    try { return JSON.parse(txt); } catch { return txt; }
  }

  async function uploadToR2(workerBaseUrl, blob, filename){
    const form = new FormData();
    form.append("file", blob, filename || "richmenu.jpg");
    const res = await fetch(workerBaseUrl + "/upload", { method:"POST", body: form });
    const txt = await res.text().catch(()=> "");
    if(!res.ok) throw new Error(`HTTP ${res.status}\n${txt}`);
    const j = JSON.parse(txt);
    if(!j.ok || !j.url || !j.key) throw new Error("ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°ï¼ˆç¼º url/keyï¼‰");
    return { url: j.url, key: j.key };
  }

  // ===== state =====
  let state = {
    meta: { name: "" },
    imageUrl: "",
    imageKey: "",
    hotspots: [],
    selectedId: null,
    selectedIds: new Set(),
  };

  // ===== history =====
  let history = [];
  let historyIndex = -1;
  function snapshot(){
    return JSON.parse(JSON.stringify({
      meta: state.meta,
      imageUrl: state.imageUrl,
      imageKey: state.imageKey,
      hotspots: state.hotspots,
      selectedId: state.selectedId,
      selectedIds: Array.from(state.selectedIds),
    }));
  }
  function pushHistory(){
    const snap = snapshot();
    history = history.slice(0, historyIndex + 1);
    history.push(snap);
    historyIndex++;
  }
  function applySnap(snap){
    state.meta = snap.meta;
    state.imageUrl = snap.imageUrl;
    state.imageKey = snap.imageKey || "";
    state.hotspots = snap.hotspots;
    state.selectedId = snap.selectedId;
    state.selectedIds = new Set(snap.selectedIds || []);
    menuNameEl.value = state.meta?.name || "";
    imgEl.src = state.imageUrl || "";
    renderAll(true);
  }
  function undo(){ if(historyIndex<=0) return; historyIndex--; applySnap(history[historyIndex]); }
  function redo(){ if(historyIndex>=history.length-1) return; historyIndex++; applySnap(history[historyIndex]); }

  // ===== view =====
  let view = { x: 0, y: 0, z: 1 };
  function updateStage(){
    stageEl.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.z})`;
    zoomLabelEl.textContent = Math.round(view.z * 100) + "%";
  }
  function resetView(){ view = { x:0, y:0, z:1 }; updateStage(); }
  function zoomBy(factor, anchorX=null, anchorY=null){
    const oldZ = view.z;
    const newZ = Math.min(4, Math.max(0.15, oldZ * factor));
    if(anchorX != null && anchorY != null){
      const rect = workspaceEl.getBoundingClientRect();
      const ax = anchorX - rect.left;
      const ay = anchorY - rect.top;
      const dx = ax - (rect.width/2);
      const dy = ay - (rect.height/2);
      view.x = (view.x - dx) * (newZ/oldZ) + dx;
      view.y = (view.y - dy) * (newZ/oldZ) + dy;
    }
    view.z = newZ;
    updateStage();
  }
  function fitToScreen(){
    const wr = workspaceEl.getBoundingClientRect();
    const pad = 140;
    const maxW = Math.max(200, wr.width - pad);
    const maxH = Math.max(200, wr.height - pad);
    const z = Math.min(3, Math.max(0.15, Math.min(maxW/BASE_W, maxH/BASE_H)));
    view.z = z; view.x = 0; view.y = 0;
    updateStage();
  }

  // ===== toggles =====
  let leftCollapsed = false;
  function toggleLeft(){ leftCollapsed = !leftCollapsed; leftPanelEl.classList.toggle("hidden", leftCollapsed); }
  let previewCollapsed = false;
  function togglePreview(){ previewCollapsed = !previewCollapsed; previewPanelEl.classList.toggle("hidden", previewCollapsed); }

  let showMenu = true;
  function toggleKeyboard(){
    showMenu = !showMenu;
    rmBarEl.classList.toggle("hidden", !showMenu);
    toggleBtnEl.textContent = showMenu ? "â‰¡" : "âŒ¨ï¸";
  }

  function initArtboard(){
    artboardEl.style.width = BASE_W + "px";
    artboardEl.style.height = BASE_H + "px";
    fitToScreen();
  }

  // ===== selection =====
  function uid(){ return "hs_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
  function clearSelection(){ state.selectedId=null; state.selectedIds.clear(); renderHotspots(); renderList(); }
  function selectAllHotspots(){ state.selectedIds = new Set(state.hotspots.map(h=>h.id)); state.selectedId = state.hotspots[0]?.id || null; renderHotspots(); renderList(); }
  function selectHotspot(id, opts={multi:false, toggle:false}){
    if(!opts.multi){
      state.selectedIds.clear();
      state.selectedIds.add(id);
      state.selectedId = id;
    }else{
      if(opts.toggle){
        if(state.selectedIds.has(id)) state.selectedIds.delete(id);
        else state.selectedIds.add(id);
      }else{
        state.selectedIds.add(id);
      }
      state.selectedId = id;
    }
    renderHotspots(); renderList();
  }
  function deleteSelectedAll(){
    if(state.selectedIds.size===0 && !state.selectedId) return;
    const ids = new Set(state.selectedIds);
    if(state.selectedId) ids.add(state.selectedId);
    if(!confirm(`ç¢ºå®šåˆªé™¤é¸å–çš„ ${ids.size} å€‹æ ¼å­ï¼Ÿ`)) return;
    state.hotspots = state.hotspots.filter(h=>!ids.has(h.id));
    state.selectedId=null; state.selectedIds.clear();
    pushHistory(); renderAll();
  }
  function focusHotspotInput(id){
    const el = document.querySelector(`[data-hs-input="${id}"]`);
    if(el){ el.focus(); el.select?.(); }
  }

  // ===== draw new hotspot (pointer) =====
  let drawing=false, start={x:0,y:0}, last={x:0,y:0}, drawRect=null, drawPointerId=null;
  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
  function pointInArtboardFromClient(clientX, clientY){
    const ab = artboardEl.getBoundingClientRect();
    const x = clamp(clientX - ab.left, 0, ab.width);
    const y = clamp(clientY - ab.top, 0, ab.height);
    return { ab, x, y };
  }

  artboardEl.addEventListener("pointerdown", (ev)=>{
    if(ev.pointerType==="mouse" && ev.button!==0) return;
    if(!state.imageUrl) return alert("è«‹å…ˆåŒ¯å…¥åœ–ç‰‡");

    const hitHotspot = ev.target.closest(".hotspot");
    const hitHandle  = ev.target.closest(".handle");
    if(hitHotspot || hitHandle) return;

    ev.preventDefault();

    const p = pointInArtboardFromClient(ev.clientX, ev.clientY);
    drawing=true;
    drawPointerId=ev.pointerId;
    artboardEl.setPointerCapture(drawPointerId);

    start={x:p.x,y:p.y};
    last={x:p.x,y:p.y};

    drawRect=document.createElement("div");
    drawRect.className="draw-rect";
    drawRect.style.left=start.x+"px";
    drawRect.style.top=start.y+"px";
    drawRect.style.width="0px";
    drawRect.style.height="0px";
    drawLayerEl.appendChild(drawRect);

    state.selectedId=null;
    renderHotspots();
  });

  artboardEl.addEventListener("pointermove", (ev)=>{
    if(drag) return;
    if(!drawing || !drawRect) return;
    if(drawPointerId!==ev.pointerId) return;
    ev.preventDefault();

    const p = pointInArtboardFromClient(ev.clientX, ev.clientY);
    last={x:p.x,y:p.y};

    const x=Math.min(start.x,last.x);
    const y=Math.min(start.y,last.y);
    const w=Math.abs(last.x-start.x);
    const h=Math.abs(last.y-start.y);

    drawRect.style.left=x+"px";
    drawRect.style.top=y+"px";
    drawRect.style.width=w+"px";
    drawRect.style.height=h+"px";
  });

  function finishDraw(){
    if(!drawing) return;
    drawing=false;
    if(drawRect){ drawRect.remove(); drawRect=null; }

    const ab = artboardEl.getBoundingClientRect();
    const x=Math.min(start.x,last.x);
    const y=Math.min(start.y,last.y);
    const w=Math.abs(last.x-start.x);
    const h=Math.abs(last.y-start.y);

    drawPointerId=null;
    if(w<18 || h<18) return;

    const nx=x/ab.width, ny=y/ab.height, nw=w/ab.width, nh=h/ab.height;
    const id=uid();
    state.hotspots.push({ id, x:nx, y:ny, w:nw, h:nh, text:"" });
    state.selectedIds.add(id);
    state.selectedId=id;

    pushHistory();
    renderAll();
    setTimeout(()=>focusHotspotInput(id), 50);
  }

  artboardEl.addEventListener("pointerup", (ev)=>{
    if(drawPointerId!==ev.pointerId) return;
    ev.preventDefault();
    try{ artboardEl.releasePointerCapture(ev.pointerId); }catch{}
    finishDraw();
  });

  artboardEl.addEventListener("pointercancel", (ev)=>{
    if(drawPointerId!==ev.pointerId) return;
    try{ artboardEl.releasePointerCapture(ev.pointerId); }catch{}
    drawing=false;
    drawPointerId=null;
    if(drawRect){ drawRect.remove(); drawRect=null; }
  });

  // ===== drag/resize (pointer) =====
  let drag=null;
  function beginDragPointer(ev, id, kind){
    const h = state.hotspots.find(x=>x.id===id);
    if(!h) return;
    ev.preventDefault();
    ev.stopPropagation();

    const r = artboardEl.getBoundingClientRect();
    let px=(ev.clientX-r.left)/r.width;
    let py=(ev.clientY-r.top)/r.height;
    px=Math.max(0,Math.min(1,px));
    py=Math.max(0,Math.min(1,py));

    drag={
      id, kind,
      pointerId: ev.pointerId,
      startPointer:{x:px,y:py},
      startBox:{x:h.x,y:h.y,w:h.w,h:h.h},
      offset:{x:px-h.x,y:py-h.y}
    };

    if(drawing){
      drawing=false;
      drawPointerId=null;
      if(drawRect){ drawRect.remove(); drawRect=null; }
    }
    artboardEl.setPointerCapture(ev.pointerId);
  }

  function onDragPointer(ev){
    if(!drag) return;
    if(ev.pointerId!==drag.pointerId) return;
    ev.preventDefault();

    const h = state.hotspots.find(x=>x.id===drag.id);
    if(!h) return;

    const r = artboardEl.getBoundingClientRect();
    let px=(ev.clientX-r.left)/r.width;
    let py=(ev.clientY-r.top)/r.height;
    px=Math.max(0,Math.min(1,px));
    py=Math.max(0,Math.min(1,py));

    const dx=px-drag.startPointer.x;
    const dy=py-drag.startPointer.y;

    let nx=drag.startBox.x, ny=drag.startBox.y, nw=drag.startBox.w, nh=drag.startBox.h;
    const min=0.03;

    if(drag.kind==="move"){
      nx = px - drag.offset.x;
      ny = py - drag.offset.y;
    }else{
      if(drag.kind.includes("n")){ ny = drag.startBox.y + dy; nh = drag.startBox.h - dy; }
      if(drag.kind.includes("s")){ nh = drag.startBox.h + dy; }
      if(drag.kind.includes("w")){ nx = drag.startBox.x + dx; nw = drag.startBox.w - dx; }
      if(drag.kind.includes("e")){ nw = drag.startBox.w + dx; }
    }

    nw=Math.max(min,nw);
    nh=Math.max(min,nh);
    nx=Math.min(1-nw,Math.max(0,nx));
    ny=Math.min(1-nh,Math.max(0,ny));

    h.x=nx; h.y=ny; h.w=nw; h.h=nh;
    renderHotspots();
    refreshPhonePreview();
  }

  function endDragPointer(ev){
    if(!drag) return;
    if(ev.pointerId!==drag.pointerId) return;
    ev.preventDefault();
    try{ artboardEl.releasePointerCapture(ev.pointerId); }catch{}
    drag=null;
    pushHistory();
    renderList();
  }

  artboardEl.addEventListener("pointermove", onDragPointer);
  artboardEl.addEventListener("pointerup", endDragPointer);

  // ===== render =====
  function renderHotspots(){
    hotspotLayerEl.innerHTML="";
    state.hotspots.forEach((h, idx)=>{
      const d=document.createElement("div");
      const isMain=(h.id===state.selectedId);
      const isMulti=state.selectedIds.has(h.id);

      d.className="hotspot"+(isMain?" selected":"")+(isMulti?" multiSelected":"");
      d.style.left=(h.x*100)+"%";
      d.style.top=(h.y*100)+"%";
      d.style.width=(h.w*100)+"%";
      d.style.height=(h.h*100)+"%";
      d.textContent=(idx+1);

      d.addEventListener("pointerdown",(ev)=>{
        if(ev.pointerType==="mouse" && ev.button!==0) return;
        const multi=ev.shiftKey;
        selectHotspot(h.id,{multi,toggle:multi});
        beginDragPointer(ev,h.id,"move");
      });

      if(isMain){
        ["nw","ne","sw","se"].forEach(pos=>{
          const hd=document.createElement("div");
          hd.className="handle "+pos;
          hd.addEventListener("pointerdown",(ev)=>{
            if(ev.pointerType==="mouse" && ev.button!==0) return;
            ev.stopPropagation();
            selectHotspot(h.id,{multi:false});
            beginDragPointer(ev,h.id,pos);
          });
          d.appendChild(hd);
        });
      }

      hotspotLayerEl.appendChild(d);
    });
    countEl.textContent = state.hotspots.length + " å€‹";
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  let inputTimer=null;
  function scheduleHistory(){
    clearTimeout(inputTimer);
    inputTimer=setTimeout(()=>pushHistory(),350);
  }

  function renderList(){
    listEl.innerHTML="";
    emptyEl.classList.toggle("hidden", state.hotspots.length!==0);

    state.hotspots.forEach((h, idx)=>{
      const wrap=document.createElement("div");
      wrap.className="border rounded-lg p-2 bg-white";

      const checked = state.selectedIds.has(h.id) || (state.selectedId===h.id);

      wrap.innerHTML=`
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <input type="checkbox" class="w-4 h-4" ${checked ? "checked":""} />
            <div class="font-bold text-sm ${h.id===state.selectedId?'text-blue-700':'text-slate-800'}">æ ¼ ${idx+1}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="text-xs text-slate-500 underline">é¸å–</button>
            <button class="text-xs text-red-600 underline">åˆªé™¤</button>
          </div>
        </div>
        <div class="text-xs text-slate-500 mb-1">é»æ“Šé€å‡ºæ–‡å­—ï¼ˆé—œéµå­—ï¼‰ï¼š</div>
        <input data-hs-input="${h.id}" class="w-full border rounded px-2 py-2 text-sm font-bold"
          placeholder="ä¾‹å¦‚ï¼šRM:HOME / MENU_SHOP / é–‹å§‹"
          value="${escapeHtml(h.text)}">
      `;

      const checkbox=wrap.querySelector("input[type=checkbox]");
      const btnSel=wrap.querySelectorAll("button")[0];
      const btnDel=wrap.querySelectorAll("button")[1];
      const input=wrap.querySelector("input[data-hs-input]");

      checkbox.onchange=()=>{
        if(checkbox.checked) state.selectedIds.add(h.id);
        else state.selectedIds.delete(h.id);
        renderHotspots();
      };

      btnSel.onclick=()=>{
        selectHotspot(h.id,{multi:false});
        setTimeout(()=>focusHotspotInput(h.id),0);
      };

      btnDel.onclick=()=>{
        if(confirm(`åˆªé™¤æ ¼ ${idx+1}ï¼Ÿ`)){
          const i=state.hotspots.findIndex(x=>x.id===h.id);
          if(i>=0){
            state.hotspots.splice(i,1);
            state.selectedIds.delete(h.id);
            if(state.selectedId===h.id) state.selectedId=null;
            pushHistory();
            renderAll();
          }
        }
      };

      input.oninput=()=>{
        h.text=input.value;
        refreshPhonePreview();
        scheduleHistory();
      };

      // âœ… ä¸é‡å»º listï¼ˆé¿å…æ‰“å­—è¢«æ‰“æ–·ï¼‰ï¼Œåªæ›´æ–°ç†±å€
      input.onfocus=()=>{
        state.selectedIds.clear();
        state.selectedIds.add(h.id);
        state.selectedId=h.id;
        renderHotspots();
      };

      listEl.appendChild(wrap);
    });
  }

  function renderAll(silent=false){
    renderHotspots();
    renderList();
    refreshPhonePreview();
    if(!silent) setStatus("å°±ç·’");
  }

  function refreshPhonePreview(){
    phoneMenuTitleEl.textContent = (state.meta?.name || "é¸å–®").trim() || "é¸å–®";

    if(!state.imageUrl){
      phoneImgEl.src="";
      phoneHotspotsEl.innerHTML="";
      return;
    }

    phoneImgEl.src = state.imageUrl;
    phoneHotspotsEl.innerHTML="";

    state.hotspots.forEach((h,i)=>{
      const btn=document.createElement("button");
      btn.style.position="absolute";
      btn.style.left=(h.x*100)+"%";
      btn.style.top=(h.y*100)+"%";
      btn.style.width=(h.w*100)+"%";
      btn.style.height=(h.h*100)+"%";
      btn.style.background="transparent";
      btn.style.border="none";
      btn.onclick=()=>{
        const t=(h.text||"").trim();
        alert(`æ ¼ ${i+1}\nå°‡é€å‡ºï¼š${t || "ï¼ˆå°šæœªå¡«ï¼‰"}`);
      };
      phoneHotspotsEl.appendChild(btn);
    });
  }

  function makeSixGrid(){
    const cols=3, rows=2;
    const gap=0.012;
    const cellW=(1-gap*(cols+1))/cols;
    const cellH=(1-gap*(rows+1))/rows;

    state.hotspots=[];
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const x=gap + c*(cellW+gap);
        const y=gap + r*(cellH+gap);
        state.hotspots.push({ id:uid(), x, y, w:cellW, h:cellH, text:"" });
      }
    }
    state.selectedIds = new Set(state.hotspots.map(h=>h.id));
    state.selectedId = state.hotspots[0]?.id || null;

    pushHistory();
    renderAll();
  }

  // âœ… ç”¢å‡º 2500x1686 ä¸¦ã€Œè‡ªå‹•å£“ç¸®åˆ° 950KB ä»¥ä¸‹ã€
  async function encodeRichMenuImage(file){
    const bmp = await createImageBitmap(file);
    const W=BASE_W, H=BASE_H;

    const s = Math.max(W / bmp.width, H / bmp.height);
    const dw = bmp.width * s;
    const dh = bmp.height * s;
    const dx = (W - dw) / 2;
    const dy = (H - dh) / 2;

    const canvas=document.createElement("canvas");
    canvas.width=W; canvas.height=H;
    const ctx=canvas.getContext("2d");
    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,W,H);
    ctx.drawImage(bmp, dx, dy, dw, dh);

    // âœ… å„ªå…ˆ JPEGï¼ˆå°å¾ˆå¤šï¼‰ï¼Œé€æ­¥é™å“è³ªç›´åˆ° <= MAX_UPLOAD_BYTES
    const qualities=[0.86,0.80,0.74,0.68,0.62,0.56];
    let blob=null;
    for(const q of qualities){
      blob = await new Promise(res=>canvas.toBlob(res, "image/jpeg", q));
      if(!blob) throw new Error("åœ–ç‰‡è½‰æ›å¤±æ•—ï¼ˆtoBlob ç©ºï¼‰");
      if(blob.size <= MAX_UPLOAD_BYTES) return { blob, ext:"jpg", mime:"image/jpeg", quality:q };
    }
    // é‚„æ˜¯å¤ªå¤§ï¼šå°±å›å‚³æœ€å¾Œä¸€å€‹ï¼ˆé€šå¸¸ä¸æœƒï¼‰
    return { blob, ext:"jpg", mime:"image/jpeg", quality:qualities[qualities.length-1] };
  }

  async function pickAndImport(){
    const base = normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return alert("è«‹å…ˆå¡« Worker URL");
    localStorage.setItem("line_worker_url", base);

    const input = $("fileInput");
    input.value="";
    input.onchange=async (e)=>{
      const file=e.target.files[0];
      if(!file) return;

      try{
        setStatus("åŒ¯å…¥ä¸­ï¼ˆå£“ç¸®ï¼‰...");
        const encoded = await encodeRichMenuImage(file);

        const up = await uploadToR2(base, encoded.blob, `richmenu_2500x1686.${encoded.ext}`);

        state.imageUrl = up.url;
        state.imageKey = up.key;
        imgEl.src = up.url;

        btnImportEl.textContent = `å·²åŒ¯å…¥ï¼ˆ${Math.round(encoded.blob.size/1024)}KBï¼‰`;
        btnImportEl.classList.remove("bg-blue-600");
        btnImportEl.classList.add("bg-emerald-600");

        pushHistory();
        renderAll();
        fitToScreen();
        setStatus("å·²åŒ¯å…¥ âœ…");
      }catch(err){
        setStatus("åŒ¯å…¥å¤±æ•—");
        alert("åŒ¯å…¥å¤±æ•—ï¼š\n"+err.message);
      }
    };
    input.click();
  }

  function buildRichMenuPayload(){
    if(!state.imageUrl) throw new Error("å°šæœªåŒ¯å…¥åœ–ç‰‡");
    if(!state.imageKey) throw new Error("ç¼ºå°‘ imageKeyï¼ˆè«‹å…ˆé‡æ–°åŒ¯å…¥åœ–ç‰‡ï¼‰");
    if(state.hotspots.length===0) throw new Error("å°šæœªæ–°å¢æ ¼å­");
    if(state.hotspots.some(h=>!String(h.text||"").trim())) throw new Error("æœ‰æ ¼å­æ²’æœ‰å¡«æ–‡å­—");

    const areas=state.hotspots.map(h=>({
      bounds:{
        x: Math.round(h.x * BASE_W),
        y: Math.round(h.y * BASE_H),
        width: Math.round(h.w * BASE_W),
        height: Math.round(h.h * BASE_H),
      },
      action:{ type:"message", text:String(h.text).trim() }
    }));

    return {
      meta:{ feature:"richmenu", name: state.meta.name || "", updatedAt: Date.now() },
      type:"richmenu",
      size:{ width: BASE_W, height: BASE_H },
      imageUrl: state.imageUrl,
      imageKey: state.imageKey,
      areas
    };
  }

  async function saveMenu(){
    const base=normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return alert("è«‹å…ˆå¡« Worker URL");

    const name=(menuNameEl.value||"").trim();
    if(!name) return alert("è«‹å…ˆå¡«é¸å–®åç¨±");

    try{
      state.meta.name=name;
      const payload=buildRichMenuPayload();
      const isDefault=(isDefaultEl.value==="yes");

      setStatus("å„²å­˜/å¥—ç”¨ä¸­...");
      const res = await postJSON(base+"/richmenu/save",{ name, payload, isDefault });

      pushHistory();
      setStatus("æˆåŠŸ âœ…");
      await refreshMenuList(true);

      alert("å·²å„²å­˜ä¸¦å¥—ç”¨åˆ° LINE OA âœ…\né¸å–®åç¨±ï¼š"+name+(isDefault?"\nï¼ˆå·²è¨­ç‚ºé è¨­/é¦–é ï¼‰":"")+(res?.richMenuId?`\nRichMenuIdï¼š${res.richMenuId}`:""));
    }catch(e){
      setStatus("å„²å­˜å¤±æ•—");
      alert("å„²å­˜å¤±æ•—ï¼š\n"+e.message);
    }
  }

  async function loadMenu(){
    const base=normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return alert("è«‹å…ˆå¡« Worker URL");

    const name=(menuNameEl.value||"").trim() || (menuSelectEl.value||"").trim();
    if(!name) return alert("è«‹å…ˆè¼¸å…¥/é¸æ“‡è¦è®€å–çš„é¸å–®");

    try{
      setStatus("è®€å–ä¸­...");
      const j=await postJSON(base+"/richmenu/load",{ name });
      if(!j.ok) throw new Error(j.error || "è®€å–å¤±æ•—");

      const p=j.payload;
      state.meta = p.meta || { name };
      state.imageUrl = p.imageUrl || "";
      state.imageKey = p.imageKey || "";
      state.hotspots = (p.areas||[]).map(a=>({
        id: uid(),
        x: (a.bounds.x||0)/BASE_W,
        y: (a.bounds.y||0)/BASE_H,
        w: (a.bounds.width||0)/BASE_W,
        h: (a.bounds.height||0)/BASE_H,
        text: (a.action?.text||""),
      }));

      state.selectedIds=new Set(state.hotspots.map(h=>h.id));
      state.selectedId=state.hotspots[0]?.id || null;

      menuNameEl.value=name;
      imgEl.src=state.imageUrl||"";

      btnImportEl.textContent=state.imageUrl?"å·²åŒ¯å…¥":"åŒ¯å…¥åœ–ç‰‡ï¼ˆè‡ªå‹•å£“ç¸®ï¼‰";
      btnImportEl.classList.toggle("bg-emerald-600", !!state.imageUrl);
      btnImportEl.classList.toggle("bg-blue-600", !state.imageUrl);

      isDefaultEl.value = j.isDefault ? "yes" : "no";

      pushHistory();
      renderAll();
      fitToScreen();
      setStatus("è®€å–æˆåŠŸ âœ…");
      setTimeout(()=>focusHotspotInput(state.selectedId), 50);
    }catch(e){
      setStatus("è®€å–å¤±æ•—");
      alert("è®€å–å¤±æ•—ï¼š\n"+e.message);
    }
  }

  async function refreshMenuList(keepSelection=false){
    const base=normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return;

    const current = keepSelection ? (menuSelectEl.value || "") : "";
    const j = await postJSON(base+"/richmenu/list", {});
    if(!j.ok) return;

    menuSelectEl.innerHTML = `<option value="">ï¼ˆé¸æ“‡é¸å–®ï¼‰</option>`;
    (j.items||[]).forEach(it=>{
      const opt=document.createElement("option");
      opt.value=it.name;
      opt.textContent=it.name+(it.isDefault?"ï¼ˆé è¨­ï¼‰":"");
      menuSelectEl.appendChild(opt);
    });
    if(current) menuSelectEl.value=current;
  }

  function onSelectMenu(){
    const v=(menuSelectEl.value||"").trim();
    if(!v) return;
    menuNameEl.value=v;
    loadMenu();
  }

  function clearAll(){
    if(!confirm("ç¢ºå®šæ¸…ç©ºåœ–ç‰‡èˆ‡å…¨éƒ¨æ ¼å­ï¼Ÿ")) return;
    state.imageUrl="";
    state.imageKey="";
    state.hotspots=[];
    state.selectedId=null;
    state.selectedIds.clear();
    imgEl.src="";

    btnImportEl.textContent="åŒ¯å…¥åœ–ç‰‡ï¼ˆè‡ªå‹•å£“ç¸®ï¼‰";
    btnImportEl.classList.remove("bg-emerald-600");
    btnImportEl.classList.add("bg-blue-600");

    pushHistory();
    renderAll();
  }

  menuNameEl.addEventListener("input", ()=>{
    state.meta.name = menuNameEl.value;
    refreshPhonePreview();
    scheduleHistory();
  });

  window.addEventListener("keydown",(ev)=>{
    if(ev.ctrlKey && !ev.shiftKey && ev.key.toLowerCase()==="z"){ ev.preventDefault(); undo(); return; }
    if((ev.ctrlKey && ev.key.toLowerCase()==="y") || (ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase()==="z")){ ev.preventDefault(); redo(); return; }
    if(ev.key==="Delete"){ ev.preventDefault(); deleteSelectedAll(); }
    if(ev.key==="Escape"){ clearSelection(); }
  });

  // middle mouse panning
  let panning=false;
  let panStart={x:0,y:0,vx:0,vy:0};
  workspaceEl.addEventListener("mousedown",(ev)=>{
    if(ev.button===1){
      ev.preventDefault();
      panning=true;
      panStart={ x:ev.clientX, y:ev.clientY, vx:view.x, vy:view.y };
      window.addEventListener("mousemove", onPan);
      window.addEventListener("mouseup", endPan, { once:true });
    }
  });
  function onPan(ev){
    if(!panning) return;
    view.x = panStart.vx + (ev.clientX - panStart.x);
    view.y = panStart.vy + (ev.clientY - panStart.y);
    updateStage();
  }
  function endPan(){ window.removeEventListener("mousemove", onPan); panning=false; }

  // wheel zoom
  workspaceEl.addEventListener("wheel",(ev)=>{
    ev.preventDefault();
    const factor = ev.deltaY < 0 ? 1.08 : 1/1.08;
    zoomBy(factor, ev.clientX, ev.clientY);
  }, { passive:false });

  function closePage(){ window.location.href="index.html"; }

  (function init(){
    const savedUrl=(localStorage.getItem("line_worker_url")||"").trim();
    if(savedUrl) workerUrlEl.value=savedUrl;
    initArtboard();
    resetView();
    renderAll(true);
    pushHistory();
    refreshMenuList();
    setStatus("å°±ç·’ âœ…");
  })();
</script>

</body>
</html>
