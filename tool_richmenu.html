<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rich Menu ç·¨è¼¯å™¨ï¼ˆ2500Ã—1686 / Canva ä»‹é¢ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{ --rail-w:76px; --panel-w:380px; }
    body{ user-select:none; }
    input, textarea, select, button { user-select:auto; }

    .checker{
      background-image:
        linear-gradient(45deg, rgba(0,0,0,.04) 25%, transparent 25%),
        linear-gradient(-45deg, rgba(0,0,0,.04) 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, rgba(0,0,0,.04) 75%),
        linear-gradient(-45deg, transparent 75%, rgba(0,0,0,.04) 75%);
      background-size: 28px 28px;
      background-position: 0 0, 0 14px, 14px -14px, -14px 0px;
    }

    .artboard{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%, -50%);
      background:#fff;
      border:1px solid rgba(15,23,42,.18);
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      border-radius: 14px;
      overflow:hidden;
    }

    .img-layer{
      position:absolute;
      inset:0;
      overflow:hidden;
      cursor: default;
      background:#f8fafc;
    }
    .img-layer img{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%, -50%);
      transform-origin: center center;
      max-width:none;
      max-height:none;
      pointer-events:none;
      user-select:none;
    }

    .hotspot{
      position:absolute;
      border:2px solid rgba(239,68,68,.95);
      background: rgba(239,68,68,.18);
      border-radius: 10px;
      color:white;
      font-weight:800;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-shadow:0 1px 2px rgba(0,0,0,.85);
      cursor:pointer;
    }
    .hotspot.selected{
      border-color: rgba(59,130,246,.95);
      background: rgba(59,130,246,.16);
    }

    .handle{
      position:absolute;
      width:10px; height:10px;
      background:#fff;
      border:2px solid rgba(59,130,246,.95);
      border-radius: 4px;
      box-shadow:0 1px 3px rgba(0,0,0,.25);
      z-index: 10;
    }
    .handle.nw{ left:-6px; top:-6px; cursor:nwse-resize; }
    .handle.ne{ right:-6px; top:-6px; cursor:nesw-resize; }
    .handle.sw{ left:-6px; bottom:-6px; cursor:nesw-resize; }
    .handle.se{ right:-6px; bottom:-6px; cursor:nwse-resize; }

    .draw-rect{
      position:absolute;
      border:2px dashed rgba(2,6,23,.55);
      background: rgba(2,6,23,.12);
      border-radius: 10px;
      pointer-events:none;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border:1px solid rgba(0,0,0,.18);
      padding:2px 6px;
      border-radius:6px;
      background:#fff;
      font-size: 11px;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-800 overflow-hidden">

<script>
/* âœ… ä»ç„¶ç¶­æŒä½ åŸæœ¬çš„ localStorage keyï¼Œä¸æ”¹ä¸²è¯ */
const LS_WORKER = "line_worker_url";
const LS_LIFF   = "line_liff_id";

/* âœ… ä½ è‹¥è¦å›ºå®š LIFF_ID å¯åœ¨é€™è£¡å¡«ï¼›æ²’å¡«å°±è‡ªå‹•åƒé¦–é å­˜çš„ line_liff_id */
let LIFF_ID = "";
</script>

<!-- Top bar -->
<div class="h-14 bg-white border-b flex items-center justify-between px-3">
  <div class="flex items-center gap-3">
    <div class="font-extrabold text-indigo-700">Rich Menu ç·¨è¼¯å™¨ï¼ˆ2500Ã—1686 / Canva ä»‹é¢ç‰ˆï¼‰</div>
    <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
      <span>ç©ºç™½éµæ‹–æ›³å¹³ç§»</span><span>ï½œ</span>
      <span>Ctrl+æ»¾è¼ªç¸®æ”¾ç•«é¢</span><span>ï½œ</span>
      <span>Alt+æ»¾è¼ªç¸®æ”¾åœ–ç‰‡ï¼ˆè£åˆ‡æ¨¡å¼ï¼‰</span><span>ï½œ</span>
      <span>Ctrl+Z / Ctrl+Y Undo/Redo</span><span>ï½œ</span>
      <span>Delete åˆªé™¤æ¡†</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreview(true)">ğŸ“± é è¦½</button>
    <button class="px-3 py-2 rounded bg-slate-700 text-white text-sm hover:bg-slate-900" onclick="goHome()">å›é¦–é </button>
  </div>
</div>

<div class="h-[calc(100vh-56px)] flex">

  <!-- Left rail -->
  <div id="rail" class="w-[76px] bg-white border-r flex flex-col items-center py-3 gap-2">
    <button class="w-12 h-12 rounded-xl bg-slate-900 text-white flex items-center justify-center text-xl hover:bg-black"
            title="æ”¶åˆ/å±•é–‹å·¦é‚Šæ¬„ä½" onclick="togglePanel()">â˜°</button>

    <button class="w-12 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-xl"
            title="ç†±å€ç·¨è¼¯æ¨¡å¼" onclick="setMode('hotspot')">ğŸ”²</button>

    <button class="w-12 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-xl"
            title="è£åˆ‡æ¨¡å¼ï¼ˆæ‹–åœ–ç‰‡æ±ºå®šè£åˆ‡ä½ç½®ï¼‰" onclick="setMode('crop')">âœ‚ï¸</button>

    <button class="w-12 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-xl"
            title="Fit" onclick="fitToScreen()">ğŸ“</button>

    <button class="w-12 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-xl"
            title="é‡ç½®è¦–è§’" onclick="resetView()">ğŸ”</button>
  </div>

  <!-- Left panel -->
  <div id="panel" class="w-[380px] bg-white border-r overflow-y-auto">
    <div class="p-4 space-y-4">

      <!-- åŸºæœ¬è¨­å®š -->
      <div class="rounded-xl border p-3 bg-slate-50">
        <div class="font-bold text-sm mb-2">åŸºæœ¬è¨­å®šï¼ˆä¸æ”¹ä½ ç¶²å€ä¸²è¯ï¼‰</div>

        <label class="text-xs text-slate-500">Worker URLï¼ˆå¾é¦–é è‡ªå‹•å¸¶å…¥ï¼‰</label>
        <input id="workerUrl" class="mt-1 w-full border rounded px-3 py-2 bg-yellow-50 text-sm"
               placeholder="https://api.xxx.workers.dev" />

        <div class="grid grid-cols-2 gap-2 mt-2">
          <div>
            <label class="text-xs text-slate-500">è§¸ç™¼é—œéµå­—ï¼ˆKV keyï¼‰</label>
            <input id="keyword" class="mt-1 w-full border rounded px-3 py-2 text-sm font-bold border-indigo-500"
                   placeholder="ä¾‹å¦‚ï¼šRM_MAIN" />
          </div>
          <div>
            <label class="text-xs text-slate-500">æª”æ¡ˆåç¨±ï¼ˆ=é¸å–®åç¨± chatBarTextï¼‰</label>
            <input id="fileName" class="mt-1 w-full border rounded px-3 py-2 text-sm font-bold"
                   placeholder="ä¾‹å¦‚ï¼šä¸»é¸å–®" />
          </div>
        </div>

        <div class="mt-2 text-xs text-slate-500">
          æœƒå­˜åˆ° <span class="kbd">payload.meta.name</span>ï¼Œä¸¦ä¸”è‡ªå‹•åŒæ­¥æˆ Rich Menu çš„ <span class="kbd">chatBarText</span>ï¼ˆåº•éƒ¨é¡¯ç¤ºæ–‡å­—ï¼‰ã€‚
        </div>

        <div id="status" class="mt-2 text-xs text-slate-500">ç‹€æ…‹ï¼šæœªåˆå§‹åŒ–</div>
      </div>

      <!-- åˆ‡æ›é¸å–® -->
      <div class="rounded-xl border p-3">
        <div class="font-bold text-sm mb-2 flex items-center justify-between">
          <span>åˆ‡æ› / å†ç·¨è¼¯ï¼ˆå·²å„²å­˜çš„é¸å–®ï¼‰</span>
          <button class="text-xs underline text-slate-500" onclick="refreshSavedList()">åˆ·æ–°</button>
        </div>

        <select id="savedSelect" class="w-full border rounded px-3 py-2 text-sm">
          <option value="">ï¼ˆå…ˆæŒ‰åˆ·æ–°ï¼‰</option>
        </select>

        <div class="mt-2 flex gap-2">
          <button class="flex-1 px-3 py-2 rounded bg-slate-200 text-slate-700 text-sm hover:bg-slate-300" onclick="loadSelectedSaved()">
            è¼‰å…¥æ‰€é¸
          </button>
          <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreview(true)">
            é è¦½
          </button>
        </div>

        <div class="mt-2 text-[11px] text-slate-500">
          é€™è£¡æ˜¯è®€ä½  KV å…§ <span class="kbd">mode=richmenu</span> çš„è³‡æ–™ï¼ˆéœ€è¦ Worker æœ‰ <span class="kbd">/rm/listSaved</span>ï¼‰ã€‚
        </div>
      </div>

      <!-- åœ–ç‰‡ -->
      <div class="rounded-xl border p-3">
        <div class="font-bold text-sm mb-2">åœ–ç‰‡ï¼ˆRich Menu å¿…é ˆ JPEG/PNGï¼‰</div>

        <div class="grid grid-cols-2 gap-2 text-xs">
          <label class="flex flex-col gap-1 col-span-2">
            <span class="text-slate-500">å“è³ª <span id="qVal">0.88</span>ï¼ˆå›ºå®šè¼¸å‡º JPEGï¼‰</span>
            <input id="quality" type="range" min="0.65" max="0.95" step="0.01" value="0.88">
          </label>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button class="px-3 py-2 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700" onclick="pickImage()">
            é¸æ“‡åœ–ç‰‡
          </button>
          <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="exportCropAndUpload()">
            ä¾è£åˆ‡è¼¸å‡º 2500Ã—1686 ä¸¦ä¸Šå‚³
          </button>
          <button class="px-3 py-2 rounded bg-slate-600 text-white text-sm hover:bg-slate-700" onclick="clearAll()">
            æ¸…ç©º
          </button>
        </div>

        <div class="mt-2 text-xs text-slate-500">
          æµç¨‹ï¼šé¸æ“‡åœ–ç‰‡ â†’ é€²è£åˆ‡æ¨¡å¼æ‹–ä½ç½®/ç¸®æ”¾ â†’ ã€Œä¾è£åˆ‡è¼¸å‡ºä¸¦ä¸Šå‚³ã€â†’ å†ç•«ç†±å€ â†’ å„²å­˜ã€‚
        </div>
      </div>

      <!-- ç†±å€ -->
      <div class="rounded-xl border p-3">
        <div class="font-bold text-sm mb-2 flex items-center justify-between">
          <span>ç†±å€æ¸…å–®</span>
          <span id="hsCount" class="text-xs text-slate-500">0</span>
        </div>

        <div id="areaEmpty" class="text-xs text-slate-400">å°šæœªæ–°å¢ç†±å€ã€‚ç”¨æ»‘é¼ åœ¨ç™½è‰²åº•æ¡†å…§æ‹–æ›³å³å¯æ–°å¢ã€‚</div>
        <div id="areaList" class="space-y-2"></div>

        <div class="mt-3 flex gap-2">
          <button class="flex-1 px-3 py-2 rounded bg-gray-600 text-white text-sm hover:bg-gray-700" onclick="loadKV()">
            è®€å–
          </button>
          <button class="flex-1 px-3 py-2 rounded bg-green-600 text-white text-sm hover:bg-green-700" onclick="saveKV()">
            å„²å­˜
          </button>
        </div>

        <div class="mt-2 text-xs text-slate-500">
          ç†±å€ã€Œå…§å®¹ã€ï¼ä½ è¦é€å‡ºçš„æ–‡å­—ï¼ˆmessage actionï¼‰ã€‚
        </div>
      </div>

      <!-- LIFF -->
      <div class="rounded-xl border p-3 bg-slate-50">
        <div class="font-bold text-sm mb-2">LIFF / ä½¿ç”¨è€…ï¼ˆæ¸¬è©¦ç”¨ï¼‰</div>
        <div class="text-xs text-slate-600 space-y-1">
          <div>LIFFï¼š<span id="liffState" class="font-bold">-</span></div>
          <div>ä½¿ç”¨è€…ï¼š<span id="userName" class="font-bold">-</span></div>
          <div>userIdï¼š<span id="userId" class="font-bold">-</span></div>
        </div>

        <div class="mt-3 flex gap-2">
          <button class="flex-1 px-3 py-2 rounded bg-black text-white text-sm hover:bg-slate-900" onclick="sendTestToMe()">
            é€æ¸¬è©¦è¨Šæ¯ï¼ˆåªæ¸¬ action æ–‡å­—ï¼‰
          </button>
          <button class="flex-1 px-3 py-2 rounded bg-slate-200 text-slate-700 text-sm hover:bg-slate-300" onclick="togglePreview(true)">
            é è¦½æŠ½å±œ
          </button>
        </div>

        <div class="mt-2 text-[11px] text-slate-500">
          Rich Menu çœŸæ­£ã€Œå¥—åˆ°èŠå¤©å®¤åº•éƒ¨ã€éœ€è¦ Bot API å»ºç«‹/ä¸Šå‚³/å¥—ç”¨ï¼ˆä½  Worker å¯å†åŠ  /rm/publish /rm/linkMeï¼‰ã€‚
        </div>
      </div>

      <div class="text-xs text-slate-400 pb-10">Powered by Cloudflare Workers & KV / R2</div>
    </div>
  </div>

  <!-- Workspace -->
  <div class="flex-1 relative checker overflow-hidden" id="workspace">
    <div class="absolute top-3 right-3 z-20 flex items-center gap-2 bg-white/90 backdrop-blur border rounded-xl px-2 py-1 shadow">
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1.1)">ï¼‹</button>
      <div class="w-16 text-center text-sm font-bold" id="zoomLabel">100%</div>
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1/1.1)">ï¼</button>
      <button class="px-2 py-1 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="fitToScreen()">Fit</button>
    </div>

    <div id="stage" class="absolute inset-0">
      <div id="artboard" class="artboard">
        <div id="imgLayer" class="img-layer">
          <img id="img" alt="">
          <div id="safe" class="absolute inset-0 pointer-events-none"></div>
        </div>
        <div id="hotspotLayer" class="absolute inset-0"></div>
        <div id="drawLayer" class="absolute inset-0"></div>
      </div>
    </div>

    <div class="absolute left-3 bottom-3 z-20 bg-white/90 backdrop-blur border rounded-xl px-3 py-2 shadow text-xs text-slate-600">
      <div class="font-bold mb-1">æ“ä½œæç¤º</div>
      <div class="space-y-1">
        <div>â€¢ ç†±å€æ¨¡å¼ï¼šåº•æ¡†å…§æ‹–æ›³æ–°å¢ï¼›é»æ¡†é¸å–ï¼›æ‹–ç§»ï¼æ‹‰è§’ç¸®æ”¾ï¼›<span class="kbd">Delete</span> åˆªé™¤</div>
        <div>â€¢ è£åˆ‡æ¨¡å¼ï¼šæ‹–å‹•åœ–ç‰‡æ±ºå®šä½ç½®ï¼›<span class="kbd">Alt</span>+æ»¾è¼ªç¸®æ”¾åœ–ç‰‡</div>
        <div>â€¢ è¦–è§’ï¼š<span class="kbd">ç©ºç™½éµ</span> æŒ‰ä½æ‹–æ›³å¹³ç§»ï¼›<span class="kbd">Ctrl</span>+æ»¾è¼ªç¸®æ”¾ç•«é¢</div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Drawer -->
<div id="drawerOverlay" class="fixed inset-0 bg-black/40 hidden z-40" onclick="togglePreview(false)"></div>
<div id="previewDrawer" class="fixed left-0 right-0 bottom-0 z-50 translate-y-full transition-transform duration-300 ease-out">
  <div class="mx-auto max-w-4xl">
    <div class="bg-white rounded-t-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <div class="font-bold text-slate-700">ğŸ“± Rich Menu é è¦½ï¼ˆç¤ºæ„ï¼‰</div>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2 text-xs text-slate-600">
            <input id="showHotspots" type="checkbox" checked> é¡¯ç¤ºç†±å€æ¡†
          </label>
          <button class="px-3 py-1.5 rounded bg-slate-200 text-slate-700 text-sm hover:bg-slate-300" onclick="togglePreview(false)">æ”¶èµ·</button>
        </div>
      </div>
      <div class="p-4 bg-slate-50">
        <div class="mx-auto w-[390px] max-w-full">
          <div class="rounded-[26px] border-4 border-slate-900 bg-slate-900 p-2">
            <div class="rounded-[20px] bg-white overflow-hidden">
              <div class="bg-slate-100 text-xs text-slate-600 px-3 py-2 border-b flex items-center justify-between">
                <span id="chatBarTextPreview">é¸å–®</span>
                <span class="text-[11px] text-slate-500">ï¼ˆåƒ…ç¤ºæ„ï¼‰</span>
              </div>
              <div class="p-3">
                <div class="relative rounded-lg overflow-hidden border bg-white">
                  <img id="phoneImg" class="w-full h-[230px] object-cover bg-gray-100">
                  <div id="phoneHotspots" class="absolute inset-0"></div>
                </div>
                <div class="mt-2 text-[11px] text-slate-500">é»ç†±å€æœƒé¡¯ç¤ºã€Œå°‡é€å‡ºæ–‡å­—ã€</div>
              </div>
            </div>
          </div>

          <div class="mt-3 flex gap-2">
            <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreview(false)">æ”¶èµ·</button>
            <button class="flex-1 px-3 py-2 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700" onclick="refreshPhonePreview()">é‡æ–°æ¸²æŸ“</button>
          </div>
        </div>
      </div>
      <div class="px-4 py-3 bg-white border-t text-xs text-slate-500">
        chatBarTextï¼ˆåº•éƒ¨é¡¯ç¤ºæ–‡å­—ï¼‰æœƒè·Ÿã€Œæª”æ¡ˆåç¨±ã€åŒæ­¥ã€‚
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<script>
/* ========= DOM ========= */
const $ = (id)=>document.getElementById(id);

const workerUrlEl = $("workerUrl");
const keywordEl   = $("keyword");
const fileNameEl  = $("fileName");
const statusEl    = $("status");

const liffStateEl = $("liffState");
const userNameEl  = $("userName");
const userIdEl    = $("userId");

const panelEl     = $("panel");
const workspaceEl = $("workspace");
const stageEl     = $("stage");

const artboardEl  = $("artboard");
const imgLayerEl  = $("imgLayer");
const imgEl       = $("img");
const safeEl      = $("safe");

const hotspotLayerEl = $("hotspotLayer");
const drawLayerEl    = $("drawLayer");
const areaListEl     = $("areaList");
const areaEmptyEl    = $("areaEmpty");
const hsCountEl      = $("hsCount");
const zoomLabelEl    = $("zoomLabel");

$("quality").addEventListener("input", ()=> $("qVal").textContent = $("quality").value);
$("showHotspots").addEventListener("change", ()=> refreshPhonePreview());

function setStatus(msg){ statusEl.textContent = "ç‹€æ…‹ï¼š" + msg; }
function normalizeWorkerUrl(raw){
  let s = (raw||"").trim();
  if(!s) return "";
  if(!/^https?:\/\//i.test(s)) s = "https://" + s;
  return s.replace(/\/+$/,'');
}
async function postJSON(url, data){
  const res = await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data) });
  const t = await res.text();
  let j = t;
  try{ j = JSON.parse(t); }catch{}
  if(!res.ok) throw new Error(`HTTP ${res.status}\n${t}`);
  return j;
}
async function uploadToR2(workerBaseUrl, blob, filename){
  const form = new FormData();
  form.append("file", blob, filename || "richmenu.jpg");
  const res = await fetch(workerBaseUrl + "/upload", { method:"POST", body: form });
  const t = await res.text();
  let j = t;
  try{ j = JSON.parse(t); }catch{}
  if(!res.ok) throw new Error(`HTTP ${res.status}\n${t}`);
  if(!j.ok || !j.url) throw new Error("ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°");
  return j.url;
}
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ========= state ========= */
const BASE_W = 2500;
const BASE_H = 1686;

let state = {
  meta: { name:"" },
  keyword: "",
  imageUrl: "",
  crop: { tx:0, ty:0, s:1 },
  mode: "hotspot",
  hotspots: [],
  selectedId: null
};

/* ========= history ========= */
let history = [];
let historyIndex = -1;
function snap(){
  return JSON.parse(JSON.stringify({
    meta: state.meta,
    keyword: state.keyword,
    imageUrl: state.imageUrl,
    crop: state.crop,
    mode: state.mode,
    hotspots: state.hotspots,
    selectedId: state.selectedId
  }));
}
function pushHistory(){
  history = history.slice(0, historyIndex+1);
  history.push(snap());
  historyIndex++;
}
function applySnap(s){
  state.meta = s.meta;
  state.keyword = s.keyword;
  state.imageUrl = s.imageUrl;
  state.crop = s.crop;
  state.mode = s.mode;
  state.hotspots = s.hotspots;
  state.selectedId = s.selectedId;

  keywordEl.value = state.keyword || "";
  fileNameEl.value = state.meta?.name || "";
  imgEl.src = state.imageUrl || "";

  applyCropTransform();
  renderAll();
  renderModeBadge();
}
function undo(){ if(historyIndex<=0) return; historyIndex--; applySnap(history[historyIndex]); }
function redo(){ if(historyIndex>=history.length-1) return; historyIndex++; applySnap(history[historyIndex]); }

/* ========= view (pan/zoom) ========= */
let view = { x:0, y:0, z:1 };
function updateStageTransform(){
  stageEl.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.z})`;
  zoomLabelEl.textContent = Math.round(view.z*100) + "%";
}
function resetView(){ view={x:0,y:0,z:1}; updateStageTransform(); }
function zoomBy(factor, cx=null, cy=null){
  const oldZ=view.z;
  const newZ=Math.min(4, Math.max(0.2, oldZ*factor));
  if(cx!=null && cy!=null){
    const rect=workspaceEl.getBoundingClientRect();
    const ax=cx-rect.left, ay=cy-rect.top;
    const dx=ax-(rect.width/2), dy=ay-(rect.height/2);
    view.x=(view.x-dx)*(newZ/oldZ)+dx;
    view.y=(view.y-dy)*(newZ/oldZ)+dy;
  }
  view.z=newZ; updateStageTransform();
}
function fitToScreen(){
  const wr=workspaceEl.getBoundingClientRect();
  const pad=140;
  const maxW=Math.max(200, wr.width-pad);
  const maxH=Math.max(200, wr.height-pad);
  const z=Math.min(3, Math.max(0.12, Math.min(maxW/BASE_W, maxH/BASE_H)));
  view={x:0,y:0,z}; updateStageTransform();
}

/* ========= panel ========= */
let panelCollapsed=false;
function togglePanel(){ panelCollapsed=!panelCollapsed; panelEl.classList.toggle("hidden", panelCollapsed); }

/* ========= artboard size fixed ========= */
function applyArtboardSize(){
  artboardEl.style.width = BASE_W + "px";
  artboardEl.style.height = BASE_H + "px";
  // safe guide
  safeEl.innerHTML="";
  const m=24;
  const box=document.createElement("div");
  box.style.position="absolute";
  box.style.left=m+"px"; box.style.top=m+"px";
  box.style.right=m+"px"; box.style.bottom=m+"px";
  box.style.border="2px dashed rgba(15,23,42,.20)";
  box.style.borderRadius="12px";
  safeEl.appendChild(box);
}

/* ========= mode ========= */
function setMode(mode){
  state.mode=mode;
  imgLayerEl.style.cursor = (mode==="crop") ? "grab" : "default";
  pushHistory();
  renderModeBadge();
}
function renderModeBadge(){
  setStatus(state.mode==="crop"
    ? "è£åˆ‡æ¨¡å¼ï¼šæ‹–åœ–ç‰‡æ±ºå®šè£åˆ‡ä½ç½®ï¼ˆAlt+æ»¾è¼ªç¸®æ”¾åœ–ç‰‡ï¼‰"
    : "ç†±å€æ¨¡å¼ï¼šæ‹–æ›³æ–°å¢æ¡†ï¼›é¸å–æ¡†å¯æ‹–ç§»/æ‹‰è§’ç¸®æ”¾");
}

/* ========= crop ========= */
function applyCropTransform(){
  const t=state.crop;
  imgEl.style.transform = `translate(calc(-50% + ${t.tx}px), calc(-50% + ${t.ty}px)) scale(${t.s})`;
}

/* ========= hotspots ========= */
function uid(){ return "hs_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function selectHotspot(id){ state.selectedId=id; renderHotspots(); renderList(); }
function addHotspot(nx,ny,nw,nh){
  const id=uid();
  state.hotspots.push({id,x:nx,y:ny,w:nw,h:nh,text:""});
  state.selectedId=id;
  pushHistory(); renderAll();
}
function deleteSelected(){
  if(!state.selectedId) return;
  const i=state.hotspots.findIndex(h=>h.id===state.selectedId);
  if(i>=0){
    state.hotspots.splice(i,1);
    state.selectedId=null;
    pushHistory(); renderAll();
  }
}

function renderHotspots(){
  hotspotLayerEl.innerHTML="";
  state.hotspots.forEach((h,idx)=>{
    const d=document.createElement("div");
    d.className="hotspot"+(h.id===state.selectedId?" selected":"");
    d.style.left=(h.x*100)+"%";
    d.style.top=(h.y*100)+"%";
    d.style.width=(h.w*100)+"%";
    d.style.height=(h.h*100)+"%";
    d.textContent=(idx+1);

    d.addEventListener("mousedown",(ev)=>{
      ev.stopPropagation();
      if(state.mode!=="hotspot") return;
      selectHotspot(h.id);
      beginDragHotspot(ev,h.id,"move");
    });
    d.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectHotspot(h.id); });

    if(h.id===state.selectedId && state.mode==="hotspot"){
      ["nw","ne","sw","se"].forEach(pos=>{
        const hd=document.createElement("div");
        hd.className="handle "+pos;
        hd.addEventListener("mousedown",(ev)=>{ ev.stopPropagation(); beginDragHotspot(ev,h.id,pos); });
        d.appendChild(hd);
      });
    }
    hotspotLayerEl.appendChild(d);
  });
  hsCountEl.textContent=state.hotspots.length+" å€‹";
}

function renderList(){
  areaListEl.innerHTML="";
  areaEmptyEl.classList.toggle("hidden", state.hotspots.length!==0);

  state.hotspots.forEach((h,idx)=>{
    const row=document.createElement("div");
    row.className="border rounded-lg p-2 bg-white";
    const selected=(h.id===state.selectedId);

    row.innerHTML=`
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-sm ${selected?'text-indigo-700':'text-slate-700'}">æ¡† ${idx+1}</div>
        <div class="flex items-center gap-2">
          <button class="text-xs ${selected?'text-indigo-700':'text-slate-500'} underline">é¸å–</button>
          <button class="text-xs text-red-600 underline">åˆªé™¤</button>
        </div>
      </div>
      <div class="text-xs text-slate-500 mb-1">é»æ­¤æ¡†é€å‡ºæ–‡å­—ï¼š</div>
      <input class="w-full border rounded px-2 py-2 text-sm font-bold"
        placeholder="ä¾‹å¦‚ï¼šMENU_SHOP / MENU_CALENDAR / MENU_NUTRITION"
        value="${escapeHtml(h.text)}">
    `;

    const btnSelect=row.querySelectorAll("button")[0];
    const btnDel=row.querySelectorAll("button")[1];
    const input=row.querySelector("input");

    btnSelect.onclick=()=>selectHotspot(h.id);
    btnDel.onclick=()=>{
      if(confirm(`åˆªé™¤æ¡† ${idx+1}ï¼Ÿ`)){
        const i=state.hotspots.findIndex(x=>x.id===h.id);
        if(i>=0){
          state.hotspots.splice(i,1);
          if(state.selectedId===h.id) state.selectedId=null;
          pushHistory(); renderAll();
        }
      }
    };
    input.oninput=()=>{ h.text=input.value; refreshPhonePreview(); };
    input.onblur=()=>pushHistory();

    areaListEl.appendChild(row);
  });
}

function renderAll(){
  applyCropTransform();
  renderHotspots();
  renderList();
  refreshPhonePreview();
}

/* ========= drawing new rect ========= */
let drawing=false;
let drawStart={x:0,y:0};
let drawRectEl=null;

function getPointInArtboard(ev){
  const r=artboardEl.getBoundingClientRect();
  return { px: ev.clientX-r.left, py: ev.clientY-r.top, r };
}

drawLayerEl.addEventListener("mousedown",(ev)=>{
  if(state.mode!=="hotspot") return;
  if(!state.imageUrl) return alert("è«‹å…ˆé¸æ“‡åœ–ç‰‡ä¸¦è¼¸å‡ºä¸Šå‚³");
  const p=getPointInArtboard(ev);
  drawing=true;
  drawStart={x:p.px,y:p.py};

  drawRectEl=document.createElement("div");
  drawRectEl.className="draw-rect";
  drawRectEl.style.left=drawStart.x+"px";
  drawRectEl.style.top=drawStart.y+"px";
  drawRectEl.style.width="0px";
  drawRectEl.style.height="0px";
  drawLayerEl.appendChild(drawRectEl);

  state.selectedId=null;
  renderHotspots();
});

window.addEventListener("mousemove",(ev)=>{
  if(!drawing || !drawRectEl) return;
  const r=artboardEl.getBoundingClientRect();
  const cx=ev.clientX-r.left;
  const cy=ev.clientY-r.top;
  const x=Math.min(drawStart.x,cx);
  const y=Math.min(drawStart.y,cy);
  const w=Math.abs(cx-drawStart.x);
  const h=Math.abs(cy-drawStart.y);
  drawRectEl.style.left=x+"px";
  drawRectEl.style.top=y+"px";
  drawRectEl.style.width=w+"px";
  drawRectEl.style.height=h+"px";
});

window.addEventListener("mouseup",()=>{
  if(!drawing) return;
  drawing=false;
  if(!drawRectEl) return;

  const rect=drawRectEl.getBoundingClientRect();
  drawRectEl.remove(); drawRectEl=null;

  const ab=artboardEl.getBoundingClientRect();
  const x=rect.left-ab.left;
  const y=rect.top-ab.top;
  const w=rect.width;
  const h=rect.height;

  if(w<24 || h<24) return;

  addHotspot(x/ab.width, y/ab.height, w/ab.width, h/ab.height);
});

/* ========= drag/resize hotspot ========= */
let drag=null;
function beginDragHotspot(ev,id,kind){
  const h=state.hotspots.find(x=>x.id===id);
  if(!h) return;
  const ab=artboardEl.getBoundingClientRect();
  drag={id,kind,ab,startMouse:{x:ev.clientX,y:ev.clientY},startBox:{x:h.x,y:h.y,w:h.w,h:h.h}};
  window.addEventListener("mousemove",onDragHotspot);
  window.addEventListener("mouseup",endDragHotspot,{once:true});
}
function onDragHotspot(ev){
  if(!drag) return;
  const h=state.hotspots.find(x=>x.id===drag.id);
  if(!h) return;

  const dx=(ev.clientX-drag.startMouse.x)/drag.ab.width;
  const dy=(ev.clientY-drag.startMouse.y)/drag.ab.height;

  let nx=drag.startBox.x, ny=drag.startBox.y, nw=drag.startBox.w, nh=drag.startBox.h;
  const min=0.02;

  if(drag.kind==="move"){
    nx=drag.startBox.x+dx;
    ny=drag.startBox.y+dy;
  }else{
    if(drag.kind.includes("n")){ ny=drag.startBox.y+dy; nh=drag.startBox.h-dy; }
    if(drag.kind.includes("s")){ nh=drag.startBox.h+dy; }
    if(drag.kind.includes("w")){ nx=drag.startBox.x+dx; nw=drag.startBox.w-dx; }
    if(drag.kind.includes("e")){ nw=drag.startBox.w+dx; }
  }

  nw=Math.max(min,nw); nh=Math.max(min,nh);
  nx=Math.min(1-nw, Math.max(0,nx));
  ny=Math.min(1-nh, Math.max(0,ny));

  h.x=nx; h.y=ny; h.w=nw; h.h=nh;
  renderHotspots(); refreshPhonePreview();
}
function endDragHotspot(){
  window.removeEventListener("mousemove",onDragHotspot);
  drag=null;
  pushHistory(); renderList();
}

/* ========= crop drag image ========= */
let cropDrag=null;
imgLayerEl.addEventListener("mousedown",(ev)=>{
  if(state.mode!=="crop") return;
  if(!state.imageUrl) return;
  cropDrag={startMouse:{x:ev.clientX,y:ev.clientY},start:{tx:state.crop.tx,ty:state.crop.ty}};
  imgLayerEl.style.cursor="grabbing";
  window.addEventListener("mousemove",onCropDrag);
  window.addEventListener("mouseup",endCropDrag,{once:true});
});
function onCropDrag(ev){
  if(!cropDrag) return;
  const dx=ev.clientX-cropDrag.startMouse.x;
  const dy=ev.clientY-cropDrag.startMouse.y;
  state.crop.tx=cropDrag.start.tx+dx;
  state.crop.ty=cropDrag.start.ty+dy;
  applyCropTransform();
}
function endCropDrag(){
  window.removeEventListener("mousemove",onCropDrag);
  imgLayerEl.style.cursor="grab";
  cropDrag=null;
  pushHistory();
}

/* ========= pan/zoom ========= */
let isSpaceDown=false;
let panning=false;
let panStart={x:0,y:0,vx:0,vy:0};

window.addEventListener("keydown",(ev)=>{
  if(ev.code==="Space"){ isSpaceDown=true; ev.preventDefault(); }

  if(ev.ctrlKey && !ev.shiftKey && ev.key.toLowerCase()==="z"){ ev.preventDefault(); undo(); return; }
  if((ev.ctrlKey && ev.key.toLowerCase()==="y") || (ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase()==="z")){
    ev.preventDefault(); redo(); return;
  }
  if(ev.key==="Delete"){ ev.preventDefault(); deleteSelected(); }
  if(ev.key==="Escape"){ state.selectedId=null; renderHotspots(); renderList(); }
});
window.addEventListener("keyup",(ev)=>{ if(ev.code==="Space") isSpaceDown=false; });

workspaceEl.addEventListener("mousedown",(ev)=>{
  if(isSpaceDown && ev.button===0){
    panning=true;
    panStart={x:ev.clientX,y:ev.clientY,vx:view.x,vy:view.y};
    window.addEventListener("mousemove",onPanMove);
    window.addEventListener("mouseup",endPan,{once:true});
  }
});
function onPanMove(ev){
  if(!panning) return;
  view.x=panStart.vx+(ev.clientX-panStart.x);
  view.y=panStart.vy+(ev.clientY-panStart.y);
  updateStageTransform();
}
function endPan(){
  window.removeEventListener("mousemove",onPanMove);
  panning=false;
}

workspaceEl.addEventListener("wheel",(ev)=>{
  if(ev.ctrlKey){
    ev.preventDefault();
    const factor=ev.deltaY<0?1.08:1/1.08;
    zoomBy(factor,ev.clientX,ev.clientY);
    return;
  }
  // crop mode image zoom: Alt+wheel
  if(state.mode==="crop" && ev.altKey){
    ev.preventDefault();
    const factor=ev.deltaY<0?1.06:1/1.06;
    state.crop.s=Math.min(6, Math.max(0.2, state.crop.s*factor));
    applyCropTransform();
    pushHistory();
    return;
  }
},{passive:false});

/* ========= preview ========= */
function togglePreview(open){
  const overlay=$("drawerOverlay");
  const drawer=$("previewDrawer");
  if(open){
    overlay.classList.remove("hidden");
    drawer.classList.remove("translate-y-full");
    refreshPhonePreview();
  }else{
    overlay.classList.add("hidden");
    drawer.classList.add("translate-y-full");
  }
}
function refreshPhonePreview(){
  const img=$("phoneImg");
  const wrap=$("phoneHotspots");
  $("chatBarTextPreview").textContent = (state.meta?.name || "é¸å–®").slice(0,14);

  if(!state.imageUrl){
    img.src=""; wrap.innerHTML=""; return;
  }
  img.src=state.imageUrl;
  wrap.innerHTML="";

  requestAnimationFrame(()=>{
    const show=$("showHotspots").checked;
    const r=wrap.getBoundingClientRect();
    if(!r.width || !r.height) return;

    state.hotspots.forEach((h,i)=>{
      if(show){
        const box=document.createElement("div");
        box.style.position="absolute";
        box.style.left=(h.x*r.width)+"px";
        box.style.top=(h.y*r.height)+"px";
        box.style.width=(h.w*r.width)+"px";
        box.style.height=(h.h*r.height)+"px";
        box.style.border="2px solid rgba(239,68,68,.9)";
        box.style.background="rgba(239,68,68,.10)";
        box.style.borderRadius="10px";
        wrap.appendChild(box);
      }
      const btn=document.createElement("button");
      btn.style.position="absolute";
      btn.style.left=(h.x*100)+"%";
      btn.style.top=(h.y*100)+"%";
      btn.style.width=(h.w*100)+"%";
      btn.style.height=(h.h*100)+"%";
      btn.style.background="transparent";
      btn.onclick=()=>{
        const t=(h.text||"").trim();
        alert(`ç†±å€ ${i+1}\nå°‡é€å‡ºï¼š${t||"ï¼ˆå°šæœªå¡«ï¼‰"}`);
      };
      wrap.appendChild(btn);
    });
  });
}

/* ========= image pick + export crop to 2500x1686 ========= */
let sourceFile=null;

async function pickImage(){
  const input=$("fileInput");
  input.value="";
  input.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file) return;
    sourceFile=file;

    // show local preview first
    const url=URL.createObjectURL(file);
    state.imageUrl=url;
    imgEl.src=url;
    state.crop={tx:0,ty:0,s:1};
    state.hotspots=[];
    state.selectedId=null;
    pushHistory();
    renderAll();
    fitToScreen();
    setStatus("å·²é¸æ“‡åœ–ç‰‡ï¼ˆè«‹é€²è£åˆ‡æ¨¡å¼èª¿æ•´ï¼Œç„¶å¾Œè¼¸å‡ºä¸Šå‚³ï¼‰");
  };
  input.click();
}

async function exportCropAndUpload(){
  const base=normalizeWorkerUrl(workerUrlEl.value);
  if(!base) return alert("Worker URL ç©ºç™½ï¼ˆè«‹å›é¦–é å…ˆå¡«ä¸€æ¬¡ï¼‰");
  if(!state.imageUrl) return alert("æ²’æœ‰åœ–ç‰‡");
  localStorage.setItem(LS_WORKER, base);

  try{
    setStatus("è¼¸å‡º 2500Ã—1686 + ä¸Šå‚³ä¸­...");

    // load image from current imageUrl (blob url or remote)
    const im = await new Promise((resolve,reject)=>{
      const x=new Image();
      x.crossOrigin="anonymous";
      x.onload=()=>resolve(x);
      x.onerror=()=>reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼ˆå¯èƒ½ CORS / blob å¤±æ•ˆï¼‰"));
      x.src=state.imageUrl;
    });

    const W=BASE_W, H=BASE_H;
    const canvas=document.createElement("canvas");
    canvas.width=W; canvas.height=H;
    const ctx=canvas.getContext("2d");

    // white bg
    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,W,H);

    // cover scale
    const sCover=Math.max(W/im.naturalWidth, H/im.naturalHeight);
    const s=sCover*state.crop.s;

    const dw=im.naturalWidth*s;
    const dh=im.naturalHeight*s;

    const cx=W/2+state.crop.tx;
    const cy=H/2+state.crop.ty;
    const dx=cx-dw/2;
    const dy=cy-dh/2;

    ctx.drawImage(im, dx, dy, dw, dh);

    // Rich Menu: JPEG only
    const q=parseFloat($("quality").value);
    const outBlob=await new Promise(res=>canvas.toBlob(res,"image/jpeg",q));
    if(!outBlob) throw new Error("è¼¸å‡ºå¤±æ•—ï¼ˆtoBlob ç©ºï¼‰");

    const filename = `richmenu_${Date.now()}_${W}x${H}.jpg`;
    const url = await uploadToR2(base, outBlob, filename);

    // replace imageUrl to R2 public URL, reset crop (baked)
    state.imageUrl=url;
    imgEl.src=url;
    state.crop={tx:0,ty:0,s:1};
    applyCropTransform();

    pushHistory();
    renderAll();
    setStatus("ä¸Šå‚³å®Œæˆ âœ…ï¼ˆå·²æ˜¯ 2500Ã—1686 JPEGï¼Œå¯ç›´æ¥ç•«ç†±å€/å„²å­˜ï¼‰");
    togglePreview(true);

  }catch(err){
    setStatus("è¼¸å‡º/ä¸Šå‚³å¤±æ•—");
    alert("è¼¸å‡º/ä¸Šå‚³å¤±æ•—ï¼š\n"+err.message);
  }
}

/* ========= KV save/load (use your existing /save /load) ========= */
function buildRichMenuPayload(){
  if(!state.imageUrl) throw new Error("å°šæœªæœ‰åœ–ç‰‡ï¼ˆè«‹å…ˆè¼¸å‡ºä¸Šå‚³ï¼‰");
  if(state.hotspots.length===0) throw new Error("å°šæœªæ–°å¢ç†±å€");
  if(state.hotspots.some(h=>!String(h.text||"").trim())) throw new Error("æœ‰ç†±å€æ²’æœ‰å¡«å…§å®¹");

  const chatBarText = (state.meta?.name || "é¸å–®").slice(0,14);

  const areas = state.hotspots.map(h=>({
    bounds:{
      x: Math.round(h.x*BASE_W),
      y: Math.round(h.y*BASE_H),
      width: Math.round(h.w*BASE_W),
      height: Math.round(h.h*BASE_H)
    },
    action:{
      type:"message",
      text: h.text.trim()
    }
  }));

  const richMenu = {
    size:{ width: BASE_W, height: BASE_H },
    selected: true,
    name: (state.meta?.name || "RichMenu").slice(0,300),
    chatBarText,
    areas
  };

  return {
    mode:"richmenu",
    meta:{ name: state.meta?.name || "" },
    imageUrl: state.imageUrl,
    richMenu
  };
}

async function saveKV(){
  const base=normalizeWorkerUrl(workerUrlEl.value);
  const keyword=(keywordEl.value||"").trim();
  const name=(fileNameEl.value||"").trim();

  if(!base || !keyword) return alert("è«‹ç¢ºèª Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem(LS_WORKER, base);

  try{
    state.keyword=keyword;
    state.meta.name=name;

    const payload = buildRichMenuPayload();
    await postJSON(base+"/save", { keyword, payload });

    pushHistory();
    setStatus("å„²å­˜æˆåŠŸ âœ…ï¼ˆKV å·²å­˜ richmenuï¼‰");
    alert("å„²å­˜æˆåŠŸï¼\nKV keyï¼š"+keyword+"\nchatBarTextï¼ˆåº•éƒ¨æ–‡å­—ï¼‰ï¼š"+(payload.richMenu.chatBarText));
    refreshSavedList();
  }catch(e){
    setStatus("å„²å­˜å¤±æ•—");
    alert("å„²å­˜å¤±æ•—ï¼š\n"+e.message);
  }
}

async function loadKV(){
  const base=normalizeWorkerUrl(workerUrlEl.value);
  const keyword=(keywordEl.value||"").trim();
  if(!base || !keyword) return alert("è«‹ç¢ºèª Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem(LS_WORKER, base);

  try{
    const data=await postJSON(base+"/load", { keyword });
    const obj=(typeof data==="string")?JSON.parse(data):data;
    if(!obj || obj.mode!=="richmenu" || !obj.richMenu) throw new Error("é€™ç­†ä¸æ˜¯ richmenu æ ¼å¼");

    state.keyword=keyword;
    state.meta=obj.meta||{name:""};
    state.imageUrl=obj.imageUrl||"";
    state.crop={tx:0,ty:0,s:1};

    const rm=obj.richMenu;
    const areas=rm.areas||[];
    state.hotspots = areas.map(a=>({
      id: uid(),
      x: (a.bounds?.x||0)/BASE_W,
      y: (a.bounds?.y||0)/BASE_H,
      w: (a.bounds?.width||0)/BASE_W,
      h: (a.bounds?.height||0)/BASE_H,
      text: a.action?.text || ""
    }));
    state.selectedId=state.hotspots[0]?.id || null;

    fileNameEl.value=state.meta?.name||"";
    imgEl.src=state.imageUrl||"";

    pushHistory();
    renderAll();
    fitToScreen();
    togglePreview(true);
    setStatus("è®€å–æˆåŠŸ âœ…");

  }catch(e){
    setStatus("è®€å–å¤±æ•—");
    alert("è®€å–å¤±æ•—ï¼š\n"+e.message);
  }
}

/* ========= saved list (requires Worker /rm/listSaved) ========= */
async function refreshSavedList(){
  const base=normalizeWorkerUrl(workerUrlEl.value);
  if(!base) return;
  try{
    const j=await postJSON(base+"/rm/listSaved", {});
    const sel=$("savedSelect");
    sel.innerHTML = `<option value="">ï¼ˆé¸æ“‡å·²å„²å­˜çš„ Rich Menuï¼‰</option>`;
    (j.items||[]).forEach(it=>{
      const opt=document.createElement("option");
      opt.value=it.key;
      const name=it.name || "";
      opt.textContent = `${it.key}${name?("ï½œ"+name):""}`;
      sel.appendChild(opt);
    });
  }catch(e){
    // ä¸æ“‹ä¸»æµç¨‹
    console.log(e);
  }
}
function loadSelectedSaved(){
  const key=$("savedSelect").value;
  if(!key) return alert("è«‹å…ˆé¸ä¸€å€‹");
  keywordEl.value=key;
  loadKV();
}

/* ========= clear ========= */
function clearAll(){
  if(!confirm("ç¢ºå®šæ¸…ç©ºåœ–ç‰‡ + å…¨éƒ¨ç†±å€ï¼Ÿ")) return;
  state.imageUrl="";
  imgEl.src="";
  state.hotspots=[];
  state.selectedId=null;
  state.crop={tx:0,ty:0,s:1};
  pushHistory();
  renderAll();
  setStatus("å·²æ¸…ç©º");
}

/* ========= LIFF (optional) ========= */
let isReady=false;
async function initLIFF(){
  try{
    const fromLS=(localStorage.getItem(LS_LIFF)||"").trim();
    if(!LIFF_ID) LIFF_ID = fromLS;

    if(!LIFF_ID){
      liffStateEl.textContent="æœªè¨­å®šï¼ˆå¯å¿½ç•¥ï¼‰";
      userNameEl.textContent="-";
      userIdEl.textContent="-";
      return;
    }

    liffStateEl.textContent="åˆå§‹åŒ–ä¸­...";
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      liffStateEl.textContent="éœ€è¦ç™»å…¥";
      liff.login();
      return;
    }

    liffStateEl.textContent = liff.isInClient() ? "LINE å…§" : "å¤–éƒ¨ç€è¦½å™¨";
    const p=await liff.getProfile();
    userNameEl.textContent=p.displayName||"-";
    userIdEl.textContent=p.userId||"-";
    isReady=true;
  }catch(e){
    liffStateEl.textContent="åˆå§‹åŒ–å¤±æ•—";
    console.log(e);
  }
}

async function sendTestToMe(){
  if(!isReady) return alert("LIFF å°šæœªå¯ç”¨ï¼ˆä½ å¯å¿½ç•¥é€™åŠŸèƒ½ï¼‰");
  if(!liff.isInClient()) return alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ‰å¯é€æ¸¬è©¦è¨Šæ¯");
  if(state.hotspots.length===0) return alert("æ²’æœ‰ç†±å€å¯æ¸¬");
  if(state.hotspots.some(h=>!String(h.text||"").trim())) return alert("æœ‰ç†±å€æ²’å¡«æ–‡å­—");

  // é€ä¸€å€‹ç°¡å–®è¨Šæ¯åˆ—å‡ºç†±å€æ–‡å­—ï¼ˆæ¸¬ action å…§å®¹ï¼‰
  const lines = state.hotspots.map((h,i)=>`#${i+1} ${h.text.trim()}`);
  await liff.sendMessages([{ type:"text", text:"RichMenu ç†±å€æ–‡å­—ï¼ˆæ¸¬è©¦ï¼‰\n"+lines.join("\n") }]);
  alert("å·²é€åˆ°èŠå¤©å®¤ âœ…");
}

/* ========= navigation ========= */
function goHome(){ window.location.href = "index.html"; }

/* ========= init ========= */
keywordEl.addEventListener("input", ()=>{ state.keyword=(keywordEl.value||"").trim(); });
fileNameEl.addEventListener("input", ()=>{
  state.meta.name=fileNameEl.value;
  refreshPhonePreview();
});

window.addEventListener("load", ()=>{
  // âœ… è‡ªå‹•å¸¶å…¥ Worker URLï¼šè·Ÿä½ é¦–é ä¸€è‡´
  const w=(localStorage.getItem(LS_WORKER)||"").trim();
  if(w) workerUrlEl.value=w;

  applyArtboardSize();
  fitToScreen();
  pushHistory();
  renderModeBadge();
  renderAll();
  refreshSavedList();
  initLIFF();
  setStatus("å°±ç·’ âœ…ï¼ˆ2500Ã—1686ï¼‰");
});
</script>

</body>
</html>
