<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å…­å®®æ ¼é¸å–®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --rail-w: 220px; --rail-w-collapsed: 76px; }
    body{ user-select:none; }
    input, textarea, select, button { user-select:auto; }

    /* æ£‹ç›¤èƒŒæ™¯ */
    .checker{
      background-image:
        linear-gradient(45deg, rgba(0,0,0,.04) 25%, transparent 25%),
        linear-gradient(-45deg, rgba(0,0,0,.04) 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, rgba(0,0,0,.04) 75%),
        linear-gradient(-45deg, transparent 75%, rgba(0,0,0,.04) 75%);
      background-size: 28px 28px;
      background-position: 0 0, 0 14px, 14px -14px, -14px 0px;
    }

    /* Artboard */
    .artboard{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%, -50%);
      background:#fff;
      border:1px solid rgba(15,23,42,.18);
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      border-radius: 14px;
      overflow:hidden;
    }

    /* å½±åƒå±¤ï¼ˆè£åˆ‡/æ‹–å‹•ï¼‰ */
    .img-layer{
      position:absolute; inset:0;
      overflow:hidden;
      background:#f8fafc;
      cursor: default;
    }
    .img-layer img{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%, -50%);
      transform-origin:center center;
      max-width:none; max-height:none;
      pointer-events:none;
      user-select:none;
    }

    /* ç†±å€ */
    .hotspot{
      position:absolute;
      border:2px solid rgba(239,68,68,.95);
      background: rgba(239,68,68,.14);
      border-radius: 12px;
      color:white;
      font-weight:900;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-shadow:0 1px 2px rgba(0,0,0,.85);
      cursor:pointer;
    }
    .hotspot.selected{
      border-color: rgba(59,130,246,.95);
      background: rgba(59,130,246,.12);
    }

    .handle{
      position:absolute;
      width:10px; height:10px;
      background:#fff;
      border:2px solid rgba(59,130,246,.95);
      border-radius: 4px;
      box-shadow:0 1px 3px rgba(0,0,0,.25);
      z-index: 10;
    }
    .handle.nw{ left:-6px; top:-6px; cursor:nwse-resize; }
    .handle.ne{ right:-6px; top:-6px; cursor:nesw-resize; }
    .handle.sw{ left:-6px; bottom:-6px; cursor:nesw-resize; }
    .handle.se{ right:-6px; bottom:-6px; cursor:nwse-resize; }

    .draw-rect{
      position:absolute;
      border:2px dashed rgba(2,6,23,.55);
      background: rgba(2,6,23,.10);
      border-radius: 12px;
      pointer-events:none;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border:1px solid rgba(0,0,0,.18);
      padding:2px 6px;
      border-radius:6px;
      background:#fff;
      font-size: 11px;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-800 overflow-hidden">

<!-- Top bar -->
<div class="h-14 bg-white border-b flex items-center justify-between px-3">
  <div class="flex items-center gap-3">
    <div class="font-extrabold text-blue-700">å…­å®®æ ¼é¸å–®</div>
    <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
      <span><span class="kbd">ç©ºç™½éµ</span>æ‹–æ›³å¹³ç§»</span>
      <span>ï½œ</span>
      <span><span class="kbd">Ctrl</span>+æ»¾è¼ªç¸®æ”¾ç•«é¢</span>
      <span>ï½œ</span>
      <span><span class="kbd">Ctrl+Z</span>/<span class="kbd">Ctrl+Y</span></span>
      <span>ï½œ</span>
      <span><span class="kbd">Delete</span> åˆªæ¡†</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="togglePreview(true)">ğŸ“± é è¦½</button>
    <button class="px-3 py-2 rounded bg-slate-700 text-white text-sm hover:bg-slate-900" onclick="window.location.href='index.html'">å›é¦–é </button>
  </div>
</div>

<div class="h-[calc(100vh-56px)] flex">

  <!-- Left rail -->
  <div id="rail" class="bg-white border-r overflow-y-auto" style="width: var(--rail-w);">
    <div class="p-3">
      <button class="w-full px-3 py-2 rounded-xl bg-slate-900 text-white flex items-center gap-2 justify-center hover:bg-black"
              onclick="toggleRail()">
        <span class="text-xl">â˜°</span>
        <span class="railText font-bold">å·¥å…·åˆ—</span>
      </button>

      <div class="mt-3 space-y-2">
        <button class="w-full px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center gap-2"
                onclick="setMode('hotspot')">
          <span class="text-xl">ğŸ”²</span><span class="railText font-bold">ç•«æ¡†</span>
        </button>

        <button class="w-full px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center gap-2"
                onclick="setMode('crop')">
          <span class="text-xl">âœ‚ï¸</span><span class="railText font-bold">è£åˆ‡</span>
        </button>

        <button class="w-full px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center gap-2"
                onclick="fitToScreen()">
          <span class="text-xl">ğŸ“</span><span class="railText font-bold">Fit</span>
        </button>

        <button class="w-full px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center gap-2"
                onclick="resetView()">
          <span class="text-xl">ğŸ”</span><span class="railText font-bold">é‡ç½®è¦–è§’</span>
        </button>
      </div>

      <!-- Settings -->
      <div class="mt-4 rounded-xl border p-3 bg-slate-50">
        <div class="font-bold text-sm mb-2 railText">è¨­å®š</div>

        <label class="text-xs text-slate-500 railText">Worker URL</label>
        <input id="workerUrl" class="mt-1 w-full border rounded px-3 py-2 bg-yellow-50 text-sm"
               placeholder="https://api.xxx.workers.dev"/>

        <div class="grid grid-cols-1 gap-2 mt-2">
          <div>
            <label class="text-xs text-slate-500 railText">è§¸ç™¼é—œéµå­—</label>
            <input id="triggerKeyword" class="mt-1 w-full border rounded px-3 py-2 text-sm font-bold border-blue-500"
                   placeholder="ä½¿ç”¨è€…è¼¸å…¥é€™å¥æœƒå‡ºç¾é¸å–®"/>
          </div>

          <div>
            <label class="text-xs text-slate-500 railText">é¸å–®åç¨±ï¼ˆ= æª”åï¼‰</label>
            <input id="fileName" class="mt-1 w-full border rounded px-3 py-2 text-sm font-bold"
                   placeholder="ä¾‹å¦‚ï¼šå…­å®®æ ¼_ä¸»é¸å–®_2026-02"/>
          </div>
        </div>

        <div id="status" class="mt-2 text-xs text-slate-500 railText">ç‹€æ…‹ï¼šæœªå°±ç·’</div>
      </div>

      <!-- Switch menu -->
      <div class="mt-3 rounded-xl border p-3">
        <div class="font-bold text-sm mb-2 railText">åˆ‡æ›é¸å–®</div>
        <div class="flex gap-2">
          <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black"
                  onclick="refreshMenuList()">åˆ·æ–°</button>
          <button class="flex-1 px-3 py-2 rounded bg-slate-200 text-slate-700 text-sm hover:bg-slate-300"
                  onclick="loadFromPicker()">è¼‰å…¥</button>
        </div>
        <select id="menuPicker" class="mt-2 w-full border rounded px-2 py-2 text-sm"></select>
        <div class="mt-2 text-[11px] text-slate-500 railText">ç”¨ DB çš„ keyword åšåˆ‡æ›ï¼ˆä¸æ”¹ç¶²å€ï¼Œä¸ç ´ä¸²è¯ï¼‰ã€‚</div>
      </div>

      <!-- Upload -->
      <div class="mt-3 rounded-xl border p-3">
        <div class="font-bold text-sm mb-2 railText">åœ–ç‰‡</div>
        <button class="w-full px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700"
                onclick="pickAndAutoUpload()">
          ä¸Šå‚³åœ–ç‰‡ï¼ˆè‡ªå‹•è£åˆ‡ 2500Ã—1686ï¼‰
        </button>
        <div class="mt-2 text-[11px] text-slate-500 railText">ä¸Šå‚³å¾Œç›´æ¥é€²å…¥ç•«æ¡†æ¨¡å¼ã€‚</div>
      </div>

      <!-- Hotspot list -->
      <div class="mt-3 rounded-xl border p-3">
        <div class="flex items-center justify-between">
          <div class="font-bold text-sm railText">æ¡†æ¸…å–®</div>
          <div id="hsCount" class="text-xs text-slate-500 railText">0</div>
        </div>
        <div id="areaEmpty" class="text-xs text-slate-400 mt-2 railText">å°šæœªæ–°å¢æ¡†ã€‚ç”¨æ»‘é¼ åœ¨åº•æ¡†å…§æ‹–æ›³å³å¯æ–°å¢ã€‚</div>
        <div id="areaList" class="space-y-2 mt-2"></div>

        <div class="mt-3 flex gap-2">
          <button class="flex-1 px-3 py-2 rounded bg-gray-600 text-white text-sm hover:bg-gray-700" onclick="loadConfig()">è®€å–</button>
          <button class="flex-1 px-3 py-2 rounded bg-green-600 text-white text-sm hover:bg-green-700" onclick="saveConfig()">å„²å­˜</button>
        </div>
      </div>

      <div class="py-6 text-[11px] text-slate-400 railText">
        åªä¿ç•™å¿…è¦æ“ä½œï¼šä¸Šå‚³ â†’ ç•«æ¡† â†’ å„²å­˜ã€‚
      </div>
    </div>
  </div>

  <!-- Workspace -->
  <div class="flex-1 relative checker overflow-hidden" id="workspace">
    <!-- zoom HUD -->
    <div class="absolute top-3 right-3 z-20 flex items-center gap-2 bg-white/90 backdrop-blur border rounded-xl px-2 py-1 shadow">
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1.1)">ï¼‹</button>
      <div class="w-16 text-center text-sm font-bold" id="zoomLabel">100%</div>
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1/1.1)">ï¼</button>
      <button class="px-2 py-1 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="fitToScreen()">Fit</button>
    </div>

    <div id="stage" class="absolute inset-0">
      <div id="artboard" class="artboard">
        <div id="imgLayer" class="img-layer">
          <img id="img" alt="">
        </div>
        <div id="hotspotLayer" class="absolute inset-0"></div>
        <div id="drawLayer" class="absolute inset-0"></div>
      </div>
    </div>

    <div class="absolute left-3 bottom-3 z-20 bg-white/90 backdrop-blur border rounded-xl px-3 py-2 shadow text-xs text-slate-600">
      <div class="font-bold mb-1">æç¤º</div>
      <div class="space-y-1">
        <div>â€¢ ç•«æ¡†ï¼šæ‹–æ›³æ–°å¢ï¼›é»æ¡†é¸å–ï¼›æ‹–ç§»/æ‹‰è§’ç¸®æ”¾</div>
        <div>â€¢ è£åˆ‡ï¼šæ‹–åœ–ç‰‡èª¿ä½ç½®ï¼ˆåªå½±éŸ¿é è¦½ï¼Œä¸å½±éŸ¿å·²ä¸Šå‚³çš„è£åˆ‡çµæœï¼‰</div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Drawer -->
<div id="drawerOverlay" class="fixed inset-0 bg-black/40 hidden z-40" onclick="togglePreview(false)"></div>
<div id="previewDrawer" class="fixed left-0 right-0 bottom-0 z-50 translate-y-full transition-transform duration-300 ease-out">
  <div class="mx-auto max-w-4xl">
    <div class="bg-white rounded-t-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <div class="font-bold text-slate-700">ğŸ“± æ‰‹æ©Ÿé è¦½</div>
        <button class="px-3 py-1.5 rounded bg-slate-200 text-slate-700 text-sm hover:bg-slate-300"
                onclick="togglePreview(false)">æ”¶èµ·</button>
      </div>
      <div class="p-4 bg-slate-50">
        <div class="mx-auto w-[360px] max-w-full">
          <div class="rounded-[26px] border-4 border-slate-900 bg-slate-900 p-2">
            <div class="rounded-[20px] bg-white overflow-hidden">
              <div class="p-3">
                <div class="relative rounded-lg overflow-hidden border bg-white">
                  <img id="phoneImg" class="w-full h-[240px] object-cover bg-gray-100">
                  <div id="phoneHotspots" class="absolute inset-0"></div>
                </div>
                <div class="mt-2 text-[11px] text-slate-500">é»æ¡†æœƒæç¤ºé€å‡ºçš„é—œéµå­—ï¼ˆæ¨¡æ“¬ï¼‰</div>
              </div>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black"
                    onclick="togglePreview(false)">æ”¶èµ·</button>
            <button class="flex-1 px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700"
                    onclick="refreshPhonePreview()">é‡æ–°æ¸²æŸ“</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<script>
/* ========= DOM ========= */
const $ = (id) => document.getElementById(id);
const workerUrlEl = $("workerUrl");
const triggerEl = $("triggerKeyword");
const fileNameEl = $("fileName");
const statusEl = $("status");



const railEl = $("rail");
const workspaceEl = $("workspace");
const stageEl = $("stage");
const artboardEl = $("artboard");
const imgLayerEl = $("imgLayer");
const imgEl = $("img");
const hotspotLayerEl = $("hotspotLayer");
const drawLayerEl = $("drawLayer");
const areaListEl = $("areaList");
const areaEmptyEl = $("areaEmpty");
const hsCountEl = $("hsCount");
const zoomLabelEl = $("zoomLabel");

const TARGET_W = 2500;
const TARGET_H = 1686;

/* ========= helpers ========= */
function normalizeWorkerUrl(raw){
  if(!raw) return "";
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = "https://" + s;
  return s.replace(/\/+$/,'');
}
function setStatus(msg){ statusEl.textContent = "ç‹€æ…‹ï¼š" + msg; }

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

async function postJSON(url, data){
  const res = await fetch(url, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const ct = res.headers.get("content-type") || "";
  return ct.includes("json") ? res.json() : res.text();
}

async function uploadToR2(workerBaseUrl, fileBlob, filename){
  const form = new FormData();
  form.append("file", fileBlob, filename || "image.webp");
  const res = await fetch(workerBaseUrl + "/upload", { method:"POST", body: form });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const j = await res.json();
  if(!j.ok || !j.url) throw new Error("ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°");
  return j.url;
}

/* ========= state ========= */
let state = {
  meta: { name: "" },
  triggerKeyword: "",
  imageUrl: "",
  frame: { w: TARGET_W, h: TARGET_H },
  mode: "hotspot",              // hotspot | crop
  crop: { tx: 0, ty: 0, s: 1 }, // åªç”¨æ–¼ã€Œç•«é¢å…§æ‹–å‹•é è¦½ã€
  hotspots: [],                 // normalized [0..1]
  selectedId: null
};

/* ========= history ========= */
let history = [];
let historyIndex = -1;

function cloneForHistory(s){
  return JSON.parse(JSON.stringify({
    meta: s.meta,
    triggerKeyword: s.triggerKeyword,
    imageUrl: s.imageUrl,
    frame: s.frame,
    mode: s.mode,
    crop: s.crop,
    hotspots: s.hotspots,
    selectedId: s.selectedId
  }));
}
function pushHistory(){
  const snap = cloneForHistory(state);
  history = history.slice(0, historyIndex + 1);
  history.push(snap);
  historyIndex++;
}
function applyHistorySnap(snap){
  state = JSON.parse(JSON.stringify(snap));
  triggerEl.value = state.triggerKeyword || "";
  fileNameEl.value = (state.meta?.name || "");
  setMode(state.mode, true);
  setImageUrl(state.imageUrl, true);
  applyFrameSize();
  renderAll();
}
function undo(){
  if(historyIndex <= 0) return;
  historyIndex--;
  applyHistorySnap(history[historyIndex]);
}
function redo(){
  if(historyIndex >= history.length - 1) return;
  historyIndex++;
  applyHistorySnap(history[historyIndex]);
}

/* ========= view (pan/zoom) ========= */
let view = { x: 0, y: 0, z: 1 };
function updateStageTransform(){
  stageEl.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.z})`;
  zoomLabelEl.textContent = Math.round(view.z * 100) + "%";
}
function resetView(){
  view = { x: 0, y: 0, z: 1 };
  updateStageTransform();
}
function zoomBy(factor, anchorClientX=null, anchorClientY=null){
  const oldZ = view.z;
  const newZ = Math.min(4, Math.max(0.2, oldZ * factor));

  if(anchorClientX != null && anchorClientY != null){
    const rect = workspaceEl.getBoundingClientRect();
    const ax = anchorClientX - rect.left;
    const ay = anchorClientY - rect.top;
    const dx = ax - (rect.width/2);
    const dy = ay - (rect.height/2);
    view.x = (view.x - dx) * (newZ/oldZ) + dx;
    view.y = (view.y - dy) * (newZ/oldZ) + dy;
  }
  view.z = newZ;
  updateStageTransform();
}
function fitToScreen(){
  const wr = workspaceEl.getBoundingClientRect();
  const pad = 120;
  const maxW = Math.max(200, wr.width - pad);
  const maxH = Math.max(200, wr.height - pad);

  const abW = state.frame.w;
  const abH = state.frame.h;
  const z = Math.min(3, Math.max(0.08, Math.min(maxW/abW, maxH/abH)));

  view.z = z;
  view.x = 0; view.y = 0;
  updateStageTransform();
}

/* ========= rail collapse ========= */
let railCollapsed = false;
function toggleRail(){
  railCollapsed = !railCollapsed;
  railEl.style.width = railCollapsed ? "var(--rail-w-collapsed)" : "var(--rail-w)";
  document.querySelectorAll(".railText").forEach(el=>{
    el.style.display = railCollapsed ? "none" : "";
  });
}

/* ========= frame size ========= */
function applyFrameSize(){
  artboardEl.style.width = state.frame.w + "px";
  artboardEl.style.height = state.frame.h + "px";
}

/* ========= mode ========= */
function setMode(mode, silent=false){
  state.mode = mode;
  imgLayerEl.style.cursor = (mode === "crop") ? "grab" : "default";
  if(!silent) pushHistory();
  setStatus(mode === "crop" ? "è£åˆ‡ï¼šæ‹–åœ–ç‰‡èª¿ä½ç½®" : "ç•«æ¡†ï¼šæ‹–æ›³æ–°å¢ / é¸å–å¯èª¿æ•´");
}

/* ========= image / crop ========= */
function setImageUrl(url, silent=false){
  state.imageUrl = url || "";
  imgEl.src = state.imageUrl || "";
  if(!silent) pushHistory();
  refreshPhonePreview();
}
function applyCropTransform(){
  const t = state.crop;
  imgEl.style.transform = `translate(calc(-50% + ${t.tx}px), calc(-50% + ${t.ty}px)) scale(${t.s})`;
}

/* ========= hotspot ========= */
function uid(){ return "hs_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

function selectHotspot(id){
  state.selectedId = id;
  renderHotspots();
  renderHotspotList();
}
function addHotspot(nx, ny, nw, nh){
  const id = uid();
  state.hotspots.push({ id, x:nx, y:ny, w:nw, h:nh, text:"" });
  state.selectedId = id;
  pushHistory();
  renderAll();
}
function deleteSelected(){
  if(!state.selectedId) return;
  const i = state.hotspots.findIndex(h => h.id === state.selectedId);
  if(i >= 0){
    state.hotspots.splice(i,1);
    state.selectedId = null;
    pushHistory();
    renderAll();
  }
}

/* ========= IMPORTANT: æ­£ç¢ºåº§æ¨™è½‰æ›ï¼ˆä¿®æ­£ä½ èªªçš„ç¸®æ”¾åç§»ï¼‰ =========
æŠŠ clientX/Y -> workspace -> stage(unscaled) -> artboard local px
*/
function clientToArtboard(ev){
  const wr = workspaceEl.getBoundingClientRect();
  const sx = ev.clientX - wr.left;
  const sy = ev.clientY - wr.top;

  // stage æ˜¯ translate(view.x, view.y) scale(view.z)
  // åç®—å› stage å…§åº§æ¨™ï¼š
  const stageX = (sx - view.x) / view.z;
  const stageY = (sy - view.y) / view.z;

  const ab = artboardEl.getBoundingClientRect(); // é€™æ˜¯ clientRectï¼Œä¸ç”¨
  // ç”¨ offsetTop/Left ä¸å¯é (absolute + transform)
  // æˆ‘å€‘ç”¨ "artboard åœ¨ stage è£¡çš„ç†è«–ä½ç½®"ï¼š
  // artboard CSSï¼šleft:50%, top:50%, transform:-50% -50%
  // æ‰€ä»¥ artboard çš„å·¦ä¸Šè§’åº§æ¨™ = stage center - (w/2, h/2)
  const stageRect = stageEl.getBoundingClientRect(); // clientRect ä¹Ÿä¸å¯é 
  // ä½† stageX/stageY æ˜¯ stage çš„å…§å®¹åº§æ¨™ï¼Œä¸­å¿ƒåœ¨ workspace çš„ä¸­å¿ƒå°æ‡‰ stage(0,0)?? ä¸ã€‚
  // å› ç‚º stage æœ¬èº« absolute inset-0ï¼Œæœªè®Šå½¢æ™‚å…¶(0,0)å° workspace(0,0)
  // æ‰€ä»¥ stageX/Y å¯è¦–ç‚º stage å…§å®¹åº§æ¨™ï¼Œä»¥å·¦ä¸Š(0,0)ç‚ºåŸé»ã€‚

  const centerX = (workspaceEl.clientWidth / 2);
  const centerY = (workspaceEl.clientHeight / 2);

  // artboard åœ¨ stage å…§å®¹åº§æ¨™çš„ä½ç½®ï¼š
  const abLeft = centerX - state.frame.w/2;
  const abTop  = centerY - state.frame.h/2;

  const px = stageX - abLeft;
  const py = stageY - abTop;

  return { px, py, in: (px>=0 && py>=0 && px<=state.frame.w && py<=state.frame.h) };
}

/* ========= drawing new hotspot ========= */
let drawing = false;
let drawStart = { x:0, y:0 };
let drawRectEl = null;

drawLayerEl.addEventListener("mousedown", (ev)=>{
  if(state.mode !== "hotspot") return;
  if(!state.imageUrl) return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡");
  const p = clientToArtboard(ev);
  if(!p.in) return;

  drawing = true;
  drawStart = { x:p.px, y:p.py };

  drawRectEl = document.createElement("div");
  drawRectEl.className = "draw-rect";
  drawRectEl.style.left = drawStart.x + "px";
  drawRectEl.style.top = drawStart.y + "px";
  drawRectEl.style.width = "0px";
  drawRectEl.style.height = "0px";
  drawLayerEl.appendChild(drawRectEl);

  state.selectedId = null;
  renderHotspots();
});

window.addEventListener("mousemove", (ev)=>{
  if(!drawing || !drawRectEl) return;
  const p = clientToArtboard(ev);
  const cx = Math.max(0, Math.min(state.frame.w, p.px));
  const cy = Math.max(0, Math.min(state.frame.h, p.py));

  const x = Math.min(drawStart.x, cx);
  const y = Math.min(drawStart.y, cy);
  const w = Math.abs(cx - drawStart.x);
  const h = Math.abs(cy - drawStart.y);

  drawRectEl.style.left = x + "px";
  drawRectEl.style.top = y + "px";
  drawRectEl.style.width = w + "px";
  drawRectEl.style.height = h + "px";
});

window.addEventListener("mouseup", ()=>{
  if(!drawing) return;
  drawing = false;
  if(!drawRectEl) return;

  const rect = drawRectEl.getBoundingClientRect(); // just for size
  const w = parseFloat(drawRectEl.style.width);
  const h = parseFloat(drawRectEl.style.height);
  const x = parseFloat(drawRectEl.style.left);
  const y = parseFloat(drawRectEl.style.top);

  drawRectEl.remove();
  drawRectEl = null;

  if(w < 30 || h < 30) return;

  addHotspot(x/state.frame.w, y/state.frame.h, w/state.frame.w, h/state.frame.h);
});

/* ========= drag / resize hotspot ========= */
let drag = null;
function beginDragHotspot(ev, id, kind){
  const h = state.hotspots.find(x=>x.id===id);
  if(!h) return;
  drag = {
    id, kind,
    startMouse: { x: ev.clientX, y: ev.clientY },
    startBox: { x:h.x, y:h.y, w:h.w, h:h.h }
  };
  window.addEventListener("mousemove", onDragHotspot);
  window.addEventListener("mouseup", endDragHotspot, { once:true });
}
function onDragHotspot(ev){
  if(!drag) return;
  const h = state.hotspots.find(x=>x.id===drag.id);
  if(!h) return;

  // ç”¨ clientToArtboard çš„å·®å€¼ï¼Œé¿å…ç¸®æ”¾å½±éŸ¿
  const p0 = clientToArtboard({ clientX: drag.startMouse.x, clientY: drag.startMouse.y });
  const p1 = clientToArtboard(ev);

  const dx = (p1.px - p0.px) / state.frame.w;
  const dy = (p1.py - p0.py) / state.frame.h;

  let nx = drag.startBox.x;
  let ny = drag.startBox.y;
  let nw = drag.startBox.w;
  let nh = drag.startBox.h;

  const min = 0.02;

  if(drag.kind === "move"){
    nx = drag.startBox.x + dx;
    ny = drag.startBox.y + dy;
  }else{
    if(drag.kind.includes("n")){
      ny = drag.startBox.y + dy;
      nh = drag.startBox.h - dy;
    }
    if(drag.kind.includes("s")){
      nh = drag.startBox.h + dy;
    }
    if(drag.kind.includes("w")){
      nx = drag.startBox.x + dx;
      nw = drag.startBox.w - dx;
    }
    if(drag.kind.includes("e")){
      nw = drag.startBox.w + dx;
    }
  }

  nw = Math.max(min, nw);
  nh = Math.max(min, nh);
  nx = Math.min(1 - nw, Math.max(0, nx));
  ny = Math.min(1 - nh, Math.max(0, ny));

  h.x = nx; h.y = ny; h.w = nw; h.h = nh;
  renderHotspots();
  refreshPhonePreview();
}
function endDragHotspot(){
  window.removeEventListener("mousemove", onDragHotspot);
  drag = null;
  pushHistory();
  renderHotspotList();
}

/* ========= render ========= */
function renderHotspots(){
  hotspotLayerEl.innerHTML = "";
  state.hotspots.forEach((h, idx)=>{
    const d = document.createElement("div");
    d.className = "hotspot" + (h.id === state.selectedId ? " selected" : "");
    d.style.left = (h.x * 100) + "%";
    d.style.top = (h.y * 100) + "%";
    d.style.width = (h.w * 100) + "%";
    d.style.height = (h.h * 100) + "%";
    d.textContent = String(idx+1);

    d.addEventListener("mousedown", (ev)=>{
      ev.stopPropagation();
      if(state.mode !== "hotspot") return;
      selectHotspot(h.id);
      beginDragHotspot(ev, h.id, "move");
    });
    d.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      selectHotspot(h.id);
    });

    if(h.id === state.selectedId && state.mode === "hotspot"){
      ["nw","ne","sw","se"].forEach(pos=>{
        const hd = document.createElement("div");
        hd.className = "handle " + pos;
        hd.addEventListener("mousedown", (ev)=>{
          ev.stopPropagation();
          beginDragHotspot(ev, h.id, pos);
        });
        d.appendChild(hd);
      });
    }
    hotspotLayerEl.appendChild(d);
  });
  hsCountEl.textContent = state.hotspots.length + " å€‹";
}

function renderHotspotList(){
  areaListEl.innerHTML = "";
  areaEmptyEl.classList.toggle("hidden", state.hotspots.length !== 0);

  state.hotspots.forEach((h, idx)=>{
    const row = document.createElement("div");
    row.className = "border rounded-lg p-2 bg-white";
    const selected = (h.id === state.selectedId);

    row.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-sm ${selected ? 'text-blue-700' : 'text-slate-700'}">æ¡† ${idx+1}</div>
        <div class="flex items-center gap-2">
          <button class="text-xs ${selected ? 'text-blue-700' : 'text-slate-500'} underline">é¸å–</button>
          <button class="text-xs text-red-600 underline">åˆªé™¤</button>
        </div>
      </div>
      <div class="text-xs text-slate-500 mb-1">é»æ­¤æ¡†é€å‡ºæ–‡å­—ï¼š</div>
      <input class="w-full border rounded px-2 py-2 text-sm font-bold"
        placeholder="ä¾‹å¦‚ï¼šMENU_A / MENU_B / MENU_C"
        value="${escapeHtml(h.text)}">
    `;

    const btnSelect = row.querySelectorAll("button")[0];
    const btnDel = row.querySelectorAll("button")[1];
    const input = row.querySelector("input");

    btnSelect.onclick = () => selectHotspot(h.id);
    btnDel.onclick = () => {
      if(confirm(`åˆªé™¤æ¡† ${idx+1}ï¼Ÿ`)){
        const i = state.hotspots.findIndex(x=>x.id===h.id);
        if(i>=0){
          state.hotspots.splice(i,1);
          if(state.selectedId === h.id) state.selectedId = null;
          pushHistory();
          renderAll();
        }
      }
    };
    input.oninput = ()=>{ h.text = input.value; refreshPhonePreview(); };
    input.onblur = ()=> pushHistory();

    areaListEl.appendChild(row);
  });
}

function renderAll(){
  applyFrameSize();
  applyCropTransform();
  renderHotspots();
  renderHotspotList();
  refreshPhonePreview();
}

/* ========= preview drawer ========= */
function togglePreview(open){
  const overlay = $("drawerOverlay");
  const drawer = $("previewDrawer");
  if(open){
    overlay.classList.remove("hidden");
    drawer.classList.remove("translate-y-full");
    refreshPhonePreview();
  }else{
    overlay.classList.add("hidden");
    drawer.classList.add("translate-y-full");
  }
}
function refreshPhonePreview(){
  const img = $("phoneImg");
  const wrap = $("phoneHotspots");

  if(!state.imageUrl){
    img.src = "";
    wrap.innerHTML = "";
    return;
  }

  img.src = state.imageUrl;
  wrap.innerHTML = "";

  requestAnimationFrame(()=>{
    const r = wrap.getBoundingClientRect();
    if(!r.width || !r.height) return;

    state.hotspots.forEach((h, i)=>{
      const box = document.createElement("button");
      box.style.position = "absolute";
      box.style.left = (h.x*100) + "%";
      box.style.top = (h.y*100) + "%";
      box.style.width = (h.w*100) + "%";
      box.style.height = (h.h*100) + "%";
      box.style.border = "2px solid rgba(239,68,68,.85)";
      box.style.background = "rgba(239,68,68,.08)";
      box.style.borderRadius = "10px";
      box.onclick = ()=> alert(`æ¡† ${i+1}\nå°‡é€å‡ºï¼š${(h.text||"").trim() || "ï¼ˆæœªå¡«ï¼‰"}`);
      wrap.appendChild(box);
    });
  });
}

/* ========= crop mode drag image (preview only) ========= */
let cropDrag = null;
imgLayerEl.addEventListener("mousedown", (ev)=>{
  if(state.mode !== "crop") return;
  if(!state.imageUrl) return;
  cropDrag = {
    startMouse: { x: ev.clientX, y: ev.clientY },
    start: { tx: state.crop.tx, ty: state.crop.ty }
  };
  imgLayerEl.style.cursor = "grabbing";
  window.addEventListener("mousemove", onCropDrag);
  window.addEventListener("mouseup", endCropDrag, { once:true });
});
function onCropDrag(ev){
  if(!cropDrag) return;
  const dx = ev.clientX - cropDrag.startMouse.x;
  const dy = ev.clientY - cropDrag.startMouse.y;
  state.crop.tx = cropDrag.start.tx + dx;
  state.crop.ty = cropDrag.start.ty + dy;
  applyCropTransform();
}
function endCropDrag(){
  window.removeEventListener("mousemove", onCropDrag);
  imgLayerEl.style.cursor = "grab";
  cropDrag = null;
  pushHistory();
}

/* ========= workspace pan/zoom ========= */
let isSpaceDown = false;
let panning = false;
let panStart = { x:0, y:0, vx:0, vy:0 };

window.addEventListener("keydown", (ev)=>{ if(ev.code==="Space"){ isSpaceDown=true; ev.preventDefault(); } });
window.addEventListener("keyup", (ev)=>{ if(ev.code==="Space"){ isSpaceDown=false; } });

workspaceEl.addEventListener("mousedown", (ev)=>{
  if(isSpaceDown && ev.button === 0){
    panning = true;
    panStart = { x: ev.clientX, y: ev.clientY, vx: view.x, vy: view.y };
    window.addEventListener("mousemove", onPanMove);
    window.addEventListener("mouseup", endPan, { once:true });
  }
});
function onPanMove(ev){
  if(!panning) return;
  view.x = panStart.vx + (ev.clientX - panStart.x);
  view.y = panStart.vy + (ev.clientY - panStart.y);
  updateStageTransform();
}
function endPan(){
  window.removeEventListener("mousemove", onPanMove);
  panning = false;
}

workspaceEl.addEventListener("wheel", (ev)=>{
  if(ev.ctrlKey){
    ev.preventDefault();
    const factor = ev.deltaY < 0 ? 1.08 : 1/1.08;
    zoomBy(factor, ev.clientX, ev.clientY);
  }
}, { passive:false });

/* ========= keyboard ========= */
window.addEventListener("keydown", (ev)=>{
  if(ev.ctrlKey && !ev.shiftKey && ev.key.toLowerCase()==="z"){ ev.preventDefault(); undo(); }
  if((ev.ctrlKey && ev.key.toLowerCase()==="y") || (ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase()==="z")){
    ev.preventDefault(); redo();
  }
  if(ev.key==="Delete"){ ev.preventDefault(); deleteSelected(); }
  if(ev.key==="Escape"){ state.selectedId=null; renderHotspots(); renderHotspotList(); }
});

/* ========= auto crop to 2500x1686 + upload ========= */
async function imageFileToAutoCroppedBlob(file){
  const bmp = await createImageBitmap(file);
  const W = TARGET_W, H = TARGET_H;

  // cover crop
  const srcW = bmp.width, srcH = bmp.height;
  const dstR = W / H;
  const srcR = srcW / srcH;

  let sx=0, sy=0, sw=srcW, sh=srcH;
  if(srcR > dstR){
    // source wider -> crop left/right
    sh = srcH;
    sw = Math.round(srcH * dstR);
    sx = Math.round((srcW - sw)/2);
    sy = 0;
  }else{
    // source taller -> crop top/bottom
    sw = srcW;
    sh = Math.round(srcW / dstR);
    sx = 0;
    sy = Math.round((srcH - sh)/2);
  }

  const canvas = document.createElement("canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,W,H);
  ctx.drawImage(bmp, sx, sy, sw, sh, 0, 0, W, H);

  // webp for size
  const blob = await new Promise(res=> canvas.toBlob(res, "image/webp", 0.9));
  if(!blob) throw new Error("è£åˆ‡è¼¸å‡ºå¤±æ•—ï¼ˆtoBlob ç©ºï¼‰");
  return blob;
}

async function pickAndAutoUpload(){
  const base = normalizeWorkerUrl(workerUrlEl.value || localStorage.getItem("line_worker_url"));
  if(!base) return alert("è«‹å…ˆå¡« Worker URLï¼ˆæˆ–å›é¦–é å…ˆå¡«ï¼‰");
  workerUrlEl.value = base;
  localStorage.setItem("line_worker_url", base);

  const input = $("fileInput");
  input.value = "";
  input.onchange = async (e)=>{
    const file = e.target.files[0];
    if(!file) return;

    try{
      setStatus("è£åˆ‡+ä¸Šå‚³ä¸­...");
      const croppedBlob = await imageFileToAutoCroppedBlob(file);
      const safeName = (file.name || "menu").replace(/\.[^/.]+$/, "");
      const url = await uploadToR2(base, croppedBlob, `${safeName}_2500x1686.webp`);

      state.imageUrl = url;
      state.crop = { tx:0, ty:0, s:1 };
      state.hotspots = [];
      state.selectedId = null;
      setImageUrl(url, true);
      pushHistory();
      renderAll();
      fitToScreen();
      setMode("hotspot", true);
      setStatus("å®Œæˆ âœ…ï¼ˆé–‹å§‹ç•«æ¡†ï¼‰");
      togglePreview(true);
    }catch(err){
      setStatus("å¤±æ•—");
      alert("ä¸Šå‚³å¤±æ•—ï¼š\n" + err.message);
    }
  };
  input.click();
}

/* ========= build imagemap-like payload (message) =========
ä½ åŸæœ¬ worker ç”¨ DB keyword -> messages array replyï¼Œ
é€™è£¡æ²¿ç”¨ imagemap æ ¼å¼è¼¸å‡ºï¼ˆactions area ä»¥ 2500x1686ï¼‰
*/
async function buildMenuPayload(){
  if(!state.imageUrl) throw new Error("å°šæœªæœ‰åœ–ç‰‡");
  if(state.hotspots.length===0) throw new Error("å°šæœªæ–°å¢æ¡†");
  if(state.hotspots.some(h => !String(h.text||"").trim())) throw new Error("æœ‰æ¡†æ²’å¡«æ–‡å­—");

  const actions = state.hotspots.map(h => ({
    type:"message",
    text: h.text.trim(),
    area:{
      x: Math.round(h.x * TARGET_W),
      y: Math.round(h.y * TARGET_H),
      width: Math.round(h.w * TARGET_W),
      height: Math.round(h.h * TARGET_H)
    }
  }));

  return {
    mode: "richmenu_6grid",
    meta: { name: state.meta?.name || "" },
    messages: [{
      type:"imagemap",
      baseUrl: state.imageUrl,
      altText: state.meta?.name || "å…­å®®æ ¼é¸å–®",
      baseSize: { width: TARGET_W, height: TARGET_H },
      actions
    }]
  };
}

/* ========= save/load ========= */
async function saveConfig(){
  const base = normalizeWorkerUrl(workerUrlEl.value);
  const keyword = triggerEl.value.trim();
  const name = fileNameEl.value.trim();

  if(!base || !keyword) return alert("è«‹å¡« Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem("line_worker_url", base);

  try{
    state.triggerKeyword = keyword;
    state.meta.name = name;

    const payload = await buildMenuPayload();
    await postJSON(base + "/save", { keyword, payload });

    pushHistory();
    setStatus("å„²å­˜æˆåŠŸ âœ…");
    alert("å„²å­˜æˆåŠŸï¼š\n" + keyword);
  }catch(e){
    setStatus("å„²å­˜å¤±æ•—");
    alert("å„²å­˜å¤±æ•—ï¼š\n" + e.message);
  }
}

async function loadConfig(){
  const base = normalizeWorkerUrl(workerUrlEl.value);
  const keyword = triggerEl.value.trim();
  if(!base || !keyword) return alert("è«‹å¡« Worker URL + è§¸ç™¼é—œéµå­—");
  localStorage.setItem("line_worker_url", base);

  try{
    const data = await postJSON(base + "/load", { keyword });
    const obj = (typeof data === "string") ? JSON.parse(data) : data;

    const m = obj?.messages?.[0];
    if(!m || m.type!=="imagemap") throw new Error("ä¸æ˜¯ imagemap æ ¼å¼");

    state.meta = obj.meta || { name:"" };
    state.triggerKeyword = keyword;
    state.imageUrl = m.baseUrl || "";
    state.frame = { w: m.baseSize?.width || TARGET_W, h: m.baseSize?.height || TARGET_H };

    const bw = state.frame.w, bh = state.frame.h;
    state.hotspots = (m.actions || []).map(a=>({
      id: uid(),
      x: (a.area?.x || 0) / bw,
      y: (a.area?.y || 0) / bh,
      w: (a.area?.width || 0) / bw,
      h: (a.area?.height || 0) / bh,
      text: a.text || ""
    }));
    state.selectedId = state.hotspots[0]?.id || null;
    state.crop = { tx:0, ty:0, s:1 };

    fileNameEl.value = state.meta?.name || "";
    setImageUrl(state.imageUrl, true);
    applyFrameSize();
    pushHistory();
    renderAll();
    fitToScreen();
    togglePreview(true);

    setStatus("è®€å–æˆåŠŸ âœ…");
  }catch(e){
    setStatus("è®€å–å¤±æ•—");
    alert("è®€å–å¤±æ•—ï¼š\n" + e.message);
  }
}

/* ========= switch menu ========= */
async function refreshMenuList(){
  const base = normalizeWorkerUrl(workerUrlEl.value || localStorage.getItem("line_worker_url"));
  if(!base) return alert("è«‹å…ˆå¡« Worker URLï¼ˆæˆ–å›é¦–é å…ˆå¡«ï¼‰");
  workerUrlEl.value = base;

  try{
    const j = await postJSON(base + "/list", {});
    const keys = (j.keywords || []);
    const sel = $("menuPicker");
    sel.innerHTML = "";
    keys.forEach(k=>{
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = k;
      sel.appendChild(opt);
    });
    setStatus("æ¸…å–®å·²åˆ·æ–° âœ…");
  }catch(e){
    alert("åˆ·æ–°å¤±æ•—ï¼š\n" + e.message);
  }
}
function loadFromPicker(){
  const k = ($("menuPicker").value || "").trim();
  if(!k) return alert("è«‹å…ˆé¸ä¸€å€‹ keyword");
  triggerEl.value = k;
  state.triggerKeyword = k;
  loadConfig();
}

/* ========= init ========= */
function init(){
  // auto fill workerUrl from localStorage (same key as index)
  const saved = localStorage.getItem("line_worker_url");
  if(saved) workerUrlEl.value = saved;

  applyFrameSize();
  resetView();
  fitToScreen();
  setMode("hotspot", true);
  pushHistory();
  renderAll();
  setStatus("å°±ç·’ âœ…");
}
init();
</script>
</body>
</html>
