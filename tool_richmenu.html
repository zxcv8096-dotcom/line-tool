<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å…­å®®æ ¼é¸å–®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --rail-w: 92px;
      --panel-w: 360px;
      --preview-w: 380px;
    }
    body{ user-select:none; }
    input, textarea, select, button { user-select:auto; }

    .checker{
      background-image:
        linear-gradient(45deg, rgba(0,0,0,.035) 25%, transparent 25%),
        linear-gradient(-45deg, rgba(0,0,0,.035) 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, rgba(0,0,0,.035) 75%),
        linear-gradient(-45deg, transparent 75%, rgba(0,0,0,.035) 75%);
      background-size: 28px 28px;
      background-position: 0 0, 0 14px, 14px -14px, -14px 0px;
    }

    .artboard{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%, -50%);
      background:#fff;
      border:1px solid rgba(15,23,42,.20);
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      border-radius: 14px;
      overflow:hidden;
    }

    .img-layer{
      position:absolute;
      inset:0;
      overflow:hidden;
      background:#f8fafc;
    }
    .img-layer img{
      width:100%;
      height:100%;
      object-fit:cover;
      user-select:none;
      pointer-events:none;
    }

    .hotspot{
      position:absolute;
      border:2px solid rgba(239,68,68,.95);
      background: rgba(239,68,68,.14);
      border-radius: 12px;
      color:white;
      font-weight:900;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-shadow:0 1px 2px rgba(0,0,0,.85);
      cursor:pointer;
    }
    .hotspot.selected{
      border-color: rgba(59,130,246,.95);
      background: rgba(59,130,246,.12);
    }

    .handle{
      position:absolute;
      width:10px; height:10px;
      background:#fff;
      border:2px solid rgba(59,130,246,.95);
      border-radius: 4px;
      box-shadow:0 1px 3px rgba(0,0,0,.25);
      z-index: 10;
    }
    .handle.nw{ left:-6px; top:-6px; cursor:nwse-resize; }
    .handle.ne{ right:-6px; top:-6px; cursor:nesw-resize; }
    .handle.sw{ left:-6px; bottom:-6px; cursor:nesw-resize; }
    .handle.se{ right:-6px; bottom:-6px; cursor:nwse-resize; }

    .draw-rect{
      position:absolute;
      border:2px dashed rgba(2,6,23,.55);
      background: rgba(2,6,23,.10);
      border-radius: 12px;
      pointer-events:none;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border:1px solid rgba(0,0,0,.18);
      padding:2px 6px;
      border-radius:6px;
      background:#fff;
      font-size: 11px;
    }

    /* phone preview */
    .phone{
      border-radius: 34px;
      background:#0b1220;
      padding:10px;
      box-shadow: 0 22px 50px rgba(0,0,0,.25);
    }
    .phone-inner{
      border-radius: 26px;
      overflow:hidden;
      background:#e7eefb;
      border:1px solid rgba(255,255,255,.12);
    }
    .phone-top{
      background:#ffffff;
      border-bottom:1px solid rgba(2,6,23,.10);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:#0f172a;
    }
    .phone-chat{
      height: 360px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .bubble{
      display:inline-block;
      padding:10px 12px;
      background:#a7f3d0;
      color:#064e3b;
      border-radius:18px;
      font-size:12px;
      margin-left:auto;
      max-width: 80%;
    }
    .phone-bottom{
      background:#ffffff;
      border-top:1px solid rgba(2,6,23,.10);
      padding:8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mini-btn{
      width:38px; height:34px;
      border-radius:10px;
      background:#f1f5f9;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:#0f172a;
      border:1px solid rgba(2,6,23,.10);
    }
    .rm-wrap{
      position:relative;
      width:100%;
      aspect-ratio: 2500 / 1686;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(2,6,23,.12);
    }
    .rm-wrap img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-800 overflow-hidden">

<!-- Top bar -->
<div class="h-14 bg-white border-b flex items-center justify-between px-3">
  <div class="flex items-center gap-3">
    <div class="font-extrabold text-indigo-700 text-lg">å…­å®®æ ¼é¸å–®</div>
    <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
      <span><span class="kbd">Ctrl</span>+æ»¾è¼ª ç¸®æ”¾</span>
      <span>ï½œ</span>
      <span><span class="kbd">ç©ºç™½éµ</span> æ‹–æ›³å¹³ç§»</span>
      <span>ï½œ</span>
      <span><span class="kbd">Ctrl+Z</span>/<span class="kbd">Ctrl+Y</span> å¾©åŸ/é‡åš</span>
      <span>ï½œ</span>
      <span><span class="kbd">Delete</span> åˆªé™¤é¸å–æ ¼</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <div id="status" class="text-xs text-slate-500 mr-2 hidden md:block">ç‹€æ…‹ï¼šå°±ç·’</div>
    <button class="px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="closePage()">è¿”å›</button>
  </div>
</div>

<div class="h-[calc(100vh-56px)] flex">

  <!-- Left rail -->
  <div class="w-[92px] bg-white border-r flex flex-col items-center py-3 gap-2">
    <button class="w-14 h-12 rounded-xl bg-slate-900 text-white flex items-center justify-center text-xl hover:bg-black"
            title="æ”¶åˆ/å±•é–‹å·¦å´"
            onclick="toggleLeft()">
      â˜°
    </button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="makeSixGrid()" title="å¿«é€Ÿå…­å®®æ ¼">
      <div class="text-xl">ğŸ§©</div>
      <div class="text-[10px] text-slate-700 font-bold">å…­æ ¼</div>
    </button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="fitToScreen()" title="Fit">
      <div class="text-xl">ğŸ“</div>
      <div class="text-[10px] text-slate-700 font-bold">Fit</div>
    </button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="resetView()" title="é‡ç½®è¦–è§’">
      <div class="text-xl">ğŸ”</div>
      <div class="text-[10px] text-slate-700 font-bold">é‡ç½®</div>
    </button>

    <button class="w-14 h-12 rounded-xl bg-slate-100 hover:bg-slate-200 flex flex-col items-center justify-center"
            onclick="togglePreview()" title="é è¦½é¢æ¿ï¼ˆå³å´ï¼‰">
      <div class="text-xl">ğŸ“±</div>
      <div class="text-[10px] text-slate-700 font-bold">é è¦½</div>
    </button>
  </div>

  <!-- Left panel -->
  <div id="leftPanel" class="w-[360px] bg-white border-r overflow-y-auto">
    <div class="p-4 space-y-4">

      <div class="rounded-xl border p-3 bg-slate-50">
        <div class="font-bold text-sm mb-2">é€£ç·š</div>
        <label class="text-xs text-slate-500">Worker URLï¼ˆå¾é¦–é è‡ªå‹•å¸¶å…¥ï¼‰</label>
        <input id="workerUrl" class="mt-1 w-full border rounded px-3 py-2 bg-yellow-50 text-sm"
               placeholder="https://api.xxx.workers.dev" />
      </div>

      <div class="rounded-xl border p-3">
        <div class="font-bold text-sm mb-2">é¸å–®è³‡è¨Š</div>

        <label class="text-xs text-slate-500">é¸å–®åç¨±ï¼ˆ=æª”æ¡ˆåç¨±ï¼‰</label>
        <input id="menuName" class="mt-1 w-full border rounded px-3 py-2 text-sm font-bold"
               placeholder="ä¾‹å¦‚ï¼šHOME_å…­å®®æ ¼" />

        <div class="mt-2 grid grid-cols-2 gap-2">
          <label class="text-xs text-slate-500">
            åˆ‡æ›å…¶ä»–é¸å–®
            <select id="menuSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm" onchange="onSelectMenu()">
              <option value="">ï¼ˆå°šæœªè¼‰å…¥ï¼‰</option>
            </select>
          </label>

          <label class="text-xs text-slate-500">
            é è¨­(é¦–é )
            <select id="isDefault" class="mt-1 w-full border rounded px-2 py-2 text-sm">
              <option value="no" selected>å¦</option>
              <option value="yes">æ˜¯</option>
            </select>
          </label>
        </div>

        <div class="mt-3 flex gap-2">
          <button id="btnImport" class="flex-1 px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700"
                  onclick="pickAndImport()">åŒ¯å…¥åœ–ç‰‡</button>

          <button class="flex-1 px-3 py-2 rounded bg-green-600 text-white text-sm hover:bg-green-700"
                  onclick="saveMenu()">å„²å­˜</button>
        </div>

        <div class="mt-2 flex gap-2">
          <button class="flex-1 px-3 py-2 rounded bg-slate-900 text-white text-sm hover:bg-black"
                  onclick="loadMenu()">è®€å–</button>

          <button class="flex-1 px-3 py-2 rounded bg-slate-200 text-slate-800 text-sm hover:bg-slate-300"
                  onclick="clearAll()">æ¸…ç©º</button>
        </div>
      </div>

      <div class="rounded-xl border p-3">
        <div class="font-bold text-sm mb-2 flex items-center justify-between">
          <span>æ ¼å­æ¸…å–®</span>
          <span id="count" class="text-xs text-slate-500">0</span>
        </div>
        <div id="empty" class="text-xs text-slate-400">å°šæœªæ–°å¢æ ¼å­ã€‚ä½ å¯ä»¥æ‹–æ›³æ–°å¢ï¼Œæˆ–æŒ‰ã€Œå…­æ ¼ã€ã€‚</div>
        <div id="list" class="space-y-2"></div>
      </div>

      <div class="text-xs text-slate-400 pb-10">
        åœ–ç‰‡æœƒè‡ªå‹•è£åˆ‡æˆ 2500Ã—1686 ä¸¦ä¸Šå‚³åˆ° R2ï¼›æ‰€æœ‰æ“ä½œæ”¯æ´ Ctrl+Z / Ctrl+Yã€‚
      </div>
    </div>
  </div>

  <!-- Workspace -->
  <div class="flex-1 relative checker overflow-hidden" id="workspace">
    <div class="absolute top-3 right-3 z-20 flex items-center gap-2 bg-white/90 backdrop-blur border rounded-xl px-2 py-1 shadow">
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1.1)">ï¼‹</button>
      <div class="w-16 text-center text-sm font-bold" id="zoomLabel">100%</div>
      <button class="px-2 py-1 rounded hover:bg-slate-100 text-sm" onclick="zoomBy(1/1.1)">ï¼</button>
      <button class="px-2 py-1 rounded bg-slate-900 text-white text-sm hover:bg-black" onclick="fitToScreen()">Fit</button>
    </div>

    <div id="stage" class="absolute inset-0">
      <div id="artboard" class="artboard">
        <div class="img-layer">
          <img id="img" alt="">
        </div>
        <div id="hotspotLayer" class="absolute inset-0"></div>
        <div id="drawLayer" class="absolute inset-0"></div>
      </div>
    </div>

    <div class="absolute left-3 bottom-3 z-20 bg-white/90 backdrop-blur border rounded-xl px-3 py-2 shadow text-xs text-slate-600">
      <div class="font-bold mb-1">æ“ä½œ</div>
      <div class="space-y-1">
        <div>â€¢ æ‹–æ›³æ–°å¢æ ¼å­ï¼›é»é¸æ ¼å­å¾Œå¯æ‹–ç§»/æ‹‰è§’ç¸®æ”¾</div>
        <div>â€¢ <span class="kbd">Ctrl</span>+æ»¾è¼ªï¼šç¸®æ”¾ç•«é¢ï¼›<span class="kbd">ç©ºç™½éµ</span>ï¼šæ‹–æ›³å¹³ç§»</div>
        <div>â€¢ <span class="kbd">Ctrl+Z</span>/<span class="kbd">Ctrl+Y</span>ï¼šå¾©åŸ/é‡åšï¼›<span class="kbd">Delete</span>ï¼šåˆªé™¤é¸å–æ ¼</div>
      </div>
    </div>
  </div>

  <!-- Right preview panel -->
  <div id="previewPanel" class="w-[380px] bg-white border-l overflow-y-auto">
    <div class="p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="font-bold text-sm">LINE æ‰‹æ©Ÿé è¦½</div>
        <button class="text-xs px-2 py-1 rounded border hover:bg-slate-50" onclick="togglePreview()">æ”¶åˆ</button>
      </div>

      <div class="phone">
        <div class="phone-inner">
          <div class="phone-top">
            <div class="font-bold">Rich Menu</div>
            <div class="text-slate-500">é è¦½</div>
          </div>

          <div class="phone-chat">
            <div class="bubble">é»ä¸‹æ–¹é¸å–®æ ¼å­æœƒé€å‡ºä½ è¨­å®šçš„æ–‡å­—</div>
            <div id="rmArea" class="mt-3 hidden"></div>
          </div>

          <div class="phone-bottom">
            <button id="toggleBtn" class="mini-btn" onclick="toggleKeyboard()">âŒ¨ï¸</button>
            <div class="flex-1 text-xs text-slate-600 truncate" id="hint">é¸å–®</div>
            <div class="mini-btn">ï¼‹</div>
          </div>

          <div id="rmBar" class="p-3 bg-white hidden">
            <div class="rm-wrap">
              <img id="phoneImg" alt="">
              <div id="phoneHotspots" class="absolute inset-0"></div>
            </div>
          </div>

        </div>
      </div>

      <div class="mt-3 text-xs text-slate-500">
        â€¢ å³ä¸‹è§’åˆ‡æ›ï¼šâŒ¨ï¸ / é¸å–®ï¼ˆæ¨¡æ“¬ LINE å·¦ä¸‹è§’åˆ‡æ›ï¼‰<br/>
        â€¢ ä½ æ¯æ¬¡æ‹–æ›³/æ”¹æ–‡å­—ï¼Œé è¦½æœƒè‡ªå‹•æ›´æ–°
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<script>
  const $ = (id)=>document.getElementById(id);

  const BASE_W = 2500;
  const BASE_H = 1686;

  const workerUrlEl = $("workerUrl");
  const menuNameEl = $("menuName");
  const menuSelectEl = $("menuSelect");
  const isDefaultEl = $("isDefault");
  const statusEl = $("status");

  const leftPanelEl = $("leftPanel");
  const previewPanelEl = $("previewPanel");
  const workspaceEl = $("workspace");
  const stageEl = $("stage");

  const artboardEl = $("artboard");
  const imgEl = $("img");
  const hotspotLayerEl = $("hotspotLayer");
  const drawLayerEl = $("drawLayer");

  const listEl = $("list");
  const emptyEl = $("empty");
  const countEl = $("count");
  const zoomLabelEl = $("zoomLabel");

  const btnImportEl = $("btnImport");

  const phoneImgEl = $("phoneImg");
  const phoneHotspotsEl = $("phoneHotspots");
  const rmBarEl = $("rmBar");
  const toggleBtnEl = $("toggleBtn");
  const hintEl = $("hint");

  function setStatus(s){
    statusEl.textContent = "ç‹€æ…‹ï¼š" + s;
  }

  function normalizeWorkerUrl(raw){
    if(!raw) return "";
    let s = raw.trim();
    if(!/^https?:\/\//i.test(s)) s = "https://" + s;
    return s.replace(/\/+$/,'');
  }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    const txt = await res.text().catch(()=> "");
    if(!res.ok){
      throw new Error(`HTTP ${res.status}\n${txt}`);
    }
    try { return JSON.parse(txt); } catch { return txt; }
  }

  async function uploadToR2(workerBaseUrl, blob, filename){
    const form = new FormData();
    form.append("file", blob, filename || "richmenu.webp");
    const res = await fetch(workerBaseUrl + "/upload", { method:"POST", body: form });
    const txt = await res.text().catch(()=> "");
    if(!res.ok) throw new Error(`HTTP ${res.status}\n${txt}`);
    const j = JSON.parse(txt);
    if(!j.ok || !j.url) throw new Error("ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°");
    return j.url;
  }

  // ===== state =====
  let state = {
    meta: { name: "" },
    imageUrl: "",
    hotspots: [],
    selectedId: null
  };

  // ===== history (Undo/Redo) =====
  let history = [];
  let historyIndex = -1;

  function snapshot(){
    return JSON.parse(JSON.stringify({
      meta: state.meta,
      imageUrl: state.imageUrl,
      hotspots: state.hotspots,
      selectedId: state.selectedId
    }));
  }
  function pushHistory(){
    const snap = snapshot();
    history = history.slice(0, historyIndex + 1);
    history.push(snap);
    historyIndex++;
  }
  function applySnap(snap){
    state.meta = snap.meta;
    state.imageUrl = snap.imageUrl;
    state.hotspots = snap.hotspots;
    state.selectedId = snap.selectedId;

    menuNameEl.value = state.meta?.name || "";
    imgEl.src = state.imageUrl || "";
    renderAll(true);
  }
  function undo(){
    if(historyIndex <= 0) return;
    historyIndex--;
    applySnap(history[historyIndex]);
  }
  function redo(){
    if(historyIndex >= history.length - 1) return;
    historyIndex++;
    applySnap(history[historyIndex]);
  }

  // ===== view (pan/zoom) =====
  let view = { x: 0, y: 0, z: 1 };
  function updateStage(){
    stageEl.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.z})`;
    zoomLabelEl.textContent = Math.round(view.z * 100) + "%";
  }
  function resetView(){
    view = { x: 0, y: 0, z: 1 };
    updateStage();
  }
  function zoomBy(factor, anchorX=null, anchorY=null){
    const oldZ = view.z;
    const newZ = Math.min(4, Math.max(0.15, oldZ * factor));

    if(anchorX != null && anchorY != null){
      const rect = workspaceEl.getBoundingClientRect();
      const ax = anchorX - rect.left;
      const ay = anchorY - rect.top;
      const dx = ax - (rect.width/2);
      const dy = ay - (rect.height/2);
      view.x = (view.x - dx) * (newZ/oldZ) + dx;
      view.y = (view.y - dy) * (newZ/oldZ) + dy;
    }

    view.z = newZ;
    updateStage();
  }
  function fitToScreen(){
    const wr = workspaceEl.getBoundingClientRect();
    const pad = 140;
    const maxW = Math.max(200, wr.width - pad);
    const maxH = Math.max(200, wr.height - pad);

    const z = Math.min(3, Math.max(0.15, Math.min(maxW/BASE_W, maxH/BASE_H)));
    view.z = z;
    view.x = 0; view.y = 0;
    updateStage();
  }

  // ===== layout toggles =====
  let leftCollapsed = false;
  function toggleLeft(){
    leftCollapsed = !leftCollapsed;
    leftPanelEl.classList.toggle("hidden", leftCollapsed);
  }

  let previewCollapsed = false;
  function togglePreview(){
    previewCollapsed = !previewCollapsed;
    previewPanelEl.classList.toggle("hidden", previewCollapsed);
  }

  // ===== phone preview menu/keyboard toggle =====
  let showMenu = false;
  function toggleKeyboard(){
    showMenu = !showMenu;
    rmBarEl.classList.toggle("hidden", !showMenu);
    toggleBtnEl.textContent = showMenu ? "â‰¡" : "âŒ¨ï¸";
    hintEl.textContent = showMenu ? "é¸å–®" : "éµç›¤";
  }

  // ===== artboard size =====
  function initArtboard(){
    artboardEl.style.width = BASE_W + "px";
    artboardEl.style.height = BASE_H + "px";
    fitToScreen();
  }

  // ===== hotspot helpers =====
  function uid(){
    return "hs_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function selectHotspot(id){
    state.selectedId = id;
    renderHotspots();
    renderList();
  }
  function deleteSelected(){
    if(!state.selectedId) return;
    const i = state.hotspots.findIndex(h=>h.id===state.selectedId);
    if(i>=0){
      state.hotspots.splice(i,1);
      state.selectedId = null;
      pushHistory();
      renderAll();
    }
  }

  // ===== accurate coordinate mapping (FIX: â€œç¸®æ”¾å¾Œç•«æ¡†ä¸æº–â€) =====
  function getArtboardPoint(ev){
    const r = artboardEl.getBoundingClientRect();
    const px = ev.clientX - r.left;
    const py = ev.clientY - r.top;
    const nx = px / r.width;
    const ny = py / r.height;
    return { r, px, py, nx, ny };
  }

  // ===== draw new hotspot =====
  let drawing=false, start={x:0,y:0}, drawRect=null;

  drawLayerEl.addEventListener("mousedown", (ev)=>{
    if(!state.imageUrl) return alert("è«‹å…ˆåŒ¯å…¥åœ–ç‰‡");
    const p = getArtboardPoint(ev);
    drawing = true;
    start = { x:p.px, y:p.py };

    drawRect = document.createElement("div");
    drawRect.className = "draw-rect";
    drawRect.style.left = start.x + "px";
    drawRect.style.top = start.y + "px";
    drawRect.style.width = "0px";
    drawRect.style.height = "0px";
    drawLayerEl.appendChild(drawRect);

    state.selectedId = null;
    renderHotspots();
  });

  window.addEventListener("mousemove", (ev)=>{
    if(!drawing || !drawRect) return;
    const r = artboardEl.getBoundingClientRect();
    const cx = ev.clientX - r.left;
    const cy = ev.clientY - r.top;

    const x = Math.min(start.x, cx);
    const y = Math.min(start.y, cy);
    const w = Math.abs(cx - start.x);
    const h = Math.abs(cy - start.y);

    drawRect.style.left = x + "px";
    drawRect.style.top = y + "px";
    drawRect.style.width = w + "px";
    drawRect.style.height = h + "px";
  });

  window.addEventListener("mouseup", ()=>{
    if(!drawing) return;
    drawing = false;

    if(drawRect){
      const ab = artboardEl.getBoundingClientRect();
      const rr = drawRect.getBoundingClientRect();
      drawRect.remove();
      drawRect = null;

      const x = rr.left - ab.left;
      const y = rr.top - ab.top;
      const w = rr.width;
      const h = rr.height;

      if(w < 18 || h < 18) return;

      const nx = x / ab.width;
      const ny = y / ab.height;
      const nw = w / ab.width;
      const nh = h / ab.height;

      const id = uid();
      state.hotspots.push({ id, x:nx, y:ny, w:nw, h:nh, text:"" });
      state.selectedId = id;

      pushHistory();
      renderAll();
    }
  });

  // ===== drag/resize =====
  let drag = null;
  function beginDrag(ev, id, kind){
    const h = state.hotspots.find(x=>x.id===id);
    if(!h) return;

    const ab = artboardEl.getBoundingClientRect();
    drag = {
      id, kind, ab,
      startMouse: { x: ev.clientX, y: ev.clientY },
      startBox: { x:h.x, y:h.y, w:h.w, h:h.h }
    };
    window.addEventListener("mousemove", onDrag);
    window.addEventListener("mouseup", endDrag, { once:true });
  }
  function onDrag(ev){
    if(!drag) return;
    const h = state.hotspots.find(x=>x.id===drag.id);
    if(!h) return;

    const dx = (ev.clientX - drag.startMouse.x) / drag.ab.width;
    const dy = (ev.clientY - drag.startMouse.y) / drag.ab.height;

    let nx = drag.startBox.x;
    let ny = drag.startBox.y;
    let nw = drag.startBox.w;
    let nh = drag.startBox.h;

    const min = 0.03;

    if(drag.kind === "move"){
      nx = drag.startBox.x + dx;
      ny = drag.startBox.y + dy;
    }else{
      if(drag.kind.includes("n")){ ny = drag.startBox.y + dy; nh = drag.startBox.h - dy; }
      if(drag.kind.includes("s")){ nh = drag.startBox.h + dy; }
      if(drag.kind.includes("w")){ nx = drag.startBox.x + dx; nw = drag.startBox.w - dx; }
      if(drag.kind.includes("e")){ nw = drag.startBox.w + dx; }
    }

    nw = Math.max(min, nw);
    nh = Math.max(min, nh);
    nx = Math.min(1 - nw, Math.max(0, nx));
    ny = Math.min(1 - nh, Math.max(0, ny));

    h.x = nx; h.y = ny; h.w = nw; h.h = nh;

    renderHotspots();
    refreshPhonePreview();
  }
  function endDrag(){
    window.removeEventListener("mousemove", onDrag);
    drag = null;
    pushHistory();
    renderList();
  }

  // ===== render hotspots =====
  function renderHotspots(){
    hotspotLayerEl.innerHTML = "";
    state.hotspots.forEach((h, idx)=>{
      const d = document.createElement("div");
      d.className = "hotspot" + (h.id === state.selectedId ? " selected" : "");
      d.style.left = (h.x*100) + "%";
      d.style.top  = (h.y*100) + "%";
      d.style.width  = (h.w*100) + "%";
      d.style.height = (h.h*100) + "%";
      d.textContent = (idx+1);

      d.addEventListener("mousedown", (ev)=>{
        ev.stopPropagation();
        selectHotspot(h.id);
        beginDrag(ev, h.id, "move");
      });
      d.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        selectHotspot(h.id);
      });

      if(h.id === state.selectedId){
        ["nw","ne","sw","se"].forEach(pos=>{
          const hd = document.createElement("div");
          hd.className = "handle " + pos;
          hd.addEventListener("mousedown", (ev)=>{
            ev.stopPropagation();
            beginDrag(ev, h.id, pos);
          });
          d.appendChild(hd);
        });
      }

      hotspotLayerEl.appendChild(d);
    });

    countEl.textContent = state.hotspots.length + " å€‹";
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // debounce for input history
  let inputTimer = null;
  function scheduleHistory(){
    clearTimeout(inputTimer);
    inputTimer = setTimeout(()=> pushHistory(), 350);
  }

  function renderList(){
    listEl.innerHTML = "";
    emptyEl.classList.toggle("hidden", state.hotspots.length !== 0);

    state.hotspots.forEach((h, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "border rounded-lg p-2 bg-white";
      const selected = h.id === state.selectedId;

      wrap.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold text-sm ${selected?'text-blue-700':'text-slate-800'}">æ ¼ ${idx+1}</div>
          <div class="flex items-center gap-2">
            <button class="text-xs ${selected?'text-blue-700':'text-slate-500'} underline">é¸å–</button>
            <button class="text-xs text-red-600 underline">åˆªé™¤</button>
          </div>
        </div>
        <div class="text-xs text-slate-500 mb-1">é»æ“Šé€å‡ºæ–‡å­—ï¼š</div>
        <input class="w-full border rounded px-2 py-2 text-sm font-bold"
          placeholder="ä¾‹å¦‚ï¼šMENU_SHOP / MENU_CALENDAR / RM:HOME"
          value="${escapeHtml(h.text)}">
      `;

      const btnSel = wrap.querySelectorAll("button")[0];
      const btnDel = wrap.querySelectorAll("button")[1];
      const input = wrap.querySelector("input");

      btnSel.onclick = ()=> selectHotspot(h.id);
      btnDel.onclick = ()=>{
        if(confirm(`åˆªé™¤æ ¼ ${idx+1}ï¼Ÿ`)){
          const i = state.hotspots.findIndex(x=>x.id===h.id);
          if(i>=0){
            state.hotspots.splice(i,1);
            if(state.selectedId===h.id) state.selectedId=null;
            pushHistory();
            renderAll();
          }
        }
      };

      input.oninput = ()=>{
        h.text = input.value;
        refreshPhonePreview();
        scheduleHistory();
      };

      listEl.appendChild(wrap);
    });
  }

  function renderAll(silent=false){
    renderHotspots();
    renderList();
    refreshPhonePreview();
    if(!silent) setStatus("å°±ç·’");
  }

  // ===== phone preview =====
  function refreshPhonePreview(){
    if(!state.imageUrl){
      phoneImgEl.src = "";
      phoneHotspotsEl.innerHTML = "";
      return;
    }

    phoneImgEl.src = state.imageUrl;
    phoneHotspotsEl.innerHTML = "";

    state.hotspots.forEach((h, i)=>{
      const btn = document.createElement("button");
      btn.style.position = "absolute";
      btn.style.left = (h.x*100) + "%";
      btn.style.top  = (h.y*100) + "%";
      btn.style.width  = (h.w*100) + "%";
      btn.style.height = (h.h*100) + "%";
      btn.style.background = "transparent";
      btn.onclick = ()=>{
        const t = (h.text||"").trim();
        alert(`æ ¼ ${i+1}\nå°‡é€å‡ºï¼š${t || "ï¼ˆå°šæœªå¡«ï¼‰"}`);
      };
      phoneHotspotsEl.appendChild(btn);
    });

    // è‡ªå‹•è®“é è¦½åƒ LINEï¼šåŒ¯å…¥å¾Œç›´æ¥é¡¯ç¤ºé¸å–®
    if(state.imageUrl){
      showMenu = true;
      rmBarEl.classList.remove("hidden");
      toggleBtnEl.textContent = "â‰¡";
      hintEl.textContent = "é¸å–®";
    }
  }

  // ===== make 6 grid =====
  function makeSixGrid(){
    // 3 columns x 2 rows
    const cols = 3, rows = 2;
    const gap = 0.012; // small margin in normalized units
    const cellW = (1 - gap*(cols+1)) / cols;
    const cellH = (1 - gap*(rows+1)) / rows;

    state.hotspots = [];
    let n=0;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        n++;
        const x = gap + c*(cellW + gap);
        const y = gap + r*(cellH + gap);
        state.hotspots.push({
          id: uid(),
          x, y, w: cellW, h: cellH,
          text: ""
        });
      }
    }
    state.selectedId = state.hotspots[0]?.id || null;
    pushHistory();
    renderAll();
  }

  // ===== import image: auto crop to 2500x1686 and upload =====
  async function cropToBase(file){
    const bmp = await createImageBitmap(file);
    const W = BASE_W, H = BASE_H;

    // cover scale
    const s = Math.max(W / bmp.width, H / bmp.height);
    const dw = bmp.width * s;
    const dh = bmp.height * s;

    // center
    const dx = (W - dw) / 2;
    const dy = (H - dh) / 2;

    const canvas = document.createElement("canvas");
    canvas.width = W; canvas.height = H;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);
    ctx.drawImage(bmp, dx, dy, dw, dh);

    // webp
    const blob = await new Promise(res=> canvas.toBlob(res, "image/webp", 0.90));
    if(!blob) throw new Error("è£åˆ‡å¤±æ•—ï¼ˆtoBlob ç©ºï¼‰");
    return blob;
  }

  async function pickAndImport(){
    const base = normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return alert("è«‹å…ˆå¡« Worker URL");
    localStorage.setItem("line_worker_url", base);

    const input = $("fileInput");
    input.value = "";
    input.onchange = async (e)=>{
      const file = e.target.files[0];
      if(!file) return;

      try{
        setStatus("åŒ¯å…¥ä¸­...");
        const blob = await cropToBase(file);
        const url = await uploadToR2(base, blob, "richmenu_2500x1686.webp");

        state.imageUrl = url;
        imgEl.src = url;

        // reset hotspots? ä¸å¼·åˆ¶æ¸…ç©ºï¼Œä½ è¦æ¸…ç©ºå°±æŒ‰æ¸…ç©º
        btnImportEl.textContent = "å·²åŒ¯å…¥";
        btnImportEl.classList.remove("bg-blue-600");
        btnImportEl.classList.add("bg-emerald-600");

        pushHistory();
        renderAll();
        fitToScreen();
        setStatus("å·²åŒ¯å…¥ âœ…");
      }catch(err){
        setStatus("åŒ¯å…¥å¤±æ•—");
        alert("åŒ¯å…¥å¤±æ•—ï¼š\n" + err.message);
      }
    };
    input.click();
  }

  // ===== build richmenu payload =====
  function buildRichMenuPayload(){
    if(!state.imageUrl) throw new Error("å°šæœªåŒ¯å…¥åœ–ç‰‡");
    if(state.hotspots.length === 0) throw new Error("å°šæœªæ–°å¢æ ¼å­");
    if(state.hotspots.some(h => !String(h.text||"").trim())) throw new Error("æœ‰æ ¼å­æ²’æœ‰å¡«æ–‡å­—");

    const areas = state.hotspots.map(h=>({
      bounds: {
        x: Math.round(h.x * BASE_W),
        y: Math.round(h.y * BASE_H),
        width: Math.round(h.w * BASE_W),
        height: Math.round(h.h * BASE_H)
      },
      action: {
        type: "message",
        text: String(h.text).trim()
      }
    }));

    return {
      meta: {
        feature: "richmenu",
        name: state.meta.name || "",
        updatedAt: Date.now()
      },
      type: "richmenu",
      size: { width: BASE_W, height: BASE_H },
      imageUrl: state.imageUrl,
      areas
    };
  }

  // ===== KV store routes (worker.js æœƒæ–°å¢) =====
  function keyOf(name){ return "RM:" + name; }

  async function saveMenu(){
    const base = normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return alert("è«‹å…ˆå¡« Worker URL");

    const name = (menuNameEl.value || "").trim();
    if(!name) return alert("è«‹å…ˆå¡«é¸å–®åç¨±");

    try{
      state.meta.name = name;

      const payload = buildRichMenuPayload();
      const isDefault = (isDefaultEl.value === "yes");

      await postJSON(base + "/richmenu/save", { name, payload, isDefault });

      pushHistory();
      setStatus("å„²å­˜æˆåŠŸ âœ…");
      await refreshMenuList(true);
      alert("å·²å„²å­˜ âœ…\né¸å–®åç¨±ï¼š" + name + (isDefault ? "\nï¼ˆå·²è¨­ç‚ºé è¨­/é¦–é ï¼‰" : ""));
    }catch(e){
      setStatus("å„²å­˜å¤±æ•—");
      alert("å„²å­˜å¤±æ•—ï¼š\n" + e.message);
    }
  }

  async function loadMenu(){
    const base = normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return alert("è«‹å…ˆå¡« Worker URL");

    const name = (menuNameEl.value || "").trim() || (menuSelectEl.value || "").trim();
    if(!name) return alert("è«‹å…ˆè¼¸å…¥/é¸æ“‡è¦è®€å–çš„é¸å–®");

    try{
      const j = await postJSON(base + "/richmenu/load", { name });
      if(!j.ok) throw new Error(j.error || "è®€å–å¤±æ•—");

      const p = j.payload;
      state.meta = p.meta || { name };
      state.imageUrl = p.imageUrl || "";
      state.hotspots = (p.areas || []).map(a=>({
        id: uid(),
        x: (a.bounds.x || 0) / BASE_W,
        y: (a.bounds.y || 0) / BASE_H,
        w: (a.bounds.width || 0) / BASE_W,
        h: (a.bounds.height || 0) / BASE_H,
        text: (a.action?.text || "")
      }));
      state.selectedId = state.hotspots[0]?.id || null;

      menuNameEl.value = name;
      imgEl.src = state.imageUrl || "";

      btnImportEl.textContent = state.imageUrl ? "å·²åŒ¯å…¥" : "åŒ¯å…¥åœ–ç‰‡";
      btnImportEl.classList.toggle("bg-emerald-600", !!state.imageUrl);
      btnImportEl.classList.toggle("bg-blue-600", !state.imageUrl);

      // default?
      isDefaultEl.value = j.isDefault ? "yes" : "no";

      pushHistory();
      renderAll();
      fitToScreen();
      setStatus("è®€å–æˆåŠŸ âœ…");
    }catch(e){
      setStatus("è®€å–å¤±æ•—");
      alert("è®€å–å¤±æ•—ï¼š\n" + e.message);
    }
  }

  async function refreshMenuList(keepSelection=false){
    const base = normalizeWorkerUrl(workerUrlEl.value);
    if(!base) return;

    const current = keepSelection ? (menuSelectEl.value || "") : "";

    const j = await postJSON(base + "/richmenu/list", {});
    if(!j.ok) return;

    menuSelectEl.innerHTML = `<option value="">ï¼ˆé¸æ“‡é¸å–®ï¼‰</option>`;
    (j.items || []).forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it.name;
      opt.textContent = it.name + (it.isDefault ? "ï¼ˆé è¨­ï¼‰" : "");
      menuSelectEl.appendChild(opt);
    });

    if(current){
      menuSelectEl.value = current;
    }
  }

  function onSelectMenu(){
    const v = (menuSelectEl.value || "").trim();
    if(!v) return;
    menuNameEl.value = v;
    loadMenu();
  }

  function clearAll(){
    if(!confirm("ç¢ºå®šæ¸…ç©ºåœ–ç‰‡èˆ‡å…¨éƒ¨æ ¼å­ï¼Ÿ")) return;
    state.imageUrl = "";
    state.hotspots = [];
    state.selectedId = null;
    imgEl.src = "";

    btnImportEl.textContent = "åŒ¯å…¥åœ–ç‰‡";
    btnImportEl.classList.remove("bg-emerald-600");
    btnImportEl.classList.add("bg-blue-600");

    pushHistory();
    renderAll();
  }

  // ===== input sync =====
  menuNameEl.addEventListener("input", ()=>{
    state.meta.name = menuNameEl.value;
    scheduleHistory();
  });

  // ===== keyboard shortcuts =====
  let isSpaceDown = false;

  window.addEventListener("keydown", (ev)=>{
    if(ev.code === "Space"){
      isSpaceDown = true;
      ev.preventDefault();
    }

    if(ev.ctrlKey && !ev.shiftKey && ev.key.toLowerCase() === "z"){
      ev.preventDefault(); undo(); return;
    }
    if((ev.ctrlKey && ev.key.toLowerCase() === "y") || (ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase() === "z")){
      ev.preventDefault(); redo(); return;
    }
    if(ev.key === "Delete"){
      ev.preventDefault();
      deleteSelected();
    }
    if(ev.key === "Escape"){
      state.selectedId = null;
      renderHotspots();
      renderList();
    }
  });

  window.addEventListener("keyup", (ev)=>{
    if(ev.code === "Space") isSpaceDown = false;
  });

  // ===== panning with space =====
  let panning = false;
  let panStart = { x:0,y:0,vx:0,vy:0 };

  workspaceEl.addEventListener("mousedown", (ev)=>{
    if(isSpaceDown && ev.button===0){
      panning = true;
      panStart = { x: ev.clientX, y: ev.clientY, vx: view.x, vy: view.y };
      window.addEventListener("mousemove", onPan);
      window.addEventListener("mouseup", endPan, { once:true });
    }
  });

  function onPan(ev){
    if(!panning) return;
    view.x = panStart.vx + (ev.clientX - panStart.x);
    view.y = panStart.vy + (ev.clientY - panStart.y);
    updateStage();
  }
  function endPan(){
    window.removeEventListener("mousemove", onPan);
    panning = false;
  }

  // ===== zoom wheel =====
  workspaceEl.addEventListener("wheel", (ev)=>{
    if(ev.ctrlKey){
      ev.preventDefault();
      const factor = ev.deltaY < 0 ? 1.08 : 1/1.08;
      zoomBy(factor, ev.clientX, ev.clientY);
    }
  }, { passive:false });

  // ===== close =====
  function closePage(){
    // å›é¦–é ï¼ˆä¸æ”¹ç¶²å€ï¼‰
    window.location.href = "index.html";
  }

  // ===== boot =====
  (function init(){
    // worker url from homepage
    const savedUrl = (localStorage.getItem("line_worker_url") || "").trim();
    if(savedUrl) workerUrlEl.value = savedUrl;

    initArtboard();
    resetView();
    renderAll(true);
    pushHistory();
    refreshMenuList();
    setStatus("å°±ç·’ âœ…");
  })();
</script>

</body>
</html>
