<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LINE OA è‡ªè£½åŠŸèƒ½å¯¦é©—å®¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; }
    .card { background: white; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .toolCard{
      text-align:left; background:#f8fafc; border:1px solid #e2e8f0;
      border-radius:16px; padding:14px; transition:.15s;
    }
    .toolCard:hover{ transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .badge { font-size: 11px; padding: 3px 10px; border-radius: 999px; border: 1px solid; }
    .badge-db { background: #eff6ff; color:#1d4ed8; border-color:#dbeafe; }
    .badge-replies { background: #fffbeb; color:#b45309; border-color:#fef3c7; }
    .btn { font-weight: 800; border-radius: 14px; padding: 10px 14px; }
    .btnDark { background:#0f172a; color:#fff; }
    .btnDark:hover { background:#000; }
    .btnGreen { background:#059669; color:#fff; }
    .btnGreen:hover { background:#047857; }
    .btnRed { background:#e11d48; color:#fff; }
    .btnRed:hover { background:#be123c; }
    .btnGhost { background:#fff; border:1px solid #e2e8f0; }
    .btnGhost:hover { background:#f1f5f9; }
  </style>
</head>

<body class="min-h-screen p-4 text-slate-800">
  <div class="max-w-5xl mx-auto space-y-4">

    <!-- Header -->
    <div class="card p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-5xl">ğŸ§ª</div>
          <h1 class="text-2xl font-extrabold mt-2">LINE OA è‡ªè£½åŠŸèƒ½å¯¦é©—å®¤ï¼ˆç¸½è¦½ / æ§ç®¡ï¼‰</h1>
          <p class="text-sm text-slate-500 mt-1">
            ä½ æ‰€æœ‰è‡ªè£½åŠŸèƒ½çš„ã€Œç ”ç™¼ç®¡ç†é ã€ã€‚åŒæ™‚åˆ—å‡º KV è£¡æ‰€æœ‰é—œéµå­—è³‡æ–™ï¼ˆåŒ…å«ä½ å¿˜äº†åœ¨å“ªåšçš„ï¼‰ã€‚
          </p>
        </div>
        <div class="text-right">
          <a href="index.html" class="btn btnDark inline-block">å›é¦–é </a>
        </div>
      </div>

      <!-- Worker URL -->
      <div class="mt-4 bg-slate-100 rounded-xl p-4">
        <label class="block text-xs font-bold text-slate-600 mb-1">Worker ç¶²å€ï¼ˆå¿…å¡«ï¼‰</label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="workerUrl" placeholder="https://api.xxx.workers.dev"
                 class="flex-1 border rounded-xl p-2 text-sm bg-white"
                 oninput="saveWorkerUrl(this.value)">
          <button class="btn btnGreen" onclick="reloadAll()">è¼‰å…¥æ‰€æœ‰è³‡æ–™</button>
        </div>
        <div class="mt-2 text-[12px] text-slate-600">
          æ³¨æ„ï¼šä½ ç›®å‰ Worker æ˜¯ã€Œç„¡å¯†ç¢¼ç®¡ç†ã€ï¼ŒçŸ¥é“ Worker URL çš„äººå°±èƒ½æ”¹ä½ çš„è³‡æ–™ï¼ˆä½ æ¥å—é€™å€‹æ¨¡å¼æ‰ç”¨ï¼‰ã€‚
        </div>
      </div>

      <!-- Status -->
      <div id="status" class="mt-3 text-sm"></div>
    </div>

    <!-- Tools -->
    <div class="card p-6">
      <h2 class="font-extrabold text-lg mb-3">å›ºå®šå·¥å…·å…¥å£ï¼ˆä½ é¦–é é‚£å¹¾å€‹ï¼‰</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">

        <button class="toolCard" onclick="go('liff_popup_imagemap.html')">
          <div class="text-3xl">ğŸ“±</div>
          <div class="font-bold mt-1">æ‰‹æ©Ÿé è¦½å¼•æµåœ–ï¼ˆLIFF å½ˆçª—ï¼‰</div>
          <div class="text-xs text-slate-500">æŠ½å±œé è¦½ / ç•«æ¡†ä¸é™ / ä¸Šå‚³åˆ° R2</div>
        </button>

        <button class="toolCard" onclick="go('tool_imagemap.html')">
          <div class="text-3xl">ğŸ—ºï¸</div>
          <div class="font-bold mt-1">å¼•æµåœ–å·¥å…·</div>
          <div class="text-xs text-slate-500">å¤§åœ–é»æ“Šã€å¤šåœ–å›è¦†</div>
        </button>

        <button class="toolCard" onclick="go('tool_carousel.html')">
          <div class="text-3xl">ğŸ </div>
          <div class="font-bold mt-1">æ»‘å‹•å¡ç‰‡</div>
          <div class="text-xs text-slate-500">å¤šåœ–è¼ªæ’­</div>
        </button>

        <button class="toolCard" onclick="go('tool_flow.html')">
          <div class="text-3xl">ğŸ”€</div>
          <div class="font-bold mt-1">è¦‹è­‰æµç¨‹</div>
          <div class="text-xs text-slate-500">é€£çºŒè·³è½‰</div>
        </button>

        <button class="toolCard ring-2 ring-rose-200" onclick="go('tool_quickreply.html')">
          <div class="text-3xl">ğŸ”´</div>
          <div class="font-bold mt-1">ç´…è‰²æ¡†æ¡† Quick Reply</div>
          <div class="text-xs text-slate-500">æ–‡å­— + åº•éƒ¨æµ®å‹•æŒ‰éˆ•</div>
        </button>

      </div>
      <div class="text-[12px] text-slate-500 mt-3">
        é€™äº›å…¥å£åªè² è²¬æ‰“é–‹ä½  GitHub Pages çš„å·¥å…·é ï¼›è³‡æ–™çš„è®€å¯«éƒ½èµ° Worker KVã€‚
      </div>
    </div>

    <!-- KV Explorer -->
    <div class="card p-6 space-y-3">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div>
          <h2 class="font-extrabold text-lg">é›²ç«¯è³‡æ–™åº«æ¢ç´¢ï¼ˆDB + REPLIESï¼‰</h2>
          <div class="text-xs text-slate-500">
            æœƒåˆ—å‡ºä½  KV è£¡æ‰€æœ‰ keywordï¼›ä½ å¯ä»¥æœå°‹ã€é è¦½å…§å®¹ã€åˆªé™¤æ¸…ç†ã€‚
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btnGhost" onclick="reloadAll()">é‡æ–°æ•´ç†</button>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-2">
        <input id="search" placeholder="æœå°‹ keywordï¼ˆä¾‹å¦‚ï¼šé¸å–® / ç‡Ÿé¤Š / ç”¢å“ / å¡ç‰‡ï¼‰"
               class="flex-1 border rounded-xl p-2 text-sm"
               oninput="renderList()">
        <select id="nsFilter" class="border rounded-xl p-2 text-sm" onchange="renderList()">
          <option value="ALL">å…¨éƒ¨ namespace</option>
          <option value="DB">DBï¼ˆBOT_DATAï¼‰</option>
          <option value="REPLIES">REPLIESï¼ˆrepliesï¼‰</option>
        </select>
      </div>

      <div id="stats" class="text-[12px] text-slate-500"></div>
      <div id="list" class="space-y-2"></div>

      <div class="mt-2 text-[12px] text-slate-500">
        è‹¥ä½ çœ‹ä¸åˆ°ä»»ä½•è³‡æ–™ï¼šé€šå¸¸æ˜¯ Worker URL ä¸å°ã€æˆ– Worker å°šæœªåŠ ä¸Š <span class="font-bold">/listAll /loadAny /deleteAny</span>ã€‚
      </div>
    </div>

    <div class="text-center text-[12px] text-slate-400 mt-2">
      Powered by GitHub Pages + Cloudflare Workers (KV/R2)
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl overflow-hidden">
      <div class="bg-slate-900 text-white p-4 flex items-center justify-between">
        <div class="font-bold" id="modalTitle">å…§å®¹é è¦½</div>
        <button class="opacity-80 hover:opacity-100" onclick="closeModal()">âœ•</button>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex flex-wrap gap-2 items-center">
          <span id="modalBadge" class="badge badge-db">DB</span>
          <span class="text-[12px] text-slate-500">ï¼ˆé€™è£¡åªé è¦½ï¼Œä¸æœƒä¿®æ”¹å…§å®¹ï¼‰</span>
        </div>
        <pre id="modalBody" class="text-xs bg-slate-50 border rounded-xl p-3 overflow-auto max-h-[60vh]"></pre>
      </div>
    </div>
  </div>

<script>
  // ====== Storage Keys ======
  const WORKER_KEY = 'line_worker_url';

  // ====== State ======
  let ALL_KEYS = []; // [{ ns:'DB'|'REPLIES', key:string }]

  window.onload = () => {
    const saved = localStorage.getItem(WORKER_KEY);
    if (saved) document.getElementById('workerUrl').value = saved;

    // é€²ä¾†å…ˆä¸è‡ªå‹•è¼‰å…¥ï¼Œé¿å…æ²’å¡« URL å°±ä¸€ç›´å ±éŒ¯
  };

  function setStatus(msg, type='info'){
    const el = document.getElementById('status');
    const cls = type==='ok' ? 'text-emerald-700' : type==='err' ? 'text-rose-700' : 'text-slate-600';
    el.className = `mt-3 text-sm ${cls}`;
    el.textContent = msg;
  }

  function saveWorkerUrl(v){
    localStorage.setItem(WORKER_KEY, (v||'').trim());
  }

  function getWorker(){
    let w = (document.getElementById('workerUrl').value || '').trim();
    w = w.replace(/\/+$/, '');
    if(!w){
      alert('è«‹å…ˆè¼¸å…¥ Worker ç¶²å€');
      document.getElementById('workerUrl').focus();
      return null;
    }
    saveWorkerUrl(w);
    return w;
  }

  function go(page){
    const w = getWorker();
    if(!w) return;
    window.location.href = page;
  }

  async function postJSON(fullUrl, data){
    const res = await fetch(fullUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data || {})
    });
    const out = await res.json().catch(()=>null);
    return {res, out};
  }

  // ====== Load All Keys ======
  async function reloadAll(){
    const w = getWorker();
    if(!w) return;

    setStatus('è¼‰å…¥ä¸­â€¦', 'info');
    ALL_KEYS = [];
    document.getElementById('list').innerHTML = '<div class="text-slate-400 text-sm">è¼‰å…¥ä¸­...</div>';

    // 1) æ–°ç‰ˆï¼š/listAll
    try{
      const r = await postJSON(w + '/listAll', {});
      if(r.res.ok && r.out && r.out.ok){
        const db = Array.isArray(r.out.db) ? r.out.db : [];
        const rep = Array.isArray(r.out.replies) ? r.out.replies : [];
        ALL_KEYS = [
          ...db.map(k => ({ns:'DB', key:k})),
          ...rep.map(k => ({ns:'REPLIES', key:k}))
        ];
        setStatus(`è¼‰å…¥æˆåŠŸï¼šDB ${db.length} ç­† / REPLIES ${rep.length} ç­†`, 'ok');
        renderList();
        return;
      }
    }catch(e){
      // continue fallback
    }

    // 2) fallbackï¼šèˆŠç‰ˆåªæœ‰ /listï¼ˆDBï¼‰
    try{
      const r = await postJSON(w + '/list', {});
      const keywords = (r.out && r.out.keywords) ? r.out.keywords : [];
      ALL_KEYS = keywords.map(k => ({ns:'DB', key:k}));
      setStatus(`è¼‰å…¥æˆåŠŸï¼ˆèˆŠæ¨¡å¼ï¼‰ï¼šDB ${keywords.length} ç­†ã€‚å»ºè­°ä½ æ›´æ–° Worker æ”¯æ´ /listAll /loadAny /deleteAnyã€‚`, 'ok');
      renderList();
      return;
    }catch(e){
      setStatus('è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª Worker URL æ­£ç¢ºã€ä¸” Worker æœ‰é–‹ CORSã€‚', 'err');
      document.getElementById('list').innerHTML =
        '<div class="text-rose-600 text-sm">è¼‰å…¥å¤±æ•—ï¼š' + escapeHtml(e.message) + '</div>';
    }
  }

  // ====== Render List ======
  function renderList(){
    const q = (document.getElementById('search').value || '').trim().toLowerCase();
    const ns = document.getElementById('nsFilter').value;

    let rows = ALL_KEYS.slice();
    if(ns !== 'ALL') rows = rows.filter(x => x.ns === ns);
    if(q) rows = rows.filter(x => x.key.toLowerCase().includes(q));

    document.getElementById('stats').textContent =
      `å…± ${ALL_KEYS.length} ç­†ï¼ˆç›®å‰é¡¯ç¤º ${rows.length} ç­†ï¼‰`;

    const list = document.getElementById('list');
    list.innerHTML = '';

    if(!rows.length){
      list.innerHTML = '<div class="text-slate-400 text-sm">æ²’æœ‰è³‡æ–™</div>';
      return;
    }

    rows.forEach(x=>{
      const badgeClass = x.ns === 'DB' ? 'badge-db' : 'badge-replies';
      const badgeText = x.ns === 'DB' ? 'DB' : 'REPLIES';

      list.innerHTML += `
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 border rounded-2xl p-3 bg-slate-50">
          <div class="flex items-center gap-2 min-w-0">
            <span class="badge ${badgeClass}">${badgeText}</span>
            <div class="font-bold truncate">${escapeHtml(x.key)}</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btnGhost" onclick="previewKey('${x.ns}','${escapeJs(x.key)}')">é è¦½</button>
            <button class="btn btnRed" onclick="deleteKey('${x.ns}','${escapeJs(x.key)}')">åˆªé™¤</button>
          </div>
        </div>
      `;
    });
  }

  // ====== Preview / Delete ======
  async function previewKey(ns, key){
    const w = getWorker();
    if(!w) return;

    // æ–°ç‰ˆï¼š/loadAny
    try{
      const r = await postJSON(w + '/loadAny', { namespace: ns, keyword: key });
      if(r.res.ok && r.out && r.out.ok){
        const payload = r.out.payload;
        const text = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
        showModal(ns, key, text);
        return;
      }else{
        // è‹¥ worker å›å‚³ ok:false
        const err = r.out && r.out.error ? r.out.error : 'è®€å–å¤±æ•—';
        alert(err);
        return;
      }
    }catch(e){
      // fallback
    }

    // fallbackï¼šèˆŠ /load åªæ”¯æ´ DBï¼ˆä¸”èˆŠç‰ˆä½ ä¹‹å‰æœ‰å¯†ç¢¼ï¼‰
    if(ns !== 'DB'){
      alert('ä½ çš„ Worker å°šæœªæ”¯æ´è®€å– REPLIESï¼ˆè«‹æ›´æ–° worker.js åŠ ä¸Š /loadAnyï¼‰');
      return;
    }

    try{
      const r = await postJSON(w + '/load', { keyword: key });
      if(r.res.ok && r.out){
        showModal(ns, key, JSON.stringify(r.out, null, 2));
        return;
      }
    }catch(e){}

    alert('è®€å–å¤±æ•—ï¼šè«‹æ›´æ–° Worker æ”¯æ´ /loadAny');
  }

  async function deleteKey(ns, key){
    const w = getWorker();
    if(!w) return;

    if(!confirm(`ç¢ºå®šåˆªé™¤ï¼Ÿ\n${ns} / ${key}\nåˆªäº†å°±ä¸èƒ½å¾©åŸ`)) return;

    try{
      const r = await postJSON(w + '/deleteAny', { namespace: ns, keyword: key });
      if(r.res.ok && r.out && r.out.ok){
        ALL_KEYS = ALL_KEYS.filter(x => !(x.ns===ns && x.key===key));
        renderList();
        alert('å·²åˆªé™¤');
        return;
      }else{
        const err = r.out && r.out.error ? r.out.error : 'åˆªé™¤å¤±æ•—';
        alert(err);
        return;
      }
    }catch(e){
      alert('åˆªé™¤å¤±æ•—ï¼šä½ çš„ Worker å¯èƒ½é‚„æ²’æ”¯æ´ /deleteAny');
    }
  }

  // ====== Modal ======
  function showModal(ns, key, body){
    document.getElementById('modalTitle').textContent = `${key}`;
    const badge = document.getElementById('modalBadge');
    badge.textContent = ns === 'DB' ? 'DB' : 'REPLIES';
    badge.className = 'badge ' + (ns === 'DB' ? 'badge-db' : 'badge-replies');

    document.getElementById('modalBody').textContent = body;

    const m = document.getElementById('modal');
    m.classList.remove('hidden');
    m.classList.add('flex');
  }

  function closeModal(){
    const m = document.getElementById('modal');
    m.classList.add('hidden');
    m.classList.remove('flex');
  }

  // ====== Escape Helpers ======
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeJs(s){
    return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  }
</script>
</body>
</html>
