<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LINE OA è‡ªè£½åŠŸèƒ½å¯¦é©—å®¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; }
  </style>
</head>
<body class="min-h-screen p-4 text-slate-800">
  <div class="max-w-5xl mx-auto space-y-4">

    <!-- Header -->
    <div class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-4xl">ğŸ§ª</div>
          <h1 class="text-2xl font-extrabold mt-2">LINE OA è‡ªè£½åŠŸèƒ½å¯¦é©—å®¤ï¼ˆç¸½è¦½ï¼‹æ§ç®¡ï¼‰</h1>
          <p class="text-sm text-slate-500 mt-1">
            ä½ åšéçš„æ‰€æœ‰è‡ªè£½åŠŸèƒ½ + æ‰€æœ‰ KV å…§çš„é—œéµå­—è³‡æ–™ï¼ˆåŒ…å«ä½ å¿˜è¨˜åšåœ¨å“ªè£¡çš„ï¼‰ã€‚
          </p>
        </div>
        <div class="text-right">
          <a href="index.html" class="inline-block px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-bold hover:bg-black">
            å›é¦–é 
          </a>
        </div>
      </div>

      <!-- Worker URL -->
      <div class="mt-4 bg-slate-100 rounded-xl p-4">
        <label class="block text-xs font-bold text-slate-600 mb-1">Worker ç¶²å€ï¼ˆå¿…å¡«ï¼Œè·¨è¨­å‚™å…±ç”¨åŒä¸€ä»½é›²ç«¯ KVï¼‰</label>
        <div class="flex gap-2">
          <input id="workerUrl" placeholder="https://api.xxx.workers.dev"
                 class="flex-1 border rounded-xl p-2 text-sm bg-white"
                 oninput="saveWorkerUrl(this.value)">
          <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-bold hover:bg-emerald-700"
                  onclick="reloadAll()">è¼‰å…¥æ‰€æœ‰è³‡æ–™</button>
        </div>
        <div class="mt-2 text-[12px] text-slate-600">
          ä½ ç¾åœ¨è¨­å®šç‚ºã€Œç„¡å¯†ç¢¼ã€ï¼Œæ‰€ä»¥åªè¦çŸ¥é“ Worker URL å°±èƒ½æ”¹è³‡æ–™ï¼ˆä½ æ¥å—é€™å€‹æ–¹å¼æˆ‘å°±ç…§åšï¼‰ã€‚
        </div>
      </div>
    </div>

    <!-- Tools -->
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="font-extrabold text-lg mb-3">ä½ ç›®å‰çš„å·¥å…·ï¼ˆå›ºå®šå…¥å£ï¼‰</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">

        <button class="toolCard" onclick="openTool('liff_popup_imagemap.html')">
          <div class="text-3xl">ğŸ“±</div>
          <div class="font-bold mt-1">æ‰‹æ©Ÿé è¦½å¼•æµåœ–ï¼ˆLIFF å½ˆçª—ï¼‰</div>
          <div class="text-xs text-slate-500">æŠ½å±œé è¦½ / ç•«æ¡†ä¸é™ / R2</div>
        </button>

        <button class="toolCard" onclick="openTool('tool_imagemap.html')">
          <div class="text-3xl">ğŸ—ºï¸</div>
          <div class="font-bold mt-1">å¼•æµåœ–å·¥å…·</div>
          <div class="text-xs text-slate-500">å¤§åœ–é»æ“Šã€å¤šåœ–å›è¦†</div>
        </button>

        <button class="toolCard" onclick="openTool('tool_carousel.html')">
          <div class="text-3xl">ğŸ </div>
          <div class="font-bold mt-1">æ»‘å‹•å¡ç‰‡</div>
          <div class="text-xs text-slate-500">å¤šåœ–è¼ªæ’­</div>
        </button>

        <button class="toolCard" onclick="openTool('tool_flow.html')">
          <div class="text-3xl">ğŸ”€</div>
          <div class="font-bold mt-1">è¦‹è­‰æµç¨‹</div>
          <div class="text-xs text-slate-500">é€£çºŒè·³è½‰</div>
        </button>

        <button class="toolCard ring-2 ring-rose-200" onclick="openTool('tool_quickreply.html')">
          <div class="text-3xl">ğŸ”´</div>
          <div class="font-bold mt-1">ç´…è‰²æ¡†æ¡† Quick Reply</div>
          <div class="text-xs text-slate-500">æ–‡å­— + åº•éƒ¨æµ®å‹•æŒ‰éˆ•</div>
        </button>

      </div>
      <style>
        .toolCard{
          text-align:left; background:#f8fafc; border:1px solid #e2e8f0;
          border-radius:16px; padding:14px; transition:.15s;
        }
        .toolCard:hover{ transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.08); }
      </style>
    </div>

    <!-- KV Explorer -->
    <div class="bg-white rounded-2xl shadow p-6 space-y-3">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="font-extrabold text-lg">é›²ç«¯è³‡æ–™åº«æ¢ç´¢ï¼ˆä½ å¿˜äº†åœ¨å“ªåšçš„éƒ½æœƒå‡ºç¾ï¼‰</h2>
          <div class="text-xs text-slate-500">æœƒåŒæ™‚åˆ—å‡º DB èˆ‡ REPLIES å…©å€‹ KV namespaceï¼ˆå¦‚æœä½ çš„ Worker æœ‰ç¶ REPLIESï¼‰ã€‚</div>
        </div>
        <button class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-bold hover:bg-black"
                onclick="reloadAll()">é‡æ–°æ•´ç†</button>
      </div>

      <div class="flex flex-col sm:flex-row gap-2">
        <input id="search" placeholder="æœå°‹é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šç‡Ÿé¤Š / é€£ç·šéŒ¯èª¤ / é¸å–®ï¼‰"
               class="flex-1 border rounded-xl p-2 text-sm"
               oninput="renderList()">
        <select id="nsFilter" class="border rounded-xl p-2 text-sm" onchange="renderList()">
          <option value="ALL">å…¨éƒ¨ namespace</option>
          <option value="DB">DBï¼ˆBOT_DATAï¼‰</option>
          <option value="REPLIES">REPLIESï¼ˆrepliesï¼‰</option>
        </select>
      </div>

      <div id="stats" class="text-[12px] text-slate-500"></div>
      <div id="list" class="space-y-2"></div>
    </div>

  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl overflow-hidden">
      <div class="bg-slate-900 text-white p-4 flex items-center justify-between">
        <div class="font-bold" id="modalTitle">å…§å®¹é è¦½</div>
        <button class="opacity-80 hover:opacity-100" onclick="closeModal()">âœ•</button>
      </div>
      <div class="p-4">
        <pre id="modalBody" class="text-xs bg-slate-50 border rounded-xl p-3 overflow-auto max-h-[60vh]"></pre>
      </div>
    </div>
  </div>

<script>
  // ====== storage ======
  const WORKER_KEY = 'line_worker_url';

  window.onload = () => {
    const saved = localStorage.getItem(WORKER_KEY);
    if(saved) document.getElementById('workerUrl').value = saved;
  };

  function saveWorkerUrl(v){
    localStorage.setItem(WORKER_KEY, (v||'').trim());
  }

  function mustWorker(){
    const w = (document.getElementById('workerUrl').value || '').trim().replace(/\/+$/, '');
    if(!w){
      alert('è«‹å…ˆè¼¸å…¥ Worker ç¶²å€');
      document.getElementById('workerUrl').focus();
      return null;
    }
    saveWorkerUrl(w);
    return w;
  }

  function openTool(page){
    const w = mustWorker();
    if(!w) return;
    window.location.href = page;
  }

  // ====== API ======
  async function postJSON(fullUrl, data){
    const res = await fetch(fullUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data || {})
    });
    const out = await res.json().catch(()=>null);
    return {res, out};
  }

  // ====== Data ======
  let ALL_KEYS = []; // { ns:'DB'|'REPLIES', key:string }

  async function reloadAll(){
    const w = mustWorker();
    if(!w) return;

    ALL_KEYS = [];
    document.getElementById('list').innerHTML = '<div class="text-slate-400 text-sm">è¼‰å…¥ä¸­...</div>';

    // 1) listAllï¼ˆæ–°ç‰ˆ workerï¼‰å¦‚æœæ²’æœ‰å°± fallback èˆŠç‰ˆ /list
    let result = null;
    try{
      const r = await postJSON(w + '/listAll', {});
      if(r.res.ok && r.out && r.out.ok) result = r.out;
    }catch(e){}

    if(result){
      const db = Array.isArray(result.db) ? result.db : [];
      const rep = Array.isArray(result.replies) ? result.replies : [];
      ALL_KEYS = [
        ...db.map(k => ({ns:'DB', key:k})),
        ...rep.map(k => ({ns:'REPLIES', key:k}))
      ];
      renderList();
      return;
    }

    // fallback: èˆŠ worker åªæœ‰ /listï¼ˆå› ok+keywordsï¼‰
    try{
      const r = await postJSON(w + '/list', {});
      const keywords = (r.out && r.out.keywords) ? r.out.keywords : [];
      ALL_KEYS = keywords.map(k => ({ns:'DB', key:k}));
      renderList();
    }catch(e){
      document.getElementById('list').innerHTML = '<div class="text-rose-600 text-sm">è®€å–å¤±æ•—ï¼š' + e.message + '</div>';
    }
  }

  function renderList(){
    const q = (document.getElementById('search').value || '').trim().toLowerCase();
    const ns = document.getElementById('nsFilter').value;

    let rows = ALL_KEYS.slice();

    if(ns !== 'ALL') rows = rows.filter(x => x.ns === ns);
    if(q) rows = rows.filter(x => x.key.toLowerCase().includes(q));

    document.getElementById('stats').textContent =
      `å…± ${ALL_KEYS.length} ç­†ï¼ˆç›®å‰é¡¯ç¤º ${rows.length} ç­†ï¼‰`;

    const list = document.getElementById('list');
    list.innerHTML = '';

    if(!rows.length){
      list.innerHTML = '<div class="text-slate-400 text-sm">æ²’æœ‰è³‡æ–™</div>';
      return;
    }

    rows.forEach(x=>{
      const badge = x.ns === 'DB'
        ? '<span class="text-[11px] px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">DB</span>'
        : '<span class="text-[11px] px-2 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-100">REPLIES</span>';

      list.innerHTML += `
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 border rounded-2xl p-3 bg-slate-50">
          <div class="flex items-center gap-2 min-w-0">
            ${badge}
            <div class="font-bold truncate">${escapeHtml(x.key)}</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-2 rounded-xl bg-white border text-sm font-bold hover:bg-slate-100"
                    onclick="previewKey('${x.ns}','${escapeJs(x.key)}')">é è¦½</button>
            <button class="px-3 py-2 rounded-xl bg-rose-600 text-white text-sm font-bold hover:bg-rose-700"
                    onclick="deleteKey('${x.ns}','${escapeJs(x.key)}')">åˆªé™¤</button>
          </div>
        </div>
      `;
    });
  }

  async function previewKey(ns, key){
    const w = mustWorker();
    if(!w) return;

    // æ–°ç‰ˆ workerï¼š/loadAny
    try{
      const r = await postJSON(w + '/loadAny', { namespace: ns, keyword: key });
      if(r.res.ok && r.out && r.out.ok){
        showModal(`${ns} / ${key}`, JSON.stringify(r.out.payload, null, 2));
        return;
      }
    }catch(e){}

    // fallback èˆŠç‰ˆï¼š/load åªæ”¯æ´ DB
    if(ns !== 'DB'){
      alert('ä½ çš„ Worker é‚„æ²’æ”¯æ´ REPLIES çš„è®€å–ï¼ˆéœ€è¦æ›´æ–° worker.jsï¼‰');
      return;
    }

    try{
      const r = await postJSON(w + '/load', { keyword: key, password: "1234" }); // èˆŠç‰ˆéœ€è¦å¯†ç¢¼
      if(r.res.ok && r.out){
        showModal(`${ns} / ${key}`, JSON.stringify(r.out, null, 2));
      }else{
        alert('è®€å–å¤±æ•—');
      }
    }catch(e){
      alert('è®€å–å¤±æ•—ï¼š' + e.message);
    }
  }

  async function deleteKey(ns, key){
    const w = mustWorker();
    if(!w) return;

    if(!confirm(`ç¢ºå®šåˆªé™¤ï¼Ÿ\n${ns} / ${key}\nåˆªäº†å°±ä¸èƒ½å¾©åŸ`)) return;

    // æ–°ç‰ˆ workerï¼š/deleteAny
    try{
      const r = await postJSON(w + '/deleteAny', { namespace: ns, keyword: key });
      if(r.res.ok && r.out && r.out.ok){
        ALL_KEYS = ALL_KEYS.filter(x => !(x.ns===ns && x.key===key));
        renderList();
        alert('å·²åˆªé™¤');
        return;
      }
    }catch(e){}

    alert('åˆªé™¤å¤±æ•—ï¼šä½ çš„ Worker å¯èƒ½é‚„æ²’æ›´æ–°åˆ°æ”¯æ´ deleteAny');
  }

  function showModal(title, body){
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').textContent = body;
    const m = document.getElementById('modal');
    m.classList.remove('hidden');
    m.classList.add('flex');
  }
  function closeModal(){
    const m = document.getElementById('modal');
    m.classList.add('hidden');
    m.classList.remove('flex');
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeJs(s){
    return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  }
</script>
</body>
</html>
