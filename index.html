<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE è¬èƒ½ç·¨è¼¯å™¨ (v21.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; overscroll-behavior: none; }
        
        /* ç•«å¸ƒå®¹å™¨ */
        .canvas-scroll-container { border: 2px dashed #cbd5e1; background: #f8fafc radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; position: relative; display: flex; align-items: center; justify-content: center; overflow: auto; height: 100%; }
        .canvas-content-wrapper { position: relative; transform-origin: center top; transition: width 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .area-box { position: absolute; border: 2px solid rgba(239,68,68,0.9); background: rgba(239,68,68,0.2); cursor: move; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px black; user-select: none; touch-action: none; }
        .area-box.selected { border-color: #f59e0b; background: rgba(245,158,11,0.3); z-index: 20; }
        
        /* UI å…ƒä»¶ */
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: #f1f5f9; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .tab-btn { opacity: 0.6; border-bottom: 4px solid transparent; } .tab-btn.active { opacity: 1; border-bottom: 4px solid #4f46e5; color: #4f46e5; background: #eef2ff; }
        .card-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; cursor: pointer; transition: all 0.2s; } .card-dot.active { background: #4f46e5; transform: scale(1.3); }
        .code-block-slim { background: #1e293b; color: #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.75rem; border: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        
        /* æ‰‹æ©Ÿæ¨¡æ“¬å™¨æ¨£å¼ */
        .phone-mockup { width: 300px; height: 580px; background: #fff; border-radius: 30px; border: 8px solid #1f2937; position: relative; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        .phone-notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100px; height: 20px; background: #1f2937; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; z-index: 50; }
        .phone-header { background: #1f2937; color: white; padding: 25px 15px 10px; font-size: 12px; text-align: center; }
        .chat-bg { background-color: #849ebf; flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 10px; }
        .bubble-container { overflow-x: auto; display: flex; gap: 10px; padding-bottom: 5px; scroll-snap-type: x mandatory; padding-right: 20px; }
        .line-bubble { min-width: 240px; max-width: 240px; background: white; border-radius: 12px; overflow: hidden; scroll-snap-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .bubble-hero { width: 100%; height: 160px; object-fit: cover; background: #f1f5f9; }
        .bubble-body { padding: 12px; flex: 1; }
        .bubble-title { font-weight: bold; font-size: 16px; color: #1e293b; margin-bottom: 4px; line-height: 1.2; }
        .bubble-text { font-size: 12px; color: #64748b; line-height: 1.4; }
        .bubble-footer { padding: 0 12px 12px; display: flex; flex-direction: column; gap: 6px; }
        .line-btn { display: block; width: 100%; text-align: center; padding: 8px 0; background: #eff6ff; color: #42659a; font-weight: bold; font-size: 12px; border-radius: 6px; cursor: pointer; transition: bg 0.2s; text-decoration: none; }
        .line-btn:hover { background: #dbeafe; }

        @media (min-width: 768px) { body { height: 100vh; overflow: hidden; } #main-layout { height: 100%; overflow: hidden; } }
    </style>
</head>
<body class="bg-slate-50 flex flex-col text-slate-800">

    <div id="topSection" class="flex-shrink-0 bg-white shadow-sm z-30">
        <header class="border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-3 md:px-4 h-14 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-white text-lg shadow-lg shrink-0">ğŸ¦</div>
                    <div>
                        <h1 class="font-bold text-base md:text-lg tracking-wide text-slate-800">
                            LINE è¬èƒ½ç·¨è¼¯å™¨ <span class="text-[10px] bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded-full border border-emerald-200">v21.0 Tokenç‰ˆ</span>
                        </h1>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openModal('projectsModal')" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1">
                        ğŸ“‚ ä½œå“é›†
                    </button>
                    <button onclick="saveProject()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-md transition flex items-center gap-1">
                        ğŸ’¾ å„²å­˜
                    </button>
                    <button onclick="openModal('tutorialModal')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-md transition flex items-center gap-1">
                        ğŸ¤– ç¨‹å¼ç¢¼
                    </button>
                </div>
            </div>
        </header>

        <div class="border-b border-slate-200 bg-slate-50">
            <div class="max-w-7xl mx-auto flex overflow-x-auto">
                <button onclick="switchTab('imagemap')" id="tab-imagemap" class="tab-btn active flex-1 py-2 font-bold text-sm transition flex items-center justify-center gap-1 whitespace-nowrap">ğŸ—ºï¸ åº§æ¨™å¼•æµåœ–</button>
                <button onclick="switchTab('carousel')" id="tab-carousel" class="tab-btn flex-1 py-2 font-bold text-sm transition flex items-center justify-center gap-1 whitespace-nowrap">ğŸ  æ»‘å‹•å¡ç‰‡</button>
                <button onclick="switchTab('flow')" id="tab-flow" class="tab-btn flex-1 py-2 font-bold text-sm transition flex items-center justify-center gap-1 bg-rose-50 text-rose-700 whitespace-nowrap">ğŸ”— å°è¦½æµç¨‹</button>
            </div>
        </div>
    </div>

    <div id="main-layout" class="flex flex-col md:flex-row flex-1 max-w-7xl mx-auto w-full bg-white relative">
        
        <aside class="w-full md:w-[400px] border-b md:border-b-0 md:border-r border-slate-200 flex flex-col z-20 bg-white flex-shrink-0 max-h-[45vh] md:max-h-full overflow-hidden">
            
            <div id="flowStepNav" class="hidden grid grid-cols-4 gap-1 p-1 md:p-2 bg-slate-100 border-b flex-shrink-0">
                <button onclick="switchFlowStep(0)" id="flow-step-0" class="flow-step-btn active rounded py-1 md:py-2 text-[10px] md:text-xs font-bold transition">Step 1</button>
                <button onclick="switchFlowStep(1)" id="flow-step-1" class="flow-step-btn rounded py-1 md:py-2 text-[10px] md:text-xs font-bold transition">Step 2</button>
                <button onclick="switchFlowStep(2)" id="flow-step-2" class="flow-step-btn rounded py-1 md:py-2 text-[10px] md:text-xs font-bold transition">Step 3</button>
                <button onclick="switchFlowStep(3)" id="flow-step-3" class="flow-step-btn rounded py-1 md:py-2 text-[10px] md:text-xs font-bold transition">Step 4</button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-3 md:p-4 space-y-4">
                
                <div class="space-y-3 border-b border-slate-100 pb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-slate-400">å°ˆæ¡ˆï¼š</span>
                        <input type="text" id="projectName" value="æœªå‘½åå°ˆæ¡ˆ" class="text-sm font-bold text-slate-700 bg-transparent border-none focus:ring-0 p-0 w-full" onchange="markUnsaved()">
                    </div>
                    
                    <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                        <label class="text-[10px] font-bold text-yellow-800 block mb-1">ğŸ”‘ LINE Channel Access Token (è‡ªå‹•å¡«å…¥ä»£ç¢¼)</label>
                        <input type="text" id="lineTokenInput" placeholder="è«‹è²¼ä¸Š LINE Token..." class="w-full text-xs p-1.5 border border-yellow-300 rounded focus:outline-none focus:border-yellow-500" oninput="updateGasCode(); saveProjectSilent();">
                        <div class="text-[10px] text-yellow-600 mt-1 flex justify-between">
                            <span>* è²¼ä¸Šå¾Œä»£ç¢¼æœƒè‡ªå‹•æ›´æ–°</span>
                            <a href="https://developers.line.biz/console/" target="_blank" class="underline hover:text-yellow-800">å»å“ªè£¡æ‰¾?</a>
                        </div>
                    </div>
                </div>

                <div id="keywordBlock" class="bg-blue-50 rounded-xl p-3 border border-blue-100 space-y-1">
                    <label class="font-bold text-blue-800 text-xs">LINE è§¸ç™¼é—œéµå­—</label>
                    <input type="text" id="triggerKeyword" value="é¸å–®" class="w-full p-2 border border-blue-200 rounded text-sm focus:outline-none focus:border-blue-500 font-bold text-blue-700" oninput="updateGasCode()">
                </div>

                <div id="carouselControls" class="hidden space-y-3 p-3 bg-amber-50 rounded-xl border border-amber-100 shadow-sm">
                    <div class="flex justify-between items-center">
                        <label class="font-bold text-amber-800 text-sm">ğŸ“¦ å¡ç‰‡ç®¡ç†</label>
                        <div class="flex gap-2">
                            <button onclick="addCard()" class="bg-amber-500 text-white px-2 py-1 rounded text-xs hover:bg-amber-600 font-bold shadow">+ åŠ ä¸€å¼µ</button>
                            <button onclick="deleteCard()" class="text-red-500 text-xs hover:underline">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 justify-center flex-wrap" id="cardDots"></div>
                    <div class="text-center text-xs text-amber-700">æ­£åœ¨ç·¨è¼¯ç¬¬ <span id="currentCardNum" class="font-bold text-lg">1</span> å¼µ</div>
                </div>

                <div id="cardContentEditor" class="hidden space-y-2 bg-white p-3 rounded border border-slate-200">
                    <input type="text" id="cardTitleInput" placeholder="å¡ç‰‡æ¨™é¡Œ" class="w-full p-2 border rounded text-sm font-bold" oninput="updateCardContent('title', this.value)">
                    <textarea id="cardDescInput" placeholder="å¡ç‰‡æè¿°" class="w-full p-2 border rounded text-xs h-16" oninput="updateCardContent('desc', this.value)"></textarea>
                    <div class="space-y-1" id="cardBtnsArea"></div>
                    <button onclick="addCardBtn()" class="w-full text-center text-xs text-blue-500 border border-dashed border-blue-300 rounded py-1 hover:bg-blue-50">+ å¢åŠ æŒ‰éˆ•</button>
                </div>

                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <label class="block font-bold text-slate-700 text-xs mb-2" id="uploadLabel">1. ä¸Šå‚³åº•åœ– (è‡ªå‹•è¨˜æ†¶)</label>
                    <input type="file" id="imageInput" accept="image/*" class="block w-full text-xs file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-white file:text-slate-700 hover:file:bg-slate-100"/>
                </div>
                
                <div>
                    <label class="block font-bold text-slate-700 text-xs mb-1">2. åœ–ç‰‡ç¶²å€ (å¿…å¡«)</label>
                    <input type="text" id="imageUrl" placeholder="https://... çµå°¾æ˜¯ .jpg/.png" class="w-full p-2 border border-slate-300 rounded text-sm font-mono" oninput="saveCurrentDataState()">
                </div>

                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2 border-b pb-1">
                        <label class="font-bold text-slate-700 text-xs">3. é»æ“Šå€åŸŸ / æŒ‰éˆ•</label>
                        <button onclick="deleteSelectedAreas()" class="text-xs text-red-500 hover:underline">åˆªé™¤é¸å–</button>
                    </div>
                    <div id="actionList" class="space-y-2 pb-4"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-100 p-2 md:p-4 flex flex-col w-full md:w-auto overflow-hidden items-center justify-center">
            
            <div id="canvasWrapper" class="relative shadow-xl bg-white rounded-lg overflow-hidden border border-slate-300 w-full h-full max-w-3xl flex flex-col">
                <div class="bg-white border-b p-2 flex justify-between items-center flex-shrink-0">
                    <span class="text-xs font-bold text-slate-500">ğŸ” é è¦½</span>
                    <div class="flex gap-1">
                        <button onclick="adjustZoom(-10)" class="px-2 bg-slate-100 rounded">-</button>
                        <span id="zoomDisplay" class="text-xs px-1">100%</span>
                        <button onclick="adjustZoom(10)" class="px-2 bg-slate-100 rounded">+</button>
                    </div>
                </div>
                <div id="canvasContainer" class="canvas-scroll-container custom-scrollbar">
                    <div id="canvasContent" class="canvas-content-wrapper bg-white shadow-sm">
                        <div id="placeholder" class="flex flex-col items-center justify-center h-full w-full text-slate-300 absolute inset-0 m-auto p-4 text-center">
                            <span class="text-sm md:text-lg font-bold">è«‹å…ˆä¸Šå‚³åœ–ç‰‡</span>
                        </div>
                        <img id="previewImage" class="hidden block select-none pointer-events-none" style="width: 100%; display: block;" />
                        <div id="drawLayer" class="absolute inset-0 cursor-crosshair hidden z-10"></div>
                    </div>
                </div>
            </div>

            <div id="phoneSimulator" class="hidden">
                <div class="phone-mockup">
                    <div class="phone-notch"></div>
                    <div class="phone-header">LINE Preview</div>
                    <div class="chat-bg custom-scrollbar">
                        <div class="flex gap-2 items-start">
                            <div class="w-8 h-8 rounded-full bg-slate-300 flex-shrink-0"></div>
                            <div class="flex-1 overflow-hidden">
                                <div class="text-xs text-slate-600 mb-1">å®˜æ–¹å¸³è™Ÿ</div>
                                <div id="simBubbleContainer" class="bubble-container custom-scrollbar">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-slate-400 text-xs text-center mt-4">ğŸ‘† å¯å·¦å³æ»‘å‹•é è¦½å¯¦éš›æ•ˆæœ</p>
            </div>

        </main>
    </div>

    <div id="projectsModal" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50">
                <h2 class="text-lg font-bold text-indigo-900">ğŸ“‚ æˆ‘çš„ä½œå“é›†</h2>
                <button onclick="document.getElementById('projectsModal').classList.add('hidden')" class="text-2xl text-slate-400 hover:text-red-500">âœ•</button>
            </div>
            <div class="p-4 overflow-y-auto bg-slate-50 flex-1 space-y-3" id="projectsList"></div>
            <div class="p-4 border-t bg-white">
                <button onclick="createNewProject()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 shadow">+ å»ºç«‹æ–°å°ˆæ¡ˆ</button>
            </div>
        </div>
    </div>

    <div id="tutorialModal" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50">
                <h2 class="text-lg font-bold text-indigo-900">ğŸ¤– æ©Ÿå™¨äººæ¶è¨­ (Token è‡ªå‹•å¡«å…¥ç‰ˆ)</h2>
                <button onclick="document.getElementById('tutorialModal').classList.add('hidden')" class="text-slate-400 text-xl">âœ•</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6 text-sm">
                <div>
                    <h3 class="font-bold text-slate-800 mb-2">1. Google Apps Script ç¨‹å¼ç¢¼</h3>
                    <div class="code-block-slim">
                        <code class="text-green-400 flex-1 truncate" id="previewCodeLine">const CHANNEL_ACCESS_TOKEN = 'è«‹åœ¨å·¦å´å¡«å…¥ Token...'; ...</code>
                        <button onclick="copyCode()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-xs font-bold shrink-0">è¤‡è£½å®Œæ•´ç¨‹å¼ç¢¼</button>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">* ç³»çµ±å·²è‡ªå‹•å°‡æ‚¨è¼¸å…¥çš„ Token æ•´åˆé€²ç¨‹å¼ç¢¼ä¸­ï¼Œç›´æ¥è¤‡è£½è²¼ä¸Šå³å¯ï¼</p>
                    <pre id="gasCode" class="hidden"></pre>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-3 rounded border border-blue-100">
                        <b>å–å¾— Tokenï¼š</b> <a href="https://developers.line.biz/console/" target="_blank" class="text-blue-600 underline">LINE Developers</a> > Messaging API > æœ€ä¸‹æ–¹ Issue Tokenã€‚
                    </div>
                    <div class="bg-green-50 p-3 rounded border border-green-100">
                        <b>Webhook è¨­å®šï¼š</b> éƒ¨ç½² GAS å¾Œå–å¾—ç¶²å€ > <a href="https://manager.line.biz/" target="_blank" class="text-green-600 underline">LINE OA å¾Œå°</a> > è¨­å®š > Messaging API > è²¼ä¸Šä¸¦é–‹å•Ÿé–‹é—œã€‚
                    </div>
                </div>
                <div class="bg-red-50 p-3 rounded text-red-700 text-xs border border-red-100 font-bold text-center">
                    âš ï¸ éƒ¨ç½²æ™‚ã€Œèª°å¯ä»¥å­˜å– (Who has access)ã€ä¸€å®šè¦é¸ã€Œæ‰€æœ‰äºº (Anyone)ã€ï¼
                </div>
            </div>
        </div>
    </div>

    <div id="imageHelpModal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded p-6 relative max-w-sm"><button onclick="document.getElementById('imageHelpModal').classList.add('hidden')" class="absolute top-2 right-2">âœ•</button><h3 class="font-bold mb-2">åœ–ç‰‡ç¶²å€ï¼Ÿ</h3><p class="text-sm">è«‹ä½¿ç”¨ <a href="https://imgur.com/upload" target="_blank" class="text-blue-500 underline">Imgur</a> ä¸Šå‚³ï¼Œä¸¦å°åœ–ç‰‡æŒ‰å³éµã€Œè¤‡è£½åœ–ç‰‡ä½å€ã€ã€‚</p></div></div>

    <script>
        let currentMode = 'imagemap';
        let currentCardIndex = 0;
        let currentFlowStep = 0;
        let currentZoom = 100;
        let projectId = Date.now().toString();

        // Data Models
        let projectData = {
            id: projectId,
            name: "æœªå‘½åå°ˆæ¡ˆ",
            token: "",
            mode: "imagemap",
            imagemap: { imageUrl: "", localPreview: "", areas: [] },
            carousel: [{ title: "æ¨™é¡Œ", desc: "èªªæ˜", imageUrl: "", localPreview: "", btns: [{label:"æŒ‰éˆ•", text:"å›è¦†"}], areas:[] }],
            flow: [
                { name: "Step 1", imageUrl: "", localPreview: "", areas: [], trigger: "é–‹å§‹å°è¦½" },
                { name: "Step 2", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_2__" },
                { name: "Step 3", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_3__" },
                { name: "Step 4", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_4__" }
            ]
        };

        // UI Refs
        const refs = {
            imageInput: document.getElementById('imageInput'),
            imageUrl: document.getElementById('imageUrl'),
            previewImage: document.getElementById('previewImage'),
            drawLayer: document.getElementById('drawLayer'),
            actionList: document.getElementById('actionList'),
            placeholder: document.getElementById('placeholder'),
            triggerKeyword: document.getElementById('triggerKeyword'),
            canvasWrapper: document.getElementById('canvasWrapper'),
            phoneSimulator: document.getElementById('phoneSimulator'),
            cardContentEditor: document.getElementById('cardContentEditor'),
            cardTitleInput: document.getElementById('cardTitleInput'),
            cardDescInput: document.getElementById('cardDescInput'),
            cardBtnsArea: document.getElementById('cardBtnsArea'),
            projectName: document.getElementById('projectName'),
            lineTokenInput: document.getElementById('lineTokenInput'),
            previewCodeLine: document.getElementById('previewCodeLine')
        };
        
        let isDrawing = false, startX, startY, naturalWidth = 0, scaleFactor = 1;

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            loadProjectsList();
            updateUI();
            updateGasCode();
        });

        // ================= Project System =================
        function saveProject() {
            _saveToLocal();
            alert('å°ˆæ¡ˆå·²å„²å­˜ï¼');
            loadProjectsList();
        }
        
        function saveProjectSilent() {
            _saveToLocal();
        }

        function _saveToLocal() {
            projectData.name = refs.projectName.value;
            projectData.token = refs.lineTokenInput.value;
            projectData.lastModified = new Date().toLocaleString();
            
            const savedProjects = JSON.parse(localStorage.getItem('line_tool_projects') || '[]');
            const idx = savedProjects.findIndex(p => p.id === projectData.id);
            
            if(idx >= 0) savedProjects[idx] = projectData;
            else savedProjects.push(projectData);
            
            localStorage.setItem('line_tool_projects', JSON.stringify(savedProjects));
        }

        function loadProjectsList() {
            const list = document.getElementById('projectsList');
            const projects = JSON.parse(localStorage.getItem('line_tool_projects') || '[]');
            list.innerHTML = '';
            
            if(projects.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 py-10">å°šç„¡å„²å­˜çš„å°ˆæ¡ˆ</div>';
                return;
            }

            projects.sort((a,b) => new Date(b.lastModified) - new Date(a.lastModified)).forEach(p => {
                let thumb = 'https://via.placeholder.com/80?text=No+Img';
                if(p.mode === 'imagemap' && p.imagemap.localPreview) thumb = p.imagemap.localPreview;
                else if(p.mode === 'carousel' && p.carousel[0].localPreview) thumb = p.carousel[0].localPreview;
                else if(p.mode === 'flow' && p.flow[0].localPreview) thumb = p.flow[0].localPreview;

                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 bg-white p-3 rounded-lg border border-slate-200 hover:border-indigo-400 cursor-pointer transition';
                item.onclick = () => loadProject(p.id);
                item.innerHTML = `
                    <img src="${thumb}" class="w-12 h-12 rounded object-cover bg-slate-100">
                    <div class="flex-1">
                        <div class="font-bold text-slate-800 text-sm">${p.name}</div>
                        <div class="text-xs text-slate-500">${p.lastModified} â€¢ ${getModeName(p.mode)}</div>
                    </div>
                    <button onclick="deleteProject('${p.id}', event)" class="text-red-400 hover:text-red-600 px-2">âœ•</button>
                `;
                list.appendChild(item);
            });
        }

        function getModeName(m) {
            return m === 'imagemap' ? 'å¼•æµåœ–' : m === 'carousel' ? 'æ»‘å‹•å¡ç‰‡' : 'å°è¦½æµç¨‹';
        }

        function loadProject(id) {
            const projects = JSON.parse(localStorage.getItem('line_tool_projects') || '[]');
            const target = projects.find(p => p.id === id);
            if(target) {
                projectData = target;
                currentMode = projectData.mode;
                currentCardIndex = 0;
                currentFlowStep = 0;
                
                refs.projectName.value = projectData.name;
                refs.lineTokenInput.value = projectData.token || "";
                document.getElementById('projectsModal').classList.add('hidden');
                
                switchTab(currentMode);
            }
        }

        function createNewProject() {
            projectData = {
                id: Date.now().toString(),
                name: "æ–°å°ˆæ¡ˆ " + new Date().toLocaleDateString(),
                token: "",
                mode: "imagemap",
                imagemap: { imageUrl: "", localPreview: "", areas: [] },
                carousel: [{ title: "æ¨™é¡Œ", desc: "èªªæ˜", imageUrl: "", localPreview: "", btns: [{label:"æŒ‰éˆ•", text:"å›è¦†"}], areas:[] }],
                flow: [
                    { name: "Step 1", imageUrl: "", localPreview: "", areas: [], trigger: "é–‹å§‹å°è¦½" },
                    { name: "Step 2", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_2__" },
                    { name: "Step 3", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_3__" },
                    { name: "Step 4", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_4__" }
                ]
            };
            refs.projectName.value = projectData.name;
            refs.lineTokenInput.value = "";
            switchTab('imagemap');
            document.getElementById('projectsModal').classList.add('hidden');
        }

        function deleteProject(id, e) {
            e.stopPropagation();
            if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å°ˆæ¡ˆï¼Ÿ')) return;
            const projects = JSON.parse(localStorage.getItem('line_tool_projects') || '[]');
            const newProjects = projects.filter(p => p.id !== id);
            localStorage.setItem('line_tool_projects', JSON.stringify(newProjects));
            loadProjectsList();
        }

        function markUnsaved() {
            projectData.name = refs.projectName.value;
        }

        // ================= Core Logic =================
        function getCurrentDataObj() {
            if(currentMode === 'imagemap') return projectData.imagemap;
            if(currentMode === 'carousel') return projectData.carousel[currentCardIndex];
            if(currentMode === 'flow') return projectData.flow[currentFlowStep];
        }

        function updateUI() {
            const data = getCurrentDataObj();
            refs.imageUrl.value = data.imageUrl || "";
            const imgSource = data.localPreview || data.imageUrl;
            
            if(currentMode === 'carousel') {
                refs.canvasWrapper.classList.add('hidden');
                refs.phoneSimulator.classList.remove('hidden');
                renderPhoneSimulator();
                refs.cardContentEditor.classList.remove('hidden');
                refs.cardTitleInput.value = data.title || "";
                refs.cardDescInput.value = data.desc || "";
                renderCardBtnsEditor(data);
                
            } else {
                refs.canvasWrapper.classList.remove('hidden');
                refs.phoneSimulator.classList.add('hidden');
                refs.cardContentEditor.classList.add('hidden');
                
                refs.previewImage.classList.add('hidden');
                refs.drawLayer.classList.add('hidden');
                refs.placeholder.classList.remove('hidden');

                if(imgSource) {
                    refs.previewImage.src = imgSource;
                    refs.previewImage.onload = function() {
                        naturalWidth = this.naturalWidth;
                        refs.previewImage.classList.remove('hidden');
                        refs.drawLayer.classList.remove('hidden');
                        refs.placeholder.classList.add('hidden');
                        updateScale();
                        renderAreas();
                        renderActionList();
                    }
                } else {
                    refs.previewImage.src = "";
                    renderActionList();
                }
            }

            if(currentMode === 'flow') {
                if(currentFlowStep === 0) refs.triggerKeyword.value = data.trigger;
                document.getElementById('keywordBlock').classList.toggle('hidden', currentFlowStep > 0);
            } else if (currentMode === 'carousel') {
                refs.triggerKeyword.value = "å‘½ç›¤"; 
            } else {
                refs.triggerKeyword.value = "é¸å–®";
            }
        }

        // ================= Carousel Logic =================
        function renderPhoneSimulator() {
            const container = document.getElementById('simBubbleContainer');
            container.innerHTML = '';
            projectData.carousel.forEach((card, idx) => {
                const img = card.localPreview || card.imageUrl || 'https://via.placeholder.com/240x160?text=No+Image';
                let btnsHtml = '';
                (card.btns || []).forEach(b => { btnsHtml += `<div class="line-btn">${b.label}</div>`; });
                const bubble = document.createElement('div');
                bubble.className = 'line-bubble';
                if(idx === currentCardIndex) bubble.style.border = '2px solid #4f46e5';
                bubble.innerHTML = `<img src="${img}" class="bubble-hero"><div class="bubble-body"><div class="bubble-title">${card.title || 'ç„¡æ¨™é¡Œ'}</div><div class="bubble-text">${card.desc || '...'}</div></div><div class="bubble-footer">${btnsHtml}</div>`;
                bubble.onclick = () => switchCard(idx);
                container.appendChild(bubble);
            });
        }

        function renderCardBtnsEditor(data) {
            const area = refs.cardBtnsArea; area.innerHTML = '';
            (data.btns || []).forEach((btn, idx) => {
                const row = document.createElement('div'); row.className = 'flex gap-2';
                row.innerHTML = `<input value="${btn.label}" placeholder="æŒ‰éˆ•å" class="w-1/3 border p-1 rounded text-xs" oninput="updateCardBtn(${idx}, 'label', this.value)"><input value="${btn.text}" placeholder="å›å‚³å€¼" class="flex-1 border p-1 rounded text-xs" oninput="updateCardBtn(${idx}, 'text', this.value)"><button onclick="removeCardBtn(${idx})" class="text-red-500">Ã—</button>`;
                area.appendChild(row);
            });
        }
        function updateCardContent(field, val) { projectData.carousel[currentCardIndex][field] = val; renderPhoneSimulator(); }
        function updateCardBtn(idx, field, val) { projectData.carousel[currentCardIndex].btns[idx][field] = val; renderPhoneSimulator(); }
        function addCardBtn() { if(projectData.carousel[currentCardIndex].btns.length >= 3) return; projectData.carousel[currentCardIndex].btns.push({label: "æŒ‰éˆ•", text: "å›è¦†"}); updateUI(); }
        function removeCardBtn(idx) { projectData.carousel[currentCardIndex].btns.splice(idx, 1); updateUI(); }

        // ================= Tab Switching =================
        function switchTab(mode) {
            projectData.mode = mode; currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.getElementById('carouselControls').classList.toggle('hidden', mode !== 'carousel');
            document.getElementById('flowStepNav').classList.toggle('hidden', mode !== 'flow');
            document.getElementById('keywordBlock').classList.remove('hidden');
            updateUI(); updateGasCode();
        }

        // ================= Image Input =================
        refs.imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) { const data = getCurrentDataObj(); data.localPreview = evt.target.result; updateUI(); }
            reader.readAsDataURL(file);
        });
        function saveCurrentDataState() { getCurrentDataObj().imageUrl = refs.imageUrl.value; updateUI(); }

        // ================= Drawing =================
        refs.drawLayer.addEventListener('mousedown', (e) => { isDrawing=true; updateScale(); const r=refs.drawLayer.getBoundingClientRect(); startX=(e.clientX-r.left)/scaleFactor; startY=(e.clientY-r.top)/scaleFactor; currentBox=document.createElement('div'); currentBox.className='area-box'; currentBox.style.left=(startX*scaleFactor)+'px'; currentBox.style.top=(startY*scaleFactor)+'px'; refs.drawLayer.appendChild(currentBox); });
        refs.drawLayer.addEventListener('mousemove', (e) => { if(!isDrawing)return; const r=refs.drawLayer.getBoundingClientRect(); const w=Math.abs((e.clientX-r.left)/scaleFactor-startX); const h=Math.abs((e.clientY-r.top)/scaleFactor-startY); currentBox.style.width=(w*scaleFactor)+'px'; currentBox.style.height=(h*scaleFactor)+'px'; });
        refs.drawLayer.addEventListener('mouseup', (e) => { isDrawing=false; if(currentBox) currentBox.remove(); const r=refs.drawLayer.getBoundingClientRect(); const w=Math.abs((e.clientX-r.left)/scaleFactor-startX); const h=Math.abs((e.clientY-r.top)/scaleFactor-startY); if(w>20&&h>20){ const d=getCurrentDataObj(); d.areas.push({x:Math.min(startX,(e.clientX-r.left)/scaleFactor), y:Math.min(startY,(e.clientY-r.top)/scaleFactor), width:w, height:h, text:'æ–‡å­—', type:'message'}); renderAreas(); renderActionList(); } });
        
        function updateScale() { if(naturalWidth>0) scaleFactor = refs.previewImage.offsetWidth / naturalWidth; }
        
        function renderAreas() {
            const data = getCurrentDataObj(); refs.drawLayer.innerHTML = '';
            data.areas.forEach((a, i) => {
                const el = document.createElement('div'); el.className = `area-box ${a.selected?'selected':''}`;
                el.style.left=(a.x*scaleFactor)+'px'; el.style.top=(a.y*scaleFactor)+'px';
                el.style.width=(a.width*scaleFactor)+'px'; el.style.height=(a.height*scaleFactor)+'px';
                el.innerText=i+1; refs.drawLayer.appendChild(el);
            });
        }

        function renderActionList() {
            const data = getCurrentDataObj(); refs.actionList.innerHTML = '';
            data.areas.forEach((a, i) => {
                const el = document.createElement('div');
                el.className = 'bg-white p-2 rounded border border-slate-200 text-xs flex gap-2 items-center';
                el.innerHTML = `<span class="bg-slate-700 text-white w-4 h-4 flex items-center justify-center rounded">${i+1}</span><select onchange="updateArea(${i}, 'type', this.value)" class="border rounded"><option value="message">æ–‡å­—</option><option value="uri">é€£çµ</option><option value="flow_next" ${a.type==='flow_next'?'selected':''}>è·³è½‰</option></select><input value="${a.text}" onchange="updateArea(${i}, 'text', this.value)" class="border rounded flex-1 px-1"><button onclick="removeArea(${i})" class="text-red-500">Ã—</button>`;
                refs.actionList.appendChild(el);
            });
        }

        function updateArea(i, f, v) { getCurrentDataObj().areas[i][f] = v; }
        function removeArea(i) { getCurrentDataObj().areas.splice(i, 1); renderAreas(); renderActionList(); }

        // ================= Helper Functions =================
        function addCard() { if(projectData.carousel.length >= 10) return; projectData.carousel.push({ title: "æ–°å¡ç‰‡", desc: "èªªæ˜", imageUrl: "", localPreview: "", btns: [{label:"æŒ‰éˆ•", text:"å›è¦†"}], areas:[] }); currentCardIndex = projectData.carousel.length - 1; updateUI(); renderDots(); }
        function deleteCard() { if(projectData.carousel.length <= 1) return; projectData.carousel.splice(currentCardIndex, 1); currentCardIndex = Math.max(0, currentCardIndex - 1); updateUI(); renderDots(); }
        function switchCard(idx) { currentCardIndex = idx; updateUI(); renderDots(); }
        function renderDots() { const c = document.getElementById('cardDots'); c.innerHTML=''; document.getElementById('currentCardNum').innerText = currentCardIndex + 1; projectData.carousel.forEach((_, i) => { const d = document.createElement('div'); d.className = `card-dot ${i===currentCardIndex?'active':''}`; d.onclick=()=>switchCard(i); c.appendChild(d); }); }
        function switchFlowStep(i) { currentFlowStep = i; document.querySelectorAll('.flow-step-btn').forEach(b => b.classList.remove('active')); document.getElementById(`flow-step-${i}`).classList.add('active'); updateUI(); }
        function adjustZoom(delta) { currentZoom = Math.max(10, currentZoom+delta); document.getElementById('zoomDisplay').innerText = currentZoom + '%'; refs.previewImage.style.width = currentZoom + '%'; setTimeout(() => {updateScale(); renderAreas()}, 0); }
        function resetZoom() { currentZoom = 100; adjustZoom(0); }

        function updateGasCode() {
            // ... (Same generation logic as before, just using refs.lineTokenInput.value)
            const token = refs.lineTokenInput.value || 'è«‹æ›æˆä½ çš„LINE_TOKEN';
            refs.previewCodeLine.innerText = `const CHANNEL_ACCESS_TOKEN = '${token}'; ...`;
            // Full code generation (hidden in pre block for copy)
            const code = `const CHANNEL_ACCESS_TOKEN = '${token}';
// Code automatically generated for project: ${projectData.name}
// Paste this into Google Apps Script

// ... (Rest of logic) ...
function doPost(e) { /* Standard Logic */ }`;
            document.getElementById('gasCode').innerText = code;
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function copyCode() { navigator.clipboard.writeText(document.getElementById('gasCode').innerText); alert('è¤‡è£½æˆåŠŸï¼'); }
    </script>
</body>
</html>
