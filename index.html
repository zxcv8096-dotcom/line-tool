<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE è¬èƒ½ç·¨è¼¯å™¨ (v13.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        
        /* ç•«å¸ƒèƒŒæ™¯èˆ‡å®¹å™¨å„ªåŒ– */
        .canvas-scroll-container {
            /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œè¶…éå‡ºç¾æ²è»¸ */
            max-height: 65vh; 
            overflow: auto;
            border: 2px dashed #cbd5e1;
            background-color: white;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }
        /* ç¢ºä¿å…§å®¹ç‰© wrapper å¯ä»¥æ’é–‹æ²è»¸ */
        .canvas-content-wrapper {
            position: relative;
            display: inline-block; /* è®“ wrapper è²¼åˆåœ–ç‰‡å¯¦éš›å¤§å° */
            min-width: 100%;
            min-height: 100%;
        }

        .area-box { 
            position: absolute; border: 2px solid rgba(239, 68, 68, 0.9); background: rgba(239, 68, 68, 0.2); 
            cursor: move; display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px black; user-select: none;
        }
        .area-box.selected { border-color: #f59e0b; background: rgba(245, 158, 11, 0.3); z-index: 20; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* é ç±¤æ¨£å¼ */
        .tab-btn { opacity: 0.6; border-bottom: 4px solid transparent; }
        .tab-btn.active { opacity: 1; border-bottom: 4px solid #4f46e5; color: #4f46e5; background: #eef2ff; }
        
        /* ç¨‹å¼ç¢¼å€å¡Š */
        .code-block { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre; position: relative; }
        
        /* å¡ç‰‡åˆ‡æ›å™¨ */
        .card-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; cursor: pointer; transition: all 0.2s; }
        .card-dot.active { background: #4f46e5; transform: scale(1.3); }
        
        /* Checkbox å„ªåŒ– */
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-white border-b border-slate-200 shadow-sm flex-shrink-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-800 rounded-lg flex items-center justify-center text-white text-xl shadow-lg">ğŸ¦</div>
                <div>
                    <h1 class="font-bold text-xl tracking-wide text-slate-800 flex items-center gap-2">
                        LINE è¬èƒ½ç·¨è¼¯å™¨ 
                        <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full border border-blue-200">v13.0 æ•ˆç‡ç‰ˆ</span>
                    </h1>
                    <p class="text-xs text-slate-400">å¤§å¿ƒå®¶æ—ç³»çµ± | ç·Šæ¹Šç‰ˆé¢ + æ‰¹æ¬¡åˆªé™¤</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openModal('tutorialModal')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition flex items-center gap-2">
                    ğŸ“š ç¨‹å¼ç¢¼èˆ‡æ•™å­¸
                </button>
                <button onclick="downloadJSON()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-lg font-bold shadow-md transform transition active:scale-95 flex items-center gap-2 text-sm">
                    ğŸ’¾ ä¸‹è¼‰ JSON
                </button>
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-slate-200 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex">
            <button onclick="switchTab('imagemap')" id="tab-imagemap" class="tab-btn active flex-1 py-3 font-bold text-lg transition flex items-center justify-center gap-2">
                ğŸ—ºï¸ åº§æ¨™å¼•æµåœ– <span class="text-xs font-normal text-slate-400">(å–®å¼µå¤§åœ–)</span>
            </button>
            <button onclick="switchTab('carousel')" id="tab-carousel" class="tab-btn flex-1 py-3 font-bold text-lg transition flex items-center justify-center gap-2">
                ğŸ  åº§æ¨™æ»‘å‹•å¡ç‰‡ <span class="text-xs font-normal text-slate-400">(å¤šå¼µåœ–+åº§æ¨™é»æ“Š)</span>
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full bg-white relative">
        
        <aside class="w-[420px] border-r border-slate-200 flex flex-col z-20 bg-white h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
                
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100 space-y-2">
                    <label class="font-bold text-blue-800 text-sm">LINE è§¸ç™¼é—œéµå­— (å¿…å¡«)</label>
                    <input type="text" id="triggerKeyword" value="é¸å–®" placeholder="ä¾‹å¦‚: é¸å–®, ç”¢å“" class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 font-bold text-blue-700" oninput="updateGasCode()">
                </div>

                <div id="carouselControls" class="hidden space-y-4 p-4 bg-amber-50 rounded-xl border border-amber-100">
                    <div class="flex justify-between items-center">
                        <label class="font-bold text-amber-800 text-sm">ğŸ“¦ å¡ç‰‡ç®¡ç† (Card Manager)</label>
                        <div class="flex gap-2">
                            <button onclick="addCard()" class="bg-amber-500 text-white px-2 py-1 rounded text-xs hover:bg-amber-600 font-bold">+ åŠ å¡ç‰‡</button>
                            <button onclick="deleteCard()" class="text-red-500 text-xs hover:underline">åˆªé™¤ç›®å‰</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 justify-center flex-wrap" id="cardDots"></div>
                    <p class="text-center text-xs text-amber-700 font-bold">ç›®å‰ç·¨è¼¯ï¼šç¬¬ <span id="currentCardNum">1</span> å¼µå¡ç‰‡</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block font-bold text-slate-700 text-sm mb-1">1. ä¸Šå‚³åº•åœ– (é è¦½ç”¨)</label>
                        <input type="file" id="imageInput" accept="image/*" class="block w-full text-xs file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200"/>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block font-bold text-slate-700 text-sm">2. åœ–ç‰‡ç¶²å€ (å¿…å¡«)</label>
                            <button onclick="openModal('imageHelpModal')" class="text-xs text-blue-600 hover:underline">â“ å¦‚ä½•å–å¾—?</button>
                        </div>
                        <input type="text" id="imageUrl" placeholder="https://... çµå°¾æ˜¯ .jpg/.png" class="w-full p-2 border border-slate-300 rounded text-sm font-mono" oninput="saveCurrentCardState()">
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-2 border-b pb-2 sticky top-0 bg-white z-10">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="selectAllBtn" class="custom-checkbox" onchange="toggleSelectAll(this.checked)">
                            <label for="selectAllBtn" class="font-bold text-slate-700 text-sm cursor-pointer select-none">å…¨é¸</label>
                        </div>
                        <div class="flex items-center gap-3">
                             <span class="text-xs text-slate-400">å…± <span id="areaCount">0</span> çµ„</span>
                             <button onclick="deleteSelectedAreas()" id="deleteSelectedBtn" class="bg-red-50 text-red-500 px-3 py-1 rounded text-xs font-bold hover:bg-red-100 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                ğŸ—‘ï¸ åˆªé™¤é¸å–
                            </button>
                        </div>
                    </div>
                    <div id="actionList" class="space-y-2 pb-4 overflow-y-auto custom-scrollbar flex-1">
                        <div class="text-center text-slate-400 text-sm py-8 border-2 border-dashed rounded-lg">è«‹åœ¨å³å´åœ–ç‰‡ç•«æ¡†æ¡† â†—ï¸</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-100 p-6 overflow-hidden flex flex-col">
            <div id="canvasWrapper" class="relative shadow-xl bg-white rounded-lg overflow-hidden flex-shrink-1">
                <div id="canvasContainer" class="canvas-scroll-container custom-scrollbar">
                    <div class="canvas-content-wrapper">
                        <div id="placeholder" class="flex flex-col items-center justify-center h-96 text-slate-300 absolute inset-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <span class="text-lg font-bold">è«‹å…ˆåœ¨å·¦å´ä¸Šå‚³åº•åœ–</span>
                        </div>
                        <img id="previewImage" class="hidden block select-none pointer-events-none" style="max-width: none;" />
                        <div id="drawLayer" class="absolute inset-0 cursor-crosshair hidden z-10"></div>
                    </div>
                </div>
            </div>
            <p class="text-center text-xs text-slate-400 mt-2 flex-shrink-0">ğŸ’¡ å¦‚æœåœ–ç‰‡éé«˜ï¼Œå¯åœ¨ç•«å¸ƒå€å…§ä¸Šä¸‹æ²å‹•</p>
        </main>
    </div>

    <div id="tutorialModal" class="hidden fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ¤– æ©Ÿå™¨äººæ¶è¨­æ‡¶äººåŒ…</h2>
                <button onclick="document.getElementById('tutorialModal').classList.add('hidden')" class="text-2xl text-slate-400 hover:text-red-500">âœ•</button>
            </div>
            <div class="p-8 overflow-y-auto space-y-8 bg-white">
                <div class="space-y-2">
                    <h3 class="font-bold text-lg flex items-center gap-2"><span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">1</span> Google Apps Script è¬ç”¨ç¨‹å¼ç¢¼</h3>
                    <p class="text-sm text-slate-600">è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼ï¼Œè²¼åˆ° Google Apps Script å°ˆæ¡ˆä¸­ (æ¸…ç©ºåŸæœ¬çš„)ã€‚<br><span class="text-red-500 font-bold">è¨˜å¾—å°‡ç¬¬ä¸€è¡Œçš„ TOKEN æ›æˆä½ è‡ªå·±çš„ï¼</span></p>
                    <div class="bg-slate-800 text-slate-200 p-4 rounded-xl font-mono text-xs overflow-x-auto relative shadow-inner">
                        <button onclick="copyCode()" class="absolute top-3 right-3 bg-white/10 border border-white/20 px-3 py-1 rounded hover:bg-white/20 transition text-white">è¤‡è£½ä»£ç¢¼</button>
                        <pre id="gasCode"></pre>
                    </div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-center">
                    <p class="text-slate-700 font-bold">æœ€å¾Œä¸€æ­¥ï¼š</p>
                    <p class="text-slate-600 text-sm">åœ¨æœ¬å·¥å…·åšå¥½è¨­å®šï¼Œé»æ“Šå³ä¸Šè§’ <span class="bg-emerald-500 text-white px-2 py-0.5 rounded text-xs">ğŸ’¾ ä¸‹è¼‰ JSON</span>ï¼Œç„¶å¾Œè²¼å›ç¨‹å¼ç¢¼ä¸­ <code>const myJson = { ... }</code> çš„ä½ç½®å³å¯ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <div id="imageHelpModal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl max-w-md p-6 relative">
            <button onclick="document.getElementById('imageHelpModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">âœ•</button>
            <h3 class="font-bold text-lg mb-4">ğŸ“· å¦‚ä½•å–å¾—åœ–ç‰‡ç¶²å€ï¼Ÿ</h3>
            <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-700 mb-4">
                <li>æ¨è–¦ä½¿ç”¨ <a href="https://imgur.com/upload" target="_blank" class="text-blue-600 underline">Imgur (å…è¨»å†Š)</a>ã€‚</li>
                <li>å°‡åœ–ç‰‡æ‹–æ‹‰ä¸Šå‚³ã€‚</li>
                <li>å°è‘—ä¸Šå‚³å¥½çš„åœ–ç‰‡æŒ‰ <b>å³éµ</b>ã€‚</li>
                <li>é¸æ“‡ <b>ã€Œè¤‡è£½åœ–ç‰‡ä½å€ã€</b> (Copy Image Link)ã€‚</li>
                <li>ç¶²å€çµå°¾å¿…é ˆæ˜¯ <b>.jpg</b> æˆ– <b>.png</b> æ‰æ­£ç¢ºï¼</li>
            </ol>
            <button onclick="document.getElementById('imageHelpModal').classList.add('hidden')" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold">æ‡‚äº†</button>
        </div>
    </div>

    <script>
        let currentMode = 'imagemap';
        let currentCardIndex = 0;
        
        // Data Structure: added 'selected' property for checkboxes
        let imagemapData = { imageUrl: "", areas: [] }; // areas: [{x,y,w,h,text,type, selected:false}, ...]
        let carouselCards = [{ imageUrl: "", areas: [] }];

        // UI Refs
        const imageInput = document.getElementById('imageInput');
        const imageUrlInput = document.getElementById('imageUrl');
        const previewImage = document.getElementById('previewImage');
        const drawLayer = document.getElementById('drawLayer');
        const actionList = document.getElementById('actionList');
        const placeholder = document.getElementById('placeholder');
        const areaCountSpan = document.getElementById('areaCount');
        const triggerKeywordInput = document.getElementById('triggerKeyword');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        
        let isDrawing = false;
        let startX, startY;
        let currentBox = null;
        let naturalWidth = 0; 
        let naturalHeight = 0;
        let scaleFactor = 1;

        window.addEventListener('DOMContentLoaded', () => {
            updateGasCode();
            renderDots();
            updateBatchControls(); // Init batch controls state
        });

        // ================= Mode Switcher =================
        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            if(mode === 'carousel') {
                document.getElementById('carouselControls').classList.remove('hidden');
                triggerKeywordInput.value = "å‘½ç›¤";
            } else {
                document.getElementById('carouselControls').classList.add('hidden');
                triggerKeywordInput.value = "é¸å–®";
            }
            loadCurrentData();
            updateGasCode();
            updateBatchControls(); // Reset checkboxes on tab switch
        }

        // ================= Card Management =================
        function addCard() {
            if(carouselCards.length >= 10) { alert("æœ€å¤š 10 å¼µå¡ç‰‡ï¼"); return; }
            carouselCards.push({ imageUrl: "", areas: [] });
            currentCardIndex = carouselCards.length - 1;
            loadCurrentData();
            renderDots();
        }

        function deleteCard() {
            if(carouselCards.length <= 1) { alert("è‡³å°‘è¦ç•™ä¸€å¼µå¡ç‰‡ï¼"); return; }
            if(!confirm("ç¢ºå®šåˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ")) return;
            carouselCards.splice(currentCardIndex, 1);
            if(currentCardIndex >= carouselCards.length) currentCardIndex = carouselCards.length - 1;
            loadCurrentData();
            renderDots();
        }

        function switchCard(index) {
            saveCurrentCardState();
            currentCardIndex = index;
            loadCurrentData();
            renderDots();
            updateBatchControls(); // Reset checkboxes on card switch
        }

        function renderDots() {
            const container = document.getElementById('cardDots');
            container.innerHTML = '';
            document.getElementById('currentCardNum').innerText = currentCardIndex + 1;
            carouselCards.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `card-dot ${i === currentCardIndex ? 'active' : ''}`;
                dot.onclick = () => switchCard(i);
                container.appendChild(dot);
            });
        }

        // ================= Data Loading/Saving =================
        function getCurrentDataObj() {
            return currentMode === 'imagemap' ? imagemapData : carouselCards[currentCardIndex];
        }

        function loadCurrentData() {
            const data = getCurrentDataObj();
            imageUrlInput.value = data.imageUrl || "";
            previewImage.src = "";
            previewImage.classList.add('hidden');
            drawLayer.classList.add('hidden');
            placeholder.classList.remove('hidden');
            
            // Reset selections when loading data
            data.areas.forEach(a => a.selected = false);

            if(data.imageUrl) {
                previewImage.src = data.imageUrl;
                previewImage.onload = function() {
                    naturalWidth = this.naturalWidth;
                    naturalHeight = this.naturalHeight;
                    previewImage.classList.remove('hidden');
                    drawLayer.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    updateScale();
                    renderAreas(); 
                    renderActionList();
                }
            } else {
                renderAreas();
                renderActionList();
            }
        }

        function saveCurrentCardState() {
            const data = getCurrentDataObj();
            data.imageUrl = imageUrlInput.value;
        }

        // ================= Image Handling =================
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                previewImage.src = evt.target.result;
                previewImage.onload = function() {
                    naturalWidth = this.naturalWidth;
                    naturalHeight = this.naturalHeight;
                    placeholder.classList.add('hidden');
                    previewImage.classList.remove('hidden');
                    drawLayer.classList.remove('hidden');
                    updateScale();
                    // New image uploaded, clear areas for this image/card
                    getCurrentDataObj().areas = [];
                    renderAreas();
                    renderActionList();
                }
            }
            reader.readAsDataURL(file);
        });

        window.addEventListener('resize', updateScale);
        function updateScale() { 
            // Use previewImage.offsetWidth instead of width to get rendered size
            if(naturalWidth>0 && previewImage.offsetWidth > 0) {
                 scaleFactor = previewImage.offsetWidth / naturalWidth; 
            }
        }

        // ================= Drawing Logic =================
        drawLayer.addEventListener('mousedown', (e) => {
            if(!previewImage.src) return;
            isDrawing = true;
            // Need to recalculate scale factor on mousedown in case of resize/scroll issues
            updateScale(); 
            const rect = drawLayer.getBoundingClientRect();
            startX = (e.clientX - rect.left) / scaleFactor;
            startY = (e.clientY - rect.top) / scaleFactor;
            currentBox = document.createElement('div');
            currentBox.className = 'area-box border-dashed opacity-50';
            currentBox.style.left = (startX * scaleFactor) + 'px';
            currentBox.style.top = (startY * scaleFactor) + 'px';
            drawLayer.appendChild(currentBox);
        });

        drawLayer.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = drawLayer.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / scaleFactor;
            const currentY = (e.clientY - rect.top) / scaleFactor;
            const w = Math.abs(currentX - startX);
            const h = Math.abs(currentY - startY);
            currentBox.style.width = (w * scaleFactor) + 'px';
            currentBox.style.height = (h * scaleFactor) + 'px';
            currentBox.style.left = (Math.min(startX, currentX) * scaleFactor) + 'px';
            currentBox.style.top = (Math.min(startY, currentY) * scaleFactor) + 'px';
        });

        drawLayer.addEventListener('mouseup', (e) => {
            if(!isDrawing) return;
            isDrawing = false;
            const rect = drawLayer.getBoundingClientRect();
            const endX = (e.clientX - rect.left) / scaleFactor;
            const endY = (e.clientY - rect.top) / scaleFactor;
            if(currentBox) currentBox.remove();
            
            const w = Math.abs(endX - startX);
            const h = Math.abs(endY - startY);
            if(w > 20 && h > 20) {
                const data = getCurrentDataObj();
                data.areas.push({ 
                    x: Math.round(Math.min(startX, endX)), 
                    y: Math.round(Math.min(startY, endY)), 
                    width: Math.round(w), 
                    height: Math.round(h), 
                    text: `é—œéµå­—${data.areas.length+1}`,
                    type: 'message',
                    selected: false // Initialize as not selected
                });
                renderAreas(); renderActionList();
            }
        });

        function renderAreas() {
            const data = getCurrentDataObj();
            drawLayer.innerHTML = '';
            data.areas.forEach((area, i) => {
                const el = document.createElement('div');
                el.className = `area-box ${area.selected ? 'selected' : ''}`; // Highlight if selected
                el.style.left = (area.x * scaleFactor) + 'px';
                el.style.top = (area.y * scaleFactor) + 'px';
                el.style.width = (area.width * scaleFactor) + 'px';
                el.style.height = (area.height * scaleFactor) + 'px';
                el.innerText = i + 1;
                // Clicking box toggles selection in list
                el.onclick = (e) => { 
                    e.stopPropagation(); 
                    toggleAreaSelection(i);
                };
                if(area.type === 'uri') { el.style.borderColor='#2563eb'; el.style.backgroundColor='rgba(37,99,235,0.2)'; }
                drawLayer.appendChild(el);
            });
            areaCountSpan.innerText = data.areas.length;
        }

        // ================= List & Batch Operations (New) =================
        function renderActionList() {
            const data = getCurrentDataObj();
            actionList.innerHTML = '';
            if(data.areas.length === 0) {
                actionList.innerHTML = '<div class="text-center text-slate-400 text-sm py-8 border-2 border-dashed rounded-lg">è«‹åœ¨å³å´åœ–ç‰‡ç•«æ¡†æ¡† â†—ï¸</div>';
                updateBatchControls();
                return;
            }
            
            data.areas.forEach((area, i) => {
                const row = document.createElement('div');
                // Highlight row if selected
                row.className = `bg-white p-3 rounded-lg border ${area.selected ? 'border-blue-500 bg-blue-50' : 'border-slate-200'} text-sm space-y-2 shadow-sm transition-colors`;
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="custom-checkbox shrink-0" ${area.selected ? 'checked' : ''} onchange="toggleAreaSelection(${i})">
                        <span class="bg-slate-800 text-white w-5 h-5 flex items-center justify-center rounded text-xs font-bold shrink-0">${i+1}</span>
                        <select onchange="updateAreaType(${i}, this.value)" class="text-xs border p-1 rounded bg-slate-50 font-bold text-slate-600">
                            <option value="message" ${area.type==='message'?'selected':''}>ğŸ’¬ å‚³æ–‡å­—</option>
                            <option value="uri" ${area.type==='uri'?'selected':''}>ğŸ”— é–‹é€£çµ</option>
                        </select>
                        <div class="flex-1"></div>
                        <button onclick="removeArea(${i})" class="text-red-300 hover:text-red-500 px-2">âœ•</button>
                    </div>
                    <input type="text" value="${area.text}" onchange="updateAreaText(${i}, this.value)" class="w-full border p-2 rounded text-xs" placeholder="${area.type==='uri'?'https://...':'è¼¸å…¥é—œéµå­—'}">
                `;
                actionList.appendChild(row);
            });
            updateBatchControls();
        }

        function toggleAreaSelection(i) {
            const data = getCurrentDataObj();
            data.areas[i].selected = !data.areas[i].selected;
            renderAreas();
            renderActionList();
        }

        function toggleSelectAll(checked) {
            const data = getCurrentDataObj();
            data.areas.forEach(a => a.selected = checked);
            renderAreas();
            renderActionList();
        }

        function deleteSelectedAreas() {
            const data = getCurrentDataObj();
            if(confirm(`ç¢ºå®šåˆªé™¤é¸å–çš„ ${data.areas.filter(a => a.selected).length} å€‹å€åŸŸå—ï¼Ÿ`)) {
                data.areas = data.areas.filter(a => !a.selected);
                renderAreas();
                renderActionList();
            }
        }

        function updateBatchControls() {
            const data = getCurrentDataObj();
            const total = data.areas.length;
            const selectedCount = data.areas.filter(a => a.selected).length;
            
            // Update Select All Checkbox state
            selectAllBtn.checked = total > 0 && total === selectedCount;
            selectAllBtn.indeterminate = selectedCount > 0 && selectedCount < total;
            selectAllBtn.disabled = total === 0;

            // Update Delete Button state
            deleteSelectedBtn.disabled = selectedCount === 0;
            deleteSelectedBtn.innerHTML = `ğŸ—‘ï¸ åˆªé™¤é¸å– (${selectedCount})`;
        }

        // ================= Individual Area Updates =================
        function updateAreaType(i, val) {
            getCurrentDataObj().areas[i].type = val;
            renderAreas(); renderActionList();
        }
        function updateAreaText(i, val) {
            getCurrentDataObj().areas[i].text = val;
        }
        function removeArea(i) {
            getCurrentDataObj().areas.splice(i, 1);
            renderAreas(); renderActionList();
        }

        // ================= JSON Generation & Code =================
        function updateGasCode() {
            const keyword = triggerKeywordInput.value || 'é¸å–®';
            const code = `const CHANNEL_ACCESS_TOKEN = 'è«‹æ›æˆä½ çš„LINE_TOKEN'; 

function doPost(e) {
  let replyToken = "", userMessage = "";
  try {
    const msg = JSON.parse(e.postData.contents);
    replyToken = msg.events[0].replyToken;
    userMessage = msg.events[0].message.text;
  } catch (error) { return ContentService.createTextOutput(""); }

  // è§¸ç™¼é—œéµå­—: ${keyword}
  if (userMessage === "${keyword}") {
    // è«‹å°‡ä¸‹è¼‰çš„ JSON æª”æ¡ˆå…§å®¹ï¼Œå®Œæ•´è¦†è“‹ä¸‹æ–¹çš„å¤§æ‹¬è™Ÿå…§å®¹ï¼š
    const myJson = { /* é€™è£¡è²¼ä¸Š JSON */ };
    
    UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
      'headers': { 'Content-Type': 'application/json; charset=UTF-8', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
      'method': 'post',
      'payload': JSON.stringify({ 'replyToken': replyToken, 'messages': [myJson] }),
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({'content': 'post ok'})).setMimeType(ContentService.MimeType.JSON);
}`;
            document.getElementById('gasCode').innerText = code;
        }

        function downloadJSON() {
            let output = {};
            if (currentMode === 'imagemap') {
                if (!imagemapData.imageUrl) { alert("è«‹å¡«å¯«åœ–ç‰‡ç¶²å€"); return; }
                const scale = (naturalWidth && naturalWidth !== 1040) ? 1040/naturalWidth : 1;
                output = {
                    "type": "imagemap",
                    "baseUrl": imagemapData.imageUrl,
                    "altText": "è«‹é¸æ“‡åŠŸèƒ½",
                    "baseSize": { "width": 1040, "height": Math.round((naturalHeight || 1040) * scale) },
                    "actions": imagemapData.areas.map(a => ({
                        "type": a.type,
                        "text": a.type==='message'?a.text:undefined,
                        "linkUri": a.type==='uri'?a.text:undefined,
                        "area": { x: Math.round(a.x*scale), y: Math.round(a.y*scale), width: Math.round(a.width*scale), height: Math.round(a.height*scale) }
                    }))
                };
            } else {
                const bubbles = carouselCards.map(card => {
                    const imgUrl = card.imageUrl || "https://via.placeholder.com/1040x1040?text=No+Image";
                    const clickAreas = card.areas.map(a => {
                        // Use 4 decimal places for precision percentage percentages
                        const leftP = (a.x / naturalWidth * 100).toFixed(4) + '%';
                        const topP = (a.y / naturalHeight * 100).toFixed(4) + '%';
                        const widthP = (a.width / naturalWidth * 100).toFixed(4) + '%';
                        const heightP = (a.height / naturalHeight * 100).toFixed(4) + '%';

                        return {
                            "type": "box", "layout": "vertical", "position": "absolute",
                            "offsetStart": leftP, "offsetTop": topP, "width": widthP, "height": heightP,
                            "action": {
                                "type": a.type, "label": "action",
                                "text": a.type==='message' ? a.text : undefined,
                                "uri": a.type==='uri' ? a.text : undefined
                            }
                        };
                    });
                    let ratio = "1:1";
                    if(naturalWidth > 0 && naturalHeight > 0) ratio = `${naturalWidth}:${naturalHeight}`;
                    return {
                        "type": "bubble",
                        "body": {
                            "type": "box", "layout": "overlap", "paddingAll": "0px",
                            "contents": [
                                { "type": "image", "url": imgUrl, "size": "full", "aspectRatio": ratio, "aspectMode": "cover" },
                                ...clickAreas
                            ]
                        }
                    };
                });
                output = { "type": "flex", "altText": "è«‹é¸æ“‡é …ç›®", "contents": { "type": "carousel", "contents": bubbles } };
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(output, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", `${currentMode}_settings.json`);
            dl.click();
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function copyCode() { navigator.clipboard.writeText(document.getElementById('gasCode').innerText); alert('è¤‡è£½æˆåŠŸï¼'); }
    </script>
</body>
</html>
