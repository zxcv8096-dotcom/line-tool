<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE å¼•æµåœ–ç‰‡åº§æ¨™ç”¢ç”Ÿå™¨ (v5.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        
        /* ç•«å¸ƒèƒŒæ™¯ */
        .canvas-container { 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border: 2px dashed #cbd5e1; 
            background-color: white;
            transition: all 0.3s;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .canvas-container:hover { border-color: #3b82f6; }
        
        /* ç´…æ¡†æ¨£å¼ */
        .area-box { 
            position: absolute; 
            border: 2px solid rgba(239, 68, 68, 0.9); 
            background: rgba(239, 68, 68, 0.2); 
            cursor: move; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-size: 16px; 
            text-shadow: 1px 1px 2px black; 
            z-index: 10;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            user-select: none;
        }
        .area-box:hover { background: rgba(239, 68, 68, 0.4); border-color: #ef4444; }
        .area-box.selected { 
            border-color: #f59e0b; 
            background: rgba(245, 158, 11, 0.3); 
            z-index: 20; 
            box-shadow: 0 0 0 2px white, 0 0 0 4px #f59e0b;
        }

        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* é€£çµæ¨£å¼ */
        .link-btn { color: #2563eb; text-decoration: underline; font-weight: bold; cursor: pointer; }
        .link-btn:hover { color: #1d4ed8; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-white border-b border-slate-200 shadow-sm flex-shrink-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-800 rounded-lg flex items-center justify-center text-white text-xl shadow-lg">ğŸ¦</div>
                <div>
                    <h1 class="font-bold text-xl tracking-wide text-slate-800 flex items-center gap-2">
                        LINE åº§æ¨™ç”¢ç”Ÿå™¨ 
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full border border-slate-200">v5.2 æ–‡å­—ç‰ˆ</span>
                    </h1>
                    <p class="text-xs text-slate-400">å¤§å¿ƒå®¶æ—ç³»çµ± | 2026.01.23 æ›´æ–°</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('tutorialModal').classList.remove('hidden')" class="text-slate-600 hover:text-blue-600 px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 text-sm border border-slate-200 hover:border-blue-200 hover:bg-blue-50 ring-2 ring-blue-50 ring-offset-1">
                    ğŸ“š ç¶å®šæ•™å­¸ (æ–‡å­—ç‰ˆ)
                </button>
                <button onclick="downloadJSON()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-lg font-bold shadow-md transform transition active:scale-95 flex items-center gap-2 text-sm">
                    ğŸ’¾ ä¸‹è¼‰ JSON
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        <aside class="w-[400px] bg-white border-r border-slate-200 flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8">
                <div class="bg-orange-50 rounded-xl p-4 border border-orange-100 space-y-2">
                    <h3 class="font-bold text-orange-800 flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zm1 14a1 1 0 100-2 1 1 0 000 2zm5-1.757l4.9-4.9a2 2 0 000-2.828L13.485 5.1a2 2 0 00-2.828 0L10 5.757v8.486zM16 18H9.071l6-6H16a2 2 0 012 2v2a2 2 0 01-2 2z" clip-rule="evenodd" /></svg>
                        æ™ºæ…§è¼¸å‡ºè¨­å®š
                    </h3>
                    <div class="flex items-start gap-3">
                        <div class="flex items-center h-5">
                            <input id="autoScale" type="checkbox" checked class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 rounded cursor-pointer">
                        </div>
                        <div class="text-xs">
                            <label for="autoScale" class="font-medium text-gray-700 cursor-pointer">å¼·åˆ¶è¼¸å‡ºç‚º 1040px æ¨™æº–å¯¬åº¦</label>
                            <p class="text-gray-500 mt-1">é–‹å•Ÿå¾Œï¼Œç„¡è«–ä¸Šå‚³çš„åœ–ç‰‡å¤šå¤§æˆ–å¤šå°ï¼Œç³»çµ±éƒ½æœƒè‡ªå‹•è¨ˆç®—æ¯”ä¾‹ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="block font-bold text-slate-700 text-sm">1. ä¸Šå‚³åº•åœ– (é è¦½ç”¨)</label>
                        <input type="file" id="imageInput" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 transition cursor-pointer border border-slate-200 rounded-lg p-1"/>
                        <div id="statusMsg" class="hidden rounded-lg p-3 text-xs flex items-center gap-2"></div>
                    </div>

                    <div class="space-y-2">
                        <label class="block font-bold text-slate-700 text-sm flex justify-between">
                            2. åœ–ç‰‡å…¬é–‹ç¶²å€ (å¿…å¡«)
                            <span class="text-[10px] text-emerald-600 bg-emerald-50 px-2 rounded-full border border-emerald-100 self-center">å·²è‡ªå‹•è¨˜æ†¶</span>
                        </label>
                        <input type="text" id="imageUrl" placeholder="è«‹è²¼ä¸Š https://... çµå°¾æ˜¯ .jpg/.png çš„ç¶²å€" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm shadow-sm transition font-mono text-slate-600" oninput="saveState()">
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-[300px]">
                    <div class="flex justify-between items-end mb-3 pb-2 border-b border-slate-100">
                        <label class="block font-bold text-slate-700 text-sm">3. é—œéµå­—è¨­å®šå€</label>
                        <span class="text-xs text-slate-400">ç›®å‰è¨­å®š: <span id="areaCount" class="font-bold text-blue-600">0</span> çµ„</span>
                    </div>
                    <div id="actionList" class="flex-1 space-y-2 overflow-y-auto pr-1">
                        <div class="text-center text-slate-400 text-sm py-12 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                            ğŸ‘† è«‹åœ¨å³å´åœ–ç‰‡ä¸Š<br>æ‹–æ›³æ»‘é¼ ç•«å‡ºæ¡†æ¡†
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-slate-50 border-t border-slate-200 text-center text-xs text-slate-400">
                ç³»çµ±å°‡è‡ªå‹•å„²å­˜æ‚¨çš„ç·¨è¼¯é€²åº¦ ğŸ’¾
            </div>
        </aside>

        <main class="flex-1 bg-slate-100/50 p-8 overflow-auto flex justify-center items-start relative select-none" id="mainArea">
            <div id="canvasWrapper" class="relative shadow-2xl rounded-sm transition-all duration-300">
                <div id="canvasContainer" class="canvas-container">
                    <div id="placeholder" class="flex flex-col items-center justify-center h-96 w-96 text-slate-300">
                        <svg class="w-20 h-20 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="text-lg font-medium">è«‹å…ˆåœ¨å·¦å´ä¸Šå‚³åº•åœ–</span>
                    </div>
                    <img id="previewImage" class="hidden max-w-full block pointer-events-none select-none" style="max-height: 85vh;" />
                    <div id="drawLayer" class="absolute inset-0 cursor-crosshair hidden"></div>
                </div>
                <div id="dimLabel" class="absolute -top-10 left-0 bg-slate-800 text-white text-xs px-3 py-1.5 rounded-lg opacity-0 transition shadow-lg flex items-center gap-2">
                    <span id="dimDot" class="w-2 h-2 rounded-full bg-green-400"></span>
                    <span id="dimText">0 x 0</span>
                </div>
            </div>
        </main>
    </div>

    <div id="tutorialModal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    ğŸ“š LINE å®˜æ–¹å¸³è™Ÿç¶å®šæµç¨‹
                </h2>
                <button onclick="document.getElementById('tutorialModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-100 rounded-full transition text-xl">âœ•</button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-slate-50 p-8 space-y-10">
                
                <section class="space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">1</span>
                        <h3 class="text-xl font-bold text-slate-800">Google ç¨‹å¼ç¢¼éƒ¨ç½²</h3>
                    </div>
                    <div class="ml-11 bg-white p-5 rounded-xl border border-slate-200 shadow-sm text-sm space-y-3">
                        <p class="text-slate-700 leading-relaxed">
                            å›åˆ° Google Apps Script ç¨‹å¼ç¢¼é é¢ï¼Œä¾åºé»æ“Šå³ä¸Šè§’çš„ï¼š<br>
                            <span class="font-bold bg-slate-100 px-2 py-1 rounded">éƒ¨ç½²</span> > <span class="font-bold bg-slate-100 px-2 py-1 rounded">æ–°å¢éƒ¨ç½²</span>
                        </p>
                        <ul class="list-disc pl-5 space-y-2 text-slate-600">
                            <li>é¸å–é¡å‹ï¼šé»æ“Šé½’è¼ªåœ–ç¤ºï¼Œé¸æ“‡ <b>ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</b>ã€‚</li>
                            <li>åŸ·è¡Œèº«åˆ†ï¼šé¸æ“‡ <b>ã€Œæˆ‘ (Me)ã€</b>ã€‚</li>
                            <li class="text-red-600 font-bold bg-red-50 p-1 rounded">èª°å¯ä»¥å­˜å–ï¼šä¸€å®šè¦é¸ã€Œæ‰€æœ‰äºº (Anyone)ã€ã€‚</li>
                        </ul>
                        <p class="text-slate-700 mt-2">
                            éƒ¨ç½²æˆåŠŸå¾Œï¼Œè«‹è¤‡è£½é‚£ä¸²ä»¥ <b>/exec</b> çµå°¾çš„é•·ç¶²å€ã€‚
                        </p>
                    </div>
                </section>

                <section class="space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-lg">2</span>
                        <h3 class="text-xl font-bold text-slate-800">LINE å¾Œå°è¨­å®š (Webhook)</h3>
                    </div>
                    <div class="ml-11 bg-white p-5 rounded-xl border border-slate-200 shadow-sm text-sm space-y-3">
                        <p class="text-slate-700 flex flex-wrap gap-2 items-center">
                            è«‹é»æ“Šé€£çµé€²å…¥å¾Œå°ï¼š
                            <a href="https://manager.line.biz/" target="_blank" class="link-btn">ğŸ‘‰ å‰å¾€ LINE Official Account Manager</a>
                        </p>
                        <ol class="list-decimal pl-5 space-y-2 text-slate-600 leading-relaxed">
                            <li>ç™»å…¥å¾Œï¼Œé¸æ“‡ä½ è¦è¨­å®šçš„å®˜æ–¹å¸³è™Ÿã€‚</li>
                            <li>é»æ“Šå³ä¸Šè§’çš„ <b>ã€Œè¨­å®šã€</b> (é½’è¼ªåœ–ç¤º)ã€‚</li>
                            <li>é»æ“Šå·¦å´é¸å–®çš„ <b>ã€ŒMessaging APIã€</b>ã€‚</li>
                            <li>
                                å¾€ä¸‹æ²å‹•æ‰¾åˆ° <b>Webhook URL</b> æ¬„ä½ï¼š<br>
                                è²¼ä¸Šå‰›å‰›è¤‡è£½çš„ Google ç¶²å€ï¼Œä¸¦æŒ‰ä¸‹ <b>ã€Œæ›´æ–° (Update)ã€</b>ã€‚
                            </li>
                            <li class="bg-green-50 text-green-800 p-2 rounded border border-green-100 font-bold">
                                é—œéµå‹•ä½œï¼šè«‹å‹™å¿…é–‹å•Ÿä¸‹æ–¹çš„ã€Œä½¿ç”¨ Webhook (Use Webhook)ã€é–‹é—œï¼
                            </li>
                            <li>é»æ“Šã€Œé©—è­‰ (Verify)ã€ï¼Œè‹¥å‡ºç¾ Success å³ä»£è¡¨æˆåŠŸã€‚</li>
                        </ol>
                    </div>
                </section>

                <section class="space-y-4 pb-4">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold text-lg">3</span>
                        <h3 class="text-xl font-bold text-slate-800">ç”¢ç”Ÿ JSON ä¸¦å¥—ç”¨</h3>
                    </div>
                    <div class="ml-11 bg-white p-5 rounded-xl border border-slate-200 shadow-sm text-sm space-y-3">
                         <p class="text-slate-700">
                            1. åœ¨æœ¬å·¥å…·ä¸Šå‚³åœ–ç‰‡ã€ç•«å‡ºé»æ“Šå€åŸŸã€‚<br>
                            2. é»æ“Šå³ä¸Šè§’ <span class="bg-emerald-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ’¾ ä¸‹è¼‰ JSON</span>ã€‚<br>
                            3. æ‰“é–‹ä¸‹è¼‰çš„æª”æ¡ˆï¼Œå…¨é¸è¤‡è£½å…§å®¹ã€‚<br>
                            4. å›åˆ° Google Apps Scriptï¼Œå°‡å…§å®¹å–ä»£æ‰åŸæœ¬çš„è¨­å®šã€‚
                        </p>
                    </div>
                </section>
            </div>
            
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end">
                <button onclick="document.getElementById('tutorialModal').classList.add('hidden')" class="bg-slate-800 text-white px-8 py-3 rounded-xl hover:bg-slate-700 transition font-bold shadow-lg transform active:scale-95">
                    æˆ‘ç­è§£äº†ï¼Œé–‹å§‹è¨­å®šï¼ğŸš€
                </button>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const imageUrlInput = document.getElementById('imageUrl');
        const previewImage = document.getElementById('previewImage');
        const drawLayer = document.getElementById('drawLayer');
        const actionList = document.getElementById('actionList');
        const statusMsg = document.getElementById('statusMsg');
        const placeholder = document.getElementById('placeholder');
        const areaCountSpan = document.getElementById('areaCount');
        const dimLabel = document.getElementById('dimLabel');
        const dimText = document.getElementById('dimText');
        const dimDot = document.getElementById('dimDot');
        const autoScaleCheckbox = document.getElementById('autoScale');
        
        let areas = [];
        let isDrawing = false;
        let startX, startY;
        let currentBox = null;
        let naturalWidth = 0;
        let naturalHeight = 0;
        let scaleFactor = 1; 

        // å•Ÿå‹•æ™‚è®€å–è¨˜æ†¶
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('line_tool_url');
            if(savedUrl) imageUrlInput.value = savedUrl;
        });

        function saveState() {
            localStorage.setItem('line_tool_url', imageUrlInput.value);
        }

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                previewImage.src = event.target.result;
                previewImage.onload = function() {
                    naturalWidth = this.naturalWidth;
                    naturalHeight = this.naturalHeight;
                    
                    placeholder.classList.add('hidden');
                    previewImage.classList.remove('hidden');
                    drawLayer.classList.remove('hidden');
                    dimText.innerText = `${naturalWidth} x ${naturalHeight} px`;
                    dimLabel.classList.remove('opacity-0');

                    updateStatusMsg();

                    areas = [];
                    renderAreas();
                    renderList();
                    updateScale();
                }
            }
            reader.readAsDataURL(file);
        });

        autoScaleCheckbox.addEventListener('change', updateStatusMsg);

        function updateStatusMsg() {
            if(!naturalWidth) return;
            const isAuto = autoScaleCheckbox.checked;

            statusMsg.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-emerald-50', 'text-emerald-700', 'bg-blue-50', 'text-blue-700');
            
            if (naturalWidth !== 1040) {
                if (isAuto) {
                    statusMsg.classList.add('bg-blue-50', 'text-blue-700', 'border', 'border-blue-100');
                    statusMsg.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg><span><b>å·²å•Ÿç”¨è‡ªå‹•ä¿®æ­£</b><br>åŸåœ– ${naturalWidth}px å°‡åœ¨ä¸‹è¼‰æ™‚è‡ªå‹•è½‰ç‚º 1040px æ¨™æº–</span>`;
                    dimDot.className = 'w-2 h-2 rounded-full bg-blue-400';
                } else {
                    statusMsg.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-100');
                    statusMsg.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><span><b>å°ºå¯¸ä¸ç¬¦ï¼</b><br>å»ºè­°å‹¾é¸ä¸Šæ–¹ã€Œå¼·åˆ¶è¼¸å‡ºã€åŠŸèƒ½</span>`;
                    dimDot.className = 'w-2 h-2 rounded-full bg-red-400';
                }
            } else {
                statusMsg.classList.add('bg-emerald-50', 'text-emerald-700', 'border', 'border-emerald-100');
                statusMsg.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span><b>å®Œç¾ï¼</b> åŸåœ–å³ç‚º 1040px</span>`;
                dimDot.className = 'w-2 h-2 rounded-full bg-emerald-400';
            }
        }

        window.addEventListener('resize', updateScale);
        function updateScale() {
            if(naturalWidth > 0) {
                scaleFactor = previewImage.width / naturalWidth;
            }
        }

        drawLayer.addEventListener('mousedown', (e) => {
            if(!previewImage.src) return;
            updateScale();
            isDrawing = true;
            const rect = drawLayer.getBoundingClientRect();
            startX = (e.clientX - rect.left) / scaleFactor;
            startY = (e.clientY - rect.top) / scaleFactor;
            
            currentBox = document.createElement('div');
            currentBox.className = 'area-box border-dashed opacity-50';
            currentBox.style.left = (startX * scaleFactor) + 'px';
            currentBox.style.top = (startY * scaleFactor) + 'px';
            drawLayer.appendChild(currentBox);
        });

        drawLayer.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = drawLayer.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / scaleFactor;
            const currentY = (e.clientY - rect.top) / scaleFactor;

            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            const left = Math.min(startX, currentX);
            const top = Math.min(startY, currentY);

            currentBox.style.width = (width * scaleFactor) + 'px';
            currentBox.style.height = (height * scaleFactor) + 'px';
            currentBox.style.left = (left * scaleFactor) + 'px';
            currentBox.style.top = (top * scaleFactor) + 'px';
        });

        drawLayer.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            isDrawing = false;
            
            const rect = drawLayer.getBoundingClientRect();
            const endX = (e.clientX - rect.left) / scaleFactor;
            const endY = (e.clientY - rect.top) / scaleFactor;
            
            const x = Math.round(Math.min(startX, endX));
            const y = Math.round(Math.min(startY, endY));
            const w = Math.round(Math.abs(endX - startX));
            const h = Math.round(Math.abs(endY - startY));

            if(currentBox) currentBox.remove();
            if (w > 20 && h > 20) {
                areas.push({ x, y, width: w, height: h, text: `é—œéµå­—${areas.length + 1}` });
                renderAreas();
                renderList();
                saveState();
            }
        });

        function renderAreas() {
            drawLayer.innerHTML = '';
            areas.forEach((area, index) => {
                const box = document.createElement('div');
                box.className = 'area-box';
                box.style.left = (area.x * scaleFactor) + 'px';
                box.style.top = (area.y * scaleFactor) + 'px';
                box.style.width = (area.width * scaleFactor) + 'px';
                box.style.height = (area.height * scaleFactor) + 'px';
                box.innerText = index + 1;
                box.onclick = (e) => { e.stopPropagation(); highlightArea(index); };
                drawLayer.appendChild(box);
            });
            areaCountSpan.innerText = areas.length;
        }

        function renderList() {
            actionList.innerHTML = '';
            if(areas.length === 0) {
                actionList.innerHTML = '<div class="text-center text-slate-400 text-sm py-12 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">ğŸ‘† è«‹åœ¨å³å´åœ–ç‰‡ä¸Š<br>æ‹–æ›³æ»‘é¼ ç•«å‡ºæ¡†æ¡†</div>';
                return;
            }

            areas.forEach((area, index) => {
                const item = document.createElement('div');
                item.className = 'bg-white p-3 rounded-xl border border-slate-200 text-sm flex gap-3 items-center shadow-sm hover:shadow-md transition group animate-fade-in';
                item.innerHTML = `
                    <span class="bg-slate-800 text-white w-6 h-6 flex items-center justify-center rounded-md text-xs font-bold shrink-0 shadow-sm">${index + 1}</span>
                    <input type="text" value="${area.text}" onchange="updateText(${index}, this.value)" class="flex-1 border border-slate-200 p-2 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 bg-slate-50 text-slate-700 font-medium" placeholder="è§¸ç™¼é—œéµå­—">
                    <button onclick="deleteArea(${index})" class="text-slate-300 hover:text-red-500 p-1.5 rounded-lg transition hover:bg-red-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                `;
                item.onclick = () => highlightArea(index);
                actionList.appendChild(item);
            });
        }

        function updateText(index, val) {
            areas[index].text = val;
            saveState();
        }

        function deleteArea(index) {
            areas.splice(index, 1);
            renderAreas();
            renderList();
            saveState();
        }

        function highlightArea(index) {
            document.querySelectorAll('.area-box').forEach((el, i) => {
                if (i === index) el.classList.add('selected');
                else el.classList.remove('selected');
            });
            const listItems = actionList.children;
            if(listItems[index]) listItems[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function downloadJSON() {
            const url = imageUrlInput.value;
            const isAuto = autoScaleCheckbox.checked;

            if (!url) { alert("âš ï¸ è«‹å…ˆåœ¨æ­¥é©Ÿ 2 å¡«å¯«ã€Œåœ–ç‰‡ç¶²å€ã€ï¼"); document.getElementById('imageUrl').focus(); return; }
            if (areas.length === 0) { alert("âš ï¸ é€™è£¡ç©ºç©ºçš„ï¼è«‹å…ˆç•«å¹¾å€‹æ¡†æ¡†ã€‚"); return; }

            let outputWidth = naturalWidth;
            let outputHeight = naturalHeight;
            let outputScale = 1;

            if (isAuto && naturalWidth !== 1040) {
                outputWidth = 1040;
                outputScale = 1040 / naturalWidth;
                outputHeight = Math.round(naturalHeight * outputScale);
            }

            const output = {
                "type": "imagemap",
                "baseUrl": url,
                "altText": "è«‹é¸æ“‡åŠŸèƒ½",
                "baseSize": {
                    "width": outputWidth,
                    "height": outputHeight
                },
                "actions": areas.map(area => ({
                    "type": "message",
                    "text": area.text,
                    "area": {
                        "x": Math.round(area.x * outputScale),
                        "y": Math.round(area.y * outputScale),
                        "width": Math.round(area.width * outputScale),
                        "height": Math.round(area.height * outputScale)
                    }
                }))
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(output, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "imagemap_settings.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>
