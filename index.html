<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE è¬èƒ½ç·¨è¼¯å™¨ (v16.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        /* ç•«å¸ƒå®¹å™¨ */
        .canvas-scroll-container { height: 60vh; overflow: auto; border: 2px dashed #cbd5e1; background: #f8fafc radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; position: relative; display: flex; align-items: center; justify-content: center; }
        .canvas-content-wrapper { position: relative; transform-origin: center top; transition: width 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .area-box { position: absolute; border: 2px solid rgba(239,68,68,0.9); background: rgba(239,68,68,0.2); cursor: move; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px black; user-select: none; }
        .area-box.selected { border-color: #f59e0b; background: rgba(245,158,11,0.3); z-index: 20; }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: #f1f5f9; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .tab-btn { opacity: 0.6; border-bottom: 4px solid transparent; } .tab-btn.active { opacity: 1; border-bottom: 4px solid #4f46e5; color: #4f46e5; background: #eef2ff; }
        .flow-step-btn { opacity: 0.7; background: #f1f5f9; } .flow-step-btn.active { opacity: 1; background: #4f46e5; color: white; }
        .card-dot { width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; cursor: pointer; transition: all 0.2s; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); } .card-dot.active { background: #4f46e5; transform: scale(1.3); border-color: #eef2ff; }
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #4f46e5; }
        .code-block { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre; position: relative; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-white border-b border-slate-200 shadow-sm flex-shrink-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-800 rounded-lg flex items-center justify-center text-white text-xl shadow-lg">ğŸ¦</div>
                <div>
                    <h1 class="font-bold text-xl tracking-wide text-slate-800 flex items-center gap-2">
                        LINE è¬èƒ½ç·¨è¼¯å™¨ 
                        <span class="text-[10px] bg-rose-100 text-rose-700 px-2 py-0.5 rounded-full border border-rose-200">v16.0 æ——è‰¦ç‰ˆ</span>
                    </h1>
                    <p class="text-xs text-slate-400">å¤§å¿ƒå®¶æ—ç³»çµ± | æ”¯æ´ 4 å±¤è‡ªå‹•è·³è½‰æµç¨‹</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openModal('tutorialModal')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition flex items-center gap-2">ğŸ“š æ•™å­¸èˆ‡ä»£ç¢¼</button>
                <button onclick="downloadJSON()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-lg font-bold shadow-md transform transition active:scale-95 flex items-center gap-2 text-sm">ğŸ’¾ ä¸‹è¼‰è¨­å®š</button>
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-slate-200 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex">
            <button onclick="switchTab('imagemap')" id="tab-imagemap" class="tab-btn active flex-1 py-3 font-bold text-lg transition flex items-center justify-center gap-2">ğŸ—ºï¸ åº§æ¨™å¼•æµåœ–</button>
            <button onclick="switchTab('carousel')" id="tab-carousel" class="tab-btn flex-1 py-3 font-bold text-lg transition flex items-center justify-center gap-2">ğŸ  åº§æ¨™æ»‘å‹•å¡ç‰‡</button>
            <button onclick="switchTab('flow')" id="tab-flow" class="tab-btn flex-1 py-3 font-bold text-lg transition flex items-center justify-center gap-2 bg-rose-50 text-rose-700">ğŸ”— å¤šå±¤æ¬¡å°è¦½æµç¨‹ (New!)</button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full bg-white relative">
        
        <aside class="w-[420px] border-r border-slate-200 flex flex-col z-20 bg-white h-full overflow-hidden">
            
            <div id="flowStepNav" class="hidden grid grid-cols-4 gap-1 p-2 bg-slate-100 border-b">
                <button onclick="switchFlowStep(0)" id="flow-step-0" class="flow-step-btn active rounded py-2 text-xs font-bold text-center transition">Step 1<br>å…¥å£åœ–</button>
                <button onclick="switchFlowStep(1)" id="flow-step-1" class="flow-step-btn rounded py-2 text-xs font-bold text-center transition">Step 2<br>ä¸»é¸å–®</button>
                <button onclick="switchFlowStep(2)" id="flow-step-2" class="flow-step-btn rounded py-2 text-xs font-bold text-center transition">Step 3<br>åˆ†é¡åœ–</button>
                <button onclick="switchFlowStep(3)" id="flow-step-3" class="flow-step-btn rounded py-2 text-xs font-bold text-center transition">Step 4<br>è©³æƒ…åœ–</button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
                
                <div id="keywordBlock" class="bg-blue-50 rounded-xl p-4 border border-blue-100 space-y-2">
                    <label class="font-bold text-blue-800 text-sm">LINE è§¸ç™¼é—œéµå­—</label>
                    <input type="text" id="triggerKeyword" value="é¸å–®" placeholder="ä¾‹å¦‚: é¸å–®" class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 font-bold text-blue-700" oninput="updateGasCode()">
                </div>

                <div id="flowHelpBlock" class="hidden bg-rose-50 rounded-xl p-4 border border-rose-100 space-y-2 text-sm text-rose-800">
                    <p class="font-bold">ğŸ’¡ æµç¨‹æ¨¡å¼èªªæ˜ï¼š</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li>è«‹ä¾åºè¨­å®š Step 1 åˆ° Step 4 çš„åœ–ç‰‡ã€‚</li>
                        <li>åœ¨ Step 1~3 ç•«æ¡†æ¡†æ™‚ï¼Œå‹•ä½œè«‹é¸ <b>ã€ŒğŸ”— è·³è½‰åˆ°ä¸‹ä¸€å±¤ã€</b>ï¼Œæ©Ÿå™¨äººå°±æœƒè‡ªå‹•ä¸²æ¥ï¼</li>
                        <li>Step 1 çš„è§¸ç™¼é—œéµå­—é è¨­ç‚º <b>ã€Œé–‹å§‹å°è¦½ã€</b> (å¯ä¿®æ”¹)ã€‚</li>
                    </ul>
                </div>

                <div id="carouselControls" class="hidden space-y-4 p-4 bg-amber-50 rounded-xl border border-amber-100 shadow-sm">
                    <div class="flex justify-between items-center">
                        <label class="font-bold text-amber-800 text-sm">ğŸ“¦ å¡ç‰‡ç®¡ç†</label>
                        <div class="flex gap-2">
                            <button onclick="addCard()" class="bg-amber-500 text-white px-3 py-1 rounded text-xs hover:bg-amber-600 font-bold shadow">+ åŠ ä¸€å¼µ</button>
                            <button onclick="deleteCard()" class="text-red-500 text-xs hover:underline">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 justify-center flex-wrap py-2" id="cardDots"></div>
                    <p class="text-center text-xs text-amber-700 font-bold">ç›®å‰ç·¨è¼¯ï¼šç¬¬ <span id="currentCardNum" class="text-lg text-amber-600">1</span> å¼µå¡ç‰‡</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <label class="block font-bold text-slate-700 text-sm mb-2" id="uploadLabel">1. ä¸Šå‚³åº•åœ– (è‡ªå‹•è¨˜æ†¶)</label>
                        <input type="file" id="imageInput" accept="image/*" class="block w-full text-xs file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-white file:text-slate-700 hover:file:bg-slate-100 file:border file:border-slate-300"/>
                        <div id="fileSizeWarning" class="hidden mt-2 text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200 flex items-center gap-1">âš ï¸ <b>æª”æ¡ˆéå¤§ï¼</b> LINE é™åˆ¶ 10MBã€‚</div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block font-bold text-slate-700 text-sm">2. åœ–ç‰‡ç¶²å€ (å¿…å¡«)</label>
                            <button onclick="openModal('imageHelpModal')" class="text-xs text-blue-600 hover:underline">â“ å¦‚ä½•å–å¾—?</button>
                        </div>
                        <input type="text" id="imageUrl" placeholder="https://... .jpg/.png" class="w-full p-2 border border-slate-300 rounded text-sm font-mono" oninput="saveCurrentDataState()">
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-2 border-b pb-2 sticky top-0 bg-white z-10">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="selectAllBtn" class="custom-checkbox" onchange="toggleSelectAll(this.checked)">
                            <label for="selectAllBtn" class="font-bold text-slate-700 text-sm cursor-pointer select-none">å…¨é¸</label>
                        </div>
                        <div class="flex items-center gap-3">
                             <span class="text-xs text-slate-400">å…± <span id="areaCount">0</span> çµ„</span>
                             <button onclick="deleteSelectedAreas()" id="deleteSelectedBtn" class="bg-red-50 text-red-500 px-3 py-1 rounded text-xs font-bold hover:bg-red-100 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                    <div id="actionList" class="space-y-2 pb-4 overflow-y-auto custom-scrollbar flex-1"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-100 p-6 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-2 bg-white p-2 rounded-lg shadow-sm border border-slate-200 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-500 pl-2">ğŸ” ç¸®æ”¾ï¼š</span>
                    <button onclick="adjustZoom(-10)" class="w-6 h-6 bg-slate-100 hover:bg-slate-200 rounded font-bold">-</button>
                    <span id="zoomDisplay" class="text-xs font-mono w-12 text-center bg-slate-50 border rounded py-1">100%</span>
                    <button onclick="adjustZoom(10)" class="w-6 h-6 bg-slate-100 hover:bg-slate-200 rounded font-bold">+</button>
                    <button onclick="resetZoom()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 ml-2">é©æ‡‰</button>
                </div>
                <div class="text-[10px] text-slate-400 pr-2">LINE æ¨™æº–å¯¬åº¦ï¼š1040px</div>
            </div>
            <div id="canvasWrapper" class="relative shadow-xl bg-white rounded-lg overflow-hidden flex-1 border border-slate-300">
                <div id="canvasContainer" class="canvas-scroll-container custom-scrollbar">
                    <div id="canvasContent" class="canvas-content-wrapper bg-white shadow-sm">
                        <div id="placeholder" class="flex flex-col items-center justify-center h-96 w-96 text-slate-300 absolute inset-0 m-auto"><span class="text-lg font-bold">è«‹å…ˆä¸Šå‚³åœ–ç‰‡</span></div>
                        <img id="previewImage" class="hidden block select-none pointer-events-none" style="width: 100%; display: block;" />
                        <div id="drawLayer" class="absolute inset-0 cursor-crosshair hidden z-10"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="tutorialModal" class="hidden fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ¤– æ©Ÿå™¨äººæ¶è¨­æ•™å­¸ (v16.0 Flowç‰ˆ)</h2>
                <button onclick="document.getElementById('tutorialModal').classList.add('hidden')" class="text-2xl text-slate-400 hover:text-red-500">âœ•</button>
            </div>
            <div class="p-8 overflow-y-auto space-y-8 bg-white">
                <div class="space-y-2">
                    <h3 class="font-bold text-lg flex items-center gap-2"><span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">1</span> Google Apps Script è¬ç”¨ç¨‹å¼ç¢¼ (Flow Map)</h3>
                    <p class="text-sm text-slate-600">è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼ï¼Œè²¼åˆ° GAS å°ˆæ¡ˆä¸­ã€‚<span class="text-red-500 font-bold">æ³¨æ„ï¼šç¬¬ä¸€è¡Œçš„ TOKEN è¦æ›æˆä½ è‡ªå·±çš„ï¼</span><br>é€™æ®µä»£ç¢¼å·²ç¶“åŒ…å«äº†ä½ è¨­å®šçš„æ‰€æœ‰æµç¨‹å’Œåœ–ç‰‡è³‡æ–™ï¼Œ<b class="text-blue-600">ä¸éœ€è¦å†ä¸‹è¼‰ JSON æª”æ¡ˆäº†ï¼</b></p>
                    <div class="bg-slate-800 text-slate-200 p-4 rounded-xl font-mono text-xs overflow-x-auto relative shadow-inner">
                        <button onclick="copyCode()" class="absolute top-3 right-3 bg-white/10 border border-white/20 px-3 py-1 rounded hover:bg-white/20 transition text-white">è¤‡è£½ä»£ç¢¼</button>
                        <pre id="gasCode"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="imageHelpModal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-xl shadow-xl max-w-md p-6 relative"><button onclick="document.getElementById('imageHelpModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">âœ•</button><h3 class="font-bold text-lg mb-4">ğŸ“· å¦‚ä½•å–å¾—åœ–ç‰‡ç¶²å€ï¼Ÿ</h3><ol class="list-decimal pl-5 space-y-2 text-sm text-slate-700 mb-4"><li>æ¨è–¦ä½¿ç”¨ <a href="https://imgur.com/upload" target="_blank" class="text-blue-600 underline">Imgur (å…è¨»å†Š)</a>ã€‚</li><li>å°‡åœ–ç‰‡æ‹–æ‹‰ä¸Šå‚³ã€‚</li><li>å°è‘—ä¸Šå‚³å¥½çš„åœ–ç‰‡æŒ‰ <b>å³éµ</b>ã€‚</li><li>é¸æ“‡ <b>ã€Œè¤‡è£½åœ–ç‰‡ä½å€ã€</b> (Copy Image Link)ã€‚</li></ol><button onclick="document.getElementById('imageHelpModal').classList.add('hidden')" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold">æ‡‚äº†</button></div></div>

    <script>
        let currentMode = 'imagemap';
        let currentCardIndex = 0;
        let currentFlowStep = 0;
        let currentZoom = 100;

        // Data Models
        let imagemapData = { imageUrl: "", localPreview: "", areas: [] };
        let carouselCards = [{ imageUrl: "", localPreview: "", areas: [] }];
        // Flow Data: Array of 4 steps
        let flowData = [
            { name: "Step 1", imageUrl: "", localPreview: "", areas: [], trigger: "é–‹å§‹å°è¦½" },
            { name: "Step 2", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_2__" },
            { name: "Step 3", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_3__" },
            { name: "Step 4", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_4__" }
        ];

        // UI Refs
        const imageInput = document.getElementById('imageInput');
        const imageUrlInput = document.getElementById('imageUrl');
        const previewImage = document.getElementById('previewImage');
        const drawLayer = document.getElementById('drawLayer');
        const actionList = document.getElementById('actionList');
        const placeholder = document.getElementById('placeholder');
        const areaCountSpan = document.getElementById('areaCount');
        const triggerKeywordInput = document.getElementById('triggerKeyword');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const fileSizeWarning = document.getElementById('fileSizeWarning');
        const zoomDisplay = document.getElementById('zoomDisplay');
        const flowStepNav = document.getElementById('flowStepNav');
        const keywordBlock = document.getElementById('keywordBlock');
        const flowHelpBlock = document.getElementById('flowHelpBlock');
        const carouselControls = document.getElementById('carouselControls');
        const uploadLabel = document.getElementById('uploadLabel');
        
        let isDrawing = false; let startX, startY; let currentBox = null;
        let naturalWidth = 0; let naturalHeight = 0; let scaleFactor = 1;

        window.addEventListener('DOMContentLoaded', () => { updateGasCode(); renderDots(); updateBatchControls(); });

        // ================= Data Logic =================
        function getCurrentDataObj() {
            if(currentMode === 'imagemap') return imagemapData;
            if(currentMode === 'carousel') return carouselCards[currentCardIndex];
            if(currentMode === 'flow') return flowData[currentFlowStep];
        }

        function loadCurrentData() {
            const data = getCurrentDataObj();
            imageUrlInput.value = data.imageUrl || "";
            const imgSource = data.localPreview || data.imageUrl;
            previewImage.classList.add('hidden'); drawLayer.classList.add('hidden'); placeholder.classList.remove('hidden');
            
            if(imgSource) {
                previewImage.src = imgSource;
                previewImage.onload = function() {
                    naturalWidth = this.naturalWidth; naturalHeight = this.naturalHeight;
                    previewImage.classList.remove('hidden'); drawLayer.classList.remove('hidden'); placeholder.classList.add('hidden');
                    applyZoom(); renderAreas(); renderActionList();
                }
            } else {
                previewImage.src = ""; renderAreas(); renderActionList();
            }
             // Update trigger input for Flow Step 1
            if(currentMode === 'flow' && currentFlowStep === 0) {
                triggerKeywordInput.value = data.trigger;
            }
        }

        function saveCurrentDataState() { getCurrentDataObj().imageUrl = imageUrlInput.value; }

        // ================= Mode Switcher =================
        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            flowStepNav.classList.add('hidden');
            carouselControls.classList.add('hidden');
            keywordBlock.classList.remove('hidden');
            flowHelpBlock.classList.add('hidden');
            uploadLabel.innerText = "1. ä¸Šå‚³åº•åœ– (è‡ªå‹•è¨˜æ†¶)";

            if(mode === 'carousel') {
                carouselControls.classList.remove('hidden');
                triggerKeywordInput.value = "å‘½ç›¤";
            } else if (mode === 'flow') {
                flowStepNav.classList.remove('hidden');
                flowHelpBlock.classList.remove('hidden');
                switchFlowStep(0); // Default to Step 1
                return; // switchFlowStep handles loading
            } else {
                triggerKeywordInput.value = "é¸å–®";
            }
            resetZoom(); loadCurrentData(); updateGasCode(); updateBatchControls();
        }

        function switchFlowStep(stepIndex) {
            currentFlowStep = stepIndex;
            document.querySelectorAll('.flow-step-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`flow-step-${stepIndex}`).classList.add('active');
            uploadLabel.innerText = `1. ä¸Šå‚³ Step ${stepIndex+1} åº•åœ–`;
            // Hide keyword input for steps 2-4 as they are triggered automatically
            if(stepIndex > 0) keywordBlock.classList.add('hidden');
            else keywordBlock.classList.remove('hidden');
            resetZoom(); loadCurrentData(); updateBatchControls();
        }

        // ================= Carousel & Flow Card Mgmt =================
        function addCard() {
            if(currentMode !== 'carousel') return;
            if(carouselCards.length >= 10) { alert("æœ€å¤š 10 å¼µå¡ç‰‡ï¼"); return; }
            carouselCards.push({ imageUrl: "", localPreview: "", areas: [] });
            currentCardIndex = carouselCards.length - 1;
            resetZoom(); loadCurrentData(); renderDots();
        }
        function deleteCard() {
             if(currentMode !== 'carousel') return;
            if(carouselCards.length <= 1) { alert("è‡³å°‘è¦ç•™ä¸€å¼µå¡ç‰‡ï¼"); return; }
            if(!confirm("ç¢ºå®šåˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ")) return;
            carouselCards.splice(currentCardIndex, 1);
            if(currentCardIndex >= carouselCards.length) currentCardIndex = carouselCards.length - 1;
            loadCurrentData(); renderDots();
        }
        function switchCard(index) {
             if(currentMode !== 'carousel') return;
            saveCurrentDataState(); currentCardIndex = index;
            resetZoom(); loadCurrentData(); renderDots(); updateBatchControls();
        }
        function renderDots() {
            const container = document.getElementById('cardDots'); container.innerHTML = '';
            document.getElementById('currentCardNum').innerText = currentCardIndex + 1;
            carouselCards.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `card-dot ${i === currentCardIndex ? 'active' : ''}`;
                dot.onclick = () => switchCard(i); container.appendChild(dot);
            });
        }

        // ================= Image & Zoom =================
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            fileSizeWarning.classList.toggle('hidden', file.size <= 10*1024*1024);
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = getCurrentDataObj();
                data.localPreview = evt.target.result; data.areas = []; loadCurrentData();
            }
            reader.readAsDataURL(file);
        });
        function adjustZoom(delta) { currentZoom = Math.min(Math.max(currentZoom + delta, 10), 300); applyZoom(); }
        function resetZoom() { currentZoom = 100; applyZoom(); }
        function applyZoom() {
            zoomDisplay.innerText = currentZoom + "%";
            document.getElementById('canvasContent').style.width = currentZoom + "%";
            requestAnimationFrame(() => { updateScale(); renderAreas(); });
        }
        new ResizeObserver(updateScale).observe(previewImage);
        function updateScale() { if(naturalWidth>0 && previewImage.offsetWidth > 0) scaleFactor = previewImage.offsetWidth / naturalWidth; }

        // ================= Drawing Logic =================
        drawLayer.addEventListener('mousedown', (e) => {
            if(!previewImage.src) return; isDrawing = true; updateScale(); 
            const rect = drawLayer.getBoundingClientRect();
            startX = (e.clientX - rect.left) / scaleFactor; startY = (e.clientY - rect.top) / scaleFactor;
            currentBox = document.createElement('div'); currentBox.className = 'area-box border-dashed opacity-50';
            currentBox.style.left = (startX * scaleFactor)+'px'; currentBox.style.top = (startY * scaleFactor)+'px';
            drawLayer.appendChild(currentBox);
        });
        drawLayer.addEventListener('mousemove', (e) => {
            if (!isDrawing) return; const rect = drawLayer.getBoundingClientRect();
            const currentX = (e.clientX - rect.left)/scaleFactor; const currentY = (e.clientY - rect.top)/scaleFactor;
            const w = Math.abs(currentX - startX); const h = Math.abs(currentY - startY);
            currentBox.style.width = (w*scaleFactor)+'px'; currentBox.style.height = (h*scaleFactor)+'px';
            currentBox.style.left = (Math.min(startX, currentX)*scaleFactor)+'px'; currentBox.style.top = (Math.min(startY, currentY)*scaleFactor)+'px';
        });
        drawLayer.addEventListener('mouseup', (e) => {
            if(!isDrawing) return; isDrawing = false; const rect = drawLayer.getBoundingClientRect();
            const endX = (e.clientX - rect.left)/scaleFactor; const endY = (e.clientY - rect.top)/scaleFactor;
            if(currentBox) currentBox.remove();
            const w = Math.abs(endX - startX); const h = Math.abs(endY - startY);
            if(w > 20 && h > 20) {
                const data = getCurrentDataObj();
                let defaultType = 'message'; let defaultText = `é—œéµå­—${data.areas.length+1}`;
                // Auto set flow trigger
                if(currentMode === 'flow' && currentFlowStep < 3) {
                    defaultType = 'flow_next';
                    defaultText = flowData[currentFlowStep+1].trigger;
                }
                data.areas.push({ x:Math.round(Math.min(startX, endX)), y:Math.round(Math.min(startY, endY)), width:Math.round(w), height:Math.round(h), text:defaultText, type:defaultType, selected:false });
                renderAreas(); renderActionList();
            }
        });

        function renderAreas() {
            const data = getCurrentDataObj(); drawLayer.innerHTML = '';
            data.areas.forEach((area, i) => {
                const el = document.createElement('div'); el.className = `area-box ${area.selected ? 'selected' : ''}`;
                el.style.left = (area.x*scaleFactor)+'px'; el.style.top = (area.y*scaleFactor)+'px';
                el.style.width = (area.width*scaleFactor)+'px'; el.style.height = (area.height*scaleFactor)+'px';
                el.innerText = i + 1; el.onclick = (e) => { e.stopPropagation(); toggleAreaSelection(i); };
                if(area.type === 'uri') { el.style.borderColor='#2563eb'; el.style.backgroundColor='rgba(37,99,235,0.2)'; }
                if(area.type === 'flow_next') { el.style.borderColor='#be123c'; el.style.backgroundColor='rgba(190,18,60,0.2)'; }
                drawLayer.appendChild(el);
            });
            areaCountSpan.innerText = data.areas.length;
        }

        // ================= Action List =================
        function renderActionList() {
            const data = getCurrentDataObj(); actionList.innerHTML = '';
            if(data.areas.length === 0) { actionList.innerHTML = '<div class="text-center text-slate-400 text-sm py-8 border-2 border-dashed rounded-lg">è«‹åœ¨å³å´åœ–ç‰‡ç•«æ¡†æ¡† â†—ï¸</div>'; updateBatchControls(); return; }
            data.areas.forEach((area, i) => {
                const row = document.createElement('div');
                row.className = `bg-white p-3 rounded-lg border ${area.selected ? 'border-blue-500 bg-blue-50' : 'border-slate-200'} text-sm space-y-2 shadow-sm transition-colors`;
                let flowOption = ''; let isReadOnly = false;
                if(currentMode === 'flow' && currentFlowStep < 3) {
                    flowOption = `<option value="flow_next" ${area.type==='flow_next'?'selected':''}>ğŸ”— è·³è½‰åˆ°ä¸‹ä¸€å±¤</option>`;
                    if(area.type === 'flow_next') isReadOnly = true;
                }
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="custom-checkbox shrink-0" ${area.selected ? 'checked' : ''} onchange="toggleAreaSelection(${i})">
                        <span class="bg-slate-800 text-white w-5 h-5 flex items-center justify-center rounded text-xs font-bold shrink-0">${i+1}</span>
                        <select onchange="updateAreaType(${i}, this.value)" class="text-xs border p-1 rounded bg-slate-50 font-bold text-slate-600">
                            <option value="message" ${area.type==='message'?'selected':''}>ğŸ’¬ å‚³æ–‡å­—</option>
                            <option value="uri" ${area.type==='uri'?'selected':''}>ğŸ”— é–‹é€£çµ</option>
                            ${flowOption}
                        </select>
                        <div class="flex-1"></div>
                        <button onclick="removeArea(${i})" class="text-red-300 hover:text-red-500 px-2">âœ•</button>
                    </div>
                    <input type="text" value="${area.text}" onchange="updateAreaText(${i}, this.value)" class="w-full border p-2 rounded text-xs ${isReadOnly?'bg-slate-100 text-slate-500 cursor-not-allowed':''}" ${isReadOnly?'readonly':''} placeholder="è¼¸å…¥é—œéµå­—">
                `;
                actionList.appendChild(row);
            });
            updateBatchControls();
        }

        function toggleAreaSelection(i) { getCurrentDataObj().areas[i].selected = !getCurrentDataObj().areas[i].selected; renderAreas(); renderActionList(); }
        function toggleSelectAll(checked) { getCurrentDataObj().areas.forEach(a => a.selected = checked); renderAreas(); renderActionList(); }
        function deleteSelectedAreas() { const data = getCurrentDataObj(); if(confirm(`åˆªé™¤é¸å–çš„ ${data.areas.filter(a => a.selected).length} å€‹å€åŸŸï¼Ÿ`)) { data.areas = data.areas.filter(a => !a.selected); renderAreas(); renderActionList(); }}
        function updateBatchControls() { const data = getCurrentDataObj(); const total = data.areas.length; const selected = data.areas.filter(a => a.selected).length; selectAllBtn.checked = total>0 && total===selected; selectAllBtn.indeterminate = selected>0 && selected<total; selectAllBtn.disabled = total===0; deleteSelectedBtn.disabled = selected===0; deleteSelectedBtn.innerHTML = `ğŸ—‘ï¸ åˆªé™¤ (${selected})`; }
        
        function updateAreaType(i, val) {
            const data = getCurrentDataObj(); data.areas[i].type = val;
            if(val === 'flow_next' && currentMode === 'flow' && currentFlowStep < 3) {
                data.areas[i].text = flowData[currentFlowStep+1].trigger;
            } else if (val === 'uri') { data.areas[i].text = ''; }
            renderAreas(); renderActionList();
        }
        function updateAreaText(i, val) { getCurrentDataObj().areas[i].text = val; }
        function removeArea(i) { getCurrentDataObj().areas.splice(i, 1); renderAreas(); renderActionList(); }

        // ================= JSON Generation (Internal Use) =================
        function generateImagemapJson(data) {
            const scale = (naturalWidth && naturalWidth !== 1040) ? 1040/naturalWidth : 1;
            return {
                "type": "imagemap", "baseUrl": data.imageUrl, "altText": "è«‹é¸æ“‡åŠŸèƒ½",
                "baseSize": { "width": 1040, "height": Math.round((naturalHeight || 1040) * scale) },
                "actions": data.areas.map(a => ({
                    "type": a.type === 'uri' ? 'uri' : 'message',
                    "text": a.type !== 'uri' ? a.text : undefined,
                    "linkUri": a.type === 'uri' ? a.text : undefined,
                    "area": { x: Math.round(a.x*scale), y: Math.round(a.y*scale), width: Math.round(a.width*scale), height: Math.round(a.height*scale) }
                }))
            };
        }

        function generateFlexCarouselJson(cardsData) {
            const bubbles = cardsData.map(card => {
                const imgUrl = card.imageUrl || "https://via.placeholder.com/1040x1040?text=No+Image";
                const clickAreas = card.areas.map(a => {
                    const leftP = (a.x / naturalWidth * 100).toFixed(4) + '%'; const topP = (a.y / naturalHeight * 100).toFixed(4) + '%';
                    const widthP = (a.width / naturalWidth * 100).toFixed(4) + '%'; const heightP = (a.height / naturalHeight * 100).toFixed(4) + '%';
                    return {
                        "type": "box", "layout": "vertical", "position": "absolute", "offsetStart": leftP, "offsetTop": topP, "width": widthP, "height": heightP,
                        "action": { "type": a.type === 'uri' ? 'uri' : 'message', "label": "action", "text": a.type !== 'uri' ? a.text : undefined, "uri": a.type === 'uri' ? a.text : undefined }
                    };
                });
                let ratio = (naturalWidth > 0 && naturalHeight > 0) ? `${naturalWidth}:${naturalHeight}` : "1:1";
                return { "type": "bubble", "body": { "type": "box", "layout": "overlap", "paddingAll": "0px", "contents": [ { "type": "image", "url": imgUrl, "size": "full", "aspectRatio": ratio, "aspectMode": "cover" }, ...clickAreas ] } };
            });
            return { "type": "flex", "altText": "è«‹é¸æ“‡é …ç›®", "contents": { "type": "carousel", "contents": bubbles } };
        }

        // ================= GAS Code & Download =================
        function updateGasCode() {
            if(currentMode === 'flow' && currentFlowStep === 0) flowData[0].trigger = triggerKeywordInput.value || 'é–‹å§‹å°è¦½';
            const trigger = triggerKeywordInput.value || 'é¸å–®';
            
            let flowMapStr = "";
            if(currentMode === 'flow') {
                flowData.forEach(step => {
                    if(!step.imageUrl) return;
                    const json = generateImagemapJson(step);
                    flowMapStr += `  "${step.trigger}": ${JSON.stringify(json, null, 2)},\n`;
                });
            }

            const code = `const CHANNEL_ACCESS_TOKEN = 'è«‹æ›æˆä½ çš„LINE_TOKEN'; 

// æµç¨‹åœ°åœ– (Flow Map) - è‡ªå‹•ç”Ÿæˆ
const flowMap = {
${flowMapStr}};

function doPost(e) {
  let replyToken = "", userMessage = "";
  try {
    const msg = JSON.parse(e.postData.contents);
    replyToken = msg.events[0].replyToken;
    userMessage = msg.events[0].message.text;
  } catch (error) { return ContentService.createTextOutput(""); }

  // æ ¸å¿ƒé‚è¼¯ï¼šæª¢æŸ¥ç”¨æˆ¶è¨Šæ¯æ˜¯å¦åœ¨æµç¨‹åœ°åœ–ä¸­
  if (flowMap[userMessage]) {
    replyMessage(replyToken, flowMap[userMessage]);
  } 
  // ä¸€èˆ¬æ¨¡å¼çš„è§¸ç™¼ (å¦‚æœåœ¨ Flow æ¨¡å¼å‰‡ä¸ä½¿ç”¨)
  else if ("${currentMode}" !== "flow" && userMessage === "${trigger}") {
    // åœ¨é€™è£¡è²¼ä¸Š Imagemap æˆ– Carousel çš„ JSON (å¦‚æœéœ€è¦)
    // const myJson = { ... };
    // replyMessage(replyToken, myJson);
  }
  
  return ContentService.createTextOutput(JSON.stringify({'content': 'post ok'})).setMimeType(ContentService.MimeType.JSON);
}

function replyMessage(replyToken, messageJson) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    'headers': { 'Content-Type': 'application/json; charset=UTF-8', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post',
    'payload': JSON.stringify({ 'replyToken': replyToken, 'messages': [messageJson] }),
  });
}`;
            document.getElementById('gasCode').innerText = code;
        }

        function downloadJSON() {
            if (currentMode === 'flow') { alert("æµç¨‹æ¨¡å¼è«‹ç›´æ¥è¤‡è£½ã€Œæ•™å­¸èˆ‡ä»£ç¢¼ã€ä¸­çš„å®Œæ•´ç¨‹å¼ç¢¼ï¼Œç„¡éœ€ä¸‹è¼‰ JSONã€‚"); return; }
            let output = {};
            if (currentMode === 'imagemap') {
                if (!imagemapData.imageUrl) { alert("è«‹å¡«å¯«åœ–ç‰‡ç¶²å€"); return; }
                output = generateImagemapJson(imagemapData);
            } else {
                if (carouselCards.some(c => !c.imageUrl)) { alert("è«‹ç¢ºä¿æ‰€æœ‰å¡ç‰‡éƒ½æœ‰åœ–ç‰‡ç¶²å€"); return; }
                output = generateFlexCarouselJson(carouselCards);
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(output, null, 2));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `${currentMode}_settings.json`); dl.click();
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); if(id==='tutorialModal') updateGasCode(); }
        function copyCode() { navigator.clipboard.writeText(document.getElementById('gasCode').innerText); alert('è¤‡è£½æˆåŠŸï¼'); }
    </script>
</body>
</html>
