<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE è¬èƒ½ç·¨è¼¯å™¨ (v17.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        
        /* ç•«å¸ƒå®¹å™¨ï¼šé«˜åº¦è‡ªé©æ‡‰ */
        .canvas-scroll-container { height: 100%; overflow: auto; border: 2px dashed #cbd5e1; background: #f8fafc radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; position: relative; display: flex; align-items: center; justify-content: center; }
        .canvas-content-wrapper { position: relative; transform-origin: center top; transition: width 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .area-box { position: absolute; border: 2px solid rgba(239,68,68,0.9); background: rgba(239,68,68,0.2); cursor: move; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px black; user-select: none; }
        .area-box.selected { border-color: #f59e0b; background: rgba(245,158,11,0.3); z-index: 20; }
        
        /* ä»‹é¢å…ƒä»¶ */
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: #f1f5f9; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .tab-btn { opacity: 0.6; border-bottom: 4px solid transparent; } .tab-btn.active { opacity: 1; border-bottom: 4px solid #4f46e5; color: #4f46e5; background: #eef2ff; }
        .flow-step-btn { opacity: 0.7; background: #f1f5f9; } .flow-step-btn.active { opacity: 1; background: #4f46e5; color: white; }
        .card-dot { width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; cursor: pointer; transition: all 0.2s; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); } .card-dot.active { background: #4f46e5; transform: scale(1.3); border-color: #eef2ff; }
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #4f46e5; }
        
        /* ç¨‹å¼ç¢¼å€å¡Š & é€£çµæŒ‰éˆ• */
        .code-block { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre; position: relative; border: 1px solid #334155; }
        .external-link-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; transition: all 0.2s; text-decoration: none; }
        .external-link-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* æ”¶åˆå‹•ç•« */
        #topSection { transition: all 0.3s ease-in-out; overflow: hidden; }
        .collapsed { height: 0 !important; padding: 0 !important; border: none !important; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

    <div id="topSection" class="flex-shrink-0 bg-white shadow-sm z-30 transition-all duration-300">
        <header class="border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 h-14 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-white text-lg shadow-lg">ğŸ¦</div>
                    <div>
                        <h1 class="font-bold text-lg tracking-wide text-slate-800 flex items-center gap-2">
                            LINE è¬èƒ½ç·¨è¼¯å™¨ 
                            <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full border border-indigo-200">v17.0 å°ˆæ³¨ç‰ˆ</span>
                        </h1>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openModal('tutorialModal')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-md transition flex items-center gap-1">
                        ğŸ“š æ–°æ‰‹ä¿æ¯æ•™å­¸
                    </button>
                    <button onclick="downloadJSON()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-md transform transition active:scale-95 flex items-center gap-1 text-xs">
                        ğŸ’¾ ä¸‹è¼‰è¨­å®š
                    </button>
                </div>
            </div>
        </header>

        <div class="border-b border-slate-200 bg-slate-50">
            <div class="max-w-7xl mx-auto flex">
                <button onclick="switchTab('imagemap')" id="tab-imagemap" class="tab-btn active flex-1 py-2 font-bold text-sm transition flex items-center justify-center gap-2">
                    ğŸ—ºï¸ åº§æ¨™å¼•æµåœ–
                </button>
                <button onclick="switchTab('carousel')" id="tab-carousel" class="tab-btn flex-1 py-2 font-bold text-sm transition flex items-center justify-center gap-2">
                    ğŸ  åº§æ¨™æ»‘å‹•å¡ç‰‡
                </button>
                <button onclick="switchTab('flow')" id="tab-flow" class="tab-btn flex-1 py-2 font-bold text-sm transition flex items-center justify-center gap-2 bg-rose-50 text-rose-700">
                    ğŸ”— å¤šå±¤æ¬¡å°è¦½æµç¨‹
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 flex justify-center hover:bg-slate-50 cursor-pointer" onclick="toggleHeader()" title="é»æ“Šæ”¶åˆ/å±•é–‹é¸å–®ï¼Œæ“´å¤§ç•«å¸ƒç©ºé–“">
        <div id="collapseIcon" class="text-slate-400 text-xs py-1">â–² æ”¶èµ·é¸å–® (å°ˆæ³¨æ¨¡å¼)</div>
    </div>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full bg-white relative">
        
        <aside class="w-[400px] border-r border-slate-200 flex flex-col z-20 bg-white h-full overflow-hidden flex-shrink-0">
            
            <div id="flowStepNav" class="hidden grid grid-cols-4 gap-1 p-2 bg-slate-100 border-b flex-shrink-0">
                <button onclick="switchFlowStep(0)" id="flow-step-0" class="flow-step-btn active rounded py-2 text-xs font-bold text-center transition">Step 1<br>å…¥å£åœ–</button>
                <button onclick="switchFlowStep(1)" id="flow-step-1" class="flow-step-btn rounded py-2 text-xs font-bold text-center transition">Step 2<br>ä¸»é¸å–®</button>
                <button onclick="switchFlowStep(2)" id="flow-step-2" class="flow-step-btn rounded py-2 text-xs font-bold text-center transition">Step 3<br>åˆ†é¡åœ–</button>
                <button onclick="switchFlowStep(3)" id="flow-step-3" class="flow-step-btn rounded py-2 text-xs font-bold text-center transition">Step 4<br>è©³æƒ…åœ–</button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
                
                <div id="keywordBlock" class="bg-blue-50 rounded-xl p-3 border border-blue-100 space-y-1">
                    <label class="font-bold text-blue-800 text-xs">LINE è§¸ç™¼é—œéµå­—</label>
                    <input type="text" id="triggerKeyword" value="é¸å–®" placeholder="ä¾‹å¦‚: é¸å–®" class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 font-bold text-blue-700" oninput="updateGasCode()">
                </div>

                <div id="flowHelpBlock" class="hidden bg-rose-50 rounded-xl p-3 border border-rose-100 space-y-1 text-xs text-rose-800">
                    <p class="font-bold">ğŸ’¡ æµç¨‹æ¨¡å¼ï¼š</p>
                    <ul class="list-disc pl-4">
                        <li>ä¾åºè¨­å®š Step 1~4 çš„åœ–ç‰‡ã€‚</li>
                        <li>ç•«æ¡†æ¡†æ™‚å‹•ä½œé¸ <b>ã€ŒğŸ”— è·³è½‰åˆ°ä¸‹ä¸€å±¤ã€</b>ã€‚</li>
                        <li>æœ€å¾Œåªéœ€è¤‡è£½ä¸€æ¬¡ç¨‹å¼ç¢¼å³å¯ã€‚</li>
                    </ul>
                </div>

                <div id="carouselControls" class="hidden space-y-3 p-3 bg-amber-50 rounded-xl border border-amber-100 shadow-sm">
                    <div class="flex justify-between items-center">
                        <label class="font-bold text-amber-800 text-sm">ğŸ“¦ å¡ç‰‡ç®¡ç†</label>
                        <div class="flex gap-2">
                            <button onclick="addCard()" class="bg-amber-500 text-white px-2 py-1 rounded text-xs hover:bg-amber-600 font-bold shadow">+ åŠ ä¸€å¼µ</button>
                            <button onclick="deleteCard()" class="text-red-500 text-xs hover:underline">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 justify-center flex-wrap" id="cardDots"></div>
                    <p class="text-center text-xs text-amber-700 font-bold">ç›®å‰ç·¨è¼¯ï¼šç¬¬ <span id="currentCardNum" class="text-lg text-amber-600">1</span> å¼µå¡ç‰‡</p>
                </div>

                <div class="space-y-3">
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <label class="block font-bold text-slate-700 text-xs mb-2" id="uploadLabel">1. ä¸Šå‚³åº•åœ– (è‡ªå‹•è¨˜æ†¶)</label>
                        <input type="file" id="imageInput" accept="image/*" class="block w-full text-xs file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-white file:text-slate-700 hover:file:bg-slate-100 file:border file:border-slate-300"/>
                        <div id="fileSizeWarning" class="hidden mt-2 text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200">âš ï¸ <b>æª”æ¡ˆéå¤§ï¼</b> LINE é™åˆ¶ 10MBã€‚</div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block font-bold text-slate-700 text-xs">2. åœ–ç‰‡ç¶²å€ (å¿…å¡«)</label>
                            <button onclick="openModal('imageHelpModal')" class="text-xs text-blue-600 hover:underline bg-blue-50 px-2 py-0.5 rounded border border-blue-100">â“ å¦‚ä½•å–å¾—?</button>
                        </div>
                        <input type="text" id="imageUrl" placeholder="è²¼ä¸Š https://... çµå°¾æ˜¯ .jpg/.png" class="w-full p-2 border border-slate-300 rounded text-sm font-mono" oninput="saveCurrentDataState()">
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-2 border-b pb-2 sticky top-0 bg-white z-10 pt-2">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="selectAllBtn" class="custom-checkbox" onchange="toggleSelectAll(this.checked)">
                            <label for="selectAllBtn" class="font-bold text-slate-700 text-xs cursor-pointer select-none">å…¨é¸</label>
                        </div>
                        <div class="flex items-center gap-2">
                             <span class="text-xs text-slate-400">å…± <span id="areaCount">0</span> çµ„</span>
                             <button onclick="deleteSelectedAreas()" id="deleteSelectedBtn" class="bg-red-50 text-red-500 px-2 py-1 rounded text-xs font-bold hover:bg-red-100 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                    <div id="actionList" class="space-y-2 pb-4 overflow-y-auto custom-scrollbar flex-1"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-100 p-4 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-2 bg-white p-2 rounded-lg shadow-sm border border-slate-200 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-500 pl-2">ğŸ” ç¸®æ”¾ï¼š</span>
                    <button onclick="adjustZoom(-10)" class="w-6 h-6 bg-slate-100 hover:bg-slate-200 rounded font-bold text-slate-600">-</button>
                    <span id="zoomDisplay" class="text-xs font-mono w-12 text-center bg-slate-50 border rounded py-1">100%</span>
                    <button onclick="adjustZoom(10)" class="w-6 h-6 bg-slate-100 hover:bg-slate-200 rounded font-bold text-slate-600">+</button>
                    <button onclick="resetZoom()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 ml-2">é©æ‡‰</button>
                </div>
                <div class="text-[10px] text-slate-400 pr-2 hidden md:block">LINE æ¨™æº–å¯¬åº¦ï¼š1040px</div>
            </div>
            <div id="canvasWrapper" class="relative shadow-xl bg-white rounded-lg overflow-hidden flex-1 border border-slate-300">
                <div id="canvasContainer" class="canvas-scroll-container custom-scrollbar">
                    <div id="canvasContent" class="canvas-content-wrapper bg-white shadow-sm">
                        <div id="placeholder" class="flex flex-col items-center justify-center h-96 w-96 text-slate-300 absolute inset-0 m-auto"><span class="text-lg font-bold">è«‹å…ˆä¸Šå‚³åœ–ç‰‡</span></div>
                        <img id="previewImage" class="hidden block select-none pointer-events-none" style="width: 100%; display: block;" />
                        <div id="drawLayer" class="absolute inset-0 cursor-crosshair hidden z-10"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="tutorialModal" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-indigo-50">
                <h2 class="text-2xl font-bold text-indigo-900 flex items-center gap-2">ğŸ¤– æ©Ÿå™¨äººæ¶è¨­ãƒ»æ–°æ‰‹ä¿æ¯æ•™å­¸</h2>
                <button onclick="document.getElementById('tutorialModal').classList.add('hidden')" class="text-2xl text-slate-400 hover:text-red-500 transition">âœ•</button>
            </div>
            <div class="p-8 overflow-y-auto space-y-10 bg-white">
                
                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl">1</div>
                    <div class="space-y-3 flex-1">
                        <h3 class="text-xl font-bold text-slate-800">å»ºç«‹å¤§è…¦ (Google Apps Script)</h3>
                        <p class="text-sm text-slate-600">é€™æ˜¯æ©Ÿå™¨äººçš„å¤§è…¦ï¼Œæˆ‘å€‘è¦æŠŠç¨‹å¼ç¢¼è²¼é€²å»ã€‚</p>
                        <a href="https://script.google.com/home" target="_blank" class="external-link-btn bg-indigo-100 text-indigo-700 hover:bg-indigo-200">
                            ğŸš€ é»æˆ‘é–‹å•Ÿ Google Apps Script
                        </a>
                        <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
                            <li>é»æ“Šå·¦ä¸Šè§’ <b>ã€Œæ–°å°ˆæ¡ˆã€</b>ã€‚</li>
                            <li>å°‡è£¡é¢çš„ç¨‹å¼ç¢¼æ¸…ç©ºã€‚</li>
                            <li><b>è¤‡è£½ä¸‹æ–¹é€™æ®µä»£ç¢¼</b>ï¼Œè²¼é€²å»ï¼š</li>
                        </ul>
                        
                        <div class="code-block mt-2">
                            <button onclick="copyCode()" class="absolute top-2 right-2 bg-white/10 border border-white/20 px-2 py-1 rounded hover:bg-white/20 transition text-white text-xs">è¤‡è£½ä»£ç¢¼</button>
                            <pre id="gasCode" class="text-xs"></pre>
                        </div>
                    </div>
                </section>

                <hr class="border-slate-100">

                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-xl">2</div>
                    <div class="space-y-3 flex-1">
                        <h3 class="text-xl font-bold text-slate-800">å–å¾—é‘°åŒ™ (LINE Token)</h3>
                        <p class="text-sm text-slate-600">æ©Ÿå™¨äººéœ€è¦ä¸€æŠŠé‘°åŒ™æ‰èƒ½æ§åˆ¶ LINEã€‚</p>
                        <a href="https://developers.line.biz/console/" target="_blank" class="external-link-btn bg-blue-100 text-blue-700 hover:bg-blue-200">
                            ğŸ”‘ é»æˆ‘é–‹å•Ÿ LINE Developers Console
                        </a>
                        <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
                            <li>ç™»å…¥å¾Œï¼Œé»é¸ä½ çš„ Provider > Channelã€‚</li>
                            <li>é»é¸ä¸Šæ–¹åˆ†é  <b>Messaging API</b>ã€‚</li>
                            <li>æ»‘åˆ°æœ€ä¸‹é¢æ‰¾åˆ° <b>Channel access token</b>ï¼Œé»æ“Š <b>Issue</b>ã€‚</li>
                            <li>è¤‡è£½é‚£ä¸²é•·é•·çš„äº‚ç¢¼ï¼Œ<b>å›ä¾†é€™è£¡ï¼ŒæŠŠç¨‹å¼ç¢¼ç¬¬ä¸€è¡Œçš„ <code>'è«‹æ›æˆä½ çš„LINE_TOKEN'</code> æ›æ‰ï¼</b></li>
                        </ul>
                    </div>
                </section>

                <hr class="border-slate-100">

                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-xl">3</div>
                    <div class="space-y-3 flex-1">
                        <h3 class="text-xl font-bold text-slate-800">å…¬é–‹éƒ¨ç½² (é—œéµæ­¥é©Ÿ)</h3>
                        <div class="bg-red-50 border-l-4 border-red-500 p-3 text-sm text-red-700">
                            <p class="font-bold">âš ï¸ é€™è£¡åšéŒ¯ï¼Œæ©Ÿå™¨äººå°±ä¸æœƒå‹•ï¼</p>
                        </div>
                        <ul class="list-decimal pl-5 text-sm text-slate-700 space-y-2">
                            <li>åœ¨ Google Apps Script é»æ“Šå³ä¸Šè§’ <b>ã€Œéƒ¨ç½²ã€</b> > <b>ã€Œæ–°å¢éƒ¨ç½²ã€</b>ã€‚</li>
                            <li>é»æ“Šé½’è¼ªåœ–ç¤º âš™ï¸ï¼Œé¸æ“‡ <b>ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</b>ã€‚</li>
                            <li>è¼¸å…¥èªªæ˜ (éš¨ä¾¿æ‰“ï¼Œä¾‹å¦‚ v1)ã€‚</li>
                            <li>åŸ·è¡Œèº«åˆ†ï¼šé¸ <b>ã€Œæˆ‘ (Me)ã€</b>ã€‚</li>
                            <li class="font-bold text-red-600">èª°å¯ä»¥å­˜å–ï¼šä¸€å®šè¦é¸ã€Œæ‰€æœ‰äºº (Anyone)ã€ï¼</li>
                            <li>é»æ“Šã€Œéƒ¨ç½²ã€ï¼Œç„¶å¾Œ<b>è¤‡è£½é‚£ä¸²ä»¥ <code>/exec</code> çµå°¾çš„ç¶²å€</b>ã€‚</li>
                        </ul>
                    </div>
                </section>

                <hr class="border-slate-100">

                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-emerald-600 text-white rounded-full flex items-center justify-center font-bold text-xl">4</div>
                    <div class="space-y-3 flex-1">
                        <h3 class="text-xl font-bold text-slate-800">é€£çµç¥ç¶“ (Webhook)</h3>
                        <p class="text-sm text-slate-600">å‘Šè¨´ LINE è¦æŠŠè¨Šæ¯å‚³åˆ°å“ªè£¡ã€‚</p>
                        <a href="https://manager.line.biz/" target="_blank" class="external-link-btn bg-emerald-100 text-emerald-700 hover:bg-emerald-200">
                            ğŸ’¬ é»æˆ‘é–‹å•Ÿ LINE Official Account Manager
                        </a>
                        <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
                            <li>é€²å…¥ <b>è¨­å®š</b> > <b>Messaging API</b>ã€‚</li>
                            <li>åœ¨ <b>Webhook URL</b> æ¬„ä½ï¼Œè²¼ä¸Šå‰›å‰›è¤‡è£½çš„ <code>/exec</code> ç¶²å€ï¼ŒæŒ‰æ›´æ–°ã€‚</li>
                            <li class="font-bold text-emerald-600">å‹™å¿…é–‹å•Ÿä¸‹æ–¹çš„ã€Œä½¿ç”¨ Webhookã€é–‹é—œã€‚</li>
                            <li>é»æ“Šã€Œé©—è­‰ã€ï¼Œå‡ºç¾ Success ä»£è¡¨æˆåŠŸï¼</li>
                        </ul>
                    </div>
                </section>

                <hr class="border-slate-100">

                <section class="flex gap-4 pb-10">
                    <div class="flex-shrink-0 w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold text-xl">5</div>
                    <div class="space-y-3 flex-1">
                        <h3 class="text-xl font-bold text-slate-800">å®Œæˆè¨­å®šï¼</h3>
                        <p class="text-sm text-slate-600">
                            ç¾åœ¨ï¼Œåªè¦ä½ åœ¨é€™å€‹ç¶²ç«™åšå¥½è¨­å®šï¼ˆç•«å¥½æ¡†æ¡†ï¼‰ï¼Œé€™æ®µç¨‹å¼ç¢¼å°±å·²ç¶“åŒ…å«äº†æ‰€æœ‰çš„è¨­å®šã€‚
                            <br><b>ä½ ä¸éœ€è¦å†ä¸‹è¼‰ JSON æª”æ¡ˆå»è²¼äº†ï¼</b> å› ç‚ºæˆ‘å€‘ç”¨çš„æ˜¯ã€Œå‹•æ…‹ç”Ÿæˆä»£ç¢¼ã€ã€‚
                            <br>åªè¦é‡æ–°éƒ¨ç½² Google Apps Script (è¨˜å¾—é¸å»ºç«‹æ–°ç‰ˆæœ¬)ï¼Œä½ çš„æ©Ÿå™¨äººå°±æœƒæ›´æ–°ï¼
                        </p>
                    </div>
                </section>

            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end">
                <button onclick="document.getElementById('tutorialModal').classList.add('hidden')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl hover:bg-indigo-700 transition font-bold shadow-lg transform active:scale-95">
                    æˆ‘å­¸æœƒäº†ï¼Œé–‹å§‹è£½ä½œï¼ğŸš€
                </button>
            </div>
        </div>
    </div>

    <div id="imageHelpModal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-xl shadow-xl max-w-md p-6 relative"><button onclick="document.getElementById('imageHelpModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">âœ•</button><h3 class="font-bold text-lg mb-4">ğŸ“· å¦‚ä½•å–å¾—åœ–ç‰‡ç¶²å€ï¼Ÿ</h3><ol class="list-decimal pl-5 space-y-2 text-sm text-slate-700 mb-4"><li>æ¨è–¦ä½¿ç”¨ <a href="https://imgur.com/upload" target="_blank" class="text-blue-600 underline">Imgur (å…è¨»å†Š)</a>ã€‚</li><li>å°‡åœ–ç‰‡æ‹–æ‹‰ä¸Šå‚³ã€‚</li><li>å°è‘—ä¸Šå‚³å¥½çš„åœ–ç‰‡æŒ‰ <b>å³éµ</b>ã€‚</li><li>é¸æ“‡ <b>ã€Œè¤‡è£½åœ–ç‰‡ä½å€ã€</b> (Copy Image Link)ã€‚</li><li>æª¢æŸ¥ç¶²å€çµå°¾å¿…é ˆæ˜¯ <b>.jpg</b> æˆ– <b>.png</b>ã€‚</li></ol><button onclick="document.getElementById('imageHelpModal').classList.add('hidden')" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold">æ‡‚äº†</button></div></div>

    <script>
        let currentMode = 'imagemap';
        let currentCardIndex = 0;
        let currentFlowStep = 0;
        let currentZoom = 100;
        let isHeaderCollapsed = false;

        // Data Models
        let imagemapData = { imageUrl: "", localPreview: "", areas: [] };
        let carouselCards = [{ imageUrl: "", localPreview: "", areas: [] }];
        let flowData = [
            { name: "Step 1", imageUrl: "", localPreview: "", areas: [], trigger: "é–‹å§‹å°è¦½" },
            { name: "Step 2", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_2__" },
            { name: "Step 3", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_3__" },
            { name: "Step 4", imageUrl: "", localPreview: "", areas: [], trigger: "__GOTO_STEP_4__" }
        ];

        // UI Refs
        const imageInput = document.getElementById('imageInput');
        const imageUrlInput = document.getElementById('imageUrl');
        const previewImage = document.getElementById('previewImage');
        const drawLayer = document.getElementById('drawLayer');
        const actionList = document.getElementById('actionList');
        const placeholder = document.getElementById('placeholder');
        const areaCountSpan = document.getElementById('areaCount');
        const triggerKeywordInput = document.getElementById('triggerKeyword');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const fileSizeWarning = document.getElementById('fileSizeWarning');
        const zoomDisplay = document.getElementById('zoomDisplay');
        const flowStepNav = document.getElementById('flowStepNav');
        const keywordBlock = document.getElementById('keywordBlock');
        const flowHelpBlock = document.getElementById('flowHelpBlock');
        const carouselControls = document.getElementById('carouselControls');
        const uploadLabel = document.getElementById('uploadLabel');
        const topSection = document.getElementById('topSection');
        const collapseIcon = document.getElementById('collapseIcon');
        
        let isDrawing = false; let startX, startY; let currentBox = null;
        let naturalWidth = 0; let naturalHeight = 0; let scaleFactor = 1;

        window.addEventListener('DOMContentLoaded', () => { updateGasCode(); renderDots(); updateBatchControls(); });

        // ================= UI Toggle =================
        function toggleHeader() {
            isHeaderCollapsed = !isHeaderCollapsed;
            if(isHeaderCollapsed) {
                topSection.classList.add('collapsed');
                collapseIcon.innerText = "â–¼ å±•é–‹é¸å–®";
            } else {
                topSection.classList.remove('collapsed');
                collapseIcon.innerText = "â–² æ”¶èµ·é¸å–® (å°ˆæ³¨æ¨¡å¼)";
            }
        }

        // ================= Data Logic =================
        function getCurrentDataObj() {
            if(currentMode === 'imagemap') return imagemapData;
            if(currentMode === 'carousel') return carouselCards[currentCardIndex];
            if(currentMode === 'flow') return flowData[currentFlowStep];
        }

        function loadCurrentData() {
            const data = getCurrentDataObj();
            imageUrlInput.value = data.imageUrl || "";
            const imgSource = data.localPreview || data.imageUrl;
            previewImage.classList.add('hidden'); drawLayer.classList.add('hidden'); placeholder.classList.remove('hidden');
            
            if(imgSource) {
                previewImage.src = imgSource;
                previewImage.onload = function() {
                    naturalWidth = this.naturalWidth; naturalHeight = this.naturalHeight;
                    previewImage.classList.remove('hidden'); drawLayer.classList.remove('hidden'); placeholder.classList.add('hidden');
                    applyZoom(); renderAreas(); renderActionList();
                }
            } else {
                previewImage.src = ""; renderAreas(); renderActionList();
            }
            if(currentMode === 'flow' && currentFlowStep === 0) triggerKeywordInput.value = data.trigger;
        }

        function saveCurrentDataState() { getCurrentDataObj().imageUrl = imageUrlInput.value; }

        // ================= Mode Switcher =================
        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            flowStepNav.classList.add('hidden');
            carouselControls.classList.add('hidden');
            keywordBlock.classList.remove('hidden');
            flowHelpBlock.classList.add('hidden');
            uploadLabel.innerText = "1. ä¸Šå‚³åº•åœ– (è‡ªå‹•è¨˜æ†¶)";

            if(mode === 'carousel') {
                carouselControls.classList.remove('hidden');
                triggerKeywordInput.value = "å‘½ç›¤";
            } else if (mode === 'flow') {
                flowStepNav.classList.remove('hidden');
                flowHelpBlock.classList.remove('hidden');
                switchFlowStep(0); return; 
            } else {
                triggerKeywordInput.value = "é¸å–®";
            }
            resetZoom(); loadCurrentData(); updateGasCode(); updateBatchControls();
        }

        function switchFlowStep(stepIndex) {
            currentFlowStep = stepIndex;
            document.querySelectorAll('.flow-step-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`flow-step-${stepIndex}`).classList.add('active');
            uploadLabel.innerText = `1. ä¸Šå‚³ Step ${stepIndex+1} åº•åœ–`;
            if(stepIndex > 0) keywordBlock.classList.add('hidden'); else keywordBlock.classList.remove('hidden');
            resetZoom(); loadCurrentData(); updateBatchControls();
        }

        // ================= Card Mgmt =================
        function addCard() {
            if(currentMode !== 'carousel') return;
            if(carouselCards.length >= 10) { alert("æœ€å¤š 10 å¼µå¡ç‰‡ï¼"); return; }
            carouselCards.push({ imageUrl: "", localPreview: "", areas: [] });
            currentCardIndex = carouselCards.length - 1; resetZoom(); loadCurrentData(); renderDots();
        }
        function deleteCard() {
             if(currentMode !== 'carousel') return;
            if(carouselCards.length <= 1) { alert("è‡³å°‘è¦ç•™ä¸€å¼µå¡ç‰‡ï¼"); return; }
            if(!confirm("ç¢ºå®šåˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ")) return;
            carouselCards.splice(currentCardIndex, 1);
            if(currentCardIndex >= carouselCards.length) currentCardIndex = carouselCards.length - 1;
            loadCurrentData(); renderDots();
        }
        function switchCard(index) {
             if(currentMode !== 'carousel') return;
            saveCurrentDataState(); currentCardIndex = index; resetZoom(); loadCurrentData(); renderDots(); updateBatchControls();
        }
        function renderDots() {
            const container = document.getElementById('cardDots'); container.innerHTML = '';
            document.getElementById('currentCardNum').innerText = currentCardIndex + 1;
            carouselCards.forEach((_, i) => {
                const dot = document.createElement('div'); dot.className = `card-dot ${i === currentCardIndex ? 'active' : ''}`;
                dot.onclick = () => switchCard(i); container.appendChild(dot);
            });
        }

        // ================= Image & Zoom =================
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            fileSizeWarning.classList.toggle('hidden', file.size <= 10*1024*1024);
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = getCurrentDataObj(); data.localPreview = evt.target.result; data.areas = []; loadCurrentData();
            }
            reader.readAsDataURL(file);
        });
        function adjustZoom(delta) { currentZoom = Math.min(Math.max(currentZoom + delta, 10), 300); applyZoom(); }
        function resetZoom() { currentZoom = 100; applyZoom(); }
        function applyZoom() {
            zoomDisplay.innerText = currentZoom + "%";
            document.getElementById('canvasContent').style.width = currentZoom + "%";
            requestAnimationFrame(() => { updateScale(); renderAreas(); });
        }
        new ResizeObserver(updateScale).observe(previewImage);
        function updateScale() { if(naturalWidth>0 && previewImage.offsetWidth > 0) scaleFactor = previewImage.offsetWidth / naturalWidth; }

        // ================= Drawing Logic =================
        drawLayer.addEventListener('mousedown', (e) => {
            if(!previewImage.src) return; isDrawing = true; updateScale(); 
            const rect = drawLayer.getBoundingClientRect();
            startX = (e.clientX - rect.left) / scaleFactor; startY = (e.clientY - rect.top) / scaleFactor;
            currentBox = document.createElement('div'); currentBox.className = 'area-box border-dashed opacity-50';
            currentBox.style.left = (startX * scaleFactor)+'px'; currentBox.style.top = (startY * scaleFactor)+'px';
            drawLayer.appendChild(currentBox);
        });
        drawLayer.addEventListener('mousemove', (e) => {
            if (!isDrawing) return; const rect = drawLayer.getBoundingClientRect();
            const currentX = (e.clientX - rect.left)/scaleFactor; const currentY = (e.clientY - rect.top)/scaleFactor;
            const w = Math.abs(currentX - startX); const h = Math.abs(currentY - startY);
            currentBox.style.width = (w*scaleFactor)+'px'; currentBox.style.height = (h*scaleFactor)+'px';
            currentBox.style.left = (Math.min(startX, currentX)*scaleFactor)+'px'; currentBox.style.top = (Math.min(startY, currentY)*scaleFactor)+'px';
        });
        drawLayer.addEventListener('mouseup', (e) => {
            if(!isDrawing) return; isDrawing = false; const rect = drawLayer.getBoundingClientRect();
            const endX = (e.clientX - rect.left)/scaleFactor; const endY = (e.clientY - rect.top)/scaleFactor;
            if(currentBox) currentBox.remove();
            const w = Math.abs(endX - startX); const h = Math.abs(endY - startY);
            if(w > 20 && h > 20) {
                const data = getCurrentDataObj();
                let defaultType = 'message'; let defaultText = `é—œéµå­—${data.areas.length+1}`;
                if(currentMode === 'flow' && currentFlowStep < 3) { defaultType = 'flow_next'; defaultText = flowData[currentFlowStep+1].trigger; }
                data.areas.push({ x:Math.round(Math.min(startX, endX)), y:Math.round(Math.min(startY, endY)), width:Math.round(w), height:Math.round(h), text:defaultText, type:defaultType, selected:false });
                renderAreas(); renderActionList();
            }
        });

        function renderAreas() {
            const data = getCurrentDataObj(); drawLayer.innerHTML = '';
            data.areas.forEach((area, i) => {
                const el = document.createElement('div'); el.className = `area-box ${area.selected ? 'selected' : ''}`;
                el.style.left = (area.x*scaleFactor)+'px'; el.style.top = (area.y*scaleFactor)+'px';
                el.style.width = (area.width*scaleFactor)+'px'; el.style.height = (area.height*scaleFactor)+'px';
                el.innerText = i + 1; el.onclick = (e) => { e.stopPropagation(); toggleAreaSelection(i); };
                if(area.type === 'uri') { el.style.borderColor='#2563eb'; el.style.backgroundColor='rgba(37,99,235,0.2)'; }
                if(area.type === 'flow_next') { el.style.borderColor='#be123c'; el.style.backgroundColor='rgba(190,18,60,0.2)'; }
                drawLayer.appendChild(el);
            });
            areaCountSpan.innerText = data.areas.length;
        }

        // ================= Action List =================
        function renderActionList() {
            const data = getCurrentDataObj(); actionList.innerHTML = '';
            if(data.areas.length === 0) { actionList.innerHTML = '<div class="text-center text-slate-400 text-sm py-8 border-2 border-dashed rounded-lg">è«‹åœ¨å³å´åœ–ç‰‡ç•«æ¡†æ¡† â†—ï¸</div>'; updateBatchControls(); return; }
            data.areas.forEach((area, i) => {
                const row = document.createElement('div');
                row.className = `bg-white p-3 rounded-lg border ${area.selected ? 'border-blue-500 bg-blue-50' : 'border-slate-200'} text-sm space-y-2 shadow-sm transition-colors`;
                let flowOption = ''; let isReadOnly = false;
                if(currentMode === 'flow' && currentFlowStep < 3) {
                    flowOption = `<option value="flow_next" ${area.type==='flow_next'?'selected':''}>ğŸ”— è·³è½‰åˆ°ä¸‹ä¸€å±¤</option>`;
                    if(area.type === 'flow_next') isReadOnly = true;
                }
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="custom-checkbox shrink-0" ${area.selected ? 'checked' : ''} onchange="toggleAreaSelection(${i})">
                        <span class="bg-slate-800 text-white w-5 h-5 flex items-center justify-center rounded text-xs font-bold shrink-0">${i+1}</span>
                        <select onchange="updateAreaType(${i}, this.value)" class="text-xs border p-1 rounded bg-slate-50 font-bold text-slate-600">
                            <option value="message" ${area.type==='message'?'selected':''}>ğŸ’¬ å‚³æ–‡å­—</option>
                            <option value="uri" ${area.type==='uri'?'selected':''}>ğŸ”— é–‹é€£çµ</option>
                            ${flowOption}
                        </select>
                        <div class="flex-1"></div>
                        <button onclick="removeArea(${i})" class="text-red-300 hover:text-red-500 px-2">âœ•</button>
                    </div>
                    <input type="text" value="${area.text}" onchange="updateAreaText(${i}, this.value)" class="w-full border p-2 rounded text-xs ${isReadOnly?'bg-slate-100 text-slate-500 cursor-not-allowed':''}" ${isReadOnly?'readonly':''} placeholder="è¼¸å…¥é—œéµå­—">
                `;
                actionList.appendChild(row);
            });
            updateBatchControls();
        }

        function toggleAreaSelection(i) { getCurrentDataObj().areas[i].selected = !getCurrentDataObj().areas[i].selected; renderAreas(); renderActionList(); }
        function toggleSelectAll(checked) { getCurrentDataObj().areas.forEach(a => a.selected = checked); renderAreas(); renderActionList(); }
        function deleteSelectedAreas() { const data = getCurrentDataObj(); if(confirm(`åˆªé™¤é¸å–çš„ ${data.areas.filter(a => a.selected).length} å€‹å€åŸŸï¼Ÿ`)) { data.areas = data.areas.filter(a => !a.selected); renderAreas(); renderActionList(); }}
        function updateBatchControls() { const data = getCurrentDataObj(); const total = data.areas.length; const selected = data.areas.filter(a => a.selected).length; selectAllBtn.checked = total>0 && total===selected; selectAllBtn.indeterminate = selected>0 && selected<total; selectAllBtn.disabled = total===0; deleteSelectedBtn.disabled = selected===0; deleteSelectedBtn.innerHTML = `ğŸ—‘ï¸ åˆªé™¤ (${selected})`; }
        function updateAreaType(i, val) { const data = getCurrentDataObj(); data.areas[i].type = val; if(val === 'flow_next' && currentMode === 'flow' && currentFlowStep < 3) { data.areas[i].text = flowData[currentFlowStep+1].trigger; } else if (val === 'uri') { data.areas[i].text = ''; } renderAreas(); renderActionList(); }
        function updateAreaText(i, val) { getCurrentDataObj().areas[i].text = val; }
        function removeArea(i) { getCurrentDataObj().areas.splice(i, 1); renderAreas(); renderActionList(); }

        // ================= JSON Generation =================
        function generateImagemapJson(data) {
            const scale = (naturalWidth && naturalWidth !== 1040) ? 1040/naturalWidth : 1;
            return {
                "type": "imagemap", "baseUrl": data.imageUrl, "altText": "è«‹é¸æ“‡åŠŸèƒ½",
                "baseSize": { "width": 1040, "height": Math.round((naturalHeight || 1040) * scale) },
                "actions": data.areas.map(a => ({
                    "type": a.type === 'uri' ? 'uri' : 'message',
                    "text": a.type !== 'uri' ? a.text : undefined,
                    "linkUri": a.type === 'uri' ? a.text : undefined,
                    "area": { x: Math.round(a.x*scale), y: Math.round(a.y*scale), width: Math.round(a.width*scale), height: Math.round(a.height*scale) }
                }))
            };
        }

        function generateFlexCarouselJson(cardsData) {
            const bubbles = cardsData.map(card => {
                const imgUrl = card.imageUrl || "https://via.placeholder.com/1040x1040?text=No+Image";
                const clickAreas = card.areas.map(a => {
                    const leftP = (a.x / naturalWidth * 100).toFixed(4) + '%'; const topP = (a.y / naturalHeight * 100).toFixed(4) + '%';
                    const widthP = (a.width / naturalWidth * 100).toFixed(4) + '%'; const heightP = (a.height / naturalHeight * 100).toFixed(4) + '%';
                    return {
                        "type": "box", "layout": "vertical", "position": "absolute", "offsetStart": leftP, "offsetTop": topP, "width": widthP, "height": heightP,
                        "action": { "type": a.type === 'uri' ? 'uri' : 'message', "label": "action", "text": a.type !== 'uri' ? a.text : undefined, "uri": a.type === 'uri' ? a.text : undefined }
                    };
                });
                let ratio = (naturalWidth > 0 && naturalHeight > 0) ? `${naturalWidth}:${naturalHeight}` : "1:1";
                return { "type": "bubble", "body": { "type": "box", "layout": "overlap", "paddingAll": "0px", "contents": [ { "type": "image", "url": imgUrl, "size": "full", "aspectRatio": ratio, "aspectMode": "cover" }, ...clickAreas ] } };
            });
            return { "type": "flex", "altText": "è«‹é¸æ“‡é …ç›®", "contents": { "type": "carousel", "contents": bubbles } };
        }

        // ================= Code Generation =================
        function updateGasCode() {
            if(currentMode === 'flow' && currentFlowStep === 0) flowData[0].trigger = triggerKeywordInput.value || 'é–‹å§‹å°è¦½';
            const trigger = triggerKeywordInput.value || 'é¸å–®';
            
            let flowMapStr = "";
            if(currentMode === 'flow') {
                flowData.forEach(step => {
                    if(!step.imageUrl) return;
                    const json = generateImagemapJson(step);
                    flowMapStr += `  "${step.trigger}": ${JSON.stringify(json, null, 2)},\n`;
                });
            } else if (currentMode === 'imagemap' && imagemapData.imageUrl) {
                const json = generateImagemapJson(imagemapData);
                flowMapStr = `  "${trigger}": ${JSON.stringify(json, null, 2)}`;
            } else if (currentMode === 'carousel' && carouselCards[0].imageUrl) {
                const json = generateFlexCarouselJson(carouselCards);
                flowMapStr = `  "${trigger}": ${JSON.stringify(json, null, 2)}`;
            }

            const code = `const CHANNEL_ACCESS_TOKEN = 'è«‹æ›æˆä½ çš„LINE_TOKEN'; 

// è‡ªå‹•ç”Ÿæˆçš„æµç¨‹åœ°åœ– (åŒ…å«æ‚¨è¨­å®šçš„æ‰€æœ‰åœ–ç‰‡èˆ‡é—œéµå­—)
const flowMap = {
${flowMapStr}
};

function doPost(e) {
  let replyToken = "", userMessage = "";
  try {
    const msg = JSON.parse(e.postData.contents);
    replyToken = msg.events[0].replyToken;
    userMessage = msg.events[0].message.text;
  } catch (error) { return ContentService.createTextOutput(""); }

  // æ ¸å¿ƒé‚è¼¯ï¼šæª¢æŸ¥ç”¨æˆ¶è¨Šæ¯æ˜¯å¦ç¬¦åˆæˆ‘å€‘è¨­å®šçš„ä»»ä½•é—œéµå­—
  if (flowMap[userMessage]) {
    replyMessage(replyToken, flowMap[userMessage]);
  }
  
  return ContentService.createTextOutput(JSON.stringify({'content': 'post ok'})).setMimeType(ContentService.MimeType.JSON);
}

function replyMessage(replyToken, messageJson) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    'headers': { 'Content-Type': 'application/json; charset=UTF-8', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post',
    'payload': JSON.stringify({ 'replyToken': replyToken, 'messages': [messageJson] }),
  });
}`;
            document.getElementById('gasCode').innerText = code;
        }

        function downloadJSON() {
            if (currentMode === 'flow') { alert("æµç¨‹æ¨¡å¼è«‹ç›´æ¥è¤‡è£½ã€Œæ•™å­¸èˆ‡ä»£ç¢¼ã€ä¸­çš„å®Œæ•´ç¨‹å¼ç¢¼ï¼Œç„¡éœ€ä¸‹è¼‰ JSONã€‚"); return; }
            let output = {};
            if (currentMode === 'imagemap') {
                if (!imagemapData.imageUrl) { alert("è«‹å¡«å¯«åœ–ç‰‡ç¶²å€"); return; }
                output = generateImagemapJson(imagemapData);
            } else {
                if (carouselCards.some(c => !c.imageUrl)) { alert("è«‹ç¢ºä¿æ‰€æœ‰å¡ç‰‡éƒ½æœ‰åœ–ç‰‡ç¶²å€"); return; }
                output = generateFlexCarouselJson(carouselCards);
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(output, null, 2));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `${currentMode}_settings.json`); dl.click();
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); if(id==='tutorialModal') updateGasCode(); }
        function copyCode() { navigator.clipboard.writeText(document.getElementById('gasCode').innerText); alert('è¤‡è£½æˆåŠŸï¼'); }
    </script>
</body>
</html>
