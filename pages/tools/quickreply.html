<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç´…è‰²æ¡†æ¡†æŒ‰éˆ•è¨­å®šï¼ˆQuick Replyï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4 text-slate-800">
  <div class="bg-white w-full max-w-lg rounded-xl shadow-lg overflow-hidden">
    <div class="bg-red-600 p-4 text-white flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2">
        <a href="index.html" class="opacity-80 hover:opacity-100">ğŸ”™</a>
        ç´…è‰²æ¡†æ¡†è¨­å®šå™¨ï¼ˆQuick Replyï¼‰
      </h1>
    </div>

    <div class="p-6 space-y-6">
      <!-- Worker URL -->
      <div class="bg-slate-100 p-4 rounded-lg">
        <label class="block text-xs font-bold text-slate-500 mb-1">Worker ç¶²å€</label>
        <input type="text" id="workerUrl"
               class="w-full border p-2 rounded text-sm bg-white text-gray-600"
               readonly>
        <div class="text-[11px] text-slate-500 mt-2">
          æé†’ï¼šè·¨è¨­å‚™åŒæ­¥é  Worker KVï¼Œæ›é›»è…¦åªè¦è¼¸å…¥ç›¸åŒ Worker URL å°±èƒ½è®€åˆ°åŒä¸€ä»½è³‡æ–™ã€‚
        </div>
      </div>

      <!-- keyword -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">æœ¬é¸å–®çš„è§¸ç™¼é—œéµå­—ï¼ˆä½¿ç”¨è€…è¼¸å…¥é€™å¥æœƒè·³å‡ºç´…æ¡†ï¼‰</label>
          <div class="flex gap-2">
            <input type="text" id="keyword" placeholder="ä¾‹å¦‚ï¼šé¸å–®"
                   class="flex-1 border-2 border-red-200 rounded p-2 focus:border-red-500 outline-none font-bold">
            <button onclick="loadData()"
                    class="bg-gray-600 text-white px-4 rounded text-sm font-bold hover:bg-gray-700">
              è®€å–
            </button>
          </div>
          <div class="text-[11px] text-slate-500 mt-2">
            ä¾‹ï¼šä½ å­˜ keyword=ã€Œé¸å–®ã€ï¼Œä½¿ç”¨è€…åœ¨ LINE è¼¸å…¥ã€Œé¸å–®ã€å°±æœƒæ”¶åˆ°ä½ è¨­å®šçš„æ–‡å­— + åº•éƒ¨ç´…æ¡†æŒ‰éˆ•ã€‚
          </div>
        </div>

        <!-- reply text -->
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">æ©Ÿå™¨äººå›è¦†æ–‡å­—</label>
          <textarea id="replyText" rows="2"
                    class="w-full border rounded p-2 text-sm"
                    placeholder="ä¾‹å¦‚ï¼šè«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™..."></textarea>
        </div>

        <!-- meta -->
        <div class="bg-slate-50 border rounded-lg p-4 space-y-3">
          <div class="font-bold text-slate-700">åˆ†é¡è³‡è¨Šï¼ˆå¯¦é©—å®¤ç¯©é¸ç”¨ï¼‰</div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1">ç‹€æ…‹</label>
              <select id="metaStatus" class="w-full border rounded p-2 text-sm">
                <option value="active">activeï¼ˆæ­£å¼ä½¿ç”¨ï¼‰</option>
                <option value="testing">testingï¼ˆæ¸¬è©¦ä¸­ï¼‰</option>
                <option value="deprecated">deprecatedï¼ˆå·²æ£„ç”¨ï¼‰</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1">å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
              <input id="metaNote" class="w-full border rounded p-2 text-sm"
                     placeholder="ä¾‹å¦‚ï¼šä¸»é¸å–®/å¥åº·å¼•æµ/ç”¢å“ä»‹ç´¹...">
            </div>
          </div>

          <div class="text-[11px] text-slate-500">
            feature æœƒå›ºå®šå¯«æˆ <span class="font-bold">quickreply</span>ï¼Œç”¨æ–¼å¯¦é©—å®¤ã€ŒåŠŸèƒ½ç¯©é¸ã€ã€‚
          </div>
        </div>

        <!-- Buttons list -->
        <div class="border-t pt-4">
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-bold text-red-600">ğŸ”´ ç´…è‰²æ¡†æ¡†æŒ‰éˆ•åˆ—è¡¨</label>
            <button onclick="addBtn()"
                    class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 font-bold">
              + æ–°å¢æŒ‰éˆ•
            </button>
          </div>

          <div class="text-[11px] text-slate-500 mb-2">
            ä½ åªè¦è¨­å®šï¼š<span class="font-bold">æŒ‰éˆ•å</span>ï¼ˆé¡¯ç¤ºåœ¨ç´…æ¡†ï¼‰ï¼‹
            <span class="font-bold">è§¸ç™¼</span>ï¼ˆæŒ‰ä¸‹å»é€å‡ºçš„æ–‡å­—/é—œéµå­—ï¼‰ã€‚
          </div>

          <div id="btnList" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>
      </div>

      <button onclick="saveData()"
              class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-md transition transform active:scale-95">
        ğŸ’¾ å„²å­˜è¨­å®š
      </button>
    </div>
  </div>

<script>
  window.onload = function () {
    const savedUrl = localStorage.getItem('line_worker_url');
    if (savedUrl) {
      document.getElementById('workerUrl').value = savedUrl.trim().replace(/\/+$/, '');
    } else {
      alert("è«‹å…ˆå›é¦–é  (index.html) è¼¸å…¥ Worker ç¶²å€ï¼");
    }
    addBtn(); // é è¨­çµ¦ä¸€å€‹æŒ‰éˆ•åˆ—
  };

  function addBtn(label = '', text = '') {
    const list = document.getElementById('btnList');
    const div = document.createElement('div');
    div.className = "flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200";
    div.innerHTML = `
      <div class="flex-1 space-y-1">
        <div class="flex items-center gap-2">
          <span class="text-xs font-bold text-gray-500 w-12">æŒ‰éˆ•å:</span>
          <input type="text" placeholder="é¡¯ç¤ºæ–‡å­—" value="${escapeHtmlAttr(label)}"
                 class="btn-label flex-1 border rounded px-2 py-1 text-sm focus:border-red-400 outline-none">
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs font-bold text-red-500 w-12">è§¸ç™¼:</span>
          <input type="text" placeholder="ç™¼é€å…§å®¹ï¼ˆé—œéµå­—ï¼‰" value="${escapeHtmlAttr(text)}"
                 class="btn-text flex-1 border rounded px-2 py-1 text-sm focus:border-red-400 outline-none bg-red-50">
        </div>
      </div>
      <button onclick="this.parentElement.remove()"
              class="text-slate-400 hover:text-red-500 px-2 font-bold text-lg">âœ•</button>
    `;
    list.appendChild(div);
  }

  function getWorkerUrlOrAlert() {
    const url = (document.getElementById('workerUrl').value || '').trim().replace(/\/+$/, '');
    if (!url) {
      alert("è«‹å…ˆå›é¦–é è¼¸å…¥ Worker ç¶²å€");
      return null;
    }
    return url;
  }

  async function saveData() {
    const url = getWorkerUrlOrAlert(); if(!url) return;
    const key = (document.getElementById('keyword').value || '').trim();
    const replyText = (document.getElementById('replyText').value || '').trim();
    const status = (document.getElementById('metaStatus').value || 'active').trim();
    const note = (document.getElementById('metaNote').value || '').trim();

    if (!key) return alert("è«‹è¼¸å…¥è§¸ç™¼é—œéµå­—ï¼ˆkeywordï¼‰");

    const btns = [];
    document.querySelectorAll('#btnList > div').forEach(div => {
      const l = (div.querySelector('.btn-label').value || '').trim();
      const t = (div.querySelector('.btn-text').value || '').trim();
      if (l && t) btns.push({ label: l, text: t });
    });

    if (btns.length === 0) {
      return alert("è‡³å°‘æ–°å¢ä¸€å€‹æŒ‰éˆ•ï¼ˆæŒ‰éˆ•åï¼‹è§¸ç™¼ï¼‰");
    }

    // âœ… payloadï¼šä½ çš„ quickreply å·¥å…·æ ¼å¼ï¼ˆé…åˆ worker.js æœƒè½‰æˆ LINE quickReply.itemsï¼‰
    const payload = {
      meta: {
        feature: "quickreply",
        status,
        createdFrom: "tool_quickreply",
        note,
        updatedAt: Date.now()
      },
      mode: "text",
      replyText: replyText || "è«‹é¸æ“‡ï¼š",
      quickReplies: btns
    };

    try {
      const res = await fetch(url + '/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword: key, payload })
      });
      const out = await res.json().catch(()=>null);

      if (res.ok && out && out.ok !== false) {
        alert('å„²å­˜æˆåŠŸï¼');
      } else {
        alert('å„²å­˜å¤±æ•—ï¼š' + (out?.error || res.status));
      }
    } catch (e) {
      alert('é€£ç·šéŒ¯èª¤ï¼š' + (e.message || e));
    }
  }

  async function loadData() {
    const url = getWorkerUrlOrAlert(); if(!url) return;
    const key = (document.getElementById('keyword').value || '').trim();
    if (!key) return alert("è«‹è¼¸å…¥é—œéµå­—");

    try {
      const res = await fetch(url + '/load', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword: key })
      });
      const data = await res.json().catch(()=>null);

      if (res.ok && data) {
        // æ”¯æ´ worker.js å¯èƒ½å›ä¾†æ•´å€‹ payload / æˆ–ç›´æ¥ payload
        const payload = data.payload ? data.payload : data;

        document.getElementById('replyText').value = payload.replyText || '';

        // meta
        const m = payload.meta || {};
        document.getElementById('metaStatus').value = m.status || 'active';
        document.getElementById('metaNote').value = m.note || '';

        // buttons
        document.getElementById('btnList').innerHTML = '';
        if (Array.isArray(payload.quickReplies) && payload.quickReplies.length) {
          payload.quickReplies.forEach(b => addBtn(b.label, b.text));
        } else {
          addBtn();
        }

        alert('è®€å–æˆåŠŸ');
      } else {
        alert('æ‰¾ä¸åˆ°æ­¤é—œéµå­—');
      }
    } catch (e) {
      alert('é€£ç·šéŒ¯èª¤ï¼š' + (e.message || e));
    }
  }

  function escapeHtmlAttr(str){
    return String(str ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }
</script>
</body>
</html>
