<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¼•æµåœ–ç·¨è¼¯å™¨ (R2 å°ºå¯¸æ¨¡å¼ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .area-box{
      position:absolute;
      border:2px solid rgba(255,0,0,.85);
      background:rgba(255,0,0,.22);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:800;
      font-size:14px;
      text-shadow:0 1px 2px rgba(0,0,0,.9);
      user-select:none;
    }
    .draw-rect{
      position:absolute;
      border:2px dashed rgba(0,0,0,.6);
      background:rgba(0,0,0,.10);
      pointer-events:none;
    }

    /* âœ… è®“å³å´ç•«å¸ƒæ›´åƒã€Œç·¨è¼¯å™¨ã€ï¼šå›ºå®šé«˜åº¦ã€å¯æ²å‹• */
    .editor-h {
      height: calc(100vh - 88px); /* æœƒè¢« JS å‹•æ…‹æ›´æ–°æ›´ç²¾æº– */
    }

    /* âœ… åœ–ç‰‡ç¸®æ”¾å®¹å™¨ï¼šç”¨ transform scale */
    #stage {
      position: relative;
      transform-origin: top left;
    }
    #drawLayer {
      position: absolute;
      inset: 0;
      cursor: crosshair;
      touch-action: none; /* âœ… pointer ç•«æ¡†æ™‚ä¸è¢«æ²å‹•/ç¸®æ”¾å¹²æ“¾ */
    }
  </style>
</head>

<body class="bg-slate-100 h-screen flex flex-col text-slate-800">

  <!-- âœ… Top barï¼ˆå¯æŠ˜ç–Šï¼Œç¸®å°å ç”¨ï¼‰ -->
  <div id="topBar" class="bg-white shadow z-10">
    <div class="p-3 flex flex-wrap gap-2 items-center justify-between">
      <div class="flex items-center gap-2">
        <a href="index.html" class="text-2xl hover:bg-slate-100 rounded px-2 py-1">ğŸ”™</a>
        <div class="font-black text-lg text-blue-600">å¼•æµåœ–ç·¨è¼¯å™¨</div>

        <button id="toggleBarBtn"
          class="ml-2 text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 font-bold">
          æ”¶åˆ
        </button>
      </div>

      <div class="flex flex-wrap gap-2 items-center">
        <input type="text" id="workerUrl" placeholder="https://xxxx.workers.dev"
          class="border rounded px-2 py-2 text-sm w-56 bg-yellow-50">
        <input type="text" id="triggerKeyword" placeholder="æœ¬åœ–é—œéµå­—ï¼ˆå¯ä¸å¡«ï¼‰"
          class="border rounded px-2 py-2 text-sm font-bold w-44 border-blue-500">

        <button onclick="loadSettingsUI()"
          class="bg-gray-500 text-white px-3 py-2 rounded text-sm hover:bg-gray-600 font-bold">è®€å–</button>

        <button onclick="saveSettingsUI(false)"
          class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 font-bold">å„²å­˜</button>

        <button onclick="saveSettingsUI(true)"
          class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 font-bold">å¦å­˜æ–°æª”</button>
      </div>
    </div>

    <!-- âœ… å¯æŠ˜ç–Šå€ -->
    <div id="topBarBody" class="px-3 pb-3">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
        <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
          <strong>imagemap å»ºè­°ï¼š</strong><br>
          - å¸¸è¦‹æ˜¯æ­£æ–¹å½¢é¢¨æ ¼ï¼ˆå¯å‹¾ã€Œè£åˆ‡æ­£æ–¹å½¢ã€ï¼‰<br>
          - ç†±å€ä¸é™æ•¸é‡ï¼Œå³å´é€ä¸€å¡«å…§å®¹<br>
          - âœ… ä½ ç¾åœ¨å¯ä»¥ç”¨ç¸®æ”¾æ›´å¥½ç•«æ¡†<br>
          - âœ… é—œéµå­—å¯ä¸å¡«ï¼šä¸å¡«æœƒå­˜åœ¨æœ¬æ©Ÿè‰ç¨¿
        </div>

        <!-- âœ… Zoom æ§åˆ¶ -->
        <div class="bg-slate-50 border rounded p-2">
          <div class="flex items-center justify-between">
            <div class="text-xs font-bold text-slate-600">ğŸ” åœ–ç‰‡ç¸®æ”¾</div>
            <div class="text-[11px] text-slate-500">æ»¾è¼ª + Ctrl/Alt/Shift</div>
          </div>

          <div class="mt-2 flex items-center gap-2">
            <input id="zoomRange" type="range" min="0.5" max="3" step="0.01" value="1" class="w-full">
            <div class="text-xs font-black w-14 text-right" id="zoomLabel">100%</div>
          </div>

          <div class="mt-2 flex gap-2">
            <button class="text-xs bg-slate-900 text-white px-3 py-2 rounded hover:bg-black font-bold"
                    onclick="setZoom(1)">100%</button>
            <button class="text-xs bg-slate-100 px-3 py-2 rounded hover:bg-slate-200 font-bold"
                    onclick="setZoom(0.75)">75%</button>
            <button class="text-xs bg-slate-100 px-3 py-2 rounded hover:bg-slate-200 font-bold"
                    onclick="setZoom(1.5)">150%</button>
          </div>
        </div>

        <!-- âœ… å£“ç¸®/è£åˆ‡ -->
        <div class="bg-slate-50 border rounded p-2">
          <div class="font-bold text-xs text-slate-600 mb-2">åœ–ç‰‡å°ºå¯¸/å£“ç¸®ï¼ˆä¸Šå‚³æ™‚ç”Ÿæ•ˆï¼‰</div>

          <div class="grid grid-cols-2 gap-2 text-xs">
            <label class="flex flex-col gap-1 col-span-2">
              <span class="text-slate-500">å°ºå¯¸æ¨¡å¼</span>
              <select id="sizeMode" class="border rounded px-2 py-1">
                <option value="line">LINE å»ºè­°ï¼ˆé•·é‚Š 1280ï¼‰</option>
                <option value="hd">æ¸…æ™°ï¼ˆé•·é‚Š 1600ï¼‰</option>
                <option value="small">çœç©ºé–“ï¼ˆé•·é‚Š 960ï¼‰</option>
                <option value="custom">è‡ªé¸å°ºå¯¸ï¼ˆå¯¬/é«˜ä¸Šé™ï¼‰</option>
              </select>
            </label>

            <label id="customWWrap" class="flex flex-col gap-1 hidden">
              <span class="text-slate-500">æœ€å¤§å¯¬(px)</span>
              <input id="customW" type="number" value="1280" min="320" max="4096" class="border rounded px-2 py-1">
            </label>
            <label id="customHWrap" class="flex flex-col gap-1 hidden">
              <span class="text-slate-500">æœ€å¤§é«˜(px)</span>
              <input id="customH" type="number" value="1280" min="320" max="4096" class="border rounded px-2 py-1">
            </label>

            <label class="flex flex-col gap-1">
              <span class="text-slate-500">æ ¼å¼</span>
              <select id="outFormat" class="border rounded px-2 py-1">
                <option value="image/webp" selected>WebPï¼ˆæ¨è–¦ï¼‰</option>
                <option value="image/jpeg">JPEG</option>
                <option value="image/png">PNGï¼ˆä¸å»ºè­°ï¼‰</option>
              </select>
            </label>

            <label class="flex flex-col gap-1">
              <span class="text-slate-500">å“è³ª</span>
              <input id="quality" type="range" min="0.55" max="0.95" step="0.01" value="0.82">
              <div class="text-right text-[11px] text-slate-500">ç›®å‰ï¼š<span id="qVal">0.82</span></div>
            </label>

            <label class="flex items-center gap-2 col-span-2 mt-1">
              <input id="cropSquare" type="checkbox" class="scale-110">
              <span class="text-slate-600">è£åˆ‡æˆæ­£æ–¹å½¢ï¼ˆimagemap å¸¸ç”¨ï¼‰</span>
            </label>

            <div class="col-span-2 text-[11px] text-slate-500">
              * ä¸Šå‚³æ™‚æœƒå†è‡ªå‹•é™åˆ¶ï¼šé•·å¯¬ä¸è¶…éä½ ç›®å‰è¢å¹•å¯è¦–å¤§å°
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… ä¸»ç·¨è¼¯å€ -->
  <div class="flex flex-1 overflow-hidden w-full editor-h" id="mainArea">
    <!-- å·¦é‚Šï¼šåœ–ç‰‡æ¸…å–® -->
    <div class="w-72 bg-white border-r overflow-y-auto p-4 flex flex-col gap-4">
      <button onclick="addImageBlock()"
        class="w-full py-3 border-2 border-dashed border-blue-300 text-blue-500 rounded font-bold hover:bg-blue-50">
        + æ–°å¢åœ–ç‰‡
      </button>

      <div id="imageList" class="space-y-4"></div>
    </div>

    <!-- å³é‚Šï¼šç•«å¸ƒ -->
    <div class="flex-1 bg-slate-200 relative overflow-auto flex justify-center p-4">
      <div id="editorWrap" class="hidden w-full max-w-6xl grid grid-cols-1 xl:grid-cols-[380px_1fr] gap-4">
        <!-- æ¡†æ¡†è¨­å®š -->
        <div class="bg-white rounded-lg shadow p-4 h-fit">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold text-slate-700">æ¡†æ¡†è¨­å®š</div>
            <button onclick="clearAreas()" class="text-xs text-red-600 underline">æ¸…ç©ºæœ¬åœ–å…¨éƒ¨æ¡†</button>
          </div>
          <div id="areaList" class="space-y-2"></div>
        </div>

        <!-- ç•«å¸ƒå€ -->
        <div class="bg-white shadow-lg relative rounded overflow-hidden">
          <div class="p-2 bg-slate-50 border-b flex items-center justify-between">
            <div class="text-xs text-slate-600">
              âœ… æ‹–æ›³ç•«æ¡†ï¼Œé»ç´…æ¡†åˆªé™¤ã€‚ç¸®æ”¾ä¸å½±éŸ¿åº§æ¨™ã€‚
            </div>
            <button onclick="triggerUpload(currentImgIndex, this)"
              class="bg-black/70 text-white text-xs px-3 py-2 rounded font-bold hover:bg-black">
              ğŸ“· ä¸Šå‚³åˆ° R2ï¼ˆå£“ç¸®ï¼‰
            </button>
          </div>

          <div class="relative overflow-auto bg-gray-100" style="height: calc(100% - 44px);">
            <div id="stage" class="inline-block">
              <img id="previewImage" class="block pointer-events-none select-none"
                   style="max-width:none; display:block;">
              <div id="drawLayer"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="emptyState" class="text-slate-400 mt-20 flex flex-col items-center">
        <span class="text-6xl mb-4">ğŸ‘ˆ</span><span>è«‹å¾å·¦å´æ–°å¢åœ–ç‰‡</span>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" class="hidden">

<script>
/* ---------- UI ç¶å®š ---------- */
const sizeModeEl = document.getElementById('sizeMode');
const customWWrap = document.getElementById('customWWrap');
const customHWrap = document.getElementById('customHWrap');
sizeModeEl.addEventListener('change', () => {
  const show = (sizeModeEl.value === 'custom');
  customWWrap.classList.toggle('hidden', !show);
  customHWrap.classList.toggle('hidden', !show);
});

const q = document.getElementById('quality');
const qVal = document.getElementById('qVal');
q.addEventListener('input', () => qVal.textContent = q.value);

/* ---------- Top bar æŠ˜ç–Š & é«˜åº¦åŒæ­¥ ---------- */
const toggleBarBtn = document.getElementById('toggleBarBtn');
const topBarBody = document.getElementById('topBarBody');
const topBar = document.getElementById('topBar');
const mainArea = document.getElementById('mainArea');

let barCollapsed = false;
toggleBarBtn.onclick = () => {
  barCollapsed = !barCollapsed;
  topBarBody.classList.toggle('hidden', barCollapsed);
  toggleBarBtn.textContent = barCollapsed ? 'å±•é–‹' : 'æ”¶åˆ';
  syncEditorHeight();
};
function syncEditorHeight(){
  const h = topBar.getBoundingClientRect().height;
  mainArea.style.height = `calc(100vh - ${Math.ceil(h)}px)`;
}
window.addEventListener('resize', syncEditorHeight);

/* ---------- Zoom ---------- */
let ZOOM = 1;
const zoomRange = document.getElementById('zoomRange');
const zoomLabel = document.getElementById('zoomLabel');
const stage = document.getElementById('stage');

function setZoom(v){
  ZOOM = Math.max(0.5, Math.min(3, Number(v) || 1));
  stage.style.transform = `scale(${ZOOM})`;
  zoomRange.value = String(ZOOM);
  zoomLabel.textContent = Math.round(ZOOM * 100) + '%';
  refreshLayerSize();
}
zoomRange.addEventListener('input', () => setZoom(zoomRange.value));

/* æ»¾è¼ªç¸®æ”¾ï¼šæŒ‰ Ctrl/Alt/Shift ä»»ä¸€éµï¼ˆåœ¨ç•«å¸ƒå®¹å™¨ä¸Šç›£è½ï¼‰ */
stage.parentElement?.addEventListener('wheel', (e) => {
  if(!(e.ctrlKey || e.altKey || e.shiftKey)) return;
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.08 : 0.08;
  setZoom((ZOOM + delta).toFixed(2));
}, { passive:false });

/* ---------- å…±ç”¨å·¥å…· ---------- */
function normalizeWorkerUrl(raw){
  if(!raw) return '';
  let s = raw.trim();
  if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
  return s.replace(/\/+$/,'');
}
async function postJSON(url, data){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status} ${res.statusText}\n${txt}`);
  }
  const ct = res.headers.get('content-type') || '';
  if(ct.includes('application/json')) return await res.json();
  return await res.text();
}
async function uploadToR2(workerBaseUrl, fileBlob, filename){
  const form = new FormData();
  form.append('file', fileBlob, filename || 'image.webp');
  const res = await fetch(workerBaseUrl + '/upload', { method:'POST', body: form });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}\n${t}`);
  }
  const j = await res.json();
  if(!j.ok || !j.url) throw new Error('ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°');
  return j.url;
}
function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* ---------- å°ºå¯¸ä¸Šé™ï¼ˆå«å¯è¦–é™åˆ¶ï¼‰ ---------- */
function getTargetMaxWH(){
  const mode = document.getElementById('sizeMode').value;
  let maxW = 1280, maxH = 1280;

  if(mode === 'line'){ maxW = 1280; maxH = 1280; }
  if(mode === 'hd'){ maxW = 1600; maxH = 1600; }
  if(mode === 'small'){ maxW = 960; maxH = 960; }
  if(mode === 'custom'){
    maxW = parseInt(document.getElementById('customW').value || '1280', 10);
    maxH = parseInt(document.getElementById('customH').value || '1280', 10);
  }

  const dpr = window.devicePixelRatio || 1;
  const preview = document.getElementById('previewImage');
  const vw = Math.max(320, Math.floor((preview.clientWidth || 1280) * dpr));
  const vh = Math.max(320, Math.floor((preview.clientHeight || 1280) * dpr));
  maxW = Math.min(maxW, vw);
  maxH = Math.min(maxH, vh);

  return { maxW, maxH };
}

/* ---------- å£“ç¸®/è£åˆ‡ ---------- */
async function compressImage(file, {maxW, maxH, mime, quality, cropSquare}){
  const img = await createImageBitmap(file);

  let sx = 0, sy = 0, sw = img.width, sh = img.height;
  if(cropSquare){
    const side = Math.min(img.width, img.height);
    sx = Math.floor((img.width - side) / 2);
    sy = Math.floor((img.height - side) / 2);
    sw = side; sh = side;
  }

  const scale = Math.min(1, maxW / sw, maxH / sh);
  const w = Math.max(1, Math.round(sw * scale));
  const h = Math.max(1, Math.round(sh * scale));

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d', { alpha: true });
  ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);

  const outBlob = await new Promise((resolve) => {
    if(mime === 'image/png') canvas.toBlob(resolve, mime);
    else canvas.toBlob(resolve, mime, quality);
  });
  if(!outBlob) throw new Error('å£“ç¸®å¤±æ•—ï¼ˆtoBlob ç©ºï¼‰');

  const ext = (mime === 'image/webp') ? 'webp' : (mime === 'image/jpeg') ? 'jpg' : 'png';
  const safeName = (file.name || 'image').replace(/\.[^/.]+$/, '');
  return { blob: outBlob, filename: `${safeName}.${ext}`, w, h };
}

/* ---------- state ---------- */
let images = []; // {url:'', areas:[{x,y,w,h,type,text}]} çš† 0~1
let currentImgIndex = -1;

window.onload = () => {
  const savedUrl = localStorage.getItem('line_worker_url');
  if(savedUrl) document.getElementById('workerUrl').value = savedUrl;

  // âœ… è‹¥æœ¬æ©Ÿæœ‰è‰ç¨¿ï¼Œæç¤ºå¯è®€å–
  syncEditorHeight();
  setZoom(1);
};

/* ---------- list ---------- */
function addImageBlock(){
  images.push({ url:'', areas:[] });
  renderImageList();
  selectImage(images.length - 1);
}
function renderImageList(){
  const list = document.getElementById('imageList');
  list.innerHTML = '';
  images.forEach((img, idx) => {
    const div = document.createElement('div');
    div.className = `p-2 border rounded ${idx === currentImgIndex ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} cursor-pointer`;
    div.innerHTML = `
      <div class="flex justify-between mb-2">
        <span class="font-bold text-xs">åœ–ç‰‡ ${idx+1}</span>
        <button class="text-red-500 text-xs" onclick="event.stopPropagation();removeImage(${idx});">âœ•</button>
      </div>
      ${img.url ? `<img src="${img.url}" class="w-full h-24 object-cover rounded mb-2 border">`
               : `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-xs text-gray-400 rounded mb-2 border">ç„¡åœ–ç‰‡</div>`}
      <button class="w-full bg-blue-600 text-white text-xs py-2 rounded hover:bg-blue-700 font-bold"
        onclick="event.stopPropagation();triggerUpload(${idx}, this);">
        ä¸Šå‚³åˆ° R2ï¼ˆå£“ç¸®ï¼‰
      </button>
      <div class="mt-1 text-[10px] text-gray-500 text-right">ç†±å€: ${img.areas.length}</div>
    `;
    div.onclick = () => selectImage(idx);
    list.appendChild(div);
  });
}
function removeImage(idx){
  images.splice(idx, 1);
  renderImageList();
  selectImage(images.length ? Math.min(idx, images.length-1) : -1);
}
function selectImage(idx){
  currentImgIndex = idx;
  const wrap = document.getElementById('editorWrap');
  const empty = document.getElementById('emptyState');

  if(idx === -1 || !images[idx]){
    wrap.classList.add('hidden');
    empty.classList.remove('hidden');
    return;
  }
  wrap.classList.remove('hidden');
  empty.classList.add('hidden');

  const imgEl = document.getElementById('previewImage');
  imgEl.src = images[idx].url || '';
  imgEl.onload = () => {
    refreshLayerSize();
    renderAreas();
  };
  renderAreas();
  renderAreaList();
}
function clearAreas(){
  if(currentImgIndex < 0) return;
  if(confirm('ç¢ºå®šæ¸…ç©ºæœ¬åœ–å…¨éƒ¨æ¡†ï¼Ÿ')){
    images[currentImgIndex].areas = [];
    renderAreas(); renderAreaList(); renderImageList();
  }
}

/* ---------- layer size sync ---------- */
const layer = document.getElementById('drawLayer');
function refreshLayerSize(){
  const imgEl = document.getElementById('previewImage');
  const w = imgEl.naturalWidth || imgEl.clientWidth || 0;
  const h = imgEl.naturalHeight || imgEl.clientHeight || 0;
  if(w && h){
    imgEl.style.width = w + 'px';
    imgEl.style.height = h + 'px';
    layer.style.width = w + 'px';
    layer.style.height = h + 'px';
  }
}

/* ---------- upload ---------- */
async function triggerUpload(idx, btn){
  const raw = document.getElementById('workerUrl').value;
  const base = normalizeWorkerUrl(raw);
  if(!base) return alert('è«‹å…ˆå¡« WorkerUrl');
  localStorage.setItem('line_worker_url', base);

  const input = document.getElementById('fileInput');
  input.value = '';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    const oldText = btn.innerText;
    btn.innerText = "â³ å£“ç¸®+ä¸Šå‚³ä¸­...";
    btn.disabled = true;

    try{
      const mime = document.getElementById('outFormat').value;
      const quality = parseFloat(document.getElementById('quality').value);
      const cropSquare = document.getElementById('cropSquare').checked;
      const { maxW, maxH } = getTargetMaxWH();

      const { blob, filename } = await compressImage(file, { maxW, maxH, mime, quality, cropSquare });
      const url = await uploadToR2(base, blob, filename);

      images[idx].url = url;
      images[idx].areas = [];
      renderImageList();
      selectImage(idx);
      setZoom(1);
    }catch(err){
      alert('ä¸Šå‚³å¤±æ•—ï¼š\n' + err.message);
    }

    btn.innerText = oldText;
    btn.disabled = false;
  };
  input.click();
}

/* ---------- drawï¼ˆâœ… pointer ç‰ˆï¼šä¸å¡ä½ï¼‰ ---------- */
let isDrawing = false;
let sx = 0, sy = 0;
let previewRect = null;
let activePointerId = null;

function getLayerPointFromClient(clientX, clientY){
  const rect = layer.getBoundingClientRect();
  const x = (clientX - rect.left) / ZOOM;
  const y = (clientY - rect.top) / ZOOM;
  return { x, y };
}

function startDrawAt(clientX, clientY){
  const p = getLayerPointFromClient(clientX, clientY);
  sx = p.x; sy = p.y;

  previewRect = document.createElement('div');
  previewRect.className = 'draw-rect';
  previewRect.style.left = sx + 'px';
  previewRect.style.top = sy + 'px';
  previewRect.style.width = '0px';
  previewRect.style.height = '0px';
  layer.appendChild(previewRect);
}
function moveDrawTo(clientX, clientY){
  if(!isDrawing || !previewRect) return;
  const p = getLayerPointFromClient(clientX, clientY);
  const cx = p.x, cy = p.y;

  const x = Math.min(sx, cx);
  const y = Math.min(sy, cy);
  const w = Math.abs(cx - sx);
  const h = Math.abs(cy - sy);

  previewRect.style.left = x + 'px';
  previewRect.style.top = y + 'px';
  previewRect.style.width = w + 'px';
  previewRect.style.height = h + 'px';
}
function endDrawAt(clientX, clientY){
  if(!isDrawing) return;
  isDrawing = false;

  const p = getLayerPointFromClient(clientX, clientY);
  const ex = p.x, ey = p.y;

  const x = Math.min(sx, ex);
  const y = Math.min(sy, ey);
  const w = Math.abs(ex - sx);
  const h = Math.abs(ey - sy);

  if(previewRect){ previewRect.remove(); previewRect = null; }
  activePointerId = null;

  if(w < 14 || h < 14) return;

  const baseW = layer.clientWidth;
  const baseH = layer.clientHeight;

  images[currentImgIndex].areas.push({
    x: x / baseW, y: y / baseH,
    w: w / baseW, h: h / baseH,
    type: 'message', text: ''
  });

  renderAreas();
  renderAreaList();
  renderImageList();
}

layer.addEventListener('pointerdown', (e) => {
  if(currentImgIndex < 0) return;
  if(!images[currentImgIndex].url) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼ˆR2ï¼‰å†ç•«æ¡†');
  if(e.button !== 0) return;

  isDrawing = true;
  activePointerId = e.pointerId;
  layer.setPointerCapture(activePointerId);

  startDrawAt(e.clientX, e.clientY);
  e.preventDefault();
});
layer.addEventListener('pointermove', (e) => {
  if(!isDrawing) return;
  if(activePointerId !== null && e.pointerId !== activePointerId) return;
  moveDrawTo(e.clientX, e.clientY);
  e.preventDefault();
});
layer.addEventListener('pointerup', (e) => {
  if(activePointerId !== null && e.pointerId !== activePointerId) return;
  endDrawAt(e.clientX, e.clientY);
  e.preventDefault();
});
layer.addEventListener('pointercancel', () => {
  if(previewRect){ previewRect.remove(); previewRect = null; }
  isDrawing = false;
  activePointerId = null;
});
window.addEventListener('blur', () => {
  if(previewRect){ previewRect.remove(); previewRect = null; }
  isDrawing = false;
  activePointerId = null;
});

/* ---------- areas render ---------- */
function renderAreas(){
  layer.querySelectorAll('.area-box').forEach(el => el.remove());
  if(currentImgIndex < 0) return;

  images[currentImgIndex].areas.forEach((a, i) => {
    const d = document.createElement('div');
    d.className = 'area-box';
    d.style.left = (a.x*100)+'%';
    d.style.top  = (a.y*100)+'%';
    d.style.width  = (a.w*100)+'%';
    d.style.height = (a.h*100)+'%';
    d.innerText = i+1;

    d.onclick = (e) => {
      e.stopPropagation();
      if(confirm(`åˆªé™¤å€åŸŸ ${i+1}?`)){
        images[currentImgIndex].areas.splice(i, 1);
        renderAreas(); renderAreaList(); renderImageList();
      }
    };

    layer.appendChild(d);
  });
}

/* ---------- area list ---------- */
function renderAreaList(){
  const box = document.getElementById('areaList');
  box.innerHTML = '';
  if(currentImgIndex < 0) return;

  const areas = images[currentImgIndex].areas;
  if(areas.length === 0){
    box.innerHTML = `<div class="text-xs text-slate-400">ç›®å‰æ²’æœ‰æ¡†ï¼Œå»åœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†ã€‚</div>`;
    return;
  }

  areas.forEach((a, i) => {
    const row = document.createElement('div');
    row.className = 'border rounded p-2 bg-white';
    row.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold text-sm">æ¡† ${i+1}</div>
        <button class="text-xs text-red-600 underline">åˆªé™¤</button>
      </div>

      <div class="grid grid-cols-3 gap-2 text-xs">
        <label class="col-span-1 flex flex-col gap-1">
          <span class="text-slate-500">å‹•ä½œ</span>
          <select class="border rounded px-2 py-1">
            <option value="message" ${a.type==='message'?'selected':''}>ç™¼æ–‡å­—</option>
            <option value="uri" ${a.type==='uri'?'selected':''}>é–‹ç¶²é </option>
          </select>
        </label>

        <label class="col-span-2 flex flex-col gap-1">
          <span class="text-slate-500">å…§å®¹</span>
          <input class="border rounded px-2 py-1" value="${escapeHtml(a.text||'')}"
            placeholder="${a.type==='uri'?'è²¼ç¶²å€ https://...':'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰'}">
        </label>
      </div>
    `;

    const delBtn = row.querySelector('button');
    const sel = row.querySelector('select');
    const input = row.querySelector('input');

    delBtn.onclick = () => {
      if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
        images[currentImgIndex].areas.splice(i, 1);
        renderAreas(); renderAreaList(); renderImageList();
      }
    };
    sel.onchange = () => {
      a.type = sel.value;
      input.placeholder = a.type === 'uri' ? 'è²¼ç¶²å€ https://...' : 'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰';
    };
    input.oninput = () => a.text = input.value;

    box.appendChild(row);
  });
}

/* ---------- imagemap messages build (1040åŸºæº–) ---------- */
function buildImagemapMessages(){
  return Promise.all(images.map(img => new Promise((resolve) => {
    const im = new Image();
    im.onload = () => {
      const baseW = 1040;
      const ratio = im.naturalHeight / im.naturalWidth;
      const baseH = Math.round(baseW * ratio);

      const actions = img.areas.map(a => ({
        type: a.type,
        text: a.type === 'message' ? a.text : undefined,
        linkUri: a.type === 'uri' ? a.text : undefined,
        area: {
          x: Math.round(a.x * baseW),
          y: Math.round(a.y * baseH),
          width: Math.round(a.w * baseW),
          height: Math.round(a.h * baseH)
        }
      }));

      resolve({
        type: "imagemap",
        baseUrl: img.url,
        altText: "é¸å–®",
        baseSize: { width: baseW, height: baseH },
        actions
      });
    };
    im.onerror = () => resolve({
      type: "imagemap",
      baseUrl: img.url,
      altText: "é¸å–®",
      baseSize: { width: 1040, height: 1040 },
      actions: []
    });
    im.src = img.url;
  })));
}

/* ---------- save/loadï¼škeyword å¯é¸ + æœ¬æ©Ÿè‰ç¨¿ ---------- */
function getDraftKey(){ return "imagemap_draft_v1"; }

function assertAreasFilled(){
  if(images.length === 0) return "è‡³å°‘æ–°å¢ä¸€å¼µåœ–ç‰‡";
  if(images.some(i => !i.url)) return "æœ‰åœ–ç‰‡å°šæœªä¸Šå‚³åˆ° R2";
  if(images.some(img => img.areas.some(a => !String(a.text||'').trim()))) return "æœ‰æ¡†æ²’æœ‰å¡«å…§å®¹ï¼ˆé—œéµå­—æˆ–ç¶²å€ï¼‰";
  return "";
}

async function saveSettingsUI(forceNew){
  const err = assertAreasFilled();
  if(err) return alert(err);

  const raw = document.getElementById('workerUrl').value;
  const base = normalizeWorkerUrl(raw);
  let keyword = document.getElementById('triggerKeyword').value.trim();

  // âœ… æ²’å¡« keywordï¼šå­˜æœ¬æ©Ÿè‰ç¨¿
  if(!keyword){
    const messages = await buildImagemapMessages();
    localStorage.setItem(getDraftKey(), JSON.stringify({ messages, savedAt: Date.now() }));
    return alert('å·²å„²å­˜åˆ°æœ¬æ©Ÿè‰ç¨¿ï¼ˆæœªå¡«é—œéµå­—ï¼‰ã€‚');
  }

  // âœ… æœ‰å¡« keywordï¼šèµ° Worker /save
  if(!base) return alert('ä½ æœ‰å¡«é—œéµå­—ï¼Œæ‰€ä»¥ WorkerUrl ä¹Ÿå¿…é ˆå¡«ï¼Œæ‰èƒ½å­˜åˆ°é›²ç«¯ã€‚');
  localStorage.setItem('line_worker_url', base);

  // âœ… å¦å­˜æ–°æª”ï¼šé¿å…è¦†è“‹ï¼ˆè‡ªå‹•åŠ å°¾ç¢¼ï¼‰
  if(forceNew){
    const suffix = new Date().toISOString().slice(0,10).replaceAll('-','') + '_' + Math.random().toString(36).slice(2,6);
    keyword = `${keyword}_${suffix}`;
    document.getElementById('triggerKeyword').value = keyword;
  }

  try{
    const messages = await buildImagemapMessages();
    await postJSON(base + '/save', {
      keyword,
      payload:{ mode:'imagemap', messages }
    });
    alert('å„²å­˜æˆåŠŸï¼ï¼ˆé›²ç«¯ï¼‰');
  }catch(e){
    alert('å„²å­˜å¤±æ•—ï¼š\n' + e.message);
  }
}

async function loadSettingsUI(){
  const raw = document.getElementById('workerUrl').value;
  const base = normalizeWorkerUrl(raw);
  const keyword = document.getElementById('triggerKeyword').value.trim();

  // âœ… æ²’å¡« keywordï¼šè®€æœ¬æ©Ÿè‰ç¨¿
  if(!keyword){
    const rawDraft = localStorage.getItem(getDraftKey());
    if(!rawDraft) return alert('æœ¬æ©Ÿæ²’æœ‰è‰ç¨¿ï¼ˆè«‹å…ˆæŒ‰ã€Œå„²å­˜ã€ä¸”ä¸å¡«é—œéµå­—ï¼‰ã€‚');
    let obj;
    try{ obj = JSON.parse(rawDraft); }catch{ obj = null; }
    if(!obj?.messages || !Array.isArray(obj.messages)) return alert('æœ¬æ©Ÿè‰ç¨¿æ ¼å¼æå£ã€‚');

    images = obj.messages.map(m => {
      const bw = m.baseSize?.width || 1040;
      const bh = m.baseSize?.height || 1040;
      return {
        url: m.baseUrl,
        areas: (m.actions || []).map(a => ({
          type: a.type,
          text: a.type === 'message' ? (a.text || '') : (a.linkUri || ''),
          x: (a.area.x || 0) / bw,
          y: (a.area.y || 0) / bh,
          w: (a.area.width || 0) / bw,
          h: (a.area.height || 0) / bh
        }))
      };
    });

    renderImageList();
    selectImage(images.length ? 0 : -1);
    setZoom(1);
    return alert('å·²è®€å–æœ¬æ©Ÿè‰ç¨¿ã€‚');
  }

  // âœ… æœ‰ keywordï¼šèµ° Worker /load
  if(!base) return alert('è«‹å…ˆå¡« WorkerUrl');
  localStorage.setItem('line_worker_url', base);

  try{
    const data = await postJSON(base + '/load', { keyword });
    const obj = (typeof data === 'string') ? JSON.parse(data) : data;

    if(!obj.messages || !Array.isArray(obj.messages)){
      return alert('è®€åˆ°è³‡æ–™ä½†æ ¼å¼ä¸å°ï¼ˆæ²’æœ‰ messagesï¼‰');
    }

    images = obj.messages.map(m => {
      const bw = m.baseSize?.width || 1040;
      const bh = m.baseSize?.height || 1040;
      return {
        url: m.baseUrl,
        areas: (m.actions || []).map(a => ({
          type: a.type,
          text: a.type === 'message' ? (a.text || '') : (a.linkUri || ''),
          x: (a.area.x || 0) / bw,
          y: (a.area.y || 0) / bh,
          w: (a.area.width || 0) / bw,
          h: (a.area.height || 0) / bh
        }))
      };
    });

    renderImageList();
    selectImage(images.length ? 0 : -1);
    setZoom(1);
    alert('è®€å–æˆåŠŸï¼ï¼ˆé›²ç«¯ï¼‰');
  }catch(e){
    alert('è®€å–å¤±æ•—ï¼š\n' + e.message);
  }
}
</script>
  <script src="/assets/js/api.js"></script>
</body>
</html>
