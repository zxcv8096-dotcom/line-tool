<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>關鍵字自動回覆後台</title>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont; background:#f5f7fb; padding:40px; }
    h1 { margin-bottom: 14px; }
    .box { background:white; padding:20px; border-radius:12px; max-width:720px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea, select, button {
      width:100%; margin-top:8px; padding:10px; font-size:16px; box-sizing:border-box;
    }
    textarea { min-height:120px; }
    button { background:#4f46e5; color:white; border:none; border-radius:10px; cursor:pointer; margin-top:14px; }
    .hint { font-size:13px; opacity:.75; margin-top:6px; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .topbar{
      max-width:720px;
      margin-bottom:12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      color:#3730a3;
    }
    .btn2{
      width:auto;
      padding:8px 12px;
      border-radius:10px;
      background:#111827;
    }
  </style>
</head>
<body>
  <h1>關鍵字自動回覆後台</h1>

  <div class="topbar">
    <span class="pill">Worker：<span id="baseText">（未設定）</span></span>
    <button class="btn2" id="btnHealth">測試 /health</button>
  </div>

  <div class="box">
    <label>關鍵字</label>
    <input id="keyword" placeholder="例如：菜單（輸入後按 Enter 可載入）" />

    <div class="row">
      <div>
        <label>回覆類型</label>
        <select id="type">
          <option value="text">文字</option>
          <option value="image">圖片（網址）</option>
          <option value="video">影片（網址）</option>
          <option value="audio">錄音（網址）</option>
          <option value="link">連結（網址＋標題）</option>
        </select>
      </div>
      <div>
        <label>連結標題（只給「連結」用）</label>
        <input id="linkTitle" placeholder="例如：點我領取" />
      </div>
    </div>

    <label id="valueLabel">回覆內容（文字）</label>
    <textarea id="value" placeholder="輸入要回覆的文字"></textarea>
    <div class="hint" id="hint"></div>

    <button id="saveBtn">儲存</button>
  </div>

  <!-- ✅ 全站共用 API（一定要放） -->
  <script src="/assets/js/api.js"></script>

  <script>
    const keywordEl = document.getElementById("keyword");
    const typeEl = document.getElementById("type");
    const linkTitleEl = document.getElementById("linkTitle");
    const valueLabelEl = document.getElementById("valueLabel");
    const valueEl = document.getElementById("value");
    const hintEl = document.getElementById("hint");
    const saveBtn = document.getElementById("saveBtn");
    const baseText = document.getElementById("baseText");
    const btnHealth = document.getElementById("btnHealth");

    // 顯示目前 Worker base
    function refreshBaseLabel(){
      const b = (window.api && api.getBase()) ? api.getBase() : "";
      baseText.textContent = b || "（未設定：請到 settings 頁輸入一次）";
    }
    refreshBaseLabel();

    btnHealth.addEventListener("click", async ()=>{
      try{
        refreshBaseLabel();
        const r = await api.health(); // GET /health
        alert("OK：\n" + JSON.stringify(r, null, 2));
      }catch(e){
        alert("失敗：\n" + e.message);
      }
    });

    function refreshUI() {
      const t = typeEl.value;

      linkTitleEl.disabled = (t !== "link");
      if (t === "text") {
        valueLabelEl.textContent = "回覆內容（文字）";
        valueEl.placeholder = "輸入要回覆的文字";
        hintEl.textContent = "";
      } else if (t === "link") {
        valueLabelEl.textContent = "連結網址";
        valueEl.placeholder = "https://...";
        hintEl.textContent = "連結要填：網址；標題填上面那格";
      } else {
        valueLabelEl.textContent = "檔案網址";
        valueEl.placeholder = "https://... (圖片/影片/音檔網址)";
        hintEl.textContent = "請貼可公開存取的檔案網址";
      }
    }
    typeEl.addEventListener("change", refreshUI);
    refreshUI();

    saveBtn.addEventListener("click", async () => {
      try{
        refreshBaseLabel();

        const keyword = keywordEl.value.trim();
        const type = typeEl.value;
        const v = valueEl.value.trim();
        const linkTitle = linkTitleEl.value.trim();

        if (!keyword) return alert("請輸入關鍵字");
        if (!v) return alert("請輸入回覆內容/網址");
        if (type === "link" && !linkTitle) return alert("連結類型請填連結標題");

        const data =
          type === "text" ? { type:"text", text: v } :
          type === "image" ? { type:"image", url: v } :
          type === "video" ? { type:"video", url: v } :
          type === "audio" ? { type:"audio", url: v } :
          { type:"link", url: v, title: linkTitle };

        // ✅ 用 api.js
        const res = await api.post("/save", {
          keyword,
          reply: JSON.stringify(data)
        });

        alert("儲存成功");
        valueEl.value = "";
      }catch(e){
        alert("儲存失敗：" + e.message);
      }
    });

    // 輸入關鍵字按 Enter：自動讀出目前設定
    keywordEl.addEventListener("keydown", async (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();

      try{
        refreshBaseLabel();

        const keyword = keywordEl.value.trim();
        if (!keyword) return;

        // ✅ 用 api.js + querystring helper
        const j = await api.get("/reply" + api.qs({ keyword }));
        const data = j?.data;
        if (!data) return alert("找不到此關鍵字");

        if (data.type === "text") {
          typeEl.value = "text";
          valueEl.value = data.text || "";
          linkTitleEl.value = "";
        } else if (data.type === "link") {
          typeEl.value = "link";
          valueEl.value = data.url || "";
          linkTitleEl.value = data.title || "";
        } else {
          typeEl.value = data.type;
          valueEl.value = data.url || "";
          linkTitleEl.value = "";
        }
        refreshUI();
      }catch(err){
        alert("讀取失敗：" + err.message);
      }
    });
  </script>
</body>
</html>
