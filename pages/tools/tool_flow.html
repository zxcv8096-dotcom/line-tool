<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>見證流程設計器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>.flow-arrow { text-align: center; font-size: 24px; color: #cbd5e1; padding: 10px; }</style>
</head>
<body class="bg-slate-50 text-slate-800 p-8 min-h-screen">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4 text-purple-600 flex items-center gap-2">
            <a href="index.html" class="text-xl hover:bg-slate-200 rounded px-1 text-slate-600">🔙</a>
            🔀 見證流程設計器
        </h1>
        
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8 flex gap-4 items-end border border-purple-100">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">Worker 網址</label>
                <input id="workerUrl" class="border p-2 rounded w-64 bg-yellow-50 text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">主觸發關鍵字</label>
                <input id="mainKeyword" placeholder="例如: 見證" class="border p-2 rounded w-40 font-bold text-purple-600 border-purple-300">
            </div>
            <button onclick="publishAll()" class="bg-purple-600 text-white px-6 py-2 rounded font-bold hover:bg-purple-700 shadow-md transition transform active:scale-95">一鍵發布所有流程</button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow mb-4 border-l-4 border-blue-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-blue-100 text-blue-800 px-3 py-1 text-xs font-bold rounded-bl-lg">STEP 1</div>
            <h3 class="font-bold text-lg mb-1">分類頁 (首頁)</h3>
            <p class="text-xs text-gray-400 mb-4">用戶輸入「<span class="key-display font-mono text-blue-600 bg-blue-50 px-1 rounded">關鍵字</span>」時顯示</p>
            <div class="flex gap-6">
                <div class="w-40 h-40 bg-gray-50 rounded-lg flex items-center justify-center cursor-pointer border-dashed border-2 border-blue-200 hover:bg-blue-50 transition relative group" onclick="uploadStep(1)">
                    <img id="img1" class="w-full h-full object-cover rounded hidden">
                    <span id="txt1" class="text-xs text-gray-400 group-hover:text-blue-500">📷 點擊上傳</span>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="bg-blue-50 p-3 rounded text-sm text-blue-800">
                        <strong>邏輯設定：</strong>
                        此圖將設定為「全版點擊」或「任意點擊」，
                        點擊後自動觸發 <span class="font-mono bg-white px-1 rounded">關鍵字_列表</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="flow-arrow animate-bounce">⬇️</div>

        <div class="bg-white p-6 rounded-lg shadow mb-4 border-l-4 border-amber-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-amber-100 text-amber-800 px-3 py-1 text-xs font-bold rounded-bl-lg">STEP 2</div>
            <h3 class="font-bold text-lg mb-1">見證列表</h3>
            <p class="text-xs text-gray-400 mb-4">隱藏關鍵字: <span class="key-display font-mono text-amber-600 bg-amber-50 px-1 rounded">關鍵字_列表</span></p>
            <div class="flex gap-6">
                <div class="w-40 h-40 bg-gray-50 rounded-lg flex items-center justify-center cursor-pointer border-dashed border-2 border-amber-200 hover:bg-amber-50 transition relative group" onclick="uploadStep(2)">
                    <img id="img2" class="w-full h-full object-cover rounded hidden">
                    <span id="txt2" class="text-xs text-gray-400 group-hover:text-amber-500">📷 上傳列表圖</span>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="bg-amber-50 p-3 rounded text-sm text-amber-800">
                        <strong>邏輯設定：</strong>
                        上半部設定為進入 <span class="font-mono bg-white px-1 rounded">關鍵字_詳細</span><br>
                        (您可以在圖片上畫出藍色區域作為「折疊」按鈕)
                    </div>
                </div>
            </div>
        </div>

        <div class="flow-arrow animate-bounce">⬇️ ⬆️</div>

        <div class="bg-white p-6 rounded-lg shadow mb-4 border-l-4 border-green-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-green-100 text-green-800 px-3 py-1 text-xs font-bold rounded-bl-lg">STEP 3</div>
            <h3 class="font-bold text-lg mb-1">見證大圖 (詳細)</h3>
            <p class="text-xs text-gray-400 mb-4">隱藏關鍵字: <span class="key-display font-mono text-green-600 bg-green-50 px-1 rounded">關鍵字_詳細</span></p>
            <div class="flex gap-6">
                <div class="w-40 h-40 bg-gray-50 rounded-lg flex items-center justify-center cursor-pointer border-dashed border-2 border-green-200 hover:bg-green-50 transition relative group" onclick="uploadStep(3)">
                    <img id="img3" class="w-full h-full object-cover rounded hidden">
                    <span id="txt3" class="text-xs text-gray-400 group-hover:text-green-500">📷 上傳詳細圖</span>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="bg-green-50 p-3 rounded text-sm text-green-800">
                        <strong>邏輯設定：</strong>
                        點擊任意處，跳轉回 <span class="font-mono bg-white px-1 rounded">關鍵字_列表</span>
                        (模擬關閉效果)
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <input type="file" id="fileInput" hidden>

    <script>
        // ★★★ 自動讀取網址 ★★★
        window.onload = function() {
            const savedUrl = localStorage.getItem('line_worker_url');
            if(savedUrl) document.getElementById('workerUrl').value = savedUrl;
        }

        let steps = {
            1: { url: '', areas: [] },
            2: { url: '', areas: [] },
            3: { url: '', areas: [] }
        };

        function uploadStep(n) {
            const url = document.getElementById('workerUrl').value;
            if(!url) return alert('請先填寫 Worker 網址');

            document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    try {
                        const res = await fetch(url+'/upload', {method:'POST', body:JSON.stringify({password:'1234', image:reader.result})});
                        const json = await res.json();
                        
                        steps[n].url = json.url;
                        document.getElementById('img'+n).src = json.url;
                        document.getElementById('img'+n).classList.remove('hidden');
                        document.getElementById('txt'+n).classList.add('hidden');
                        
                        // 自動產生 Imagemap 熱區邏輯
                        // 這裡為了簡化操作，直接使用預設的全版或半版熱區
                        // 若要更精細，可以使用 Imagemap 工具先做好再來填入
                        if(n === 1) steps[n].areas = [{x:0,y:0,width:1040,height:1040, type:'message', text:'_KEY_2_'}];
                        if(n === 2) steps[n].areas = [{x:0,y:0,width:1040,height:520, type:'message', text:'_KEY_3_'}]; // 上半部去詳細
                        if(n === 3) steps[n].areas = [{x:0,y:0,width:1040,height:1040, type:'message', text:'_KEY_2_'}]; // 點擊回列表
                    } catch(e) { alert('上傳失敗'); }
                }
            }
        }

        async function publishAll() {
            const mainKey = document.getElementById('mainKeyword').value;
            const url = document.getElementById('workerUrl').value;
            if(!mainKey || !url) return alert('資料不全');
            if(!steps[1].url || !steps[2].url || !steps[3].url) return alert('請上傳所有步驟的圖片');

            const key1 = mainKey;
            const key2 = mainKey + "_列表";
            const key3 = mainKey + "_詳細";

            // 替換真實關鍵字
            steps[1].areas[0].text = key2;
            steps[2].areas[0].text = key3;
            steps[3].areas[0].text = key2;

            // 批次儲存
            try {
                await saveOne(url, key1, steps[1]);
                await saveOne(url, key2, steps[2]);
                await saveOne(url, key3, steps[3]);
                alert('🎉 發布成功！\n請在 LINE 輸入「' + mainKey + '」開始測試。');
            } catch(e) { alert('儲存過程發生錯誤'); }
        }

        async function saveOne(url, key, stepData) {
            const payload = {
                mode: 'imagemap',
                messages: [{
                    type: "imagemap",
                    baseUrl: stepData.url,
                    altText: "見證流程",
                    baseSize: { width: 1040, height: 1040 },
                    actions: stepData.areas.map(a => ({
                        type: a.type, text: a.text,
                        area: {x:a.x, y:a.y, width:a.width, height:a.height}
                    }))
                }]
            };
            await fetch(url+'/save', {
                method:'POST', body:JSON.stringify({password:'1234', keyword:key, payload})
            });
        }
    </script>
    <script src="/assets/js/api.js"></script>
</body>
</html>
