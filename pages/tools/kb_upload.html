<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>文件庫上傳（AI 用）</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-100 p-4">
  <div class="max-w-3xl mx-auto">
    <div class="bg-white rounded-2xl shadow p-6">
      <h1 class="text-2xl font-extrabold text-slate-900">文件庫上傳（AI 用）</h1>
      <p class="text-slate-600 mt-1">把產品/方案說明貼上來，之後 AI 會用這些內容生成報告與推薦。</p>

      <div class="mt-5">
        <label class="text-sm font-semibold text-slate-700">Worker 網址</label>
        <input id="api" class="mt-1 w-full px-4 py-3 rounded-xl border" placeholder="https://api.xxx.workers.dev" />
        <div class="text-xs text-slate-500 mt-2">會自動抓首頁的 <span class="font-mono">line_worker_url</span></div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-semibold text-slate-700">文件 ID（可空白）</label>
          <input id="id" class="mt-1 w-full px-4 py-3 rounded-xl border font-mono" placeholder="例如 plan_basic" />
        </div>
        <div>
          <label class="text-sm font-semibold text-slate-700">文件標題</label>
          <input id="title" class="mt-1 w-full px-4 py-3 rounded-xl border" placeholder="例如：能量支持方案（入門）" />
        </div>
      </div>

      <div class="mt-4">
        <label class="text-sm font-semibold text-slate-700">標籤（逗號分隔）</label>
        <input id="tags" class="mt-1 w-full px-4 py-3 rounded-xl border" placeholder="疲勞,睡眠,腸胃,代謝" />
      </div>

      <div class="mt-4">
        <label class="text-sm font-semibold text-slate-700">文件內容（貼上全文）</label>
        <textarea id="text" rows="14" class="mt-1 w-full px-4 py-3 rounded-xl border font-mono"
          placeholder="把你的方案說明、產品特色、適用族群、注意事項貼在這裡"></textarea>
      </div>

      <div class="mt-5 flex gap-2">
        <button id="btnSave" class="px-5 py-3 rounded-xl bg-slate-900 text-white font-semibold hover:bg-black">儲存文件</button>
        <button id="btnTest" class="px-5 py-3 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-500">測試生成報告</button>
      </div>

      <pre id="out" class="mt-5 p-4 rounded-xl bg-slate-900 text-slate-100 text-xs overflow-auto"></pre>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  function apiBase(){
    const v = ($("api").value || "").trim();
    if(!v) throw new Error("請先輸入 Worker 網址");
    localStorage.setItem("line_worker_url", v);
    return v.replace(/\/$/,'');
  }

  window.onload = ()=>{
    const saved = (localStorage.getItem("line_worker_url") || "").trim();
    if(saved) $("api").value = saved;
  };

  $("btnSave").onclick = async ()=>{
    try{
      const base = apiBase();
      const id = ($("id").value || "").trim();
      const title = ($("title").value || "").trim();
      const tags = ($("tags").value || "").split(",").map(s=>s.trim()).filter(Boolean);
      const text = ($("text").value || "").trim();
      if(!text) return alert("請貼上文件內容");

      const res = await fetch(base + "/kb/put", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id, title, tags, text })
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || data?.ok===false) throw new Error(data?.error || "儲存失敗");
      $("out").textContent = JSON.stringify(data, null, 2);
      alert("已儲存 ✅");
    }catch(e){
      alert(e.message);
    }
  };

  $("btnTest").onclick = async ()=>{
    try{
      const base = apiBase();
      const res = await fetch(base + "/ai/report", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          answers: [
            { q:"你最想改善什麼？", a:"下午容易沒電" },
            { q:"目前狀況多久了？", a:"好幾個月" },
            { q:"生活作息？", a:"常熬夜、外食多" }
          ]
        })
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || data?.ok===false) throw new Error(data?.error || "生成失敗");
      $("out").textContent = JSON.stringify(data, null, 2);
    }catch(e){
      alert(e.message);
    }
  };
</script>
</body>
</html>
