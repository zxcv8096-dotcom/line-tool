<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï½œä¸­æ§å°ï¼ˆæ–°ç‰ˆä»‹é¢ï¼‹å¼•æµåœ–=imagemapç•«æ¡†ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0b1220;
      --muted:#5b6b87;
      --bd:rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.86);
      --glass2: rgba(255,255,255,.72);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
      --shadow2: 0 10px 26px rgba(2,6,23,.08);
      --ring: 0 0 0 5px rgba(99,102,241,.14);
      --radius: 22px;
    }
    body{
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,.20), transparent 60%),
        radial-gradient(900px 520px at 90% 18%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 520px at 40% 92%, rgba(236,72,153,.14), transparent 60%),
        linear-gradient(135deg, #fbfdff, #f1f6ff 35%, #ecfeff);
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .thinbar::-webkit-scrollbar{ height:10px; width:10px; }
    .thinbar::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.20); border-radius: 999px; }
    .card{
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(15,23,42,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
    }
    .card2{
      background: var(--glass2);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(15,23,42,.08);
      box-shadow: var(--shadow2);
      border-radius: var(--radius);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:.5rem; border-radius: 16px; padding:.72rem 1rem;
      font-weight:900; font-size:13px;
      transition: transform .08s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease, filter .18s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-dark{
      color:#fff;
      background: linear-gradient(135deg, #0b1220, #111827);
      box-shadow: 0 12px 24px rgba(2,6,23,.18);
    }
    .btn-dark:hover{ filter: brightness(1.03); }
    .btn-soft{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(15,23,42,.12);
      color: #0b1220;
      box-shadow: 0 10px 20px rgba(2,6,23,.06);
    }
    .btn-soft:hover{ background: rgba(255,255,255,.98); border-color: rgba(99,102,241,.25); }
    .btn-indigo{
      color:#fff;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 14px 28px rgba(99,102,241,.18);
    }
    .btn-indigo:hover{ filter: brightness(1.03); }
    .btn-emerald{
      color:#fff;
      background: linear-gradient(135deg, #10b981, #22c55e);
      box-shadow: 0 14px 28px rgba(16,185,129,.18);
    }
    .btn-emerald:hover{ filter: brightness(1.03); }
    .in{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.86);
      padding: .78rem 1rem;
      outline: none;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    .in:focus{
      border-color: rgba(99,102,241,.35);
      box-shadow: var(--ring);
      background: rgba(255,255,255,.98);
    }
    .pill{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .55rem;
      border-radius:999px;
      font-weight:900;
      font-size:11px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
      color: rgba(2,6,23,.72);
    }
    .pill-green{ border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.10); color: rgba(5,150,105,1); }
    .pill-indigo{ border-color: rgba(99,102,241,.25); background: rgba(99,102,241,.10); color: rgba(79,70,229,1); }
    .pill-rose{ border-color: rgba(244,63,94,.25); background: rgba(244,63,94,.10); color: rgba(190,18,60,1); }
    .minw0{ min-width:0; }

    /* ===== æ–°ç‰ˆï¼šç‰ˆé¢æ›´ç·Šæ¹Šã€å¥½ç”¨ã€æ²’æœ‰å¤§ç©ºç™½ ===== */
    .wrap{
      max-width: 1220px;
      margin: 0 auto;
      padding: clamp(12px, 2.2vw, 22px);
    }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(14px);
      border: 1px solid rgba(15,23,42,.08);
      box-shadow: 0 10px 30px rgba(2,6,23,.06);
      border-radius: 22px;
      background: rgba(255,255,255,.70);
    }
    .tab{
      display:inline-flex; align-items:center; justify-content:center;
      padding:.62rem .9rem;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      font-weight:900;
      font-size:12px;
      color: rgba(2,6,23,.86);
      user-select:none;
      transition: all .16s ease;
    }
    .tab:hover{ background: rgba(255,255,255,.95); border-color: rgba(99,102,241,.28); }
    .tab.active{
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(16,185,129,1));
      color:#fff;
      border-color: transparent;
      box-shadow: 0 10px 22px rgba(99,102,241,.18);
    }

    .grid-main{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
      margin-top: 14px;
    }
    @media (max-width: 1100px){
      .grid-main{ grid-template-columns: 1fr; }
    }

    .sidebar-sticky{
      position: sticky;
      top: 92px;
    }
    @media (max-width: 1100px){
      .sidebar-sticky{ position: static; top:auto; }
    }

    .section-title{
      font-weight: 900;
      font-size: 14px;
      color: rgba(2,6,23,.92);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hint{ font-size: 11px; color: rgba(2,6,23,.55); line-height: 1.5; }

    canvas{ display:block; max-width:100%; height:auto; }

    /* ===== Toast ===== */
    #toastWrap{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      width: min(92vw, 560px);
      z-index: 9999;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* =========================================================
       âœ… å¼•æµåœ–ï¼ˆimagemapï¼‰ç·¨è¼¯å™¨ï¼šè·Ÿä½ ä¸‹é¢é‚£ä»½ä¸€æ¨£ï¼ˆç•«æ¡†/ç¸®æ”¾/ä¸Šå‚³R2/å„²å­˜è®€å–ï¼‰
       ========================================================= */
    .area-box{
      position:absolute;
      border:2px solid rgba(255,0,0,.85);
      background:rgba(255,0,0,.22);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:800;
      font-size:14px;
      text-shadow:0 1px 2px rgba(0,0,0,.9);
      user-select:none;
    }
    .draw-rect{
      position:absolute;
      border:2px dashed rgba(0,0,0,.6);
      background:rgba(0,0,0,.10);
      pointer-events:none;
    }
    #imapStage{
      position: relative;
      transform-origin: top left;
    }
    #imapDrawLayer{
      position:absolute;
      inset:0;
      cursor:crosshair;
      touch-action:none;
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="wrap">

    <!-- Top bar -->
    <div class="topbar p-3 md:p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="minw0">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="text-lg md:text-xl font-black text-slate-950">ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï½œä¸­æ§å°</div>
            <span class="pill pill-indigo">æ–°ç‰ˆä»‹é¢</span>
            <span class="pill pill-green" id="pillConn">æœªé€£ç·š</span>
            <span class="pill">æœ€å¾Œï¼š<span id="txtLast" class="mono ml-1">-</span></span>
          </div>
          <div class="hint mt-1">
            âœ… å³å´ã€Œå¼•æµåœ–ã€å·²æ”¹æˆä½ è¦çš„ <b>imagemap ç•«æ¡†ç‰ˆ</b>ï¼šæ–°å¢åœ–ç‰‡ â†’ ä¸Šå‚³åˆ° R2 â†’ æ‹–æ›³ç•«æ¡† â†’ å¡«æ–‡å­—/ç¶²å€ â†’ å„²å­˜/è®€å–ã€‚
          </div>
        </div>

        <div class="minw0 flex flex-wrap gap-2 justify-start md:justify-end">
          <button class="tab active" data-tab="tab-preview">é è¦½ / ç”¢åœ–</button>
          <button class="tab" data-tab="tab-cta">å¼•æµåœ–ï¼ˆç•«æ¡†/ä¸Šå‚³R2ï¼‰</button>
          <button class="tab" data-tab="tab-targets">å¹´é½¡å±¤åƒè€ƒå€¼</button>
        </div>
      </div>
    </div>

    <div class="grid-main">

      <!-- Sidebar -->
      <aside class="sidebar-sticky space-y-3">
        <div class="card p-4">
          <div class="section-title">
            <span>é€£ç·šè¨­å®š</span>
            <span class="pill pill-rose" id="pillConn2">æœªé€£ç·š</span>
          </div>
          <div class="mt-3 grid gap-2">
            <label class="text-xs font-extrabold text-slate-600">Worker API</label>
            <input id="inApiBase" class="in mono" value="https://api.zxcv8096.workers.dev/" />
            <label class="text-xs font-extrabold text-slate-600 mt-1">Admin Keyï¼ˆå¯ç©ºç™½ï¼‰</label>
            <input id="inAdminKey" class="in mono" placeholder="è‹¥ Worker æœ‰é©—è­‰æ‰éœ€è¦å¡«" />
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnConnect" class="btn btn-dark w-full">é€£ç·š</button>
              <button id="btnWrite" class="btn btn-emerald w-full">å¯«å…¥KV</button>
            </div>
            <div class="hint mt-2">
              éœ€è¦ APIï¼š<span class="mono">POST /listAll /putAny /loadAny</span><br/>
              åœ–ç‰‡ä¸Šå‚³è‹¥ä½ æœ‰åšä¹Ÿå¯ç”¨ï¼š<span class="mono">POST /upload</span>
            </div>
          </div>

          <div id="errBanner" class="hidden mt-3 rounded-2xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
            <div class="font-extrabold">éŒ¯èª¤</div>
            <div id="errText" class="mt-1 mono text-[12px] whitespace-pre-wrap"></div>
          </div>
        </div>

        <div class="card p-4">
          <div class="section-title"><span>å•å·è¨­å®š</span><span class="pill">life11</span></div>
          <div class="mt-3 grid gap-2">
            <label class="text-xs font-extrabold text-slate-600">å•Ÿå‹•é—œéµå­—ï¼ˆLINE ä½¿ç”¨è€…è¼¸å…¥é€™å€‹é–‹å§‹ï¼‰</label>
            <input id="inKeyword" class="in" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»ç‡Ÿé¤Š" />
            <div class="hint">
              æœƒå¯«å…¥ï¼š<span class="mono">AI_SURVEY:KW_MAP</span> ä¾‹å¦‚ <span class="mono">{"ç”Ÿæ´»ç‡Ÿé¤Š":"life11"}</span>
            </div>
          </div>
          <div class="mt-3 rounded-2xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900 leading-6">
            <div class="font-extrabold">è¦å‰‡</div>
            <div>â€¢ å¾ 100% é–‹å§‹ï¼Œç­”ã€Œæ˜¯ã€å°±æ‰£åˆ†ï¼ˆå¤¾åˆ° 0ï½100%ï¼‰ã€‚</div>
            <div>â€¢ ç”¢åœ–ï¼šå€‹è³‡ â†’ 9 å€‹ç‡Ÿé¤Šç´ ï¼ˆå–®åˆ—ï¼‰â†’ æœ€ä¸‹é¢å¼•æµåœ–ã€‚</div>
          </div>
        </div>

        <div class="card p-4">
          <div class="section-title"><span>å¿«é€Ÿæ¸¬è©¦</span><span class="pill pill-indigo">æ¨¡æ“¬</span></div>
          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="btnSimAllGood" class="btn btn-soft w-full">éƒ½å¾ˆå¥åº·</button>
            <button id="btnSimAllYes" class="btn btn-soft w-full">å…¨éƒ¨é¸æ˜¯</button>
          </div>

          <div class="mt-3">
            <label class="text-xs font-extrabold text-slate-600">é è¦½é ­åƒ URLï¼ˆæ¸¬è©¦ç”¨ï¼‰</label>
            <input id="inPreviewAvatarUrl" class="in mono mt-1" value="https://i.pravatar.cc/150?img=12" />
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnApplyPreviewAvatar" class="btn btn-soft w-full">å¥—ç”¨</button>
              <button id="btnRandPreviewAvatar" class="btn btn-soft w-full">éš¨æ©Ÿ</button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="space-y-3 minw0">

        <!-- TAB: Preview / Render -->
        <section id="tab-preview" class="space-y-3">
          <div class="card p-4">
            <div class="section-title">
              <span>å•å·æ¨¡æ“¬ï¼ˆ11é¡Œï¼‰</span>
              <span class="pill">No.1ï½11</span>
            </div>
            <div class="hint mt-1">é€™è£¡åªåšæ¸¬è©¦ï¼›æ­£å¼ LINE ç”± Worker æ§åˆ¶ã€‚</div>
            <div id="simWrap" class="mt-3 grid gap-2"></div>
          </div>

          <div class="card p-4">
            <div class="section-title">
              <span>ç”¢ç”Ÿåœ–ç‰‡ï¼ˆ900Ã—1600 PNGï¼‰</span>
              <span class="pill pill-green">ç‡Ÿé¤Šç´ å–®åˆ—ï¼‹ä¸Šé™å¤§å­—ï¼‹ç™¾åˆ†æ¯”ç½®ä¸­</span>
            </div>

            <div class="mt-3 grid md:grid-cols-2 gap-3">
              <div class="card2 p-4 minw0">
                <div class="font-black text-slate-950">åº•æ¿åœ–ç‰‡ URLï¼ˆå¿…å¡«ï¼‰</div>
                <div class="hint mt-1">åº•æ¿éœ€å¯å…¬é–‹å­˜å–ä¸¦å…è¨±è·¨åŸŸï¼ˆCORSï¼‰ï¼Œä¸ç„¶ä¸‹è¼‰æœƒå¤±æ•—ã€‚</div>
                <input id="inBgUrl" class="in mono mt-2" placeholder="https://.../report_bg.png" />

                <div class="mt-3">
                  <div class="font-black text-slate-950">å¼•æµåœ–ä¾†æºï¼ˆå¯é¸ï¼‰</div>
                  <div class="hint mt-1">
                    âœ… ä½ ç¾åœ¨çš„å¼•æµåœ–ç·¨è¼¯å™¨æ˜¯ã€Œç•«æ¡†/ä¸Šå‚³R2ã€ç‰ˆã€‚<br/>
                    ä½ å¯ä»¥åœ¨ã€Œå¼•æµåœ–ã€åˆ†é é¸å¥½åœ–ç‰‡å¾Œï¼ŒæŒ‰<b>ã€Œå¥—ç”¨åˆ°é è¦½/ç”¢åœ–ã€</b>ï¼Œå®ƒæœƒæŠŠåœ–ç‰‡ URL å¡«åˆ°é€™è£¡ã€‚
                  </div>
                  <input id="inCtaSource" class="in mono mt-2" placeholder="å¯è²¼ï¼šhttps://... æˆ– data:image/png;base64,..." />
                  <div class="grid grid-cols-2 gap-2 mt-2">
                    <button id="btnUseCtaFromEditor" class="btn btn-soft w-full">ç”¨ç·¨è¼¯å™¨çš„å¼•æµåœ–</button>
                    <button id="btnClearCtaSource" class="btn btn-soft w-full">æ¸…é™¤å¼•æµåœ–</button>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-4">
                  <button id="btnRenderImg" class="btn btn-dark w-full">ç”¢ç”Ÿåœ–ç‰‡</button>
                  <button id="btnDownloadImg" class="btn btn-soft w-full">ä¸‹è¼‰PNG</button>
                </div>
              </div>

              <div class="card2 p-4 minw0">
                <div class="flex items-center gap-3">
                  <div class="relative">
                    <div class="absolute -inset-1 rounded-full bg-gradient-to-br from-indigo-400/50 to-emerald-400/50 blur"></div>
                    <img id="previewAvatar" src="https://i.pravatar.cc/150?img=12"
                         class="relative w-14 h-14 rounded-full border border-white/60 shadow" alt="avatar"/>
                  </div>
                  <div class="minw0">
                    <div id="previewName" class="font-black text-slate-950 truncate">LINEä½¿ç”¨è€…åç¨±</div>
                    <div id="previewId" class="text-sm text-slate-500 mono truncate">@line_id</div>
                    <div id="previewMeta" class="text-xs text-slate-500 mt-1">æ€§åˆ¥ï¼šç”·ã€€å¹´é½¡ï¼š19 æ­²ä»¥ä¸Š</div>
                  </div>
                </div>

                <div class="mt-3">
                  <canvas id="cvReport" class="w-full rounded-2xl border border-slate-200 bg-white"></canvas>
                  <div class="hint mt-2">â€» è‹¥ä¸‹è¼‰å¤±æ•—ï¼Œå¤šåŠæ˜¯åº•æ¿è·¨åŸŸï¼ˆCORSï¼‰æ²’é–‹ã€‚</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- TAB: CTA / Imagemap Editor -->
        <section id="tab-cta" class="hidden space-y-3">
          <div class="card p-4">
            <div class="section-title">
              <span>å¼•æµåœ–ç·¨è¼¯å™¨ï¼ˆR2 ä¸Šå‚³ï¼‹ç•«æ¡†ï¼‹ç¸®æ”¾ï¼‰</span>
              <span class="pill pill-indigo">è·Ÿä½ æä¾›çš„ R2 å°ºå¯¸æ¨¡å¼ç‰ˆä¸€è‡´</span>
            </div>

            <div class="hint mt-1">
              ä½¿ç”¨æµç¨‹ï¼šâ‘  æ–°å¢åœ–ç‰‡ â†’ â‘¡ ä¸Šå‚³åˆ° R2ï¼ˆå£“ç¸®ï¼‰â†’ â‘¢ åœ¨åœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡† â†’ â‘£ å³å´å¡«ã€Œç™¼æ–‡å­—/é–‹ç¶²å€ã€â†’ â‘¤ å„²å­˜/è®€å–ã€‚<br/>
              å¦å¤–ï¼šä½ è¦æŠŠé€™å¼µå¼•æµåœ–æ”¾é€²å ±å‘Šåœ–ç‰‡åº•éƒ¨ â†’ ç”¨ã€Œå¥—ç”¨åˆ°é è¦½/ç”¢åœ–ã€ï¼Œå®ƒæœƒæŠŠã€Œç›®å‰åœ–ç‰‡ URLã€å¡«å›å»ã€‚
            </div>

            <!-- Top controls -->
            <div class="mt-3 grid grid-cols-1 xl:grid-cols-3 gap-3">
              <div class="card2 p-3">
                <div class="text-xs font-extrabold text-slate-600 mb-2">é›²ç«¯è¨­å®šï¼ˆWorker /save /loadï¼‰</div>
                <div class="grid gap-2">
                  <input type="text" id="imapWorkerUrl" placeholder="https://xxxx.workers.dev"
                         class="in mono bg-yellow-50" />
                  <input type="text" id="imapKeyword" placeholder="æœ¬åœ–é—œéµå­—ï¼ˆå¯ä¸å¡«ï¼šå­˜æœ¬æ©Ÿè‰ç¨¿ï¼‰"
                         class="in font-black border-indigo-300" />
                  <div class="grid grid-cols-3 gap-2">
                    <button id="btnIMapLoad" class="btn btn-soft w-full">è®€å–</button>
                    <button id="btnIMapSave" class="btn btn-emerald w-full">å„²å­˜</button>
                    <button id="btnIMapSaveAs" class="btn btn-indigo w-full">å¦å­˜æ–°æª”</button>
                  </div>
                  <div class="hint">ä¸å¡«é—œéµå­—ï¼šå­˜åˆ°æœ¬æ©Ÿè‰ç¨¿ï¼›æœ‰å¡«é—œéµå­—ï¼šå­˜åˆ° Workerï¼ˆ/saveï¼‰ã€‚</div>
                </div>
              </div>

              <div class="card2 p-3">
                <div class="flex items-center justify-between">
                  <div class="text-xs font-extrabold text-slate-600">ğŸ” åœ–ç‰‡ç¸®æ”¾</div>
                  <div class="text-[11px] text-slate-500">æ»¾è¼ª + Ctrl/Alt/Shift</div>
                </div>
                <div class="mt-2 flex items-center gap-2">
                  <input id="imapZoomRange" type="range" min="0.5" max="3" step="0.01" value="1" class="w-full">
                  <div class="text-xs font-black w-14 text-right" id="imapZoomLabel">100%</div>
                </div>
                <div class="mt-2 flex gap-2">
                  <button class="btn btn-dark text-xs !py-2 !px-3" id="imapZoom100">100%</button>
                  <button class="btn btn-soft text-xs !py-2 !px-3" id="imapZoom75">75%</button>
                  <button class="btn btn-soft text-xs !py-2 !px-3" id="imapZoom150">150%</button>
                </div>
              </div>

              <div class="card2 p-3">
                <div class="text-xs font-extrabold text-slate-600 mb-2">åœ–ç‰‡å°ºå¯¸/å£“ç¸®ï¼ˆä¸Šå‚³æ™‚ç”Ÿæ•ˆï¼‰</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <label class="flex flex-col gap-1 col-span-2">
                    <span class="text-slate-500">å°ºå¯¸æ¨¡å¼</span>
                    <select id="imapSizeMode" class="border rounded-2xl px-3 py-2 bg-white/90">
                      <option value="line">LINE å»ºè­°ï¼ˆé•·é‚Š 1280ï¼‰</option>
                      <option value="hd">æ¸…æ™°ï¼ˆé•·é‚Š 1600ï¼‰</option>
                      <option value="small">çœç©ºé–“ï¼ˆé•·é‚Š 960ï¼‰</option>
                      <option value="custom">è‡ªé¸å°ºå¯¸ï¼ˆå¯¬/é«˜ä¸Šé™ï¼‰</option>
                    </select>
                  </label>

                  <label id="imapCustomWWrap" class="flex flex-col gap-1 hidden">
                    <span class="text-slate-500">æœ€å¤§å¯¬(px)</span>
                    <input id="imapCustomW" type="number" value="1280" min="320" max="4096" class="border rounded-2xl px-3 py-2 bg-white/90">
                  </label>
                  <label id="imapCustomHWrap" class="flex flex-col gap-1 hidden">
                    <span class="text-slate-500">æœ€å¤§é«˜(px)</span>
                    <input id="imapCustomH" type="number" value="1280" min="320" max="4096" class="border rounded-2xl px-3 py-2 bg-white/90">
                  </label>

                  <label class="flex flex-col gap-1">
                    <span class="text-slate-500">æ ¼å¼</span>
                    <select id="imapOutFormat" class="border rounded-2xl px-3 py-2 bg-white/90">
                      <option value="image/webp" selected>WebPï¼ˆæ¨è–¦ï¼‰</option>
                      <option value="image/jpeg">JPEG</option>
                      <option value="image/png">PNGï¼ˆä¸å»ºè­°ï¼‰</option>
                    </select>
                  </label>

                  <label class="flex flex-col gap-1">
                    <span class="text-slate-500">å“è³ª</span>
                    <input id="imapQuality" type="range" min="0.55" max="0.95" step="0.01" value="0.82">
                    <div class="text-right text-[11px] text-slate-500">ç›®å‰ï¼š<span id="imapQVal">0.82</span></div>
                  </label>

                  <label class="flex items-center gap-2 col-span-2 mt-1">
                    <input id="imapCropSquare" type="checkbox" class="scale-110">
                    <span class="text-slate-600">è£åˆ‡æˆæ­£æ–¹å½¢ï¼ˆimagemap å¸¸ç”¨ï¼‰</span>
                  </label>

                  <div class="col-span-2 text-[11px] text-slate-500">
                    * ä¸Šå‚³æ™‚æœƒå†è‡ªå‹•é™åˆ¶ï¼šé•·å¯¬ä¸è¶…éä½ ç›®å‰è¢å¹•å¯è¦–å¤§å°
                  </div>
                </div>
              </div>
            </div>

            <!-- Main editor -->
            <div class="mt-3 grid grid-cols-1 xl:grid-cols-[300px_1fr] gap-3">
              <!-- Left list -->
              <div class="card2 p-3">
                <button id="imapAddImage"
                        class="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-2xl font-black hover:bg-indigo-50">
                  + æ–°å¢åœ–ç‰‡
                </button>
                <div id="imapImageList" class="space-y-3 mt-3"></div>

                <div class="mt-3 grid grid-cols-1 gap-2">
                  <button id="btnApplyToPreview" class="btn btn-dark w-full">å¥—ç”¨åˆ°é è¦½/ç”¢åœ–</button>
                  <button id="btnCopyImagemapJson" class="btn btn-soft w-full">è¤‡è£½ imagemap JSON</button>
                </div>

                <div class="hint mt-2">
                  â€¢ ã€Œå¥—ç”¨åˆ°é è¦½/ç”¢åœ–ã€åªæœƒæŠŠç›®å‰åœ–ç‰‡ URL å¸¶å›å»ï¼ˆç”¨ä¾†æ”¾åœ¨å ±å‘Šåº•éƒ¨ï¼‰ã€‚<br/>
                  â€¢ ã€Œè¤‡è£½ imagemap JSONã€æ˜¯çµ¦ LINE imagemap ç”¨ï¼ˆå«æ¡†åº§æ¨™ï¼‰ã€‚
                </div>
              </div>

              <!-- Right: area list + canvas -->
              <div class="card2 p-3">
                <div class="grid grid-cols-1 2xl:grid-cols-[360px_1fr] gap-3">
                  <!-- Area settings -->
                  <div class="bg-white/80 border border-slate-200 rounded-2xl p-3 h-fit">
                    <div class="flex items-center justify-between mb-2">
                      <div class="font-black text-slate-700">æ¡†æ¡†è¨­å®š</div>
                      <button id="imapClearAreas" class="text-xs text-rose-600 underline font-black">æ¸…ç©ºæœ¬åœ–å…¨éƒ¨æ¡†</button>
                    </div>
                    <div id="imapAreaList" class="space-y-2"></div>
                  </div>

                  <!-- Canvas zone -->
                  <div class="bg-white/80 border border-slate-200 rounded-2xl overflow-hidden">
                    <div class="p-2 bg-slate-50 border-b flex items-center justify-between">
                      <div class="text-xs text-slate-600 font-black">
                        âœ… æ‹–æ›³ç•«æ¡†ï¼Œé»ç´…æ¡†åˆªé™¤ã€‚ç¸®æ”¾ä¸å½±éŸ¿åº§æ¨™ã€‚
                      </div>
                      <button id="imapUploadBtn"
                        class="bg-black/70 text-white text-xs px-3 py-2 rounded-xl font-black hover:bg-black">
                        ğŸ“· ä¸Šå‚³åˆ° R2ï¼ˆå£“ç¸®ï¼‰
                      </button>
                    </div>

                    <div class="relative overflow-auto bg-gray-100" style="height: min(72vh, 720px);">
                      <div id="imapStage" class="inline-block">
                        <img id="imapPreviewImage" class="block pointer-events-none select-none" style="max-width:none; display:block;">
                        <div id="imapDrawLayer"></div>
                      </div>
                    </div>

                    <div id="imapEmptyState" class="text-slate-400 p-6 hidden">
                      <div class="text-center">
                        <div class="text-4xl mb-2">ğŸ‘ˆ</div>
                        <div class="font-black">è«‹å…ˆå¾å·¦å´æ–°å¢åœ–ç‰‡</div>
                        <div class="text-xs mt-1">ä¸Šå‚³åˆ° R2 å¾Œæ‰èƒ½ç•«æ¡†</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <input type="file" id="imapFileInput" accept="image/*" class="hidden">
          </div>
        </section>

        <!-- TAB: Targets -->
        <section id="tab-targets" class="hidden space-y-3">
          <div class="card p-4">
            <div class="section-title">
              <span>â‘¢ å¹´é½¡å±¤åƒè€ƒå€¼ï¼ˆä¸Šé™å€¼ä¾†æºï¼‰</span>
              <div class="flex gap-2">
                <button id="btnResetTargets" class="btn btn-soft">æ¢å¾©é è¨­</button>
                <button id="btnCopyTargetsJson" class="btn btn-soft">è¤‡è£½JSON</button>
              </div>
            </div>
            <div class="hint mt-1">ç”¢åœ–æ™‚é¡¯ç¤ºã€Œæ•¸å­—ï¼‹å–®ä½ã€ï¼ˆä¸é¡¯ç¤ºâ€œä¸Šé™â€å­—æ¨£ï¼‰ã€‚</div>

            <div class="mt-3 overflow-auto thinbar">
              <table class="w-full min-w-[980px] border-collapse">
                <thead>
                  <tr class="text-xs text-slate-600">
                    <th class="text-left p-2 border-b border-slate-200">é …ç›®</th>
                    <th class="text-left p-2 border-b border-slate-200">å–®ä½</th>
                    <th class="text-left p-2 border-b border-slate-200">0~10 æ­²</th>
                    <th class="text-left p-2 border-b border-slate-200">11~18 æ­²</th>
                    <th class="text-left p-2 border-b border-slate-200">19+ï¼ˆå¥³ï¼‰</th>
                    <th class="text-left p-2 border-b border-slate-200">19+ï¼ˆç”·ï¼‰</th>
                  </tr>
                </thead>
                <tbody id="targetsTbody" class="text-sm"></tbody>
              </table>
            </div>

            <div class="hint mt-2">
              â€» çµ„åˆé¡¯ç¤ºï¼š<span class="mono font-bold">ç¶­ç”Ÿç´ Bç¾¤ï¼ˆB1/B2/B6ï¼‰</span>ã€<span class="mono font-bold">éˆ£/é‚</span>ã€<span class="mono font-bold">å¾®é‡å…ƒç´ ï¼ˆç¢˜/ç¡’ï¼‰</span>ã€‚
            </div>
          </div>
        </section>

      </main>
    </div>

    <div id="toastWrap"></div>
  </div>

<script>
(() => {
  // ====== KV keys ======
  const Q_KEY = "AI_SURVEY:Q:life11";
  const KW_MAP_KEY = "AI_SURVEY:KW_MAP";

  // ====== Defaults ======
  const DEFAULT_LINE_NAME = "LINEä½¿ç”¨è€…åç¨±";
  const DEFAULT_LINE_ID   = "@line_id";
  const DEFAULT_LINE_AVATAR_URL = "https://i.pravatar.cc/150?img=12";

  const AGE_CHILD = "0~10 æ­² (å…’ç«¥)";
  const AGE_TEEN  = "11~18 æ­² (é’å°‘å¹´)";
  const AGE_ADULT = "19 æ­²ä»¥ä¸Š";

  const QUESTIONS = [
    { id:"q1",  type:"yn",  text:"æˆ‘ç¶“å¸¸åªæœ‰å…©é¤" },
    { id:"q2",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„è”¬èœå’Œæ°´æœå°‘æ–¼5ä»½ï¼ˆä»¥æˆäººæ‰‹æŒå¤§å°ç›¤å­ç‚ºæ¨™æº–ï¼‰" },
    { id:"q3",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„ç±³é£¯æˆ–éºµæ¢å°‘æ–¼1.5ç¢—" },
    { id:"q4",  type:"yn",  text:"æˆ‘æ¯å¤©å–çš„ä¹³è£½å“å°‘æ–¼1.5æ¯" },
    { id:"q5",  type:"yn",  text:"æˆ‘æ¯å¤©é£²ç”¨å’–å•¡æˆ–èŒ¶ï¼ˆè‡³å°‘å…©æ¯ï¼‰" },
    { id:"q6",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„è›‹ç™½è³ªé¡é£Ÿç‰©å°‘æ–¼5ä»½ï¼ˆä»¥æˆäººä¸‰æ ¹æ‰‹æŒ‡çš„é‡ç‚ºæ¨™æº–ï¼‰" },
    { id:"q7",  type:"yn",  text:"æˆ‘ç¶“å¸¸é£Ÿç”¨é«˜æº«ã€æ²¹ç‚¸æˆ–ç‡’ç…®çš„é£Ÿç‰©" },
    { id:"q8",  type:"yn",  text:"æˆ‘æœ‰å¸è¸ç¿’æ…£" },
    { id:"q9",  type:"yn",  text:"æˆ‘å¸¸ç¯€é£Ÿä»¥æ¸›è¼•é«”é‡" },
    { id:"q10", type:"sex", text:"æˆ‘çš„æ€§åˆ¥" },
    { id:"q11", type:"age", text:"æˆ‘çš„å¹´é½¡ç¯„åœ" },
  ];

  const LABEL = {
    vitA:"ç¶­ç”Ÿç´ A",
    vitB:"ç¶­ç”Ÿç´ Bç¾¤ï¼ˆB1/B2/B6ï¼‰",
    vitC:"ç¶­ç”Ÿç´ C",
    vitD:"ç¶­ç”Ÿç´ D",
    vitE:"ç¶­ç”Ÿç´ E",
    ca_mg:"éˆ£/é‚",
    iron:"éµ",
    fiber:"è†³é£Ÿçº–ç¶­",
    trace:"å¾®é‡å…ƒç´ ï¼ˆç¢˜/ç¡’ï¼‰",
  };
  const PCT_ORDER = ["vitA","vitB","vitC","vitD","vitE","ca_mg","iron","fiber","trace"];

  const DEDUCT_EXCEL_DEFAULT = {
    q1: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
    q2: { vitA:20, vitB:16, vitC:20, vitD:0,  vitE:16, ca_mg:0,  iron:0,  fiber:25, trace:16 },
    q3: { vitA:0,  vitB:17, vitC:0,  vitD:0,  vitE:17, ca_mg:0,  iron:16, fiber:25, trace:17 },
    q4: { vitA:20, vitB:17, vitC:0,  vitD:25, vitE:0,  ca_mg:25, iron:0,  fiber:0,  trace:0  },
    q5: { vitA:0,  vitB:0,  vitC:0,  vitD:0,  vitE:0,  ca_mg:25, iron:17, fiber:0,  trace:17 },
    q6: { vitA:0,  vitB:0,  vitC:0,  vitD:25, vitE:0,  ca_mg:0,  iron:17, fiber:0,  trace:16 },
    q7: { vitA:0,  vitB:16, vitC:20, vitD:0,  vitE:17, ca_mg:0,  iron:0,  fiber:0,  trace:0  },
    q8: { vitA:20, vitB:0,  vitC:20, vitD:0,  vitE:16, ca_mg:0,  iron:16, fiber:0,  trace:0  },
    q9: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
  };

  const TARGETS_EXCEL_DEFAULT = [
    { id:"vitA",   name:"ç¶­ç”Ÿç´ A", unit:"Âµg",  child:1500, teen:2500, adultF:3000, adultM:3000 },
    { id:"b1",     name:"ç¶­ç”Ÿç´ B1", unit:"mg", child:0.9,  teen:1.2,  adultF:0.9,  adultM:1.2 },
    { id:"b2",     name:"ç¶­ç”Ÿç´ B2", unit:"mg", child:1.0,  teen:1.3,  adultF:1.0,  adultM:1.3 },
    { id:"b6",     name:"ç¶­ç”Ÿç´ B6", unit:"mg", child:1.0,  teen:1.5,  adultF:1.5,  adultM:1.6 },
    { id:"vitC",   name:"ç¶­ç”Ÿç´ C", unit:"mg",  child:1200, teen:1800, adultF:2000, adultM:2000 },
    { id:"vitD",   name:"ç¶­ç”Ÿç´ D", unit:"Âµg",  child:50,   teen:50,   adultF:50,   adultM:50   },
    { id:"vitE",   name:"ç¶­ç”Ÿç´ E", unit:"mg",  child:300,  teen:800,  adultF:1000, adultM:1000 },
    { id:"ca",     name:"éˆ£",       unit:"mg",  child:1500, teen:2500, adultF:2500, adultM:2500 },
    { id:"mg",     name:"é‚",       unit:"mg",  child:250,  teen:350,  adultF:320,  adultM:380  },
    { id:"iron",   name:"éµ",       unit:"mg",  child:30,   teen:40,   adultF:45,   adultM:40   },
    { id:"fiber",  name:"çº–ç¶­",     unit:"g",   child:20,   teen:25,   adultF:27,   adultM:34   },
    { id:"iodine", name:"å¾®é‡(ç¢˜)", unit:"Âµg",  child:90,   teen:130,  adultF:150,  adultM:150  },
    { id:"selen",  name:"å¾®é‡(ç¡’)", unit:"Âµg",  child:30,   teen:55,   adultF:55,   adultM:55   },
  ];

  const $ = (id)=>document.getElementById(id);

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toast(msg, type="ok"){
    const wrap = $("toastWrap");
    const div = document.createElement("div");
    div.className = `card px-4 py-3 border ${
      type==="ok" ? "border-emerald-200" : type==="warn" ? "border-amber-200" : "border-rose-200"
    }`;
    div.style.borderRadius = "18px";
    div.innerHTML = `<div class="text-sm text-slate-950 font-black">${escapeHtml(msg)}</div>`;
    wrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }
  function showErr(e){
    $("errBanner").classList.remove("hidden");
    $("errText").textContent = String(e?.stack || e?.message || e || "");
  }
  function clearErr(){
    $("errBanner").classList.add("hidden");
    $("errText").textContent = "";
  }

  // ====== Tabs ======
  function setTab(tabId){
    document.querySelectorAll(".tab").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-tab")===tabId);
    });
    ["tab-preview","tab-cta","tab-targets"].forEach(id=>{
      const el = $(id);
      if(el) el.classList.toggle("hidden", id!==tabId);
    });
  }
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>setTab(b.getAttribute("data-tab")));
  });

  // ====== API ======
  function apiBase(){ return ($("inApiBase").value || "").trim().replace(/\/$/,""); }
  function adminKey(){ return ($("inAdminKey").value || "").trim(); }

  async function apiJson(path, bodyObj){
    const base = apiBase();
    if(!base) throw new Error("API Base ä¸å¯ç©ºç™½");
    const headers = { "Content-Type":"application/json" };
    const k = adminKey();
    if(k) headers["X-Admin-Key"] = k;

    const res = await fetch(base + path, {
      method:"POST",
      headers,
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }
  async function kvGet(key){
    const r = await apiJson("/loadAny", { namespace:"DB", keyword:key });
    return r?.payload ?? r;
  }
  async function kvPut(key, payload){
    await apiJson("/putAny", { namespace:"DB", keyword:key, payload });
  }

  let CONNECTED = false;
  function setConn(ok){
    CONNECTED = !!ok;
    $("txtLast").textContent = new Date().toLocaleString();
    const p1 = $("pillConn");
    const p2 = $("pillConn2");
    const cls = ok ? "pill pill-green" : "pill pill-rose";
    if(p1){ p1.className = cls; p1.textContent = ok ? "å·²é€£ç·š" : "æœªé€£ç·š"; }
    if(p2){ p2.className = cls; p2.textContent = ok ? "å·²é€£ç·š" : "æœªé€£ç·š"; }
  }
  async function connect(){
    clearErr();
    await apiJson("/listAll", {});
    setConn(true);
    toast("é€£ç·šæˆåŠŸ âœ…");
  }

  // ====== Survey payload ======
  let targetsRows = structuredClone(TARGETS_EXCEL_DEFAULT);

  function getAgeOpts(){ return [AGE_CHILD, AGE_TEEN, AGE_ADULT]; }
  function buildRules(){ return { yn_yes: structuredClone(DEDUCT_EXCEL_DEFAULT), sex: { "ç”·": {}, "å¥³": {} }, age: {} }; }

  function getTargetsObject(){
    const byId = {};
    targetsRows.forEach(r=>byId[r.id]=structuredClone(r));
    const pick = (rid, ageKey, sexKey) => {
      const r = byId[rid]; if(!r) return null;
      if(ageKey==="child") return r.child;
      if(ageKey==="teen") return r.teen;
      return (sexKey==="female") ? r.adultF : r.adultM;
    };
    const pack = (ageKey, sexKey) => {
      const vitB = `B1:${pick("b1",ageKey,sexKey)}mg, B2:${pick("b2",ageKey,sexKey)}mg, B6:${pick("b6",ageKey,sexKey)}mg`;
      const ca_mg = `éˆ£:${pick("ca",ageKey,sexKey)}mg, é‚:${pick("mg",ageKey,sexKey)}mg`;
      const trace = `ç¢˜:${pick("iodine",ageKey,sexKey)}Âµg, ç¡’:${pick("selen",ageKey,sexKey)}Âµg`;
      return {
        vitA: `${pick("vitA",ageKey,sexKey)}Âµg`,
        vitB,
        vitC: `${pick("vitC",ageKey,sexKey)}mg`,
        vitD: `${pick("vitD",ageKey,sexKey)}Âµg`,
        vitE: `${pick("vitE",ageKey,sexKey)}mg`,
        ca_mg,
        iron: `${pick("iron",ageKey,sexKey)}mg`,
        fiber: `${pick("fiber",ageKey,sexKey)}g`,
        trace,
      };
    };
    return {
      rows: structuredClone(targetsRows),
      combined: {
        child: pack("child","female"),
        teen: pack("teen","female"),
        adultFemale: pack("adult","female"),
        adultMale: pack("adult","male"),
      }
    };
  }

  function buildSurveyPayload(){
    const kw = ($("inKeyword").value || "").trim();
    if(!kw) throw new Error("è«‹å¡«ã€å•Ÿå‹•é—œéµå­—ã€");

    const ageOpts = getAgeOpts();
    const nodes = {};
    for(let i=0;i<QUESTIONS.length;i++){
      const q = QUESTIONS[i];
      const nextId = (QUESTIONS[i+1]) ? QUESTIONS[i+1].id : "";
      if(q.type === "yn"){
        nodes[q.id] = { q: q.text, type:"yn", options:[ {t:"æ˜¯",value:"æ˜¯",next:nextId}, {t:"ä¸æ˜¯",value:"ä¸æ˜¯",next:nextId} ] };
      } else if(q.type === "sex"){
        nodes[q.id] = { q: q.text, type:"sex", options:[ {t:"ç”·",value:"ç”·",next:nextId}, {t:"å¥³",value:"å¥³",next:nextId} ] };
      } else if(q.type === "age"){
        nodes[q.id] = { q: q.text, type:"age", options:[
          {t:ageOpts[0],value:ageOpts[0],next:nextId},
          {t:ageOpts[1],value:ageOpts[1],next:nextId},
          {t:ageOpts[2],value:ageOpts[2],next:nextId}
        ] };
      }
    }

    return {
      version: "life11-vUI-redesign-imagemap-editor",
      name: "life11",
      title: "ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï¼ˆ11é¡Œï¼‰",
      keyword: kw,
      start: "q1",
      rules: buildRules(),
      targetsExcel: getTargetsObject(),
      nodes,
      order: QUESTIONS.map(x=>x.id),
      nutrients: LABEL,
      ui: { ageOptions: { child: ageOpts[0], teen: ageOpts[1], adult: ageOpts[2] } }
    };
  }

  async function writeKV(){
    if(!CONNECTED) throw new Error("æœªé€£ç·šï¼Œä¸èƒ½å¯«å…¥ï¼ˆå…ˆæŒ‰ã€é€£ç·šã€ï¼‰");
    const payload = buildSurveyPayload();
    await kvPut(Q_KEY, payload);

    const kw = payload.keyword.trim();
    let map = {};
    try{
      const raw = await kvGet(KW_MAP_KEY);
      if(raw && typeof raw === "object") map = raw;
    }catch{ map = {}; }
    map[kw] = "life11";
    await kvPut(KW_MAP_KEY, map);
    toast("å·²å¯«å…¥ KV âœ…ï¼ˆå•å· + KW_MAP + è¦å‰‡ + æ”å–é‡ï¼‰");
  }

  // ====== Targets table ======
  function numOrText(v){
    if(v === "" || v === null || v === undefined) return "";
    const n = Number(v);
    return Number.isFinite(n) ? n : String(v);
  }
  function renderTargetsTable(){
    const tb = $("targetsTbody");
    tb.innerHTML = "";
    targetsRows.forEach(row=>{
      const tr = document.createElement("tr");
      tr.className = "border-b border-slate-100";
      tr.innerHTML = `
        <td class="p-2 font-black text-slate-950">${escapeHtml(row.name)}</td>
        <td class="p-2 text-slate-600">${escapeHtml(row.unit)}</td>
        <td class="p-2"><input data-col="child" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.child)}" /></td>
        <td class="p-2"><input data-col="teen" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.teen)}" /></td>
        <td class="p-2"><input data-col="adultF" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.adultF)}" /></td>
        <td class="p-2"><input data-col="adultM" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.adultM)}" /></td>
      `;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("input[data-id][data-col]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id = inp.getAttribute("data-id");
        const col = inp.getAttribute("data-col");
        const row = targetsRows.find(r=>r.id===id);
        if(!row) return;
        row[col] = numOrText(inp.value);
      });
    });
  }
  function resetTargets(){
    targetsRows = structuredClone(TARGETS_EXCEL_DEFAULT);
    renderTargetsTable();
    toast("å·²æ¢å¾©é è¨­");
  }

  // ====== Simulation UI ======
  const simState = {};
  function renderSim(){
    const [ageChild, ageTeen, ageAdult] = getAgeOpts();
    const wrap = $("simWrap");
    wrap.innerHTML = "";

    QUESTIONS.forEach((q, i)=>{
      const box = document.createElement("div");
      box.className = "card2 p-3";

      let optsHtml = "";
      if(q.type==="yn"){
        const v = simState[q.id] ?? "ä¸æ˜¯";
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            <button data-v="æ˜¯" class="btn ${v==="æ˜¯"?"btn-dark":"btn-soft"}">æ˜¯</button>
            <button data-v="ä¸æ˜¯" class="btn ${v==="ä¸æ˜¯"?"btn-dark":"btn-soft"}">ä¸æ˜¯</button>
          </div>`;
      }else if(q.type==="sex"){
        const v = simState[q.id] ?? "ç”·";
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            <button data-v="ç”·" class="btn ${v==="ç”·"?"btn-dark":"btn-soft"}">ç”·</button>
            <button data-v="å¥³" class="btn ${v==="å¥³"?"btn-dark":"btn-soft"}">å¥³</button>
          </div>`;
      }else if(q.type==="age"){
        const v = simState[q.id] ?? ageAdult;
        const opts = [ageChild, ageTeen, ageAdult];
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            ${opts.map(a => `
              <button data-v="${escapeHtml(a)}" class="btn ${v===a?"btn-dark":"btn-soft"}">${escapeHtml(a)}</button>
            `).join("")}
          </div>`;
      }

      box.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="text-[11px] text-slate-500">No.${i+1}/11</div>
          <span class="pill">é¸æ“‡</span>
        </div>
        <div class="mt-1 font-black text-slate-950">${escapeHtml(q.text)}</div>
        ${optsHtml}
      `;
      box.querySelectorAll("button[data-v]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          simState[q.id] = btn.getAttribute("data-v");
          renderSim();
          updatePreviewMeta();
        });
      });
      wrap.appendChild(box);
    });
    updatePreviewMeta();
  }

  function updatePreviewMeta(){
    const sex = simState.q10 ?? "ç”·";
    const age = simState.q11 ?? AGE_ADULT;
    $("previewMeta").textContent = `æ€§åˆ¥ï¼š${sex}ã€€å¹´é½¡ï¼š${age}`;
  }

  // ====== Calculate remain ======
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function getRemainFromSim(){
    const rules = buildRules();
    const ans = {};
    QUESTIONS.forEach(q=>{
      if(q.type==="yn")  ans[q.id] = simState[q.id] ?? "ä¸æ˜¯";
      if(q.type==="sex") ans[q.id] = simState[q.id] ?? "ç”·";
      if(q.type==="age") ans[q.id] = simState[q.id] ?? AGE_ADULT;
    });

    const deduct = {};
    Object.keys(rules.yn_yes).forEach(qid=>{
      if(ans[qid] === "æ˜¯"){
        const obj = rules.yn_yes[qid];
        for(const k in obj){
          deduct[k] = (deduct[k] || 0) + (Number(obj[k]) || 0);
        }
      }
    });

    const remain = {};
    PCT_ORDER.forEach(k=>{
      remain[k] = clamp(100 - (deduct[k]||0), 0, 100);
    });
    return { ans, remain };
  }

  // ====== Caps (numbers + unit only) ======
  function capPick(row, ans){
    const age = ans?.q11 || AGE_ADULT;
    const sex = ans?.q10 || "ç”·";
    const ageKey = age.includes("0~10") ? "child" : age.includes("11~18") ? "teen" : "adult";
    if(ageKey==="child") return row.child;
    if(ageKey==="teen") return row.teen;
    return (sex==="å¥³") ? row.adultF : row.adultM;
  }
  function capNumUnitForKey(key, ans){
    const byId = {};
    targetsRows.forEach(r=>byId[r.id]=r);
    const fmt = (v, unit) => (v === "" || v === null || v === undefined) ? "-" : `${v}${unit||""}`;

    if(key==="vitA"){ const r=byId.vitA; return r?fmt(capPick(r,ans), r.unit):"-"; }
    if(key==="vitC"){ const r=byId.vitC; return r?fmt(capPick(r,ans), r.unit):"-"; }
    if(key==="vitD"){ const r=byId.vitD; return r?fmt(capPick(r,ans), r.unit):"-"; }
    if(key==="vitE"){ const r=byId.vitE; return r?fmt(capPick(r,ans), r.unit):"-"; }
    if(key==="iron"){ const r=byId.iron; return r?fmt(capPick(r,ans), r.unit):"-"; }
    if(key==="fiber"){ const r=byId.fiber; return r?fmt(capPick(r,ans), r.unit):"-"; }

    if(key==="vitB"){
      const b1=byId.b1, b2=byId.b2, b6=byId.b6;
      if(!b1 || !b2 || !b6) return "-";
      const u = b1.unit || "mg";
      return `${capPick(b1,ans)}/${capPick(b2,ans)}/${capPick(b6,ans)}${u}`;
    }
    if(key==="ca_mg"){
      const ca=byId.ca, mg=byId.mg;
      if(!ca || !mg) return "-";
      const u = ca.unit || "mg";
      return `${capPick(ca,ans)}/${capPick(mg,ans)}${u}`;
    }
    if(key==="trace"){
      const io=byId.iodine, se=byId.selen;
      if(!io || !se) return "-";
      const u = io.unit || "Âµg";
      return `${capPick(io,ans)}/${capPick(se,ans)}${u}`;
    }
    return "-";
  }

  // ====== Report render ======
  function pctColor(p){
    if(p < 35) return "#ff4d4f";
    if(p < 70) return "#fbbf24";
    return "#34d399";
  }
  async function loadImg(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>resolve(img);
      img.onerror = ()=>reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š" + url));
      img.src = url;
    });
  }
  function roundRect(ctx, x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  function drawCircleAvatar(ctx, img, cx, cy, r){
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(img, cx - r, cy - r, r*2, r*2);
    ctx.restore();
  }
  function drawCover(ctx, img, x, y, w, h){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    const s = Math.max(w/iw, h/ih);
    const sw = iw * s;
    const sh = ih * s;
    const sx = x + (w - sw)/2;
    const sy = y + (h - sh)/2;
    ctx.drawImage(img, sx, sy, sw, sh);
  }

  let lastPngDataUrl = "";

  async function renderReportImage(){
    const bgUrl = ($("inBgUrl").value||"").trim();
    if(!bgUrl) throw new Error("è«‹å…ˆå¡«ã€åº•æ¿åœ–ç‰‡ URLã€");

    const ctaSrc = ($("inCtaSource").value||"").trim(); // can be url or dataURL

    const W = 900, H = 1600;
    const cv = $("cvReport");
    cv.width = W; cv.height = H;
    const ctx = cv.getContext("2d");

    const bg = await loadImg(bgUrl);
    ctx.drawImage(bg, 0, 0, W, H);

    const { ans, remain } = getRemainFromSim();

    const lineName = DEFAULT_LINE_NAME;
    const lineId = DEFAULT_LINE_ID;
    const avatarUrl = (($("inPreviewAvatarUrl")?.value || DEFAULT_LINE_AVATAR_URL) + "").trim() || DEFAULT_LINE_AVATAR_URL;

    // header (personal)
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "#000000";
    roundRect(ctx, 48, 48, W-96, 190, 46);
    ctx.fill();
    ctx.restore();

    try{
      const av = await loadImg(avatarUrl);
      drawCircleAvatar(ctx, av, 140, 140, 58);
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,.85)";
      ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.arc(140, 140, 60, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }catch{
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.20)";
      ctx.beginPath();
      ctx.arc(140, 140, 58, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    ctx.fillStyle = "rgba(255,255,255,.96)";
    ctx.textAlign = "left";
    ctx.font = "bold 44px Microsoft JhengHei, sans-serif";
    ctx.fillText(lineName, 230, 128);

    ctx.fillStyle = "rgba(255,255,255,.90)";
    ctx.font = "bold 26px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\",\"Courier New\", monospace";
    ctx.fillText(lineId, 230, 172);

    ctx.fillStyle = "rgba(255,255,255,.86)";
    ctx.font = "bold 22px Microsoft JhengHei, sans-serif";
    ctx.fillText(`æ€§åˆ¥ï¼š${ans.q10}   å¹´é½¡ï¼š${ans.q11}`, 230, 208);

    // nutrients (single row each)
    const listX = 56;
    const listY = 270;
    const listW = W - listX*2;
    const rowH = 68;
    const rowsGap = 10;

    ctx.save();
    ctx.globalAlpha = 0.14;
    ctx.fillStyle = "#0b122b";
    roundRect(ctx, 44, listY-14, W-88, (rowH+rowsGap)*PCT_ORDER.length - rowsGap + 28, 36);
    ctx.fill();
    ctx.restore();

    for(let i=0;i<PCT_ORDER.length;i++){
      const k = PCT_ORDER[i];
      const y = listY + i*(rowH+rowsGap);
      const pct = remain[k];
      const cap = capNumUnitForKey(k, ans);

      ctx.save();
      ctx.globalAlpha = 0.16;
      ctx.fillStyle = "#ffffff";
      roundRect(ctx, listX, y, listW, rowH, 20);
      ctx.fill();
      ctx.restore();

      ctx.strokeStyle = "rgba(255,255,255,.38)";
      ctx.lineWidth = 2;
      roundRect(ctx, listX, y, listW, rowH, 20);
      ctx.stroke();

      // name full
      ctx.textAlign = "left";
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = "bold 20px Microsoft JhengHei, sans-serif";
      ctx.fillText(LABEL[k] || k, listX+16, y+26);

      // cap big
      ctx.textAlign = "right";
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.font = "bold 22px Microsoft JhengHei, sans-serif";
      ctx.fillText(cap, listX+listW-16, y+28);

      // bar
      const barX = listX+16, barY = y+38, barW = listW-32, barH = 18;

      ctx.textAlign = "left";
      ctx.fillStyle = "rgba(255,255,255,.22)";
      roundRect(ctx, barX, barY, barW, barH, 9);
      ctx.fill();

      const fillW = Math.max(0, Math.min(barW, barW*(pct/100)));
      ctx.fillStyle = pctColor(pct);
      roundRect(ctx, barX, barY, fillW, barH, 9);
      ctx.fill();

      // pct in center of bar
      ctx.textAlign = "center";
      ctx.font = "bold 18px Microsoft JhengHei, sans-serif";
      ctx.fillStyle = "rgba(255,255,255,.96)";
      ctx.lineWidth = 4;
      ctx.strokeStyle = "rgba(0,0,0,.35)";
      ctx.strokeText(`${pct}%`, barX + barW/2, barY + 14);
      ctx.fillText(`${pct}%`, barX + barW/2, barY + 14);
    }

    // CTA at bottom
    const ctaX = 56;
    const ctaY = 950;
    const ctaW = W - ctaX*2;
    const ctaH = 600;

    ctx.save();
    ctx.globalAlpha = 0.14;
    ctx.fillStyle = "#0b122b";
    roundRect(ctx, ctaX, ctaY, ctaW, ctaH, 40);
    ctx.fill();
    ctx.restore();

    if(ctaSrc){
      try{
        const ctaImg = await loadImg(ctaSrc);
        ctx.save();
        roundRect(ctx, ctaX, ctaY, ctaW, ctaH, 40);
        ctx.clip();
        drawCover(ctx, ctaImg, ctaX, ctaY, ctaW, ctaH);
        ctx.restore();
      }catch{}
    }

    ctx.strokeStyle = "rgba(255,255,255,.45)";
    ctx.setLineDash([10,8]);
    ctx.lineWidth = 3;
    roundRect(ctx, ctaX+22, ctaY+22, ctaW-44, ctaH-44, 34);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.textAlign = "center";
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.font = "bold 22px Microsoft JhengHei, sans-serif";
    ctx.fillText("å¼•æµåœ–å€ï¼ˆå¯å¾å¼•æµåœ–åˆ†é å¥—ç”¨ï¼‰", ctaX + ctaW/2, ctaY + 60);

    lastPngDataUrl = cv.toDataURL("image/png");
    return lastPngDataUrl;
  }

  function downloadPng(){
    if(!lastPngDataUrl) throw new Error("è«‹å…ˆæŒ‰ã€ç”¢ç”Ÿåœ–ç‰‡ã€");
    const a = document.createElement("a");
    a.href = lastPngDataUrl;
    a.download = "nutrition_report.png";
    a.click();
  }

  // ====== Preview header ======
  function initPreviewLine(){
    $("previewName").textContent = DEFAULT_LINE_NAME;
    $("previewId").textContent = DEFAULT_LINE_ID;
    $("previewAvatar").src = ($("inPreviewAvatarUrl").value || DEFAULT_LINE_AVATAR_URL).trim() || DEFAULT_LINE_AVATAR_URL;
    updatePreviewMeta();
  }

  // =========================================================
  // âœ… å¼•æµåœ–ï¼ˆimagemapï¼‰ç·¨è¼¯å™¨ï¼šæ•´å¥—æ¬é€²ä¾†
  // =========================================================
  const imap = {
    images: [], // {url:'', areas:[{x,y,w,h,type,text}]} çš† 0~1
    current: -1,
    ZOOM: 1,
    isDrawing: false,
    sx: 0, sy: 0,
    previewRect: null,
    activePointerId: null
  };

  const elStage = $("imapStage");
  const elLayer = $("imapDrawLayer");
  const elImg = $("imapPreviewImage");
  const elList = $("imapImageList");
  const elAreaList = $("imapAreaList");
  const elEmpty = $("imapEmptyState");

  function normalizeWorkerUrl(raw){
    if(!raw) return '';
    let s = raw.trim();
    if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
    return s.replace(/\/+$/,'');
  }
  async function postJSON(url, data){
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${txt}`);
    }
    const ct = res.headers.get('content-type') || '';
    if(ct.includes('application/json')) return await res.json();
    return await res.text();
  }
  async function uploadToR2(workerBaseUrl, fileBlob, filename){
    const form = new FormData();
    form.append('file', fileBlob, filename || 'image.webp');
    const res = await fetch(workerBaseUrl + '/upload', { method:'POST', body: form });
    if(!res.ok){
      const t = await res.text().catch(()=> '');
      throw new Error(`HTTP ${res.status}\n${t}`);
    }
    const j = await res.json();
    if(!j.ok || !j.url) throw new Error('ä¸Šå‚³å›å‚³æ ¼å¼ä¸å°');
    return j.url;
  }

  function imapSizeModeSync(){
    const show = ($("imapSizeMode").value === 'custom');
    $("imapCustomWWrap").classList.toggle('hidden', !show);
    $("imapCustomHWrap").classList.toggle('hidden', !show);
  }
  $("imapSizeMode").addEventListener('change', imapSizeModeSync);

  $("imapQuality").addEventListener('input', ()=> $("imapQVal").textContent = $("imapQuality").value);

  function setZoom(v){
    imap.ZOOM = Math.max(0.5, Math.min(3, Number(v) || 1));
    elStage.style.transform = `scale(${imap.ZOOM})`;
    $("imapZoomRange").value = String(imap.ZOOM);
    $("imapZoomLabel").textContent = Math.round(imap.ZOOM * 100) + '%';
    refreshLayerSize();
  }
  $("imapZoomRange").addEventListener('input', ()=> setZoom($("imapZoomRange").value));
  $("imapZoom100").addEventListener('click', ()=> setZoom(1));
  $("imapZoom75").addEventListener('click', ()=> setZoom(0.75));
  $("imapZoom150").addEventListener('click', ()=> setZoom(1.5));

  elStage.parentElement?.addEventListener('wheel', (e) => {
    if(!(e.ctrlKey || e.altKey || e.shiftKey)) return;
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.08 : 0.08;
    setZoom((imap.ZOOM + delta).toFixed(2));
  }, { passive:false });

  function getTargetMaxWH(){
    const mode = $("imapSizeMode").value;
    let maxW = 1280, maxH = 1280;

    if(mode === 'line'){ maxW = 1280; maxH = 1280; }
    if(mode === 'hd'){ maxW = 1600; maxH = 1600; }
    if(mode === 'small'){ maxW = 960; maxH = 960; }
    if(mode === 'custom'){
      maxW = parseInt($("imapCustomW").value || '1280', 10);
      maxH = parseInt($("imapCustomH").value || '1280', 10);
    }

    const dpr = window.devicePixelRatio || 1;
    const vw = Math.max(320, Math.floor((elImg.clientWidth || 1280) * dpr));
    const vh = Math.max(320, Math.floor((elImg.clientHeight || 1280) * dpr));
    maxW = Math.min(maxW, vw);
    maxH = Math.min(maxH, vh);

    return { maxW, maxH };
  }

  async function compressImage(file, {maxW, maxH, mime, quality, cropSquare}){
    const img = await createImageBitmap(file);

    let sx = 0, sy = 0, sw = img.width, sh = img.height;
    if(cropSquare){
      const side = Math.min(img.width, img.height);
      sx = Math.floor((img.width - side) / 2);
      sy = Math.floor((img.height - side) / 2);
      sw = side; sh = side;
    }

    const scale = Math.min(1, maxW / sw, maxH / sh);
    const w = Math.max(1, Math.round(sw * scale));
    const h = Math.max(1, Math.round(sh * scale));

    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d', { alpha: true });
    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);

    const outBlob = await new Promise((resolve) => {
      if(mime === 'image/png') canvas.toBlob(resolve, mime);
      else canvas.toBlob(resolve, mime, quality);
    });
    if(!outBlob) throw new Error('å£“ç¸®å¤±æ•—ï¼ˆtoBlob ç©ºï¼‰');

    const ext = (mime === 'image/webp') ? 'webp' : (mime === 'image/jpeg') ? 'jpg' : 'png';
    const safeName = (file.name || 'image').replace(/\.[^/.]+$/, '');
    return { blob: outBlob, filename: `${safeName}.${ext}`, w, h };
  }

  function renderImageList(){
    elList.innerHTML = '';
    imap.images.forEach((img, idx) => {
      const div = document.createElement('div');
      div.className = `p-2 border rounded-2xl ${idx === imap.current ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'} cursor-pointer`;
      div.innerHTML = `
        <div class="flex justify-between mb-2">
          <span class="font-black text-xs">åœ–ç‰‡ ${idx+1}</span>
          <button class="text-rose-600 text-xs font-black" data-del="${idx}">âœ•</button>
        </div>
        ${img.url ? `<img src="${img.url}" class="w-full h-24 object-cover rounded-xl mb-2 border">`
                 : `<div class="w-full h-24 bg-gray-100 flex items-center justify-center text-xs text-gray-400 rounded-xl mb-2 border">ç„¡åœ–ç‰‡</div>`}
        <button class="w-full bg-indigo-600 text-white text-xs py-2 rounded-xl hover:bg-indigo-700 font-black" data-up="${idx}">
          ä¸Šå‚³åˆ° R2ï¼ˆå£“ç¸®ï¼‰
        </button>
        <div class="mt-1 text-[10px] text-gray-500 text-right">ç†±å€: ${img.areas.length}</div>
      `;
      div.addEventListener('click', ()=> selectImage(idx));
      div.querySelector('[data-del]')?.addEventListener('click', (e)=>{
        e.stopPropagation();
        removeImage(idx);
      });
      div.querySelector('[data-up]')?.addEventListener('click', (e)=>{
        e.stopPropagation();
        triggerUpload(idx, e.currentTarget);
      });
      elList.appendChild(div);
    });
  }

  function addImageBlock(){
    imap.images.push({ url:'', areas:[] });
    renderImageList();
    selectImage(imap.images.length - 1);
  }

  function removeImage(idx){
    imap.images.splice(idx, 1);
    renderImageList();
    selectImage(imap.images.length ? Math.min(idx, imap.images.length-1) : -1);
  }

  function selectImage(idx){
    imap.current = idx;

    if(idx === -1 || !imap.images[idx]){
      elImg.src = '';
      elEmpty.classList.remove('hidden');
      elAreaList.innerHTML = `<div class="text-xs text-slate-400">è«‹å¾å·¦å´æ–°å¢åœ–ç‰‡ã€‚</div>`;
      return;
    }

    elEmpty.classList.add('hidden');

    elImg.src = imap.images[idx].url || '';
    elImg.onload = () => {
      refreshLayerSize();
      renderAreas();
      renderAreaList();
    };

    renderImageList();
    renderAreas();
    renderAreaList();
  }

  function clearAreas(){
    if(imap.current < 0) return;
    if(confirm('ç¢ºå®šæ¸…ç©ºæœ¬åœ–å…¨éƒ¨æ¡†ï¼Ÿ')){
      imap.images[imap.current].areas = [];
      renderAreas(); renderAreaList(); renderImageList();
    }
  }

  function refreshLayerSize(){
    const w = elImg.naturalWidth || elImg.clientWidth || 0;
    const h = elImg.naturalHeight || elImg.clientHeight || 0;
    if(w && h){
      elImg.style.width = w + 'px';
      elImg.style.height = h + 'px';
      elLayer.style.width = w + 'px';
      elLayer.style.height = h + 'px';
    }
  }

  async function triggerUpload(idx, btnEl){
    const raw = $("imapWorkerUrl").value;
    const base = normalizeWorkerUrl(raw);
    if(!base) return alert('è«‹å…ˆå¡« WorkerUrlï¼ˆå³ä¸Šï¼‰');
    localStorage.setItem('line_worker_url', base);

    const input = $("imapFileInput");
    input.value = '';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if(!file) return;

      const oldText = btnEl.innerText;
      btnEl.innerText = "â³ å£“ç¸®+ä¸Šå‚³ä¸­...";
      btnEl.disabled = true;

      try{
        const mime = $("imapOutFormat").value;
        const quality = parseFloat($("imapQuality").value);
        const cropSquare = $("imapCropSquare").checked;
        const { maxW, maxH } = getTargetMaxWH();

        const { blob, filename } = await compressImage(file, { maxW, maxH, mime, quality, cropSquare });
        const url = await uploadToR2(base, blob, filename);

        imap.images[idx].url = url;
        imap.images[idx].areas = [];
        renderImageList();
        selectImage(idx);
        setZoom(1);
        toast("ä¸Šå‚³æˆåŠŸ âœ…");
      }catch(err){
        alert('ä¸Šå‚³å¤±æ•—ï¼š\n' + err.message);
      }

      btnEl.innerText = oldText;
      btnEl.disabled = false;
    };
    input.click();
  }

  function getLayerPointFromClient(clientX, clientY){
    const rect = elLayer.getBoundingClientRect();
    const x = (clientX - rect.left) / imap.ZOOM;
    const y = (clientY - rect.top) / imap.ZOOM;
    return { x, y };
  }

  function startDrawAt(clientX, clientY){
    const p = getLayerPointFromClient(clientX, clientY);
    imap.sx = p.x; imap.sy = p.y;

    imap.previewRect = document.createElement('div');
    imap.previewRect.className = 'draw-rect';
    imap.previewRect.style.left = imap.sx + 'px';
    imap.previewRect.style.top = imap.sy + 'px';
    imap.previewRect.style.width = '0px';
    imap.previewRect.style.height = '0px';
    elLayer.appendChild(imap.previewRect);
  }
  function moveDrawTo(clientX, clientY){
    if(!imap.isDrawing || !imap.previewRect) return;
    const p = getLayerPointFromClient(clientX, clientY);
    const cx = p.x, cy = p.y;

    const x = Math.min(imap.sx, cx);
    const y = Math.min(imap.sy, cy);
    const w = Math.abs(cx - imap.sx);
    const h = Math.abs(cy - imap.sy);

    imap.previewRect.style.left = x + 'px';
    imap.previewRect.style.top = y + 'px';
    imap.previewRect.style.width = w + 'px';
    imap.previewRect.style.height = h + 'px';
  }
  function endDrawAt(clientX, clientY){
    if(!imap.isDrawing) return;
    imap.isDrawing = false;

    const p = getLayerPointFromClient(clientX, clientY);
    const ex = p.x, ey = p.y;

    const x = Math.min(imap.sx, ex);
    const y = Math.min(imap.sy, ey);
    const w = Math.abs(ex - imap.sx);
    const h = Math.abs(ey - imap.sy);

    if(imap.previewRect){ imap.previewRect.remove(); imap.previewRect = null; }
    imap.activePointerId = null;

    if(w < 14 || h < 14) return;

    const baseW = elLayer.clientWidth;
    const baseH = elLayer.clientHeight;

    imap.images[imap.current].areas.push({
      x: x / baseW, y: y / baseH,
      w: w / baseW, h: h / baseH,
      type: 'message', text: ''
    });

    renderAreas();
    renderAreaList();
    renderImageList();
  }

  elLayer.addEventListener('pointerdown', (e) => {
    if(imap.current < 0) return;
    if(!imap.images[imap.current].url) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼ˆR2ï¼‰å†ç•«æ¡†');
    if(e.button !== 0) return;

    imap.isDrawing = true;
    imap.activePointerId = e.pointerId;
    elLayer.setPointerCapture(imap.activePointerId);

    startDrawAt(e.clientX, e.clientY);
    e.preventDefault();
  });
  elLayer.addEventListener('pointermove', (e) => {
    if(!imap.isDrawing) return;
    if(imap.activePointerId !== null && e.pointerId !== imap.activePointerId) return;
    moveDrawTo(e.clientX, e.clientY);
    e.preventDefault();
  });
  elLayer.addEventListener('pointerup', (e) => {
    if(imap.activePointerId !== null && e.pointerId !== imap.activePointerId) return;
    endDrawAt(e.clientX, e.clientY);
    e.preventDefault();
  });
  elLayer.addEventListener('pointercancel', () => {
    if(imap.previewRect){ imap.previewRect.remove(); imap.previewRect = null; }
    imap.isDrawing = false;
    imap.activePointerId = null;
  });
  window.addEventListener('blur', () => {
    if(imap.previewRect){ imap.previewRect.remove(); imap.previewRect = null; }
    imap.isDrawing = false;
    imap.activePointerId = null;
  });

  function renderAreas(){
    elLayer.querySelectorAll('.area-box').forEach(el => el.remove());
    if(imap.current < 0) return;

    imap.images[imap.current].areas.forEach((a, i) => {
      const d = document.createElement('div');
      d.className = 'area-box';
      d.style.left = (a.x*100)+'%';
      d.style.top  = (a.y*100)+'%';
      d.style.width  = (a.w*100)+'%';
      d.style.height = (a.h*100)+'%';
      d.innerText = i+1;

      d.onclick = (e) => {
        e.stopPropagation();
        if(confirm(`åˆªé™¤å€åŸŸ ${i+1}?`)){
          imap.images[imap.current].areas.splice(i, 1);
          renderAreas(); renderAreaList(); renderImageList();
        }
      };

      elLayer.appendChild(d);
    });
  }

  function renderAreaList(){
    elAreaList.innerHTML = '';
    if(imap.current < 0) {
      elAreaList.innerHTML = `<div class="text-xs text-slate-400">è«‹å…ˆæ–°å¢åœ–ç‰‡ã€‚</div>`;
      return;
    }

    const areas = imap.images[imap.current].areas;
    if(areas.length === 0){
      elAreaList.innerHTML = `<div class="text-xs text-slate-400">ç›®å‰æ²’æœ‰æ¡†ï¼Œå»åœ–ç‰‡ä¸Šæ‹–æ›³ç•«æ¡†ã€‚</div>`;
      return;
    }

    areas.forEach((a, i) => {
      const row = document.createElement('div');
      row.className = 'border rounded-2xl p-3 bg-white';
      row.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="font-black text-sm">æ¡† ${i+1}</div>
          <button class="text-xs text-rose-600 underline font-black" data-del>åˆªé™¤</button>
        </div>

        <div class="grid grid-cols-3 gap-2 text-xs">
          <label class="col-span-1 flex flex-col gap-1">
            <span class="text-slate-500 font-black">å‹•ä½œ</span>
            <select class="border rounded-xl px-2 py-2 bg-white">
              <option value="message" ${a.type==='message'?'selected':''}>ç™¼æ–‡å­—</option>
              <option value="uri" ${a.type==='uri'?'selected':''}>é–‹ç¶²é </option>
            </select>
          </label>

          <label class="col-span-2 flex flex-col gap-1">
            <span class="text-slate-500 font-black">å…§å®¹</span>
            <input class="border rounded-xl px-3 py-2" value="${escapeHtml(a.text||'')}"
              placeholder="${a.type==='uri'?'è²¼ç¶²å€ https://...':'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰'}">
          </label>
        </div>
      `;

      const delBtn = row.querySelector('[data-del]');
      const sel = row.querySelector('select');
      const input = row.querySelector('input');

      delBtn.onclick = () => {
        if(confirm(`åˆªé™¤æ¡† ${i+1}ï¼Ÿ`)){
          imap.images[imap.current].areas.splice(i, 1);
          renderAreas(); renderAreaList(); renderImageList();
        }
      };
      sel.onchange = () => {
        a.type = sel.value;
        input.placeholder = a.type === 'uri' ? 'è²¼ç¶²å€ https://...' : 'å¡«å…¥é—œéµå­—ï¼ˆè¨Šæ¯ï¼‰';
      };
      input.oninput = () => a.text = input.value;

      elAreaList.appendChild(row);
    });
  }

  function assertAreasFilled(){
    if(imap.images.length === 0) return "è‡³å°‘æ–°å¢ä¸€å¼µåœ–ç‰‡";
    if(imap.images.some(i => !i.url)) return "æœ‰åœ–ç‰‡å°šæœªä¸Šå‚³åˆ° R2";
    if(imap.images.some(img => img.areas.some(a => !String(a.text||'').trim()))) return "æœ‰æ¡†æ²’æœ‰å¡«å…§å®¹ï¼ˆé—œéµå­—æˆ–ç¶²å€ï¼‰";
    return "";
  }

  function buildImagemapMessages(){
    return Promise.all(imap.images.map(img => new Promise((resolve) => {
      const im = new Image();
      im.onload = () => {
        const baseW = 1040;
        const ratio = im.naturalHeight / im.naturalWidth;
        const baseH = Math.round(baseW * ratio);

        const actions = img.areas.map(a => ({
          type: a.type,
          text: a.type === 'message' ? a.text : undefined,
          linkUri: a.type === 'uri' ? a.text : undefined,
          area: {
            x: Math.round(a.x * baseW),
            y: Math.round(a.y * baseH),
            width: Math.round(a.w * baseW),
            height: Math.round(a.h * baseH)
          }
        }));

        resolve({
          type: "imagemap",
          baseUrl: img.url,
          altText: "é¸å–®",
          baseSize: { width: baseW, height: baseH },
          actions
        });
      };
      im.onerror = () => resolve({
        type: "imagemap",
        baseUrl: img.url,
        altText: "é¸å–®",
        baseSize: { width: 1040, height: 1040 },
        actions: []
      });
      im.src = img.url;
    })));
  }

  function getDraftKey(){ return "imagemap_draft_v1"; }

  async function saveSettingsUI(forceNew){
    const err = assertAreasFilled();
    if(err) return alert(err);

    const raw = $("imapWorkerUrl").value;
    const base = normalizeWorkerUrl(raw);
    let keyword = $("imapKeyword").value.trim();

    // æ²’å¡« keywordï¼šå­˜æœ¬æ©Ÿè‰ç¨¿
    if(!keyword){
      const messages = await buildImagemapMessages();
      localStorage.setItem(getDraftKey(), JSON.stringify({ messages, savedAt: Date.now() }));
      return alert('å·²å„²å­˜åˆ°æœ¬æ©Ÿè‰ç¨¿ï¼ˆæœªå¡«é—œéµå­—ï¼‰ã€‚');
    }

    // æœ‰å¡« keywordï¼šèµ° Worker /save
    if(!base) return alert('ä½ æœ‰å¡«é—œéµå­—ï¼Œæ‰€ä»¥ WorkerUrl ä¹Ÿå¿…é ˆå¡«ï¼Œæ‰èƒ½å­˜åˆ°é›²ç«¯ã€‚');
    localStorage.setItem('line_worker_url', base);

    // å¦å­˜æ–°æª”ï¼šé¿å…è¦†è“‹
    if(forceNew){
      const suffix = new Date().toISOString().slice(0,10).replaceAll('-','') + '_' + Math.random().toString(36).slice(2,6);
      keyword = `${keyword}_${suffix}`;
      $("imapKeyword").value = keyword;
    }

    try{
      const messages = await buildImagemapMessages();
      await postJSON(base + '/save', {
        keyword,
        payload:{ mode:'imagemap', messages }
      });
      alert('å„²å­˜æˆåŠŸï¼ï¼ˆé›²ç«¯ï¼‰');
    }catch(e){
      alert('å„²å­˜å¤±æ•—ï¼š\n' + e.message);
    }
  }

  async function loadSettingsUI(){
    const raw = $("imapWorkerUrl").value;
    const base = normalizeWorkerUrl(raw);
    const keyword = $("imapKeyword").value.trim();

    // æ²’å¡« keywordï¼šè®€æœ¬æ©Ÿè‰ç¨¿
    if(!keyword){
      const rawDraft = localStorage.getItem(getDraftKey());
      if(!rawDraft) return alert('æœ¬æ©Ÿæ²’æœ‰è‰ç¨¿ï¼ˆè«‹å…ˆæŒ‰ã€Œå„²å­˜ã€ä¸”ä¸å¡«é—œéµå­—ï¼‰ã€‚');
      let obj;
      try{ obj = JSON.parse(rawDraft); }catch{ obj = null; }
      if(!obj?.messages || !Array.isArray(obj.messages)) return alert('æœ¬æ©Ÿè‰ç¨¿æ ¼å¼æå£ã€‚');

      imap.images = obj.messages.map(m => {
        const bw = m.baseSize?.width || 1040;
        const bh = m.baseSize?.height || 1040;
        return {
          url: m.baseUrl,
          areas: (m.actions || []).map(a => ({
            type: a.type,
            text: a.type === 'message' ? (a.text || '') : (a.linkUri || ''),
            x: (a.area.x || 0) / bw,
            y: (a.area.y || 0) / bh,
            w: (a.area.width || 0) / bw,
            h: (a.area.height || 0) / bh
          }))
        };
      });

      renderImageList();
      selectImage(imap.images.length ? 0 : -1);
      setZoom(1);
      return alert('å·²è®€å–æœ¬æ©Ÿè‰ç¨¿ã€‚');
    }

    // æœ‰ keywordï¼šèµ° Worker /load
    if(!base) return alert('è«‹å…ˆå¡« WorkerUrl');
    localStorage.setItem('line_worker_url', base);

    try{
      const data = await postJSON(base + '/load', { keyword });
      const obj = (typeof data === 'string') ? JSON.parse(data) : data;

      if(!obj.messages || !Array.isArray(obj.messages)){
        return alert('è®€åˆ°è³‡æ–™ä½†æ ¼å¼ä¸å°ï¼ˆæ²’æœ‰ messagesï¼‰');
      }

      imap.images = obj.messages.map(m => {
        const bw = m.baseSize?.width || 1040;
        const bh = m.baseSize?.height || 1040;
        return {
          url: m.baseUrl,
          areas: (m.actions || []).map(a => ({
            type: a.type,
            text: a.type === 'message' ? (a.text || '') : (a.linkUri || ''),
            x: (a.area.x || 0) / bw,
            y: (a.area.y || 0) / bh,
            w: (a.area.width || 0) / bw,
            h: (a.area.height || 0) / bh
          }))
        };
      });

      renderImageList();
      selectImage(imap.images.length ? 0 : -1);
      setZoom(1);
      alert('è®€å–æˆåŠŸï¼ï¼ˆé›²ç«¯ï¼‰');
    }catch(e){
      alert('è®€å–å¤±æ•—ï¼š\n' + e.message);
    }
  }

  // ====== Hook main UI events ======
  $("btnConnect").addEventListener("click", async ()=>{
    try{ await connect(); }
    catch(e){ setConn(false); showErr(e); toast("é€£ç·šå¤±æ•—","err"); }
  });

  $("btnWrite").addEventListener("click", async ()=>{
    try{ clearErr(); await writeKV(); }
    catch(e){ showErr(e); toast(e.message || "å¯«å…¥å¤±æ•—","err"); }
  });

  $("btnSimAllGood").addEventListener("click", ()=>{
    ["q1","q2","q3","q4","q5","q6","q7","q8","q9"].forEach(id=>simState[id]="ä¸æ˜¯");
    simState.q10="ç”·";
    simState.q11=AGE_ADULT;
    renderSim();
    toast("å·²å¡«å…¥ã€éƒ½å¾ˆå¥åº·ã€");
  });

  $("btnSimAllYes").addEventListener("click", ()=>{
    ["q1","q2","q3","q4","q5","q6","q7","q8","q9"].forEach(id=>simState[id]="æ˜¯");
    simState.q10="ç”·";
    simState.q11=AGE_ADULT;
    renderSim();
    toast("å·²å¡«å…¥ã€å…¨éƒ¨é¸æ˜¯ã€");
  });

  $("btnApplyPreviewAvatar").addEventListener("click", ()=>{
    const u = ($("inPreviewAvatarUrl").value||"").trim() || DEFAULT_LINE_AVATAR_URL;
    $("previewAvatar").src = u;
    toast("å·²å¥—ç”¨é è¦½é ­åƒ âœ…");
  });

  $("btnRandPreviewAvatar").addEventListener("click", ()=>{
    const n = Math.floor(Math.random()*70)+1;
    const u = `https://i.pravatar.cc/150?img=${n}`;
    $("inPreviewAvatarUrl").value = u;
    $("previewAvatar").src = u;
    toast("å·²æ›´æ›éš¨æ©Ÿé ­åƒ âœ…");
  });

  $("btnRenderImg").addEventListener("click", async ()=>{
    try{
      clearErr();
      await renderReportImage();
      toast("å·²ç”¢ç”Ÿåœ–ç‰‡ âœ…");
    }catch(e){
      showErr(e);
      toast(e.message || "ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—","err");
    }
  });

  $("btnDownloadImg").addEventListener("click", ()=>{
    try{ downloadPng(); toast("å·²ä¸‹è¼‰ PNG âœ…"); }
    catch(e){ toast(e.message || "ä¸‹è¼‰å¤±æ•—","warn"); }
  });

  $("btnResetTargets").addEventListener("click", resetTargets);

  $("btnCopyTargetsJson").addEventListener("click", async ()=>{
    try{
      const obj = getTargetsObject();
      await navigator.clipboard.writeText(JSON.stringify(obj, null, 2));
      toast("å·²è¤‡è£½ Targets JSON âœ…");
    }catch{
      toast("è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰", "warn");
    }
  });

  // ====== Imagemap editor hooks ======
  $("imapAddImage").addEventListener('click', addImageBlock);
  $("imapClearAreas").addEventListener('click', clearAreas);
  $("imapUploadBtn").addEventListener('click', ()=>{
    if(imap.current < 0) return alert("è«‹å…ˆæ–°å¢åœ–ç‰‡");
    triggerUpload(imap.current, $("imapUploadBtn"));
  });

  $("btnIMapLoad").addEventListener('click', loadSettingsUI);
  $("btnIMapSave").addEventListener('click', ()=>saveSettingsUI(false));
  $("btnIMapSaveAs").addEventListener('click', ()=>saveSettingsUI(true));

  $("btnApplyToPreview").addEventListener('click', ()=>{
    if(imap.current < 0 || !imap.images[imap.current]?.url){
      return toast("æ²’æœ‰å¯å¥—ç”¨çš„åœ–ç‰‡ï¼ˆå…ˆä¸Šå‚³åˆ° R2ï¼‰", "warn");
    }
    $("inCtaSource").value = imap.images[imap.current].url;
    toast("å·²å¥—ç”¨åˆ°ã€é è¦½/ç”¢åœ–ã€ âœ…");
    setTab("tab-preview");
  });

  $("btnCopyImagemapJson").addEventListener('click', async ()=>{
    try{
      const err = assertAreasFilled();
      if(err) return toast(err, "warn");
      const messages = await buildImagemapMessages();
      await navigator.clipboard.writeText(JSON.stringify({ mode:"imagemap", messages }, null, 2));
      toast("å·²è¤‡è£½ imagemap JSON âœ…");
    }catch(e){
      toast(e.message || "è¤‡è£½å¤±æ•—", "warn");
    }
  });

  // Preview tab: use editor image url
  $("btnUseCtaFromEditor").addEventListener("click", ()=>{
    if(imap.current < 0 || !imap.images[imap.current]?.url){
      return toast("ç·¨è¼¯å™¨ç›®å‰æ²’æœ‰åœ–ç‰‡ URLï¼ˆå…ˆä¸Šå‚³åˆ° R2ï¼‰", "warn");
    }
    $("inCtaSource").value = imap.images[imap.current].url;
    toast("å·²å¥—ç”¨ç·¨è¼¯å™¨çš„å¼•æµåœ– âœ…");
    setTab("tab-preview");
  });

  $("btnClearCtaSource").addEventListener("click", ()=>{
    $("inCtaSource").value = "";
    toast("å·²æ¸…é™¤å¼•æµåœ–", "warn");
  });

  // ===== init =====
  function safeDefaultSim(){
    ["q1","q2","q3","q4","q5","q6","q7","q8","q9"].forEach(id=>simState[id]="ä¸æ˜¯");
    simState.q10="ç”·";
    simState.q11=AGE_ADULT;
  }

  // restore workerUrl for imap editor
  const savedUrl = localStorage.getItem('line_worker_url');
  if(savedUrl) $("imapWorkerUrl").value = savedUrl;

  safeDefaultSim();
  initPreviewLine();
  renderSim();
  renderTargetsTable();
  setConn(false);

  // init imap editor
  imapSizeModeSync();
  $("imapQVal").textContent = $("imapQuality").value;
  setZoom(1);
  renderImageList();
  selectImage(-1);
})();
</script>
</body>
</html>
