<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï½œä¸­æ§å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0b1220;
      --muted:#5b6b87;
      --bd:rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.82);
      --glass2: rgba(255,255,255,.70);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
      --shadow2: 0 8px 22px rgba(2,6,23,.08);
      --ring: 0 0 0 5px rgba(99,102,241,.14);
    }
    body{
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,.20), transparent 60%),
        radial-gradient(900px 520px at 90% 18%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 520px at 40% 92%, rgba(236,72,153,.14), transparent 60%),
        linear-gradient(135deg, #fbfdff, #f1f6ff 35%, #ecfeff);
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .card{
      background: var(--glass);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.08);
    }
    .card-soft{
      background: var(--glass2);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      border: 1px solid rgba(15,23,42,.08);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .thinbar::-webkit-scrollbar{ height:10px; width:10px; }
    .thinbar::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.20); border-radius: 999px; }
    table th, table td { vertical-align: middle; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:.5rem; border-radius: 16px; padding:.72rem 1rem;
      font-weight:900; font-size:13px;
      transition: transform .08s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-primary{
      color:#fff;
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(16,185,129,1));
      box-shadow: 0 14px 28px rgba(99,102,241,.20);
    }
    .btn-primary:hover{ filter: brightness(1.04); }
    .btn-dark{
      color:#fff;
      background: linear-gradient(135deg, #0b1220, #111827);
      box-shadow: 0 12px 24px rgba(2,6,23,.18);
    }
    .btn-dark:hover{ filter: brightness(1.03); }
    .btn-soft{
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(15,23,42,.12);
      color: #0b1220;
      box-shadow: 0 10px 20px rgba(2,6,23,.06);
    }
    .btn-soft:hover{ background: rgba(255,255,255,.98); border-color: rgba(99,102,241,.25); box-shadow: 0 14px 26px rgba(2,6,23,.08); }
    .btn-emerald{
      color:#fff;
      background: linear-gradient(135deg, #10b981, #22c55e);
      box-shadow: 0 14px 28px rgba(16,185,129,.18);
    }
    .btn-emerald:hover{ filter: brightness(1.03); }
    .btn-indigo{
      color:#fff;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 14px 28px rgba(99,102,241,.18);
    }
    .btn-indigo:hover{ filter: brightness(1.03); }
    .btn-mini{ border-radius: 14px; padding: .55rem .8rem; font-size: 12px; font-weight: 900; }
    .btn-disabled{ opacity:.45; pointer-events:none; }

    .in{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.82);
      padding: .78rem 1rem;
      outline: none;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    .in:focus{
      border-color: rgba(99,102,241,.35);
      box-shadow: var(--ring);
      background: rgba(255,255,255,.96);
    }
    .in-mini{ border-radius: 14px; padding: .62rem .9rem; }

    .hero{
      background: linear-gradient(135deg, rgba(255,255,255,.70), rgba(255,255,255,.52));
      border: 1px solid rgba(15,23,42,.08);
      box-shadow: 0 14px 40px rgba(2,6,23,.08);
      backdrop-filter: blur(14px);
    }

    .pill{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .55rem;
      border-radius:999px;
      font-weight:800;
      font-size:11px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
      color: rgba(2,6,23,.72);
    }
    .pill-green{ border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.10); color: rgba(5,150,105,1); }
    .pill-indigo{ border-color: rgba(99,102,241,.25); background: rgba(99,102,241,.10); color: rgba(79,70,229,1); }
    .pill-rose{ border-color: rgba(244,63,94,.25); background: rgba(244,63,94,.10); color: rgba(190,18,60,1); }

    @media (min-width: 1024px){
      .sticky-left{ position: sticky; top: 14px; align-self: start; }
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-3 md:p-6">

    <header class="hero rounded-3xl p-4 md:p-5 mb-3">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <div class="flex items-center gap-2 flex-wrap">
            <h1 class="text-2xl md:text-3xl font-black text-slate-950 tracking-tight">ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï½œä¸­æ§å°</h1>
            <span class="pill pill-indigo">å ±å‘Šå…§å«æŒ‰éˆ•</span>
            <span class="pill pill-green">å¯åŒ¯å‡ºé»æ“Šå€JSON</span>
          </div>
          <p class="text-sm text-slate-600 mt-1 leading-6">
            ä¸€éµå¯«å…¥ KVï¼ˆå•å·/è¦å‰‡/æ”å–é‡ï¼‰ï¼‹ ç”¢ç”Ÿåœ–ç‰‡ç‰ˆç‡Ÿé¤Šå ±å‘Š PNGï¼ˆé•·æ¢ä¸‹æ–¹ç›´æ¥ç•«ã€Œè³¼è²·æŒ‰éˆ•ã€ï¼‰ã€‚
          </p>
        </div>

        <div class="text-xs text-slate-600 leading-6">
          <div class="font-extrabold">éœ€è¦ Worker APIï¼š</div>
          <div class="mono">POST /listAll /putAny /loadAny /upload</div>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
        <div class="flex items-center gap-2 text-xs">
          <span class="pill pill-rose" id="pillConn">æœªé€£ç·š</span>
          <span class="pill">æœ€å¾Œæ¸¬è©¦ï¼š<span id="txtLast" class="mono ml-1">-</span></span>
        </div>
        <div class="text-[11px] text-slate-500">
          KVï¼š<span class="mono font-bold">AI_SURVEY:Q:life11</span>ï½œ<span class="mono font-bold">AI_SURVEY:KW_MAP</span>ï½œ<span class="mono font-bold">AI_SURVEY:LINKS:life11</span>
        </div>
      </div>
    </header>

    <section class="card rounded-3xl p-4 md:p-5 mb-3">
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="text-xs font-extrabold text-slate-600">Worker APIï¼ˆå›ºå®šï¼‰</label>
          <input id="inApiBase" class="in mono mt-1" value="https://api.zxcv8096.workers.dev/" />
        </div>

        <div>
          <label class="text-xs font-extrabold text-slate-600">Admin Keyï¼ˆå¯ç©ºç™½ï¼‰</label>
          <input id="inAdminKey" class="in mono mt-1" placeholder="è‹¥ Worker æœ‰é©—è­‰æ‰éœ€è¦å¡«" />
        </div>

        <div class="md:col-span-3 flex gap-2">
          <button id="btnConnect" class="btn btn-dark w-full">é€£ç·šæª¢æŸ¥</button>
          <button id="btnWrite" class="btn btn-emerald w-full">ä¸€éµå¯«å…¥KV</button>
          <!-- âœ… æ–°å¢ï¼šä¸€éµç™¼ä½ˆï¼ˆä¿ç•™ä½ åŸæœ¬æ‰€æœ‰æŒ‰éˆ•ä¸ç ï¼‰ -->
          <button id="btnPublish" class="btn btn-primary w-full">ğŸš€ ä¸€éµç™¼ä½ˆ</button>
        </div>

        <div class="md:col-span-3 flex flex-wrap gap-2 pt-1">
          <!-- âœ… æ–°å¢ï¼šé€£çµåŒæ­¥ KV çš„è¼‰å…¥/å„²å­˜ï¼Œä¸å½±éŸ¿ä½ åŸæœ¬ localStorage -->
          <button id="btnLoadLinksKV" class="btn btn-soft btn-mini">å¾ KV è®€å–è³¼è²·é€£çµ</button>
          <button id="btnSaveLinksKV" class="btn btn-soft btn-mini">æŠŠè³¼è²·é€£çµå­˜åˆ° KV</button>
          <span class="pill">è³¼è²·é€£çµï¼šlocalStorage + KVï¼ˆå¯åŒæ­¥ï¼‰</span>
        </div>
      </div>

      <div id="errBanner" class="hidden mt-3 rounded-2xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
        <div class="font-extrabold">éŒ¯èª¤</div>
        <div id="errText" class="mt-1 mono text-[12px] whitespace-pre-wrap"></div>
      </div>
    </section>

    <div class="grid lg:grid-cols-3 gap-3">
      <!-- LEFT -->
      <div class="space-y-3 sticky-left">
        <section class="card rounded-3xl p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-lg font-black text-slate-950">â‘  å•å·è¨­å®š</h2>
            <span class="pill">æ‰£åˆ†æ¨¡å‹ï¼šå›ºå®š</span>
          </div>

          <div class="mt-3 grid gap-3">
            <div class="card-soft rounded-3xl p-4">
              <label class="text-xs font-extrabold text-slate-600">å•Ÿå‹•é—œéµå­—ï¼ˆLINE ä½¿ç”¨è€…è¼¸å…¥é€™å€‹é–‹å§‹ï¼‰</label>
              <input id="inKeyword" class="in mt-1" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»ç‡Ÿé¤Š" />
              <div class="text-[11px] text-slate-500 mt-2 leading-5">
                å¯«å…¥ <span class="mono font-bold">AI_SURVEY:KW_MAP</span>ï¼š<span class="mono">{"é—œéµå­—":"life11"}</span>
              </div>
            </div>

            <div class="rounded-3xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900 leading-6">
              <div class="font-extrabold">è¦å‰‡èªªæ˜</div>
              <div>â€¢ å¾ 100% é–‹å§‹ï¼Œç­”ã€Œæ˜¯ã€å°±æ‰£åˆ†ï¼›è‡ªå‹•å¤¾åˆ° 0ï½100%ã€‚</div>
              <div>â€¢ åœ–ç‰‡å ±å‘Šï¼šé•·æ¢åœ–ä¸‹æ–¹æœƒç›´æ¥ç•«ã€Œè³¼è²·æŒ‰éˆ•ã€ï¼Œå†åŒ¯å‡ºé»æ“Šå€çµ¦ä½ åš imagemapã€‚</div>
              <div class="mt-2 font-extrabold">ğŸš€ ä¸€éµç™¼ä½ˆæœƒåšï¼š</div>
              <div>â‘  å¯«å…¥å•å·/è¦å‰‡/åƒè€ƒå€¼ â†’ KV</div>
              <div>â‘¡ åŒæ­¥è³¼è²·é€£çµ â†’ KV</div>
              <div>â‘¢ ç«‹åˆ»ç”¢ç”Ÿ PNG + è‡ªå‹•åŒ¯å‡ºé»æ“Šå€ JSON</div>
            </div>

            <div class="card-soft rounded-3xl p-4">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="text-sm font-black text-slate-950">å¿«é€Ÿæ“ä½œ</div>
                  <div class="text-[11px] text-slate-500 mt-1">å¸¸ç”¨æŒ‰éˆ•é›†ä¸­</div>
                </div>
                <span class="pill pill-indigo">å¿«æ·</span>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-2">
                <button id="btnSimAllGood" class="btn btn-soft w-full">éƒ½å¾ˆå¥åº·</button>
                <button id="btnSimAllYes" class="btn btn-soft w-full">å…¨éƒ¨é¸æ˜¯</button>
                <button id="btnRenderImg" class="btn btn-dark w-full">ç”¢ç”Ÿåœ–ç‰‡</button>
                <button id="btnDownloadImg" class="btn btn-soft w-full">ä¸‹è¼‰PNG</button>
              </div>
              <div class="mt-2 grid grid-cols-2 gap-2">
                <button id="btnExportAreas" class="btn btn-indigo w-full">åŒ¯å‡ºé»æ“Šå€JSON</button>
                <button id="btnCopyAreas" class="btn btn-soft w-full">è¤‡è£½JSON</button>
              </div>
              <textarea id="outAreas" class="in mono mt-2 h-28 text-[12px]" placeholder="åŒ¯å‡ºå¾Œæœƒå‡ºç¾åœ¨é€™è£¡ï¼ˆå«æŒ‰éˆ•åº§æ¨™ + é€£çµï¼‰"></textarea>
            </div>
          </div>
        </section>

        <!-- Links editor -->
        <section class="card rounded-3xl p-4 md:p-5">
          <div class="flex items-end justify-between gap-2">
            <div>
              <h2 class="text-lg font-black text-slate-950">è³¼è²·é é¢é€£çµè¨­å®š</h2>
              <p class="text-sm text-slate-600 mt-1">é€™äº›é€£çµæœƒç¶å®šåˆ°ã€Œå ±å‘Šåœ–ç‰‡å…§ã€çš„æŒ‰éˆ•ã€‚</p>
            </div>
            <div class="flex gap-2">
              <button id="btnSaveLinks" class="btn btn-emerald btn-mini">å„²å­˜</button>
              <button id="btnClearLinks" class="btn btn-soft btn-mini">æ¸…ç©º</button>
            </div>
          </div>

          <div class="mt-3 space-y-2" id="linksEditor"></div>
          <div class="mt-3 text-[11px] text-slate-500 leading-5">
            â€» PNG å…§åªæ˜¯ç•«å‡ºæŒ‰éˆ•å¤–è§€ï¼›è¦èƒ½é»æ“Šè«‹ç”¨ã€ŒåŒ¯å‡ºé»æ“Šå€JSONã€å»åšå¼•æµåœ–/LINE imagemap é»æ“Šå€ã€‚<br/>
            â€» é€™è£¡é è¨­å­˜ localStorageï¼›ä½ ä¹Ÿå¯ä»¥ç”¨ä¸Šæ–¹æŒ‰éˆ•åŒæ­¥åˆ° KVï¼ˆæ¨è–¦ï¼‰ã€‚
          </div>
        </section>
      </div>

      <!-- RIGHT -->
      <div class="lg:col-span-2 space-y-3">
        <section class="card rounded-3xl p-4 md:p-5">
          <div class="flex items-end justify-between gap-2">
            <div>
              <h2 class="text-lg font-black text-slate-950">â‘¡ é è¦½èˆ‡æ¨¡æ“¬</h2>
              <p class="text-sm text-slate-600 mt-1">åªåšåœ–ç‰‡å ±å‘Š PNGï¼ˆå›ºå®šé è¨­é¡¯ç¤ºæ¨£å¼ï¼‰ã€‚</p>
            </div>
            <span class="pill pill-indigo">æ¨¡æ“¬</span>
          </div>

          <div class="mt-3 grid gap-3 md:grid-cols-2">
            <div class="card-soft rounded-3xl p-4">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="text-sm font-black text-slate-950">11 é¡Œï¼ˆç…§åœ–ä¸æ”¹å­—ï¼‰</div>
                  <div class="text-[11px] text-slate-500 mt-1">æ˜¯/ä¸æ˜¯ã€æ€§åˆ¥ã€å¹´é½¡</div>
                </div>
                <span class="pill">é¸æ“‡</span>
              </div>
              <div id="simWrap" class="mt-3 space-y-2 max-h-[420px] overflow-auto thinbar pr-1"></div>
            </div>

            <div class="space-y-3">
              <div class="card-soft rounded-3xl p-4">
                <div class="flex items-end justify-between gap-2">
                  <div>
                    <div class="text-sm font-black text-slate-950">å ±å‘Šé è¨­é¡¯ç¤ºæ¨£å¼</div>
                    <div class="text-[11px] text-slate-500 mt-1">åƒ…é è¦½ï¼›æ­£å¼ç”± LINE è‡ªå‹•å¸¶å…¥ï¼ˆä¸åœ¨æ­¤åŒ¯å…¥ï¼‰ã€‚</div>
                  </div>
                  <span class="pill">é è¨­</span>
                </div>

                <div class="mt-3 flex items-center gap-3">
                  <div class="relative">
                    <div class="absolute -inset-1 rounded-full bg-gradient-to-br from-indigo-400/50 to-emerald-400/50 blur"></div>
                    <img id="previewAvatar" src="https://i.pravatar.cc/150?img=12"
                         class="relative w-14 h-14 rounded-full border border-white/60 shadow" alt="avatar"/>
                  </div>
                  <div class="min-w-0">
                    <div id="previewName" class="font-black text-slate-950 truncate">LINEä½¿ç”¨è€…åç¨±</div>
                    <div id="previewId" class="text-sm text-slate-500 mono truncate">@line_id</div>
                  </div>
                </div>
              </div>

              <div class="card-soft rounded-3xl p-4">
                <div class="flex items-end justify-between gap-2">
                  <div>
                    <div class="text-sm font-black text-slate-950">R2 ä¸Šå‚³ï¼ˆåº•æ¿ï¼‰</div>
                    <div class="text-[11px] text-slate-500 mt-1">é¸æª” â†’ <span class="mono">POST /upload</span> â†’ å›å‚³ URL â†’ è‡ªå‹•å¡«å…¥åº•æ¿ã€‚</div>
                  </div>
                  <span class="pill pill-indigo">upload</span>
                </div>

                <div class="mt-3 grid gap-2">
                  <div>
                    <label class="text-[11px] font-extrabold text-slate-600">é¸æ“‡æª”æ¡ˆ</label>
                    <input id="upFile" type="file" accept="image/*"
                           class="mt-1 w-full px-3 py-2 rounded-2xl border border-slate-200 bg-white/85" />
                  </div>

                  <div class="flex gap-2">
                    <button id="btnUploadR2" class="btn btn-indigo w-full">ä¸Šå‚³åˆ° R2</button>
                    <button id="btnUseAsBg" class="btn btn-soft w-full">è¨­ç‚ºåº•æ¿URL</button>
                  </div>

                  <div class="rounded-2xl border border-slate-200 bg-white/80 p-3">
                    <div class="text-[11px] font-extrabold text-slate-600">ä¸Šå‚³çµæœ URL</div>
                    <input id="upResultUrl" class="in in-mini mono mt-1" placeholder="ä¸Šå‚³æˆåŠŸå¾Œæœƒå‡ºç¾åœ¨é€™è£¡" />
                    <div class="text-[11px] text-slate-500 mt-2">è¦èƒ½åŒ¯å‡º PNGï¼šåº•æ¿åœ–éœ€å¯å…¬é–‹å­˜å–ä¸¦å…è¨±è·¨åŸŸï¼ˆCORSï¼‰ã€‚</div>
                  </div>

                  <div class="text-[11px] text-slate-500">
                    å­˜æ”¾è·¯å¾‘ï¼ˆkeyï¼‰å·²è‡ªå‹•è¨­å®šï¼š<span class="mono font-bold" id="txtAutoKey">assets/life11/report_bg.png</span>
                  </div>

                  <input id="upKey" class="hidden" />
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="card rounded-3xl p-4 md:p-5">
          <div class="flex items-end justify-between gap-2">
            <div>
              <h2 class="text-lg font-black text-slate-950">åœ–ç‰‡ç‰ˆç‡Ÿé¤Šç´ æ¯”ä¾‹å ±å‘Šï¼ˆå«æŒ‰éˆ•ï¼‰</h2>
              <p class="text-sm text-slate-600 mt-1">å›ºå®š 900Ã—1600 PNGï¼ˆé•·æ¢ä¸‹æ–¹ï¼šç›´æ¥ç•«ã€Œæ‚¨çš„æ¯æ—¥æ”å–å°šéœ€ã€ï¼‹æŒ‰éˆ•ï¼‰ã€‚</p>
            </div>
            <span class="pill">PNG</span>
          </div>

          <div class="mt-3 grid gap-2">
            <label class="text-[11px] font-extrabold text-slate-600">åº•æ¿åœ–ç‰‡URLï¼ˆR2 å…¬é–‹ç¶²å€ï¼‰</label>
            <input id="inBgUrl" class="in mono" placeholder="https://<your-public-r2-url>/assets/report_bg.png" />
          </div>

          <div class="mt-3">
            <canvas id="cvReport" class="w-full rounded-3xl border border-slate-200 bg-white"></canvas>
            <div class="text-[11px] text-slate-500 mt-2">
              â€» è‹¥ä¸‹è¼‰ PNG å¤±æ•—ï¼Œå¤šåŠæ˜¯åº•æ¿åœ–è·¨åŸŸï¼ˆCORSï¼‰æ²’é–‹ã€‚
            </div>
          </div>
        </section>

        <section class="card rounded-3xl p-4 md:p-5">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-2">
            <div>
              <h2 class="text-lg font-black text-slate-950">â‘¢ å¹´é½¡å±¤åƒè€ƒå€¼</h2>
              <p class="text-sm text-slate-600 mt-1">ä½ æ”¹é€™è£¡ï¼Œå°±æœƒå¯«é€² KVï¼ˆä¸Šé™å€¼æœƒç”¨é€™è£¡çš„æ•¸å­—ï¼‰ã€‚</p>
            </div>
            <div class="flex gap-2">
              <button id="btnResetTargets" class="btn btn-soft">æ¢å¾©é è¨­</button>
              <button id="btnCopyTargetsJson" class="btn btn-soft">è¤‡è£½ JSON</button>
            </div>
          </div>

          <div class="mt-3 overflow-auto thinbar">
            <table class="w-full min-w-[980px] border-collapse">
              <thead>
                <tr class="text-xs text-slate-600">
                  <th class="text-left p-2 border-b border-slate-200">é …ç›®</th>
                  <th class="text-left p-2 border-b border-slate-200">å–®ä½</th>
                  <th class="text-left p-2 border-b border-slate-200">0~10 æ­²</th>
                  <th class="text-left p-2 border-b border-slate-200">11~18 æ­²</th>
                  <th class="text-left p-2 border-b border-slate-200">19+ï¼ˆå¥³ï¼‰</th>
                  <th class="text-left p-2 border-b border-slate-200">19+ï¼ˆç”·ï¼‰</th>
                </tr>
              </thead>
              <tbody id="targetsTbody" class="text-sm"></tbody>
            </table>
          </div>

          <div class="mt-2 text-[11px] text-slate-500 leading-5">
            â€» æ•¸å€¼æœƒçµ„åˆæˆï¼š<span class="mono font-bold">vitB(B1/B2/B6)</span>ã€<span class="mono font-bold">ca_mg(éˆ£/é‚)</span>ã€<span class="mono font-bold">trace(ç¢˜/ç¡’)</span>ã€‚
          </div>
        </section>
      </div>
    </div>

    <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(92vw,560px)] space-y-2 z-50"></div>
  </div>

<script>
(() => {
  const Q_KEY = "AI_SURVEY:Q:life11";
  const KW_MAP_KEY = "AI_SURVEY:KW_MAP";

  // âœ… æ–°å¢ï¼šè³¼è²·é€£çµåŒæ­¥åˆ° KVï¼ˆä¸ç ä½ çš„ localStorageï¼‰
  const LINKS_KV_KEY = "AI_SURVEY:LINKS:life11";

  const DEFAULT_LINE_NAME = "LINEä½¿ç”¨è€…åç¨±";
  const DEFAULT_LINE_ID   = "@line_id";
  const DEFAULT_LINE_AVATAR_URL = "https://i.pravatar.cc/150?img=12";

  // âœ… 10å€‹æŒ‰éˆ•ï¼ˆæœƒç•«é€² PNG è£¡ï¼‰
  const BUY_ITEMS = [
    { key:"vitA",    label:"ç¶­ç”Ÿç´ A" },
    { key:"vitB",    label:"ç¶­ç”Ÿç´ B" },
    { key:"vitC",    label:"ç¶­ç”Ÿç´ C" },
    { key:"vitD",    label:"ç¶­ç”Ÿç´ D" },
    { key:"vitE",    label:"ç¶­ç”Ÿç´ E" },
    { key:"ca_mg",   label:"éˆ£é‚" },
    { key:"iron",    label:"éµ" },
    { key:"fiber",   label:"è†³é£Ÿçº–ç¶­" },
    { key:"trace",   label:"å¾®é‡å…ƒç´ " },
    { key:"protein", label:"è›‹ç™½è³ª" },
  ];
  const LS_LINKS_KEY = "life11_buy_links_v1";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function autoKeyForUpload(file){
    const d = new Date();
    const stamp = `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
    const ext = (file?.name || "").split(".").pop()?.toLowerCase();
    const safeExt = (ext && ext.length <= 6) ? ext : "png";
    return `assets/life11/report_bg_${stamp}.${safeExt}`;
  }

  const AGE_CHILD = "0~10 æ­² (å…’ç«¥)";
  const AGE_TEEN  = "11~18 æ­² (é’å°‘å¹´)";
  const AGE_ADULT = "19 æ­²ä»¥ä¸Š";

  const QUESTIONS = [
    { id:"q1",  type:"yn",  text:"æˆ‘ç¶“å¸¸åªæœ‰å…©é¤" },
    { id:"q2",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„è”¬èœå’Œæ°´æœå°‘æ–¼5ä»½ï¼ˆä»¥æˆäººæ‰‹æŒå¤§å°ç›¤å­ç‚ºæ¨™æº–ï¼‰" },
    { id:"q3",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„ç±³é£¯æˆ–éºµæ¢å°‘æ–¼1.5ç¢—" },
    { id:"q4",  type:"yn",  text:"æˆ‘æ¯å¤©å–çš„ä¹³è£½å“å°‘æ–¼1.5æ¯" },
    { id:"q5",  type:"yn",  text:"æˆ‘æ¯å¤©é£²ç”¨å’–å•¡æˆ–èŒ¶ï¼ˆè‡³å°‘å…©æ¯ï¼‰" },
    { id:"q6",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„è›‹ç™½è³ªé¡é£Ÿç‰©å°‘æ–¼5ä»½ï¼ˆä»¥æˆäººä¸‰æ ¹æ‰‹æŒ‡çš„é‡ç‚ºæ¨™æº–ï¼‰" },
    { id:"q7",  type:"yn",  text:"æˆ‘ç¶“å¸¸é£Ÿç”¨é«˜æº«ã€æ²¹ç‚¸æˆ–ç‡’ç…®çš„é£Ÿç‰©" },
    { id:"q8",  type:"yn",  text:"æˆ‘æœ‰å¸è¸ç¿’æ…£" },
    { id:"q9",  type:"yn",  text:"æˆ‘å¸¸ç¯€é£Ÿä»¥æ¸›è¼•é«”é‡" },
    { id:"q10", type:"sex", text:"æˆ‘çš„æ€§åˆ¥" },
    { id:"q11", type:"age", text:"æˆ‘çš„å¹´é½¡ç¯„åœ" },
    { id:"done", type:"done", text:"ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·è©•ä¼°å®Œç•¢ï¼" }
  ];

  // âœ… é¡¯ç¤ºåç¨±ï¼ˆå«æ”¯é …ï¼‰
  const LABEL = {
    vitA:"ç¶­ç”Ÿç´ A",
    vitB:"ç¶­ç”Ÿç´ Bï¼ˆB1/B2/B6ï¼‰",
    vitC:"ç¶­ç”Ÿç´ C",
    vitD:"ç¶­ç”Ÿç´ D",
    vitE:"ç¶­ç”Ÿç´ E",
    ca_mg:"éˆ£é‚ï¼ˆéˆ£/é‚ï¼‰",
    iron:"éµ",
    fiber:"è†³é£Ÿçº–ç¶­",
    trace:"å¾®é‡å…ƒç´ ï¼ˆç¢˜/ç¡’ï¼‰",
  };
  const PCT_ORDER = ["vitA","vitB","vitC","vitD","vitE","ca_mg","iron","fiber","trace"];

  const DEDUCT_EXCEL_DEFAULT = {
    q1: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
    q2: { vitA:20, vitB:16, vitC:20, vitD:0,  vitE:16, ca_mg:0,  iron:0,  fiber:25, trace:16 },
    q3: { vitA:0,  vitB:17, vitC:0,  vitD:0,  vitE:17, ca_mg:0,  iron:16, fiber:25, trace:17 },
    q4: { vitA:20, vitB:17, vitC:0,  vitD:25, vitE:0,  ca_mg:25, iron:0,  fiber:0,  trace:0  },
    q5: { vitA:0,  vitB:0,  vitC:0,  vitD:0,  vitE:0,  ca_mg:25, iron:17, fiber:0,  trace:17 },
    q6: { vitA:0,  vitB:0,  vitC:0,  vitD:25, vitE:0,  ca_mg:0,  iron:17, fiber:0,  trace:16 },
    q7: { vitA:0,  vitB:16, vitC:20, vitD:0,  vitE:17, ca_mg:0,  iron:0,  fiber:0,  trace:0  },
    q8: { vitA:20, vitB:0,  vitC:20, vitD:0,  vitE:16, ca_mg:0,  iron:16, fiber:0,  trace:0  },
    q9: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
  };

  const TARGETS_EXCEL_DEFAULT = [
    { id:"vitA",   name:"ç¶­ç”Ÿç´ A", unit:"Âµg",  child:1500, teen:2500, adultF:3000, adultM:3000 },
    { id:"b1",     name:"ç¶­ç”Ÿç´ B1", unit:"mg", child:0.9,  teen:1.2,  adultF:0.9,  adultM:1.2 },
    { id:"b2",     name:"ç¶­ç”Ÿç´ B2", unit:"mg", child:1.0,  teen:1.3,  adultF:1.0,  adultM:1.3 },
    { id:"b6",     name:"ç¶­ç”Ÿç´ B6", unit:"mg", child:1.0,  teen:1.5,  adultF:1.5,  adultM:1.6 },
    { id:"vitC",   name:"ç¶­ç”Ÿç´ C", unit:"mg",  child:1200, teen:1800, adultF:2000, adultM:2000 },
    { id:"vitD",   name:"ç¶­ç”Ÿç´ D", unit:"Âµg",  child:50,   teen:50,   adultF:50,   adultM:50   },
    { id:"vitE",   name:"ç¶­ç”Ÿç´ E", unit:"mg",  child:300,  teen:800,  adultF:1000, adultM:1000 },
    { id:"ca",     name:"éˆ£",       unit:"mg",  child:1500, teen:2500, adultF:2500, adultM:2500 },
    { id:"mg",     name:"é‚",       unit:"mg",  child:250,  teen:350,  adultF:320,  adultM:380  },
    { id:"iron",   name:"éµ",       unit:"mg",  child:30,   teen:40,   adultF:45,   adultM:40   },
    { id:"fiber",  name:"çº–ç¶­",     unit:"g",   child:20,   teen:25,   adultF:27,   adultM:34   },
    { id:"iodine", name:"å¾®é‡(ç¢˜)", unit:"Âµg",  child:90,   teen:130,  adultF:150,  adultM:150  },
    { id:"selen",  name:"å¾®é‡(ç¡’)", unit:"Âµg",  child:30,   teen:55,   adultF:55,   adultM:55   },
  ];

  const $ = (id)=>document.getElementById(id);

  function toast(msg, type="ok"){
    const wrap = $("toastWrap");
    const div = document.createElement("div");
    div.className = `card rounded-2xl px-4 py-3 border ${
      type==="ok" ? "border-emerald-200" : type==="warn" ? "border-amber-200" : "border-rose-200"
    }`;
    div.innerHTML = `<div class="text-sm text-slate-950 font-black">${escapeHtml(msg)}</div>`;
    wrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function showErr(e){
    $("errBanner").classList.remove("hidden");
    $("errText").textContent = String(e?.stack || e?.message || e || "");
  }
  function clearErr(){
    $("errBanner").classList.add("hidden");
    $("errText").textContent = "";
  }

  function initPreviewLine(){
    $("previewName").textContent = DEFAULT_LINE_NAME;
    $("previewId").textContent = DEFAULT_LINE_ID;
    $("previewAvatar").src = DEFAULT_LINE_AVATAR_URL || "https://i.pravatar.cc/150?img=12";
  }

  function apiBase(){ return ($("inApiBase").value || "").trim().replace(/\/$/,""); }
  function adminKey(){ return ($("inAdminKey").value || "").trim(); }

  async function apiJson(path, bodyObj){
    const base = apiBase();
    if(!base) throw new Error("API Base ä¸å¯ç©ºç™½");
    const headers = { "Content-Type":"application/json" };
    const k = adminKey();
    if(k) headers["X-Admin-Key"] = k;

    const res = await fetch(base + path, {
      method:"POST",
      headers,
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }
  async function apiForm(path, formData){
    const base = apiBase();
    if(!base) throw new Error("API Base ä¸å¯ç©ºç™½");
    const headers = {};
    const k = adminKey();
    if(k) headers["X-Admin-Key"] = k;

    const res = await fetch(base + path, { method:"POST", headers, body: formData });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }

  async function kvGet(key){
    const r = await apiJson("/loadAny", { namespace:"DB", keyword:key });
    return r?.payload ?? r;
  }
  async function kvPut(key, payload){
    await apiJson("/putAny", { namespace:"DB", keyword:key, payload });
  }

  let CONNECTED = false;
  function setPill(ok){
    const el = document.getElementById("pillConn");
    if(!el) return;
    el.textContent = ok ? "å·²é€£ç·š" : "æœªé€£ç·š";
    el.className = "pill " + (ok ? "pill-green" : "pill-rose");
  }
  function setStatus(ok){
    CONNECTED = !!ok;
    setPill(CONNECTED);
    $("txtLast").textContent = new Date().toLocaleString();
  }
  async function connect(){
    clearErr();
    await apiJson("/listAll", {});
    setStatus(true);
    toast("é€£ç·šæˆåŠŸ âœ…");
  }

  // Targets table
  let targetsRows = structuredClone(TARGETS_EXCEL_DEFAULT);
  function numOrText(v){
    if(v === "" || v === null || v === undefined) return "";
    const n = Number(v);
    return Number.isFinite(n) ? n : String(v);
  }
  function renderTargetsTable(){
    const tb = $("targetsTbody");
    tb.innerHTML = "";
    targetsRows.forEach(row=>{
      const tr = document.createElement("tr");
      tr.className = "border-b border-slate-100";
      tr.innerHTML = `
        <td class="p-2 font-black text-slate-950">${escapeHtml(row.name)}</td>
        <td class="p-2 text-slate-600">${escapeHtml(row.unit)}</td>
        <td class="p-2"><input data-col="child" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.child)}" /></td>
        <td class="p-2"><input data-col="teen" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.teen)}" /></td>
        <td class="p-2"><input data-col="adultF" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.adultF)}" /></td>
        <td class="p-2"><input data-col="adultM" data-id="${row.id}" type="number" step="any" class="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white/90 focus:outline-none focus:ring-4 focus:ring-indigo-100" value="${escapeHtml(row.adultM)}" /></td>
      `;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("input[data-id][data-col]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id = inp.getAttribute("data-id");
        const col = inp.getAttribute("data-col");
        const row = targetsRows.find(r=>r.id===id);
        if(!row) return;
        row[col] = numOrText(inp.value);
      });
    });
  }
  function resetTargets(){
    targetsRows = structuredClone(TARGETS_EXCEL_DEFAULT);
    renderTargetsTable();
    toast("å·²æ¢å¾©é è¨­");
  }

  function getTargetsObject(){
    const byId = {};
    targetsRows.forEach(r=>byId[r.id]=structuredClone(r));

    const pack = (ageKey, sexKey) => {
      const pick = (rid) => {
        const r = byId[rid];
        if(!r) return null;
        if(ageKey==="child") return r.child;
        if(ageKey==="teen") return r.teen;
        return (sexKey==="female") ? r.adultF : r.adultM;
      };
      const vitB = `B1:${pick("b1")}mg, B2:${pick("b2")}mg, B6:${pick("b6")}mg`;
      const ca_mg = `éˆ£:${pick("ca")}mg, é‚:${pick("mg")}mg`;
      const trace = `ç¢˜:${pick("iodine")}Âµg, ç¡’:${pick("selen")}Âµg`;
      return {
        vitA: `${pick("vitA")}Âµg`,
        vitB,
        vitC: `${pick("vitC")}mg`,
        vitD: `${pick("vitD")}Âµg`,
        vitE: `${pick("vitE")}mg`,
        ca_mg,
        iron: `${pick("iron")}mg`,
        fiber: `${pick("fiber")}g`,
        trace,
      };
    };

    const combined = {
      child: pack("child"),
      teen: pack("teen"),
      adultFemale: pack("adult","female"),
      adultMale: pack("adult","male"),
    };
    return { rows: structuredClone(targetsRows), combined };
  }

  function getAgeOpts(){ return [AGE_CHILD, AGE_TEEN, AGE_ADULT]; }
  function buildRules(){ return { yn_yes: structuredClone(DEDUCT_EXCEL_DEFAULT), sex: { "ç”·": {}, "å¥³": {} }, age: {} }; }

  function buildSurveyPayload(){
    const kw = ($("inKeyword").value || "").trim();
    if(!kw) throw new Error("è«‹å¡«ã€å•Ÿå‹•é—œéµå­—ã€");

    const ageOpts = getAgeOpts();
    const nodes = {};
    for(let i=0;i<QUESTIONS.length;i++){
      const q = QUESTIONS[i];
      if(q.type === "done") continue;
      const nextId = (QUESTIONS[i+1] && QUESTIONS[i+1].id !== "done") ? QUESTIONS[i+1].id : "";
      if(q.type === "yn"){
        nodes[q.id] = { q: q.text, type:"yn", options:[ {t:"æ˜¯",value:"æ˜¯",next:nextId}, {t:"ä¸æ˜¯",value:"ä¸æ˜¯",next:nextId} ] };
      } else if(q.type === "sex"){
        nodes[q.id] = { q: q.text, type:"sex", options:[ {t:"ç”·",value:"ç”·",next:nextId}, {t:"å¥³",value:"å¥³",next:nextId} ] };
      } else if(q.type === "age"){
        nodes[q.id] = { q: q.text, type:"age", options:[
          {t:ageOpts[0],value:ageOpts[0],next:nextId},
          {t:ageOpts[1],value:ageOpts[1],next:nextId},
          {t:ageOpts[2],value:ageOpts[2],next:nextId}
        ] };
      }
    }

    return {
      version: "life11-v15-bigger-text-roomy-buttons-branch-labels",
      name: "life11",
      title: "ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï¼ˆ11é¡Œï¼‰",
      keyword: kw,
      start: "q1",
      rules: buildRules(),
      targetsExcel: getTargetsObject(),
      nodes,
      order: QUESTIONS.filter(x=>x.type!=="done").map(x=>x.id),
      nutrients: LABEL,
      ui: { ageOptions: { child: ageOpts[0], teen: ageOpts[1], adult: ageOpts[2] } }
    };
  }

  async function writeKV(){
    if(!CONNECTED) throw new Error("æœªé€£ç·šï¼Œä¸èƒ½å¯«å…¥ï¼ˆå…ˆæŒ‰ã€é€£ç·šæª¢æŸ¥ã€ï¼‰");
    const payload = buildSurveyPayload();
    await kvPut(Q_KEY, payload);

    const kw = payload.keyword.trim();
    let map = {};
    try{
      const raw = await kvGet(KW_MAP_KEY);
      if(raw && typeof raw === "object") map = raw;
    }catch{ map = {}; }
    map[kw] = "life11";
    await kvPut(KW_MAP_KEY, map);

    toast("å·²å¯«å…¥ KV âœ…ï¼ˆå•å· + KW_MAP + è¦å‰‡ + æ”å–é‡ï¼‰");
  }

  // Simulation
  const simState = {};
  function renderSim(){
    const [ageChild, ageTeen, ageAdult] = getAgeOpts();
    const wrap = $("simWrap");
    wrap.innerHTML = "";

    QUESTIONS.filter(x=>x.type!=="done").forEach((q, i)=>{
      const box = document.createElement("div");
      box.className = "rounded-3xl border border-slate-200 bg-white/85 p-3";

      let optsHtml = "";
      if(q.type==="yn"){
        const v = simState[q.id] ?? "ä¸æ˜¯";
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            <button data-v="æ˜¯" class="btn ${v==="æ˜¯"?"btn-dark":"btn-soft"}">æ˜¯</button>
            <button data-v="ä¸æ˜¯" class="btn ${v==="ä¸æ˜¯"?"btn-dark":"btn-soft"}">ä¸æ˜¯</button>
          </div>`;
      }else if(q.type==="sex"){
        const v = simState[q.id] ?? "ç”·";
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            <button data-v="ç”·" class="btn ${v==="ç”·"?"btn-dark":"btn-soft"}">ç”·</button>
            <button data-v="å¥³" class="btn ${v==="å¥³"?"btn-dark":"btn-soft"}">å¥³</button>
          </div>`;
      }else if(q.type==="age"){
        const v = simState[q.id] ?? ageAdult;
        const opts = [ageChild, ageTeen, ageAdult];
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            ${opts.map(a => `
              <button data-v="${escapeHtml(a)}" class="btn ${v===a?"btn-dark":"btn-soft"}">${escapeHtml(a)}</button>
            `).join("")}
          </div>`;
      }

      box.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="text-[11px] text-slate-500">No.${i+1}/11</div>
          <span class="pill">é¸æ“‡</span>
        </div>
        <div class="mt-1 font-black text-slate-950">${escapeHtml(q.text)}</div>
        ${optsHtml}
      `;
      box.querySelectorAll("button[data-v]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          simState[q.id] = btn.getAttribute("data-v");
          renderSim();
        });
      });
      wrap.appendChild(box);
    });
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function getRemainFromSim(){
    const [ageChild, ageTeen, ageAdult] = getAgeOpts();
    const rules = buildRules();
    const ans = {};
    QUESTIONS.filter(x=>x.type!=="done").forEach(q=>{
      if(q.type==="yn")  ans[q.id] = simState[q.id] ?? "ä¸æ˜¯";
      if(q.type==="sex") ans[q.id] = simState[q.id] ?? "ç”·";
      if(q.type==="age") ans[q.id] = simState[q.id] ?? ageAdult;
    });

    const deduct = {};
    Object.keys(rules.yn_yes).forEach(qid=>{
      if(ans[qid] === "æ˜¯"){
        const obj = rules.yn_yes[qid];
        for(const k in obj){
          deduct[k] = (deduct[k] || 0) + (Number(obj[k]) || 0);
        }
      }
    });

    const remain = {};
    PCT_ORDER.forEach(k=>{
      remain[k] = clamp(100 - (deduct[k]||0), 0, 100);
    });
    return { ans, remain };
  }

  async function uploadToR2(){
    if(!CONNECTED) throw new Error("æœªé€£ç·šï¼Œä¸èƒ½ä¸Šå‚³ï¼ˆå…ˆæŒ‰ã€é€£ç·šæª¢æŸ¥ã€ï¼‰");
    const f = $("upFile").files?.[0];
    if(!f) throw new Error("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");

    const key = autoKeyForUpload(f);
    $("upKey").value = key;
    $("txtAutoKey").textContent = key;

    const fd = new FormData();
    fd.append("file", f);
    fd.append("key", key);
    fd.append("contentType", f.type || "application/octet-stream");

    const r = await apiForm("/upload", fd);
    const url = r?.url || r?.publicUrl || r?.result?.url || r?.result?.publicUrl || r?.payload?.url || "";
    if(!url) throw new Error("ä¸Šå‚³æˆåŠŸä½†æ²’æ‹¿åˆ° URLï¼ˆè«‹ç¢ºèª Worker /upload å›å‚³ {url} æˆ– {publicUrl}ï¼‰");

    $("upResultUrl").value = url;
    toast("ä¸Šå‚³æˆåŠŸ âœ…");
    return url;
  }

  function onPickFile(){
    const f = $("upFile").files?.[0];
    if(!f) return;
    const key = autoKeyForUpload(f);
    $("upKey").value = key;
    $("txtAutoKey").textContent = key;
  }

  let lastPngDataUrl = "";
  let lastClickAreas = [];

  function pctColor(p){
    if(p < 35) return "#ff4d4f";
    if(p < 70) return "#fbbf24";
    return "#34d399";
  }
  async function loadImg(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>resolve(img);
      img.onerror = ()=>reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š" + url));
      img.src = url;
    });
  }
  function roundRect(ctx, x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  function drawCircleAvatar(ctx, img, cx, cy, r){
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(img, cx - r, cy - r, r*2, r*2);
    ctx.restore();
  }

  // âœ… ä¾ã€Œå¹´é½¡/æ€§åˆ¥ã€æŠ“ä¸Šé™å€¼ï¼ˆä¾†æºï¼šâ‘¢ targetsRowsï¼‰
  function capPick(row, ans){
    const age = ans?.q11 || AGE_ADULT;
    const sex = ans?.q10 || "ç”·";
    const ageKey = age.includes("0~10") ? "child" : age.includes("11~18") ? "teen" : "adult";
    if(ageKey==="child") return row.child;
    if(ageKey==="teen") return row.teen;
    return (sex==="å¥³") ? row.adultF : row.adultM;
  }
  function capTextForKey(key, ans){
    const byId = {};
    targetsRows.forEach(r=>byId[r.id]=r);

    const fmt = (v, unit) => {
      if(v === "" || v === null || v === undefined) return "-";
      return `${v}${unit||""}`; // âœ… åªé¡¯ç¤ºã€Œæ•¸å­—+å–®ä½ã€
    };

    if(key==="vitA"){ const r = byId.vitA; return r ? fmt(capPick(r,ans), r.unit) : "-"; }
    if(key==="vitC"){ const r = byId.vitC; return r ? fmt(capPick(r,ans), r.unit) : "-"; }
    if(key==="vitD"){ const r = byId.vitD; return r ? fmt(capPick(r,ans), r.unit) : "-"; }
    if(key==="vitE"){ const r = byId.vitE; return r ? fmt(capPick(r,ans), r.unit) : "-"; }
    if(key==="iron"){ const r = byId.iron; return r ? fmt(capPick(r,ans), r.unit) : "-"; }
    if(key==="fiber"){ const r = byId.fiber; return r ? fmt(capPick(r,ans), r.unit) : "-"; }

    if(key==="vitB"){
      const b1=byId.b1, b2=byId.b2, b6=byId.b6;
      if(!b1 || !b2 || !b6) return "-";
      const u = b1.unit || "mg";
      return `${capPick(b1,ans)}/${capPick(b2,ans)}/${capPick(b6,ans)}${u}`;
    }
    if(key==="ca_mg"){
      const ca=byId.ca, mg=byId.mg;
      if(!ca || !mg) return "-";
      const u = ca.unit || "mg";
      return `${capPick(ca,ans)}/${capPick(mg,ans)}${u}`;
    }
    if(key==="trace"){
      const io=byId.iodine, se=byId.selen;
      if(!io || !se) return "-";
      const u = io.unit || "Âµg";
      return `${capPick(io,ans)}/${capPick(se,ans)}${u}`;
    }
    return "-";
  }

  // ====== âœ… è³¼è²·é€£çµï¼ˆlocalStorage + KVï¼‰ ======
  function normalizeUrl(u){
    const s = (u || "").trim();
    if(!s) return "";
    if(/^https?:\/\//i.test(s)) return s;
    if(/^www\./i.test(s)) return "https://" + s;
    return s;
  }
  function loadLinksLocal(){
    try{
      const raw = localStorage.getItem(LS_LINKS_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    }catch{
      return {};
    }
  }
  function saveLinksLocal(obj){
    localStorage.setItem(LS_LINKS_KEY, JSON.stringify(obj || {}));
  }
  async function loadLinksKV(){
    if(!CONNECTED) throw new Error("æœªé€£ç·šï¼Œä¸èƒ½è®€å– KVï¼ˆå…ˆæŒ‰ã€é€£ç·šæª¢æŸ¥ã€ï¼‰");
    const obj = await kvGet(LINKS_KV_KEY).catch(()=> ({}));
    return (obj && typeof obj==="object") ? obj : {};
  }
  async function saveLinksKV(obj){
    if(!CONNECTED) throw new Error("æœªé€£ç·šï¼Œä¸èƒ½å¯«å…¥ KVï¼ˆå…ˆæŒ‰ã€é€£ç·šæª¢æŸ¥ã€ï¼‰");
    await kvPut(LINKS_KV_KEY, obj || {});
  }
  function mergeLinksPreferLocal(localObj, kvObj){
    const out = {};
    BUY_ITEMS.forEach(it=>{
      const a = normalizeUrl(localObj?.[it.key] || "");
      const b = normalizeUrl(kvObj?.[it.key] || "");
      out[it.key] = a || b || "";
    });
    return out;
  }

  let buyLinks = loadLinksLocal();

  function renderLinksEditor(){
    const wrap = $("linksEditor");
    wrap.innerHTML = "";
    BUY_ITEMS.forEach(item=>{
      const row = document.createElement("div");
      row.className = "rounded-3xl border border-slate-200 bg-white/85 p-3";
      const v = buyLinks[item.key] || "";
      row.innerHTML = `
        <div class="flex flex-col gap-2">
          <div class="flex items-center justify-between gap-2">
            <div class="font-black text-slate-950">${escapeHtml(item.label)}</div>
            <div class="mono text-[11px] text-slate-500">${escapeHtml(item.key)}</div>
          </div>
          <input class="in in-mini mono" data-link-key="${escapeHtml(item.key)}" placeholder="è²¼ä¸Šè³¼è²·é é¢é€£çµï¼ˆå¯ç©ºç™½ï¼‰" value="${escapeHtml(v)}"/>
        </div>
      `;
      wrap.appendChild(row);
    });

    wrap.querySelectorAll("input[data-link-key]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const k = inp.getAttribute("data-link-key");
        buyLinks[k] = normalizeUrl(inp.value);
      });
    });
  }

  // ===== âœ… æ ¸å¿ƒï¼šç•«å ±å‘Šï¼ˆé•·æ¢ï¼‹æ–‡å­—ï¼‹æŒ‰éˆ•éƒ½åœ¨ PNG è£¡ï¼‰ =====
  async function renderReportImage(){
    const bgUrl = ($("inBgUrl").value||"").trim();
    if(!bgUrl) throw new Error("è«‹å…ˆå¡«ã€åº•æ¿åœ–ç‰‡URLï¼ˆR2 å…¬é–‹ç¶²å€ï¼‰ã€");

    const W = 900, H = 1600;
    const cv = $("cvReport");
    cv.width = W; cv.height = H;
    const ctx = cv.getContext("2d");

    lastClickAreas = [];

    const bg = await loadImg(bgUrl);
    ctx.drawImage(bg, 0, 0, W, H);

    const { ans, remain } = getRemainFromSim();

    const lineName = DEFAULT_LINE_NAME;
    const lineId = DEFAULT_LINE_ID;
    const avatarUrl = DEFAULT_LINE_AVATAR_URL;

    // ===== ä¸Šæ–¹å€‹äººè³‡æ–™å€ =====
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "#000000";
    roundRect(ctx, 48, 48, W-96, 190, 46);
    ctx.fill();
    ctx.restore();

    if(avatarUrl){
      try{
        const av = await loadImg(avatarUrl);
        drawCircleAvatar(ctx, av, 140, 140, 58);
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,.85)";
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.arc(140, 140, 60, 0, Math.PI*2);
        ctx.stroke();
        ctx.restore();
      }catch{}
    }

    ctx.fillStyle = "rgba(255,255,255,.96)";
    ctx.textAlign = "left";
    ctx.font = "bold 44px Microsoft JhengHei, sans-serif";
    ctx.fillText(lineName, 230, 128);

    ctx.fillStyle = "rgba(255,255,255,.90)";
    ctx.font = "bold 26px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\",\"Courier New\", monospace";
    ctx.fillText(lineId, 230, 172);

    ctx.fillStyle = "rgba(255,255,255,.86)";
    ctx.font = "bold 22px Microsoft JhengHei, sans-serif";
    ctx.fillText(`å¹´é½¡:${ans.q11} Â· æ€§åˆ¥:${ans.q10}`, 230, 208);

    // ===== ç‡Ÿé¤Šç´ é•·æ¢ =====
    const listX = 56;
    const listY = 270;
    const listW = W - listX*2;

    const rowH  = 94;
    const gapY  = 12;

    const panelH = (rowH+gapY)*PCT_ORDER.length - gapY + 28;

    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "#0b122b";
    roundRect(ctx, 42, listY-14, W-84, panelH, 36);
    ctx.fill();
    ctx.restore();

    for(let i=0;i<PCT_ORDER.length;i++){
      const k = PCT_ORDER[i];
      const x = listX;
      const y = listY + i*(rowH + gapY);
      const pct = remain[k];
      const capText = capTextForKey(k, ans);

      ctx.save();
      ctx.globalAlpha = 0.16;
      ctx.fillStyle = "#ffffff";
      roundRect(ctx, x, y, listW, rowH, 22);
      ctx.fill();
      ctx.restore();

      ctx.strokeStyle = "rgba(255,255,255,.40)";
      ctx.lineWidth = 2;
      roundRect(ctx, x, y, listW, rowH, 22);
      ctx.stroke();

      ctx.textAlign = "left";
      ctx.fillStyle = "rgba(255,255,255,.98)";
      ctx.font = "bold 26px Microsoft JhengHei, sans-serif";
      ctx.fillText(LABEL[k] || k, x+18, y+38);

      ctx.fillStyle = "rgba(255,255,255,.94)";
      ctx.font = "bold 24px Microsoft JhengHei, sans-serif";
      ctx.fillText(capText, x+18, y+72);

      const barX = x + 330;
      const barY = y + 34;
      const barW = listW - 330 - 18;
      const barH = 30;

      ctx.fillStyle = "rgba(255,255,255,.22)";
      roundRect(ctx, barX, barY, barW, barH, 15);
      ctx.fill();

      const fillW = Math.max(0, Math.min(barW, barW*(pct/100)));
      ctx.fillStyle = pctColor(pct);
      roundRect(ctx, barX, barY, fillW, barH, 15);
      ctx.fill();

      ctx.textAlign = "center";
      ctx.fillStyle = "rgba(255,255,255,.98)";
      ctx.font = "bold 20px Microsoft JhengHei, sans-serif";
      ctx.fillText(`${pct}%`, barX + barW/2, barY + 22);
    }

    // ===== é»æ“Šäº†è§£å€ï¼š3æ¬„æŒ‰éˆ• =====
    const afterBarsY = (listY - 14) + panelH + 24;
    const titleX = 56;

    const btnCols = 3;
    const btnGapX = 16;
    const btnGapY2 = 16;
    const btnH = 62;
    const btnW = Math.floor((W - 84 - btnGapX*(btnCols-1)) / btnCols);
    const btnStartX = 42;
    const btnStartY = afterBarsY + 52;

    const btnRows = Math.ceil(BUY_ITEMS.length / btnCols);
    const boxPadBottom = 28;
    const boxH = 52 + (btnRows * btnH) + ((btnRows-1) * btnGapY2) + boxPadBottom;

    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "#000";
    roundRect(ctx, 42, afterBarsY-12, W-84, boxH, 36);
    ctx.fill();
    ctx.restore();

    ctx.textAlign = "left";
    ctx.fillStyle = "rgba(255,255,255,.98)";
    ctx.font = "bold 26px Microsoft JhengHei, sans-serif";
    ctx.fillText("æ‚¨çš„æ¯æ—¥æ”å–å°šéœ€(é»æ“Šäº†è§£)ï¼š", titleX, afterBarsY+30);

    for(let i=0;i<BUY_ITEMS.length;i++){
      const item = BUY_ITEMS[i];
      const col = i % btnCols;
      const row = Math.floor(i / btnCols);
      const x = btnStartX + col*(btnW + btnGapX);
      const y = btnStartY + row*(btnH + btnGapY2);

      ctx.save();
      ctx.globalAlpha = 0.20;
      ctx.fillStyle = "#ffffff";
      roundRect(ctx, x, y, btnW, btnH, 24);
      ctx.fill();
      ctx.restore();

      ctx.strokeStyle = "rgba(255,255,255,.45)";
      ctx.lineWidth = 2;
      roundRect(ctx, x, y, btnW, btnH, 24);
      ctx.stroke();

      ctx.textAlign = "center";
      ctx.fillStyle = "rgba(255,255,255,.98)";
      ctx.font = "bold 22px Microsoft JhengHei, sans-serif";
      ctx.fillText(item.label, x + btnW/2, y + 40);

      const url = normalizeUrl(buyLinks[item.key] || "");
      lastClickAreas.push({
        key: item.key,
        label: item.label,
        x: Math.round(x), y: Math.round(y),
        w: Math.round(btnW), h: Math.round(btnH),
        url
      });
    }

    lastPngDataUrl = cv.toDataURL("image/png");
    return lastPngDataUrl;
  }

  function downloadPng(){
    if(!lastPngDataUrl) throw new Error("è«‹å…ˆæŒ‰ã€ç”¢ç”Ÿåœ–ç‰‡ã€");
    const a = document.createElement("a");
    a.href = lastPngDataUrl;
    a.download = "nutrition_report.png";
    a.click();
  }

  function exportAreasJson(){
    if(!lastClickAreas?.length) throw new Error("è«‹å…ˆã€ç”¢ç”Ÿåœ–ç‰‡ã€ï¼Œæ‰èƒ½åŒ¯å‡ºé»æ“Šå€");
    const payload = {
      canvas: { width: 900, height: 1600 },
      areas: lastClickAreas.filter(a => !!a.url)
    };
    const txt = JSON.stringify(payload, null, 2);
    $("outAreas").value = txt;
    return txt;
  }

  // âœ… æ–°å¢ï¼šä¸€éµç™¼ä½ˆï¼ˆä½ è¦çš„ï¼šå…¨è¨­å®šå®ŒæŒ‰ä¸€ä¸‹å°±å¥½ï¼‰
  async function publishAll(){
    clearErr();

    // 1) ç¢ºä¿é€£ç·š
    if(!CONNECTED) await connect();

    // 2) å…ˆæŠŠè³¼è²·é€£çµå­˜ localï¼ˆé¿å…æ„å¤–ï¼‰
    saveLinksLocal(buyLinks);

    // 3) å¯«å…¥å•å·/è¦å‰‡/åƒè€ƒå€¼/KW_MAP
    await writeKV();

    // 4) åŒæ­¥è³¼è²·é€£çµåˆ° KVï¼ˆé€™å°±æ˜¯ä½ ä¹‹å‰è¦ºå¾—æˆ‘ç æ‰çš„ã€Œä¸»è¦åŠŸèƒ½ã€ä¹‹ä¸€ï¼‰
    await saveLinksKV(buyLinks);

    // 5) ç”¢ç”Ÿåœ–ç‰‡ï¼ˆéœ€è¦åº•æ¿URLï¼‰
    await renderReportImage();

    // 6) è‡ªå‹•åŒ¯å‡ºé»æ“Šå€ JSON
    exportAreasJson();

    toast("ğŸš€ ç™¼ä½ˆå®Œæˆ âœ…ï¼ˆKV + é€£çµKV + PNG + JSONï¼‰");
  }

  // ====== connect / write / publish ======
  $("btnConnect").addEventListener("click", async ()=>{
    try{ await connect(); }
    catch(e){ setStatus(false); showErr(e); toast("é€£ç·šå¤±æ•—","err"); }
  });

  $("btnWrite").addEventListener("click", async ()=>{
    try{ clearErr(); await writeKV(); }
    catch(e){ showErr(e); toast(e.message || "å¯«å…¥å¤±æ•—","err"); }
  });

  $("btnPublish").addEventListener("click", async ()=>{
    try{
      await publishAll();
    }catch(e){
      showErr(e);
      toast(e.message || "ä¸€éµç™¼ä½ˆå¤±æ•—","err");
    }
  });

  // ====== upload ======
  $("upFile").addEventListener("change", onPickFile);
  $("btnUploadR2").addEventListener("click", async ()=>{
    try{ clearErr(); await uploadToR2(); }
    catch(e){ showErr(e); toast(e.message || "ä¸Šå‚³å¤±æ•—","err"); }
  });
  $("btnUseAsBg").addEventListener("click", ()=>{
    const u = ($("upResultUrl").value||"").trim();
    if(!u) return toast("æ²’æœ‰å¯ç”¨çš„ä¸Šå‚³URL","warn");
    $("inBgUrl").value = u;
    toast("å·²å¡«å…¥åº•æ¿URL âœ…");
  });

  // ====== render / download ======
  $("btnRenderImg").addEventListener("click", async ()=>{
    try{ clearErr(); await renderReportImage(); toast("å·²ç”¢ç”Ÿåœ–ç‰‡ âœ…"); }
    catch(e){ showErr(e); toast(e.message || "ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—","err"); }
  });
  $("btnDownloadImg").addEventListener("click", ()=>{
    try{ downloadPng(); toast("å·²ä¸‹è¼‰ PNG âœ…"); }
    catch(e){ toast(e.message || "ä¸‹è¼‰å¤±æ•—","warn"); }
  });

  // ====== export areas ======
  $("btnExportAreas").addEventListener("click", ()=>{
    try{
      exportAreasJson();
      toast("å·²åŒ¯å‡ºé»æ“Šå€ JSON âœ…ï¼ˆåªå«æœ‰å¡«URLçš„æŒ‰éˆ•ï¼‰");
    }catch(e){
      toast(e.message || "åŒ¯å‡ºå¤±æ•—", "warn");
    }
  });
  $("btnCopyAreas").addEventListener("click", async ()=>{
    try{
      const txt = exportAreasJson();
      await navigator.clipboard.writeText(txt);
      toast("å·²è¤‡è£½ JSON âœ…");
    }catch(e){
      toast("è¤‡è£½å¤±æ•—ï¼ˆæˆ–å°šæœªç”¢ç”Ÿåœ–ç‰‡ï¼‰", "warn");
    }
  });

  // ====== simulate ======
  $("btnSimAllGood").addEventListener("click", ()=>{
    ["q1","q2","q3","q4","q5","q6","q7","q8","q9"].forEach(id=>simState[id]="ä¸æ˜¯");
    simState.q10="å¥³";
    simState.q11=AGE_CHILD;
    renderSim();
    toast("å·²å¡«å…¥ã€éƒ½å¾ˆå¥åº·ã€æ¸¬è©¦ç­”æ¡ˆ");
  });
  $("btnSimAllYes").addEventListener("click", ()=>{
    ["q1","q2","q3","q4","q5","q6","q7","q8","q9"].forEach(id=>simState[id]="æ˜¯");
    simState.q10="ç”·";
    simState.q11=AGE_ADULT;
    renderSim();
    toast("å·²å¡«å…¥ã€å…¨éƒ¨éƒ½é¸æ˜¯ã€æ¸¬è©¦ç­”æ¡ˆ");
  });

  // ====== targets table ======
  $("btnResetTargets").addEventListener("click", resetTargets);
  $("btnCopyTargetsJson").addEventListener("click", async ()=>{
    try{
      const obj = getTargetsObject();
      await navigator.clipboard.writeText(JSON.stringify(obj, null, 2));
      toast("å·²è¤‡è£½ Targets JSON âœ…");
    }catch{
      toast("è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰", "warn");
    }
  });

  // ====== save links (local) ======
  $("btnSaveLinks").addEventListener("click", ()=>{
    saveLinksLocal(buyLinks);
    toast("å·²å„²å­˜è³¼è²·é€£çµ âœ…ï¼ˆlocalStorageï¼‰");
  });
  $("btnClearLinks").addEventListener("click", ()=>{
    buyLinks = {};
    saveLinksLocal(buyLinks);
    renderLinksEditor();
    toast("å·²æ¸…ç©º âœ…", "warn");
  });

  // ====== links KV sync (æ–°å¢ï¼Œä¸ç åŸåŠŸèƒ½) ======
  $("btnLoadLinksKV").addEventListener("click", async ()=>{
    try{
      clearErr();
      if(!CONNECTED) await connect();
      const kvObj = await loadLinksKV();
      const localObj = loadLinksLocal();
      buyLinks = mergeLinksPreferLocal(localObj, kvObj);
      saveLinksLocal(buyLinks);
      renderLinksEditor();
      toast("å·²å¾ KV è®€å–ï¼ˆä¸¦èˆ‡ local åˆä½µï¼‰âœ…");
    }catch(e){
      showErr(e);
      toast(e.message || "è®€å– KV é€£çµå¤±æ•—", "err");
    }
  });
  $("btnSaveLinksKV").addEventListener("click", async ()=>{
    try{
      clearErr();
      if(!CONNECTED) await connect();
      saveLinksLocal(buyLinks);
      await saveLinksKV(buyLinks);
      toast("å·²æŠŠè³¼è²·é€£çµå­˜åˆ° KV âœ…");
    }catch(e){
      showErr(e);
      toast(e.message || "å¯«å…¥ KV é€£çµå¤±æ•—", "err");
    }
  });

  // init
  initPreviewLine();
  renderTargetsTable();
  renderSim();
  renderLinksEditor();
  $("txtAutoKey").textContent = "assets/life11/report_bg_YYYYMMDD_HHMMSS.png";
})();
</script>
</body>
</html>
