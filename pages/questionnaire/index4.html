<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï½œä¸€éµç™¼ä½ˆï¼ˆç°¡ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0b1220; --bd:rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.88); --shadow: 0 18px 55px rgba(15,23,42,.10);
      --ring: 0 0 0 5px rgba(99,102,241,.14);
    }
    body{
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,.20), transparent 60%),
        radial-gradient(900px 520px at 90% 18%, rgba(16,185,129,.18), transparent 60%),
        linear-gradient(135deg, #fbfdff, #f1f6ff 35%, #ecfeff);
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .card{
      background: var(--glass);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.08);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .in{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      padding: .78rem 1rem;
      outline: none;
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    .in:focus{ border-color: rgba(99,102,241,.35); box-shadow: var(--ring); }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 16px; padding:.82rem 1rem;
      font-weight:900; font-size:14px;
      user-select:none; transition: transform .08s ease, filter .18s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-dark{ color:#fff; background: linear-gradient(135deg, #0b1220, #111827); }
    .btn-emerald{ color:#fff; background: linear-gradient(135deg, #10b981, #22c55e); }
    .btn-indigo{ color:#fff; background: linear-gradient(135deg, #6366f1, #8b5cf6); }
    .pill{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .55rem;
      border-radius:999px;
      font-weight:800; font-size:11px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
    }
    .pill-ok{ border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.10); color: rgba(5,150,105,1); }
    .pill-bad{ border-color: rgba(244,63,94,.25); background: rgba(244,63,94,.10); color: rgba(190,18,60,1); }
    .thinbar::-webkit-scrollbar{ height:10px; width:10px; }
    .thinbar::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.20); border-radius: 999px; }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-5xl mx-auto p-3 md:p-6">

    <!-- Header -->
    <header class="card rounded-3xl p-4 md:p-5 mb-3">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <div class="flex items-center gap-2 flex-wrap">
            <h1 class="text-2xl md:text-3xl font-black tracking-tight">ä¸€éµç™¼ä½ˆï½œåœ–ç‰‡ç‰ˆç‡Ÿé¤Šå ±å‘Š</h1>
            <span id="pillConn" class="pill pill-bad">æœªé€£ç·š</span>
            <span class="pill">KVï¼š<span class="mono font-bold">life11</span></span>
          </div>
          <p class="text-sm text-slate-600 mt-2 leading-6">
            ä½ åªè¦æŠŠè¨­å®šå¡«å¥½ï¼ŒæŒ‰ã€Œä¸€éµç™¼ä½ˆã€å°±æœƒè‡ªå‹•å¯«å…¥ KVï¼ˆå•å·+KW_MAP+é€£çµ+çµ±ä¸€å¼•æµåœ–ï¼‰ï¼Œä¸¦ç«‹å³ç”Ÿæˆ PNG é è¦½å¯ä¸‹è¼‰ã€‚
          </p>
        </div>
        <div class="text-xs text-slate-600 leading-6">
          <div class="font-extrabold">éœ€è¦ Worker APIï¼š</div>
          <div class="mono">/listAll /putAny /loadAny /upload</div>
        </div>
      </div>

      <div class="mt-3 grid md:grid-cols-3 gap-2">
        <div class="md:col-span-2">
          <label class="text-xs font-extrabold text-slate-600">Worker API</label>
          <input id="inApiBase" class="in mono mt-1" value="https://api.zxcv8096.workers.dev/" />
        </div>
        <div>
          <label class="text-xs font-extrabold text-slate-600">Admin Keyï¼ˆå¯ç©ºç™½ï¼‰</label>
          <input id="inAdminKey" class="in mono mt-1" placeholder="è‹¥ Worker æœ‰é©—è­‰æ‰å¡«" />
        </div>
      </div>

      <div class="mt-3 grid md:grid-cols-3 gap-2">
        <button id="btnConnect" class="btn btn-dark w-full">é€£ç·šæª¢æŸ¥</button>
        <button id="btnLoad" class="btn btn-indigo w-full">è®€å–é›²ç«¯è¨­å®š</button>
        <button id="btnPublish" class="btn btn-emerald w-full">ğŸš€ ä¸€éµç™¼ä½ˆ</button>
      </div>

      <div id="errBanner" class="hidden mt-3 rounded-2xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
        <div class="font-extrabold">éŒ¯èª¤</div>
        <div id="errText" class="mt-1 mono text-[12px] whitespace-pre-wrap"></div>
      </div>
    </header>

    <!-- Settings -->
    <div class="grid lg:grid-cols-2 gap-3">

      <!-- Left -->
      <section class="card rounded-3xl p-4 md:p-5">
        <h2 class="text-lg font-black">å¿…è¦è¨­å®š</h2>

        <div class="mt-3 grid gap-3">
          <div>
            <label class="text-xs font-extrabold text-slate-600">å•Ÿå‹•é—œéµå­—ï¼ˆLINE ä½¿ç”¨è€…è¼¸å…¥é€™å€‹é–‹å§‹ï¼‰</label>
            <input id="inKeyword" class="in mt-1" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»ç‡Ÿé¤Š" />
          </div>

          <div class="rounded-3xl border border-slate-200 bg-white/70 p-4">
            <div class="text-xs font-extrabold text-slate-600">åº•æ¿ï¼ˆå ±å‘ŠèƒŒæ™¯åœ–ï¼‰</div>
            <div class="mt-2 grid gap-2">
              <input id="inBgUrl" class="in mono" placeholder="åº•æ¿åœ–ç‰‡URLï¼ˆR2 å…¬é–‹ç¶²å€ï¼‰" />
              <div class="flex gap-2">
                <input id="upFile" type="file" accept="image/*"
                  class="w-full px-3 py-2 rounded-2xl border border-slate-200 bg-white/85" />
                <button id="btnUploadR2" class="btn btn-indigo">ä¸Šå‚³R2</button>
              </div>
              <input id="upResultUrl" class="in mono" placeholder="ä¸Šå‚³å¾ŒURLæœƒå‡ºç¾åœ¨é€™è£¡ï¼ˆå¯ç›´æ¥ç•¶åº•æ¿ï¼‰" />
              <div class="flex gap-2">
                <button id="btnUseAsBg" class="btn btn-dark w-full">ç”¨ä¸Šå‚³URLç•¶åº•æ¿</button>
                <button id="btnRenderImg" class="btn btn-soft w-full border border-slate-200 bg-white/75">ç”¢ç”Ÿåœ–ç‰‡</button>
              </div>
            </div>
            <div class="text-[11px] text-slate-500 mt-2">â€» è‹¥ä¸‹è¼‰ PNG å¤±æ•—ï¼Œå¤šåŠæ˜¯åº•æ¿åœ–è·¨åŸŸï¼ˆCORSï¼‰æ²’é–‹ã€‚</div>
          </div>

          <div class="rounded-3xl border border-slate-200 bg-white/70 p-4">
            <div class="text-xs font-extrabold text-slate-600">è³¼è²·é€£çµï¼ˆæœƒç¶å®šåˆ°åœ–ç‰‡å…§æŒ‰éˆ•ï¼‰</div>
            <div class="mt-2 space-y-2" id="linksEditor"></div>
          </div>

          <div class="rounded-3xl border border-slate-200 bg-white/70 p-4">
            <div class="text-xs font-extrabold text-slate-600">ç”¢å“å…¥å£ï¼ˆçµ±ä¸€å¼•æµåœ–ï¼‰</div>
            <div class="mt-2 grid gap-2">
              <input id="inAssetTitle" class="in" placeholder="ctaTitleï¼ˆä¾‹ï¼šé»é€™è£¡çœ‹çœ‹ç”¢å“ï¼‰" />
              <input id="inAssetImage" class="in mono" placeholder="imageUrlï¼ˆhttps://...pngï¼‰" />
              <input id="inAssetLink" class="in mono" placeholder="linkUrlï¼ˆhttps://...ï¼‰" />
            </div>
          </div>
        </div>
      </section>

      <!-- Right -->
      <section class="card rounded-3xl p-4 md:p-5">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-lg font-black">åœ–ç‰‡é è¦½ï¼ˆPNGï¼‰</h2>
          <div class="flex gap-2">
            <button id="btnDownloadImg" class="btn btn-dark">ä¸‹è¼‰PNG</button>
            <button id="btnExportAreas" class="btn btn-indigo">åŒ¯å‡ºé»æ“Šå€</button>
          </div>
        </div>

        <div class="mt-3">
          <canvas id="cvReport" class="w-full rounded-3xl border border-slate-200 bg-white"></canvas>
        </div>

        <div class="mt-3">
          <label class="text-xs font-extrabold text-slate-600">é»æ“Šå€ JSONï¼ˆåš LINE imagemap ç”¨ï¼‰</label>
          <textarea id="outAreas" class="in mono mt-1 h-40 text-[12px]" placeholder="æŒ‰ã€åŒ¯å‡ºé»æ“Šå€ã€å¾Œæœƒå‡ºç¾åœ¨é€™è£¡"></textarea>
        </div>

        <div class="mt-3 rounded-3xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900 leading-6">
          <div class="font-extrabold">ä¸€éµç™¼ä½ˆæœƒåšä»€éº¼ï¼Ÿ</div>
          <div>1) å¯«å…¥å•å·/è¦å‰‡/æ”å–é‡ â†’ <span class="mono">AI_SURVEY:Q:life11</span></div>
          <div>2) æ›´æ–°å•Ÿå‹•é—œéµå­— â†’ <span class="mono">AI_SURVEY:KW_MAP</span></div>
          <div>3) å¯«å…¥è³¼è²·é€£çµ â†’ <span class="mono">AI_SURVEY:LINKS:life11</span></div>
          <div>4) å¯«å…¥çµ±ä¸€å¼•æµåœ– â†’ <span class="mono">AI_SURVEY:ASSET:DEFAULT</span></div>
        </div>
      </section>

    </div>

    <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(92vw,560px)] space-y-2 z-50"></div>
  </div>

<script>
(() => {
  // ===== keys =====
  const Q_KEY = "AI_SURVEY:Q:life11";
  const KW_MAP_KEY = "AI_SURVEY:KW_MAP";
  const LINKS_KEY = "AI_SURVEY:LINKS:life11";
  const ASSET_DEFAULT_KEY = "AI_SURVEY:ASSET:DEFAULT";

  // ===== defaults =====
  const DEFAULT_LINE_NAME = "LINEä½¿ç”¨è€…åç¨±";
  const DEFAULT_LINE_ID   = "@line_id";
  const DEFAULT_LINE_AVATAR_URL = "https://i.pravatar.cc/150?img=12";

  const BUY_ITEMS = [
    { key:"vitA",    label:"ç¶­ç”Ÿç´ A" },
    { key:"vitB",    label:"ç¶­ç”Ÿç´ B" },
    { key:"vitC",    label:"ç¶­ç”Ÿç´ C" },
    { key:"vitD",    label:"ç¶­ç”Ÿç´ D" },
    { key:"vitE",    label:"ç¶­ç”Ÿç´ E" },
    { key:"ca_mg",   label:"éˆ£é‚" },
    { key:"iron",    label:"éµ" },
    { key:"fiber",   label:"è†³é£Ÿçº–ç¶­" },
    { key:"trace",   label:"å¾®é‡å…ƒç´ " },
    { key:"protein", label:"è›‹ç™½è³ª" },
  ];

  // 11é¡Œï¼ˆå›ºå®šï¼‰
  const AGE_CHILD = "0~10 æ­² (å…’ç«¥)";
  const AGE_TEEN  = "11~18 æ­² (é’å°‘å¹´)";
  const AGE_ADULT = "19 æ­²ä»¥ä¸Š";

  const QUESTIONS = [
    { id:"q1",  type:"yn",  text:"æˆ‘ç¶“å¸¸åªæœ‰å…©é¤" },
    { id:"q2",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„è”¬èœå’Œæ°´æœå°‘æ–¼5ä»½ï¼ˆä»¥æˆäººæ‰‹æŒå¤§å°ç›¤å­ç‚ºæ¨™æº–ï¼‰" },
    { id:"q3",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„ç±³é£¯æˆ–éºµæ¢å°‘æ–¼1.5ç¢—" },
    { id:"q4",  type:"yn",  text:"æˆ‘æ¯å¤©å–çš„ä¹³è£½å“å°‘æ–¼1.5æ¯" },
    { id:"q5",  type:"yn",  text:"æˆ‘æ¯å¤©é£²ç”¨å’–å•¡æˆ–èŒ¶ï¼ˆè‡³å°‘å…©æ¯ï¼‰" },
    { id:"q6",  type:"yn",  text:"æˆ‘æ¯å¤©æ”å–çš„è›‹ç™½è³ªé¡é£Ÿç‰©å°‘æ–¼5ä»½ï¼ˆä»¥æˆäººä¸‰æ ¹æ‰‹æŒ‡çš„é‡ç‚ºæ¨™æº–ï¼‰" },
    { id:"q7",  type:"yn",  text:"æˆ‘ç¶“å¸¸é£Ÿç”¨é«˜æº«ã€æ²¹ç‚¸æˆ–ç‡’ç…®çš„é£Ÿç‰©" },
    { id:"q8",  type:"yn",  text:"æˆ‘æœ‰å¸è¸ç¿’æ…£" },
    { id:"q9",  type:"yn",  text:"æˆ‘å¸¸ç¯€é£Ÿä»¥æ¸›è¼•é«”é‡" },
    { id:"q10", type:"sex", text:"æˆ‘çš„æ€§åˆ¥" },
    { id:"q11", type:"age", text:"æˆ‘çš„å¹´é½¡ç¯„åœ" },
  ];

  const LABEL = {
    vitA:"ç¶­ç”Ÿç´ A",
    vitB:"ç¶­ç”Ÿç´ Bï¼ˆB1/B2/B6ï¼‰",
    vitC:"ç¶­ç”Ÿç´ C",
    vitD:"ç¶­ç”Ÿç´ D",
    vitE:"ç¶­ç”Ÿç´ E",
    ca_mg:"éˆ£é‚ï¼ˆéˆ£/é‚ï¼‰",
    iron:"éµ",
    fiber:"è†³é£Ÿçº–ç¶­",
    trace:"å¾®é‡å…ƒç´ ï¼ˆç¢˜/ç¡’ï¼‰",
  };
  const PCT_ORDER = ["vitA","vitB","vitC","vitD","vitE","ca_mg","iron","fiber","trace"];

  // æ‰£åˆ†ï¼ˆå›ºå®šï¼‰
  const DEDUCT = {
    q1: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
    q2: { vitA:20, vitB:16, vitC:20, vitE:16, fiber:25, trace:16 },
    q3: { vitB:17, vitE:17, iron:16, fiber:25, trace:17 },
    q4: { vitA:20, vitB:17, vitD:25, ca_mg:25 },
    q5: { ca_mg:25, iron:17, trace:17 },
    q6: { vitD:25, iron:17, trace:16 },
    q7: { vitB:16, vitC:20, vitE:17 },
    q8: { vitA:20, vitC:20, vitE:16, iron:16 },
    q9: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
  };

  // åƒè€ƒå€¼ï¼ˆå›ºå®šé è¨­ï¼›è‹¥ä½ è¦æ”¹æˆå¯ç·¨è¡¨ï¼Œæˆ‘å†åŠ å›å»ï¼‰
  const TARGETS_COMBINED_DEFAULT = {
    child: {
      vitA:"1500Âµg", vitB:"B1:0.9mg, B2:1mg, B6:1mg", vitC:"1200mg", vitD:"50Âµg", vitE:"300mg",
      ca_mg:"éˆ£:1500mg, é‚:250mg", iron:"30mg", fiber:"20g", trace:"ç¢˜:90Âµg, ç¡’:30Âµg"
    },
    teen: {
      vitA:"2500Âµg", vitB:"B1:1.2mg, B2:1.3mg, B6:1.5mg", vitC:"1800mg", vitD:"50Âµg", vitE:"800mg",
      ca_mg:"éˆ£:2500mg, é‚:350mg", iron:"40mg", fiber:"25g", trace:"ç¢˜:130Âµg, ç¡’:55Âµg"
    },
    adultFemale: {
      vitA:"3000Âµg", vitB:"B1:0.9mg, B2:1mg, B6:1.5mg", vitC:"2000mg", vitD:"50Âµg", vitE:"1000mg",
      ca_mg:"éˆ£:2500mg, é‚:320mg", iron:"45mg", fiber:"27g", trace:"ç¢˜:150Âµg, ç¡’:55Âµg"
    },
    adultMale: {
      vitA:"3000Âµg", vitB:"B1:1.2mg, B2:1.3mg, B6:1.6mg", vitC:"2000mg", vitD:"50Âµg", vitE:"1000mg",
      ca_mg:"éˆ£:2500mg, é‚:380mg", iron:"40mg", fiber:"34g", trace:"ç¢˜:150Âµg, ç¡’:55Âµg"
    },
  };

  // ===== helpers =====
  const $ = (id)=>document.getElementById(id);
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toast(msg){
    const wrap = $("toastWrap");
    const div = document.createElement("div");
    div.className = "card rounded-2xl px-4 py-3 border border-emerald-200";
    div.innerHTML = `<div class="text-sm text-slate-950 font-black">${escapeHtml(msg)}</div>`;
    wrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }
  function showErr(e){
    $("errBanner").classList.remove("hidden");
    $("errText").textContent = String(e?.stack || e?.message || e || "");
  }
  function clearErr(){
    $("errBanner").classList.add("hidden");
    $("errText").textContent = "";
  }

  function apiBase(){ return ($("inApiBase").value || "").trim().replace(/\/$/,""); }
  function adminKey(){ return ($("inAdminKey").value || "").trim(); }

  async function apiJson(path, bodyObj){
    const base = apiBase();
    if(!base) throw new Error("API Base ä¸å¯ç©ºç™½");
    const headers = { "Content-Type":"application/json" };
    const k = adminKey();
    if(k) headers["X-Admin-Key"] = k;

    const res = await fetch(base + path, {
      method:"POST",
      headers,
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }
  async function apiForm(path, formData){
    const base = apiBase();
    if(!base) throw new Error("API Base ä¸å¯ç©ºç™½");
    const headers = {};
    const k = adminKey();
    if(k) headers["X-Admin-Key"] = k;

    const res = await fetch(base + path, { method:"POST", headers, body: formData });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }
  async function kvGet(key){
    const r = await apiJson("/loadAny", { namespace:"DB", keyword:key });
    return r?.payload ?? r;
  }
  async function kvPut(key, payload){
    await apiJson("/putAny", { namespace:"DB", keyword:key, payload });
  }

  let CONNECTED = false;
  function setConn(ok){
    CONNECTED = !!ok;
    const pill = $("pillConn");
    pill.textContent = ok ? "å·²é€£ç·š" : "æœªé€£ç·š";
    pill.className = "pill " + (ok ? "pill-ok" : "pill-bad");
  }
  async function connect(){
    clearErr();
    await apiJson("/listAll", {});
    setConn(true);
    toast("é€£ç·šæˆåŠŸ âœ…");
  }

  // ===== Links UI =====
  let buyLinks = {};
  function normalizeUrl(u){
    const s = (u || "").trim();
    if(!s) return "";
    if(/^https?:\/\//i.test(s)) return s;
    if(/^www\./i.test(s)) return "https://" + s;
    return s;
  }
  function renderLinksEditor(){
    const wrap = $("linksEditor");
    wrap.innerHTML = "";
    BUY_ITEMS.forEach(item=>{
      const row = document.createElement("div");
      row.innerHTML = `
        <div class="flex items-center gap-2">
          <div class="w-28 text-sm font-black">${escapeHtml(item.label)}</div>
          <input class="in mono" style="padding:.55rem .8rem;border-radius:14px" data-k="${escapeHtml(item.key)}" placeholder="https://..." value="${escapeHtml(buyLinks[item.key]||"")}"/>
        </div>
      `;
      wrap.appendChild(row);
    });
    wrap.querySelectorAll("input[data-k]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const k = inp.getAttribute("data-k");
        buyLinks[k] = normalizeUrl(inp.value);
      });
    });
  }

  // ===== Survey payload =====
  function buildSurveyPayload(){
    const kw = ($("inKeyword").value || "").trim();
    if(!kw) throw new Error("è«‹å¡«ã€å•Ÿå‹•é—œéµå­—ã€");

    const ageOpts = [AGE_CHILD, AGE_TEEN, AGE_ADULT];
    const nodes = {};
    for(let i=0;i<QUESTIONS.length;i++){
      const q = QUESTIONS[i];
      const nextId = QUESTIONS[i+1]?.id || "";
      if(q.type==="yn"){
        nodes[q.id] = { q:q.text, type:"yn", options:[{t:"æ˜¯",value:"æ˜¯",next:nextId},{t:"ä¸æ˜¯",value:"ä¸æ˜¯",next:nextId}] };
      }else if(q.type==="sex"){
        nodes[q.id] = { q:q.text, type:"sex", options:[{t:"ç”·",value:"ç”·",next:nextId},{t:"å¥³",value:"å¥³",next:nextId}] };
      }else if(q.type==="age"){
        nodes[q.id] = { q:q.text, type:"age", options:[
          {t:ageOpts[0],value:ageOpts[0],next:nextId},
          {t:ageOpts[1],value:ageOpts[1],next:nextId},
          {t:ageOpts[2],value:ageOpts[2],next:nextId},
        ] };
      }
    }

    return {
      version: "life11-simple-publish",
      name: "life11",
      title: "ç”Ÿæ´»å‹æ…‹ç‡Ÿé¤Šå•å·ï¼ˆ11é¡Œï¼‰",
      keyword: kw,
      start: "q1",
      rules: { yn_yes: DEDUCT, sex:{ "ç”·":{}, "å¥³":{} }, age:{} },
      targetsExcel: { combined: TARGETS_COMBINED_DEFAULT }, // âœ… ç°¡ç‰ˆå…ˆå›ºå®š
      nodes,
      order: QUESTIONS.map(x=>x.id),
      nutrients: LABEL,
      ui: { ageOptions:{ child:ageOpts[0], teen:ageOpts[1], adult:ageOpts[2] } }
    };
  }

  // ===== Upload R2 =====
  function pad2(n){ return String(n).padStart(2,"0"); }
  function autoKeyForUpload(file){
    const d = new Date();
    const stamp = `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
    const ext = (file?.name || "").split(".").pop()?.toLowerCase();
    const safeExt = (ext && ext.length <= 6) ? ext : "png";
    return `assets/life11/report_bg_${stamp}.${safeExt}`;
  }
  async function uploadToR2(){
    if(!CONNECTED) throw new Error("æœªé€£ç·š");
    const f = $("upFile").files?.[0];
    if(!f) throw new Error("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");

    const fd = new FormData();
    fd.append("file", f);
    fd.append("key", autoKeyForUpload(f));
    fd.append("contentType", f.type || "application/octet-stream");

    const r = await apiForm("/upload", fd);
    const url = r?.url || r?.publicUrl || r?.result?.url || r?.result?.publicUrl || r?.payload?.url || "";
    if(!url) throw new Error("ä¸Šå‚³æˆåŠŸä½†æ²’æ‹¿åˆ° URLï¼ˆè«‹ç¢ºèª Worker /upload å›å‚³ {url} æˆ– {publicUrl}ï¼‰");
    $("upResultUrl").value = url;
    toast("ä¸Šå‚³æˆåŠŸ âœ…");
    return url;
  }

  // ===== Image render (same look) =====
  let lastPng = "";
  let lastAreas = [];

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function pctColor(p){ if(p<35) return "#ff4d4f"; if(p<70) return "#fbbf24"; return "#34d399"; }

  async function loadImg(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>resolve(img);
      img.onerror = ()=>reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š" + url));
      img.src = url;
    });
  }
  function roundRect(ctx, x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  function drawCircleAvatar(ctx, img, cx, cy, r){
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(img, cx - r, cy - r, r*2, r*2);
    ctx.restore();
  }

  // ç°¡ç‰ˆï¼šç”¨å›ºå®šæ¨¡æ“¬ç­”æ¡ˆï¼ˆä½ åªéœ€è¦æª¢æŸ¥ç‰ˆé¢ï¼‰
  function getRemainSample(){
    // é€™è£¡ç”¨ã€Œåä¸­ç­‰ã€ç¤ºæ„ï¼Œæ­£å¼ç”± worker è¨ˆç®—å¾Œç™¼çµ¦å®¢æˆ¶
    const remain = { vitA:78, vitB:66, vitC:72, vitD:55, vitE:62, ca_mg:58, iron:51, fiber:50, trace:66 };
    const ans = { q10:"ç”·", q11:AGE_ADULT };
    return { ans, remain };
  }

  function capTextFromCombined(key, ans){
    const age = ans.q11;
    const sex = ans.q10;
    const bucket = age.includes("0~10") ? "child" : age.includes("11~18") ? "teen" : (sex==="å¥³" ? "adultFemale" : "adultMale");
    const t = TARGETS_COMBINED_DEFAULT[bucket] || {};
    if(key==="vitB") return (t.vitB || "").match(/B1:(.*?)mg.*B2:(.*?)mg.*B6:(.*?)mg/i) ? `${RegExp.$1}/${RegExp.$2}/${RegExp.$3}mg` : (t.vitB||"-");
    if(key==="ca_mg") return (t.ca_mg || "").match(/éˆ£:(.*?)mg.*é‚:(.*?)mg/i) ? `${RegExp.$1}/${RegExp.$2}mg` : (t.ca_mg||"-");
    if(key==="trace") return (t.trace || "").match(/ç¢˜:(.*?)Âµg.*ç¡’:(.*?)Âµg/i) ? `${RegExp.$1}/${RegExp.$2}Âµg` : (t.trace||"-");
    return t[key] || "-";
  }

  async function renderReport(){
    const bgUrl = ($("inBgUrl").value||"").trim();
    if(!bgUrl) throw new Error("è«‹å¡«åº•æ¿åœ–ç‰‡URL");
    const W=900,H=1600;
    const cv=$("cvReport"); cv.width=W; cv.height=H;
    const ctx=cv.getContext("2d");
    lastAreas = [];

    const bg=await loadImg(bgUrl);
    ctx.drawImage(bg,0,0,W,H);

    const { ans, remain } = getRemainSample();

    // Header panel
    ctx.save();
    ctx.globalAlpha=0.22; ctx.fillStyle="#000";
    roundRect(ctx,48,48,W-96,190,46); ctx.fill();
    ctx.restore();

    try{
      const av=await loadImg(DEFAULT_LINE_AVATAR_URL);
      drawCircleAvatar(ctx,av,140,140,58);
      ctx.save(); ctx.strokeStyle="rgba(255,255,255,.85)"; ctx.lineWidth=6;
      ctx.beginPath(); ctx.arc(140,140,60,0,Math.PI*2); ctx.stroke(); ctx.restore();
    }catch{}

    ctx.fillStyle="rgba(255,255,255,.96)";
    ctx.textAlign="left";
    ctx.font="bold 44px Microsoft JhengHei, sans-serif";
    ctx.fillText(DEFAULT_LINE_NAME,230,128);
    ctx.fillStyle="rgba(255,255,255,.90)";
    ctx.font="bold 26px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\",\"Courier New\", monospace";
    ctx.fillText(DEFAULT_LINE_ID,230,172);
    ctx.fillStyle="rgba(255,255,255,.86)";
    ctx.font="bold 22px Microsoft JhengHei, sans-serif";
    ctx.fillText(`å¹´é½¡:${ans.q11} Â· æ€§åˆ¥:${ans.q10}`,230,208);

    // Bars panel
    const listX=56, listY=270, listW=W-listX*2;
    const rowH=94, gapY=12;
    const panelH=(rowH+gapY)*PCT_ORDER.length-gapY+28;

    ctx.save(); ctx.globalAlpha=0.18; ctx.fillStyle="#0b122b";
    roundRect(ctx,42,listY-14,W-84,panelH,36); ctx.fill(); ctx.restore();

    for(let i=0;i<PCT_ORDER.length;i++){
      const k=PCT_ORDER[i];
      const x=listX;
      const y=listY+i*(rowH+gapY);
      const pct=clamp(remain[k],0,100);
      const cap=capTextFromCombined(k,ans);

      ctx.save(); ctx.globalAlpha=0.16; ctx.fillStyle="#fff";
      roundRect(ctx,x,y,listW,rowH,22); ctx.fill(); ctx.restore();

      ctx.strokeStyle="rgba(255,255,255,.40)"; ctx.lineWidth=2;
      roundRect(ctx,x,y,listW,rowH,22); ctx.stroke();

      ctx.textAlign="left";
      ctx.fillStyle="rgba(255,255,255,.98)";
      ctx.font="bold 26px Microsoft JhengHei, sans-serif";
      ctx.fillText(LABEL[k]||k,x+18,y+38);

      ctx.fillStyle="rgba(255,255,255,.94)";
      ctx.font="bold 24px Microsoft JhengHei, sans-serif";
      ctx.fillText(cap,x+18,y+72);

      const barX=x+330, barY=y+34, barW=listW-330-18, barH=30;
      ctx.fillStyle="rgba(255,255,255,.22)";
      roundRect(ctx,barX,barY,barW,barH,15); ctx.fill();

      const fillW=Math.max(0, Math.min(barW, barW*(pct/100)));
      ctx.fillStyle=pctColor(pct);
      roundRect(ctx,barX,barY,fillW,barH,15); ctx.fill();

      ctx.textAlign="center";
      ctx.fillStyle="rgba(255,255,255,.98)";
      ctx.font="bold 20px Microsoft JhengHei, sans-serif";
      ctx.fillText(`${pct}%`,barX+barW/2,barY+22);
    }

    // Buttons section
    const afterBarsY=(listY-14)+panelH+24;
    ctx.save(); ctx.globalAlpha=0.22; ctx.fillStyle="#000";
    const btnCols=3, btnGapX=16, btnGapY2=16, btnH=62;
    const btnW=Math.floor((W-84 - btnGapX*(btnCols-1))/btnCols);
    const btnRows=Math.ceil(BUY_ITEMS.length/btnCols);
    const boxH=52+(btnRows*btnH)+((btnRows-1)*btnGapY2)+28;
    roundRect(ctx,42,afterBarsY-12,W-84,boxH,36); ctx.fill(); ctx.restore();

    ctx.textAlign="left";
    ctx.fillStyle="rgba(255,255,255,.98)";
    ctx.font="bold 26px Microsoft JhengHei, sans-serif";
    ctx.fillText("æ‚¨çš„æ¯æ—¥æ”å–å°šéœ€(é»æ“Šäº†è§£)ï¼š",56,afterBarsY+30);

    const btnStartX=42, btnStartY=afterBarsY+52;
    for(let i=0;i<BUY_ITEMS.length;i++){
      const item=BUY_ITEMS[i];
      const col=i%btnCols, row=Math.floor(i/btnCols);
      const x=btnStartX+col*(btnW+btnGapX);
      const y=btnStartY+row*(btnH+btnGapY2);

      ctx.save(); ctx.globalAlpha=0.20; ctx.fillStyle="#fff";
      roundRect(ctx,x,y,btnW,btnH,24); ctx.fill(); ctx.restore();
      ctx.strokeStyle="rgba(255,255,255,.45)"; ctx.lineWidth=2;
      roundRect(ctx,x,y,btnW,btnH,24); ctx.stroke();

      ctx.textAlign="center";
      ctx.fillStyle="rgba(255,255,255,.98)";
      ctx.font="bold 22px Microsoft JhengHei, sans-serif";
      ctx.fillText(item.label,x+btnW/2,y+40);

      const url = normalizeUrl(buyLinks[item.key]||"");
      lastAreas.push({ key:item.key, label:item.label, x:Math.round(x), y:Math.round(y), w:Math.round(btnW), h:Math.round(btnH), url });
    }

    lastPng = cv.toDataURL("image/png");
    toast("å·²ç”¢ç”Ÿåœ–ç‰‡ âœ…");
  }

  function downloadPng(){
    if(!lastPng) throw new Error("è«‹å…ˆç”¢ç”Ÿåœ–ç‰‡");
    const a=document.createElement("a");
    a.href=lastPng; a.download="nutrition_report.png"; a.click();
  }
  function exportAreas(){
    if(!lastAreas.length) throw new Error("è«‹å…ˆç”¢ç”Ÿåœ–ç‰‡");
    const payload={ canvas:{width:900,height:1600}, areas:lastAreas.filter(a=>!!a.url) };
    $("outAreas").value = JSON.stringify(payload,null,2);
    toast("å·²åŒ¯å‡ºé»æ“Šå€ âœ…");
  }

  // ===== Publish (one click) =====
  async function publish(){
    clearErr();
    if(!CONNECTED) await connect();

    const kw = ($("inKeyword").value||"").trim();
    if(!kw) throw new Error("è«‹å¡«ã€å•Ÿå‹•é—œéµå­—ã€");
    if(!($("inBgUrl").value||"").trim()) throw new Error("è«‹å¡«åº•æ¿URLï¼ˆæˆ–å…ˆä¸Šå‚³R2å†å¥—ç”¨ï¼‰");

    // 1) Survey
    const survey = buildSurveyPayload();
    await kvPut(Q_KEY, survey);

    // 2) KW_MAP
    let map = {};
    try{
      const raw = await kvGet(KW_MAP_KEY);
      if(raw && typeof raw==="object") map = raw;
    }catch{}
    map[kw] = "life11";
    await kvPut(KW_MAP_KEY, map);

    // 3) Links
    await kvPut(LINKS_KEY, buyLinks);

    // 4) Default asset
    const asset = {
      ctaTitle: ($("inAssetTitle").value||"").trim(),
      imageUrl: ($("inAssetImage").value||"").trim(),
      linkUrl:  ($("inAssetLink").value||"").trim(),
    };
    await kvPut(ASSET_DEFAULT_KEY, asset);

    // 5) Render PNG now
    await renderReport();

    toast("ğŸš€ ç™¼ä½ˆå®Œæˆ âœ…ï¼ˆKV å…¨éƒ¨å·²æ›´æ–°ï¼‰");
  }

  // ===== Load cloud =====
  async function loadCloud(){
    clearErr();
    if(!CONNECTED) await connect();

    const q = await kvGet(Q_KEY).catch(()=>null);
    if(q && typeof q==="object"){
      if(q.keyword) $("inKeyword").value = q.keyword;
      toast("å·²è®€å–é›²ç«¯å•å·è¨­å®š âœ…");
    }

    const links = await kvGet(LINKS_KEY).catch(()=>null);
    if(links && typeof links==="object"){
      buyLinks = links;
      renderLinksEditor();
      toast("å·²è®€å–é›²ç«¯è³¼è²·é€£çµ âœ…");
    }

    const asset = await kvGet(ASSET_DEFAULT_KEY).catch(()=>null);
    if(asset && typeof asset==="object"){
      $("inAssetTitle").value = asset.ctaTitle || "";
      $("inAssetImage").value = asset.imageUrl || "";
      $("inAssetLink").value  = asset.linkUrl  || "";
      toast("å·²è®€å–é›²ç«¯çµ±ä¸€å¼•æµåœ– âœ…");
    }
  }

  // ===== UI events =====
  $("btnConnect").addEventListener("click", async ()=>{
    try{ await connect(); } catch(e){ showErr(e); setConn(false); }
  });
  $("btnLoad").addEventListener("click", async ()=>{
    try{ await loadCloud(); } catch(e){ showErr(e); }
  });
  $("btnUploadR2").addEventListener("click", async ()=>{
    try{
      if(!CONNECTED) await connect();
      const url = await uploadToR2();
      $("upResultUrl").value = url;
    }catch(e){ showErr(e); }
  });
  $("btnUseAsBg").addEventListener("click", ()=>{
    const u = ($("upResultUrl").value||"").trim();
    if(!u) return toast("æ²’æœ‰ä¸Šå‚³URL");
    $("inBgUrl").value = u;
    toast("å·²å¥—ç”¨åº•æ¿URL âœ…");
  });
  $("btnRenderImg").addEventListener("click", async ()=>{
    try{ await renderReport(); }catch(e){ showErr(e); }
  });
  $("btnDownloadImg").addEventListener("click", ()=>{
    try{ downloadPng(); }catch(e){ showErr(e); }
  });
  $("btnExportAreas").addEventListener("click", ()=>{
    try{ exportAreas(); }catch(e){ showErr(e); }
  });
  $("btnPublish").addEventListener("click", async ()=>{
    try{ await publish(); }catch(e){ showErr(e); }
  });

  // init
  renderLinksEditor();
})();
</script>
</body>
</html>
