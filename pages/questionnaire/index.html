<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI 問卷後台 admin（單一貼上套用版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --bd:rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.90);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
    }
    body{
      color:var(--ink);
      background: linear-gradient(135deg, #f8fafc, #eef2ff, #ecfeff);
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .card{ background: var(--glass); backdrop-filter: blur(10px); box-shadow: var(--shadow); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .thinbar::-webkit-scrollbar{ height:10px; width:10px; }
    .thinbar::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.18); border-radius: 999px; }
    .safe-bottom{ padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>

<body class="min-h-screen safe-bottom">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">AI 問卷後台 admin</h1>
        <p class="text-slate-600 mt-1 text-sm">
          單一貼上區：一次輸入「題目＋四選一選項＋跳題＋reportKey＋報告模板」，一鍵套用並儲存到 KV
        </p>
      </div>
      <div class="text-xs text-slate-600 leading-5">
        <div class="font-bold">Worker 需支援：</div>
        <div class="mono">POST /listAll</div>
        <div class="mono">POST /putAny</div>
        <div class="mono">POST /loadAny</div>
        <div class="mono">POST /deleteAny</div>
      </div>
    </header>

    <!-- CONNECT -->
    <section class="card rounded-2xl p-4 border border-slate-200">
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="text-sm font-semibold text-slate-700">Worker 網址</label>
          <input id="inApiBase" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                 placeholder="https://api.xxx.workers.dev" />
          <div class="text-xs text-slate-500 mt-2">
            問卷Key：<span class="mono font-semibold">AI_SURVEY:Q:&lt;name&gt;</span>　
            關鍵字表：<span class="mono font-semibold">AI_SURVEY:KW_MAP</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="btnConnect" class="w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">連線</button>
          <button id="btnSaveSurvey" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 font-semibold">儲存到 KV</button>
        </div>
      </div>

      <div class="mt-2 text-xs text-slate-500">
        狀態：<span id="txtStatus" class="font-semibold">未連線</span>　
        最後同步：<span id="txtLastSync" class="mono">-</span>
      </div>

      <div id="errBanner" class="hidden mt-3 rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
        <div class="font-extrabold">頁面出錯</div>
        <div id="errText" class="mt-1 mono text-[12px] whitespace-pre-wrap"></div>
      </div>
    </section>

    <div class="grid lg:grid-cols-3 gap-4 mt-4">
      <!-- LEFT: list -->
      <aside class="card rounded-2xl p-4 border border-slate-200 h-fit lg:sticky lg:top-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-500">問卷清單</div>
            <div class="text-sm text-slate-900 font-semibold">載入 / 刪除</div>
          </div>
          <button id="btnNew" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">新增</button>
        </div>

        <div class="mt-3">
          <input id="qSearch" class="w-full px-4 py-2 rounded-xl border border-slate-200" placeholder="搜尋…" />
        </div>

        <div id="surveyList" class="mt-3 space-y-2"></div>
      </aside>

      <!-- RIGHT: one paste -->
      <main class="lg:col-span-2 space-y-4">
        <section class="card rounded-2xl p-5 border border-slate-200">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-lg font-extrabold text-slate-900">單一貼上區（一次套用）</h2>
              <p class="text-sm text-slate-600 mt-1">
                你只需要在這裡貼：<span class="font-semibold">問卷資訊 + NODE（題目/選項）+ REPORT（報告模板）</span>
              </p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <button id="btnPasteExample" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">塞入範例</button>
              <button id="btnApplyPaste" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">套用到問卷</button>
              <button id="btnValidate" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">檢查</button>
            </div>
          </div>

          <div class="mt-4">
            <textarea id="inPaste" rows="18"
              class="w-full px-4 py-3 rounded-2xl border border-slate-200 mono thinbar"
              style="min-height: 360px; max-height: 70vh; overflow:auto;"
              placeholder="把內容貼在這裡…"></textarea>
          </div>

          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
              <div class="text-sm font-extrabold text-slate-900">目前套用內容</div>
              <div class="mt-2 text-xs text-slate-600 leading-6">
                <div>NAME：<span id="txtCurName" class="mono font-semibold">-</span></div>
                <div>TITLE：<span id="txtCurTitle" class="mono font-semibold">-</span></div>
                <div>KEYWORD：<span id="txtCurKeyword" class="mono font-semibold">-</span></div>
                <div>START：<span id="txtCurStart" class="mono font-semibold">-</span></div>
              </div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
              <div class="text-sm font-extrabold text-slate-900">統計</div>
              <div class="mt-2 text-xs text-slate-600 leading-6">
                <div>Nodes：<span id="txtNodeCount" class="mono font-semibold">0</span></div>
                <div>模板（reports）：<span id="txtReportCount" class="mono font-semibold">0</span></div>
                <div class="text-[11px] text-slate-500 mt-1">每個 NODE 必須「四選一（4個選項）」</div>
              </div>
            </div>
          </div>
        </section>

        <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(92vw,560px)] space-y-2 z-50"></div>
      </main>
    </div>
  </div>

<script>
/* ============================================================
   ✅ admin.html（單一貼上套用版）
   - 只保留乾淨必要功能：連線、載入/刪除問卷、單一貼上套用、檢查、儲存
   - 解析格式支援：
     NAME/TITLE/KEYWORD/START/FINAL
     NODE: <id>
     Q: <question>
     - <text> -> next=<id|END> report=<reportKey可空>
     REPORT: <reportKey>
     BODY:
     <多行模板>
     ENDREPORT
   ============================================================ */

(() => {
  // ---------- constants ----------
  const Q_PREFIX = "AI_SURVEY:Q:";
  const KW_MAP_KEY = "AI_SURVEY:KW_MAP";

  // ---------- state ----------
  let API_BASE = "";
  let SURVEYS = [];
  let CURRENT = makeEmptySurvey();
  let KW_MAP = {};

  // ---------- DOM helper ----------
  const $ = (id) => document.getElementById(id);

  // ---------- safe errors ----------
  const showErr = (msg) => {
    try{
      $("errBanner").classList.remove("hidden");
      $("errText").textContent = String(msg || "");
    }catch{}
  };
  window.addEventListener("error", (e) => {
    showErr(e?.error?.stack || e?.message || e);
  });

  // ---------- ui ----------
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toast(msg, type="ok"){
    const wrap = $("toastWrap");
    if(!wrap) return alert(msg);
    const div = document.createElement("div");
    const bd = type==="ok" ? "border-emerald-200" : type==="warn" ? "border-amber-200" : "border-rose-200";
    const bg = type==="ok" ? "bg-emerald-50/80" : type==="warn" ? "bg-amber-50/80" : "bg-rose-50/80";
    div.className = `card rounded-2xl px-4 py-3 border ${bd} ${bg}`;
    div.innerHTML = `<div class="text-sm text-slate-900 font-semibold">${escapeHtml(msg)}</div>`;
    wrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }
  function normKw(s){
    return String(s||"").trim().replace(/\s+/g,"").toLowerCase();
  }

  // ---------- model ----------
  function makeEmptySurvey(){
    return {
      name: "",
      title: "",
      keyword: "",
      start: "q1",
      final: { text: "" },
      nodes: {},
      reports: {}
    };
  }
  function normalizeSurvey(obj){
    const base = makeEmptySurvey();
    if(obj && typeof obj === "object"){
      base.name = obj.name || base.name;
      base.title = obj.title || base.title;
      base.keyword = obj.keyword || base.keyword;
      base.start = obj.start || base.start;
      base.final = (obj.final && typeof obj.final==="object") ? obj.final : base.final;
      base.nodes = (obj.nodes && typeof obj.nodes==="object") ? obj.nodes : base.nodes;
      base.reports = (obj.reports && typeof obj.reports==="object") ? obj.reports : base.reports;
    }
    base.nodes = base.nodes || {};
    for(const nodeId of Object.keys(base.nodes)){
      const n = base.nodes[nodeId] || {};
      n.q = String(n.q || "").trim();
      n.options = Array.isArray(n.options) ? n.options : [];
      n.options = n.options.map(o => ({
        t: String(o?.t || "").trim(),
        next: String(o?.next || "").trim(),
        reportKey: String(o?.reportKey || "").trim(),
      }));
      base.nodes[nodeId] = n;
    }
    base.reports = base.reports || {};
    return base;
  }

  // ---------- API ----------
  async function api(path, bodyObj){
    if(!API_BASE) throw new Error("Worker 網址未設定");
    const res = await fetch(API_BASE.replace(/\/$/,"") + path, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }

  async function kvGet(key){
    const r = await api("/loadAny", { namespace:"DB", keyword: key });
    return r?.payload ?? r;
  }
  async function kvPut(key, payload){
    await api("/putAny", { namespace:"DB", keyword: key, payload });
  }
  async function kvDel(key){
    await api("/deleteAny", { namespace:"DB", keyword: key });
  }

  // ---------- KW MAP ----------
  async function refreshKwMap(){
    try{
      const raw = await kvGet(KW_MAP_KEY);
      KW_MAP = (raw && typeof raw === "object") ? raw : {};
    }catch{
      KW_MAP = {};
    }
  }
  async function saveKwMap(){
    await kvPut(KW_MAP_KEY, KW_MAP);
  }
  function keywordOwner(kw){
    const k = normKw(kw);
    if(!k) return "";
    return KW_MAP[k] || "";
  }

  // ---------- survey list ----------
  async function refreshSurveyList(){
    const data = await api("/listAll", {});
    const db = data.db || [];
    SURVEYS = db
      .filter(k => k.startsWith(Q_PREFIX))
      .map(k => ({ key:k, name:k.replace(Q_PREFIX,"") }))
      .sort((a,b)=>a.name.localeCompare(b.name,"zh-Hant"));
    renderSurveyList();
  }

  function renderSurveyList(){
    const wrap = $("surveyList");
    wrap.innerHTML = "";
    const q = ($("qSearch").value || "").trim().toLowerCase();
    const items = SURVEYS.filter(x => !q || x.name.toLowerCase().includes(q));

    if(items.length===0){
      const d = document.createElement("div");
      d.className = "rounded-2xl border border-dashed border-slate-300 bg-white/60 p-4 text-slate-600 text-sm";
      d.textContent = "目前沒有問卷。按「新增」建立。";
      wrap.appendChild(d);
      return;
    }

    items.forEach(x=>{
      const row = document.createElement("div");
      row.className = "rounded-2xl bg-white/70 border border-slate-200 overflow-hidden";

      const top = document.createElement("div");
      top.className = "px-4 py-3 flex items-start justify-between gap-3";

      const left = document.createElement("button");
      left.className = "text-left min-w-0 flex-1 hover:opacity-80";
      left.innerHTML = `
        <div class="font-semibold text-slate-900 truncate">${escapeHtml(x.name)}</div>
        <div class="text-xs text-slate-500 mono truncate">${escapeHtml(x.key)}</div>
      `;
      left.onclick = async ()=>{
        try{
          const loaded = await kvGet(x.key);
          CURRENT = normalizeSurvey(loaded);
          updateCurrentMetaUI();
          toast("已載入：" + x.name);
        }catch(e){
          toast(e.message, "err");
        }
      };

      const del = document.createElement("button");
      del.className = "shrink-0 px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-500 font-extrabold text-sm";
      del.textContent = "刪除";
      del.onclick = async ()=>{
        const ok = confirm(`確定刪除「${x.name}」？（會連同關鍵字綁定一起刪）`);
        if(!ok) return;
        try{
          await surveyDeleteByName(x.name);
          toast("已刪除：" + x.name);
          if((CURRENT.name||"") === x.name){
            CURRENT = makeEmptySurvey();
            updateCurrentMetaUI();
          }
          await refreshKwMap();
          await refreshSurveyList();
        }catch(e){
          toast(e.message, "err");
        }
      };

      top.appendChild(left);
      top.appendChild(del);
      row.appendChild(top);
      wrap.appendChild(row);
    });
  }

  async function surveyDeleteByName(name){
    const key = Q_PREFIX + name;

    // 先讀問卷，拿 keyword
    let survey = null;
    try{ survey = await kvGet(key); }catch{}
    await kvDel(key);

    // 移除 KW_MAP 綁定
    await refreshKwMap();
    const kw = normKw(survey?.keyword || "");
    if(kw && KW_MAP[kw] === name) delete KW_MAP[kw];
    for(const k of Object.keys(KW_MAP)){
      if(KW_MAP[k] === name) delete KW_MAP[k];
    }
    await saveKwMap();
  }

  // ---------- paste parser ----------
  function parsePaste(text){
    const lines = (text||"").replace(/\r/g,"").split("\n");

    const out = {
      name: "",
      title: "",
      keyword: "",
      start: "q1",
      final: "",
      nodes: {},
      reports: {}
    };

    let i = 0;

    // node temp
    let curNodeId = "";
    let curQ = "";
    let curOpts = [];

    const flushNode = ()=>{
      if(!curNodeId) return;
      out.nodes[curNodeId] = { q: curQ || "", options: curOpts.slice() };
      curNodeId = "";
      curQ = "";
      curOpts = [];
    };

    // report temp
    let inReport = false;
    let reportKey = "";
    let reportBuf = [];

    const flushReport = ()=>{
      if(!reportKey) return;
      out.reports[reportKey] = reportBuf.join("\n").trim();
      reportKey = "";
      reportBuf = [];
    };

    while(i < lines.length){
      const raw = lines[i] ?? "";
      const line = raw.trim();

      // skip empty
      if(!line){
        if(inReport) reportBuf.push(""); // keep blank lines in report body
        i++; continue;
      }

      // REPORT block
      if(/^REPORT\s*:/i.test(line)){
        flushNode();
        // start new report
        if(inReport) flushReport();
        inReport = true;
        reportKey = line.split(":").slice(1).join(":").trim();
        reportBuf = [];
        i++; continue;
      }
      if(inReport){
        if(/^BODY\s*:/i.test(line)){
          i++; continue;
        }
        if(/^ENDREPORT\b/i.test(line)){
          flushReport();
          inReport = false;
          i++; continue;
        }
        reportBuf.push(raw.replace(/\s+$/,"")); // keep original indentation mostly
        i++; continue;
      }

      // headers
      if(/^NAME\s*:/i.test(line)){ out.name = line.split(":").slice(1).join(":").trim(); i++; continue; }
      if(/^TITLE\s*:/i.test(line)){ out.title = line.split(":").slice(1).join(":").trim(); i++; continue; }
      if(/^KEYWORD\s*:/i.test(line)){ out.keyword = line.split(":").slice(1).join(":").trim(); i++; continue; }
      if(/^START\s*:/i.test(line)){ out.start = line.split(":").slice(1).join(":").trim(); i++; continue; }
      if(/^FINAL\s*:/i.test(line)){ out.final = line.split(":").slice(1).join(":").trim(); i++; continue; }

      // NODE
      if(/^NODE\s*:/i.test(line)){
        flushNode();
        curNodeId = line.split(":").slice(1).join(":").trim();
        curQ = "";
        curOpts = [];
        i++; continue;
      }
      if(/^Q\s*:/i.test(line)){
        curQ = line.split(":").slice(1).join(":").trim();
        i++; continue;
      }

      // option line
      const optm = line.match(/^\-\s*(.+)$/);
      if(optm && curNodeId){
        const full = optm[1].trim();
        const parts = full.split("->").map(x=>x.trim());
        const t = parts[0] || "";
        let next = "";
        let rk = "";

        if(parts[1]){
          const p = parts[1];
          const nextm = p.match(/next\s*=\s*([A-Za-z0-9_\-]+)/i);
          const repm = p.match(/report\s*=\s*([A-Za-z0-9_\-]*)/i);
          next = nextm ? nextm[1] : "";
          rk = repm ? (repm[1]||"") : "";
          if(String(next).toUpperCase() === "END") next = "";
        }
        curOpts.push({ t, next, reportKey: rk });
        i++; continue;
      }

      // unknown line -> ignore safely
      i++;
    }

    // flush tail
    if(inReport) flushReport();
    flushNode();

    // basic checks
    if(!out.name || !out.title || !out.keyword) throw new Error("缺少 NAME / TITLE / KEYWORD");
    if(!Object.keys(out.nodes).length) throw new Error("沒有讀到 NODE");
    if(!out.start) out.start = "q1";

    // enforce 4 options each node
    for(const nid of Object.keys(out.nodes)){
      const o = out.nodes[nid]?.options || [];
      if(o.length !== 4) throw new Error(`NODE ${nid} 不是四選一（目前 ${o.length} 個選項）`);
      for(let k=0;k<o.length;k++){
        if(!String(o[k].t||"").trim()) throw new Error(`NODE ${nid} 選項 ${k+1} 文字是空的`);
      }
    }

    return out;
  }

  function applyParsedToCurrent(parsed){
    CURRENT = makeEmptySurvey();
    CURRENT.name = String(parsed.name||"").trim();
    CURRENT.title = String(parsed.title||"").trim();
    CURRENT.keyword = normKw(parsed.keyword||"");
    CURRENT.start = String(parsed.start||"q1").trim();
    CURRENT.final = { text: String(parsed.final||"").trim() };
    CURRENT.nodes = parsed.nodes || {};
    CURRENT.reports = parsed.reports || {};
    updateCurrentMetaUI();
  }

  function updateCurrentMetaUI(){
    $("txtCurName").textContent = CURRENT.name || "-";
    $("txtCurTitle").textContent = CURRENT.title || "-";
    $("txtCurKeyword").textContent = CURRENT.keyword || "-";
    $("txtCurStart").textContent = CURRENT.start || "-";
    $("txtNodeCount").textContent = String(Object.keys(CURRENT.nodes||{}).length);
    $("txtReportCount").textContent = String(Object.keys(CURRENT.reports||{}).length);
  }

  // ---------- validation (before save) ----------
  function validateSurvey(){
    const name = String(CURRENT.name||"").trim();
    const title = String(CURRENT.title||"").trim();
    const kw = normKw(CURRENT.keyword||"");
    const start = String(CURRENT.start||"").trim();

    if(!name) throw new Error("NAME 空白（請先套用貼上內容）");
    if(!title) throw new Error("TITLE 空白（請先套用貼上內容）");
    if(!kw) throw new Error("KEYWORD 空白（請先套用貼上內容）");
    if(!start) throw new Error("START 空白（請先套用貼上內容）");

    const owner = keywordOwner(kw);
    if(owner && owner !== name) throw new Error("KEYWORD 已被其他問卷使用");

    const nodes = CURRENT.nodes || {};
    if(!nodes[start]) throw new Error(`起始節點不存在：${start}`);

    // next pointers must exist
    const usedReportKeys = new Set();
    for(const nodeId of Object.keys(nodes)){
      const node = nodes[nodeId];
      if(!String(node.q||"").trim()) throw new Error(`NODE ${nodeId} 題目是空的`);
      if(!Array.isArray(node.options) || node.options.length !== 4) throw new Error(`NODE ${nodeId} 不是四選一`);
      node.options.forEach((o, idx)=>{
        const nx = String(o.next||"").trim();
        if(nx && !nodes[nx]) throw new Error(`NODE ${nodeId} 選項 ${idx+1} next 指向不存在：${nx}`);
        const rk = String(o.reportKey||"").trim();
        if(rk) usedReportKeys.add(rk);
      });
    }
    if(usedReportKeys.size === 0) throw new Error("沒有任何 reportKey（請在最後一題四個選項填 report=xxx）");

    // report templates must exist for used keys
    const reports = CURRENT.reports || {};
    for(const rk of usedReportKeys){
      if(!reports[rk] || !String(reports[rk]).trim()){
        throw new Error(`缺少報告模板：REPORT ${rk}（請在貼上區補上 REPORT: ${rk} ... ENDREPORT）`);
      }
    }

    return { name, title, kw, start };
  }

  // ---------- save ----------
  async function saveSurveyToKV(){
    const { name, title, kw, start } = validateSurvey();

    // normalize and write
    CURRENT.name = name;
    CURRENT.title = title;
    CURRENT.keyword = kw;
    CURRENT.start = start;

    await kvPut(Q_PREFIX + CURRENT.name, CURRENT);

    // update KW_MAP (handle rename keyword)
    await refreshKwMap();
    for(const k of Object.keys(KW_MAP)){
      if(KW_MAP[k] === CURRENT.name && k !== kw) delete KW_MAP[k];
    }
    KW_MAP[kw] = CURRENT.name;
    await saveKwMap();

    $("txtLastSync").textContent = new Date().toLocaleString();
    toast("已儲存到 KV ✅");
    await refreshSurveyList();
  }

  // ---------- api base ----------
  function setApiBaseFromInput(){
    const v = ($("inApiBase").value || "").trim();
    if(!v) throw new Error("請輸入 Worker 網址");
    API_BASE = v;
    localStorage.setItem("ai_survey_admin_api_base", v);
  }
  function initApiBase(){
    const v = (localStorage.getItem("ai_survey_admin_api_base") || "").trim();
    if(v){
      API_BASE = v;
      $("inApiBase").value = v;
    }
  }

  // ---------- example ----------
  function exampleText(){
    return `NAME: 生活健康問卷_20題_四選一
TITLE: 3分鐘生活健康分析（20題）
KEYWORD: 生活問卷
START: q1
FINAL: 如果你願意，我可以再幫你做 7 天調整建議。

NODE: q1
Q: 你最近整體精神感受比較像？
- 很有精神 -> next=q2 report=
- 普通還可以 -> next=q2 report=
- 常覺得疲累 -> next=q2 report=
- 起床就沒力 -> next=q2 report=

NODE: q2
Q: 你最近的睡眠品質？
- 好，醒來清爽 -> next=q3 report=
- 還行，偶爾醒 -> next=q3 report=
- 常醒/淺眠 -> next=q3 report=
- 難入睡 -> next=q3 report=

NODE: q3
Q: 你最近的壓力感受？
- 不太有 -> next=q4 report=
- 偶爾有 -> next=q4 report=
- 常常有 -> next=q4 report=
- 很明顯、難放鬆 -> next=q4 report=

NODE: q4
Q: 你腸胃感受比較像？
- 順暢 -> next=q5 report=
- 偶爾不適 -> next=q5 report=
- 常脹氣/悶 -> next=q5 report=
- 容易拉肚子或便祕 -> next=q5 report=

NODE: q5
Q: 最後一題：你比較想先從哪個方向開始調整？
- 睡眠與作息 -> next=END report=life_sleep
- 壓力與放鬆 -> next=END report=life_stress
- 飲食與腸胃 -> next=END report=life_gut
- 體態與代謝 -> next=END report=life_metabolism

REPORT: life_sleep
BODY:
【優先方向】
先把作息與睡眠穩住，白天精神與食慾/代謝通常會一起改善。

【可能的常見缺口（方向提示）】
• 鎂、B群、維生素D（若少曬太陽）、晚餐蛋白質不足

【今天就能做的 3 件事】
1) 固定一個「上床時間」，睡前 60 分鐘停掉強刺激內容
2) 晚上減少含糖/酒精/濃茶咖啡因
3) 白天補足蛋白質與水分，晚上比較不會餓醒

【圖片】
（這裡可放圖片 URL）

【適合你的產品搭配】
A) 你的產品/連結
B) 你的產品/連結

提醒：若有慢性病/孕哺/用藥，請先詢問醫師或藥師。
ENDREPORT

REPORT: life_stress
BODY:
【優先方向】
先把壓力與放鬆做起來，睡眠與消化常會跟著改善。

【可能的常見缺口（方向提示）】
• 鎂、維生素C、Omega-3（若很少吃魚）、規律運動不足

【今天就能做的 3 件事】
1) 每天 10 分鐘走路/伸展（不求強度，求規律）
2) 下午後降低咖啡因與含糖飲
3) 睡前做 3 分鐘慢呼吸（吸 4 秒、吐 6 秒）

【圖片】
（這裡可放圖片 URL）

【適合你的產品搭配】
A) 你的產品/連結
B) 你的產品/連結

提醒：若有慢性病/孕哺/用藥，請先詢問醫師或藥師。
ENDREPORT

REPORT: life_gut
BODY:
【優先方向】
先把飲食與腸胃穩定，精神與體態通常會更好調整。

【可能的常見缺口（方向提示）】
• 纖維、益生菌來源、蛋白質分配、飲水不足

【今天就能做的 3 件事】
1) 每餐先補一份蔬菜（或蔬果/湯品）
2) 先把水量拉到「分段喝」：起床、上午、下午、晚餐前
3) 外食先避開重油辣＋高糖飲

【圖片】
（這裡可放圖片 URL）

【適合你的產品搭配】
A) 你的產品/連結
B) 你的產品/連結

提醒：若有慢性病/孕哺/用藥，請先詢問醫師或藥師。
ENDREPORT

REPORT: life_metabolism
BODY:
【優先方向】
先從體態與代謝入手：規律活動＋蛋白質分配，最有效率。

【可能的常見缺口（方向提示）】
• 蛋白質不足、纖維不足、久坐、睡眠不足影響食慾

【今天就能做的 3 件事】
1) 先做到「每餐有蛋白質」：豆魚蛋肉擇一
2) 每天至少 6000 步或 20 分鐘快走
3) 甜食改成「固定時段少量」，不要整天零食

【圖片】
（這裡可放圖片 URL）

【適合你的產品搭配】
A) 你的產品/連結
B) 你的產品/連結

提醒：若有慢性病/孕哺/用藥，請先詢問醫師或藥師。
ENDREPORT
`;
  }

  // ---------- bind ----------
  function bind(){
    $("qSearch").oninput = renderSurveyList;

    $("btnNew").onclick = ()=>{
      CURRENT = makeEmptySurvey();
      updateCurrentMetaUI();
      toast("已建立新問卷（貼上後按『套用到問卷』）");
    };

    $("btnConnect").onclick = async ()=>{
      try{
        setApiBaseFromInput();
        $("txtStatus").textContent = "已連線";
        $("txtStatus").className = "font-semibold text-emerald-700";
        $("txtLastSync").textContent = new Date().toLocaleString();

        await refreshKwMap();
        await refreshSurveyList();

        toast("連線成功 ✅");
      }catch(e){
        $("txtStatus").textContent = "連線失敗";
        $("txtStatus").className = "font-semibold text-rose-700";
        toast(e.message, "err");
      }
    };

    $("btnPasteExample").onclick = ()=>{
      $("inPaste").value = exampleText();
      $("inPaste").focus();
      toast("已塞入範例");
    };

    $("btnApplyPaste").onclick = ()=>{
      try{
        const parsed = parsePaste($("inPaste").value || "");
        applyParsedToCurrent(parsed);
        toast("已套用到問卷（可按『檢查』或『儲存到 KV』）");
      }catch(e){
        toast(e.message, "err");
      }
    };

    $("btnValidate").onclick = async ()=>{
      try{
        // if user hasn't connected yet, still allow local validate (but keyword ownership needs KW_MAP)
        if(API_BASE) await refreshKwMap().catch(()=>{});
        validateSurvey();
        toast("檢查通過 ✅");
      }catch(e){
        toast(e.message, "err");
      }
    };

    $("btnSaveSurvey").onclick = async ()=>{
      try{
        setApiBaseFromInput();
        await refreshKwMap();
        await saveSurveyToKV();
      }catch(e){
        toast(e.message, "err");
      }
    };
  }

  // ---------- init ----------
  function init(){
    initApiBase();
    bind();
    updateCurrentMetaUI();
  }

  init();
})();
</script>
</body>
</html>
