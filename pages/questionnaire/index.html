<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>生活型態營養問卷（11題）</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --bd:#e5e7eb; --bg:#f6f7fb; --card:#fff;
      --accent:#1d4ed8; --shadow: 0 10px 30px rgba(15,23,42,.08); --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:"Microsoft JhengHei",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
      -webkit-text-size-adjust:100%;
      display:flex; justify-content:center;
      padding:18px 14px calc(18px + env(safe-area-inset-bottom));
    }
    .wrap{ width:min(520px, 100%); }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .hero{
      height:168px;
      background:
        radial-gradient(900px 260px at 30% 10%, rgba(29,78,216,.10), transparent 60%),
        linear-gradient(135deg, #fafafa, #f1f5f9);
      display:flex; align-items:center; justify-content:center;
      border-bottom:1px solid var(--bd);
    }
    .hero img{ width:78%; max-width:360px; height:auto; opacity:.95; filter: drop-shadow(0 6px 10px rgba(0,0,0,.10)); user-select:none; -webkit-user-drag:none; }
    .body{ padding:18px 18px 14px; }
    .q{ font-weight:800; font-size:20px; line-height:1.35; margin:0 0 8px; }
    .meta{ color:var(--muted); font-size:14px; margin:0 0 12px; }
    .divider{ height:1px; background:var(--bd); margin:14px -18px 14px; }
    .btn{
      width:100%; background:#fff; border:none; padding:16px 14px;
      font-size:18px; font-weight:700; color:var(--accent); cursor:pointer;
    }
    .btn + .btn{ border-top:1px solid var(--bd); }
    .btn:active{ transform: translateY(1px); }
    .hint{ margin-top:12px; font-size:13px; color:var(--muted); line-height:1.6; }
    .pill{
      display:inline-block; padding:6px 10px; border-radius:999px;
      background:#eff6ff; border:1px solid #dbeafe; color:#1e40af;
      font-weight:800; font-size:12px;
    }
    .pill.bad{ background:#fff1f2; border-color:#fecdd3; color:#9f1239; }
    .pill.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .report{ white-space:pre-wrap; font-size:15px; line-height:1.75; }
    .actions{ margin-top:14px; display:grid; gap:10px; }
    .linkbtn{
      display:block; text-align:center; text-decoration:none;
      padding:14px 12px; border-radius:14px; font-weight:900;
      border:1px solid var(--bd); background:#0f172a; color:#fff;
    }
    .ghost{ background:#fff; color:#0f172a; }
    .small{ font-size:12px; color:var(--muted); line-height:1.6; margin-top:10px; }
    .kv{
      display:grid; grid-template-columns:110px 1fr; gap:8px 10px;
      margin-top:10px; padding:12px; border:1px solid var(--bd);
      border-radius:14px; background:#fff;
    }
    .k{ color:var(--muted); font-weight:800; font-size:13px; }
    .v{ font-weight:800; font-size:13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="hero">
        <img alt="A TEAM" src="https://a-plus-team.com/logo.png" onerror="this.style.display='none'">
      </div>
      <div class="body" id="app"></div>
    </div>
  </div>

<script>
(() => {
  // ==========================
  // ✅ 你的 Worker API（固定）
  // ==========================
  const API_BASE = "https://api.zxcv8096.workers.dev";

  // 你的 KV keys（沿用你 admin.html 的規格）
  const KW_MAP_KEY = "AI_SURVEY:KW_MAP";
  const LEAD_PREFIX = "AI_SURVEY:LEAD:";
  const LAST_PREFIX = "AI_SURVEY:LAST:";

  // 啟動關鍵字（從網址參數 k 取得）
  const params = new URLSearchParams(location.search);
  const keyword = (params.get("k") || "").trim(); // 例如：生活營養

  // 你之後再換成你的產品連結
  const PRODUCT_LINK = "https://你的產品連結";
  const SEVEN_DAYS_KEYWORD = "7天";

  // 題目（照圖不改）
  const Q = [
    { id:"q1",  type:"yn",  text:"我經常只有兩餐" },
    { id:"q2",  type:"yn",  text:"我每天攝取的蔬菜和水果少於5份（以成人手掌大小盤子為標準）" },
    { id:"q3",  type:"yn",  text:"我每天攝取的米飯或麵條少於1.5碗" },
    { id:"q4",  type:"yn",  text:"我每天喝的乳製品少於1.5杯" },
    { id:"q5",  type:"yn",  text:"我每天飲用咖啡或茶（至少兩杯）" },
    { id:"q6",  type:"yn",  text:"我每天攝取的蛋白質類食物少於5份（以成人三根手指的量為標準）" },
    { id:"q7",  type:"yn",  text:"我經常食用高溫、油炸或燒煮的食物" },
    { id:"q8",  type:"yn",  text:"我有吸菸習慣" },
    { id:"q9",  type:"yn",  text:"我常節食以減輕體重" },
    { id:"q10", type:"sex", text:"我的性別" },
    // ✅ 只有年齡改動（更合理，仍 3 選項）
    { id:"q11", type:"age", text:"我的年齡範圍" },
  ];

  // 分數（未來可對圖表）
  const score = { vitA:0, vitB:0, vitC:0, vitD:0, vitE:0, ca_mg:0, iron:0, fiber:0, trace:0, protein:0 };
  const answers = {}; // 保存答題（Yes/No/男/女/年齡段）
  const profile = { sex:"", age:"" };

  // UI
  const app = document.getElementById("app");
  let idx = 0;

  // ============ API helpers ============
  async function api(path, bodyObj){
    const res = await fetch(API_BASE.replace(/\/$/,"") + path, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }
  async function kvGet(key){
    const r = await api("/loadAny", { namespace:"DB", keyword: key });
    return r?.payload ?? r;
  }
  async function kvPut(key, payload){
    await api("/putAny", { namespace:"DB", keyword: key, payload });
  }

  // ============ scoring ============
  function add(obj){
    for(const k in obj){
      if(score[k] === undefined) score[k] = 0;
      score[k] += obj[k];
    }
  }
  function applyYNRules(qid, yes){
    if(!yes) return;
    switch(qid){
      case "q1": add({ vitB:1, protein:1, trace:1 }); break;
      case "q2": add({ vitA:1, vitC:2, fiber:2, trace:1 }); break;
      case "q3": add({ vitB:2, trace:1 }); break;
      case "q4": add({ ca_mg:2, vitD:1 }); break;
      case "q5": add({ ca_mg:1, vitB:1, trace:1 }); break;
      case "q6": add({ protein:3, iron:1, vitB:1 }); break;
      case "q7": add({ vitC:1, vitE:2, trace:1 }); break;
      case "q8": add({ vitC:2, vitE:1, trace:1 }); break;
      case "q9": add({ protein:1, iron:1, vitB:2, trace:1 }); break;
    }
  }
  function applySexRules(sex){
    profile.sex = sex;
    if(sex === "女") add({ iron:1 });
  }
  function applyAgeRules(age){
    profile.age = age;
    if(age === "18歲以下") add({ ca_mg:1, vitD:1, protein:1 });
    if(age === "19–39歲")  add({ vitB:1 });
    if(age === "40歲以上") add({ ca_mg:2, vitD:2, trace:1 });
  }

  // ============ report ============
  const label = {
    vitA:"維生素A", vitB:"維生素B群", vitC:"維生素C", vitD:"維生素D", vitE:"維生素E",
    ca_mg:"鈣鎂", iron:"鐵", fiber:"膳食纖維", trace:"微量元素", protein:"蛋白質",
  };
  function level(s){ if(s>=6) return "優先"; if(s>=4) return "建議補強"; if(s>=2) return "可加強"; return "穩定"; }
  function sortedNutrients(){
    const arr = Object.keys(label).map(k => [k, score[k] || 0]);
    arr.sort((a,b)=> b[1]-a[1]);
    return arr;
  }
  function buildReport(){
    const arr = sortedNutrients();
    const top = arr.slice(0,3).filter(x=>x[1] > 0);
    const topText = top.length ? top.map(([k,v], i)=> `${i+1}) ${label[k]}（${level(v)}）`).join("\n") : "目前沒有明顯需要優先加強的項目（維持即可）";
    const blocks = arr.map(([k,v]) => `• ${label[k]}：${level(v)}`).join("\n");

    const tips = [];
    if(score.fiber >= 2) tips.push("把「蔬菜+水果」拉到每天至少 5 份（用手掌大小盤子估算）。");
    if(score.protein >= 3) tips.push("每餐安排 1 份優質蛋白（豆/魚/蛋/肉/乳），先把「總量」補足。");
    if(score.ca_mg >= 2) tips.push("乳製品不足時，可用豆製品/小魚乾/深綠蔬菜分段補鈣，並維持日曬習慣。");
    if(score.vitC >= 2) tips.push("高溫油炸/吸菸/蔬果不足者，優先用新鮮蔬果與規律作息做支持。");
    if(score.vitB >= 2) tips.push("若常兩餐/節食/主食偏少，先把三餐節奏與主食比例調回穩定。");
    if(!tips.length) tips.push("目前整體偏穩定：維持規律飲食、蛋白質與蔬果量，並留意水分補充。");

    return `【生活型態營養問卷｜文字版評估結果】

啟動關鍵字：${keyword || "-"}

基本資料：
- 性別：${profile.sex || "未填"}
- 年齡：${profile.age || "未填"}

你的優先關注方向（Top 3）：
${topText}

各項營養方向概況：
${blocks}

【你可以先做的 3 件事】
1) ${tips[0] || "維持規律三餐與均衡飲食。"}
2) ${tips[1] || "每天至少 5 份蔬果，並把蛋白質補到每餐都有。"}
3) ${tips[2] || "固定日曬與充足睡眠，減少高溫油炸與含糖飲料。"}

【專屬連結】
${PRODUCT_LINK}

提醒：本分析為生活營養評估，不涉及醫療診斷；若有慢性病、孕哺或用藥，請先詢問專業人員。`;
  }

  // ============ UI ============
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderNeedKeyword(){
    app.innerHTML = `
      <div class="row"><span class="pill bad">缺少啟動關鍵字</span></div>
      <div class="q" style="margin-top:10px;">無法開始問卷</div>
      <p class="meta">請從 LINE 點擊帶參數的連結，例如：</p>
      <div class="hint mono">${esc(location.origin + location.pathname)}?k=生活營養</div>
    `;
  }

  function renderConnecting(){
    app.innerHTML = `
      <div class="row"><span class="pill">連線檢查中…</span></div>
      <div class="q" style="margin-top:10px;">正在連到 API</div>
      <p class="meta mono">${esc(API_BASE)}</p>
      <div class="hint">若你看到這頁卡住，代表 Worker 連線失敗或 CORS 未開。</div>
    `;
  }

  function renderConnectFail(msg){
    app.innerHTML = `
      <div class="row"><span class="pill bad">未連線</span></div>
      <div class="q" style="margin-top:10px;">無法開始（必須連到 API）</div>
      <p class="meta">API 連線失敗：</p>
      <div class="hint mono">${esc(msg || "")}</div>
      <div class="divider"></div>
      <div class="hint">
        你目前設定的 API：<span class="mono">${esc(API_BASE)}</span><br>
        請確認 Worker 有提供：<span class="mono">POST /loadAny</span> 與 <span class="mono">CORS</span> 允許你的 GitHub Pages 網域。
      </div>
      <div class="actions">
        <button class="linkbtn ghost" id="btnRetry">重試連線</button>
      </div>
    `;
    document.getElementById("btnRetry").onclick = () => boot();
  }

  function renderKeywordNotRegistered(){
    app.innerHTML = `
      <div class="row"><span class="pill bad">關鍵字未註冊</span></div>
      <div class="q" style="margin-top:10px;">此關鍵字尚未在後台綁定</div>
      <p class="meta">目前網址參數 k：</p>
      <div class="hint mono">${esc(keyword)}</div>
      <div class="divider"></div>
      <div class="hint">
        你需要在 KV 的 <span class="mono">${KW_MAP_KEY}</span> 裡面，建立對應：<br>
        <span class="mono">{"${esc(keyword)}":"某個問卷名稱"}</span><br>
        （或你要我改成「不檢查 KW_MAP，只要有 k 就能開始」也可以）
      </div>
    `;
  }

  function renderQuestion(){
    const q = Q[idx];
    const no = idx + 1;
    const total = Q.length;

    let buttons = "";
    if(q.type === "yn"){
      buttons = `<button class="btn" data-v="yes">是</button><button class="btn" data-v="no">不是</button>`;
    }else if(q.type === "sex"){
      buttons = `<button class="btn" data-v="男">男</button><button class="btn" data-v="女">女</button>`;
    }else if(q.type === "age"){
      buttons = `
        <button class="btn" data-v="18歲以下">18歲以下</button>
        <button class="btn" data-v="19–39歲">19–39歲</button>
        <button class="btn" data-v="40歲以上">40歲以上</button>
      `;
    }

    app.innerHTML = `
      <div class="row">
        <span class="pill ok">已連線</span>
        <span class="pill">問題 No.${no}/${total}</span>
      </div>
      <div class="q" style="margin-top:10px;">${esc(q.text)}</div>
      <div class="meta">請依照你目前的狀態選擇。</div>
      <div class="divider"></div>
      ${buttons}
    `;

    app.querySelectorAll(".btn").forEach(b=>{
      b.addEventListener("click", async ()=>{
        const v = b.getAttribute("data-v");
        // 記錄答案
        answers[q.id] = (q.type==="yn") ? (v==="yes" ? "是" : "不是") : v;

        // 計分
        if(q.type === "yn") applyYNRules(q.id, v === "yes");
        if(q.type === "sex") applySexRules(v);
        if(q.type === "age") applyAgeRules(v);

        idx++;
        if(idx >= Q.length) await renderDone();
        else renderQuestion();
      });
    });
  }

  async function renderDone(){
    const reportText = buildReport();
    const now = Date.now();

    // 寫入 KV（Lead + Last）
    const lead = {
      createdAt: new Date(now).toISOString(),
      keyword,
      profile,
      answers,
      score,
      reportText
    };

    app.innerHTML = `
      <div class="row"><span class="pill">寫入結果中…</span></div>
      <div class="q" style="margin-top:10px;">生活型態營養問卷評估完畢！</div>
      <p class="meta">正在把結果存進後台（必須成功才顯示報告）。</p>
    `;

    try{
      await kvPut(LEAD_PREFIX + now, lead);
      await kvPut(LAST_PREFIX + keyword, lead);
    }catch(e){
      renderConnectFail("寫入 KV 失敗：" + (e?.message || e));
      return;
    }

    app.innerHTML = `
      <div class="row"><span class="pill ok">已完成</span></div>
      <div class="q" style="margin-top:10px;">馬上看看評估結果！</div>

      <div class="kv">
        <div class="k">性別</div><div class="v">${esc(profile.sex || "-")}</div>
        <div class="k">年齡</div><div class="v">${esc(profile.age || "-")}</div>
      </div>

      <div class="divider"></div>
      <div class="report" id="reportText">${esc(reportText)}</div>

      <div class="actions">
        <a class="linkbtn" href="${esc(PRODUCT_LINK)}" target="_blank" rel="noopener">查看專屬連結</a>
        <button class="linkbtn ghost" id="btnCopy">複製報告文字</button>
      </div>

      <div class="small">
        若你想拿到你的「7天生活調整清單」，回覆「${SEVEN_DAYS_KEYWORD}」。（通常由 LINE webhook 端處理）
      </div>
    `;

    document.getElementById("btnCopy").onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(reportText);
        const b = document.getElementById("btnCopy");
        b.textContent = "已複製 ✅";
        setTimeout(()=> b.textContent = "複製報告文字", 1200);
      }catch{
        alert("瀏覽器限制導致複製失敗，請手動選取複製。");
      }
    };
  }

  // ============ boot ============
  async function boot(){
    if(!keyword){
      renderNeedKeyword();
      return;
    }
    renderConnecting();

    try{
      // 1) 先測試 loadAny 可用（也順便抓 KW_MAP）
      const kwMap = await kvGet(KW_MAP_KEY);

      // 2) 如果你想「必須後台有綁定關鍵字」才開放，就保留這段
      const mapObj = (kwMap && typeof kwMap === "object") ? kwMap : {};
      if(!mapObj[keyword]){
        renderKeywordNotRegistered();
        return;
      }

      // 3) 開始問卷
      idx = 0;
      renderQuestion();

    }catch(e){
      renderConnectFail(e?.message || String(e));
    }
  }

  boot();
})();
</script>
</body>
</html>
