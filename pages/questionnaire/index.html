<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report Renderer</title>
  <style>
    body{font-family:"Microsoft JhengHei",system-ui;margin:16px}
    canvas{border:1px solid #ddd;border-radius:12px;max-width:100%}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
    .muted{color:#64748b}
  </style>
</head>
<body>
  <div class="muted" id="status">loading...</div>
  <canvas id="cv" width="900" height="1400"></canvas>

  <div class="row">
    <button id="btnGen">重新產生並上傳</button>
  </div>

<script>
const API_BASE = location.origin; // Worker 同網域
const BG_URL = "https://YOUR_BG_IMAGE_URL/report_bg.png"; // 你那張藍底模板（請換成你的網址）

const qs = new URLSearchParams(location.search);
const userId = qs.get("userId") || "";
if(!userId) document.getElementById("status").textContent = "missing userId";

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");

document.getElementById("btnGen").onclick = () => run(true);

run(false);

async function run(forceUpload){
  setStatus("讀取報告資料...");
  const rep = await fetchJSON(`${API_BASE}/reportData?userId=${encodeURIComponent(userId)}`);

  setStatus("載入背景/頭貼...");
  const bg = await loadImg(BG_URL);
  const avatar = rep.pictureUrl ? await loadImg(rep.pictureUrl).catch(()=>null) : null;

  setStatus("繪製...");
  drawReport(rep, bg, avatar);

  if(forceUpload){
    setStatus("輸出PNG並上傳...");
    const pngBase64 = cv.toDataURL("image/png");
    const up = await fetchJSON(`${API_BASE}/uploadReport`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ userId, pngBase64 })
    });
    setStatus(`完成，上傳網址：${up.imageUrl}`);
  }else{
    setStatus("完成（未上傳）");
  }
}

function setStatus(s){ document.getElementById("status").textContent = s; }

function drawReport(rep, bg, avatar){
  // 背景
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.drawImage(bg, 0, 0, cv.width, cv.height);

  // Header文字（A+Health / Line ID / 名字）
  ctx.fillStyle = "#ffffff";
  ctx.font = "bold 56px Microsoft JhengHei";
  ctx.fillText("A+Health", 370, 120);

  ctx.font = "24px Microsoft JhengHei";
  ctx.fillText(`Line: ${rep.lineId || rep.userId}`, 370, 160);

  ctx.font = "bold 34px Microsoft JhengHei";
  ctx.fillText(`${rep.displayName || "—"}`, 370, 210);

  ctx.font = "24px Microsoft JhengHei";
  ctx.fillText(`年齡:${rep.age || "—"}  性別:${rep.sex || "—"}`, 370, 250);

  // 圓形頭貼
  const ax=110, ay=110, ar=90;
  ctx.save();
  ctx.beginPath();
  ctx.arc(ax, ay, ar, 0, Math.PI*2);
  ctx.closePath();
  ctx.clip();
  if(avatar){
    // cover
    const s = Math.max((ar*2)/avatar.width, (ar*2)/avatar.height);
    const w = avatar.width*s, h = avatar.height*s;
    ctx.drawImage(avatar, ax-ar-(w-(ar*2))/2, ay-ar-(h-(ar*2))/2, w, h);
  }else{
    ctx.fillStyle="#0b1220";
    ctx.fillRect(ax-ar, ay-ar, ar*2, ar*2);
  }
  ctx.restore();
  // 外圈
  ctx.strokeStyle="#ffffff";
  ctx.lineWidth=10;
  ctx.beginPath(); ctx.arc(ax, ay, ar, 0, Math.PI*2); ctx.stroke();

  // 紅色長條（照你圖的排列）
  const items = [
    ["維生素A", rep.display.vita, rep.need.vita],
    ["維生素B", rep.display.vitb, rep.need.vitb],
    ["維生素C", rep.display.vitc, rep.need.vitc],
    ["維生素D", rep.display.vitd, rep.need.vitd],
    ["維生素E", rep.display.vite, rep.need.vite],
    ["鈣鎂",     rep.display.camg, rep.need.camg],
    ["鐵",       rep.display.iron, rep.need.iron],
    ["纖維",     rep.display.fiber, rep.need.fiber],
    ["微量元素", rep.display.trace, rep.need.trace],
  ];

  const leftLabelX = 110;
  const barX = 300;
  const barW = 520;
  const barH = 42;
  let y = 330;
  const gap = 54;

  ctx.font = "26px Microsoft JhengHei";
  items.forEach(([label, value, need])=>{
    // label
    ctx.fillStyle="#ffffff";
    ctx.fillText(label + ":", leftLabelX, y+30);

    // bar background (透明底)
    ctx.globalAlpha = 0.25;
    roundRect(ctx, barX, y, barW, barH, 20);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
    ctx.globalAlpha = 1;

    // red bar length
    const pct = clamp(need/100, 0.08, 1); // 至少有一點紅，不然看不到
    const w = Math.round(barW*pct);
    roundRect(ctx, barX, y, w, barH, 20);
    ctx.fillStyle = "#e11d48";
    ctx.fill();

    // value text inside bar
    ctx.fillStyle="#0b1220";
    ctx.font = "24px Microsoft JhengHei";
    ctx.fillText(value, barX + 18, y + 29);

    ctx.font = "26px Microsoft JhengHei";
    y += gap;
  });

  // 底部按鈕（像你圖的那種灰色膠囊）
  const btns = [
    "維生素A","維生素B","維生素C",
    "維生素D","維生素E","鈣鎂",
    "鐵","膳食纖維","微量元素","蛋白質"
  ];
  ctx.font = "22px Microsoft JhengHei";
  let bx=120, by=980;
  const bw=190, bh=60, bgap=18;
  btns.forEach((t,i)=>{
    roundRect(ctx, bx, by, bw, bh, 18);
    ctx.fillStyle="rgba(255,255,255,0.45)";
    ctx.fill();
    ctx.fillStyle="#ffffff";
    ctx.fillText(t, bx+26, by+38);

    bx += bw + bgap;
    if((i+1)%3===0){ bx=120; by += bh + 18; }
  });

  // footer
  ctx.fillStyle="#ffffff";
  ctx.font="bold 46px Microsoft JhengHei";
  ctx.fillText("A TEAM", 370, 1325);
}

function roundRect(ctx,x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

async function fetchJSON(url, opt){
  const r = await fetch(url, opt);
  if(!r.ok) throw new Error(await r.text());
  return await r.json();
}
function loadImg(src){
  return new Promise((res, rej)=>{
    const im = new Image();
    im.crossOrigin = "anonymous";
    im.onload = ()=>res(im);
    im.onerror = rej;
    im.src = src;
  });
}
</script>
</body>
</html>
