<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>問卷中控台｜Config</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bd:#e5e7eb;--tx:#0f172a;--muted:#64748b;}
    body{font-family:system-ui,"Microsoft JhengHei";color:var(--tx)}
    .card{border:1px solid var(--bd);border-radius:18px;padding:16px;background:#fff}
    .btn{border-radius:14px;padding:10px 14px;font-weight:800}
    .btn-primary{background:#0f172a;color:#fff}
    .btn-ghost{border:1px solid var(--bd);background:#fff}
    .small{font-size:12px;color:var(--muted)}
    textarea{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body class="bg-slate-50">
<div class="max-w-4xl mx-auto p-4 md:p-6 space-y-4">
  <header class="card space-y-2">
    <div class="text-xl font-extrabold">問卷中控台（只管理雲端設定）</div>
    <div class="small">設定會寫入 Cloudflare KV：<span class="font-bold">cfg:questionnaire</span></div>

    <div class="grid md:grid-cols-2 gap-3">
      <div class="space-y-1">
        <div class="text-sm font-bold">Worker API Base</div>
        <input id="apiBase" class="w-full border rounded-xl px-3 py-2"
               placeholder="https://xxx.workers.dev"/>
      </div>
      <div class="space-y-1">
        <div class="text-sm font-bold">ADMIN_KEY（建議）</div>
        <input id="adminKey" type="password" class="w-full border rounded-xl px-3 py-2"
               placeholder="Worker 的 ADMIN_KEY"/>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 items-center">
      <button id="btnLoad" class="btn btn-ghost">讀取</button>
      <button id="btnSave" class="btn btn-primary">儲存</button>
      <button id="btnExport" class="btn btn-ghost">下載 JSON</button>
      <span id="hint" class="small"></span>
    </div>
  </header>

  <section class="card space-y-2">
    <div class="font-extrabold">Config JSON（整包貼上可直接儲存）</div>
    <div class="small">
      你要的聊天室問卷會用：<span class="font-bold">questions / coverImageUrl / startKeywords / productLinks</span>
    </div>
    <textarea id="box" rows="22" class="w-full border rounded-xl p-3 text-xs"></textarea>
  </section>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const LS_API="console_api_base", LS_KEY="console_admin_key";
$("apiBase").value = localStorage.getItem(LS_API)||"";
$("adminKey").value = localStorage.getItem(LS_KEY)||"";

function hint(t){
  $("hint").textContent=t;
  clearTimeout(hint._t);
  hint._t=setTimeout(()=>$("hint").textContent="",2000);
}

async function apiGet(path){
  const base=$("apiBase").value.trim().replace(/\/$/,"");
  if(!base) throw new Error("no_api_base");
  localStorage.setItem(LS_API, base);
  const r=await fetch(base+path);
  const j=await r.json().catch(()=>null);
  if(!r.ok) throw new Error(j?.error||"get_failed");
  return j;
}

async function apiPut(path, body){
  const base=$("apiBase").value.trim().replace(/\/$/,"");
  if(!base) throw new Error("no_api_base");
  localStorage.setItem(LS_API, base);

  const key=$("adminKey").value.trim();
  localStorage.setItem(LS_KEY, key);

  const r=await fetch(base+path,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      ...(key?{"x-admin-key":key}:{})
    },
    body:JSON.stringify(body)
  });
  const j=await r.json().catch(()=>null);
  if(!r.ok) throw new Error(j?.error||"put_failed");
  return j;
}

$("btnLoad").onclick = async ()=>{
  try{
    hint("讀取中…");
    const j=await apiGet("/api/config");
    $("box").value=JSON.stringify(j.config,null,2);
    hint("讀取完成✅");
  }catch(e){
    hint("讀取失敗："+(e.message||e));
  }
};

$("btnSave").onclick = async ()=>{
  try{
    const cfg=JSON.parse($("box").value||"{}");
    hint("儲存中…");
    await apiPut("/api/config",{config:cfg});
    hint("已儲存✅");
  }catch(e){
    hint("儲存失敗："+(e.message||e));
  }
};

$("btnExport").onclick = ()=>{
  try{
    const obj=JSON.parse($("box").value||"{}");
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="cfg-questionnaire.json"; a.click();
    URL.revokeObjectURL(url);
  }catch(e){
    hint("JSON 格式錯誤");
  }
};
</script>
</body>
</html>
