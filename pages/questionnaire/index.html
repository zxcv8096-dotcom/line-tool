<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>問卷中控台｜A+Health</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --glass: rgba(255,255,255,.72);
      --bd: rgba(15,23,42,.10);
      --muted: rgba(15,23,42,.55);
    }
    body{font-family: ui-sans-serif, system-ui, "Microsoft JhengHei";}
    .glass{background:var(--glass); backdrop-filter: blur(10px); border:1px solid var(--bd);}
    .soft-shadow{box-shadow: 0 18px 50px rgba(2,6,23,.10);}
    .pill{border:1px solid var(--bd); border-radius:999px; padding:6px 12px; font-size:12px; color:rgba(15,23,42,.7); background:rgba(255,255,255,.65);}
    .btn{
      border-radius:14px; padding:10px 14px; font-weight:800;
      transition: transform .08s ease, box-shadow .15s ease, background .15s ease, border .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px);}
    .btn-primary{
      background: linear-gradient(135deg,#0ea5e9,#2563eb);
      color:#fff; box-shadow: 0 12px 30px rgba(37,99,235,.25);
    }
    .btn-primary:hover{filter: brightness(1.02);}
    .btn-ghost{
      border:1px solid var(--bd);
      background:rgba(255,255,255,.75);
      color: rgba(15,23,42,.86);
    }
    .btn-ghost:hover{background:rgba(255,255,255,.92);}
    .btn-danger{
      background: rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      color:#b91c1c;
    }
    .inp{
      width:100%;
      border-radius:14px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.85);
      padding:10px 12px;
      outline:none;
    }
    .inp:focus{box-shadow: 0 0 0 4px rgba(59,130,246,.12); border-color: rgba(59,130,246,.35);}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:rgba(15,23,42,.10);}
    .card{border-radius:22px;}
    .fade-in{animation: fade .22s ease-out both;}
    @keyframes fade{from{opacity:.0; transform: translateY(4px);}to{opacity:1; transform: translateY(0);}}
  </style>
</head>

<body class="min-h-screen bg-slate-950">
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-slate-900"></div>
    <div class="absolute -top-40 -left-40 w-[520px] h-[520px] rounded-full bg-blue-500/25 blur-3xl"></div>
    <div class="absolute -bottom-40 -right-40 w-[520px] h-[520px] rounded-full bg-sky-400/20 blur-3xl"></div>
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(255,255,255,.06),transparent_55%)]"></div>
  </div>

  <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-4">
    <header class="glass soft-shadow card p-4 md:p-5 text-slate-900 fade-in">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center text-white soft-shadow">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M12 2l7 4v6c0 5-3 9-7 10-4-1-7-5-7-10V6l7-4Z" stroke="white" stroke-width="2" />
              <path d="M9 12h6M12 9v6" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div class="text-lg md:text-xl font-extrabold text-white">A+Health 問卷中控台</div>
            <div class="small text-white/70">多份問卷｜AI 產生｜一鍵發布｜LINE 立即同步</div>
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <span id="activeInfo" class="pill text-white/90 bg-white/10 border-white/15">目前上線：—</span>
          <span id="status" class="pill text-white/80 bg-white/10 border-white/15">—</span>
          <button id="btnRefresh" class="btn btn-ghost">重整</button>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <div class="space-y-1">
          <div class="text-sm font-bold text-white">Worker API Base（自動）</div>
          <div class="flex gap-2">
            <input id="apiBase" class="inp text-slate-900" placeholder="自動偵測中…" readonly>
            <button id="btnSetApi" class="btn btn-ghost">設定</button>
          </div>
          <div class="small text-white/70">
            ✅ 來源順序：<b>?api</b> → <b>?gw</b> → <b>localStorage.q_console_api_base_pretty</b> → <b>localStorage.GW_BASE</b>
          </div>
        </div>

        <div class="space-y-1">
          <div class="text-sm font-bold text-white">ADMIN_KEY（管理用）</div>
          <div class="flex gap-2">
            <input id="adminKey" class="inp text-slate-900" type="password" placeholder="輸入一次後會記住">
            <button id="btnSaveKey" class="btn btn-ghost">保存</button>
          </div>
          <div class="small text-white/70">用於：新增/儲存/刪除/AI/發布（header: <b>x-admin-key</b>）</div>
        </div>
      </div>

      <div class="mt-4 flex gap-2 flex-wrap">
        <button id="btnPing" class="btn btn-primary">測試連線</button>
        <button id="btnNew" class="btn btn-ghost">＋ 新增問卷</button>
        <span class="small text-white/70" id="hint"></span>
      </div>
    </header>

    <div class="grid lg:grid-cols-12 gap-4 fade-in">
      <aside class="lg:col-span-4 glass soft-shadow card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-white font-extrabold text-lg">問卷清單</div>
          <button id="btnDup" class="btn btn-ghost">複製</button>
        </div>

        <div class="flex gap-2">
          <button id="btnDelete" class="btn btn-danger w-full">刪除</button>
        </div>

        <div id="list" class="space-y-2"></div>
      </aside>

      <main class="lg:col-span-8 glass soft-shadow card p-4 space-y-4">
        <div class="flex items-start justify-between gap-3 flex-wrap">
          <div>
            <div class="text-white font-extrabold text-lg">編輯草稿（Draft）</div>
            <div class="small text-white/70">你改的是草稿；按「發布」才會同步上線給 LINE 使用。</div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button id="btnLoadDraft" class="btn btn-ghost">讀草稿</button>
            <button id="btnSaveDraft" class="btn btn-primary">儲存草稿</button>
            <button id="btnPublish" class="btn btn-ghost">發布並上線</button>
          </div>
        </div>

        <div id="emptyState" class="text-white/75 small">
          請先在左側選擇一份問卷，或按「新增問卷」建立第一份。
        </div>

        <section id="editor" class="space-y-4 hidden">
          <div class="grid md:grid-cols-2 gap-3">
            <div class="space-y-1">
              <div class="text-white font-bold text-sm">問卷名稱</div>
              <input id="qName" class="inp" placeholder="例如：生活型態營養問卷 v2">
            </div>
            <div class="space-y-1">
              <div class="text-white font-bold text-sm">封面圖 URL（Flex hero）</div>
              <input id="coverUrl" class="inp" placeholder="https://.../cover.png">
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-3">
            <div class="space-y-1">
              <div class="text-white font-bold text-sm">開始關鍵字（逗號分隔）</div>
              <input id="startKeywords" class="inp" placeholder="生活型態營養問卷,開始,start">
            </div>
            <div class="space-y-1">
              <div class="text-white font-bold text-sm">品牌標題（Flex altText）</div>
              <input id="brandTitle" class="inp" placeholder="生活型態營養問卷">
            </div>
          </div>

          <div class="divider"></div>

          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-white font-extrabold">題目與選項</div>
              <button id="btnAddQ" class="btn btn-ghost">＋ 新增題目</button>
            </div>
            <div id="qEditor" class="space-y-3"></div>
          </div>

          <div class="divider"></div>

          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-white font-extrabold">產品連結（營養素 → 產品頁）</div>
              <button id="btnAddP" class="btn btn-ghost">＋ 新增連結</button>
            </div>
            <div class="small text-white/70">你可以自由新增 key（例如：protein、vitD、omega3…）。報告圖點擊可導向這些網址。</div>
            <div id="pEditor" class="space-y-2"></div>
          </div>

          <div class="divider"></div>

          <div class="space-y-2">
            <div class="text-white font-extrabold">AI 幫你寫/改問卷</div>
            <div class="small text-white/70">
              例：把問卷變成 11 題，增加腸胃、睡眠、壓力、皮膚；像營養師問診但不要醫療用語。
            </div>
            <textarea id="aiText" class="inp" rows="5" placeholder="輸入你的需求…"></textarea>
            <div class="flex gap-2 flex-wrap">
              <button id="btnAIApply" class="btn btn-primary">AI 直接套用到草稿</button>
              <span id="aiHint" class="small text-white/70"></span>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative glass soft-shadow card p-4 md:p-5 w-full max-w-xl text-slate-900 fade-in">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-lg font-extrabold text-slate-900">設定 Worker API Base</div>
          <div class="small">只需設定一次，之後自動記住。</div>
        </div>
        <button id="modalClose" class="btn btn-ghost">關閉</button>
      </div>

      <div class="mt-3 space-y-2">
        <div class="text-sm font-bold">Worker 網址（例如 https://xxx.workers.dev）</div>
        <input id="modalApi" class="inp" placeholder="https://...workers.dev">
        <div class="small">
          ✅ 你也可以用網址參數：<b>?api=https://xxx.workers.dev</b>（一次設定後就不需要再帶）
        </div>
      </div>

      <div class="mt-4 flex gap-2 justify-end">
        <button id="modalSave" class="btn btn-primary">保存</button>
      </div>

      <div class="mt-3 small text-slate-700">
        如果你是從「統一窗口」開過來，這裡應該會自動有值；沒有才需要手貼。
      </div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);

const LS_API="q_console_api_base_pretty";
const LS_KEY="q_console_admin_key_pretty";

let ACTIVE_ID=null, LIST=[], CURRENT_ID=null, CFG=null;

function setStatus(t){ $("status").textContent = t; }
function hint(t){
  $("hint").textContent=t;
  clearTimeout(hint._t);
  hint._t=setTimeout(()=> $("hint").textContent="", 2600);
}
function aiHint(t){
  $("aiHint").textContent=t;
  clearTimeout(aiHint._t);
  aiHint._t=setTimeout(()=> $("aiHint").textContent="", 3500);
}

function showEditor(){
  $("emptyState").classList.add("hidden");
  $("editor").classList.remove("hidden");
}
function showEmpty(){
  $("emptyState").classList.remove("hidden");
  $("editor").classList.add("hidden");
}

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* -------------------------
 * API Base (fixed)
 * ------------------------- */
function normalizeBase(b){ return String(b||"").trim().replace(/\/+$/,""); }

function getQueryBase(){
  const u = new URL(location.href);
  const api = (u.searchParams.get("api")||"").trim();
  const gw  = (u.searchParams.get("gw")||"").trim();
  return normalizeBase(api || gw);
}

async function ping(base){
  const url = normalizeBase(base) + "/api/ping";
  try{
    const r = await fetch(url, { cache:"no-store", mode:"cors" });
    if(!r.ok) return { ok:false, reason:`HTTP ${r.status}` };
    const txt = await r.text();
    try{
      const j = JSON.parse(txt);
      if(j && j.ok) return { ok:true };
      return { ok:false, reason:"ping 回傳非 ok" };
    }catch{
      // 不是 JSON 也算失敗，但給原因
      return { ok:false, reason:"ping 回傳不是 JSON" };
    }
  }catch(e){
    return { ok:false, reason: (e?.message || String(e) || "fetch error") };
  }
}

async function resolveApiBase(){
  // 1) ?api= 或 ?gw=
  const q = getQueryBase();
  if(q){
    localStorage.setItem(LS_API, q);
    return q;
  }

  // 2) saved (問卷自己的)
  const saved = normalizeBase(localStorage.getItem(LS_API));
  if(saved) return saved;

  // 3) fallback to 統一窗口 GW_BASE
  const gwSaved = normalizeBase(localStorage.getItem("GW_BASE"));
  if(gwSaved){
    localStorage.setItem(LS_API, gwSaved);
    return gwSaved;
  }

  // 4) none
  return "";
}

function setApiBaseUI(base){
  $("apiBase").value = base ? base : "尚未設定";
}

/* -------------------------
 * Admin key
 * ------------------------- */
function loadKey(){
  const k = localStorage.getItem(LS_KEY) || "";
  $("adminKey").value = k;
}
$("btnSaveKey").onclick = ()=>{
  localStorage.setItem(LS_KEY, $("adminKey").value.trim());
  hint("已保存 ADMIN_KEY ✅");
};

/* -------------------------
 * API helpers (better errors)
 * ------------------------- */
function base(){
  const b = normalizeBase($("apiBase").value);
  if(!b || b==="尚未設定") throw new Error("尚未設定 API Base");
  return b;
}
function key(){
  const k = ($("adminKey").value || "").trim();
  if(!k) throw new Error("需要 ADMIN_KEY");
  return k;
}

async function apiGet(path){
  const url = base()+path;
  let r, txt, j=null;
  try{
    r = await fetch(url, { cache:"no-store", mode:"cors" });
    txt = await r.text();
    try{ j = JSON.parse(txt); }catch{}
  }catch(e){
    throw new Error("連線失敗（可能是 CORS 或 Worker 沒開）：" + (e?.message||e));
  }
  if(!r.ok){
    throw new Error(j?.error || `GET failed: HTTP ${r.status}`);
  }
  return j ?? {};
}

async function apiAdmin(method, path, body){
  const url = base()+path;
  let r, txt, j=null;
  try{
    r = await fetch(url, {
      method,
      mode:"cors",
      headers:{
        "Content-Type":"application/json",
        "x-admin-key": key()
      },
      body: body ? JSON.stringify(body) : undefined
    });
    txt = await r.text();
    try{ j = JSON.parse(txt); }catch{}
  }catch(e){
    throw new Error("連線失敗（可能是 CORS 或 Worker 沒開）：" + (e?.message||e));
  }
  if(!r.ok){
    throw new Error(j?.error || `ADMIN request failed: HTTP ${r.status}`);
  }
  return j ?? {};
}

/* -------------------------
 * Modal
 * ------------------------- */
function openModal(){
  $("modal").classList.remove("hidden");
  $("modal").classList.add("flex");
  $("modalApi").value = "";
}
function closeModal(){
  $("modal").classList.add("hidden");
  $("modal").classList.remove("flex");
}
$("btnSetApi").onclick = openModal;
$("modalClose").onclick = closeModal;
$("modal").addEventListener("click", (e)=>{
  if(e.target === $("modal")) closeModal();
});
$("modalSave").onclick = async ()=>{
  const b = normalizeBase($("modalApi").value);
  if(!b) return hint("請貼入 Worker 網址");
  setStatus("驗證 API…");
  const res = await ping(b);
  if(!res.ok){
    setStatus("—");
    return hint("驗證失敗：" + res.reason);
  }
  localStorage.setItem(LS_API, b);
  setApiBaseUI(b);
  closeModal();
  hint("已保存 API Base ✅");
  setStatus("—");
  await loadList();
};

/* -------------------------
 * Actions
 * ------------------------- */
$("btnPing").onclick = async ()=>{
  try{
    const b = base();
    setStatus("測試中…");
    const res = await ping(b);
    if(res.ok) setStatus("連線 OK ✅");
    else { setStatus("連線失敗"); hint("原因：" + res.reason); openModal(); }
  }catch(e){
    setStatus("連線失敗");
    hint(e.message || String(e));
    openModal();
  }
};

$("btnRefresh").onclick = ()=>loadList();

$("btnNew").onclick = async ()=>{
  try{
    const name = prompt("問卷名稱？","新問卷");
    if(name===null) return;
    setStatus("建立中…");
    const j = await apiAdmin("POST","/api/q/create",{name});
    await loadList();
    CURRENT_ID = j.id;
    await loadDraft();
    setStatus("已建立 ✅");
  }catch(e){
    setStatus("建立失敗");
    hint(e.message||String(e));
  }
};

$("btnDup").onclick = async ()=>{
  try{
    if(!CURRENT_ID) return hint("先選一份問卷");
    const name = prompt("複製後的新名稱？","複製問卷");
    if(name===null) return;
    setStatus("複製中…");
    const j = await apiAdmin("POST","/api/q/duplicate",{fromId:CURRENT_ID,name});
    await loadList();
    CURRENT_ID = j.id;
    await loadDraft();
    setStatus("已複製 ✅");
  }catch(e){
    setStatus("複製失敗");
    hint(e.message||String(e));
  }
};

$("btnDelete").onclick = async ()=>{
  try{
    if(!CURRENT_ID) return hint("先選一份問卷");
    if(!confirm("確定刪除？（draft + published 都會刪）")) return;
    setStatus("刪除中…");
    await apiAdmin("POST","/api/q/delete",{id:CURRENT_ID});
    CURRENT_ID=null; CFG=null;
    showEmpty();
    await loadList();
    setStatus("已刪除 ✅");
  }catch(e){
    setStatus("刪除失敗");
    hint(e.message||String(e));
  }
};

$("btnLoadDraft").onclick = ()=>loadDraft();

$("btnSaveDraft").onclick = async ()=>{
  try{
    if(!CURRENT_ID || !CFG) return hint("先選一份問卷");
    collectHeaderFields();
    setStatus("儲存中…");
    await apiAdmin("PUT","/api/q/save",{id:CURRENT_ID,config:CFG});
    await loadList();
    setStatus("草稿已儲存 ✅");
  }catch(e){
    setStatus("儲存失敗");
    hint(e.message||String(e));
  }
};

$("btnPublish").onclick = async ()=>{
  try{
    if(!CURRENT_ID) return hint("先選一份問卷");
    if(!confirm("發布並切換為上線問卷？")) return;
    setStatus("發布中…");
    await apiAdmin("POST","/api/q/publish",{id:CURRENT_ID});
    await loadList();
    setStatus("已發布並上線 ✅");
  }catch(e){
    setStatus("發布失敗");
    hint(e.message||String(e));
  }
};

$("btnAddQ").onclick = ()=>{
  if(!CFG) return;
  const nid = "q" + (CFG.questions.length + 1);
  CFG.questions.push({ id:nid, title:"新題目", type:"yn" });
  renderQEditor();
};

$("btnAddP").onclick = ()=>{
  if(!CFG) return;
  CFG.productLinks = CFG.productLinks || {};
  let k = "new_key";
  let i = 1;
  while(CFG.productLinks[k] !== undefined){ k = "new_key_" + (i++); }
  CFG.productLinks[k] = "";
  renderPEditor();
};

$("btnAIApply").onclick = async ()=>{
  try{
    if(!CURRENT_ID) return aiHint("先選一份問卷");
    const instruction = ($("aiText").value||"").trim();
    if(!instruction) return aiHint("請輸入需求");
    aiHint("AI 生成中…");
    const j = await apiAdmin("POST","/api/q/ai",{id:CURRENT_ID,instruction});
    CFG = j.config;
    fillHeaderFields();
    renderQEditor();
    renderPEditor();
    await loadList();
    aiHint("已套用 AI ✅（記得：儲存草稿 / 發布）");
  }catch(e){
    aiHint("AI 失敗：" + (e.message||String(e)));
  }
};

/* -------------------------
 * Data load/render
 * ------------------------- */
async function loadList(){
  try{
    setStatus("讀取清單…");
    const j = await apiGet("/api/q/list");
    ACTIVE_ID = j.activeId;
    LIST = j.items || [];
    renderList();
    $("activeInfo").textContent = "目前上線：" + (ACTIVE_ID || "（尚未發布）");
    setStatus("就緒 ✅");
  }catch(e){
    setStatus("讀取失敗");
    hint(e.message||String(e));
    openModal();
  }
}

function renderList(){
  const box = $("list");
  box.innerHTML = "";
  if(!LIST.length){
    box.innerHTML = `<div class="small text-white/70">尚無問卷，按「新增問卷」建立第一份。</div>`;
    return;
  }
  LIST.forEach(item=>{
    const isActive = item.id === ACTIVE_ID;
    const btn = document.createElement("button");
    btn.className = "w-full text-left rounded-2xl p-3 border border-white/10 bg-white/5 hover:bg-white/10 transition";
    btn.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div class="text-white font-extrabold">${esc(item.name || item.id)}</div>
        <div class="flex items-center gap-2">
          ${isActive ? `<span class="pill text-white bg-white/10 border-white/15">上線</span>` : ``}
          ${item.publishedAt ? `<span class="pill text-white bg-white/10 border-white/15">已發布</span>` : `<span class="pill text-white bg-white/10 border-white/15">未發布</span>`}
        </div>
      </div>
      <div class="small text-white/65 mt-1">${esc(item.id)}</div>
    `;
    btn.onclick = async ()=>{
      CURRENT_ID = item.id;
      await loadDraft();
    };
    box.appendChild(btn);
  });
}

async function loadDraft(){
  try{
    if(!CURRENT_ID) return;
    setStatus("讀草稿…");
    const j = await apiGet(`/api/q/get?id=${encodeURIComponent(CURRENT_ID)}&ver=draft`);
    CFG = j.config || {};
    CFG.questions = Array.isArray(CFG.questions) ? CFG.questions : [];
    CFG.productLinks = (CFG.productLinks && typeof CFG.productLinks === "object") ? CFG.productLinks : {};
    fillHeaderFields();
    renderQEditor();
    renderPEditor();
    showEditor();
    setStatus("草稿已載入 ✅");
  }catch(e){
    setStatus("讀取失敗");
    hint(e.message||String(e));
  }
}

/* -------------------------
 * Editor binding
 * ------------------------- */
function fillHeaderFields(){
  $("qName").value = CFG?.meta?.name || "";
  $("coverUrl").value = CFG?.coverImageUrl || "";
  $("startKeywords").value = (CFG?.startKeywords || []).join(",");
  $("brandTitle").value = CFG?.brandTitle || "";
}

function collectHeaderFields(){
  if(!CFG) return;
  CFG.meta = CFG.meta || {};
  CFG.meta.name = ($("qName").value||"").trim() || "未命名問卷";
  CFG.coverImageUrl = ($("coverUrl").value||"").trim();
  CFG.brandTitle = ($("brandTitle").value||"").trim() || "問卷";
  CFG.startKeywords = ($("startKeywords").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  CFG.meta.updatedAt = Date.now();
}

function uid(){ return "op_" + Math.random().toString(36).slice(2,10); }

function renderQEditor(){
  const box = $("qEditor");
  box.innerHTML = "";
  if(!CFG) return;

  CFG.questions = Array.isArray(CFG.questions) ? CFG.questions : [];

  CFG.questions.forEach((q, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "rounded-2xl border border-white/10 bg-white/5 p-3 space-y-2";

    wrap.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div class="text-white font-extrabold">Q${idx+1}</div>
        <div class="flex gap-2">
          <button class="btn btn-ghost text-xs" data-act="up">↑</button>
          <button class="btn btn-ghost text-xs" data-act="down">↓</button>
          <button class="btn btn-danger text-xs" data-act="del">刪除</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-2">
        <div class="space-y-1">
          <div class="text-white/80 text-sm font-bold">題目 ID（唯一）</div>
          <input class="inp" data-k="id" value="${esc(q.id)}" placeholder="q1">
        </div>
        <div class="space-y-1">
          <div class="text-white/80 text-sm font-bold">題目文字</div>
          <input class="inp" data-k="title" value="${esc(q.title)}" placeholder="例如：我經常只有兩餐">
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-2">
        <div class="space-y-1">
          <div class="text-white/80 text-sm font-bold">題型</div>
          <select class="inp" data-k="type">
            <option value="yn" ${q.type==="yn"?"selected":""}>是/不是（yn）</option>
            <option value="choice" ${q.type==="choice"?"selected":""}>四選一（choice）</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-white/80 text-sm font-bold">選項（choice 才需要）</div>
          <button class="btn btn-ghost w-full" data-act="addOpt">＋ 新增選項</button>
        </div>
      </div>

      <div class="space-y-2" data-optwrap="1"></div>
    `;
    box.appendChild(wrap);

    const optWrap = wrap.querySelector('[data-optwrap="1"]');

    if(q.type === "choice"){
      q.options = Array.isArray(q.options) ? q.options : [];
      if(q.options.length < 2){
        q.options = [
          { id: uid(), v:"a", t:"選項A" },
          { id: uid(), v:"b", t:"選項B" },
          { id: uid(), v:"c", t:"選項C" },
          { id: uid(), v:"d", t:"選項D" }
        ];
      }else{
        // 補 id
        q.options = q.options.map(op => ({ id: op.id || uid(), v: op.v, t: op.t }));
      }

      q.options.forEach((op)=>{
        const row = document.createElement("div");
        row.className = "grid grid-cols-12 gap-2 items-center";
        row.innerHTML = `
          <div class="col-span-2"><input class="inp" style="padding:8px 10px;border-radius:12px" data-opk="v" value="${esc(op.v)}" placeholder="a"></div>
          <div class="col-span-9"><input class="inp" style="padding:8px 10px;border-radius:12px" data-opk="t" value="${esc(op.t)}" placeholder="文字"></div>
          <div class="col-span-1 text-right"><button class="btn btn-danger text-xs" data-act="delOpt">✕</button></div>
        `;
        optWrap.appendChild(row);

        row.querySelector('[data-act="delOpt"]').onclick = ()=>{
          const cur = CFG.questions[idx];
          cur.options = (cur.options||[]).filter(x => x.id !== op.id);
          renderQEditor();
        };

        row.querySelectorAll("input[data-opk]").forEach(inp=>{
          inp.addEventListener("input", ()=>{
            const cur = CFG.questions[idx];
            const target = (cur.options||[]).find(x=>x.id===op.id);
            if(!target) return;
            target[inp.dataset.opk] = inp.value;
          });
        });
      });
    }else{
      optWrap.innerHTML = `<div class="small text-white/70">yn 題型不需要選項。</div>`;
    }

    wrap.querySelectorAll("[data-k]").forEach(el=>{
      el.addEventListener("input", ()=>{
        const k = el.dataset.k;
        CFG.questions[idx][k] = el.value;
        if(k === "type"){
          if(el.value === "choice"){
            CFG.questions[idx].options = CFG.questions[idx].options || [
              { id: uid(), v:"a", t:"選項A" },
              { id: uid(), v:"b", t:"選項B" },
              { id: uid(), v:"c", t:"選項C" },
              { id: uid(), v:"d", t:"選項D" }
            ];
          }else{
            delete CFG.questions[idx].options;
          }
          renderQEditor();
        }
      });
    });

    wrap.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick = ()=>{
        const act = btn.dataset.act;
        if(act==="del"){
          CFG.questions.splice(idx,1);
          renderQEditor();
        }
        if(act==="up" && idx>0){
          [CFG.questions[idx-1], CFG.questions[idx]] = [CFG.questions[idx], CFG.questions[idx-1]];
          renderQEditor();
        }
        if(act==="down" && idx<CFG.questions.length-1){
          [CFG.questions[idx+1], CFG.questions[idx]] = [CFG.questions[idx], CFG.questions[idx+1]];
          renderQEditor();
        }
        if(act==="addOpt"){
          const cur = CFG.questions[idx];
          cur.type = "choice";
          cur.options = Array.isArray(cur.options) ? cur.options : [];
          const n = cur.options.length;
          cur.options.push({ id: uid(), v: String.fromCharCode(97+n) || "x", t:"新選項" });
          renderQEditor();
        }
      };
    });
  });
}

function renderPEditor(){
  const box = $("pEditor");
  box.innerHTML = "";
  if(!CFG) return;

  CFG.productLinks = (CFG.productLinks && typeof CFG.productLinks === "object") ? CFG.productLinks : {};
  const keys = Object.keys(CFG.productLinks);

  if(keys.length === 0){
    box.innerHTML = `<div class="small text-white/70">尚無產品連結，按「新增連結」。</div>`;
    return;
  }

  keys.forEach((k)=>{
    const row = document.createElement("div");
    row.className = "grid grid-cols-12 gap-2 items-center rounded-2xl border border-white/10 bg-white/5 p-2";
    row.innerHTML = `
      <div class="col-span-3">
        <input class="inp" style="padding:8px 10px;border-radius:12px" value="${esc(k)}" data-pk="key">
      </div>
      <div class="col-span-8">
        <input class="inp" style="padding:8px 10px;border-radius:12px" value="${esc(CFG.productLinks[k])}" placeholder="https://..." data-pk="url">
      </div>
      <div class="col-span-1 text-right">
        <button class="btn btn-danger text-xs" data-act="delP">✕</button>
      </div>
    `;
    box.appendChild(row);

    const keyInp = row.querySelector('input[data-pk="key"]');
    const urlInp = row.querySelector('input[data-pk="url"]');
    const delBtn = row.querySelector('button[data-act="delP"]');

    keyInp.addEventListener("input", ()=>{
      const nk = keyInp.value.trim();
      if(!nk || nk === k) return;
      CFG.productLinks[nk] = CFG.productLinks[k];
      delete CFG.productLinks[k];
      renderPEditor();
    });
    urlInp.addEventListener("input", ()=>{
      const kk = keyInp.value.trim() || k;
      CFG.productLinks[kk] = urlInp.value;
    });
    delBtn.onclick = ()=>{
      const kk = keyInp.value.trim() || k;
      delete CFG.productLinks[kk];
      renderPEditor();
    };
  });
}

/* -------------------------
 * Boot
 * ------------------------- */
(async function(){
  loadKey();
  setStatus("自動偵測 API…");

  const resolved = await resolveApiBase();
  if(resolved){
    setApiBaseUI(resolved);
    setStatus("—");
    await loadList();
    if(LIST.length){
      CURRENT_ID = LIST[0].id;
      await loadDraft();
    }else{
      showEmpty();
    }
  }else{
    setApiBaseUI("");
    setStatus("需要設定 API");
    openModal();
    showEmpty();
  }
})();
</script>
</body>
</html>
