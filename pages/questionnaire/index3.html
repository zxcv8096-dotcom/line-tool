<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>生活型態營養問卷｜中控台（11題）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --bd:rgba(15,23,42,.10);
      --glass: rgba(255,255,255,.88);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
    }
    body{
      color:var(--ink);
      background: linear-gradient(135deg, #f8fafc, #eef2ff, #ecfeff);
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .card{ background: var(--glass); backdrop-filter: blur(10px); box-shadow: var(--shadow); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .thinbar::-webkit-scrollbar{ height:10px; width:10px; }
    .thinbar::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.18); border-radius: 999px; }
    table th, table td { vertical-align: middle; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">生活型態營養問卷｜中控台（11題）</h1>
        <p class="text-sm text-slate-600 mt-1">這頁就是你的唯一中控台：一鍵把題目/關鍵字/扣分規則/年齡層攝取量寫進 Cloudflare KV；右側可直接產生圖片版報告 PNG。</p>
      </div>
      <div class="text-xs text-slate-600 leading-6">
        <div class="font-bold">需要 Worker 提供 API：</div>
        <div class="mono">POST /listAll /putAny /loadAny /upload</div>
        <div class="text-[11px] text-slate-500 mt-1">（若你 Worker 有驗證，可在下方填 Admin Key）</div>
      </div>
    </header>

    <!-- CONNECT -->
    <section class="card rounded-2xl p-5 mb-4 border border-slate-200">
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="text-sm font-semibold text-slate-700">Worker API（固定）</label>
          <input id="inApiBase" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                 value="https://api.zxcv8096.workers.dev/" />
          <div class="text-xs text-slate-500 mt-2">
            寫入位置：
            <span class="mono font-semibold">AI_SURVEY:Q:life11</span>｜
            <span class="mono font-semibold">AI_SURVEY:KW_MAP</span>
          </div>
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-700">Admin Key（可空白）</label>
          <input id="inAdminKey" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200 mono"
                 placeholder="若你的 Worker 有驗證才需要填" />
        </div>

        <div class="flex gap-2">
          <button id="btnConnect" class="w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">連線檢查</button>
          <button id="btnWrite" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 font-semibold">一鍵寫入KV</button>
        </div>
      </div>

      <div class="mt-3 text-xs text-slate-500">
        狀態：<span id="txtStatus" class="font-semibold">未連線</span>
        最後測試：<span id="txtLast" class="mono">-</span>
      </div>

      <div id="errBanner" class="hidden mt-3 rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
        <div class="font-extrabold">錯誤</div>
        <div id="errText" class="mt-1 mono text-[12px] whitespace-pre-wrap"></div>
      </div>
    </section>

    <div class="grid lg:grid-cols-2 gap-4">
      <!-- LEFT -->
      <section class="card rounded-2xl p-5 border border-slate-200">
        <h2 class="text-lg font-extrabold text-slate-900">① 問卷設定</h2>

        <div class="mt-4 grid gap-3">
          <div>
            <label class="text-sm font-semibold text-slate-700">啟動關鍵字（LINE 使用者輸入這個開始）</label>
            <input id="inKeyword" class="mt-1 w-full px-4 py-3 rounded-xl border border-slate-200"
                   placeholder="例如：生活營養" />
            <div class="text-xs text-slate-500 mt-2">
              會寫入到 <span class="mono font-semibold">AI_SURVEY:KW_MAP</span>：<span class="mono">{"關鍵字":"life11"}</span>
            </div>
          </div>

          <div class="rounded-2xl border border-indigo-200 bg-indigo-50/60 p-4">
            <div class="text-sm font-extrabold text-indigo-900">年齡選項（可改字）</div>
            <div class="text-xs text-indigo-900/70 mt-1">⚠️ 這裡會影響問卷 Q11 選項；攝取量數值在下面「Excel 表」調整。</div>

            <div class="mt-3 grid gap-2">
              <input id="ageChild" class="w-full px-4 py-2 rounded-xl border border-indigo-200 bg-white" value="0~10 歲 (兒童)" />
              <input id="ageTeen"  class="w-full px-4 py-2 rounded-xl border border-indigo-200 bg-white" value="11~18 歲 (青少年)" />
              <input id="ageAdult" class="w-full px-4 py-2 rounded-xl border border-indigo-200 bg-white" value="19 歲以上" />
            </div>
            <div class="text-[12px] text-indigo-900/70 mt-2">
              19 歲以上會依 Q10 性別自動套用「女/男」的攝取量。
            </div>
          </div>

          <div class="rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900 leading-6">
            <div class="font-extrabold">扣分模型規則（固定邏輯）</div>
            <div>• 從 100% 開始，答「是」就扣分；會自動夾到 0～100%。</div>
            <div>• 圖片與文字報告都會以固定順序顯示 9 種營養素。</div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card rounded-2xl p-5 border border-slate-200">
        <div class="flex items-end justify-between gap-3">
          <div>
            <h2 class="text-lg font-extrabold text-slate-900">② 預覽與模擬</h2>
            <p class="text-sm text-slate-600 mt-1">這裡用來確認：文字報告 + 圖片報告（PNG）。</p>
          </div>
          <div class="flex gap-2">
            <button id="btnSimAllGood" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">
              一鍵「都很健康」
            </button>
            <button id="btnSimAllYes" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">
              一鍵「全部都選是」
            </button>
          </div>
        </div>

        <div class="mt-4 grid gap-3">
          <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="text-sm font-extrabold text-slate-900">11 題（照圖不改字）</div>
            <div class="text-xs text-slate-500 mt-1">是/不是、性別、年齡（年齡名稱可改）</div>

            <div id="simWrap" class="mt-3 space-y-3 max-h-[420px] overflow-auto thinbar pr-1"></div>
          </div>

          <div class="grid md:grid-cols-2 gap-2">
            <button id="btnMakeReport" class="px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">
              產生文字報告（模擬）
            </button>
            <button id="btnCopyReport" class="px-4 py-3 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">
              複製報告
            </button>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="text-sm font-extrabold text-slate-900">文字版報告輸出</div>
            <textarea id="outReport" rows="12" class="mt-2 w-full px-4 py-3 rounded-xl border border-slate-200"
              placeholder="按『產生文字報告』後會出現在這裡"></textarea>
            <div class="text-xs text-slate-500 mt-2">
              顯示內容：9 種營養素%（固定順序）＋ 每日攝取參考值（依年齡/性別）。
            </div>
          </div>

          <!-- R2 UPLOAD -->
          <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="flex items-end justify-between gap-3">
              <div>
                <div class="text-sm font-extrabold text-slate-900">R2 上傳（背景/LOGO）</div>
                <div class="text-xs text-slate-500 mt-1">選檔 → 上傳到 Worker 的 <span class="mono">POST /upload</span> → 回傳 URL 後自動填入下方。</div>
              </div>
              <div class="text-[11px] text-slate-500">
                需求：你的 Worker /upload 需支援 <span class="mono">multipart/form-data</span>。
              </div>
            </div>

            <div class="mt-3 grid gap-2">
              <div class="grid md:grid-cols-3 gap-2 items-end">
                <div class="md:col-span-2">
                  <label class="text-xs font-bold text-slate-500">選擇檔案</label>
                  <input id="upFile" type="file" accept="image/*" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-500">存放路徑（key）</label>
                  <input id="upKey" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 mono"
                    placeholder="assets/bg.png" />
                </div>
              </div>

              <div class="flex gap-2">
                <button id="btnUploadR2" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 font-semibold">上傳到 R2</button>
                <button id="btnUseAsBg" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">設為底板URL</button>
                <button id="btnUseAsLogo" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">設為LOGO URL</button>
              </div>

              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs font-bold text-slate-500">上傳結果 URL</div>
                <input id="upResultUrl" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 mono"
                  placeholder="上傳成功後會出現在這裡" />
                <div class="text-[11px] text-slate-500 mt-2">
                  如果你回傳的是 <span class="mono">r2://</span> 或內部 key，請改成「可公開存取」的 URL 才能在 Canvas 匯出 PNG。
                </div>
              </div>
            </div>
          </div>

          <!-- IMAGE PREVIEW -->
          <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="flex items-end justify-between gap-3">
              <div>
                <div class="text-sm font-extrabold text-slate-900">圖片版報告（預覽/匯出PNG）</div>
                <div class="text-xs text-slate-500 mt-1">固定輸出 900×1600 PNG（固定9種 + 第10格CTA）。</div>
              </div>
              <div class="flex gap-2">
                <button id="btnRenderImg" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-black font-semibold">產生圖片</button>
                <button id="btnDownloadImg" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">下載PNG</button>
              </div>
            </div>

            <div class="mt-3 grid gap-2">
              <label class="text-xs font-bold text-slate-500">底板圖片URL（R2 公開網址）</label>
              <input id="inBgUrl" class="w-full px-3 py-2 rounded-xl border border-slate-200 mono"
                placeholder="https://<your-public-r2-url>/assets/report_bg.png" />
              <label class="text-xs font-bold text-slate-500">LOGO圖片URL（可空白）</label>
              <input id="inLogoUrl" class="w-full px-3 py-2 rounded-xl border border-slate-200 mono"
                placeholder="https://.../logo.png" />
            </div>

            <div class="mt-3">
              <canvas id="cvReport" class="w-full rounded-2xl border border-slate-200 bg-white"></canvas>
              <div class="text-[11px] text-slate-500 mt-2">
                ※ 若「下載PNG」失敗，多半是背景圖跨域（CORS）沒開。請用可公開的 R2 URL，並允許跨域讀取。
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>

    <!-- EXCEL TABLE -->
    <section class="card rounded-2xl p-5 border border-slate-200 mt-4">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-extrabold text-slate-900">③ 年齡層參考值（Excel 版｜可改）</h2>
          <p class="text-sm text-slate-600 mt-1">你改這裡，就會寫進 KV（用於文字/圖片版的「每日攝取參考值」）。</p>
        </div>
        <div class="flex gap-2">
          <button id="btnResetTargets" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">恢復 Excel 預設</button>
          <button id="btnCopyTargetsJson" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 font-semibold">複製 JSON</button>
        </div>
      </div>

      <div class="mt-4 overflow-auto thinbar">
        <table class="w-full min-w-[980px] border-collapse">
          <thead>
            <tr class="text-xs text-slate-600">
              <th class="text-left p-2 border-b border-slate-200">項目</th>
              <th class="text-left p-2 border-b border-slate-200">單位</th>
              <th class="text-left p-2 border-b border-slate-200">0~10 歲</th>
              <th class="text-left p-2 border-b border-slate-200">11~18 歲</th>
              <th class="text-left p-2 border-b border-slate-200">19+（女）</th>
              <th class="text-left p-2 border-b border-slate-200">19+（男）</th>
            </tr>
          </thead>
          <tbody id="targetsTbody" class="text-sm"></tbody>
        </table>
      </div>

      <div class="mt-3 text-xs text-slate-500">
        ※ 這裡的數值會組合成：<span class="mono font-semibold">vitB(B1/B2/B6)</span>、<span class="mono font-semibold">ca_mg(鈣/鎂)</span>、<span class="mono font-semibold">trace(碘/硒)</span>。
      </div>
    </section>

    <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(92vw,560px)] space-y-2 z-50"></div>
  </div>

<script>
(() => {
  // =====================
  // KV keys
  // =====================
  const Q_KEY = "AI_SURVEY:Q:life11";
  const KW_MAP_KEY = "AI_SURVEY:KW_MAP";

  // =====================
  // Questions (fixed)
  // =====================
  const QUESTIONS = [
    { id:"q1",  type:"yn",  text:"我經常只有兩餐" },
    { id:"q2",  type:"yn",  text:"我每天攝取的蔬菜和水果少於5份（以成人手掌大小盤子為標準）" },
    { id:"q3",  type:"yn",  text:"我每天攝取的米飯或麵條少於1.5碗" },
    { id:"q4",  type:"yn",  text:"我每天喝的乳製品少於1.5杯" },
    { id:"q5",  type:"yn",  text:"我每天飲用咖啡或茶（至少兩杯）" },
    { id:"q6",  type:"yn",  text:"我每天攝取的蛋白質類食物少於5份（以成人三根手指的量為標準）" },
    { id:"q7",  type:"yn",  text:"我經常食用高溫、油炸或燒煮的食物" },
    { id:"q8",  type:"yn",  text:"我有吸菸習慣" },
    { id:"q9",  type:"yn",  text:"我常節食以減輕體重" },
    { id:"q10", type:"sex", text:"我的性別" },
    { id:"q11", type:"age", text:"我的年齡範圍" },
    { id:"done", type:"done", text:"生活型態營養問卷評估完畢！" }
  ];

  // =====================
  // Nutrient labels (fixed 9)
  // =====================
  const LABEL = {
    vitA:"維生素A",
    vitB:"維生素B",
    vitC:"維生素C",
    vitD:"維生素D",
    vitE:"維生素E",
    ca_mg:"鈣鎂",
    iron:"鐵",
    fiber:"膳食纖維",
    trace:"微量元素",
  };

  // 固定顯示順序
  const PCT_ORDER = ["vitA","vitB","vitC","vitD","vitE","ca_mg","iron","fiber","trace"];

  // =====================
  // Deduct rules (answer "是" => deduct)
  // =====================
  const DEDUCT_EXCEL_DEFAULT = {
    q1: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
    q2: { vitA:20, vitB:16, vitC:20, vitD:0,  vitE:16, ca_mg:0,  iron:0,  fiber:25, trace:16 },
    q3: { vitA:0,  vitB:17, vitC:0,  vitD:0,  vitE:17, ca_mg:0,  iron:16, fiber:25, trace:17 },
    q4: { vitA:20, vitB:17, vitC:0,  vitD:25, vitE:0,  ca_mg:25, iron:0,  fiber:0,  trace:0  },
    q5: { vitA:0,  vitB:0,  vitC:0,  vitD:0,  vitE:0,  ca_mg:25, iron:17, fiber:0,  trace:17 },
    q6: { vitA:0,  vitB:0,  vitC:0,  vitD:25, vitE:0,  ca_mg:0,  iron:17, fiber:0,  trace:16 },
    q7: { vitA:0,  vitB:16, vitC:20, vitD:0,  vitE:17, ca_mg:0,  iron:0,  fiber:0,  trace:0  },
    q8: { vitA:20, vitB:0,  vitC:20, vitD:0,  vitE:16, ca_mg:0,  iron:16, fiber:0,  trace:0  },
    q9: { vitA:20, vitB:17, vitC:20, vitD:25, vitE:17, ca_mg:25, iron:17, fiber:25, trace:17 },
  };

  // =====================
  // Targets Excel (editable)
  // =====================
  const TARGETS_EXCEL_DEFAULT = [
    { id:"vitA",   name:"維生素A", unit:"µg",  child:1500, teen:2500, adultF:3000, adultM:3000 },

    { id:"b1",     name:"維生素B1", unit:"mg", child:0.9,  teen:1.2,  adultF:0.9,  adultM:1.2 },
    { id:"b2",     name:"維生素B2", unit:"mg", child:1.0,  teen:1.3,  adultF:1.0,  adultM:1.3 },
    { id:"b6",     name:"維生素B6", unit:"mg", child:1.0,  teen:1.5,  adultF:1.5,  adultM:1.6 },

    { id:"vitC",   name:"維生素C", unit:"mg",  child:1200, teen:1800, adultF:2000, adultM:2000 },
    { id:"vitD",   name:"維生素D", unit:"µg",  child:50,   teen:50,   adultF:50,   adultM:50   },
    { id:"vitE",   name:"維生素E", unit:"mg",  child:300,  teen:800,  adultF:1000, adultM:1000 },

    { id:"ca",     name:"鈣",       unit:"mg",  child:1500, teen:2500, adultF:2500, adultM:2500 },
    { id:"mg",     name:"鎂",       unit:"mg",  child:250,  teen:350,  adultF:320,  adultM:380  },

    { id:"iron",   name:"鐵",       unit:"mg",  child:30,   teen:40,   adultF:45,   adultM:40   },
    { id:"fiber",  name:"纖維",     unit:"g",   child:20,   teen:25,   adultF:27,   adultM:34   },

    { id:"iodine", name:"微量(碘)", unit:"µg",  child:90,   teen:130,  adultF:150,  adultM:150  },
    { id:"selen",  name:"微量(硒)", unit:"µg",  child:30,   teen:55,   adultF:55,   adultM:55   },
  ];

  // =====================
  // DOM helpers
  // =====================
  const $ = (id)=>document.getElementById(id);

  function toast(msg, type="ok"){
    const wrap = $("toastWrap");
    const div = document.createElement("div");
    div.className = `card rounded-2xl px-4 py-3 border ${
      type==="ok" ? "border-emerald-200" : type==="warn" ? "border-amber-200" : "border-rose-200"
    }`;
    div.innerHTML = `<div class="text-sm text-slate-900 font-semibold">${escapeHtml(msg)}</div>`;
    wrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .25s"; }, 2200);
    setTimeout(()=>{ div.remove(); }, 2600);
  }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function showErr(e){
    $("errBanner").classList.remove("hidden");
    $("errText").textContent = String(e?.stack || e?.message || e || "");
  }
  function clearErr(){
    $("errBanner").classList.add("hidden");
    $("errText").textContent = "";
  }

  // =====================
  // API
  // =====================
  function apiBase(){
    return ($("inApiBase").value || "").trim().replace(/\/$/,"");
  }
  function adminKey(){
    return ($("inAdminKey").value || "").trim();
  }
  async function apiJson(path, bodyObj){
    const base = apiBase();
    if(!base) throw new Error("API Base 不可空白");
    const headers = { "Content-Type":"application/json" };
    const k = adminKey();
    if(k) headers["X-Admin-Key"] = k;

    const res = await fetch(base + path, {
      method:"POST",
      headers,
      body: JSON.stringify(bodyObj || {})
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }

  async function apiForm(path, formData){
    const base = apiBase();
    if(!base) throw new Error("API Base 不可空白");
    const headers = {};
    const k = adminKey();
    if(k) headers["X-Admin-Key"] = k;

    const res = await fetch(base + path, {
      method:"POST",
      headers,
      body: formData
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((data && (data.error||data.detail)) || (res.status + " " + res.statusText));
    if(data && data.ok === false) throw new Error(data.error || data.detail || "API error");
    return data;
  }

  async function kvGet(key){
    const r = await apiJson("/loadAny", { namespace:"DB", keyword:key });
    return r?.payload ?? r;
  }
  async function kvPut(key, payload){
    await apiJson("/putAny", { namespace:"DB", keyword:key, payload });
  }

  // =====================
  // Connect status
  // =====================
  let CONNECTED = false;
  function setStatus(ok, msg){
    CONNECTED = !!ok;
    $("txtStatus").textContent = msg;
    $("txtStatus").className = ok ? "font-semibold text-emerald-700" : "font-semibold text-rose-700";
    $("txtLast").textContent = new Date().toLocaleString();
  }
  async function connect(){
    clearErr();
    await apiJson("/listAll", {});
    setStatus(true, "已連線");
    toast("連線成功");
  }

  // =====================
  // Targets table (Excel)
  // =====================
  let targetsRows = structuredClone(TARGETS_EXCEL_DEFAULT);

  function numOrText(v){
    if(v === "" || v === null || v === undefined) return "";
    const n = Number(v);
    return Number.isFinite(n) ? n : String(v);
  }

  function renderTargetsTable(){
    const tb = $("targetsTbody");
    tb.innerHTML = "";
    targetsRows.forEach(row=>{
      const tr = document.createElement("tr");
      tr.className = "border-b border-slate-100";
      tr.innerHTML = `
        <td class="p-2 font-semibold text-slate-900">${escapeHtml(row.name)}</td>
        <td class="p-2 text-slate-600">${escapeHtml(row.unit)}</td>

        <td class="p-2">
          <input data-col="child" data-id="${row.id}" type="number" step="any"
            class="w-28 px-3 py-2 rounded-xl border border-slate-200 bg-white"
            value="${escapeHtml(row.child)}" />
        </td>
        <td class="p-2">
          <input data-col="teen" data-id="${row.id}" type="number" step="any"
            class="w-28 px-3 py-2 rounded-xl border border-slate-200 bg-white"
            value="${escapeHtml(row.teen)}" />
        </td>
        <td class="p-2">
          <input data-col="adultF" data-id="${row.id}" type="number" step="any"
            class="w-28 px-3 py-2 rounded-xl border border-slate-200 bg-white"
            value="${escapeHtml(row.adultF)}" />
        </td>
        <td class="p-2">
          <input data-col="adultM" data-id="${row.id}" type="number" step="any"
            class="w-28 px-3 py-2 rounded-xl border border-slate-200 bg-white"
            value="${escapeHtml(row.adultM)}" />
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("input[data-id][data-col]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id = inp.getAttribute("data-id");
        const col = inp.getAttribute("data-col");
        const row = targetsRows.find(r=>r.id===id);
        if(!row) return;
        row[col] = numOrText(inp.value);
      });
    });
  }

  function resetTargets(){
    targetsRows = structuredClone(TARGETS_EXCEL_DEFAULT);
    renderTargetsTable();
    toast("已恢復 Excel 預設");
  }

  function getTargetsObject(){
    const byId = {};
    targetsRows.forEach(r=>byId[r.id]=structuredClone(r));

    const pack = (ageKey, sexKey) => {
      const pick = (rid) => {
        const r = byId[rid];
        if(!r) return null;
        if(ageKey==="child") return r.child;
        if(ageKey==="teen") return r.teen;
        return (sexKey==="female") ? r.adultF : r.adultM;
      };

      const vitB = `B1:${pick("b1")}mg, B2:${pick("b2")}mg, B6:${pick("b6")}mg`;
      const ca_mg = `鈣:${pick("ca")}mg, 鎂:${pick("mg")}mg`;
      const trace = `碘:${pick("iodine")}µg, 硒:${pick("selen")}µg`;

      return {
        vitA: `${pick("vitA")}µg`,
        vitB,
        vitC: `${pick("vitC")}mg`,
        vitD: `${pick("vitD")}µg`,
        vitE: `${pick("vitE")}mg`,
        ca_mg,
        iron: `${pick("iron")}mg`,
        fiber: `${pick("fiber")}g`,
        trace,
      };
    };

    const combined = {
      child: pack("child"),
      teen: pack("teen"),
      adultFemale: pack("adult","female"),
      adultMale: pack("adult","male"),
    };

    return { rows: structuredClone(targetsRows), combined };
  }

  // =====================
  // Age options + rules
  // =====================
  function getAgeOpts(){
    return [
      ($("ageChild").value || "0~10 歲 (兒童)").trim(),
      ($("ageTeen").value  || "11~18 歲 (青少年)").trim(),
      ($("ageAdult").value || "19 歲以上").trim(),
    ];
  }

  function buildRules(){
    return {
      yn_yes: structuredClone(DEDUCT_EXCEL_DEFAULT),
      sex: { "男": {}, "女": {} },
      age: {}
    };
  }

  // =====================
  // Survey payload (write KV) - 已移除：營養素連結、引流圖
  // =====================
  function buildSurveyPayload(){
    const kw = ($("inKeyword").value || "").trim();
    if(!kw) throw new Error("請填『啟動關鍵字』");

    const ageOpts = getAgeOpts();
    if(ageOpts.some(x => !x)) throw new Error("年齡選項不可空白（需要 3 個）");

    const nodes = {};
    for(let i=0;i<QUESTIONS.length;i++){
      const q = QUESTIONS[i];
      if(q.type === "done") continue;

      const nextId = (QUESTIONS[i+1] && QUESTIONS[i+1].id !== "done") ? QUESTIONS[i+1].id : "";
      if(q.type === "yn"){
        nodes[q.id] = {
          q: q.text,
          type: "yn",
          options: [
            { t:"是",   value:"是",   next: nextId },
            { t:"不是", value:"不是", next: nextId },
          ]
        };
      } else if(q.type === "sex"){
        nodes[q.id] = {
          q: q.text,
          type: "sex",
          options: [
            { t:"男", value:"男", next: nextId },
            { t:"女", value:"女", next: nextId },
          ]
        };
      } else if(q.type === "age"){
        nodes[q.id] = {
          q: q.text,
          type: "age",
          options: [
            { t:ageOpts[0], value:ageOpts[0], next: nextId },
            { t:ageOpts[1], value:ageOpts[1], next: nextId },
            { t:ageOpts[2], value:ageOpts[2], next: nextId },
          ]
        };
      }
    }

    const targets = getTargetsObject();

    return {
      version: "life11-v6-percent-deduct-no-links-no-lead",
      name: "life11",
      title: "生活型態營養問卷（11題）",
      keyword: kw,
      start: "q1",
      rules: buildRules(),
      targetsExcel: targets,
      nodes,
      order: QUESTIONS.filter(x=>x.type!=="done").map(x=>x.id),
      nutrients: LABEL,
      ui: {
        ageOptions: { child: ageOpts[0], teen: ageOpts[1], adult: ageOpts[2] }
      }
    };
  }

  async function writeKV(){
    if(!CONNECTED) throw new Error("未連線，不能寫入（先按『連線檢查』）");
    const payload = buildSurveyPayload();

    await kvPut(Q_KEY, payload);

    const kw = payload.keyword.trim();
    let map = {};
    try{
      const raw = await kvGet(KW_MAP_KEY);
      if(raw && typeof raw === "object") map = raw;
    }catch{
      map = {};
    }
    map[kw] = "life11";
    await kvPut(KW_MAP_KEY, map);

    toast("已寫入 KV ✅（問卷 + KW_MAP + 扣分規則 + Excel攝取量）");
  }

  // =====================
  // Simulation UI
  // =====================
  const simState = {};

  function renderSim(){
    const [ageChild, ageTeen, ageAdult] = getAgeOpts();

    const wrap = $("simWrap");
    wrap.innerHTML = "";

    QUESTIONS.filter(x=>x.type!=="done").forEach((q, i)=>{
      const box = document.createElement("div");
      box.className = "rounded-2xl border border-slate-200 bg-white p-4";

      let optsHtml = "";
      if(q.type==="yn"){
        const v = simState[q.id] ?? "不是";
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            <button data-v="是" class="px-3 py-2 rounded-xl border ${v==="是"?"border-slate-900 bg-slate-900 text-white":"border-slate-200 bg-white hover:bg-slate-50"} font-semibold">是</button>
            <button data-v="不是" class="px-3 py-2 rounded-xl border ${v==="不是"?"border-slate-900 bg-slate-900 text-white":"border-slate-200 bg-white hover:bg-slate-50"} font-semibold">不是</button>
          </div>
        `;
      }else if(q.type==="sex"){
        const v = simState[q.id] ?? "男";
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            <button data-v="男" class="px-3 py-2 rounded-xl border ${v==="男"?"border-slate-900 bg-slate-900 text-white":"border-slate-200 bg-white hover:bg-slate-50"} font-semibold">男</button>
            <button data-v="女" class="px-3 py-2 rounded-xl border ${v==="女"?"border-slate-900 bg-slate-900 text-white":"border-slate-200 bg-white hover:bg-slate-50"} font-semibold">女</button>
          </div>
        `;
      }else if(q.type==="age"){
        const v = simState[q.id] ?? ageAdult;
        const opts = [ageChild, ageTeen, ageAdult];
        optsHtml = `
          <div class="flex gap-2 flex-wrap mt-2">
            ${opts.map(a => `
              <button data-v="${escapeHtml(a)}" class="px-3 py-2 rounded-xl border ${v===a?"border-slate-900 bg-slate-900 text-white":"border-slate-200 bg-white hover:bg-slate-50"} font-semibold">${escapeHtml(a)}</button>
            `).join("")}
          </div>
        `;
      }

      box.innerHTML = `
        <div class="text-xs text-slate-500">問題 No.${i+1}/11</div>
        <div class="mt-1 font-extrabold text-slate-900">${escapeHtml(q.text)}</div>
        ${optsHtml}
      `;

      box.querySelectorAll("button[data-v]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const v = btn.getAttribute("data-v");
          simState[q.id] = v;
          renderSim();
        });
      });

      wrap.appendChild(box);
    });
  }

  // =====================
  // Report (text)
  // =====================
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function getRemainFromSim(){
    const [ageChild, ageTeen, ageAdult] = getAgeOpts();
    const rules = buildRules();

    const ans = {};
    QUESTIONS.filter(x=>x.type!=="done").forEach(q=>{
      if(q.type==="yn")  ans[q.id] = simState[q.id] ?? "不是";
      if(q.type==="sex") ans[q.id] = simState[q.id] ?? "男";
      if(q.type==="age") ans[q.id] = simState[q.id] ?? ageAdult;
    });

    const deduct = {};
    Object.keys(rules.yn_yes).forEach(qid=>{
      if(ans[qid] === "是"){
        const obj = rules.yn_yes[qid];
        for(const k in obj){
          deduct[k] = (deduct[k] || 0) + (Number(obj[k]) || 0);
        }
      }
    });

    const remain = {};
    PCT_ORDER.forEach(k=>{
      const d = deduct[k] || 0;
      remain[k] = clamp(100 - d, 0, 100);
    });

    return { ans, remain };
  }

  function getSelectedTargets(ans){
    const [ageChild, ageTeen, ageAdult] = getAgeOpts();
    const t = getTargetsObject().combined;
    if(ans.q11 === ageChild) return t.child;
    if(ans.q11 === ageTeen) return t.teen;
    return (ans.q10 === "女") ? t.adultFemale : t.adultMale;
  }

  function makeReport(){
    const { ans, remain } = getRemainFromSim();
    const pack = getSelectedTargets(ans);

    const pctLinesAll = PCT_ORDER.map(k => `• ${LABEL[k]}：${remain[k]}%`).join("\n");

    const targetLines =
`- 維生素A：${pack.vitA}
- 維生素B：${pack.vitB}
- 維生素C：${pack.vitC}
- 維生素D：${pack.vitD}
- 維生素E：${pack.vitE}
- 鈣鎂：${pack.ca_mg}
- 鐵：${pack.iron}
- 膳食纖維：${pack.fiber}
- 微量元素：${pack.trace}`;

    const kw = ($("inKeyword").value||"").trim() || "-";

    const report =
`【生活型態營養問卷｜結果（%）】

啟動關鍵字：${kw}

基本資料：
- 性別：${ans.q10}
- 年齡：${ans.q11}

【全部營養素 %（固定順序）】
${pctLinesAll}

【你的每日攝取參考值（依年齡/性別）】
${targetLines}

提醒：本分析為生活營養評估，不涉及醫療診斷；若有慢性病、孕哺或用藥，請先詢問專業人員。`;

    $("outReport").value = report;
  }

  // =====================
  // R2 upload UI -> POST /upload (multipart/form-data)
  // 送出欄位：
  // - file: 檔案
  // - key: 你輸入的路徑（例 assets/bg.png）
  // - kind: bg|logo（可選）
  // 期待回傳 JSON 其中之一：
  // - { ok:true, url:"https://..." }
  // - { ok:true, publicUrl:"https://..." }
  // - { ok:true, result:{ url:"https://..." } }
  // =====================
  async function uploadToR2(){
    if(!CONNECTED) throw new Error("未連線，不能上傳（先按『連線檢查』）");
    const f = $("upFile").files?.[0];
    if(!f) throw new Error("請先選擇檔案");
    const key = ($("upKey").value || "").trim();
    if(!key) throw new Error("請填『存放路徑（key）』例如 assets/bg.png");

    const fd = new FormData();
    fd.append("file", f);
    fd.append("key", key);
    fd.append("contentType", f.type || "application/octet-stream");

    const r = await apiForm("/upload", fd);

    const url =
      r?.url ||
      r?.publicUrl ||
      r?.result?.url ||
      r?.result?.publicUrl ||
      r?.payload?.url ||
      "";

    if(!url) throw new Error("上傳成功但沒拿到 URL（請確認 Worker /upload 回傳 {url} 或 {publicUrl}）");

    $("upResultUrl").value = url;
    toast("上傳成功 ✅");
    return url;
  }

  // =====================
  // Image render (Canvas) - 固定9種 + 第10格CTA（C：顏色條 + %）
  // =====================
  let lastPngDataUrl = "";

  function pctColor(p){
    if(p < 35) return "#ff4d4f";
    if(p < 70) return "#fbbf24";
    return "#34d399";
  }

  async function loadImg(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>resolve(img);
      img.onerror = ()=>reject(new Error("圖片載入失敗：" + url));
      img.src = url;
    });
  }

  function roundRect(ctx, x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  async function renderReportImage(){
    const bgUrl = ($("inBgUrl").value||"").trim();
    if(!bgUrl) throw new Error("請先填『底板圖片URL（R2 公開網址）』");
    const logoUrl = ($("inLogoUrl").value||"").trim();

    const W = 900, H = 1600;
    const cv = $("cvReport");
    cv.width = W; cv.height = H;
    const ctx = cv.getContext("2d");

    const bg = await loadImg(bgUrl);
    ctx.drawImage(bg, 0, 0, W, H);

    const { ans, remain } = getRemainFromSim();

    const panelX = 60, panelY = 860, panelW = W-120, panelH = 680;
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "#ffffff";
    roundRect(ctx, panelX, panelY, panelW, panelH, 46);
    ctx.fill();
    ctx.restore();

    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.font = "bold 44px Microsoft JhengHei, sans-serif";
    ctx.textAlign = "left";
    ctx.fillText("營養狀況總覽", panelX+34, panelY+70);

    // 基本資料小字（可刪）
    ctx.font = "bold 20px Microsoft JhengHei, sans-serif";
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.fillText(`性別：${ans.q10}   年齡：${ans.q11}`, panelX+34, panelY+108);

    if(logoUrl){
      try{
        const logo = await loadImg(logoUrl);
        const lw = 260, lh = 90;
        ctx.globalAlpha = 0.95;
        ctx.drawImage(logo, W/2 - lw/2, 60, lw, lh);
        ctx.globalAlpha = 1;
      }catch{}
    }

    const cols=2, rows=5;
    const gap=18;
    const boxX=panelX+26;
    const boxY=panelY+140;
    const boxW=(panelW-26*2-gap)/cols;
    const boxH=(panelH-140-26-gap*(rows-1))/rows;

    const items = PCT_ORDER.map(k=>({ key:k, label: LABEL[k], pct: remain[k] }));
    items.push({ key:"cta", label:"點擊查看建議產品", pct:null });

    for(let i=0;i<10;i++){
      const r = Math.floor(i/cols);
      const c = i%cols;
      const x = boxX + c*(boxW+gap);
      const y = boxY + r*(boxH+gap);

      ctx.save();
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "#0b122b";
      roundRect(ctx, x, y, boxW, boxH, 28);
      ctx.fill();
      ctx.restore();

      ctx.strokeStyle = "rgba(255,255,255,.45)";
      ctx.lineWidth = 2;
      roundRect(ctx, x, y, boxW, boxH, 28);
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = "bold 28px Microsoft JhengHei, sans-serif";
      ctx.textAlign = "left";
      ctx.fillText(items[i].label, x+20, y+44);

      if(items[i].key === "cta"){
        ctx.fillStyle = "rgba(255,255,255,.90)";
        ctx.font = "bold 22px Microsoft JhengHei, sans-serif";
        ctx.fillText("（此格之後可做為可點擊區）", x+20, y+86);
        continue;
      }

      const pct = items[i].pct;
      const barX = x+20, barY = y+72, barW = boxW-40, barH = 16;

      ctx.fillStyle = "rgba(255,255,255,.22)";
      roundRect(ctx, barX, barY, barW, barH, 10);
      ctx.fill();

      const fillW = Math.max(0, Math.min(barW, barW * (pct/100)));
      ctx.fillStyle = pctColor(pct);
      roundRect(ctx, barX, barY, fillW, barH, 10);
      ctx.fill();

      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = "bold 30px Microsoft JhengHei, sans-serif";
      ctx.textAlign = "right";
      ctx.fillText(`${pct}%`, x+boxW-20, y+122);
      ctx.textAlign = "left";
    }

    lastPngDataUrl = cv.toDataURL("image/png");
    return lastPngDataUrl;
  }

  function downloadPng(){
    if(!lastPngDataUrl) throw new Error("請先按『產生圖片』");
    const a = document.createElement("a");
    a.href = lastPngDataUrl;
    a.download = "nutrition_report.png";
    a.click();
  }

  // =====================
  // Events
  // =====================
  $("btnConnect").addEventListener("click", async ()=>{
    try{ await connect(); }
    catch(e){
      setStatus(false, "連線失敗");
      showErr(e);
      toast("連線失敗", "err");
    }
  });

  $("btnWrite").addEventListener("click", async ()=>{
    try{
      clearErr();
      await writeKV();
    }catch(e){
      showErr(e);
      toast(e.message || "寫入失敗", "err");
    }
  });

  $("btnMakeReport").addEventListener("click", ()=>{
    try{ makeReport(); toast("已產生文字報告 ✅"); }
    catch(e){ toast(e.message, "err"); }
  });

  $("btnCopyReport").addEventListener("click", async ()=>{
    try{
      const t = $("outReport").value || "";
      if(!t.trim()) return toast("沒有報告可複製", "warn");
      await navigator.clipboard.writeText(t);
      toast("已複製報告 ✅");
    }catch{
      toast("複製失敗（瀏覽器限制）", "warn");
    }
  });

  $("btnUploadR2").addEventListener("click", async ()=>{
    try{
      clearErr();
      await uploadToR2();
    }catch(e){
      showErr(e);
      toast(e.message || "上傳失敗", "err");
    }
  });

  $("btnUseAsBg").addEventListener("click", ()=>{
    const u = ($("upResultUrl").value||"").trim();
    if(!u) return toast("沒有可用的上傳URL", "warn");
    $("inBgUrl").value = u;
    toast("已填入底板URL ✅");
  });

  $("btnUseAsLogo").addEventListener("click", ()=>{
    const u = ($("upResultUrl").value||"").trim();
    if(!u) return toast("沒有可用的上傳URL", "warn");
    $("inLogoUrl").value = u;
    toast("已填入LOGO URL ✅");
  });

  $("btnRenderImg").addEventListener("click", async ()=>{
    try{
      clearErr();
      await renderReportImage();
      toast("已產生圖片 ✅");
    }catch(e){
      showErr(e);
      toast(e.message || "產生圖片失敗", "err");
    }
  });

  $("btnDownloadImg").addEventListener("click", ()=>{
    try{
      downloadPng();
      toast("已下載 PNG ✅");
    }catch(e){
      toast(e.message || "下載失敗", "warn");
    }
  });

  $("btnSimAllGood").addEventListener("click", ()=>{
    ["q1","q2","q3","q4","q5","q6","q7","q8","q9"].forEach(id=>simState[id]="不是");
    simState.q10="男";
    simState.q11=($("ageAdult").value||"19 歲以上").trim();
    renderSim();
    toast("已填入『都很健康』測試答案");
  });

  $("btnSimAllYes").addEventListener("click", ()=>{
    ["q1","q2","q3","q4","q5","q6","q7","q8","q9"].forEach(id=>simState[id]="是");
    simState.q10="男";
    simState.q11=($("ageAdult").value||"19 歲以上").trim();
    renderSim();
    toast("已填入『全部都選是』測試答案");
  });

  ["ageChild","ageTeen","ageAdult"].forEach(id=>{
    $(id).addEventListener("input", ()=> renderSim());
  });

  $("btnResetTargets").addEventListener("click", resetTargets);

  $("btnCopyTargetsJson").addEventListener("click", async ()=>{
    try{
      const obj = getTargetsObject();
      await navigator.clipboard.writeText(JSON.stringify(obj, null, 2));
      toast("已複製 Targets JSON ✅");
    }catch{
      toast("複製失敗（瀏覽器限制）", "warn");
    }
  });

  // =====================
  // init
  // =====================
  renderTargetsTable();
  renderSim();
})();
</script>
</body>
</html>
